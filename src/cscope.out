cscope 15 $HOME/darknet/src               0000855835
	@activation_layer.c

1 
	~"aùiv©iÚ_Ïy”.h
"

2 
	~"uts.h
"

3 
	~"cuda.h
"

4 
	~"bÏs.h
"

5 
	~"gemm.h
"

7 
	~<m©h.h
>

8 
	~<¡dio.h
>

9 
	~<¡dlib.h
>

10 
	~<¡ršg.h
>

12 
Ïy”
 
	$make_aùiv©iÚ_Ïy”
(
b©ch
, 
šputs
, 
ACTIVATION
 
aùiv©iÚ
)

14 
Ïy”
 
l
 = {0};

15 
l
.
ty³
 = 
ACTIVE
;

17 
l
.
šputs
 = inputs;

18 
l
.
ouuts
 = 
šputs
;

19 
l
.
b©ch
=batch;

21 
l
.
ouut
 = 
	`ÿÎoc
(
b©ch
*
šputs
, (*));

22 
l
.
d–
 = 
	`ÿÎoc
(
b©ch
*
šputs
, (*));

24 
l
.
fÜw¬d
 = 
fÜw¬d_aùiv©iÚ_Ïy”
;

25 
l
.
backw¬d
 = 
backw¬d_aùiv©iÚ_Ïy”
;

26 #ifdeà
GPU


27 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_aùiv©iÚ_Ïy”_gpu
;

28 
l
.
backw¬d_gpu
 = 
backw¬d_aùiv©iÚ_Ïy”_gpu
;

30 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
, 
šputs
*
b©ch
);

31 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
, 
šputs
*
b©ch
);

33 
l
.
aùiv©iÚ
 =‡ctivation;

34 
	`årštf
(
¡d”r
, "Aùiv©iÚ Lay”: %d iÅuts\n", 
šputs
);

35  
l
;

36 
	}
}

38 
	$fÜw¬d_aùiv©iÚ_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

40 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
, 
Ãt
.
šput
, 1,†.
ouut
, 1);

41 
	`aùiv©e_¬¿y
(
l
.
ouut
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
);

42 
	}
}

44 
	$backw¬d_aùiv©iÚ_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

46 
	`g¿d›Á_¬¿y
(
l
.
ouut
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
,†.
d–
);

47 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
d–
, 1, 
Ãt
.delta, 1);

48 
	}
}

50 #ifdeà
GPU


52 
	$fÜw¬d_aùiv©iÚ_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

54 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
Ãt
.
šput_gpu
, 1,†.
ouut_gpu
, 1);

55 
	`aùiv©e_¬¿y_gpu
(
l
.
ouut_gpu
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
);

56 
	}
}

58 
	$backw¬d_aùiv©iÚ_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

60 
	`g¿d›Á_¬¿y_gpu
(
l
.
ouut_gpu
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
,†.
d–_gpu
);

61 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
d–_gpu
, 1, 
Ãt
.delta_gpu, 1);

62 
	}
}

	@activation_layer.h

1 #iâdeà
ACTIVATION_LAYER_H


2 
	#ACTIVATION_LAYER_H


	)

4 
	~"aùiv©iÚs.h
"

5 
	~"Ïy”.h
"

6 
	~"ÃtwÜk.h
"

8 
Ïy”
 
make_aùiv©iÚ_Ïy”
(
b©ch
, 
šputs
, 
ACTIVATION
 
aùiv©iÚ
);

10 
fÜw¬d_aùiv©iÚ_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

11 
backw¬d_aùiv©iÚ_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

13 #ifdeà
GPU


14 
fÜw¬d_aùiv©iÚ_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

15 
backw¬d_aùiv©iÚ_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

	@activations.c

1 
	~"aùiv©iÚs.h
"

3 
	~<m©h.h
>

4 
	~<¡dio.h
>

5 
	~<¡dlib.h
>

6 
	~<¡ršg.h
>

8 *
	$g‘_aùiv©iÚ_¡ršg
(
ACTIVATION
 
a
)

10 
a
){

11 
LOGISTIC
:

13 
LOGGY
:

15 
RELU
:

17 
ELU
:

19 
RELIE
:

21 
RAMP
:

23 
LINEAR
:

25 
TANH
:

27 
PLSE
:

29 
LEAKY
:

31 
STAIR
:

33 
HARDTAN
:

35 
LHTAN
:

41 
	}
}

43 
ACTIVATION
 
	$g‘_aùiv©iÚ
(*
s
)

45 ià(
	`¡rcmp
(
s
, "logi¡ic")==0è 
LOGISTIC
;

46 ià(
	`¡rcmp
(
s
, "loggy")==0è 
LOGGY
;

47 ià(
	`¡rcmp
(
s
, "»lu")==0è 
RELU
;

48 ià(
	`¡rcmp
(
s
, "–u")==0è 
ELU
;

49 ià(
	`¡rcmp
(
s
, "»l›")==0è 
RELIE
;

50 ià(
	`¡rcmp
(
s
, "¶£")==0è 
PLSE
;

51 ià(
	`¡rcmp
(
s
, "h¬dn")==0è 
HARDTAN
;

52 ià(
	`¡rcmp
(
s
, "lhn")==0è 
LHTAN
;

53 ià(
	`¡rcmp
(
s
, "lš—r")==0è 
LINEAR
;

54 ià(
	`¡rcmp
(
s
, "¿mp")==0è 
RAMP
;

55 ià(
	`¡rcmp
(
s
, "Ëaky")==0è 
LEAKY
;

56 ià(
	`¡rcmp
(
s
, "nh")==0è 
TANH
;

57 ià(
	`¡rcmp
(
s
, "¡aœ")==0è 
STAIR
;

58 
	`årštf
(
¡d”r
, "Couldn'ˆfšd‡ùiv©iÚ funùiÚ %s, gošg w™h ReLU\n", 
s
);

59  
RELU
;

60 
	}
}

62 
	$aùiv©e
(
x
, 
ACTIVATION
 
a
)

64 
a
){

65 
LINEAR
:

66  
	`lš—r_aùiv©e
(
x
);

67 
LOGISTIC
:

68  
	`logi¡ic_aùiv©e
(
x
);

69 
LOGGY
:

70  
	`loggy_aùiv©e
(
x
);

71 
RELU
:

72  
	`»lu_aùiv©e
(
x
);

73 
ELU
:

74  
	`–u_aùiv©e
(
x
);

75 
RELIE
:

76  
	`»l›_aùiv©e
(
x
);

77 
RAMP
:

78  
	`¿mp_aùiv©e
(
x
);

79 
LEAKY
:

80  
	`Ëaky_aùiv©e
(
x
);

81 
TANH
:

82  
	`nh_aùiv©e
(
x
);

83 
PLSE
:

84  
	`¶£_aùiv©e
(
x
);

85 
STAIR
:

86  
	`¡aœ_aùiv©e
(
x
);

87 
HARDTAN
:

88  
	`h¬dn_aùiv©e
(
x
);

89 
LHTAN
:

90  
	`lhn_aùiv©e
(
x
);

93 
	}
}

95 
	$aùiv©e_¬¿y
(*
x
, cÚ¡ 
n
, cÚ¡ 
ACTIVATION
 
a
)

97 
i
;

98 
i
 = 0; i < 
n
; ++i){

99 
x
[
i
] = 
	`aùiv©e
(x[i], 
a
);

101 
	}
}

103 
	$g¿d›Á
(
x
, 
ACTIVATION
 
a
)

105 
a
){

106 
LINEAR
:

107  
	`lš—r_g¿d›Á
(
x
);

108 
LOGISTIC
:

109  
	`logi¡ic_g¿d›Á
(
x
);

110 
LOGGY
:

111  
	`loggy_g¿d›Á
(
x
);

112 
RELU
:

113  
	`»lu_g¿d›Á
(
x
);

114 
ELU
:

115  
	`–u_g¿d›Á
(
x
);

116 
RELIE
:

117  
	`»l›_g¿d›Á
(
x
);

118 
RAMP
:

119  
	`¿mp_g¿d›Á
(
x
);

120 
LEAKY
:

121  
	`Ëaky_g¿d›Á
(
x
);

122 
TANH
:

123  
	`nh_g¿d›Á
(
x
);

124 
PLSE
:

125  
	`¶£_g¿d›Á
(
x
);

126 
STAIR
:

127  
	`¡aœ_g¿d›Á
(
x
);

128 
HARDTAN
:

129  
	`h¬dn_g¿d›Á
(
x
);

130 
LHTAN
:

131  
	`lhn_g¿d›Á
(
x
);

134 
	}
}

136 
	$g¿d›Á_¬¿y
(cÚ¡ *
x
, cÚ¡ 
n
, cÚ¡ 
ACTIVATION
 
a
, *
d–
)

138 
i
;

139 
i
 = 0; i < 
n
; ++i){

140 
d–
[
i
] *ğ
	`g¿d›Á
(
x
[i], 
a
);

142 
	}
}

	@activations.h

1 #iâdeà
ACTIVATIONS_H


2 
	#ACTIVATIONS_H


	)

3 
	~"d¬kÃt.h
"

4 
	~"cuda.h
"

5 
	~"m©h.h
"

7 
ACTIVATION
 
g‘_aùiv©iÚ
(*
s
);

9 *
g‘_aùiv©iÚ_¡ršg
(
ACTIVATION
 
a
);

10 
aùiv©e
(
x
, 
ACTIVATION
 
a
);

11 
g¿d›Á
(
x
, 
ACTIVATION
 
a
);

12 
g¿d›Á_¬¿y
(cÚ¡ *
x
, cÚ¡ 
n
, cÚ¡ 
ACTIVATION
 
a
, *
d–
);

13 
aùiv©e_¬¿y
(*
x
, cÚ¡ 
n
, cÚ¡ 
ACTIVATION
 
a
);

14 #ifdeà
GPU


15 
aùiv©e_¬¿y_gpu
(*
x
, 
n
, 
ACTIVATION
 
a
);

16 
g¿d›Á_¬¿y_gpu
(*
x
, 
n
, 
ACTIVATION
 
a
, *
d–
);

19 
šlše
 
	$¡aœ_aùiv©e
(
x
)

21 
n
 = 
	`æoÜ
(
x
);

22 ià(
n
%2 =ğ0è 
	`æoÜ
(
x
/2.);

23  (
x
 - 
n
è+ 
	`æoÜ
(x/2.);

24 
	}
}

25 
šlše
 
	$h¬dn_aùiv©e
(
x
)

27 ià(
x
 < -1)  -1;

28 ià(
x
 > 1)  1;

29  
x
;

30 
	}
}

31 
šlše
 
	$lš—r_aùiv©e
(
x
){ x;
	}
}

32 
šlše
 
	$logi¡ic_aùiv©e
(
x
){ 1./(1. + 
	`exp
(-x));
	}
}

33 
šlše
 
	$loggy_aùiv©e
(
x
){ 2./(1. + 
	`exp
(-x)è- 1;
	}
}

34 
šlše
 
	$»lu_aùiv©e
(
x
){ x*(x>0);
	}
}

35 
šlše
 
	$–u_aùiv©e
(
x
){ (x >ğ0)*x + (x < 0)*(
	`exp
(x)-1);
	}
}

36 
šlše
 
	$»l›_aùiv©e
(
x
){ (x>0è? x : .01*x;
	}
}

37 
šlše
 
	$¿mp_aùiv©e
(
x
){ x*(x>0)+.1*x;
	}
}

38 
šlše
 
	$Ëaky_aùiv©e
(
x
){ (x>0è? x : .1*x;
	}
}

39 
šlše
 
	$nh_aùiv©e
(
x
){ (
	`exp
(2*x)-1)/Óxp(2*x)+1);
	}
}

40 
šlše
 
	$¶£_aùiv©e
(
x
)

42 if(
x
 < -4)  .01 * (x + 4);

43 if(
x
 > 4)  .01 * (x - 4) + 1;

44  .125*
x
 + .5;

45 
	}
}

47 
šlše
 
	$lhn_aùiv©e
(
x
)

49 if(
x
 < 0)  .001*x;

50 if(
x
 > 1)  .001*(x-1) + 1;

51  
x
;

52 
	}
}

53 
šlše
 
	$lhn_g¿d›Á
(
x
)

55 if(
x
 > 0 && x < 1)  1;

57 
	}
}

59 
šlše
 
	$h¬dn_g¿d›Á
(
x
)

61 ià(
x
 > -1 && x < 1)  1;

63 
	}
}

64 
šlše
 
	$lš—r_g¿d›Á
(
x
){ 1;
	}
}

65 
šlše
 
	$logi¡ic_g¿d›Á
(
x
){ (1-x)*x;
	}
}

66 
šlše
 
	$loggy_g¿d›Á
(
x
)

68 
y
 = (
x
+1.)/2.;

69  2*(1-
y
)*y;

70 
	}
}

71 
šlše
 
	$¡aœ_g¿d›Á
(
x
)

73 ià(
	`æoÜ
(
x
) == x)  0;

75 
	}
}

76 
šlše
 
	$»lu_g¿d›Á
(
x
){ (x>0);
	}
}

77 
šlše
 
	$–u_g¿d›Á
(
x
){ (x >ğ0è+ (x < 0)*(x + 1);
	}
}

78 
šlše
 
	$»l›_g¿d›Á
(
x
){ (x>0è? 1 : .01;
	}
}

79 
šlše
 
	$¿mp_g¿d›Á
(
x
){ (x>0)+.1;
	}
}

80 
šlše
 
	$Ëaky_g¿d›Á
(
x
){ (x>0è? 1 : .1;
	}
}

81 
šlše
 
	$nh_g¿d›Á
(
x
){ 1-x*x;
	}
}

82 
šlše
 
	$¶£_g¿d›Á
(
x
){ (x < 0 || x > 1è? .01 : .125;
	}
}

	@avgpool_layer.c

1 
	~"avgpoŞ_Ïy”.h
"

2 
	~"cuda.h
"

3 
	~<¡dio.h
>

5 
avgpoŞ_Ïy”
 
	$make_avgpoŞ_Ïy”
(
b©ch
, 
w
, 
h
, 
c
)

7 
	`årštf
(
¡d”r
, "avg %4d x%4d x%4d -> %4d\n", 
w
, 
h
, 
c
, c);

8 
avgpoŞ_Ïy”
 
l
 = {0};

9 
l
.
ty³
 = 
AVGPOOL
;

10 
l
.
b©ch
 = batch;

11 
l
.
h
 = h;

12 
l
.
w
 = w;

13 
l
.
c
 = c;

14 
l
.
out_w
 = 1;

15 
l
.
out_h
 = 1;

16 
l
.
out_c
 = 
c
;

17 
l
.
ouuts
 =†.
out_c
;

18 
l
.
šputs
 = 
h
*
w
*
c
;

19 
ouut_size
 = 
l
.
ouuts
 * 
b©ch
;

20 
l
.
ouut
 = 
	`ÿÎoc
(
ouut_size
, ());

21 
l
.
d–
 = 
	`ÿÎoc
(
ouut_size
, ());

22 
l
.
fÜw¬d
 = 
fÜw¬d_avgpoŞ_Ïy”
;

23 
l
.
backw¬d
 = 
backw¬d_avgpoŞ_Ïy”
;

24 #ifdeà
GPU


25 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_avgpoŞ_Ïy”_gpu
;

26 
l
.
backw¬d_gpu
 = 
backw¬d_avgpoŞ_Ïy”_gpu
;

27 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
, 
ouut_size
);

28 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
, 
ouut_size
);

30  
l
;

31 
	}
}

33 
	$»size_avgpoŞ_Ïy”
(
avgpoŞ_Ïy”
 *
l
, 
w
, 
h
)

35 
l
->
w
 = w;

36 
l
->
h
 = h;

37 
l
->
šputs
 = 
h
*
w
*l->
c
;

38 
	}
}

40 
	$fÜw¬d_avgpoŞ_Ïy”
(cÚ¡ 
avgpoŞ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

42 
b
,
i
,
k
;

44 
b
 = 0; b < 
l
.
b©ch
; ++b){

45 
k
 = 0; k < 
l
.
c
; ++k){

46 
out_šdex
 = 
k
 + 
b
*
l
.
c
;

47 
l
.
ouut
[
out_šdex
] = 0;

48 
i
 = 0; i < 
l
.
h
*l.
w
; ++i){

49 
š_šdex
 = 
i
 + 
l
.
h
*l.
w
*(
k
 + 
b
*l.
c
);

50 
l
.
ouut
[
out_šdex
] +ğ
Ãt
.
šput
[
š_šdex
];

52 
l
.
ouut
[
out_šdex
] /ğl.
h
*l.
w
;

55 
	}
}

57 
	$backw¬d_avgpoŞ_Ïy”
(cÚ¡ 
avgpoŞ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

59 
b
,
i
,
k
;

61 
b
 = 0; b < 
l
.
b©ch
; ++b){

62 
k
 = 0; k < 
l
.
c
; ++k){

63 
out_šdex
 = 
k
 + 
b
*
l
.
c
;

64 
i
 = 0; i < 
l
.
h
*l.
w
; ++i){

65 
š_šdex
 = 
i
 + 
l
.
h
*l.
w
*(
k
 + 
b
*l.
c
);

66 
Ãt
.
d–
[
š_šdex
] +ğ
l
.d–[
out_šdex
] / (l.
h
*l.
w
);

70 
	}
}

	@avgpool_layer.h

1 #iâdeà
AVGPOOL_LAYER_H


2 
	#AVGPOOL_LAYER_H


	)

4 
	~"image.h
"

5 
	~"cuda.h
"

6 
	~"Ïy”.h
"

7 
	~"ÃtwÜk.h
"

9 
Ïy”
 
	tavgpoŞ_Ïy”
;

11 
image
 
g‘_avgpoŞ_image
(
avgpoŞ_Ïy”
 
l
);

12 
avgpoŞ_Ïy”
 
make_avgpoŞ_Ïy”
(
b©ch
, 
w
, 
h
, 
c
);

13 
»size_avgpoŞ_Ïy”
(
avgpoŞ_Ïy”
 *
l
, 
w
, 
h
);

14 
fÜw¬d_avgpoŞ_Ïy”
(cÚ¡ 
avgpoŞ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

15 
backw¬d_avgpoŞ_Ïy”
(cÚ¡ 
avgpoŞ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

17 #ifdeà
GPU


18 
fÜw¬d_avgpoŞ_Ïy”_gpu
(
avgpoŞ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

19 
backw¬d_avgpoŞ_Ïy”_gpu
(
avgpoŞ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

	@batchnorm_layer.c

1 
	~"cÚvŞutiÚ®_Ïy”.h
"

2 
	~"b©chnÜm_Ïy”.h
"

3 
	~"bÏs.h
"

4 
	~<¡dio.h
>

6 
Ïy”
 
	$make_b©chnÜm_Ïy”
(
b©ch
, 
w
, 
h
, 
c
)

8 
	`årštf
(
¡d”r
, "B©ch NÜm®iz©iÚ Lay”: %d x %d x %d image\n", 
w
,
h
,
c
);

9 
Ïy”
 
l
 = {0};

10 
l
.
ty³
 = 
BATCHNORM
;

11 
l
.
b©ch
 = batch;

12 
l
.
h
 =†.
out_h
 = h;

13 
l
.
w
 =†.
out_w
 = w;

14 
l
.
c
 =†.
out_c
 = c;

15 
l
.
ouut
 = 
	`ÿÎoc
(
h
 * 
w
 * 
c
 * 
b©ch
, ());

16 
l
.
d–
 = 
	`ÿÎoc
(
h
 * 
w
 * 
c
 * 
b©ch
, ());

17 
l
.
šputs
 = 
w
*
h
*
c
;

18 
l
.
ouuts
 =†.
šputs
;

20 
l
.
sÿËs
 = 
	`ÿÎoc
(
c
, ());

21 
l
.
sÿË_upd©es
 = 
	`ÿÎoc
(
c
, ());

22 
l
.
bŸ£s
 = 
	`ÿÎoc
(
c
, ());

23 
l
.
bŸs_upd©es
 = 
	`ÿÎoc
(
c
, ());

24 
i
;

25 
i
 = 0; i < 
c
; ++i){

26 
l
.
sÿËs
[
i
] = 1;

29 
l
.
m—n
 = 
	`ÿÎoc
(
c
, ());

30 
l
.
v¬Ÿnû
 = 
	`ÿÎoc
(
c
, ());

32 
l
.
rŞlšg_m—n
 = 
	`ÿÎoc
(
c
, ());

33 
l
.
rŞlšg_v¬Ÿnû
 = 
	`ÿÎoc
(
c
, ());

35 
l
.
fÜw¬d
 = 
fÜw¬d_b©chnÜm_Ïy”
;

36 
l
.
backw¬d
 = 
backw¬d_b©chnÜm_Ïy”
;

37 #ifdeà
GPU


38 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_b©chnÜm_Ïy”_gpu
;

39 
l
.
backw¬d_gpu
 = 
backw¬d_b©chnÜm_Ïy”_gpu
;

41 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
, 
h
 * 
w
 * 
c
 * 
b©ch
);

42 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
, 
h
 * 
w
 * 
c
 * 
b©ch
);

44 
l
.
bŸ£s_gpu
 = 
	`cuda_make_¬¿y
Ö.
bŸ£s
, 
c
);

45 
l
.
bŸs_upd©es_gpu
 = 
	`cuda_make_¬¿y
Ö.
bŸs_upd©es
, 
c
);

47 
l
.
sÿËs_gpu
 = 
	`cuda_make_¬¿y
Ö.
sÿËs
, 
c
);

48 
l
.
sÿË_upd©es_gpu
 = 
	`cuda_make_¬¿y
Ö.
sÿË_upd©es
, 
c
);

50 
l
.
m—n_gpu
 = 
	`cuda_make_¬¿y
Ö.
m—n
, 
c
);

51 
l
.
v¬Ÿnû_gpu
 = 
	`cuda_make_¬¿y
Ö.
v¬Ÿnû
, 
c
);

53 
l
.
rŞlšg_m—n_gpu
 = 
	`cuda_make_¬¿y
Ö.
m—n
, 
c
);

54 
l
.
rŞlšg_v¬Ÿnû_gpu
 = 
	`cuda_make_¬¿y
Ö.
v¬Ÿnû
, 
c
);

56 
l
.
m—n_d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
m—n
, 
c
);

57 
l
.
v¬Ÿnû_d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
v¬Ÿnû
, 
c
);

59 
l
.
x_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
,†.
b©ch
*l.
ouuts
);

60 
l
.
x_nÜm_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
,†.
b©ch
*l.
ouuts
);

61 #ifdeà
CUDNN


62 
	`cudÂC»©eT’sÜDesütÜ
(&
l
.
nÜmT’sÜDesc
);

63 
	`cudÂC»©eT’sÜDesütÜ
(&
l
.
d¡T’sÜDesc
);

64 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
,†.
b©ch
,†.
out_c
,†.
out_h
,†.
out_w
);

65 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
nÜmT’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 1,†.
out_c
, 1, 1);

69  
l
;

70 
	}
}

72 
	$backw¬d_sÿË_ıu
(*
x_nÜm
, *
d–
, 
b©ch
, 
n
, 
size
, *
sÿË_upd©es
)

74 
i
,
b
,
f
;

75 
f
 = 0; f < 
n
; ++f){

76 
sum
 = 0;

77 
b
 = 0; b < 
b©ch
; ++b){

78 
i
 = 0; i < 
size
; ++i){

79 
šdex
 = 
i
 + 
size
*(
f
 + 
n
*
b
);

80 
sum
 +ğ
d–
[
šdex
] * 
x_nÜm
[index];

83 
sÿË_upd©es
[
f
] +ğ
sum
;

85 
	}
}

87 
	$m—n_d–_ıu
(*
d–
, *
v¬Ÿnû
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
, *
m—n_d–
)

90 
i
,
j
,
k
;

91 
i
 = 0; i < 
f‹rs
; ++i){

92 
m—n_d–
[
i
] = 0;

93 
j
 = 0; j < 
b©ch
; ++j) {

94 
k
 = 0; k < 
¥©Ÿl
; ++k) {

95 
šdex
 = 
j
*
f‹rs
*
¥©Ÿl
 + 
i
*¥©ŸÈ+ 
k
;

96 
m—n_d–
[
i
] +ğ
d–
[
šdex
];

99 
m—n_d–
[
i
] *ğ(-1./
	`sq¹
(
v¬Ÿnû
[i] + .00001f));

101 
	}
}

102 
	$v¬Ÿnû_d–_ıu
(*
x
, *
d–
, *
m—n
, *
v¬Ÿnû
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
, *
v¬Ÿnû_d–
)

105 
i
,
j
,
k
;

106 
i
 = 0; i < 
f‹rs
; ++i){

107 
v¬Ÿnû_d–
[
i
] = 0;

108 
j
 = 0; j < 
b©ch
; ++j){

109 
k
 = 0; k < 
¥©Ÿl
; ++k){

110 
šdex
 = 
j
*
f‹rs
*
¥©Ÿl
 + 
i
*¥©ŸÈ+ 
k
;

111 
v¬Ÿnû_d–
[
i
] +ğ
d–
[
šdex
]*(
x
[šdex] - 
m—n
[i]);

114 
v¬Ÿnû_d–
[
i
] *ğ-.5 * 
	`pow
(
v¬Ÿnû
[i] + .00001f, ()(-3./2.));

116 
	}
}

117 
	$nÜm®ize_d–_ıu
(*
x
, *
m—n
, *
v¬Ÿnû
, *
m—n_d–
, *
v¬Ÿnû_d–
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
, *
d–
)

119 
f
, 
j
, 
k
;

120 
j
 = 0; j < 
b©ch
; ++j){

121 
f
 = 0; f < 
f‹rs
; ++f){

122 
k
 = 0; k < 
¥©Ÿl
; ++k){

123 
šdex
 = 
j
*
f‹rs
*
¥©Ÿl
 + 
f
*¥©ŸÈ+ 
k
;

124 
d–
[
šdex
] = d–[šdex] * 1./(
	`sq¹
(
v¬Ÿnû
[
f
] + .00001f)è+ 
v¬Ÿnû_d–
[f] * 2. * (
x
[šdex] - 
m—n
[f]è/ (
¥©Ÿl
 * 
b©ch
è+ 
m—n_d–
[f]/(spatial*batch);

128 
	}
}

130 
	$»size_b©chnÜm_Ïy”
(
Ïy”
 *Ïy”, 
w
, 
h
)

132 
	`årštf
(
¡d”r
, "Not implemented\n");

133 
	}
}

135 
	$fÜw¬d_b©chnÜm_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

137 if(
l
.
ty³
 =ğ
BATCHNORM
è
	`cİy_ıu
Ö.
ouuts
*l.
b©ch
, 
Ãt
.
šput
, 1,†.
ouut
, 1);

138 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
ouut
, 1,†.
x
, 1);

139 if(
Ãt
.
Œaš
){

140 
	`m—n_ıu
(
l
.
ouut
,†.
b©ch
,†.
out_c
,†.
out_h
*l.
out_w
,†.
m—n
);

141 
	`v¬Ÿnû_ıu
(
l
.
ouut
,†.
m—n
,†.
b©ch
,†.
out_c
,†.
out_h
*l.
out_w
,†.
v¬Ÿnû
);

143 
	`sÿl_ıu
(
l
.
out_c
, .99,†.
rŞlšg_m—n
, 1);

144 
	`axpy_ıu
(
l
.
out_c
, .01,†.
m—n
, 1,†.
rŞlšg_m—n
, 1);

145 
	`sÿl_ıu
(
l
.
out_c
, .99,†.
rŞlšg_v¬Ÿnû
, 1);

146 
	`axpy_ıu
(
l
.
out_c
, .01,†.
v¬Ÿnû
, 1,†.
rŞlšg_v¬Ÿnû
, 1);

148 
	`nÜm®ize_ıu
(
l
.
ouut
,†.
m—n
,†.
v¬Ÿnû
,†.
b©ch
,†.
out_c
,†.
out_h
*l.
out_w
);

149 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
ouut
, 1,†.
x_nÜm
, 1);

151 
	`nÜm®ize_ıu
(
l
.
ouut
,†.
rŞlšg_m—n
,†.
rŞlšg_v¬Ÿnû
,†.
b©ch
,†.
out_c
,†.
out_h
*l.
out_w
);

153 
	`sÿË_bŸs
(
l
.
ouut
,†.
sÿËs
,†.
b©ch
,†.
out_c
,†.
out_h
*l.
out_w
);

154 
	`add_bŸs
(
l
.
ouut
,†.
bŸ£s
,†.
b©ch
,†.
out_c
,†.
out_h
*l.
out_w
);

155 
	}
}

157 
	$backw¬d_b©chnÜm_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

159 if(!
Ãt
.
Œaš
){

160 
l
.
m—n
 =†.
rŞlšg_m—n
;

161 
l
.
v¬Ÿnû
 =†.
rŞlšg_v¬Ÿnû
;

163 
	`backw¬d_bŸs
(
l
.
bŸs_upd©es
,†.
d–
,†.
b©ch
,†.
out_c
,†.
out_w
*l.
out_h
);

164 
	`backw¬d_sÿË_ıu
(
l
.
x_nÜm
,†.
d–
,†.
b©ch
,†.
out_c
,†.
out_w
*l.
out_h
,†.
sÿË_upd©es
);

166 
	`sÿË_bŸs
(
l
.
d–
,†.
sÿËs
,†.
b©ch
,†.
out_c
,†.
out_h
*l.
out_w
);

168 
	`m—n_d–_ıu
(
l
.
d–
,†.
v¬Ÿnû
,†.
b©ch
,†.
out_c
,†.
out_w
*l.
out_h
,†.
m—n_d–
);

169 
	`v¬Ÿnû_d–_ıu
(
l
.
x
,†.
d–
,†.
m—n
,†.
v¬Ÿnû
,†.
b©ch
,†.
out_c
,†.
out_w
*l.
out_h
,†.
v¬Ÿnû_d–
);

170 
	`nÜm®ize_d–_ıu
(
l
.
x
,†.
m—n
,†.
v¬Ÿnû
,†.
m—n_d–
,†.
v¬Ÿnû_d–
,†.
b©ch
,†.
out_c
,†.
out_w
*l.
out_h
,†.
d–
);

171 if(
l
.
ty³
 =ğ
BATCHNORM
è
	`cİy_ıu
Ö.
ouuts
*l.
b©ch
,†.
d–
, 1, 
Ãt
.delta, 1);

172 
	}
}

174 #ifdeà
GPU


176 
	$puÎ_b©chnÜm_Ïy”
(
Ïy”
 
l
)

178 
	`cuda_puÎ_¬¿y
(
l
.
sÿËs_gpu
,†.
sÿËs
,†.
c
);

179 
	`cuda_puÎ_¬¿y
(
l
.
rŞlšg_m—n_gpu
,†.
rŞlšg_m—n
,†.
c
);

180 
	`cuda_puÎ_¬¿y
(
l
.
rŞlšg_v¬Ÿnû_gpu
,†.
rŞlšg_v¬Ÿnû
,†.
c
);

181 
	}
}

182 
	$push_b©chnÜm_Ïy”
(
Ïy”
 
l
)

184 
	`cuda_push_¬¿y
(
l
.
sÿËs_gpu
,†.
sÿËs
,†.
c
);

185 
	`cuda_push_¬¿y
(
l
.
rŞlšg_m—n_gpu
,†.
rŞlšg_m—n
,†.
c
);

186 
	`cuda_push_¬¿y
(
l
.
rŞlšg_v¬Ÿnû_gpu
,†.
rŞlšg_v¬Ÿnû
,†.
c
);

187 
	}
}

189 
	$fÜw¬d_b©chnÜm_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

191 if(
l
.
ty³
 =ğ
BATCHNORM
è
	`cİy_gpu
Ö.
ouuts
*l.
b©ch
, 
Ãt
.
šput_gpu
, 1,†.
ouut_gpu
, 1);

192 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
ouut_gpu
, 1,†.
x_gpu
, 1);

193 ià(
Ãt
.
Œaš
) {

194 #ifdeà
CUDNN


195 
Úe
 = 1;

196 
z”o
 = 0;

197 
	`cudÂB©chNÜm®iz©iÚFÜw¬dT¿ššg
(
	`cudÂ_hªdË
(),

198 
CUDNN_BATCHNORM_SPATIAL
,

199 &
Úe
,

200 &
z”o
,

201 
l
.
d¡T’sÜDesc
,

202 
l
.
x_gpu
,

203 
l
.
d¡T’sÜDesc
,

204 
l
.
ouut_gpu
,

205 
l
.
nÜmT’sÜDesc
,

206 
l
.
sÿËs_gpu
,

207 
l
.
bŸ£s_gpu
,

209 
l
.
rŞlšg_m—n_gpu
,

210 
l
.
rŞlšg_v¬Ÿnû_gpu
,

212 
l
.
m—n_gpu
,

213 
l
.
v¬Ÿnû_gpu
);

215 
	`ç¡_m—n_gpu
(
l
.
ouut_gpu
,†.
b©ch
,†.
out_c
,†.
out_h
*l.
out_w
,†.
m—n_gpu
);

216 
	`ç¡_v¬Ÿnû_gpu
(
l
.
ouut_gpu
,†.
m—n_gpu
,†.
b©ch
,†.
out_c
,†.
out_h
*l.
out_w
,†.
v¬Ÿnû_gpu
);

218 
	`sÿl_gpu
(
l
.
out_c
, .99,†.
rŞlšg_m—n_gpu
, 1);

219 
	`axpy_gpu
(
l
.
out_c
, .01,†.
m—n_gpu
, 1,†.
rŞlšg_m—n_gpu
, 1);

220 
	`sÿl_gpu
(
l
.
out_c
, .99,†.
rŞlšg_v¬Ÿnû_gpu
, 1);

221 
	`axpy_gpu
(
l
.
out_c
, .01,†.
v¬Ÿnû_gpu
, 1,†.
rŞlšg_v¬Ÿnû_gpu
, 1);

223 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
ouut_gpu
, 1,†.
x_gpu
, 1);

224 
	`nÜm®ize_gpu
(
l
.
ouut_gpu
,†.
m—n_gpu
,†.
v¬Ÿnû_gpu
,†.
b©ch
,†.
out_c
,†.
out_h
*l.
out_w
);

225 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
ouut_gpu
, 1,†.
x_nÜm_gpu
, 1);

227 
	`sÿË_bŸs_gpu
(
l
.
ouut_gpu
,†.
sÿËs_gpu
,†.
b©ch
,†.
out_c
,†.
out_h
*l.
out_w
);

228 
	`add_bŸs_gpu
(
l
.
ouut_gpu
,†.
bŸ£s_gpu
,†.
b©ch
,†.
out_c
,†.
out_w
*l.
out_h
);

231 
	`nÜm®ize_gpu
(
l
.
ouut_gpu
,†.
rŞlšg_m—n_gpu
,†.
rŞlšg_v¬Ÿnû_gpu
,†.
b©ch
,†.
out_c
,†.
out_h
*l.
out_w
);

232 
	`sÿË_bŸs_gpu
(
l
.
ouut_gpu
,†.
sÿËs_gpu
,†.
b©ch
,†.
out_c
,†.
out_h
*l.
out_w
);

233 
	`add_bŸs_gpu
(
l
.
ouut_gpu
,†.
bŸ£s_gpu
,†.
b©ch
,†.
out_c
,†.
out_w
*l.
out_h
);

236 
	}
}

238 
	$backw¬d_b©chnÜm_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

240 if(!
Ãt
.
Œaš
){

241 
l
.
m—n_gpu
 =†.
rŞlšg_m—n_gpu
;

242 
l
.
v¬Ÿnû_gpu
 =†.
rŞlšg_v¬Ÿnû_gpu
;

244 #ifdeà
CUDNN


245 
Úe
 = 1;

246 
z”o
 = 0;

247 
	`cudÂB©chNÜm®iz©iÚBackw¬d
(
	`cudÂ_hªdË
(),

248 
CUDNN_BATCHNORM_SPATIAL
,

249 &
Úe
,

250 &
z”o
,

251 &
Úe
,

252 &
Úe
,

253 
l
.
d¡T’sÜDesc
,

254 
l
.
x_gpu
,

255 
l
.
d¡T’sÜDesc
,

256 
l
.
d–_gpu
,

257 
l
.
d¡T’sÜDesc
,

258 
l
.
x_nÜm_gpu
,

259 
l
.
nÜmT’sÜDesc
,

260 
l
.
sÿËs_gpu
,

261 
l
.
sÿË_upd©es_gpu
,

262 
l
.
bŸs_upd©es_gpu
,

264 
l
.
m—n_gpu
,

265 
l
.
v¬Ÿnû_gpu
);

266 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
x_nÜm_gpu
, 1,†.
d–_gpu
, 1);

268 
	`backw¬d_bŸs_gpu
(
l
.
bŸs_upd©es_gpu
,†.
d–_gpu
,†.
b©ch
,†.
out_c
,†.
out_w
*l.
out_h
);

269 
	`backw¬d_sÿË_gpu
(
l
.
x_nÜm_gpu
,†.
d–_gpu
,†.
b©ch
,†.
out_c
,†.
out_w
*l.
out_h
,†.
sÿË_upd©es_gpu
);

271 
	`sÿË_bŸs_gpu
(
l
.
d–_gpu
,†.
sÿËs_gpu
,†.
b©ch
,†.
out_c
,†.
out_h
*l.
out_w
);

273 
	`ç¡_m—n_d–_gpu
(
l
.
d–_gpu
,†.
v¬Ÿnû_gpu
,†.
b©ch
,†.
out_c
,†.
out_w
*l.
out_h
,†.
m—n_d–_gpu
);

274 
	`ç¡_v¬Ÿnû_d–_gpu
(
l
.
x_gpu
,†.
d–_gpu
,†.
m—n_gpu
,†.
v¬Ÿnû_gpu
,†.
b©ch
,†.
out_c
,†.
out_w
*l.
out_h
,†.
v¬Ÿnû_d–_gpu
);

275 
	`nÜm®ize_d–_gpu
(
l
.
x_gpu
,†.
m—n_gpu
,†.
v¬Ÿnû_gpu
,†.
m—n_d–_gpu
,†.
v¬Ÿnû_d–_gpu
,†.
b©ch
,†.
out_c
,†.
out_w
*l.
out_h
,†.
d–_gpu
);

277 if(
l
.
ty³
 =ğ
BATCHNORM
è
	`cİy_gpu
Ö.
ouuts
*l.
b©ch
,†.
d–_gpu
, 1, 
Ãt
.delta_gpu, 1);

278 
	}
}

	@batchnorm_layer.h

1 #iâdeà
BATCHNORM_LAYER_H


2 
	#BATCHNORM_LAYER_H


	)

4 
	~"image.h
"

5 
	~"Ïy”.h
"

6 
	~"ÃtwÜk.h
"

8 
Ïy”
 
make_b©chnÜm_Ïy”
(
b©ch
, 
w
, 
h
, 
c
);

9 
fÜw¬d_b©chnÜm_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

10 
backw¬d_b©chnÜm_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

12 #ifdeà
GPU


13 
fÜw¬d_b©chnÜm_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

14 
backw¬d_b©chnÜm_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

15 
puÎ_b©chnÜm_Ïy”
(
Ïy”
 
l
);

16 
push_b©chnÜm_Ïy”
(
Ïy”
 
l
);

	@blas.c

1 
	~"bÏs.h
"

3 
	~<m©h.h
>

4 
	~<as£¹.h
>

5 
	~<æßt.h
>

6 
	~<¡dio.h
>

7 
	~<¡dlib.h
>

8 
	~<¡ršg.h
>

9 
	$»Üg_ıu
(*
x
, 
w
, 
h
, 
c
, 
b©ch
, 
¡ride
, 
fÜw¬d
, *
out
)

11 
b
,
i
,
j
,
k
;

12 
out_c
 = 
c
/(
¡ride
*stride);

14 
b
 = 0; b < 
b©ch
; ++b){

15 
k
 = 0; k < 
c
; ++k){

16 
j
 = 0; j < 
h
; ++j){

17 
i
 = 0; i < 
w
; ++i){

18 
š_šdex
 = 
i
 + 
w
*(
j
 + 
h
*(
k
 + 
c
*
b
));

19 
c2
 = 
k
 % 
out_c
;

20 
off£t
 = 
k
 / 
out_c
;

21 
w2
 = 
i
*
¡ride
 + 
off£t
 % stride;

22 
h2
 = 
j
*
¡ride
 + 
off£t
 / stride;

23 
out_šdex
 = 
w2
 + 
w
*
¡ride
*(
h2
 + 
h
*¡ride*(
c2
 + 
out_c
*
b
));

24 if(
fÜw¬d
è
out
[
out_šdex
] = 
x
[
š_šdex
];

25 
out
[
š_šdex
] = 
x
[
out_šdex
];

30 
	}
}

32 
	$æ©‹n
(*
x
, 
size
, 
Ïy”s
, 
b©ch
, 
fÜw¬d
)

34 *
sw­
 = 
	`ÿÎoc
(
size
*
Ïy”s
*
b©ch
, ());

35 
i
,
c
,
b
;

36 
b
 = 0; b < 
b©ch
; ++b){

37 
c
 = 0; c < 
Ïy”s
; ++c){

38 
i
 = 0; i < 
size
; ++i){

39 
i1
 = 
b
*
Ïy”s
*
size
 + 
c
*siz+ 
i
;

40 
i2
 = 
b
*
Ïy”s
*
size
 + 
i
*Ïy” + 
c
;

41 ià(
fÜw¬d
è
sw­
[
i2
] = 
x
[
i1
];

42 
sw­
[
i1
] = 
x
[
i2
];

46 
	`memıy
(
x
, 
sw­
, 
size
*
Ïy”s
*
b©ch
*());

47 
	`ä“
(
sw­
);

48 
	}
}

50 
	$weigh‹d_sum_ıu
(*
a
, *
b
, *
s
, 
n
, *
c
)

52 
i
;

53 
i
 = 0; i < 
n
; ++i){

54 
c
[
i
] = 
s
[i]*
a
[i] + (1-s[i])*(
b
 ? b[i] : 0);

56 
	}
}

58 
	$weigh‹d_d–_ıu
(*
a
, *
b
, *
s
, *
da
, *
db
, *
ds
, 
n
, *
dc
)

60 
i
;

61 
i
 = 0; i < 
n
; ++i){

62 if(
da
èda[
i
] +ğ
dc
[i] * 
s
[i];

63 if(
db
èdb[
i
] +ğ
dc
[i] * (1-
s
[i]);

64 
ds
[
i
] +ğ
dc
[i] * (
a
[i] - 
b
[i]);

66 
	}
}

68 
	$shÜtcut_ıu
(
b©ch
, 
w1
, 
h1
, 
c1
, *
add
, 
w2
, 
h2
, 
c2
, 
s1
, 
s2
, *
out
)

70 
¡ride
 = 
w1
/
w2
;

71 
§m¶e
 = 
w2
/
w1
;

72 
	`as£¹
(
¡ride
 =ğ
h1
/
h2
);

73 
	`as£¹
(
§m¶e
 =ğ
h2
/
h1
);

74 if(
¡ride
 < 1) stride = 1;

75 if(
§m¶e
 < 1) sample = 1;

76 
mšw
 = (
w1
 < 
w2
) ? w1 : w2;

77 
mšh
 = (
h1
 < 
h2
) ? h1 : h2;

78 
mšc
 = (
c1
 < 
c2
) ? c1 : c2;

80 
i
,
j
,
k
,
b
;

81 
b
 = 0; b < 
b©ch
; ++b){

82 
k
 = 0; k < 
mšc
; ++k){

83 
j
 = 0; j < 
mšh
; ++j){

84 
i
 = 0; i < 
mšw
; ++i){

85 
out_šdex
 = 
i
*
§m¶e
 + 
w2
*(
j
*§m¶+ 
h2
*(
k
 + 
c2
*
b
));

86 
add_šdex
 = 
i
*
¡ride
 + 
w1
*(
j
*¡rid+ 
h1
*(
k
 + 
c1
*
b
));

87 
out
[
out_šdex
] = 
s1
*out[out_šdex] + 
s2
*
add
[
add_šdex
];

92 
	}
}

94 
	$m—n_ıu
(*
x
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
, *
m—n
)

96 
sÿË
 = 1./(
b©ch
 * 
¥©Ÿl
);

97 
i
,
j
,
k
;

98 
i
 = 0; i < 
f‹rs
; ++i){

99 
m—n
[
i
] = 0;

100 
j
 = 0; j < 
b©ch
; ++j){

101 
k
 = 0; k < 
¥©Ÿl
; ++k){

102 
šdex
 = 
j
*
f‹rs
*
¥©Ÿl
 + 
i
*¥©ŸÈ+ 
k
;

103 
m—n
[
i
] +ğ
x
[
šdex
];

106 
m—n
[
i
] *ğ
sÿË
;

108 
	}
}

110 
	$v¬Ÿnû_ıu
(*
x
, *
m—n
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
, *
v¬Ÿnû
)

112 
sÿË
 = 1./(
b©ch
 * 
¥©Ÿl
 - 1);

113 
i
,
j
,
k
;

114 
i
 = 0; i < 
f‹rs
; ++i){

115 
v¬Ÿnû
[
i
] = 0;

116 
j
 = 0; j < 
b©ch
; ++j){

117 
k
 = 0; k < 
¥©Ÿl
; ++k){

118 
šdex
 = 
j
*
f‹rs
*
¥©Ÿl
 + 
i
*¥©ŸÈ+ 
k
;

119 
v¬Ÿnû
[
i
] +ğ
	`pow
((
x
[
šdex
] - 
m—n
[i]), 2);

122 
v¬Ÿnû
[
i
] *ğ
sÿË
;

124 
	}
}

126 
	$l2nÜm®ize_ıu
(*
x
, *
dx
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
)

128 
b
,
f
,
i
;

129 
b
 = 0; b < 
b©ch
; ++b){

130 
i
 = 0; i < 
¥©Ÿl
; ++i){

131 
sum
 = 0;

132 
f
 = 0; f < 
f‹rs
; ++f){

133 
šdex
 = 
b
*
f‹rs
*
¥©Ÿl
 + 
f
*¥©ŸÈ+ 
i
;

134 
sum
 +ğ
	`powf
(
x
[
šdex
], 2);

136 
sum
 = 
	`sq¹f
(sum);

137 
f
 = 0; f < 
f‹rs
; ++f){

138 
šdex
 = 
b
*
f‹rs
*
¥©Ÿl
 + 
f
*¥©ŸÈ+ 
i
;

139 
x
[
šdex
] /ğ
sum
;

140 
dx
[
šdex
] = (1 - 
x
[šdex]è/ 
sum
;

144 
	}
}

147 
	$nÜm®ize_ıu
(*
x
, *
m—n
, *
v¬Ÿnû
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
)

149 
b
, 
f
, 
i
;

150 
b
 = 0; b < 
b©ch
; ++b){

151 
f
 = 0; f < 
f‹rs
; ++f){

152 
i
 = 0; i < 
¥©Ÿl
; ++i){

153 
šdex
 = 
b
*
f‹rs
*
¥©Ÿl
 + 
f
*¥©ŸÈ+ 
i
;

154 
x
[
šdex
] = (x[šdex] - 
m—n
[
f
])/(
	`sq¹
(
v¬Ÿnû
[f]) + .000001f);

158 
	}
}

160 
	$cÚ¡_ıu
(
N
, 
ALPHA
, *
X
, 
INCX
)

162 
i
;

163 
i
 = 0; i < 
N
; ++iè
X
[i*
INCX
] = 
ALPHA
;

164 
	}
}

166 
	$mul_ıu
(
N
, *
X
, 
INCX
, *
Y
, 
INCY
)

168 
i
;

169 
i
 = 0; i < 
N
; ++iè
Y
[i*
INCY
] *ğ
X
[i*
INCX
];

170 
	}
}

172 
	$pow_ıu
(
N
, 
ALPHA
, *
X
, 
INCX
, *
Y
, 
INCY
)

174 
i
;

175 
i
 = 0; i < 
N
; ++iè
Y
[i*
INCY
] = 
	`pow
(
X
[i*
INCX
], 
ALPHA
);

176 
	}
}

178 
	$axpy_ıu
(
N
, 
ALPHA
, *
X
, 
INCX
, *
Y
, 
INCY
)

180 
i
;

181 
i
 = 0; i < 
N
; ++iè
Y
[i*
INCY
] +ğ
ALPHA
*
X
[i*
INCX
];

182 
	}
}

184 
	$sÿl_ıu
(
N
, 
ALPHA
, *
X
, 
INCX
)

186 
i
;

187 
i
 = 0; i < 
N
; ++iè
X
[i*
INCX
] *ğ
ALPHA
;

188 
	}
}

190 
	$fl_ıu
(
N
, 
ALPHA
, *
X
, 
INCX
)

192 
i
;

193 
i
 = 0; i < 
N
; ++iè
X
[i*
INCX
] = 
ALPHA
;

194 
	}
}

196 
	$deš‹r_ıu
(
NX
, *
X
, 
NY
, *
Y
, 
B
, *
OUT
)

198 
i
, 
j
;

199 
šdex
 = 0;

200 
j
 = 0; j < 
B
; ++j) {

201 
i
 = 0; i < 
NX
; ++i){

202 if(
X
èX[
j
*
NX
 + 
i
] +ğ
OUT
[
šdex
];

203 ++
šdex
;

205 
i
 = 0; i < 
NY
; ++i){

206 if(
Y
èY[
j
*
NY
 + 
i
] +ğ
OUT
[
šdex
];

207 ++
šdex
;

210 
	}
}

212 
	$š‹r_ıu
(
NX
, *
X
, 
NY
, *
Y
, 
B
, *
OUT
)

214 
i
, 
j
;

215 
šdex
 = 0;

216 
j
 = 0; j < 
B
; ++j) {

217 
i
 = 0; i < 
NX
; ++i){

218 
OUT
[
šdex
++] = 
X
[
j
*
NX
 + 
i
];

220 
i
 = 0; i < 
NY
; ++i){

221 
OUT
[
šdex
++] = 
Y
[
j
*
NY
 + 
i
];

224 
	}
}

226 
	$cİy_ıu
(
N
, *
X
, 
INCX
, *
Y
, 
INCY
)

228 
i
;

229 
i
 = 0; i < 
N
; ++iè
Y
[i*
INCY
] = 
X
[i*
INCX
];

230 
	}
}

232 
	$muÉ_add_što_ıu
(
N
, *
X
, *
Y
, *
Z
)

234 
i
;

235 
i
 = 0; i < 
N
; ++iè
Z
[i] +ğ
X
[i]*
Y
[i];

236 
	}
}

238 
	$smoÙh_l1_ıu
(
n
, *
´ed
, *
Œuth
, *
d–
, *
”rÜ
)

240 
i
;

241 
i
 = 0; i < 
n
; ++i){

242 
diff
 = 
Œuth
[
i
] - 
´ed
[i];

243 
abs_v®
 = 
	`çbs
(
diff
);

244 if(
abs_v®
 < 1) {

245 
”rÜ
[
i
] = 
diff
 * diff;

246 
d–
[
i
] = 
diff
;

249 
”rÜ
[
i
] = 2*
abs_v®
 - 1;

250 
d–
[
i
] = (
diff
 < 0) ? 1 : -1;

253 
	}
}

255 
	$l1_ıu
(
n
, *
´ed
, *
Œuth
, *
d–
, *
”rÜ
)

257 
i
;

258 
i
 = 0; i < 
n
; ++i){

259 
diff
 = 
Œuth
[
i
] - 
´ed
[i];

260 
”rÜ
[
i
] = 
	`çbs
(
diff
);

261 
d–
[
i
] = 
diff
 > 0 ? 1 : -1;

263 
	}
}

265 
	$soámax_x_’t_ıu
(
n
, *
´ed
, *
Œuth
, *
d–
, *
”rÜ
)

267 
i
;

268 
i
 = 0; i < 
n
; ++i){

269 
t
 = 
Œuth
[
i
];

270 
p
 = 
´ed
[
i
];

271 
”rÜ
[
i
] = (
t
è? -
	`log
(
p
) : 0;

272 
d–
[
i
] = 
t
-
p
;

274 
	}
}

276 
	$logi¡ic_x_’t_ıu
(
n
, *
´ed
, *
Œuth
, *
d–
, *
”rÜ
)

278 
i
;

279 
š‹r£ùiÚ
 =0,
Œue_sum
=0,
´ed_sum
=0;

280 
i
 = 0; i < 
n
; ++i){

281 
š‹r£ùiÚ
 +ğ
Œuth
[
i
] * 
´ed
[i];

282 
Œue_sum
 +ğ
Œuth
[
i
] *ruth[i];

283 
´ed_sum
 +ğ
´ed
[
i
] *…red[i];

284 
t
 = 
Œuth
[
i
];

285 
p
 = 
´ed
[
i
];

287 
d–
[
i
] = 
t
-
p
;

289 
”rÜ
[0] = (2.0 * 
š‹r£ùiÚ
 + 1.0è/ (
Œue_sum
 + 
´ed_sum
 + 1.0);

290 
	}
}

292 
	$l2_ıu
(
n
, *
´ed
, *
Œuth
, *
d–
, *
”rÜ
)

294 
i
;

295 
i
 = 0; i < 
n
; ++i){

296 
diff
 = 
Œuth
[
i
] - 
´ed
[i];

297 
”rÜ
[
i
] = 
diff
 * diff;

298 
d–
[
i
] = 
diff
;

300 
	}
}

302 
	$dÙ_ıu
(
N
, *
X
, 
INCX
, *
Y
, 
INCY
)

304 
i
;

305 
dÙ
 = 0;

306 
i
 = 0; i < 
N
; ++iè
dÙ
 +ğ
X
[i*
INCX
] * 
Y
[i*
INCY
];

307  
dÙ
;

308 
	}
}

310 
	$soámax
(*
šput
, 
n
, 
‹mp
, 
¡ride
, *
ouut
)

312 
i
;

313 
sum
 = 0;

314 
Ïrge¡
 = -
FLT_MAX
;

315 
i
 = 0; i < 
n
; ++i){

316 if(
šput
[
i
*
¡ride
] > 
Ïrge¡
)†argest = input[i*stride];

318 
i
 = 0; i < 
n
; ++i){

319 
e
 = 
	`exp
(
šput
[
i
*
¡ride
]/
‹mp
 - 
Ïrge¡
/temp);

320 
sum
 +ğ
e
;

321 
ouut
[
i
*
¡ride
] = 
e
;

323 
i
 = 0; i < 
n
; ++i){

324 
ouut
[
i
*
¡ride
] /ğ
sum
;

326 
	}
}

329 
	$soámax_ıu
(*
šput
, 
n
, 
b©ch
, 
b©ch_off£t
, 
groups
, 
group_off£t
, 
¡ride
, 
‹mp
, *
ouut
)

331 
g
, 
b
;

332 
b
 = 0; b < 
b©ch
; ++b){

333 
g
 = 0; g < 
groups
; ++g){

334 
	`soámax
(
šput
 + 
b
*
b©ch_off£t
 + 
g
*
group_off£t
, 
n
, 
‹mp
, 
¡ride
, 
ouut
 + b*batch_offset + g*group_offset);

337 
	}
}

339 
	$up§m¶e_ıu
(*
š
, 
w
, 
h
, 
c
, 
b©ch
, 
¡ride
, 
fÜw¬d
, 
sÿË
, *
out
)

341 
i
, 
j
, 
k
, 
b
;

342 
b
 = 0; b < 
b©ch
; ++b){

343 
k
 = 0; k < 
c
; ++k){

344 
j
 = 0; j < 
h
*
¡ride
; ++j){

345 
i
 = 0; i < 
w
*
¡ride
; ++i){

346 
š_šdex
 = 
b
*
w
*
h
*
c
 + 
k
*w*h + (
j
/
¡ride
)*w + 
i
/stride;

347 
out_šdex
 = 
b
*
w
*
h
*
c
*
¡ride
*¡rid+ 
k
*w*h*¡ride*¡rid+ 
j
*w*¡rid+ 
i
;

348 if(
fÜw¬d
è
out
[
out_šdex
] = 
sÿË
*
š
[
š_šdex
];

349 
š
[
š_šdex
] +ğ
sÿË
*
out
[
out_šdex
];

354 
	}
}

	@blas.h

1 #iâdeà
BLAS_H


2 
	#BLAS_H


	)

3 
	~"d¬kÃt.h
"

5 
æ©‹n
(*
x
, 
size
, 
Ïy”s
, 
b©ch
, 
fÜw¬d
);

6 
pm
(
M
, 
N
, *
A
);

7 *
¿ndom_m©rix
(
rows
, 
cŞs
);

8 
time_¿ndom_m©rix
(
TA
, 
TB
, 
m
, 
k
, 
n
);

9 
»Üg_ıu
(*
x
, 
w
, 
h
, 
c
, 
b©ch
, 
¡ride
, 
fÜw¬d
, *
out
);

11 
‹¡_bÏs
();

13 
š‹r_ıu
(
NX
, *
X
, 
NY
, *
Y
, 
B
, *
OUT
);

14 
deš‹r_ıu
(
NX
, *
X
, 
NY
, *
Y
, 
B
, *
OUT
);

15 
muÉ_add_što_ıu
(
N
, *
X
, *
Y
, *
Z
);

17 
cÚ¡_ıu
(
N
, 
ALPHA
, *
X
, 
INCX
);

18 
cÚ¡¿š_gpu
(
N
, 
ALPHA
, * 
X
, 
INCX
);

19 
pow_ıu
(
N
, 
ALPHA
, *
X
, 
INCX
, *
Y
, 
INCY
);

20 
mul_ıu
(
N
, *
X
, 
INCX
, *
Y
, 
INCY
);

22 
‹¡_gpu_bÏs
();

23 
shÜtcut_ıu
(
b©ch
, 
w1
, 
h1
, 
c1
, *
add
, 
w2
, 
h2
, 
c2
, 
s1
, 
s2
, *
out
);

25 
m—n_ıu
(*
x
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
, *
m—n
);

26 
v¬Ÿnû_ıu
(*
x
, *
m—n
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
, *
v¬Ÿnû
);

28 
sÿË_bŸs
(*
ouut
, *
sÿËs
, 
b©ch
, 
n
, 
size
);

29 
backw¬d_sÿË_ıu
(*
x_nÜm
, *
d–
, 
b©ch
, 
n
, 
size
, *
sÿË_upd©es
);

30 
m—n_d–_ıu
(*
d–
, *
v¬Ÿnû
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
, *
m—n_d–
);

31 
v¬Ÿnû_d–_ıu
(*
x
, *
d–
, *
m—n
, *
v¬Ÿnû
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
, *
v¬Ÿnû_d–
);

32 
nÜm®ize_d–_ıu
(*
x
, *
m—n
, *
v¬Ÿnû
, *
m—n_d–
, *
v¬Ÿnû_d–
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
, *
d–
);

33 
l2nÜm®ize_ıu
(*
x
, *
dx
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
);

35 
smoÙh_l1_ıu
(
n
, *
´ed
, *
Œuth
, *
d–
, *
”rÜ
);

36 
l2_ıu
(
n
, *
´ed
, *
Œuth
, *
d–
, *
”rÜ
);

37 
l1_ıu
(
n
, *
´ed
, *
Œuth
, *
d–
, *
”rÜ
);

38 
logi¡ic_x_’t_ıu
(
n
, *
´ed
, *
Œuth
, *
d–
, *
”rÜ
);

39 
soámax_x_’t_ıu
(
n
, *
´ed
, *
Œuth
, *
d–
, *
”rÜ
);

40 
weigh‹d_sum_ıu
(*
a
, *
b
, *
s
, 
num
, *
c
);

41 
weigh‹d_d–_ıu
(*
a
, *
b
, *
s
, *
da
, *
db
, *
ds
, 
n
, *
dc
);

43 
soámax
(*
šput
, 
n
, 
‹mp
, 
¡ride
, *
ouut
);

44 
soámax_ıu
(*
šput
, 
n
, 
b©ch
, 
b©ch_off£t
, 
groups
, 
group_off£t
, 
¡ride
, 
‹mp
, *
ouut
);

45 
up§m¶e_ıu
(*
š
, 
w
, 
h
, 
c
, 
b©ch
, 
¡ride
, 
fÜw¬d
, 
sÿË
, *
out
);

47 #ifdeà
GPU


48 
	~"cuda.h
"

49 
	~"Œ“.h
"

51 
axpy_gpu
(
N
, 
ALPHA
, * 
X
, 
INCX
, * 
Y
, 
INCY
);

52 
axpy_gpu_off£t
(
N
, 
ALPHA
, * 
X
, 
OFFX
, 
INCX
, * 
Y
, 
OFFY
, 
INCY
);

53 
cİy_gpu
(
N
, * 
X
, 
INCX
, * 
Y
, 
INCY
);

54 
cİy_gpu_off£t
(
N
, * 
X
, 
OFFX
, 
INCX
, * 
Y
, 
OFFY
, 
INCY
);

55 
add_gpu
(
N
, 
ALPHA
, * 
X
, 
INCX
);

56 
suµ_gpu
(
N
, 
ALPHA
, * 
X
, 
INCX
);

57 
mask_gpu
(
N
, * 
X
, 
mask_num
, * 
mask
, 
v®
);

58 
sÿË_mask_gpu
(
N
, * 
X
, 
mask_num
, * 
mask
, 
sÿË
);

59 
cÚ¡_gpu
(
N
, 
ALPHA
, *
X
, 
INCX
);

60 
pow_gpu
(
N
, 
ALPHA
, *
X
, 
INCX
, *
Y
, 
INCY
);

61 
mul_gpu
(
N
, *
X
, 
INCX
, *
Y
, 
INCY
);

63 
m—n_gpu
(*
x
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
, *
m—n
);

64 
v¬Ÿnû_gpu
(*
x
, *
m—n
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
, *
v¬Ÿnû
);

65 
nÜm®ize_gpu
(*
x
, *
m—n
, *
v¬Ÿnû
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
);

66 
l2nÜm®ize_gpu
(*
x
, *
dx
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
);

68 
nÜm®ize_d–_gpu
(*
x
, *
m—n
, *
v¬Ÿnû
, *
m—n_d–
, *
v¬Ÿnû_d–
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
, *
d–
);

70 
ç¡_m—n_d–_gpu
(*
d–
, *
v¬Ÿnû
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
, *
m—n_d–
);

71 
ç¡_v¬Ÿnû_d–_gpu
(*
x
, *
d–
, *
m—n
, *
v¬Ÿnû
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
, *
v¬Ÿnû_d–
);

73 
ç¡_v¬Ÿnû_gpu
(*
x
, *
m—n
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
, *
v¬Ÿnû
);

74 
ç¡_m—n_gpu
(*
x
, 
b©ch
, 
f‹rs
, 
¥©Ÿl
, *
m—n
);

75 
shÜtcut_gpu
(
b©ch
, 
w1
, 
h1
, 
c1
, *
add
, 
w2
, 
h2
, 
c2
, 
s1
, 
s2
, *
out
);

76 
sÿË_bŸs_gpu
(*
ouut
, *
bŸ£s
, 
b©ch
, 
n
, 
size
);

77 
backw¬d_sÿË_gpu
(*
x_nÜm
, *
d–
, 
b©ch
, 
n
, 
size
, *
sÿË_upd©es
);

78 
sÿË_bŸs_gpu
(*
ouut
, *
bŸ£s
, 
b©ch
, 
n
, 
size
);

79 
add_bŸs_gpu
(*
ouut
, *
bŸ£s
, 
b©ch
, 
n
, 
size
);

80 
backw¬d_bŸs_gpu
(*
bŸs_upd©es
, *
d–
, 
b©ch
, 
n
, 
size
);

82 
logi¡ic_x_’t_gpu
(
n
, *
´ed
, *
Œuth
, *
d–
, *
”rÜ1
, *
”rÜ2
);

83 
soámax_x_’t_gpu
(
n
, *
´ed
, *
Œuth
, *
d–
, *
”rÜ
);

84 
smoÙh_l1_gpu
(
n
, *
´ed
, *
Œuth
, *
d–
, *
”rÜ
);

85 
l2_gpu
(
n
, *
´ed
, *
Œuth
, *
d–
, *
”rÜ
);

86 
l1_gpu
(
n
, *
´ed
, *
Œuth
, *
d–
, *
”rÜ
);

87 
wgª_gpu
(
n
, *
´ed
, *
Œuth
, *
d–
, *
”rÜ
);

88 
weigh‹d_d–_gpu
(*
a
, *
b
, *
s
, *
da
, *
db
, *
ds
, 
num
, *
dc
);

89 
weigh‹d_sum_gpu
(*
a
, *
b
, *
s
, 
num
, *
c
);

90 
muÉ_add_što_gpu
(
num
, *
a
, *
b
, *
c
);

91 
š‹r_gpu
(
NX
, *
X
, 
NY
, *
Y
, 
B
, *
OUT
);

92 
deš‹r_gpu
(
NX
, *
X
, 
NY
, *
Y
, 
B
, *
OUT
);

94 
»Üg_gpu
(*
x
, 
w
, 
h
, 
c
, 
b©ch
, 
¡ride
, 
fÜw¬d
, *
out
);

96 
soámax_gpu
(*
šput
, 
n
, 
b©ch
, 
b©ch_off£t
, 
groups
, 
group_off£t
, 
¡ride
, 
‹mp
, *
ouut
);

97 
adam_upd©e_gpu
(*
w
, *
d
, *
m
, *
v
, 
B1
, 
B2
, 
•s
, 
deÿy
, 
¿‹
, 
n
, 
b©ch
, 
t
);

98 
adam_gpu
(
n
, *
x
, *
m
, *
v
, 
B1
, 
B2
, 
¿‹
, 
•s
, 
t
);

100 
æ©‹n_gpu
(*
x
, 
¥©Ÿl
, 
Ïy”s
, 
b©ch
, 
fÜw¬d
, *
out
);

101 
soámax_Œ“
(*
šput
, 
¥©Ÿl
, 
b©ch
, 
¡ride
, 
‹mp
, *
ouut
, 
Œ“
 
h›r
);

102 
up§m¶e_gpu
(*
š
, 
w
, 
h
, 
c
, 
b©ch
, 
¡ride
, 
fÜw¬d
, 
sÿË
, *
out
);

	@box.c

1 
	~"box.h
"

2 
	~<¡dio.h
>

3 
	~<m©h.h
>

4 
	~<¡dlib.h
>

6 
	$nms_com·¿tÜ
(cÚ¡ *
·
, cÚ¡ *
pb
)

8 
d‘eùiÚ
 
a
 = *(d‘eùiÚ *)
·
;

9 
d‘eùiÚ
 
b
 = *(d‘eùiÚ *)
pb
;

10 
diff
 = 0;

11 if(
b
.
sÜt_şass
 >= 0){

12 
diff
 = 
a
.
´ob
[
b
.
sÜt_şass
] - b.prob[b.sort_class];

14 
diff
 = 
a
.
objeùÃss
 - 
b
.objectness;

16 if(
diff
 < 0)  1;

17 if(
diff
 > 0)  -1;

19 
	}
}

21 
	$do_nms_obj
(
d‘eùiÚ
 *
d‘s
, 
tÙ®
, 
şas£s
, 
th»sh
)

23 
i
, 
j
, 
k
;

24 
k
 = 
tÙ®
-1;

25 
i
 = 0; i <ğ
k
; ++i){

26 if(
d‘s
[
i
].
objeùÃss
 == 0){

27 
d‘eùiÚ
 
sw­
 = 
d‘s
[
i
];

28 
d‘s
[
i
] = d‘s[
k
];

29 
d‘s
[
k
] = 
sw­
;

30 --
k
;

31 --
i
;

34 
tÙ®
 = 
k
+1;

36 
i
 = 0; i < 
tÙ®
; ++i){

37 
d‘s
[
i
].
sÜt_şass
 = -1;

40 
	`qsÜt
(
d‘s
, 
tÙ®
, (
d‘eùiÚ
), 
nms_com·¿tÜ
);

41 
i
 = 0; i < 
tÙ®
; ++i){

42 if(
d‘s
[
i
].
objeùÃss
 == 0) ;

43 
box
 
a
 = 
d‘s
[
i
].
bbox
;

44 
j
 = 
i
+1; j < 
tÙ®
; ++j){

45 if(
d‘s
[
j
].
objeùÃss
 == 0) ;

46 
box
 
b
 = 
d‘s
[
j
].
bbox
;

47 ià(
	`box_iou
(
a
, 
b
è> 
th»sh
){

48 
d‘s
[
j
].
objeùÃss
 = 0;

49 
k
 = 0; k < 
şas£s
; ++k){

50 
d‘s
[
j
].
´ob
[
k
] = 0;

55 
	}
}

58 
	$do_nms_sÜt
(
d‘eùiÚ
 *
d‘s
, 
tÙ®
, 
şas£s
, 
th»sh
)

60 
i
, 
j
, 
k
;

61 
k
 = 
tÙ®
-1;

62 
i
 = 0; i <ğ
k
; ++i){

63 if(
d‘s
[
i
].
objeùÃss
 == 0){

64 
d‘eùiÚ
 
sw­
 = 
d‘s
[
i
];

65 
d‘s
[
i
] = d‘s[
k
];

66 
d‘s
[
k
] = 
sw­
;

67 --
k
;

68 --
i
;

71 
tÙ®
 = 
k
+1;

73 
k
 = 0; k < 
şas£s
; ++k){

74 
i
 = 0; i < 
tÙ®
; ++i){

75 
d‘s
[
i
].
sÜt_şass
 = 
k
;

77 
	`qsÜt
(
d‘s
, 
tÙ®
, (
d‘eùiÚ
), 
nms_com·¿tÜ
);

78 
i
 = 0; i < 
tÙ®
; ++i){

79 if(
d‘s
[
i
].
´ob
[
k
] == 0) ;

80 
box
 
a
 = 
d‘s
[
i
].
bbox
;

81 
j
 = 
i
+1; j < 
tÙ®
; ++j){

82 
box
 
b
 = 
d‘s
[
j
].
bbox
;

83 ià(
	`box_iou
(
a
, 
b
è> 
th»sh
){

84 
d‘s
[
j
].
´ob
[
k
] = 0;

89 
	}
}

91 
box
 
	$æßt_to_box
(*
f
, 
¡ride
)

93 
box
 
b
 = {0};

94 
b
.
x
 = 
f
[0];

95 
b
.
y
 = 
f
[1*
¡ride
];

96 
b
.
w
 = 
f
[2*
¡ride
];

97 
b
.
h
 = 
f
[3*
¡ride
];

98  
b
;

99 
	}
}

101 
dbox
 
	$d”iv©ive
(
box
 
a
, box 
b
)

103 
dbox
 
d
;

104 
d
.
dx
 = 0;

105 
d
.
dw
 = 0;

106 
l1
 = 
a
.
x
 -‡.
w
/2;

107 
l2
 = 
b
.
x
 - b.
w
/2;

108 ià(
l1
 > 
l2
){

109 
d
.
dx
 -= 1;

110 
d
.
dw
 += .5;

112 
r1
 = 
a
.
x
 +‡.
w
/2;

113 
r2
 = 
b
.
x
 + b.
w
/2;

114 if(
r1
 < 
r2
){

115 
d
.
dx
 += 1;

116 
d
.
dw
 += .5;

118 ià(
l1
 > 
r2
) {

119 
d
.
dx
 = -1;

120 
d
.
dw
 = 0;

122 ià(
r1
 < 
l2
){

123 
d
.
dx
 = 1;

124 
d
.
dw
 = 0;

127 
d
.
dy
 = 0;

128 
d
.
dh
 = 0;

129 
t1
 = 
a
.
y
 -‡.
h
/2;

130 
t2
 = 
b
.
y
 - b.
h
/2;

131 ià(
t1
 > 
t2
){

132 
d
.
dy
 -= 1;

133 
d
.
dh
 += .5;

135 
b1
 = 
a
.
y
 +‡.
h
/2;

136 
b2
 = 
b
.
y
 + b.
h
/2;

137 if(
b1
 < 
b2
){

138 
d
.
dy
 += 1;

139 
d
.
dh
 += .5;

141 ià(
t1
 > 
b2
) {

142 
d
.
dy
 = -1;

143 
d
.
dh
 = 0;

145 ià(
b1
 < 
t2
){

146 
d
.
dy
 = 1;

147 
d
.
dh
 = 0;

149  
d
;

150 
	}
}

152 
	$ov”Ïp
(
x1
, 
w1
, 
x2
, 
w2
)

154 
l1
 = 
x1
 - 
w1
/2;

155 
l2
 = 
x2
 - 
w2
/2;

156 
Ëá
 = 
l1
 > 
l2
 ?†1 :†2;

157 
r1
 = 
x1
 + 
w1
/2;

158 
r2
 = 
x2
 + 
w2
/2;

159 
right
 = 
r1
 < 
r2
 ?„1 :„2;

160  
right
 - 
Ëá
;

161 
	}
}

163 
	$box_š‹r£ùiÚ
(
box
 
a
, box 
b
)

165 
w
 = 
	`ov”Ïp
(
a
.
x
,‡.w, 
b
.x, b.w);

166 
h
 = 
	`ov”Ïp
(
a
.
y
,‡.h, 
b
.y, b.h);

167 if(
w
 < 0 || 
h
 < 0)  0;

168 
¬—
 = 
w
*
h
;

169  
¬—
;

170 
	}
}

172 
	$box_uniÚ
(
box
 
a
, box 
b
)

174 
i
 = 
	`box_š‹r£ùiÚ
(
a
, 
b
);

175 
u
 = 
a
.
w
*a.
h
 + 
b
.w*b.h - 
i
;

176  
u
;

177 
	}
}

179 
	$box_iou
(
box
 
a
, box 
b
)

181  
	`box_š‹r£ùiÚ
(
a
, 
b
)/
	`box_uniÚ
(a, b);

182 
	}
}

184 
	$box_rm£
(
box
 
a
, box 
b
)

186  
	`sq¹
(
	`pow
(
a
.
x
-
b
.x, 2) +

187 
	`pow
(
a
.
y
-
b
.y, 2) +

188 
	`pow
(
a
.
w
-
b
.w, 2) +

189 
	`pow
(
a
.
h
-
b
.h, 2));

190 
	}
}

192 
dbox
 
	$dš‹r£ù
(
box
 
a
, box 
b
)

194 
w
 = 
	`ov”Ïp
(
a
.
x
,‡.w, 
b
.x, b.w);

195 
h
 = 
	`ov”Ïp
(
a
.
y
,‡.h, 
b
.y, b.h);

196 
dbox
 
dov”
 = 
	`d”iv©ive
(
a
, 
b
);

197 
dbox
 
di
;

199 
di
.
dw
 = 
dov”
.dw*
h
;

200 
di
.
dx
 = 
dov”
.dx*
h
;

201 
di
.
dh
 = 
dov”
.dh*
w
;

202 
di
.
dy
 = 
dov”
.dy*
w
;

204  
di
;

205 
	}
}

207 
dbox
 
	$duniÚ
(
box
 
a
, box 
b
)

209 
dbox
 
du
;

211 
dbox
 
di
 = 
	`dš‹r£ù
(
a
, 
b
);

212 
du
.
dw
 = 
a
.
h
 - 
di
.dw;

213 
du
.
dh
 = 
a
.
w
 - 
di
.dh;

214 
du
.
dx
 = -
di
.dx;

215 
du
.
dy
 = -
di
.dy;

217  
du
;

218 
	}
}

221 
	$‹¡_duniÚ
()

223 
box
 
a
 = {0, 0, 1, 1};

224 
box
 
dxa
= {0+.0001, 0, 1, 1};

225 
box
 
dya
= {0, 0+.0001, 1, 1};

226 
box
 
dwa
= {0, 0, 1+.0001, 1};

227 
box
 
dha
= {0, 0, 1, 1+.0001};

229 
box
 
b
 = {.5, .5, .2, .2};

230 
dbox
 
di
 = 
	`duniÚ
(
a
,
b
);

231 
	`´štf
("UniÚ: %à%à%à%f\n", 
di
.
dx
, di.
dy
, di.
dw
, di.
dh
);

232 
š‹r
 = 
	`box_uniÚ
(
a
, 
b
);

233 
xš‹r
 = 
	`box_uniÚ
(
dxa
, 
b
);

234 
yš‹r
 = 
	`box_uniÚ
(
dya
, 
b
);

235 
wš‹r
 = 
	`box_uniÚ
(
dwa
, 
b
);

236 
hš‹r
 = 
	`box_uniÚ
(
dha
, 
b
);

237 
xš‹r
 = (xš‹¸- 
š‹r
)/(.0001);

238 
yš‹r
 = (yš‹¸- 
š‹r
)/(.0001);

239 
wš‹r
 = (wš‹¸- 
š‹r
)/(.0001);

240 
hš‹r
 = (hš‹¸- 
š‹r
)/(.0001);

241 
	`´štf
("UniÚ Mªu® %à%à%à%f\n", 
xš‹r
, 
yš‹r
, 
wš‹r
, 
hš‹r
);

242 
	}
}

243 
	$‹¡_dš‹r£ù
()

245 
box
 
a
 = {0, 0, 1, 1};

246 
box
 
dxa
= {0+.0001, 0, 1, 1};

247 
box
 
dya
= {0, 0+.0001, 1, 1};

248 
box
 
dwa
= {0, 0, 1+.0001, 1};

249 
box
 
dha
= {0, 0, 1, 1+.0001};

251 
box
 
b
 = {.5, .5, .2, .2};

252 
dbox
 
di
 = 
	`dš‹r£ù
(
a
,
b
);

253 
	`´štf
("IÁ”: %à%à%à%f\n", 
di
.
dx
, di.
dy
, di.
dw
, di.
dh
);

254 
š‹r
 = 
	`box_š‹r£ùiÚ
(
a
, 
b
);

255 
xš‹r
 = 
	`box_š‹r£ùiÚ
(
dxa
, 
b
);

256 
yš‹r
 = 
	`box_š‹r£ùiÚ
(
dya
, 
b
);

257 
wš‹r
 = 
	`box_š‹r£ùiÚ
(
dwa
, 
b
);

258 
hš‹r
 = 
	`box_š‹r£ùiÚ
(
dha
, 
b
);

259 
xš‹r
 = (xš‹¸- 
š‹r
)/(.0001);

260 
yš‹r
 = (yš‹¸- 
š‹r
)/(.0001);

261 
wš‹r
 = (wš‹¸- 
š‹r
)/(.0001);

262 
hš‹r
 = (hš‹¸- 
š‹r
)/(.0001);

263 
	`´štf
("IÁ” Mªu® %à%à%à%f\n", 
xš‹r
, 
yš‹r
, 
wš‹r
, 
hš‹r
);

264 
	}
}

266 
	$‹¡_box
()

268 
	`‹¡_dš‹r£ù
();

269 
	`‹¡_duniÚ
();

270 
box
 
a
 = {0, 0, 1, 1};

271 
box
 
dxa
= {0+.00001, 0, 1, 1};

272 
box
 
dya
= {0, 0+.00001, 1, 1};

273 
box
 
dwa
= {0, 0, 1+.00001, 1};

274 
box
 
dha
= {0, 0, 1, 1+.00001};

276 
box
 
b
 = {.5, 0, .2, .2};

278 
iou
 = 
	`box_iou
(
a
,
b
);

279 
iou
 = (1-iou)*(1-iou);

280 
	`´štf
("%f\n", 
iou
);

281 
dbox
 
d
 = 
	`diou
(
a
, 
b
);

282 
	`´štf
("%à%à%à%f\n", 
d
.
dx
, d.
dy
, d.
dw
, d.
dh
);

284 
xiou
 = 
	`box_iou
(
dxa
, 
b
);

285 
yiou
 = 
	`box_iou
(
dya
, 
b
);

286 
wiou
 = 
	`box_iou
(
dwa
, 
b
);

287 
hiou
 = 
	`box_iou
(
dha
, 
b
);

288 
xiou
 = ((1-xiou)*(1-xiouè- 
iou
)/(.00001);

289 
yiou
 = ((1-yiou)*(1-yiouè- 
iou
)/(.00001);

290 
wiou
 = ((1-wiou)*(1-wiouè- 
iou
)/(.00001);

291 
hiou
 = ((1-hiou)*(1-hiouè- 
iou
)/(.00001);

292 
	`´štf
("mªu® %à%à%à%f\n", 
xiou
, 
yiou
, 
wiou
, 
hiou
);

293 
	}
}

295 
dbox
 
	$diou
(
box
 
a
, box 
b
)

297 
u
 = 
	`box_uniÚ
(
a
,
b
);

298 
i
 = 
	`box_š‹r£ùiÚ
(
a
,
b
);

299 
dbox
 
di
 = 
	`dš‹r£ù
(
a
,
b
);

300 
dbox
 
du
 = 
	`duniÚ
(
a
,
b
);

301 
dbox
 
dd
 = {0,0,0,0};

303 if(
i
 <= 0 || 1) {

304 
dd
.
dx
 = 
b
.
x
 - 
a
.x;

305 
dd
.
dy
 = 
b
.
y
 - 
a
.y;

306 
dd
.
dw
 = 
b
.
w
 - 
a
.w;

307 
dd
.
dh
 = 
b
.
h
 - 
a
.h;

308  
dd
;

311 
dd
.
dx
 = 2*
	`pow
((1-(
i
/
u
)),1)*(
di
.dx*u - 
du
.dx*i)/(u*u);

312 
dd
.
dy
 = 2*
	`pow
((1-(
i
/
u
)),1)*(
di
.dy*u - 
du
.dy*i)/(u*u);

313 
dd
.
dw
 = 2*
	`pow
((1-(
i
/
u
)),1)*(
di
.dw*u - 
du
.dw*i)/(u*u);

314 
dd
.
dh
 = 2*
	`pow
((1-(
i
/
u
)),1)*(
di
.dh*u - 
du
.dh*i)/(u*u);

315  
dd
;

316 
	}
}

319 
	$do_nms
(
box
 *
boxes
, **
´obs
, 
tÙ®
, 
şas£s
, 
th»sh
)

321 
i
, 
j
, 
k
;

322 
i
 = 0; i < 
tÙ®
; ++i){

323 
ªy
 = 0;

324 
k
 = 0; k < 
şas£s
; ++kè
ªy
 =‡ny || (
´obs
[
i
][k] > 0);

325 if(!
ªy
) {

328 
j
 = 
i
+1; j < 
tÙ®
; ++j){

329 ià(
	`box_iou
(
boxes
[
i
], boxes[
j
]è> 
th»sh
){

330 
k
 = 0; k < 
şas£s
; ++k){

331 ià(
´obs
[
i
][
k
] <…robs[
j
][k])…robs[i][k] = 0;

332 
´obs
[
j
][
k
] = 0;

337 
	}
}

339 
box
 
	$’code_box
(
box
 
b
, box 
ªchÜ
)

341 
box
 
’code
;

342 
’code
.
x
 = (
b
.x - 
ªchÜ
.xè/‡nchÜ.
w
;

343 
’code
.
y
 = (
b
.y - 
ªchÜ
.yè/‡nchÜ.
h
;

344 
’code
.
w
 = 
	`log2
(
b
.w / 
ªchÜ
.w);

345 
’code
.
h
 = 
	`log2
(
b
.h / 
ªchÜ
.h);

346  
’code
;

347 
	}
}

349 
box
 
	$decode_box
(
box
 
b
, box 
ªchÜ
)

351 
box
 
decode
;

352 
decode
.
x
 = 
b
.x * 
ªchÜ
.
w
 +‡nchor.x;

353 
decode
.
y
 = 
b
.y * 
ªchÜ
.
h
 +‡nchor.y;

354 
decode
.
w
 = 
	`pow
(2., 
b
.wè* 
ªchÜ
.w;

355 
decode
.
h
 = 
	`pow
(2., 
b
.hè* 
ªchÜ
.h;

356  
decode
;

357 
	}
}

	@box.h

1 #iâdeà
BOX_H


2 
	#BOX_H


	)

3 
	~"d¬kÃt.h
"

6 
	mdx
, 
	mdy
, 
	mdw
, 
	mdh
;

7 } 
	tdbox
;

9 
box_rm£
(
box
 
a
, box 
b
);

10 
dbox
 
diou
(
box
 
a
, box 
b
);

11 
box
 
decode_box
(box 
b
, box 
ªchÜ
);

12 
box
 
’code_box
(box 
b
, box 
ªchÜ
);

	@classifier.h

	@col2im.c

1 
	~<¡dio.h
>

2 
	~<m©h.h
>

3 
	$cŞ2im_add_pix–
(*
im
, 
height
, 
width
, 
chªÃls
,

4 
row
, 
cŞ
, 
chªÃl
, 
·d
, 
v®
)

6 
row
 -ğ
·d
;

7 
cŞ
 -ğ
·d
;

9 ià(
row
 < 0 || 
cŞ
 < 0 ||

10 
row
 >ğ
height
 || 
cŞ
 >ğ
width
) ;

11 
im
[
cŞ
 + 
width
*(
row
 + 
height
*
chªÃl
)] +ğ
v®
;

12 
	}
}

14 
	$cŞ2im_ıu
(* 
d©a_cŞ
,

15 
chªÃls
, 
height
, 
width
,

16 
ksize
, 
¡ride
, 
·d
, * 
d©a_im
)

18 
c
,
h
,
w
;

19 
height_cŞ
 = (
height
 + 2*
·d
 - 
ksize
è/ 
¡ride
 + 1;

20 
width_cŞ
 = (
width
 + 2*
·d
 - 
ksize
è/ 
¡ride
 + 1;

22 
chªÃls_cŞ
 = 
chªÃls
 * 
ksize
 * ksize;

23 
c
 = 0; c < 
chªÃls_cŞ
; ++c) {

24 
w_off£t
 = 
c
 % 
ksize
;

25 
h_off£t
 = (
c
 / 
ksize
) % ksize;

26 
c_im
 = 
c
 / 
ksize
 / ksize;

27 
h
 = 0; h < 
height_cŞ
; ++h) {

28 
w
 = 0; w < 
width_cŞ
; ++w) {

29 
im_row
 = 
h_off£t
 + 
h
 * 
¡ride
;

30 
im_cŞ
 = 
w_off£t
 + 
w
 * 
¡ride
;

31 
cŞ_šdex
 = (
c
 * 
height_cŞ
 + 
h
è* 
width_cŞ
 + 
w
;

32 
v®
 = 
d©a_cŞ
[
cŞ_šdex
];

33 
	`cŞ2im_add_pix–
(
d©a_im
, 
height
, 
width
, 
chªÃls
,

34 
im_row
, 
im_cŞ
, 
c_im
, 
·d
, 
v®
);

38 
	}
}

	@col2im.h

1 #iâdeà
COL2IM_H


2 
	#COL2IM_H


	)

4 
cŞ2im_ıu
(* 
d©a_cŞ
,

5 
chªÃls
, 
height
, 
width
,

6 
ksize
, 
¡ride
, 
·d
, * 
d©a_im
);

8 #ifdeà
GPU


9 
cŞ2im_gpu
(*
d©a_cŞ
,

10 
chªÃls
, 
height
, 
width
,

11 
ksize
, 
¡ride
, 
·d
, *
d©a_im
);

	@compare.c

1 
	~<¡dio.h
>

3 
	~"ÃtwÜk.h
"

4 
	~"d‘eùiÚ_Ïy”.h
"

5 
	~"co¡_Ïy”.h
"

6 
	~"uts.h
"

7 
	~"·r£r.h
"

8 
	~"box.h
"

10 
	$Œaš_com·»
(*
cfgfe
, *
weightfe
)

12 
	`¤ªd
(
	`time
(0));

13 
avg_loss
 = -1;

14 *
ba£
 = 
	`ba£cfg
(
cfgfe
);

15 *
backup_dœeùÜy
 = "/home/pjreddie/backup/";

16 
	`´štf
("%s\n", 
ba£
);

17 
ÃtwÜk
 
Ãt
 = 
	`·r£_ÃtwÜk_cfg
(
cfgfe
);

18 if(
weightfe
){

19 
	`lßd_weights
(&
Ãt
, 
weightfe
);

21 
	`´štf
("L—ºšg R©e: %g, Mom’tum: %g, Deÿy: %g\n", 
Ãt
.
Ë¬nšg_¿‹
,‚‘.
mom’tum
,‚‘.
deÿy
);

22 
imgs
 = 1024;

23 
li¡
 *
¶i¡
 = 
	`g‘_·ths
("data/compare.train.list");

24 **
·ths
 = (**)
	`li¡_to_¬¿y
(
¶i¡
);

25 
N
 = 
¶i¡
->
size
;

26 
	`´štf
("%d\n", 
N
);

27 
şock_t
 
time
;

28 
±h»ad_t
 
lßd_th»ad
;

29 
d©a
 
Œaš
;

30 
d©a
 
bufãr
;

32 
lßd_¬gs
 
¬gs
 = {0};

33 
¬gs
.
w
 = 
Ãt
.w;

34 
¬gs
.
h
 = 
Ãt
.h;

35 
¬gs
.
·ths
 =…aths;

36 
¬gs
.
şas£s
 = 20;

37 
¬gs
.
n
 = 
imgs
;

38 
¬gs
.
m
 = 
N
;

39 
¬gs
.
d
 = &
bufãr
;

40 
¬gs
.
ty³
 = 
COMPARE_DATA
;

42 
lßd_th»ad
 = 
	`lßd_d©a_š_th»ad
(
¬gs
);

43 
•och
 = *
Ãt
.
£’
/
N
;

44 
i
 = 0;

46 ++
i
;

47 
time
=
	`şock
();

48 
	`±h»ad_još
(
lßd_th»ad
, 0);

49 
Œaš
 = 
bufãr
;

51 
lßd_th»ad
 = 
	`lßd_d©a_š_th»ad
(
¬gs
);

52 
	`´štf
("Lßded: %là£cÚds\n", 
	`£c
(
	`şock
()-
time
));

53 
time
=
	`şock
();

54 
loss
 = 
	`Œaš_ÃtwÜk
(
Ãt
, 
Œaš
);

55 if(
avg_loss
 =ğ-1èavg_los ğ
loss
;

56 
avg_loss
 =‡vg_loss*.9 + 
loss
*.1;

57 
	`´štf
("%.3f: %f, %àavg, %là£cÚds, %ld images\n", ()*
Ãt
.
£’
/
N
, 
loss
, 
avg_loss
, 
	`£c
(
	`şock
()-
time
), *net.seen);

58 
	`ä“_d©a
(
Œaš
);

59 if(
i
%100 == 0){

60 
buff
[256];

61 
	`¥rštf
(
buff
, "%s/%s_%d_mšÜ_%d.weights",
backup_dœeùÜy
,
ba£
, 
•och
, 
i
);

62 
	`§ve_weights
(
Ãt
, 
buff
);

64 if(*
Ãt
.
£’
/
N
 > 
•och
){

65 
•och
 = *
Ãt
.
£’
/
N
;

66 
i
 = 0;

67 
buff
[256];

68 
	`¥rštf
(
buff
, "%s/%s_%d.weights",
backup_dœeùÜy
,
ba£
, 
•och
);

69 
	`§ve_weights
(
Ãt
, 
buff
);

70 if(
•och
%22 =ğ0è
Ãt
.
Ë¬nšg_¿‹
 *= .1;

73 
	`±h»ad_još
(
lßd_th»ad
, 0);

74 
	`ä“_d©a
(
bufãr
);

75 
	`ä“_ÃtwÜk
(
Ãt
);

76 
	`ä“_±rs
((**)
·ths
, 
¶i¡
->
size
);

77 
	`ä“_li¡
(
¶i¡
);

78 
	`ä“
(
ba£
);

79 
	}
}

81 
	$v®id©e_com·»
(*
f’ame
, *
weightfe
)

83 
i
 = 0;

84 
ÃtwÜk
 
Ãt
 = 
	`·r£_ÃtwÜk_cfg
(
f’ame
);

85 if(
weightfe
){

86 
	`lßd_weights
(&
Ãt
, 
weightfe
);

88 
	`¤ªd
(
	`time
(0));

90 
li¡
 *
¶i¡
 = 
	`g‘_·ths
("data/compare.val.list");

92 **
·ths
 = (**)
	`li¡_to_¬¿y
(
¶i¡
);

93 
N
 = 
¶i¡
->
size
/2;

94 
	`ä“_li¡
(
¶i¡
);

96 
şock_t
 
time
;

97 
cÜ»ù
 = 0;

98 
tÙ®
 = 0;

99 
¥l™s
 = 10;

100 
num
 = (
i
+1)*
N
/
¥l™s
 - i*N/splits;

102 
d©a
 
v®
, 
bufãr
;

104 
lßd_¬gs
 
¬gs
 = {0};

105 
¬gs
.
w
 = 
Ãt
.w;

106 
¬gs
.
h
 = 
Ãt
.h;

107 
¬gs
.
·ths
 =…aths;

108 
¬gs
.
şas£s
 = 20;

109 
¬gs
.
n
 = 
num
;

110 
¬gs
.
m
 = 0;

111 
¬gs
.
d
 = &
bufãr
;

112 
¬gs
.
ty³
 = 
COMPARE_DATA
;

114 
±h»ad_t
 
lßd_th»ad
 = 
	`lßd_d©a_š_th»ad
(
¬gs
);

115 
i
 = 1; i <ğ
¥l™s
; ++i){

116 
time
=
	`şock
();

118 
	`±h»ad_još
(
lßd_th»ad
, 0);

119 
v®
 = 
bufãr
;

121 
num
 = (
i
+1)*
N
/
¥l™s
 - i*N/splits;

122 **
·¹
 = 
·ths
+(
i
*
N
/
¥l™s
);

123 if(
i
 !ğ
¥l™s
){

124 
¬gs
.
·ths
 = 
·¹
;

125 
lßd_th»ad
 = 
	`lßd_d©a_š_th»ad
(
¬gs
);

127 
	`´štf
("Lßded: %d image š %là£cÚds\n", 
v®
.
X
.
rows
, 
	`£c
(
	`şock
()-
time
));

129 
time
=
	`şock
();

130 
m©rix
 
´ed
 = 
	`ÃtwÜk_´ediù_d©a
(
Ãt
, 
v®
);

131 
j
,
k
;

132 
j
 = 0; j < 
v®
.
y
.
rows
; ++j){

133 
k
 = 0; k < 20; ++k){

134 if(
v®
.
y
.
v®s
[
j
][
k
*2] != val.y.vals[j][k*2+1]){

135 ++
tÙ®
;

136 if((
v®
.
y
.
v®s
[
j
][
k
*2] < v®.y.v®s[j][k*2+1]è=ğ(
´ed
.vals[j][k*2] <…red.vals[j][k*2+1])){

137 ++
cÜ»ù
;

142 
	`ä“_m©rix
(
´ed
);

143 
	`´štf
("%d: Acc: %f, %là£cÚds, %d images\n", 
i
, ()
cÜ»ù
/
tÙ®
, 
	`£c
(
	`şock
()-
time
), 
v®
.
X
.
rows
);

144 
	`ä“_d©a
(
v®
);

146 
	}
}

149 
ÃtwÜk
 
	mÃt
;

150 *
	mf’ame
;

151 
	mşass
;

152 
	mşas£s
;

153 
	m–o
;

154 *
	m–os
;

155 } 
	tsÜbË_bbox
;

157 
	gtÙ®_com·»s
 = 0;

158 
	gcu¼’t_şass
 = 0;

160 
	$–o_com·¿tÜ
(cÚ¡ *
a
, cÚ¡ *
b
)

162 
sÜbË_bbox
 
box1
 = *(sÜbË_bbox*)
a
;

163 
sÜbË_bbox
 
box2
 = *(sÜbË_bbox*)
b
;

164 if(
box1
.
–os
[
cu¼’t_şass
] =ğ
box2
.elos[current_class])  0;

165 if(
box1
.
–os
[
cu¼’t_şass
] > 
box2
.elos[current_class])  -1;

167 
	}
}

169 
	$bbox_com·¿tÜ
(cÚ¡ *
a
, cÚ¡ *
b
)

171 ++
tÙ®_com·»s
;

172 
sÜbË_bbox
 
box1
 = *(sÜbË_bbox*)
a
;

173 
sÜbË_bbox
 
box2
 = *(sÜbË_bbox*)
b
;

174 
ÃtwÜk
 
Ãt
 = 
box1
.net;

175 
şass
 = 
box1
.class;

177 
image
 
im1
 = 
	`lßd_image_cŞÜ
(
box1
.
f’ame
, 
Ãt
.
w
,‚‘.
h
);

178 
image
 
im2
 = 
	`lßd_image_cŞÜ
(
box2
.
f’ame
, 
Ãt
.
w
,‚‘.
h
);

179 *
X
 = 
	`ÿÎoc
(
Ãt
.
w
*Ãt.
h
*Ãt.
c
, ());

180 
	`memıy
(
X
, 
im1
.
d©a
, im1.
w
*im1.
h
*im1.
c
*());

181 
	`memıy
(
X
+
im1
.
w
*im1.
h
*im1.
c
, 
im2
.
d©a
, im2.w*im2.h*im2.c*());

182 *
´ediùiÚs
 = 
	`ÃtwÜk_´ediù
(
Ãt
, 
X
);

184 
	`ä“_image
(
im1
);

185 
	`ä“_image
(
im2
);

186 
	`ä“
(
X
);

187 ià(
´ediùiÚs
[
şass
*2] >…redictions[class*2+1]){

191 
	}
}

193 
	$bbox_upd©e
(
sÜbË_bbox
 *
a
, sÜbË_bbox *
b
, 
şass
, 
»suÉ
)

195 
k
 = 32;

196 
EA
 = 1./(1+
	`pow
(10, (
b
->
–os
[
şass
] - 
a
->elos[class])/400.));

197 
EB
 = 1./(1+
	`pow
(10, (
a
->
–os
[
şass
] - 
b
->elos[class])/400.));

198 
SA
 = 
»suÉ
 ? 1 : 0;

199 
SB
 = 
»suÉ
 ? 0 : 1;

200 
a
->
–os
[
şass
] +ğ
k
*(
SA
 - 
EA
);

201 
b
->
–os
[
şass
] +ğ
k
*(
SB
 - 
EB
);

202 
	}
}

204 
	$bbox_fight
(
ÃtwÜk
 
Ãt
, 
sÜbË_bbox
 *
a
, sÜbË_bbox *
b
, 
şas£s
, 
şass
)

206 
image
 
im1
 = 
	`lßd_image_cŞÜ
(
a
->
f’ame
, 
Ãt
.
w
,‚‘.
h
);

207 
image
 
im2
 = 
	`lßd_image_cŞÜ
(
b
->
f’ame
, 
Ãt
.
w
,‚‘.
h
);

208 *
X
 = 
	`ÿÎoc
(
Ãt
.
w
*Ãt.
h
*Ãt.
c
, ());

209 
	`memıy
(
X
, 
im1
.
d©a
, im1.
w
*im1.
h
*im1.
c
*());

210 
	`memıy
(
X
+
im1
.
w
*im1.
h
*im1.
c
, 
im2
.
d©a
, im2.w*im2.h*im2.c*());

211 *
´ediùiÚs
 = 
	`ÃtwÜk_´ediù
(
Ãt
, 
X
);

212 ++
tÙ®_com·»s
;

214 
i
;

215 
i
 = 0; i < 
şas£s
; ++i){

216 if(
şass
 < 0 || cÏs =ğ
i
){

217 
»suÉ
 = 
´ediùiÚs
[
i
*2] >…redictions[i*2+1];

218 
	`bbox_upd©e
(
a
, 
b
, 
i
, 
»suÉ
);

222 
	`ä“_image
(
im1
);

223 
	`ä“_image
(
im2
);

224 
	`ä“
(
X
);

225 
	}
}

227 
	$SÜtMa¡”3000
(*
f’ame
, *
weightfe
)

229 
i
 = 0;

230 
ÃtwÜk
 
Ãt
 = 
	`·r£_ÃtwÜk_cfg
(
f’ame
);

231 if(
weightfe
){

232 
	`lßd_weights
(&
Ãt
, 
weightfe
);

234 
	`¤ªd
(
	`time
(0));

235 
	`£t_b©ch_ÃtwÜk
(&
Ãt
, 1);

237 
li¡
 *
¶i¡
 = 
	`g‘_·ths
("data/compare.sort.list");

239 **
·ths
 = (**)
	`li¡_to_¬¿y
(
¶i¡
);

240 
N
 = 
¶i¡
->
size
;

241 
	`ä“_li¡
(
¶i¡
);

242 
sÜbË_bbox
 *
boxes
 = 
	`ÿÎoc
(
N
, (sortable_bbox));

243 
	`´štf
("SÜtšg %d boxes...\n", 
N
);

244 
i
 = 0; i < 
N
; ++i){

245 
boxes
[
i
].
f’ame
 = 
·ths
[i];

246 
boxes
[
i
].
Ãt
 =‚et;

247 
boxes
[
i
].
şass
 = 7;

248 
boxes
[
i
].
–o
 = 1500;

250 
şock_t
 
time
=
	`şock
();

251 
	`qsÜt
(
boxes
, 
N
, (
sÜbË_bbox
), 
bbox_com·¿tÜ
);

252 
i
 = 0; i < 
N
; ++i){

253 
	`´štf
("%s\n", 
boxes
[
i
].
f’ame
);

255 
	`´štf
("SÜ‹d iÀ%d com·»s, %à£cs\n", 
tÙ®_com·»s
, 
	`£c
(
	`şock
()-
time
));

256 
	}
}

258 
	$B©eRoy®eW™hCh“£
(*
f’ame
, *
weightfe
)

260 
şas£s
 = 20;

261 
i
,
j
;

262 
ÃtwÜk
 
Ãt
 = 
	`·r£_ÃtwÜk_cfg
(
f’ame
);

263 if(
weightfe
){

264 
	`lßd_weights
(&
Ãt
, 
weightfe
);

266 
	`¤ªd
(
	`time
(0));

267 
	`£t_b©ch_ÃtwÜk
(&
Ãt
, 1);

269 
li¡
 *
¶i¡
 = 
	`g‘_·ths
("data/compare.sort.list");

273 **
·ths
 = (**)
	`li¡_to_¬¿y
(
¶i¡
);

274 
N
 = 
¶i¡
->
size
;

275 
tÙ®
 = 
N
;

276 
	`ä“_li¡
(
¶i¡
);

277 
sÜbË_bbox
 *
boxes
 = 
	`ÿÎoc
(
N
, (sortable_bbox));

278 
	`´štf
("B©šg %d boxes...\n", 
N
);

279 
i
 = 0; i < 
N
; ++i){

280 
boxes
[
i
].
f’ame
 = 
·ths
[i];

281 
boxes
[
i
].
Ãt
 =‚et;

282 
boxes
[
i
].
şas£s
 = classes;

283 
boxes
[
i
].
–os
 = 
	`ÿÎoc
(
şas£s
, ());;

284 
j
 = 0; j < 
şas£s
; ++j){

285 
boxes
[
i
].
–os
[
j
] = 1500;

288 
round
;

289 
şock_t
 
time
=
	`şock
();

290 
round
 = 1;„ound <= 4; ++round){

291 
şock_t
 
round_time
=
	`şock
();

292 
	`´štf
("Round: %d\n", 
round
);

293 
	`shufæe
(
boxes
, 
N
, (
sÜbË_bbox
));

294 
i
 = 0; i < 
N
/2; ++i){

295 
	`bbox_fight
(
Ãt
, 
boxes
+
i
*2, boxes+i*2+1, 
şas£s
, -1);

297 
	`´štf
("Round: %à£cs, %d„emaššg\n", 
	`£c
(
	`şock
()-
round_time
), 
N
);

300 
şass
;

302 
şass
 = 0; cÏs < 
şas£s
; ++class){

304 
N
 = 
tÙ®
;

305 
cu¼’t_şass
 = 
şass
;

306 
	`qsÜt
(
boxes
, 
N
, (
sÜbË_bbox
), 
–o_com·¿tÜ
);

307 
N
 /= 2;

309 
round
 = 1;„ound <= 100; ++round){

310 
şock_t
 
round_time
=
	`şock
();

311 
	`´štf
("Round: %d\n", 
round
);

313 
	`sÜ_shufæe
(
boxes
, 
N
, (
sÜbË_bbox
), 10);

314 
i
 = 0; i < 
N
/2; ++i){

315 
	`bbox_fight
(
Ãt
, 
boxes
+
i
*2, boxes+i*2+1, 
şas£s
, 
şass
);

317 
	`qsÜt
(
boxes
, 
N
, (
sÜbË_bbox
), 
–o_com·¿tÜ
);

318 if(
round
 <ğ20è
N
 = (N*9/10)/2*2;

320 
	`´štf
("Round: %à£cs, %d„emaššg\n", 
	`£c
(
	`şock
()-
round_time
), 
N
);

322 
buff
[256];

323 
	`¥rštf
(
buff
, "»suÉs/b©e_%d.log", 
şass
);

324 
FILE
 *
outå
 = 
	`fİ’
(
buff
, "w");

325 
i
 = 0; i < 
N
; ++i){

326 
	`årštf
(
outå
, "% %f\n", 
boxes
[
i
].
f’ame
, boxes[i].
–os
[
şass
]);

328 
	`fşo£
(
outå
);

330 
	`´štf
("Touºam’ˆš %d com·»s, %à£cs\n", 
tÙ®_com·»s
, 
	`£c
(
	`şock
()-
time
));

331 
	}
}

333 
	$run_com·»
(
¬gc
, **
¬gv
)

335 if(
¬gc
 < 4){

336 
	`årštf
(
¡d”r
, "u§ge: % % [Œaš/‹¡/v®id] [cfg] [weight (İtiÚ®)]\n", 
¬gv
[0],‡rgv[1]);

340 *
cfg
 = 
¬gv
[3];

341 *
weights
 = (
¬gc
 > 4è? 
¬gv
[4] : 0;

343 if(0==
	`¡rcmp
(
¬gv
[2], "Œaš")è
	`Œaš_com·»
(
cfg
, 
weights
);

344 if(0==
	`¡rcmp
(
¬gv
[2], "v®id")è
	`v®id©e_com·»
(
cfg
, 
weights
);

345 if(0==
	`¡rcmp
(
¬gv
[2], "sÜt")è
	`SÜtMa¡”3000
(
cfg
, 
weights
);

346 if(0==
	`¡rcmp
(
¬gv
[2], "b©e")è
	`B©eRoy®eW™hCh“£
(
cfg
, 
weights
);

352 
	}
}

	@connected_layer.c

1 
	~"cÚÃùed_Ïy”.h
"

2 
	~"cÚvŞutiÚ®_Ïy”.h
"

3 
	~"b©chnÜm_Ïy”.h
"

4 
	~"uts.h
"

5 
	~"cuda.h
"

6 
	~"bÏs.h
"

7 
	~"gemm.h
"

9 
	~<m©h.h
>

10 
	~<¡dio.h
>

11 
	~<¡dlib.h
>

12 
	~<¡ršg.h
>

14 
Ïy”
 
	$make_cÚÃùed_Ïy”
(
b©ch
, 
šputs
, 
ouuts
, 
ACTIVATION
 
aùiv©iÚ
, 
b©ch_nÜm®ize
, 
adam
)

16 
i
;

17 
Ïy”
 
l
 = {0};

18 
l
.
Ë¬nšg_¿‹_sÿË
 = 1;

19 
l
.
ty³
 = 
CONNECTED
;

21 
l
.
šputs
 = inputs;

22 
l
.
ouuts
 = outputs;

23 
l
.
b©ch
=batch;

24 
l
.
b©ch_nÜm®ize
 = batch_normalize;

25 
l
.
h
 = 1;

26 
l
.
w
 = 1;

27 
l
.
c
 = 
šputs
;

28 
l
.
out_h
 = 1;

29 
l
.
out_w
 = 1;

30 
l
.
out_c
 = 
ouuts
;

32 
l
.
ouut
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

33 
l
.
d–
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

35 
l
.
weight_upd©es
 = 
	`ÿÎoc
(
šputs
*
ouuts
, ());

36 
l
.
bŸs_upd©es
 = 
	`ÿÎoc
(
ouuts
, ());

38 
l
.
weights
 = 
	`ÿÎoc
(
ouuts
*
šputs
, ());

39 
l
.
bŸ£s
 = 
	`ÿÎoc
(
ouuts
, ());

41 
l
.
fÜw¬d
 = 
fÜw¬d_cÚÃùed_Ïy”
;

42 
l
.
backw¬d
 = 
backw¬d_cÚÃùed_Ïy”
;

43 
l
.
upd©e
 = 
upd©e_cÚÃùed_Ïy”
;

46 
sÿË
 = 
	`sq¹
(2./
šputs
);

47 
i
 = 0; i < 
ouuts
*
šputs
; ++i){

48 
l
.
weights
[
i
] = 
sÿË
*
	`¿nd_unifÜm
(-1, 1);

51 
i
 = 0; i < 
ouuts
; ++i){

52 
l
.
bŸ£s
[
i
] = 0;

55 if(
adam
){

56 
l
.
m
 = 
	`ÿÎoc
Ö.
šputs
*l.
ouuts
, ());

57 
l
.
v
 = 
	`ÿÎoc
Ö.
šputs
*l.
ouuts
, ());

58 
l
.
bŸs_m
 = 
	`ÿÎoc
Ö.
ouuts
, ());

59 
l
.
sÿË_m
 = 
	`ÿÎoc
Ö.
ouuts
, ());

60 
l
.
bŸs_v
 = 
	`ÿÎoc
Ö.
ouuts
, ());

61 
l
.
sÿË_v
 = 
	`ÿÎoc
Ö.
ouuts
, ());

63 if(
b©ch_nÜm®ize
){

64 
l
.
sÿËs
 = 
	`ÿÎoc
(
ouuts
, ());

65 
l
.
sÿË_upd©es
 = 
	`ÿÎoc
(
ouuts
, ());

66 
i
 = 0; i < 
ouuts
; ++i){

67 
l
.
sÿËs
[
i
] = 1;

70 
l
.
m—n
 = 
	`ÿÎoc
(
ouuts
, ());

71 
l
.
m—n_d–
 = 
	`ÿÎoc
(
ouuts
, ());

72 
l
.
v¬Ÿnû
 = 
	`ÿÎoc
(
ouuts
, ());

73 
l
.
v¬Ÿnû_d–
 = 
	`ÿÎoc
(
ouuts
, ());

75 
l
.
rŞlšg_m—n
 = 
	`ÿÎoc
(
ouuts
, ());

76 
l
.
rŞlšg_v¬Ÿnû
 = 
	`ÿÎoc
(
ouuts
, ());

78 
l
.
x
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

79 
l
.
x_nÜm
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

82 #ifdeà
GPU


83 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_cÚÃùed_Ïy”_gpu
;

84 
l
.
backw¬d_gpu
 = 
backw¬d_cÚÃùed_Ïy”_gpu
;

85 
l
.
upd©e_gpu
 = 
upd©e_cÚÃùed_Ïy”_gpu
;

87 
l
.
weights_gpu
 = 
	`cuda_make_¬¿y
Ö.
weights
, 
ouuts
*
šputs
);

88 
l
.
bŸ£s_gpu
 = 
	`cuda_make_¬¿y
Ö.
bŸ£s
, 
ouuts
);

90 
l
.
weight_upd©es_gpu
 = 
	`cuda_make_¬¿y
Ö.
weight_upd©es
, 
ouuts
*
šputs
);

91 
l
.
bŸs_upd©es_gpu
 = 
	`cuda_make_¬¿y
Ö.
bŸs_upd©es
, 
ouuts
);

93 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
, 
ouuts
*
b©ch
);

94 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
, 
ouuts
*
b©ch
);

95 ià(
adam
) {

96 
l
.
m_gpu
 = 
	`cuda_make_¬¿y
(0, 
šputs
*
ouuts
);

97 
l
.
v_gpu
 = 
	`cuda_make_¬¿y
(0, 
šputs
*
ouuts
);

98 
l
.
bŸs_m_gpu
 = 
	`cuda_make_¬¿y
(0, 
ouuts
);

99 
l
.
bŸs_v_gpu
 = 
	`cuda_make_¬¿y
(0, 
ouuts
);

100 
l
.
sÿË_m_gpu
 = 
	`cuda_make_¬¿y
(0, 
ouuts
);

101 
l
.
sÿË_v_gpu
 = 
	`cuda_make_¬¿y
(0, 
ouuts
);

104 if(
b©ch_nÜm®ize
){

105 
l
.
m—n_gpu
 = 
	`cuda_make_¬¿y
Ö.
m—n
, 
ouuts
);

106 
l
.
v¬Ÿnû_gpu
 = 
	`cuda_make_¬¿y
Ö.
v¬Ÿnû
, 
ouuts
);

108 
l
.
rŞlšg_m—n_gpu
 = 
	`cuda_make_¬¿y
Ö.
m—n
, 
ouuts
);

109 
l
.
rŞlšg_v¬Ÿnû_gpu
 = 
	`cuda_make_¬¿y
Ö.
v¬Ÿnû
, 
ouuts
);

111 
l
.
m—n_d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
m—n
, 
ouuts
);

112 
l
.
v¬Ÿnû_d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
v¬Ÿnû
, 
ouuts
);

114 
l
.
sÿËs_gpu
 = 
	`cuda_make_¬¿y
Ö.
sÿËs
, 
ouuts
);

115 
l
.
sÿË_upd©es_gpu
 = 
	`cuda_make_¬¿y
Ö.
sÿË_upd©es
, 
ouuts
);

117 
l
.
x_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
,†.
b©ch
*
ouuts
);

118 
l
.
x_nÜm_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
,†.
b©ch
*
ouuts
);

119 #ifdeà
CUDNN


120 
	`cudÂC»©eT’sÜDesütÜ
(&
l
.
nÜmT’sÜDesc
);

121 
	`cudÂC»©eT’sÜDesütÜ
(&
l
.
d¡T’sÜDesc
);

122 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
,†.
b©ch
,†.
out_c
,†.
out_h
,†.
out_w
);

123 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
nÜmT’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 1,†.
out_c
, 1, 1);

127 
l
.
aùiv©iÚ
 =‡ctivation;

128 
	`årštf
(
¡d”r
, "cÚÃùed %4d -> %4d\n", 
šputs
, 
ouuts
);

129  
l
;

130 
	}
}

132 
	$upd©e_cÚÃùed_Ïy”
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
)

134 
Ë¬nšg_¿‹
 = 
a
.Ë¬nšg_¿‹*
l
.
Ë¬nšg_¿‹_sÿË
;

135 
mom’tum
 = 
a
.momentum;

136 
deÿy
 = 
a
.decay;

137 
b©ch
 = 
a
.batch;

138 
	`axpy_ıu
(
l
.
ouuts
, 
Ë¬nšg_¿‹
/
b©ch
,†.
bŸs_upd©es
, 1,†.
bŸ£s
, 1);

139 
	`sÿl_ıu
(
l
.
ouuts
, 
mom’tum
,†.
bŸs_upd©es
, 1);

141 if(
l
.
b©ch_nÜm®ize
){

142 
	`axpy_ıu
(
l
.
ouuts
, 
Ë¬nšg_¿‹
/
b©ch
,†.
sÿË_upd©es
, 1,†.
sÿËs
, 1);

143 
	`sÿl_ıu
(
l
.
ouuts
, 
mom’tum
,†.
sÿË_upd©es
, 1);

146 
	`axpy_ıu
(
l
.
šputs
*l.
ouuts
, -
deÿy
*
b©ch
,†.
weights
, 1,†.
weight_upd©es
, 1);

147 
	`axpy_ıu
(
l
.
šputs
*l.
ouuts
, 
Ë¬nšg_¿‹
/
b©ch
,†.
weight_upd©es
, 1,†.
weights
, 1);

148 
	`sÿl_ıu
(
l
.
šputs
*l.
ouuts
, 
mom’tum
,†.
weight_upd©es
, 1);

149 
	}
}

151 
	$fÜw¬d_cÚÃùed_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

153 
	`fl_ıu
(
l
.
ouuts
*l.
b©ch
, 0,†.
ouut
, 1);

154 
m
 = 
l
.
b©ch
;

155 
k
 = 
l
.
šputs
;

156 
n
 = 
l
.
ouuts
;

157 *
a
 = 
Ãt
.
šput
;

158 *
b
 = 
l
.
weights
;

159 *
c
 = 
l
.
ouut
;

160 
	`gemm
(0,1,
m
,
n
,
k
,1,
a
,k,
b
,k,1,
c
,n);

161 if(
l
.
b©ch_nÜm®ize
){

162 
	`fÜw¬d_b©chnÜm_Ïy”
(
l
, 
Ãt
);

164 
	`add_bŸs
(
l
.
ouut
,†.
bŸ£s
,†.
b©ch
,†.
ouuts
, 1);

166 
	`aùiv©e_¬¿y
(
l
.
ouut
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
);

167 
	}
}

169 
	$backw¬d_cÚÃùed_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

171 
	`g¿d›Á_¬¿y
(
l
.
ouut
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
,†.
d–
);

173 if(
l
.
b©ch_nÜm®ize
){

174 
	`backw¬d_b©chnÜm_Ïy”
(
l
, 
Ãt
);

176 
	`backw¬d_bŸs
(
l
.
bŸs_upd©es
,†.
d–
,†.
b©ch
,†.
ouuts
, 1);

179 
m
 = 
l
.
ouuts
;

180 
k
 = 
l
.
b©ch
;

181 
n
 = 
l
.
šputs
;

182 *
a
 = 
l
.
d–
;

183 *
b
 = 
Ãt
.
šput
;

184 *
c
 = 
l
.
weight_upd©es
;

185 
	`gemm
(1,0,
m
,
n
,
k
,1,
a
,m,
b
,n,1,
c
,n);

187 
m
 = 
l
.
b©ch
;

188 
k
 = 
l
.
ouuts
;

189 
n
 = 
l
.
šputs
;

191 
a
 = 
l
.
d–
;

192 
b
 = 
l
.
weights
;

193 
c
 = 
Ãt
.
d–
;

195 if(
c
è
	`gemm
(0,0,
m
,
n
,
k
,1,
a
,k,
b
,n,1,c,n);

196 
	}
}

199 
	$d’Üm®ize_cÚÃùed_Ïy”
(
Ïy”
 
l
)

201 
i
, 
j
;

202 
i
 = 0; i < 
l
.
ouuts
; ++i){

203 
sÿË
 = 
l
.
sÿËs
[
i
]/
	`sq¹
Ö.
rŞlšg_v¬Ÿnû
[i] + .000001);

204 
j
 = 0; j < 
l
.
šputs
; ++j){

205 
l
.
weights
[
i
*l.
šputs
 + 
j
] *ğ
sÿË
;

207 
l
.
bŸ£s
[
i
] -ğl.
rŞlšg_m—n
[i] * 
sÿË
;

208 
l
.
sÿËs
[
i
] = 1;

209 
l
.
rŞlšg_m—n
[
i
] = 0;

210 
l
.
rŞlšg_v¬Ÿnû
[
i
] = 1;

212 
	}
}

215 
	$¡©i¡ics_cÚÃùed_Ïy”
(
Ïy”
 
l
)

217 if(
l
.
b©ch_nÜm®ize
){

218 
	`´štf
("Scales ");

219 
	`´št_¡©i¡ics
(
l
.
sÿËs
,†.
ouuts
);

227 
	`´štf
("Biases ");

228 
	`´št_¡©i¡ics
(
l
.
bŸ£s
,†.
ouuts
);

229 
	`´štf
("Weights ");

230 
	`´št_¡©i¡ics
(
l
.
weights
,†.
ouuts
);

231 
	}
}

233 #ifdeà
GPU


235 
	$puÎ_cÚÃùed_Ïy”
(
Ïy”
 
l
)

237 
	`cuda_puÎ_¬¿y
(
l
.
weights_gpu
,†.
weights
,†.
šputs
*l.
ouuts
);

238 
	`cuda_puÎ_¬¿y
(
l
.
bŸ£s_gpu
,†.
bŸ£s
,†.
ouuts
);

239 
	`cuda_puÎ_¬¿y
(
l
.
weight_upd©es_gpu
,†.
weight_upd©es
,†.
šputs
*l.
ouuts
);

240 
	`cuda_puÎ_¬¿y
(
l
.
bŸs_upd©es_gpu
,†.
bŸs_upd©es
,†.
ouuts
);

241 ià(
l
.
b©ch_nÜm®ize
){

242 
	`cuda_puÎ_¬¿y
(
l
.
sÿËs_gpu
,†.
sÿËs
,†.
ouuts
);

243 
	`cuda_puÎ_¬¿y
(
l
.
rŞlšg_m—n_gpu
,†.
rŞlšg_m—n
,†.
ouuts
);

244 
	`cuda_puÎ_¬¿y
(
l
.
rŞlšg_v¬Ÿnû_gpu
,†.
rŞlšg_v¬Ÿnû
,†.
ouuts
);

246 
	}
}

248 
	$push_cÚÃùed_Ïy”
(
Ïy”
 
l
)

250 
	`cuda_push_¬¿y
(
l
.
weights_gpu
,†.
weights
,†.
šputs
*l.
ouuts
);

251 
	`cuda_push_¬¿y
(
l
.
bŸ£s_gpu
,†.
bŸ£s
,†.
ouuts
);

252 
	`cuda_push_¬¿y
(
l
.
weight_upd©es_gpu
,†.
weight_upd©es
,†.
šputs
*l.
ouuts
);

253 
	`cuda_push_¬¿y
(
l
.
bŸs_upd©es_gpu
,†.
bŸs_upd©es
,†.
ouuts
);

254 ià(
l
.
b©ch_nÜm®ize
){

255 
	`cuda_push_¬¿y
(
l
.
sÿËs_gpu
,†.
sÿËs
,†.
ouuts
);

256 
	`cuda_push_¬¿y
(
l
.
rŞlšg_m—n_gpu
,†.
rŞlšg_m—n
,†.
ouuts
);

257 
	`cuda_push_¬¿y
(
l
.
rŞlšg_v¬Ÿnû_gpu
,†.
rŞlšg_v¬Ÿnû
,†.
ouuts
);

259 
	}
}

261 
	$upd©e_cÚÃùed_Ïy”_gpu
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
)

263 
Ë¬nšg_¿‹
 = 
a
.Ë¬nšg_¿‹*
l
.
Ë¬nšg_¿‹_sÿË
;

264 
mom’tum
 = 
a
.momentum;

265 
deÿy
 = 
a
.decay;

266 
b©ch
 = 
a
.batch;

267 if(
a
.
adam
){

268 
	`adam_upd©e_gpu
(
l
.
weights_gpu
,†.
weight_upd©es_gpu
,†.
m_gpu
,†.
v_gpu
, 
a
.
B1
,‡.
B2
,‡.
•s
, 
deÿy
, 
Ë¬nšg_¿‹
,†.
šputs
*l.
ouuts
, 
b©ch
,‡.
t
);

269 
	`adam_upd©e_gpu
(
l
.
bŸ£s_gpu
,†.
bŸs_upd©es_gpu
,†.
bŸs_m_gpu
,†.
bŸs_v_gpu
, 
a
.
B1
,‡.
B2
,‡.
•s
, 
deÿy
, 
Ë¬nšg_¿‹
,†.
ouuts
, 
b©ch
,‡.
t
);

270 if(
l
.
sÿËs_gpu
){

271 
	`adam_upd©e_gpu
(
l
.
sÿËs_gpu
,†.
sÿË_upd©es_gpu
,†.
sÿË_m_gpu
,†.
sÿË_v_gpu
, 
a
.
B1
,‡.
B2
,‡.
•s
, 
deÿy
, 
Ë¬nšg_¿‹
,†.
ouuts
, 
b©ch
,‡.
t
);

274 
	`axpy_gpu
(
l
.
ouuts
, 
Ë¬nšg_¿‹
/
b©ch
,†.
bŸs_upd©es_gpu
, 1,†.
bŸ£s_gpu
, 1);

275 
	`sÿl_gpu
(
l
.
ouuts
, 
mom’tum
,†.
bŸs_upd©es_gpu
, 1);

277 if(
l
.
b©ch_nÜm®ize
){

278 
	`axpy_gpu
(
l
.
ouuts
, 
Ë¬nšg_¿‹
/
b©ch
,†.
sÿË_upd©es_gpu
, 1,†.
sÿËs_gpu
, 1);

279 
	`sÿl_gpu
(
l
.
ouuts
, 
mom’tum
,†.
sÿË_upd©es_gpu
, 1);

282 
	`axpy_gpu
(
l
.
šputs
*l.
ouuts
, -
deÿy
*
b©ch
,†.
weights_gpu
, 1,†.
weight_upd©es_gpu
, 1);

283 
	`axpy_gpu
(
l
.
šputs
*l.
ouuts
, 
Ë¬nšg_¿‹
/
b©ch
,†.
weight_upd©es_gpu
, 1,†.
weights_gpu
, 1);

284 
	`sÿl_gpu
(
l
.
šputs
*l.
ouuts
, 
mom’tum
,†.
weight_upd©es_gpu
, 1);

286 
	}
}

288 
	$fÜw¬d_cÚÃùed_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

290 
	`fl_gpu
(
l
.
ouuts
*l.
b©ch
, 0,†.
ouut_gpu
, 1);

292 
m
 = 
l
.
b©ch
;

293 
k
 = 
l
.
šputs
;

294 
n
 = 
l
.
ouuts
;

295 * 
a
 = 
Ãt
.
šput_gpu
;

296 * 
b
 = 
l
.
weights_gpu
;

297 * 
c
 = 
l
.
ouut_gpu
;

298 
	`gemm_gpu
(0,1,
m
,
n
,
k
,1,
a
,k,
b
,k,1,
c
,n);

300 ià(
l
.
b©ch_nÜm®ize
) {

301 
	`fÜw¬d_b©chnÜm_Ïy”_gpu
(
l
, 
Ãt
);

303 
	`add_bŸs_gpu
(
l
.
ouut_gpu
,†.
bŸ£s_gpu
,†.
b©ch
,†.
ouuts
, 1);

305 
	`aùiv©e_¬¿y_gpu
(
l
.
ouut_gpu
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
);

306 
	}
}

308 
	$backw¬d_cÚÃùed_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

310 
	`cÚ¡¿š_gpu
(
l
.
ouuts
*l.
b©ch
, 1,†.
d–_gpu
, 1);

311 
	`g¿d›Á_¬¿y_gpu
(
l
.
ouut_gpu
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
,†.
d–_gpu
);

312 if(
l
.
b©ch_nÜm®ize
){

313 
	`backw¬d_b©chnÜm_Ïy”_gpu
(
l
, 
Ãt
);

315 
	`backw¬d_bŸs_gpu
(
l
.
bŸs_upd©es_gpu
,†.
d–_gpu
,†.
b©ch
,†.
ouuts
, 1);

318 
m
 = 
l
.
ouuts
;

319 
k
 = 
l
.
b©ch
;

320 
n
 = 
l
.
šputs
;

321 * 
a
 = 
l
.
d–_gpu
;

322 * 
b
 = 
Ãt
.
šput_gpu
;

323 * 
c
 = 
l
.
weight_upd©es_gpu
;

324 
	`gemm_gpu
(1,0,
m
,
n
,
k
,1,
a
,m,
b
,n,1,
c
,n);

326 
m
 = 
l
.
b©ch
;

327 
k
 = 
l
.
ouuts
;

328 
n
 = 
l
.
šputs
;

330 
a
 = 
l
.
d–_gpu
;

331 
b
 = 
l
.
weights_gpu
;

332 
c
 = 
Ãt
.
d–_gpu
;

334 if(
c
è
	`gemm_gpu
(0,0,
m
,
n
,
k
,1,
a
,k,
b
,n,1,c,n);

335 
	}
}

	@connected_layer.h

1 #iâdeà
CONNECTED_LAYER_H


2 
	#CONNECTED_LAYER_H


	)

4 
	~"aùiv©iÚs.h
"

5 
	~"Ïy”.h
"

6 
	~"ÃtwÜk.h
"

8 
Ïy”
 
make_cÚÃùed_Ïy”
(
b©ch
, 
šputs
, 
ouuts
, 
ACTIVATION
 
aùiv©iÚ
, 
b©ch_nÜm®ize
, 
adam
);

10 
fÜw¬d_cÚÃùed_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

11 
backw¬d_cÚÃùed_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

12 
upd©e_cÚÃùed_Ïy”
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
);

14 #ifdeà
GPU


15 
fÜw¬d_cÚÃùed_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

16 
backw¬d_cÚÃùed_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

17 
upd©e_cÚÃùed_Ïy”_gpu
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
);

18 
push_cÚÃùed_Ïy”
(
Ïy”
 
l
);

19 
puÎ_cÚÃùed_Ïy”
(
Ïy”
 
l
);

	@convolutional_layer.c

1 
	~"cÚvŞutiÚ®_Ïy”.h
"

2 
	~"uts.h
"

3 
	~"b©chnÜm_Ïy”.h
"

4 
	~"im2cŞ.h
"

5 
	~"cŞ2im.h
"

6 
	~"bÏs.h
"

7 
	~"gemm.h
"

8 
	~<¡dio.h
>

9 
	~<time.h
>

11 #ifdeà
AI2


12 
	~"xnÜ_Ïy”.h
"

15 
	$sw­_bš¬y
(
cÚvŞutiÚ®_Ïy”
 *
l
)

17 *
sw­
 = 
l
->
weights
;

18 
l
->
weights
 =†->
bš¬y_weights
;

19 
l
->
bš¬y_weights
 = 
sw­
;

21 #ifdeà
GPU


22 
sw­
 = 
l
->
weights_gpu
;

23 
l
->
weights_gpu
 =†->
bš¬y_weights_gpu
;

24 
l
->
bš¬y_weights_gpu
 = 
sw­
;

26 
	}
}

28 
	$bš¬ize_weights
(*
weights
, 
n
, 
size
, *
bš¬y
)

30 
i
, 
f
;

31 
f
 = 0; f < 
n
; ++f){

32 
m—n
 = 0;

33 
i
 = 0; i < 
size
; ++i){

34 
m—n
 +ğ
	`çbs
(
weights
[
f
*
size
 + 
i
]);

36 
m—n
 = m—À/ 
size
;

37 
i
 = 0; i < 
size
; ++i){

38 
bš¬y
[
f
*
size
 + 
i
] = (
weights
[f*siz+ i] > 0è? 
m—n
 : -mean;

41 
	}
}

43 
	$bš¬ize_ıu
(*
šput
, 
n
, *
bš¬y
)

45 
i
;

46 
i
 = 0; i < 
n
; ++i){

47 
bš¬y
[
i
] = (
šput
[i] > 0) ? 1 : -1;

49 
	}
}

51 
	$bš¬ize_šput
(*
šput
, 
n
, 
size
, *
bš¬y
)

53 
i
, 
s
;

54 
s
 = 0; s < 
size
; ++s){

55 
m—n
 = 0;

56 
i
 = 0; i < 
n
; ++i){

57 
m—n
 +ğ
	`çbs
(
šput
[
i
*
size
 + 
s
]);

59 
m—n
 = m—À/ 
n
;

60 
i
 = 0; i < 
n
; ++i){

61 
bš¬y
[
i
*
size
 + 
s
] = (
šput
[i*siz+ s] > 0è? 
m—n
 : -mean;

64 
	}
}

66 
	$cÚvŞutiÚ®_out_height
(
cÚvŞutiÚ®_Ïy”
 
l
)

68  (
l
.
h
 + 2*l.
·d
 -†.
size
è/†.
¡ride
 + 1;

69 
	}
}

71 
	$cÚvŞutiÚ®_out_width
(
cÚvŞutiÚ®_Ïy”
 
l
)

73  (
l
.
w
 + 2*l.
·d
 -†.
size
è/†.
¡ride
 + 1;

74 
	}
}

76 
image
 
	$g‘_cÚvŞutiÚ®_image
(
cÚvŞutiÚ®_Ïy”
 
l
)

78  
	`æßt_to_image
(
l
.
out_w
,l.
out_h
,l.
out_c
,l.
ouut
);

79 
	}
}

81 
image
 
	$g‘_cÚvŞutiÚ®_d–
(
cÚvŞutiÚ®_Ïy”
 
l
)

83  
	`æßt_to_image
(
l
.
out_w
,l.
out_h
,l.
out_c
,l.
d–
);

84 
	}
}

86 
size_t
 
	$g‘_wÜk¥aû_size
(
Ïy”
 
l
){

87 #ifdeà
CUDNN


88 if(
gpu_šdex
 >= 0){

89 
size_t
 
mo¡
 = 0;

90 
size_t
 
s
 = 0;

91 
	`cudÂG‘CÚvŞutiÚFÜw¬dWÜk¥aûSize
(
	`cudÂ_hªdË
(),

92 
l
.
¤cT’sÜDesc
,

93 
l
.
weightDesc
,

94 
l
.
cÚvDesc
,

95 
l
.
d¡T’sÜDesc
,

96 
l
.
fw_®go
,

97 &
s
);

98 ià(
s
 > 
mo¡
) most = s;

99 
	`cudÂG‘CÚvŞutiÚBackw¬dF‹rWÜk¥aûSize
(
	`cudÂ_hªdË
(),

100 
l
.
¤cT’sÜDesc
,

101 
l
.
dd¡T’sÜDesc
,

102 
l
.
cÚvDesc
,

103 
l
.
dweightDesc
,

104 
l
.
bf_®go
,

105 &
s
);

106 ià(
s
 > 
mo¡
) most = s;

107 
	`cudÂG‘CÚvŞutiÚBackw¬dD©aWÜk¥aûSize
(
	`cudÂ_hªdË
(),

108 
l
.
weightDesc
,

109 
l
.
dd¡T’sÜDesc
,

110 
l
.
cÚvDesc
,

111 
l
.
d¤cT’sÜDesc
,

112 
l
.
bd_®go
,

113 &
s
);

114 ià(
s
 > 
mo¡
) most = s;

115  
mo¡
;

118  (
size_t
)
l
.
out_h
*l.
out_w
*l.
size
*l.size*l.
c
/l.
groups
*();

119 
	}
}

121 #ifdeà
GPU


122 #ifdeà
CUDNN


123 
	$cudÂ_cÚvŞutiÚ®_£tup
(
Ïy”
 *
l
)

125 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
->
d¤cT’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
,†->
b©ch
,†->
c
,†->
h
,†->
w
);

126 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
->
dd¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
,†->
b©ch
,†->
out_c
,†->
out_h
,†->
out_w
);

128 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
->
¤cT’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
,†->
b©ch
,†->
c
,†->
h
,†->
w
);

129 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
,†->
b©ch
,†->
out_c
,†->
out_h
,†->
out_w
);

130 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
->
nÜmT’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 1,†->
out_c
, 1, 1);

132 
	`cudÂS‘F‹r4dDesütÜ
(
l
->
dweightDesc
, 
CUDNN_DATA_FLOAT
, 
CUDNN_TENSOR_NCHW
,†->
n
,†->
c
/l->
groups
,†->
size
,†->size);

133 
	`cudÂS‘F‹r4dDesütÜ
(
l
->
weightDesc
, 
CUDNN_DATA_FLOAT
, 
CUDNN_TENSOR_NCHW
,†->
n
,†->
c
/l->
groups
,†->
size
,†->size);

134 #ià
CUDNN_MAJOR
 >= 6

135 
	`cudÂS‘CÚvŞutiÚ2dDesütÜ
(
l
->
cÚvDesc
,†->
·d
,†->·d,†->
¡ride
,†->¡ride, 1, 1, 
CUDNN_CROSS_CORRELATION
, 
CUDNN_DATA_FLOAT
);

137 
	`cudÂS‘CÚvŞutiÚ2dDesütÜ
(
l
->
cÚvDesc
,†->
·d
,†->·d,†->
¡ride
,†->¡ride, 1, 1, 
CUDNN_CROSS_CORRELATION
);

140 #ià
CUDNN_MAJOR
 >= 7

141 
	`cudÂS‘CÚvŞutiÚGroupCouÁ
(
l
->
cÚvDesc
,†->
groups
);

143 if(
l
->
groups
 > 1){

144 
	`”rÜ
("CUDNN < 7 doesn't support groups,…lease upgrade!");

148 
	`cudÂG‘CÚvŞutiÚFÜw¬dAlgÜ™hm
(
	`cudÂ_hªdË
(),

149 
l
->
¤cT’sÜDesc
,

150 
l
->
weightDesc
,

151 
l
->
cÚvDesc
,

152 
l
->
d¡T’sÜDesc
,

153 
CUDNN_CONVOLUTION_FWD_SPECIFY_WORKSPACE_LIMIT
,

155 &
l
->
fw_®go
);

156 
	`cudÂG‘CÚvŞutiÚBackw¬dD©aAlgÜ™hm
(
	`cudÂ_hªdË
(),

157 
l
->
weightDesc
,

158 
l
->
dd¡T’sÜDesc
,

159 
l
->
cÚvDesc
,

160 
l
->
d¤cT’sÜDesc
,

161 
CUDNN_CONVOLUTION_BWD_DATA_SPECIFY_WORKSPACE_LIMIT
,

163 &
l
->
bd_®go
);

164 
	`cudÂG‘CÚvŞutiÚBackw¬dF‹rAlgÜ™hm
(
	`cudÂ_hªdË
(),

165 
l
->
¤cT’sÜDesc
,

166 
l
->
dd¡T’sÜDesc
,

167 
l
->
cÚvDesc
,

168 
l
->
dweightDesc
,

169 
CUDNN_CONVOLUTION_BWD_FILTER_SPECIFY_WORKSPACE_LIMIT
,

171 &
l
->
bf_®go
);

172 
	}
}

176 
cÚvŞutiÚ®_Ïy”
 
	$make_cÚvŞutiÚ®_Ïy”
(
b©ch
, 
h
, 
w
, 
c
, 
n
, 
groups
, 
size
, 
¡ride
, 
·ddšg
, 
ACTIVATION
 
aùiv©iÚ
, 
b©ch_nÜm®ize
, 
bš¬y
, 
xnÜ
, 
adam
)

178 
i
;

179 
cÚvŞutiÚ®_Ïy”
 
l
 = {0};

180 
l
.
ty³
 = 
CONVOLUTIONAL
;

182 
l
.
groups
 = groups;

183 
l
.
h
 = h;

184 
l
.
w
 = w;

185 
l
.
c
 = c;

186 
l
.
n
 =‚;

187 
l
.
bš¬y
 = binary;

188 
l
.
xnÜ
 = xnor;

189 
l
.
b©ch
 = batch;

190 
l
.
¡ride
 = stride;

191 
l
.
size
 = size;

192 
l
.
·d
 = 
·ddšg
;

193 
l
.
b©ch_nÜm®ize
 = batch_normalize;

195 
l
.
weights
 = 
	`ÿÎoc
(
c
/
groups
*
n
*
size
*size, ());

196 
l
.
weight_upd©es
 = 
	`ÿÎoc
(
c
/
groups
*
n
*
size
*size, ());

198 
l
.
bŸ£s
 = 
	`ÿÎoc
(
n
, ());

199 
l
.
bŸs_upd©es
 = 
	`ÿÎoc
(
n
, ());

201 
l
.
nweights
 = 
c
/
groups
*
n
*
size
*size;

202 
l
.
nbŸ£s
 = 
n
;

205 
sÿË
 = 
	`sq¹
(2./(
size
*size*
c
/
l
.
groups
));

209 
i
 = 0; i < 
l
.
nweights
; ++ièl.
weights
[i] = 
sÿË
*
	`¿nd_nÜm®
();

210 
out_w
 = 
	`cÚvŞutiÚ®_out_width
(
l
);

211 
out_h
 = 
	`cÚvŞutiÚ®_out_height
(
l
);

212 
l
.
out_h
 = out_h;

213 
l
.
out_w
 = out_w;

214 
l
.
out_c
 = 
n
;

215 
l
.
ouuts
 =†.
out_h
 *†.
out_w
 *†.
out_c
;

216 
l
.
šputs
 =†.
w
 *†.
h
 *†.
c
;

218 
l
.
ouut
 = 
	`ÿÎoc
Ö.
b©ch
*l.
ouuts
, ());

219 
l
.
d–
 = 
	`ÿÎoc
Ö.
b©ch
*l.
ouuts
, ());

221 
l
.
fÜw¬d
 = 
fÜw¬d_cÚvŞutiÚ®_Ïy”
;

222 
l
.
backw¬d
 = 
backw¬d_cÚvŞutiÚ®_Ïy”
;

223 
l
.
upd©e
 = 
upd©e_cÚvŞutiÚ®_Ïy”
;

224 if(
bš¬y
){

225 
l
.
bš¬y_weights
 = 
	`ÿÎoc
Ö.
nweights
, ());

226 
l
.
cweights
 = 
	`ÿÎoc
Ö.
nweights
, ());

227 
l
.
sÿËs
 = 
	`ÿÎoc
(
n
, ());

229 if(
xnÜ
){

230 
l
.
bš¬y_weights
 = 
	`ÿÎoc
Ö.
nweights
, ());

231 
l
.
bš¬y_šput
 = 
	`ÿÎoc
Ö.
šputs
*l.
b©ch
, ());

234 if(
b©ch_nÜm®ize
){

235 
l
.
sÿËs
 = 
	`ÿÎoc
(
n
, ());

236 
l
.
sÿË_upd©es
 = 
	`ÿÎoc
(
n
, ());

237 
i
 = 0; i < 
n
; ++i){

238 
l
.
sÿËs
[
i
] = 1;

241 
l
.
m—n
 = 
	`ÿÎoc
(
n
, ());

242 
l
.
v¬Ÿnû
 = 
	`ÿÎoc
(
n
, ());

244 
l
.
m—n_d–
 = 
	`ÿÎoc
(
n
, ());

245 
l
.
v¬Ÿnû_d–
 = 
	`ÿÎoc
(
n
, ());

247 
l
.
rŞlšg_m—n
 = 
	`ÿÎoc
(
n
, ());

248 
l
.
rŞlšg_v¬Ÿnû
 = 
	`ÿÎoc
(
n
, ());

249 
l
.
x
 = 
	`ÿÎoc
Ö.
b©ch
*l.
ouuts
, ());

250 
l
.
x_nÜm
 = 
	`ÿÎoc
Ö.
b©ch
*l.
ouuts
, ());

252 if(
adam
){

253 
l
.
m
 = 
	`ÿÎoc
Ö.
nweights
, ());

254 
l
.
v
 = 
	`ÿÎoc
Ö.
nweights
, ());

255 
l
.
bŸs_m
 = 
	`ÿÎoc
(
n
, ());

256 
l
.
sÿË_m
 = 
	`ÿÎoc
(
n
, ());

257 
l
.
bŸs_v
 = 
	`ÿÎoc
(
n
, ());

258 
l
.
sÿË_v
 = 
	`ÿÎoc
(
n
, ());

261 #ifdeà
GPU


262 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_cÚvŞutiÚ®_Ïy”_gpu
;

263 
l
.
backw¬d_gpu
 = 
backw¬d_cÚvŞutiÚ®_Ïy”_gpu
;

264 
l
.
upd©e_gpu
 = 
upd©e_cÚvŞutiÚ®_Ïy”_gpu
;

266 if(
gpu_šdex
 >= 0){

267 ià(
adam
) {

268 
l
.
m_gpu
 = 
	`cuda_make_¬¿y
Ö.
m
,†.
nweights
);

269 
l
.
v_gpu
 = 
	`cuda_make_¬¿y
Ö.
v
,†.
nweights
);

270 
l
.
bŸs_m_gpu
 = 
	`cuda_make_¬¿y
Ö.
bŸs_m
, 
n
);

271 
l
.
bŸs_v_gpu
 = 
	`cuda_make_¬¿y
Ö.
bŸs_v
, 
n
);

272 
l
.
sÿË_m_gpu
 = 
	`cuda_make_¬¿y
Ö.
sÿË_m
, 
n
);

273 
l
.
sÿË_v_gpu
 = 
	`cuda_make_¬¿y
Ö.
sÿË_v
, 
n
);

276 
l
.
weights_gpu
 = 
	`cuda_make_¬¿y
Ö.
weights
,†.
nweights
);

277 
l
.
weight_upd©es_gpu
 = 
	`cuda_make_¬¿y
Ö.
weight_upd©es
,†.
nweights
);

279 
l
.
bŸ£s_gpu
 = 
	`cuda_make_¬¿y
Ö.
bŸ£s
, 
n
);

280 
l
.
bŸs_upd©es_gpu
 = 
	`cuda_make_¬¿y
Ö.
bŸs_upd©es
, 
n
);

282 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
,†.
b©ch
*
out_h
*
out_w
*
n
);

283 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
,†.
b©ch
*
out_h
*
out_w
*
n
);

285 if(
bš¬y
){

286 
l
.
bš¬y_weights_gpu
 = 
	`cuda_make_¬¿y
Ö.
weights
,†.
nweights
);

288 if(
xnÜ
){

289 
l
.
bš¬y_weights_gpu
 = 
	`cuda_make_¬¿y
Ö.
weights
,†.
nweights
);

290 
l
.
bš¬y_šput_gpu
 = 
	`cuda_make_¬¿y
(0,†.
šputs
*l.
b©ch
);

293 if(
b©ch_nÜm®ize
){

294 
l
.
m—n_gpu
 = 
	`cuda_make_¬¿y
Ö.
m—n
, 
n
);

295 
l
.
v¬Ÿnû_gpu
 = 
	`cuda_make_¬¿y
Ö.
v¬Ÿnû
, 
n
);

297 
l
.
rŞlšg_m—n_gpu
 = 
	`cuda_make_¬¿y
Ö.
m—n
, 
n
);

298 
l
.
rŞlšg_v¬Ÿnû_gpu
 = 
	`cuda_make_¬¿y
Ö.
v¬Ÿnû
, 
n
);

300 
l
.
m—n_d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
m—n
, 
n
);

301 
l
.
v¬Ÿnû_d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
v¬Ÿnû
, 
n
);

303 
l
.
sÿËs_gpu
 = 
	`cuda_make_¬¿y
Ö.
sÿËs
, 
n
);

304 
l
.
sÿË_upd©es_gpu
 = 
	`cuda_make_¬¿y
Ö.
sÿË_upd©es
, 
n
);

306 
l
.
x_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
,†.
b©ch
*
out_h
*
out_w
*
n
);

307 
l
.
x_nÜm_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
,†.
b©ch
*
out_h
*
out_w
*
n
);

309 #ifdeà
CUDNN


310 
	`cudÂC»©eT’sÜDesütÜ
(&
l
.
nÜmT’sÜDesc
);

311 
	`cudÂC»©eT’sÜDesütÜ
(&
l
.
¤cT’sÜDesc
);

312 
	`cudÂC»©eT’sÜDesütÜ
(&
l
.
d¡T’sÜDesc
);

313 
	`cudÂC»©eF‹rDesütÜ
(&
l
.
weightDesc
);

314 
	`cudÂC»©eT’sÜDesütÜ
(&
l
.
d¤cT’sÜDesc
);

315 
	`cudÂC»©eT’sÜDesütÜ
(&
l
.
dd¡T’sÜDesc
);

316 
	`cudÂC»©eF‹rDesütÜ
(&
l
.
dweightDesc
);

317 
	`cudÂC»©eCÚvŞutiÚDesütÜ
(&
l
.
cÚvDesc
);

318 
	`cudÂ_cÚvŞutiÚ®_£tup
(&
l
);

322 
l
.
wÜk¥aû_size
 = 
	`g‘_wÜk¥aû_size
(l);

323 
l
.
aùiv©iÚ
 =‡ctivation;

325 
	`årštf
(
¡d”r
, "cÚv %5d %2d x%2d /%2d %4d x%4d x%4d -> %4d x%4d x%4d %5.3àBFLOPs\n", 
n
, 
size
, size, 
¡ride
, 
w
, 
h
, 
c
, 
l
.
out_w
,†.
out_h
,†.
out_c
, (2.0 *†.À*†.size*l.size*l.c/l.
groups
 *†.out_h*l.out_w)/1000000000.);

327  
l
;

328 
	}
}

330 
	$d’Üm®ize_cÚvŞutiÚ®_Ïy”
(
cÚvŞutiÚ®_Ïy”
 
l
)

332 
i
, 
j
;

333 
i
 = 0; i < 
l
.
n
; ++i){

334 
sÿË
 = 
l
.
sÿËs
[
i
]/
	`sq¹
Ö.
rŞlšg_v¬Ÿnû
[i] + .00001);

335 
j
 = 0; j < 
l
.
c
/l.
groups
*l.
size
*l.size; ++j){

336 
l
.
weights
[
i
*l.
c
/l.
groups
*l.
size
*l.siz+ 
j
] *ğ
sÿË
;

338 
l
.
bŸ£s
[
i
] -ğl.
rŞlšg_m—n
[i] * 
sÿË
;

339 
l
.
sÿËs
[
i
] = 1;

340 
l
.
rŞlšg_m—n
[
i
] = 0;

341 
l
.
rŞlšg_v¬Ÿnû
[
i
] = 1;

343 
	}
}

370 
	$»size_cÚvŞutiÚ®_Ïy”
(
cÚvŞutiÚ®_Ïy”
 *
l
, 
w
, 
h
)

372 
l
->
w
 = w;

373 
l
->
h
 = h;

374 
out_w
 = 
	`cÚvŞutiÚ®_out_width
(*
l
);

375 
out_h
 = 
	`cÚvŞutiÚ®_out_height
(*
l
);

377 
l
->
out_w
 = out_w;

378 
l
->
out_h
 = out_h;

380 
l
->
ouuts
 =†->
out_h
 *†->
out_w
 *†->
out_c
;

381 
l
->
šputs
 =†->
w
 *†->
h
 *†->
c
;

383 
l
->
ouut
 = 
	`»®loc
Ö->ouut,†->
b©ch
*l->
ouuts
*());

384 
l
->
d–
 = 
	`»®loc
Ö->d–,†->
b©ch
*l->
ouuts
*());

385 if(
l
->
b©ch_nÜm®ize
){

386 
l
->
x
 = 
	`»®loc
Ö->x,†->
b©ch
*l->
ouuts
*());

387 
l
->
x_nÜm
 = 
	`»®loc
Ö->x_nÜm,†->
b©ch
*l->
ouuts
*());

390 #ifdeà
GPU


391 
	`cuda_ä“
(
l
->
d–_gpu
);

392 
	`cuda_ä“
(
l
->
ouut_gpu
);

394 
l
->
d–_gpu
 = 
	`cuda_make_¬¿y
Ö->
d–
,†->
b©ch
*l->
ouuts
);

395 
l
->
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö->
ouut
,†->
b©ch
*l->
ouuts
);

397 if(
l
->
b©ch_nÜm®ize
){

398 
	`cuda_ä“
(
l
->
x_gpu
);

399 
	`cuda_ä“
(
l
->
x_nÜm_gpu
);

401 
l
->
x_gpu
 = 
	`cuda_make_¬¿y
Ö->
ouut
,†->
b©ch
*l->
ouuts
);

402 
l
->
x_nÜm_gpu
 = 
	`cuda_make_¬¿y
Ö->
ouut
,†->
b©ch
*l->
ouuts
);

404 #ifdeà
CUDNN


405 
	`cudÂ_cÚvŞutiÚ®_£tup
(
l
);

408 
l
->
wÜk¥aû_size
 = 
	`g‘_wÜk¥aû_size
(*l);

409 
	}
}

411 
	$add_bŸs
(*
ouut
, *
bŸ£s
, 
b©ch
, 
n
, 
size
)

413 
i
,
j
,
b
;

414 
b
 = 0; b < 
b©ch
; ++b){

415 
i
 = 0; i < 
n
; ++i){

416 
j
 = 0; j < 
size
; ++j){

417 
ouut
[(
b
*
n
 + 
i
)*
size
 + 
j
] +ğ
bŸ£s
[i];

421 
	}
}

423 
	$sÿË_bŸs
(*
ouut
, *
sÿËs
, 
b©ch
, 
n
, 
size
)

425 
i
,
j
,
b
;

426 
b
 = 0; b < 
b©ch
; ++b){

427 
i
 = 0; i < 
n
; ++i){

428 
j
 = 0; j < 
size
; ++j){

429 
ouut
[(
b
*
n
 + 
i
)*
size
 + 
j
] *ğ
sÿËs
[i];

433 
	}
}

435 
	$backw¬d_bŸs
(*
bŸs_upd©es
, *
d–
, 
b©ch
, 
n
, 
size
)

437 
i
,
b
;

438 
b
 = 0; b < 
b©ch
; ++b){

439 
i
 = 0; i < 
n
; ++i){

440 
bŸs_upd©es
[
i
] +ğ
	`sum_¬¿y
(
d–
+
size
*(i+
b
*
n
), size);

443 
	}
}

445 
	$fÜw¬d_cÚvŞutiÚ®_Ïy”
(
cÚvŞutiÚ®_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

447 
i
, 
j
;

449 
	`fl_ıu
(
l
.
ouuts
*l.
b©ch
, 0,†.
ouut
, 1);

451 if(
l
.
xnÜ
){

452 
	`bš¬ize_weights
(
l
.
weights
,†.
n
,†.
c
/l.
groups
*l.
size
*l.size,†.
bš¬y_weights
);

453 
	`sw­_bš¬y
(&
l
);

454 
	`bš¬ize_ıu
(
Ãt
.
šput
, 
l
.
c
*l.
h
*l.
w
*l.
b©ch
,†.
bš¬y_šput
);

455 
Ãt
.
šput
 = 
l
.
bš¬y_šput
;

458 
m
 = 
l
.
n
/l.
groups
;

459 
k
 = 
l
.
size
*l.size*l.
c
/l.
groups
;

460 
n
 = 
l
.
out_w
*l.
out_h
;

461 
i
 = 0; i < 
l
.
b©ch
; ++i){

462 
j
 = 0; j < 
l
.
groups
; ++j){

463 *
a
 = 
l
.
weights
 + 
j
*l.
nweights
/l.
groups
;

464 *
b
 = 
Ãt
.
wÜk¥aû
;

465 *
c
 = 
l
.
ouut
 + (
i
*l.
groups
 + 
j
)*
n
*
m
;

466 *
im
 = 
Ãt
.
šput
 + (
i
*
l
.
groups
 + 
j
)*l.
c
/l.groups*l.
h
*l.
w
;

468 ià(
l
.
size
 == 1) {

469 
b
 = 
im
;

471 
	`im2cŞ_ıu
(
im
, 
l
.
c
/l.
groups
,†.
h
,†.
w
,†.
size
,†.
¡ride
,†.
·d
, 
b
);

473 
	`gemm
(0,0,
m
,
n
,
k
,1,
a
,k,
b
,n,1,
c
,n);

477 if(
l
.
b©ch_nÜm®ize
){

478 
	`fÜw¬d_b©chnÜm_Ïy”
(
l
, 
Ãt
);

480 
	`add_bŸs
(
l
.
ouut
,†.
bŸ£s
,†.
b©ch
,†.
n
,†.
out_h
*l.
out_w
);

483 
	`aùiv©e_¬¿y
(
l
.
ouut
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
);

484 if(
l
.
bš¬y
 ||†.
xnÜ
è
	`sw­_bš¬y
(&l);

485 
	}
}

487 
	$backw¬d_cÚvŞutiÚ®_Ïy”
(
cÚvŞutiÚ®_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

489 
i
, 
j
;

490 
m
 = 
l
.
n
/l.
groups
;

491 
n
 = 
l
.
size
*l.size*l.
c
/l.
groups
;

492 
k
 = 
l
.
out_w
*l.
out_h
;

494 
	`g¿d›Á_¬¿y
(
l
.
ouut
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
,†.
d–
);

496 if(
l
.
b©ch_nÜm®ize
){

497 
	`backw¬d_b©chnÜm_Ïy”
(
l
, 
Ãt
);

499 
	`backw¬d_bŸs
(
l
.
bŸs_upd©es
,†.
d–
,†.
b©ch
,†.
n
, 
k
);

502 
i
 = 0; i < 
l
.
b©ch
; ++i){

503 
j
 = 0; j < 
l
.
groups
; ++j){

504 *
a
 = 
l
.
d–
 + (
i
*l.
groups
 + 
j
)*
m
*
k
;

505 *
b
 = 
Ãt
.
wÜk¥aû
;

506 *
c
 = 
l
.
weight_upd©es
 + 
j
*l.
nweights
/l.
groups
;

508 *
im
 = 
Ãt
.
šput
 + (
i
*
l
.
groups
 + 
j
)*l.
c
/l.groups*l.
h
*l.
w
;

509 *
imd
 = 
Ãt
.
d–
 + (
i
*
l
.
groups
 + 
j
)*l.
c
/l.groups*l.
h
*l.
w
;

511 if(
l
.
size
 == 1){

512 
b
 = 
im
;

514 
	`im2cŞ_ıu
(
im
, 
l
.
c
/l.
groups
,†.
h
,†.
w
,

515 
l
.
size
,†.
¡ride
,†.
·d
, 
b
);

518 
	`gemm
(0,1,
m
,
n
,
k
,1,
a
,k,
b
,k,1,
c
,n);

520 ià(
Ãt
.
d–
) {

521 
a
 = 
l
.
weights
 + 
j
*l.
nweights
/l.
groups
;

522 
b
 = 
l
.
d–
 + (
i
*l.
groups
 + 
j
)*
m
*
k
;

523 
c
 = 
Ãt
.
wÜk¥aû
;

524 ià(
l
.
size
 == 1) {

525 
c
 = 
imd
;

528 
	`gemm
(1,0,
n
,
k
,
m
,1,
a
,n,
b
,k,0,
c
,k);

530 ià(
l
.
size
 != 1) {

531 
	`cŞ2im_ıu
(
Ãt
.
wÜk¥aû
, 
l
.
c
/l.
groups
,†.
h
,†.
w
,†.
size
,†.
¡ride
,†.
·d
, 
imd
);

536 
	}
}

538 
	$upd©e_cÚvŞutiÚ®_Ïy”
(
cÚvŞutiÚ®_Ïy”
 
l
, 
upd©e_¬gs
 
a
)

540 
Ë¬nšg_¿‹
 = 
a
.Ë¬nšg_¿‹*
l
.
Ë¬nšg_¿‹_sÿË
;

541 
mom’tum
 = 
a
.momentum;

542 
deÿy
 = 
a
.decay;

543 
b©ch
 = 
a
.batch;

545 
	`axpy_ıu
(
l
.
n
, 
Ë¬nšg_¿‹
/
b©ch
,†.
bŸs_upd©es
, 1,†.
bŸ£s
, 1);

546 
	`sÿl_ıu
(
l
.
n
, 
mom’tum
,†.
bŸs_upd©es
, 1);

548 if(
l
.
sÿËs
){

549 
	`axpy_ıu
(
l
.
n
, 
Ë¬nšg_¿‹
/
b©ch
,†.
sÿË_upd©es
, 1,†.
sÿËs
, 1);

550 
	`sÿl_ıu
(
l
.
n
, 
mom’tum
,†.
sÿË_upd©es
, 1);

553 
	`axpy_ıu
(
l
.
nweights
, -
deÿy
*
b©ch
,†.
weights
, 1,†.
weight_upd©es
, 1);

554 
	`axpy_ıu
(
l
.
nweights
, 
Ë¬nšg_¿‹
/
b©ch
,†.
weight_upd©es
, 1,†.
weights
, 1);

555 
	`sÿl_ıu
(
l
.
nweights
, 
mom’tum
,†.
weight_upd©es
, 1);

556 
	}
}

559 
image
 
	$g‘_cÚvŞutiÚ®_weight
(
cÚvŞutiÚ®_Ïy”
 
l
, 
i
)

561 
h
 = 
l
.
size
;

562 
w
 = 
l
.
size
;

563 
c
 = 
l
.c/l.
groups
;

564  
	`æßt_to_image
(
w
,
h
,
c
,
l
.
weights
+
i
*h*w*c);

565 
	}
}

567 
	$rgbgr_weights
(
cÚvŞutiÚ®_Ïy”
 
l
)

569 
i
;

570 
i
 = 0; i < 
l
.
n
; ++i){

571 
image
 
im
 = 
	`g‘_cÚvŞutiÚ®_weight
(
l
, 
i
);

572 ià(
im
.
c
 == 3) {

573 
	`rgbgr_image
(
im
);

576 
	}
}

578 
	$»sÿË_weights
(
cÚvŞutiÚ®_Ïy”
 
l
, 
sÿË
, 
Œªs
)

580 
i
;

581 
i
 = 0; i < 
l
.
n
; ++i){

582 
image
 
im
 = 
	`g‘_cÚvŞutiÚ®_weight
(
l
, 
i
);

583 ià(
im
.
c
 == 3) {

584 
	`sÿË_image
(
im
, 
sÿË
);

585 
sum
 = 
	`sum_¬¿y
(
im
.
d©a
, im.
w
*im.
h
*im.
c
);

586 
l
.
bŸ£s
[
i
] +ğ
sum
*
Œªs
;

589 
	}
}

591 
image
 *
	$g‘_weights
(
cÚvŞutiÚ®_Ïy”
 
l
)

593 
image
 *
weights
 = 
	`ÿÎoc
(
l
.
n
, (image));

594 
i
;

595 
i
 = 0; i < 
l
.
n
; ++i){

596 
weights
[
i
] = 
	`cİy_image
(
	`g‘_cÚvŞutiÚ®_weight
(
l
, i));

597 
	`nÜm®ize_image
(
weights
[
i
]);

605  
weights
;

606 
	}
}

608 
image
 *
	$visu®ize_cÚvŞutiÚ®_Ïy”
(
cÚvŞutiÚ®_Ïy”
 
l
, *
wšdow
, 
image
 *
´ev_weights
)

610 
image
 *
sšgË_weights
 = 
	`g‘_weights
(
l
);

611 
	`show_images
(
sšgË_weights
, 
l
.
n
, 
wšdow
);

613 
image
 
d–
 = 
	`g‘_cÚvŞutiÚ®_image
(
l
);

614 
image
 
dc
 = 
	`cŞÏp£_image_Ïy”s
(
d–
, 1);

615 
buff
[256];

616 
	`¥rštf
(
buff
, "%s: Ouut", 
wšdow
);

619 
	`ä“_image
(
dc
);

620  
sšgË_weights
;

621 
	}
}

	@convolutional_layer.h

1 #iâdeà
CONVOLUTIONAL_LAYER_H


2 
	#CONVOLUTIONAL_LAYER_H


	)

4 
	~"cuda.h
"

5 
	~"image.h
"

6 
	~"aùiv©iÚs.h
"

7 
	~"Ïy”.h
"

8 
	~"ÃtwÜk.h
"

10 
Ïy”
 
	tcÚvŞutiÚ®_Ïy”
;

12 #ifdeà
GPU


13 
fÜw¬d_cÚvŞutiÚ®_Ïy”_gpu
(
cÚvŞutiÚ®_Ïy”
 
Ïy”
, 
ÃtwÜk
 
Ãt
);

14 
backw¬d_cÚvŞutiÚ®_Ïy”_gpu
(
cÚvŞutiÚ®_Ïy”
 
Ïy”
, 
ÃtwÜk
 
Ãt
);

15 
upd©e_cÚvŞutiÚ®_Ïy”_gpu
(
cÚvŞutiÚ®_Ïy”
 
Ïy”
, 
upd©e_¬gs
 
a
);

17 
push_cÚvŞutiÚ®_Ïy”
(
cÚvŞutiÚ®_Ïy”
 
Ïy”
);

18 
puÎ_cÚvŞutiÚ®_Ïy”
(
cÚvŞutiÚ®_Ïy”
 
Ïy”
);

20 
add_bŸs_gpu
(*
ouut
, *
bŸ£s
, 
b©ch
, 
n
, 
size
);

21 
backw¬d_bŸs_gpu
(*
bŸs_upd©es
, *
d–
, 
b©ch
, 
n
, 
size
);

22 
adam_upd©e_gpu
(*
w
, *
d
, *
m
, *
v
, 
B1
, 
B2
, 
•s
, 
deÿy
, 
¿‹
, 
n
, 
b©ch
, 
t
);

23 #ifdeà
CUDNN


24 
cudÂ_cÚvŞutiÚ®_£tup
(
Ïy”
 *
l
);

28 
cÚvŞutiÚ®_Ïy”
 
make_cÚvŞutiÚ®_Ïy”
(
b©ch
, 
h
, 
w
, 
c
, 
n
, 
groups
, 
size
, 
¡ride
, 
·ddšg
, 
ACTIVATION
 
aùiv©iÚ
, 
b©ch_nÜm®ize
, 
bš¬y
, 
xnÜ
, 
adam
);

29 
»size_cÚvŞutiÚ®_Ïy”
(
cÚvŞutiÚ®_Ïy”
 *
Ïy”
, 
w
, 
h
);

30 
fÜw¬d_cÚvŞutiÚ®_Ïy”
(cÚ¡ 
cÚvŞutiÚ®_Ïy”
 
Ïy”
, 
ÃtwÜk
 
Ãt
);

31 
upd©e_cÚvŞutiÚ®_Ïy”
(
cÚvŞutiÚ®_Ïy”
 
Ïy”
, 
upd©e_¬gs
 
a
);

32 
image
 *
visu®ize_cÚvŞutiÚ®_Ïy”
(
cÚvŞutiÚ®_Ïy”
 
Ïy”
, *
wšdow
, imag*
´ev_weights
);

33 
bš¬ize_weights
(*
weights
, 
n
, 
size
, *
bš¬y
);

34 
sw­_bš¬y
(
cÚvŞutiÚ®_Ïy”
 *
l
);

35 
bš¬ize_weights2
(*
weights
, 
n
, 
size
, *
bš¬y
, *
sÿËs
);

37 
backw¬d_cÚvŞutiÚ®_Ïy”
(
cÚvŞutiÚ®_Ïy”
 
Ïy”
, 
ÃtwÜk
 
Ãt
);

39 
add_bŸs
(*
ouut
, *
bŸ£s
, 
b©ch
, 
n
, 
size
);

40 
backw¬d_bŸs
(*
bŸs_upd©es
, *
d–
, 
b©ch
, 
n
, 
size
);

42 
image
 
g‘_cÚvŞutiÚ®_image
(
cÚvŞutiÚ®_Ïy”
 
Ïy”
);

43 
image
 
g‘_cÚvŞutiÚ®_d–
(
cÚvŞutiÚ®_Ïy”
 
Ïy”
);

44 
image
 
g‘_cÚvŞutiÚ®_weight
(
cÚvŞutiÚ®_Ïy”
 
Ïy”
, 
i
);

46 
cÚvŞutiÚ®_out_height
(
cÚvŞutiÚ®_Ïy”
 
Ïy”
);

47 
cÚvŞutiÚ®_out_width
(
cÚvŞutiÚ®_Ïy”
 
Ïy”
);

	@cost_layer.c

1 
	~"co¡_Ïy”.h
"

2 
	~"uts.h
"

3 
	~"cuda.h
"

4 
	~"bÏs.h
"

5 
	~<m©h.h
>

6 
	~<¡ršg.h
>

7 
	~<¡dlib.h
>

8 
	~<¡dio.h
>

10 
COST_TYPE
 
	$g‘_co¡_ty³
(*
s
)

12 ià(
	`¡rcmp
(
s
, "£g")==0è 
SEG
;

13 ià(
	`¡rcmp
(
s
, "s£")==0è 
SSE
;

14 ià(
	`¡rcmp
(
s
, "masked")==0è 
MASKED
;

15 ià(
	`¡rcmp
(
s
, "smoÙh")==0è 
SMOOTH
;

16 ià(
	`¡rcmp
(
s
, "L1")==0è 
L1
;

17 ià(
	`¡rcmp
(
s
, "wgª")==0è 
WGAN
;

18 
	`årštf
(
¡d”r
, "Couldn'ˆfšd co¡y³ %s, gošg w™h SSE\n", 
s
);

19  
SSE
;

20 
	}
}

22 *
	$g‘_co¡_¡ršg
(
COST_TYPE
 
a
)

24 
a
){

25 
SEG
:

27 
SSE
:

29 
MASKED
:

31 
SMOOTH
:

33 
L1
:

35 
WGAN
:

39 
	}
}

41 
co¡_Ïy”
 
	$make_co¡_Ïy”
(
b©ch
, 
šputs
, 
COST_TYPE
 
co¡_ty³
, 
sÿË
)

43 
	`årštf
(
¡d”r
, "co¡ %4d\n", 
šputs
);

44 
co¡_Ïy”
 
l
 = {0};

45 
l
.
ty³
 = 
COST
;

47 
l
.
sÿË
 = scale;

48 
l
.
b©ch
 = batch;

49 
l
.
šputs
 = inputs;

50 
l
.
ouuts
 = 
šputs
;

51 
l
.
co¡_ty³
 = cost_type;

52 
l
.
d–
 = 
	`ÿÎoc
(
šputs
*
b©ch
, ());

53 
l
.
ouut
 = 
	`ÿÎoc
(
šputs
*
b©ch
, ());

54 
l
.
co¡
 = 
	`ÿÎoc
(1, ());

56 
l
.
fÜw¬d
 = 
fÜw¬d_co¡_Ïy”
;

57 
l
.
backw¬d
 = 
backw¬d_co¡_Ïy”
;

58 #ifdeà
GPU


59 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_co¡_Ïy”_gpu
;

60 
l
.
backw¬d_gpu
 = 
backw¬d_co¡_Ïy”_gpu
;

62 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
, 
šputs
*
b©ch
);

63 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
, 
šputs
*
b©ch
);

65  
l
;

66 
	}
}

68 
	$»size_co¡_Ïy”
(
co¡_Ïy”
 *
l
, 
šputs
)

70 
l
->
šputs
 = inputs;

71 
l
->
ouuts
 = 
šputs
;

72 
l
->
d–
 = 
	`»®loc
Ö->d–, 
šputs
*l->
b©ch
*());

73 
l
->
ouut
 = 
	`»®loc
Ö->ouut, 
šputs
*l->
b©ch
*());

74 #ifdeà
GPU


75 
	`cuda_ä“
(
l
->
d–_gpu
);

76 
	`cuda_ä“
(
l
->
ouut_gpu
);

77 
l
->
d–_gpu
 = 
	`cuda_make_¬¿y
Ö->
d–
, 
šputs
*l->
b©ch
);

78 
l
->
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö->
ouut
, 
šputs
*l->
b©ch
);

80 
	}
}

82 
	$fÜw¬d_co¡_Ïy”
(
co¡_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

84 ià(!
Ãt
.
Œuth
) ;

85 if(
l
.
co¡_ty³
 =ğ
MASKED
){

86 
i
;

87 
i
 = 0; i < 
l
.
b©ch
*l.
šputs
; ++i){

88 if(
Ãt
.
Œuth
[
i
] =ğ
SECRET_NUM
èÃt.
šput
[i] = SECRET_NUM;

91 if(
l
.
co¡_ty³
 =ğ
SMOOTH
){

92 
	`smoÙh_l1_ıu
(
l
.
b©ch
*l.
šputs
, 
Ãt
.
šput
,‚‘.
Œuth
,†.
d–
,†.
ouut
);

93 }if(
l
.
co¡_ty³
 =ğ
L1
){

94 
	`l1_ıu
(
l
.
b©ch
*l.
šputs
, 
Ãt
.
šput
,‚‘.
Œuth
,†.
d–
,†.
ouut
);

96 
	`l2_ıu
(
l
.
b©ch
*l.
šputs
, 
Ãt
.
šput
,‚‘.
Œuth
,†.
d–
,†.
ouut
);

98 
l
.
co¡
[0] = 
	`sum_¬¿y
Ö.
ouut
,†.
b©ch
*l.
šputs
);

99 
	}
}

101 
	$backw¬d_co¡_Ïy”
(cÚ¡ 
co¡_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

103 
	`axpy_ıu
(
l
.
b©ch
*l.
šputs
,†.
sÿË
,†.
d–
, 1, 
Ãt
.delta, 1);

104 
	}
}

106 #ifdeà
GPU


108 
	$puÎ_co¡_Ïy”
(
co¡_Ïy”
 
l
)

110 
	`cuda_puÎ_¬¿y
(
l
.
d–_gpu
,†.
d–
,†.
b©ch
*l.
šputs
);

111 
	}
}

113 
	$push_co¡_Ïy”
(
co¡_Ïy”
 
l
)

115 
	`cuda_push_¬¿y
(
l
.
d–_gpu
,†.
d–
,†.
b©ch
*l.
šputs
);

116 
	}
}

118 
	$æßt_abs_com·»
 (cÚ¡ * 
a
, cÚ¡ * 
b
)

120 
ç
 = *(cÚ¡ *è
a
;

121 if(
ç
 < 0) fa = -fa;

122 
fb
 = *(cÚ¡ *è
b
;

123 if(
fb
 < 0) fb = -fb;

124  (
ç
 > 
fb
) - (fa < fb);

125 
	}
}

127 
	$fÜw¬d_co¡_Ïy”_gpu
(
co¡_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

129 ià(!
Ãt
.
Œuth
) ;

130 if(
l
.
smoÙh
){

131 
	`sÿl_gpu
(
l
.
b©ch
*l.
šputs
, (1-l.
smoÙh
), 
Ãt
.
Œuth_gpu
, 1);

132 
	`add_gpu
(
l
.
b©ch
*l.
šputs
,†.
smoÙh
 * 1./l.šputs, 
Ãt
.
Œuth_gpu
, 1);

135 if(
l
.
co¡_ty³
 =ğ
SMOOTH
){

136 
	`smoÙh_l1_gpu
(
l
.
b©ch
*l.
šputs
, 
Ãt
.
šput_gpu
,‚‘.
Œuth_gpu
,†.
d–_gpu
,†.
ouut_gpu
);

137 } ià(
l
.
co¡_ty³
 =ğ
L1
){

138 
	`l1_gpu
(
l
.
b©ch
*l.
šputs
, 
Ãt
.
šput_gpu
,‚‘.
Œuth_gpu
,†.
d–_gpu
,†.
ouut_gpu
);

139 } ià(
l
.
co¡_ty³
 =ğ
WGAN
){

140 
	`wgª_gpu
(
l
.
b©ch
*l.
šputs
, 
Ãt
.
šput_gpu
,‚‘.
Œuth_gpu
,†.
d–_gpu
,†.
ouut_gpu
);

142 
	`l2_gpu
(
l
.
b©ch
*l.
šputs
, 
Ãt
.
šput_gpu
,‚‘.
Œuth_gpu
,†.
d–_gpu
,†.
ouut_gpu
);

145 ià(
l
.
co¡_ty³
 =ğ
SEG
 &&†.
noobjeù_sÿË
 != 1) {

146 
	`sÿË_mask_gpu
(
l
.
b©ch
*l.
šputs
,†.
d–_gpu
, 0, 
Ãt
.
Œuth_gpu
,†.
noobjeù_sÿË
);

147 
	`sÿË_mask_gpu
(
l
.
b©ch
*l.
šputs
,†.
ouut_gpu
, 0, 
Ãt
.
Œuth_gpu
,†.
noobjeù_sÿË
);

149 ià(
l
.
co¡_ty³
 =ğ
MASKED
) {

150 
	`mask_gpu
(
l
.
b©ch
*l.
šputs
, 
Ãt
.
d–_gpu
, 
SECRET_NUM
,‚‘.
Œuth_gpu
, 0);

153 if(
l
.
¿tio
){

154 
	`cuda_puÎ_¬¿y
(
l
.
d–_gpu
,†.
d–
,†.
b©ch
*l.
šputs
);

155 
	`qsÜt
(
l
.
d–
,†.
b©ch
*l.
šputs
, (), 
æßt_abs_com·»
);

156 
n
 = (1-
l
.
¿tio
è*†.
b©ch
*l.
šputs
;

157 
th»sh
 = 
l
.
d–
[
n
];

158 
th»sh
 = 0;

159 
	`´štf
("%f\n", 
th»sh
);

160 
	`suµ_gpu
(
l
.
b©ch
*l.
šputs
, 
th»sh
,†.
d–_gpu
, 1);

163 if(
l
.
th»sh
){

164 
	`suµ_gpu
(
l
.
b©ch
*l.
šputs
,†.
th»sh
*1./l.šputs,†.
d–_gpu
, 1);

167 
	`cuda_puÎ_¬¿y
(
l
.
ouut_gpu
,†.
ouut
,†.
b©ch
*l.
šputs
);

168 
l
.
co¡
[0] = 
	`sum_¬¿y
Ö.
ouut
,†.
b©ch
*l.
šputs
);

169 
	}
}

171 
	$backw¬d_co¡_Ïy”_gpu
(cÚ¡ 
co¡_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

173 
	`axpy_gpu
(
l
.
b©ch
*l.
šputs
,†.
sÿË
,†.
d–_gpu
, 1, 
Ãt
.delta_gpu, 1);

174 
	}
}

	@cost_layer.h

1 #iâdeà
COST_LAYER_H


2 
	#COST_LAYER_H


	)

3 
	~"Ïy”.h
"

4 
	~"ÃtwÜk.h
"

6 
Ïy”
 
	tco¡_Ïy”
;

8 
COST_TYPE
 
g‘_co¡_ty³
(*
s
);

9 *
g‘_co¡_¡ršg
(
COST_TYPE
 
a
);

10 
co¡_Ïy”
 
make_co¡_Ïy”
(
b©ch
, 
šputs
, 
COST_TYPE
 
ty³
, 
sÿË
);

11 
fÜw¬d_co¡_Ïy”
(cÚ¡ 
co¡_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

12 
backw¬d_co¡_Ïy”
(cÚ¡ 
co¡_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

13 
»size_co¡_Ïy”
(
co¡_Ïy”
 *
l
, 
šputs
);

15 #ifdeà
GPU


16 
fÜw¬d_co¡_Ïy”_gpu
(
co¡_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

17 
backw¬d_co¡_Ïy”_gpu
(cÚ¡ 
co¡_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

	@crnn_layer.c

1 
	~"üÂ_Ïy”.h
"

2 
	~"cÚvŞutiÚ®_Ïy”.h
"

3 
	~"uts.h
"

4 
	~"cuda.h
"

5 
	~"bÏs.h
"

6 
	~"gemm.h
"

8 
	~<m©h.h
>

9 
	~<¡dio.h
>

10 
	~<¡dlib.h
>

11 
	~<¡ršg.h
>

13 
	$šüem’t_Ïy”
(
Ïy”
 *
l
, 
¡•s
)

15 
num
 = 
l
->
ouuts
*l->
b©ch
*
¡•s
;

16 
l
->
ouut
 +ğ
num
;

17 
l
->
d–
 +ğ
num
;

18 
l
->
x
 +ğ
num
;

19 
l
->
x_nÜm
 +ğ
num
;

21 #ifdeà
GPU


22 
l
->
ouut_gpu
 +ğ
num
;

23 
l
->
d–_gpu
 +ğ
num
;

24 
l
->
x_gpu
 +ğ
num
;

25 
l
->
x_nÜm_gpu
 +ğ
num
;

27 
	}
}

29 
Ïy”
 
	$make_üÂ_Ïy”
(
b©ch
, 
h
, 
w
, 
c
, 
hidd’_f‹rs
, 
ouut_f‹rs
, 
¡•s
, 
ACTIVATION
 
aùiv©iÚ
, 
b©ch_nÜm®ize
)

31 
	`årštf
(
¡d”r
, "CRNN Lay”: %d x %d x %d image, %d f‹rs\n", 
h
,
w
,
c
,
ouut_f‹rs
);

32 
b©ch
 = b©ch / 
¡•s
;

33 
Ïy”
 
l
 = {0};

34 
l
.
b©ch
 = batch;

35 
l
.
ty³
 = 
CRNN
;

36 
l
.
¡•s
 = steps;

37 
l
.
h
 = h;

38 
l
.
w
 = w;

39 
l
.
c
 = c;

40 
l
.
out_h
 = 
h
;

41 
l
.
out_w
 = 
w
;

42 
l
.
out_c
 = 
ouut_f‹rs
;

43 
l
.
šputs
 = 
h
*
w
*
c
;

44 
l
.
hidd’
 = 
h
 * 
w
 * 
hidd’_f‹rs
;

45 
l
.
ouuts
 =†.
out_h
 *†.
out_w
 *†.
out_c
;

47 
l
.
¡©e
 = 
	`ÿÎoc
Ö.
hidd’
*
b©ch
*(
¡•s
+1), ());

49 
l
.
šput_Ïy”
 = 
	`m®loc
((
Ïy”
));

50 
	`årštf
(
¡d”r
, "\t\t");

51 *(
l
.
šput_Ïy”
èğ
	`make_cÚvŞutiÚ®_Ïy”
(
b©ch
*
¡•s
, 
h
, 
w
, 
c
, 
hidd’_f‹rs
, 1, 3, 1, 1, 
aùiv©iÚ
, 
b©ch_nÜm®ize
, 0, 0, 0);

52 
l
.
šput_Ïy”
->
b©ch
 = batch;

54 
l
.
£lf_Ïy”
 = 
	`m®loc
((
Ïy”
));

55 
	`årštf
(
¡d”r
, "\t\t");

56 *(
l
.
£lf_Ïy”
èğ
	`make_cÚvŞutiÚ®_Ïy”
(
b©ch
*
¡•s
, 
h
, 
w
, 
hidd’_f‹rs
, hidd’_f‹rs, 1, 3, 1, 1, 
aùiv©iÚ
, 
b©ch_nÜm®ize
, 0, 0, 0);

57 
l
.
£lf_Ïy”
->
b©ch
 = batch;

59 
l
.
ouut_Ïy”
 = 
	`m®loc
((
Ïy”
));

60 
	`årštf
(
¡d”r
, "\t\t");

61 *(
l
.
ouut_Ïy”
èğ
	`make_cÚvŞutiÚ®_Ïy”
(
b©ch
*
¡•s
, 
h
, 
w
, 
hidd’_f‹rs
, 
ouut_f‹rs
, 1, 3, 1, 1, 
aùiv©iÚ
, 
b©ch_nÜm®ize
, 0, 0, 0);

62 
l
.
ouut_Ïy”
->
b©ch
 = batch;

64 
l
.
ouut
 =†.
ouut_Ïy”
->output;

65 
l
.
d–
 =†.
ouut_Ïy”
->delta;

67 
l
.
fÜw¬d
 = 
fÜw¬d_üÂ_Ïy”
;

68 
l
.
backw¬d
 = 
backw¬d_üÂ_Ïy”
;

69 
l
.
upd©e
 = 
upd©e_üÂ_Ïy”
;

71 #ifdeà
GPU


72 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_üÂ_Ïy”_gpu
;

73 
l
.
backw¬d_gpu
 = 
backw¬d_üÂ_Ïy”_gpu
;

74 
l
.
upd©e_gpu
 = 
upd©e_üÂ_Ïy”_gpu
;

76 
l
.
¡©e_gpu
 = 
	`cuda_make_¬¿y
Ö.
¡©e
,†.
hidd’
*
b©ch
*(
¡•s
+1));

77 
l
.
ouut_gpu
 =†.
ouut_Ïy”
->output_gpu;

78 
l
.
d–_gpu
 =†.
ouut_Ïy”
->delta_gpu;

81  
l
;

82 
	}
}

84 
	$upd©e_üÂ_Ïy”
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
)

86 
	`upd©e_cÚvŞutiÚ®_Ïy”
(*(
l
.
šput_Ïy”
), 
a
);

87 
	`upd©e_cÚvŞutiÚ®_Ïy”
(*(
l
.
£lf_Ïy”
), 
a
);

88 
	`upd©e_cÚvŞutiÚ®_Ïy”
(*(
l
.
ouut_Ïy”
), 
a
);

89 
	}
}

91 
	$fÜw¬d_üÂ_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

93 
ÃtwÜk
 
s
 = 
Ãt
;

94 
s
.
Œaš
 = 
Ãt
.train;

95 
i
;

96 
Ïy”
 
šput_Ïy”
 = *(
l
.input_layer);

97 
Ïy”
 
£lf_Ïy”
 = *(
l
.self_layer);

98 
Ïy”
 
ouut_Ïy”
 = *(
l
.output_layer);

100 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
ouut_Ïy”
.
d–
, 1);

101 
	`fl_ıu
(
l
.
hidd’
 *†.
b©ch
 *†.
¡•s
, 0, 
£lf_Ïy”
.
d–
, 1);

102 
	`fl_ıu
(
l
.
hidd’
 *†.
b©ch
 *†.
¡•s
, 0, 
šput_Ïy”
.
d–
, 1);

103 if(
Ãt
.
Œaš
è
	`fl_ıu
(
l
.
hidd’
 *†.
b©ch
, 0,†.
¡©e
, 1);

105 
i
 = 0; i < 
l
.
¡•s
; ++i) {

106 
s
.
šput
 = 
Ãt
.input;

107 
	`fÜw¬d_cÚvŞutiÚ®_Ïy”
(
šput_Ïy”
, 
s
);

109 
s
.
šput
 = 
l
.
¡©e
;

110 
	`fÜw¬d_cÚvŞutiÚ®_Ïy”
(
£lf_Ïy”
, 
s
);

112 *
Şd_¡©e
 = 
l
.
¡©e
;

113 if(
Ãt
.
Œaš
è
l
.
¡©e
 +ğl.
hidd’
*l.
b©ch
;

114 if(
l
.
shÜtcut
){

115 
	`cİy_ıu
(
l
.
hidd’
 *†.
b©ch
, 
Şd_¡©e
, 1,†.
¡©e
, 1);

117 
	`fl_ıu
(
l
.
hidd’
 *†.
b©ch
, 0,†.
¡©e
, 1);

119 
	`axpy_ıu
(
l
.
hidd’
 *†.
b©ch
, 1, 
šput_Ïy”
.
ouut
, 1,†.
¡©e
, 1);

120 
	`axpy_ıu
(
l
.
hidd’
 *†.
b©ch
, 1, 
£lf_Ïy”
.
ouut
, 1,†.
¡©e
, 1);

122 
s
.
šput
 = 
l
.
¡©e
;

123 
	`fÜw¬d_cÚvŞutiÚ®_Ïy”
(
ouut_Ïy”
, 
s
);

125 
Ãt
.
šput
 +ğ
l
.
šputs
*l.
b©ch
;

126 
	`šüem’t_Ïy”
(&
šput_Ïy”
, 1);

127 
	`šüem’t_Ïy”
(&
£lf_Ïy”
, 1);

128 
	`šüem’t_Ïy”
(&
ouut_Ïy”
, 1);

130 
	}
}

132 
	$backw¬d_üÂ_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

134 
ÃtwÜk
 
s
 = 
Ãt
;

135 
i
;

136 
Ïy”
 
šput_Ïy”
 = *(
l
.input_layer);

137 
Ïy”
 
£lf_Ïy”
 = *(
l
.self_layer);

138 
Ïy”
 
ouut_Ïy”
 = *(
l
.output_layer);

140 
	`šüem’t_Ïy”
(&
šput_Ïy”
, 
l
.
¡•s
-1);

141 
	`šüem’t_Ïy”
(&
£lf_Ïy”
, 
l
.
¡•s
-1);

142 
	`šüem’t_Ïy”
(&
ouut_Ïy”
, 
l
.
¡•s
-1);

144 
l
.
¡©e
 +ğl.
hidd’
*l.
b©ch
*l.
¡•s
;

145 
i
 = 
l
.
¡•s
-1; i >= 0; --i) {

146 
	`cİy_ıu
(
l
.
hidd’
 *†.
b©ch
, 
šput_Ïy”
.
ouut
, 1,†.
¡©e
, 1);

147 
	`axpy_ıu
(
l
.
hidd’
 *†.
b©ch
, 1, 
£lf_Ïy”
.
ouut
, 1,†.
¡©e
, 1);

149 
s
.
šput
 = 
l
.
¡©e
;

150 
s
.
d–
 = 
£lf_Ïy”
.delta;

151 
	`backw¬d_cÚvŞutiÚ®_Ïy”
(
ouut_Ïy”
, 
s
);

153 
l
.
¡©e
 -ğl.
hidd’
*l.
b©ch
;

163 
s
.
šput
 = 
l
.
¡©e
;

164 
s
.
d–
 = 
£lf_Ïy”
.d– - 
l
.
hidd’
*l.
b©ch
;

165 ià(
i
 =ğ0è
s
.
d–
 = 0;

166 
	`backw¬d_cÚvŞutiÚ®_Ïy”
(
£lf_Ïy”
, 
s
);

168 
	`cİy_ıu
(
l
.
hidd’
*l.
b©ch
, 
£lf_Ïy”
.
d–
, 1, 
šput_Ïy”
.delta, 1);

169 ià(
i
 > 0 && 
l
.
shÜtcut
è
	`axpy_ıu
Ö.
hidd’
*l.
b©ch
, 1, 
£lf_Ïy”
.
d–
, 1, self_layer.delta -†.hidden*l.batch, 1);

170 
s
.
šput
 = 
Ãt
.špuˆ+ 
i
*
l
.
šputs
*l.
b©ch
;

171 if(
Ãt
.
d–
è
s
.d– =‚‘.d– + 
i
*
l
.
šputs
*l.
b©ch
;

172 
s
.
d–
 = 0;

173 
	`backw¬d_cÚvŞutiÚ®_Ïy”
(
šput_Ïy”
, 
s
);

175 
	`šüem’t_Ïy”
(&
šput_Ïy”
, -1);

176 
	`šüem’t_Ïy”
(&
£lf_Ïy”
, -1);

177 
	`šüem’t_Ïy”
(&
ouut_Ïy”
, -1);

179 
	}
}

181 #ifdeà
GPU


183 
	$puÎ_üÂ_Ïy”
(
Ïy”
 
l
)

185 
	`puÎ_cÚvŞutiÚ®_Ïy”
(*(
l
.
šput_Ïy”
));

186 
	`puÎ_cÚvŞutiÚ®_Ïy”
(*(
l
.
£lf_Ïy”
));

187 
	`puÎ_cÚvŞutiÚ®_Ïy”
(*(
l
.
ouut_Ïy”
));

188 
	}
}

190 
	$push_üÂ_Ïy”
(
Ïy”
 
l
)

192 
	`push_cÚvŞutiÚ®_Ïy”
(*(
l
.
šput_Ïy”
));

193 
	`push_cÚvŞutiÚ®_Ïy”
(*(
l
.
£lf_Ïy”
));

194 
	`push_cÚvŞutiÚ®_Ïy”
(*(
l
.
ouut_Ïy”
));

195 
	}
}

197 
	$upd©e_üÂ_Ïy”_gpu
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
)

199 
	`upd©e_cÚvŞutiÚ®_Ïy”_gpu
(*(
l
.
šput_Ïy”
), 
a
);

200 
	`upd©e_cÚvŞutiÚ®_Ïy”_gpu
(*(
l
.
£lf_Ïy”
), 
a
);

201 
	`upd©e_cÚvŞutiÚ®_Ïy”_gpu
(*(
l
.
ouut_Ïy”
), 
a
);

202 
	}
}

204 
	$fÜw¬d_üÂ_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

206 
ÃtwÜk
 
s
 = 
Ãt
;

207 
i
;

208 
Ïy”
 
šput_Ïy”
 = *(
l
.input_layer);

209 
Ïy”
 
£lf_Ïy”
 = *(
l
.self_layer);

210 
Ïy”
 
ouut_Ïy”
 = *(
l
.output_layer);

212 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
ouut_Ïy”
.
d–_gpu
, 1);

213 
	`fl_gpu
(
l
.
hidd’
 *†.
b©ch
 *†.
¡•s
, 0, 
£lf_Ïy”
.
d–_gpu
, 1);

214 
	`fl_gpu
(
l
.
hidd’
 *†.
b©ch
 *†.
¡•s
, 0, 
šput_Ïy”
.
d–_gpu
, 1);

215 if(
Ãt
.
Œaš
è
	`fl_gpu
(
l
.
hidd’
 *†.
b©ch
, 0,†.
¡©e_gpu
, 1);

217 
i
 = 0; i < 
l
.
¡•s
; ++i) {

218 
s
.
šput_gpu
 = 
Ãt
.input_gpu;

219 
	`fÜw¬d_cÚvŞutiÚ®_Ïy”_gpu
(
šput_Ïy”
, 
s
);

221 
s
.
šput_gpu
 = 
l
.
¡©e_gpu
;

222 
	`fÜw¬d_cÚvŞutiÚ®_Ïy”_gpu
(
£lf_Ïy”
, 
s
);

224 *
Şd_¡©e
 = 
l
.
¡©e_gpu
;

225 if(
Ãt
.
Œaš
è
l
.
¡©e_gpu
 +ğl.
hidd’
*l.
b©ch
;

226 if(
l
.
shÜtcut
){

227 
	`cİy_gpu
(
l
.
hidd’
 *†.
b©ch
, 
Şd_¡©e
, 1,†.
¡©e_gpu
, 1);

229 
	`fl_gpu
(
l
.
hidd’
 *†.
b©ch
, 0,†.
¡©e_gpu
, 1);

231 
	`axpy_gpu
(
l
.
hidd’
 *†.
b©ch
, 1, 
šput_Ïy”
.
ouut_gpu
, 1,†.
¡©e_gpu
, 1);

232 
	`axpy_gpu
(
l
.
hidd’
 *†.
b©ch
, 1, 
£lf_Ïy”
.
ouut_gpu
, 1,†.
¡©e_gpu
, 1);

234 
s
.
šput_gpu
 = 
l
.
¡©e_gpu
;

235 
	`fÜw¬d_cÚvŞutiÚ®_Ïy”_gpu
(
ouut_Ïy”
, 
s
);

237 
Ãt
.
šput_gpu
 +ğ
l
.
šputs
*l.
b©ch
;

238 
	`šüem’t_Ïy”
(&
šput_Ïy”
, 1);

239 
	`šüem’t_Ïy”
(&
£lf_Ïy”
, 1);

240 
	`šüem’t_Ïy”
(&
ouut_Ïy”
, 1);

242 
	}
}

244 
	$backw¬d_üÂ_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

246 
ÃtwÜk
 
s
 = 
Ãt
;

247 
s
.
Œaš
 = 
Ãt
.train;

248 
i
;

249 
Ïy”
 
šput_Ïy”
 = *(
l
.input_layer);

250 
Ïy”
 
£lf_Ïy”
 = *(
l
.self_layer);

251 
Ïy”
 
ouut_Ïy”
 = *(
l
.output_layer);

252 
	`šüem’t_Ïy”
(&
šput_Ïy”
, 
l
.
¡•s
 - 1);

253 
	`šüem’t_Ïy”
(&
£lf_Ïy”
, 
l
.
¡•s
 - 1);

254 
	`šüem’t_Ïy”
(&
ouut_Ïy”
, 
l
.
¡•s
 - 1);

255 
l
.
¡©e_gpu
 +ğl.
hidd’
*l.
b©ch
*l.
¡•s
;

256 
i
 = 
l
.
¡•s
-1; i >= 0; --i) {

257 
	`cİy_gpu
(
l
.
hidd’
 *†.
b©ch
, 
šput_Ïy”
.
ouut_gpu
, 1,†.
¡©e_gpu
, 1);

258 
	`axpy_gpu
(
l
.
hidd’
 *†.
b©ch
, 1, 
£lf_Ïy”
.
ouut_gpu
, 1,†.
¡©e_gpu
, 1);

260 
s
.
šput_gpu
 = 
l
.
¡©e_gpu
;

261 
s
.
d–_gpu
 = 
£lf_Ïy”
.delta_gpu;

262 
	`backw¬d_cÚvŞutiÚ®_Ïy”_gpu
(
ouut_Ïy”
, 
s
);

264 
l
.
¡©e_gpu
 -ğl.
hidd’
*l.
b©ch
;

266 
s
.
šput_gpu
 = 
l
.
¡©e_gpu
;

267 
s
.
d–_gpu
 = 
£lf_Ïy”
.d–_gpu - 
l
.
hidd’
*l.
b©ch
;

268 ià(
i
 =ğ0è
s
.
d–_gpu
 = 0;

269 
	`backw¬d_cÚvŞutiÚ®_Ïy”_gpu
(
£lf_Ïy”
, 
s
);

271 
	`cİy_gpu
(
l
.
hidd’
*l.
b©ch
, 
£lf_Ïy”
.
d–_gpu
, 1, 
šput_Ïy”
.delta_gpu, 1);

272 ià(
i
 > 0 && 
l
.
shÜtcut
è
	`axpy_gpu
Ö.
hidd’
*l.
b©ch
, 1, 
£lf_Ïy”
.
d–_gpu
, 1, self_layer.delta_gpu -†.hidden*l.batch, 1);

273 
s
.
šput_gpu
 = 
Ãt
.šput_gpu + 
i
*
l
.
šputs
*l.
b©ch
;

274 if(
Ãt
.
d–_gpu
è
s
.d–_gpu =‚‘.d–_gpu + 
i
*
l
.
šputs
*l.
b©ch
;

275 
s
.
d–_gpu
 = 0;

276 
	`backw¬d_cÚvŞutiÚ®_Ïy”_gpu
(
šput_Ïy”
, 
s
);

278 
	`šüem’t_Ïy”
(&
šput_Ïy”
, -1);

279 
	`šüem’t_Ïy”
(&
£lf_Ïy”
, -1);

280 
	`šüem’t_Ïy”
(&
ouut_Ïy”
, -1);

282 
	}
}

	@crnn_layer.h

2 #iâdeà
CRNN_LAYER_H


3 
	#CRNN_LAYER_H


	)

5 
	~"aùiv©iÚs.h
"

6 
	~"Ïy”.h
"

7 
	~"ÃtwÜk.h
"

9 
Ïy”
 
make_üÂ_Ïy”
(
b©ch
, 
h
, 
w
, 
c
, 
hidd’_f‹rs
, 
ouut_f‹rs
, 
¡•s
, 
ACTIVATION
 
aùiv©iÚ
, 
b©ch_nÜm®ize
);

11 
fÜw¬d_üÂ_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

12 
backw¬d_üÂ_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

13 
upd©e_üÂ_Ïy”
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
);

15 #ifdeà
GPU


16 
fÜw¬d_üÂ_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

17 
backw¬d_üÂ_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

18 
upd©e_üÂ_Ïy”_gpu
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
);

19 
push_üÂ_Ïy”
(
Ïy”
 
l
);

20 
puÎ_üÂ_Ïy”
(
Ïy”
 
l
);

	@crop_layer.c

1 
	~"üİ_Ïy”.h
"

2 
	~"cuda.h
"

3 
	~<¡dio.h
>

5 
image
 
	$g‘_üİ_image
(
üİ_Ïy”
 
l
)

7 
h
 = 
l
.
out_h
;

8 
w
 = 
l
.
out_w
;

9 
c
 = 
l
.
out_c
;

10  
	`æßt_to_image
(
w
,
h
,
c
,
l
.
ouut
);

11 
	}
}

13 
	$backw¬d_üİ_Ïy”
(cÚ¡ 
üİ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
){
	}
}

14 
	$backw¬d_üİ_Ïy”_gpu
(cÚ¡ 
üİ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
){
	}
}

16 
üİ_Ïy”
 
	$make_üİ_Ïy”
(
b©ch
, 
h
, 
w
, 
c
, 
üİ_height
, 
üİ_width
, 
æ
, 
ªgË
, 
§tu¿tiÚ
, 
exposu»
)

18 
	`årštf
(
¡d”r
, "Crİ Lay”: %d x %d -> %d x %d x %d image\n", 
h
,
w
,
üİ_height
,
üİ_width
,
c
);

19 
üİ_Ïy”
 
l
 = {0};

20 
l
.
ty³
 = 
CROP
;

21 
l
.
b©ch
 = batch;

22 
l
.
h
 = h;

23 
l
.
w
 = w;

24 
l
.
c
 = c;

25 
l
.
sÿË
 = ()
üİ_height
 / 
h
;

26 
l
.
æ
 = flip;

27 
l
.
ªgË
 =‡ngle;

28 
l
.
§tu¿tiÚ
 = saturation;

29 
l
.
exposu»
 =ƒxposure;

30 
l
.
out_w
 = 
üİ_width
;

31 
l
.
out_h
 = 
üİ_height
;

32 
l
.
out_c
 = 
c
;

33 
l
.
šputs
 =†.
w
 *†.
h
 *†.
c
;

34 
l
.
ouuts
 =†.
out_w
 *†.
out_h
 *†.
out_c
;

35 
l
.
ouut
 = 
	`ÿÎoc
Ö.
ouuts
*
b©ch
, ());

36 
l
.
fÜw¬d
 = 
fÜw¬d_üİ_Ïy”
;

37 
l
.
backw¬d
 = 
backw¬d_üİ_Ïy”
;

39 #ifdeà
GPU


40 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_üİ_Ïy”_gpu
;

41 
l
.
backw¬d_gpu
 = 
backw¬d_üİ_Ïy”_gpu
;

42 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
,†.
ouuts
*
b©ch
);

43 
l
.
¿nd_gpu
 = 
	`cuda_make_¬¿y
(0,†.
b©ch
*8);

45  
l
;

46 
	}
}

48 
	$»size_üİ_Ïy”
(
Ïy”
 *
l
, 
w
, 
h
)

50 
l
->
w
 = w;

51 
l
->
h
 = h;

53 
l
->
out_w
 =†->
sÿË
*
w
;

54 
l
->
out_h
 =†->
sÿË
*
h
;

56 
l
->
šputs
 =†->
w
 *†->
h
 *†->
c
;

57 
l
->
ouuts
 =†->
out_h
 *†->
out_w
 *†->
out_c
;

59 
l
->
ouut
 = 
	`»®loc
Ö->ouut,†->
b©ch
*l->
ouuts
*());

60 #ifdeà
GPU


61 
	`cuda_ä“
(
l
->
ouut_gpu
);

62 
l
->
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö->
ouut
,†->
ouuts
*l->
b©ch
);

64 
	}
}

67 
	$fÜw¬d_üİ_Ïy”
(cÚ¡ 
üİ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

69 
i
,
j
,
c
,
b
,
row
,
cŞ
;

70 
šdex
;

71 
couÁ
 = 0;

72 
æ
 = (
l
.æ && 
	`¿nd
()%2);

73 
dh
 = 
	`¿nd
()%(
l
.
h
 -†.
out_h
 + 1);

74 
dw
 = 
	`¿nd
()%(
l
.
w
 -†.
out_w
 + 1);

75 
sÿË
 = 2;

76 
Œªs
 = -1;

77 if(
l
.
nßdju¡
){

78 
sÿË
 = 1;

79 
Œªs
 = 0;

81 if(!
Ãt
.
Œaš
){

82 
æ
 = 0;

83 
dh
 = (
l
.
h
 -†.
out_h
)/2;

84 
dw
 = (
l
.
w
 -†.
out_w
)/2;

86 
b
 = 0; b < 
l
.
b©ch
; ++b){

87 
c
 = 0; c < 
l
.c; ++c){

88 
i
 = 0; i < 
l
.
out_h
; ++i){

89 
j
 = 0; j < 
l
.
out_w
; ++j){

90 if(
æ
){

91 
cŞ
 = 
l
.
w
 - 
dw
 - 
j
 - 1;

93 
cŞ
 = 
j
 + 
dw
;

95 
row
 = 
i
 + 
dh
;

96 
šdex
 = 
cŞ
+
l
.
w
*(
row
+l.
h
*(
c
 +†.c*
b
));

97 
l
.
ouut
[
couÁ
++] = 
Ãt
.
šput
[
šdex
]*
sÿË
 + 
Œªs
;

102 
	}
}

	@crop_layer.h

1 #iâdeà
CROP_LAYER_H


2 
	#CROP_LAYER_H


	)

4 
	~"image.h
"

5 
	~"Ïy”.h
"

6 
	~"ÃtwÜk.h
"

8 
Ïy”
 
	tüİ_Ïy”
;

10 
image
 
g‘_üİ_image
(
üİ_Ïy”
 
l
);

11 
üİ_Ïy”
 
make_üİ_Ïy”
(
b©ch
, 
h
, 
w
, 
c
, 
üİ_height
, 
üİ_width
, 
æ
, 
ªgË
, 
§tu¿tiÚ
, 
exposu»
);

12 
fÜw¬d_üİ_Ïy”
(cÚ¡ 
üİ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

13 
»size_üİ_Ïy”
(
Ïy”
 *
l
, 
w
, 
h
);

15 #ifdeà
GPU


16 
fÜw¬d_üİ_Ïy”_gpu
(
üİ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

	@cuda.c

1 
	ggpu_šdex
 = 0;

3 #ifdeà
GPU


5 
	~"cuda.h
"

6 
	~"uts.h
"

7 
	~"bÏs.h
"

8 
	~<as£¹.h
>

9 
	~<¡dlib.h
>

10 
	~<time.h
>

12 
	$cuda_£t_deviû
(
n
)

14 
gpu_šdex
 = 
n
;

15 
cudaE¼Ü_t
 
¡©us
 = 
	`cudaS‘Deviû
(
n
);

16 
	`check_”rÜ
(
¡©us
);

17 
	}
}

19 
	$cuda_g‘_deviû
()

21 
n
 = 0;

22 
cudaE¼Ü_t
 
¡©us
 = 
	`cudaG‘Deviû
(&
n
);

23 
	`check_”rÜ
(
¡©us
);

24  
n
;

25 
	}
}

27 
	$check_”rÜ
(
cudaE¼Ü_t
 
¡©us
)

30 
cudaE¼Ü_t
 
¡©us2
 = 
	`cudaG‘La¡E¼Ü
();

31 ià(
¡©us
 !ğ
cudaSucûss
)

33 cÚ¡ *
s
 = 
	`cudaG‘E¼ÜSŒšg
(
¡©us
);

34 
bufãr
[256];

35 
	`´štf
("CUDA E¼Ü: %s\n", 
s
);

36 
	`as£¹
(0);

37 
	`¢´štf
(
bufãr
, 256, "CUDA E¼Ü: %s", 
s
);

38 
	`”rÜ
(
bufãr
);

40 ià(
¡©us2
 !ğ
cudaSucûss
)

42 cÚ¡ *
s
 = 
	`cudaG‘E¼ÜSŒšg
(
¡©us
);

43 
bufãr
[256];

44 
	`´štf
("CUDA E¼Ü P»v: %s\n", 
s
);

45 
	`as£¹
(0);

46 
	`¢´štf
(
bufãr
, 256, "CUDA E¼Ü P»v: %s", 
s
);

47 
	`”rÜ
(
bufãr
);

49 
	}
}

51 
dim3
 
	$cuda_gridsize
(
size_t
 
n
){

52 
size_t
 
k
 = (
n
-1è/ 
BLOCK
 + 1;

53 
size_t
 
x
 = 
k
;

54 
size_t
 
y
 = 1;

55 if(
x
 > 65535){

56 
x
 = 
	`û
(
	`sq¹
(
k
));

57 
y
 = (
n
-1)/(
x
*
BLOCK
) + 1;

59 
dim3
 
d
 = {
x
, 
y
, 1};

61  
d
;

62 
	}
}

64 #ifdeà
CUDNN


65 
cudÂHªdË_t
 
	$cudÂ_hªdË
()

67 
š™
[16] = {0};

68 
cudÂHªdË_t
 
hªdË
[16];

69 
i
 = 
	`cuda_g‘_deviû
();

70 if(!
š™
[
i
]) {

71 
	`cudÂC»©e
(&
hªdË
[
i
]);

72 
š™
[
i
] = 1;

74  
hªdË
[
i
];

75 
	}
}

78 
cubÏsHªdË_t
 
	$bÏs_hªdË
()

80 
š™
[16] = {0};

81 
cubÏsHªdË_t
 
hªdË
[16];

82 
i
 = 
	`cuda_g‘_deviû
();

83 if(!
š™
[
i
]) {

84 
	`cubÏsC»©e
(&
hªdË
[
i
]);

85 
š™
[
i
] = 1;

87  
hªdË
[
i
];

88 
	}
}

90 *
	$cuda_make_¬¿y
(*
x
, 
size_t
 
n
)

92 *
x_gpu
;

93 
size_t
 
size
 = ()*
n
;

94 
cudaE¼Ü_t
 
¡©us
 = 
	`cudaM®loc
((**)&
x_gpu
, 
size
);

95 
	`check_”rÜ
(
¡©us
);

96 if(
x
){

97 
¡©us
 = 
	`cudaMemıy
(
x_gpu
, 
x
, 
size
, 
cudaMemıyHo¡ToDeviû
);

98 
	`check_”rÜ
(
¡©us
);

100 
	`fl_gpu
(
n
, 0, 
x_gpu
, 1);

102 if(!
x_gpu
è
	`”rÜ
("Cuda malloc failed\n");

103  
x_gpu
;

104 
	}
}

106 
	$cuda_¿ndom
(*
x_gpu
, 
size_t
 
n
)

108 
cu¿ndG’”©Ü_t
 
g’
[16];

109 
š™
[16] = {0};

110 
i
 = 
	`cuda_g‘_deviû
();

111 if(!
š™
[
i
]){

112 
	`cu¿ndC»©eG’”©Ü
(&
g’
[
i
], 
CURAND_RNG_PSEUDO_DEFAULT
);

113 
	`cu¿ndS‘P£udoRªdomG’”©ÜS“d
(
g’
[
i
], 
	`time
(0));

114 
š™
[
i
] = 1;

116 
	`cu¿ndG’”©eUnifÜm
(
g’
[
i
], 
x_gpu
, 
n
);

117 
	`check_”rÜ
(
	`cudaP“kAtLa¡E¼Ü
());

118 
	}
}

120 
	$cuda_com·»
(*
x_gpu
, *
x
, 
size_t
 
n
, *
s
)

122 *
tmp
 = 
	`ÿÎoc
(
n
, ());

123 
	`cuda_puÎ_¬¿y
(
x_gpu
, 
tmp
, 
n
);

126 
	`axpy_ıu
(
n
, -1, 
x
, 1, 
tmp
, 1);

127 
”r
 = 
	`dÙ_ıu
(
n
, 
tmp
, 1,mp, 1);

128 
	`´štf
("E¼Ü %s: %f\n", 
s
, 
	`sq¹
(
”r
/
n
));

129 
	`ä“
(
tmp
);

130  
”r
;

131 
	}
}

133 *
	$cuda_make_št_¬¿y
(*
x
, 
size_t
 
n
)

135 *
x_gpu
;

136 
size_t
 
size
 = ()*
n
;

137 
cudaE¼Ü_t
 
¡©us
 = 
	`cudaM®loc
((**)&
x_gpu
, 
size
);

138 
	`check_”rÜ
(
¡©us
);

139 if(
x
){

140 
¡©us
 = 
	`cudaMemıy
(
x_gpu
, 
x
, 
size
, 
cudaMemıyHo¡ToDeviû
);

141 
	`check_”rÜ
(
¡©us
);

143 if(!
x_gpu
è
	`”rÜ
("Cuda malloc failed\n");

144  
x_gpu
;

145 
	}
}

147 
	$cuda_ä“
(*
x_gpu
)

149 
cudaE¼Ü_t
 
¡©us
 = 
	`cudaF»e
(
x_gpu
);

150 
	`check_”rÜ
(
¡©us
);

151 
	}
}

153 
	$cuda_push_¬¿y
(*
x_gpu
, *
x
, 
size_t
 
n
)

155 
size_t
 
size
 = ()*
n
;

156 
cudaE¼Ü_t
 
¡©us
 = 
	`cudaMemıy
(
x_gpu
, 
x
, 
size
, 
cudaMemıyHo¡ToDeviû
);

157 
	`check_”rÜ
(
¡©us
);

158 
	}
}

160 
	$cuda_puÎ_¬¿y
(*
x_gpu
, *
x
, 
size_t
 
n
)

162 
size_t
 
size
 = ()*
n
;

163 
cudaE¼Ü_t
 
¡©us
 = 
	`cudaMemıy
(
x
, 
x_gpu
, 
size
, 
cudaMemıyDeviûToHo¡
);

164 
	`check_”rÜ
(
¡©us
);

165 
	}
}

167 
	$cuda_mag_¬¿y
(*
x_gpu
, 
size_t
 
n
)

169 *
‹mp
 = 
	`ÿÎoc
(
n
, ());

170 
	`cuda_puÎ_¬¿y
(
x_gpu
, 
‹mp
, 
n
);

171 
m
 = 
	`mag_¬¿y
(
‹mp
, 
n
);

172 
	`ä“
(
‹mp
);

173  
m
;

174 
	}
}

176 
	$cuda_£t_deviû
(
n
){
	}
}

	@cuda.h

1 #iâdeà
CUDA_H


2 
	#CUDA_H


	)

4 
	~"d¬kÃt.h
"

6 #ifdeà
GPU


8 
check_”rÜ
(
cudaE¼Ü_t
 
¡©us
);

9 
cubÏsHªdË_t
 
bÏs_hªdË
();

10 *
cuda_make_št_¬¿y
(*
x
, 
size_t
 
n
);

11 
cuda_¿ndom
(*
x_gpu
, 
size_t
 
n
);

12 
cuda_com·»
(*
x_gpu
, *
x
, 
size_t
 
n
, *
s
);

13 
dim3
 
cuda_gridsize
(
size_t
 
n
);

15 #ifdeà
CUDNN


16 
cudÂHªdË_t
 
cudÂ_hªdË
();

	@data.c

1 
	~"d©a.h
"

2 
	~"uts.h
"

3 
	~"image.h
"

4 
	~"cuda.h
"

6 
	~<¡dio.h
>

7 
	~<¡dlib.h
>

8 
	~<¡ršg.h
>

10 
±h»ad_mu‹x_t
 
	gmu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

12 
li¡
 *
	$g‘_·ths
(*
f’ame
)

14 *
·th
;

15 
FILE
 *
fe
 = 
	`fİ’
(
f’ame
, "r");

16 if(!
fe
è
	`fe_”rÜ
(
f’ame
);

17 
li¡
 *
lšes
 = 
	`make_li¡
();

18 (
·th
=
	`fg‘l
(
fe
))){

19 
	`li¡_š£¹
(
lšes
, 
·th
);

21 
	`fşo£
(
fe
);

22  
lšes
;

23 
	}
}

42 **
	$g‘_¿ndom_·ths
(**
·ths
, 
n
, 
m
)

44 **
¿ndom_·ths
 = 
	`ÿÎoc
(
n
, (*));

45 
i
;

46 
	`±h»ad_mu‹x_lock
(&
mu‹x
);

47 
i
 = 0; i < 
n
; ++i){

48 
šdex
 = 
	`¿nd
()%
m
;

49 
¿ndom_·ths
[
i
] = 
·ths
[
šdex
];

52 
	`±h»ad_mu‹x_uÆock
(&
mu‹x
);

53  
¿ndom_·ths
;

54 
	}
}

57 
·th_Ïb–s
 *
	$g‘_¿ndom_·ths_Ïb–s
(**
·ths
, **
Ïb–s
, 
n
, 
m
)

59 
·th_Ïb–s
 *
·th_Ïb
 = (·th_Ïb–s*)
	`m®loc
( (…ath_labels) );

60 
·th_Ïb
->
¿ndom_·ths
 = 
	`ÿÎoc
(
n
, (*));

61 
·th_Ïb
->
¿ndom_Ïb–s
 = 
	`ÿÎoc
(
n
, (*));

62 
i
;

63 
	`±h»ad_mu‹x_lock
(&
mu‹x
);

64 
i
 = 0; i < 
n
; ++i){

65 
šdex
 = 
	`¿nd
()%
m
;

66 
·th_Ïb
->
¿ndom_·ths
[
i
] = 
·ths
[
šdex
];

67 
·th_Ïb
->
¿ndom_Ïb–s
[
i
] = 
Ïb–s
[
šdex
];

72 
	`±h»ad_mu‹x_uÆock
(&
mu‹x
);

73  
·th_Ïb
;

74 
	}
}

76 **
	$fšd_»¶aû_·ths
(**
·ths
, 
n
, *
fšd
, *
»¶aû
)

78 **
»¶aû_·ths
 = 
	`ÿÎoc
(
n
, (*));

79 
i
;

80 
i
 = 0; i < 
n
; ++i){

81 
»¶aûd
[4096];

82 
	`fšd_»¶aû
(
·ths
[
i
], 
fšd
, 
»¶aû
, 
»¶aûd
);

83 
»¶aû_·ths
[
i
] = 
	`cİy_¡ršg
(
»¶aûd
);

85  
»¶aû_·ths
;

86 
	}
}

88 
m©rix
 
	$lßd_image_·ths_g¿y
(**
·ths
, 
n
, 
w
, 
h
)

90 
i
;

91 
m©rix
 
X
;

92 
X
.
rows
 = 
n
;

93 
X
.
v®s
 = 
	`ÿÎoc
(X.
rows
, (*));

94 
X
.
cŞs
 = 0;

96 
i
 = 0; i < 
n
; ++i){

97 
image
 
im
 = 
	`lßd_image_g¿y
(
·ths
[
i
], 
w
, 
h
);

105 
X
.
v®s
[
i
] = 
im
.
d©a
;

106 
X
.
cŞs
 = 
im
.
h
*im.
w
;

108  
X
;

109 
	}
}

111 
m©rix
 
	$lßd_image_·ths
(**
·ths
, 
n
, 
w
, 
h
)

113 
i
;

114 
m©rix
 
X
;

115 
X
.
rows
 = 
n
;

116 
X
.
v®s
 = 
	`ÿÎoc
(X.
rows
, (*));

117 
X
.
cŞs
 = 0;

119 
i
 = 0; i < 
n
; ++i){

121 
image
 
im
 = 
	`lßd_image_cŞÜ
(
·ths
[
i
], 
w
, 
h
);

125 
X
.
v®s
[
i
] = 
im
.
d©a
;

126 
X
.
cŞs
 = 
im
.
h
*im.
w
*im.
c
;

128  
X
;

129 
	}
}

131 
m©rix
 
	$lßd_image_augm’t_·ths
(**
·ths
, 
n
, 
mš
, 
max
, 
size
, 
ªgË
, 
a¥eù
, 
hue
, 
§tu¿tiÚ
, 
exposu»
, 
ûÁ”
)

133 
i
;

134 
m©rix
 
X
;

135 
X
.
rows
 = 
n
;

136 
X
.
v®s
 = 
	`ÿÎoc
(X.
rows
, (*));

137 
X
.
cŞs
 = 0;

139 
i
 = 0; i < 
n
; ++i){

140 
image
 
im
 = 
	`lßd_image_cŞÜ
(
·ths
[
i
], 0, 0);

141 
image
 
üİ
;

142 if(
ûÁ”
){

143 
üİ
 = 
	`ûÁ”_üİ_image
(
im
, 
size
, size);

145 
üİ
 = 
	`¿ndom_augm’t_image
(
im
, 
ªgË
, 
a¥eù
, 
mš
, 
max
, 
size
, size);

147 
æ
 = 
	`¿nd
()%2;

148 ià(
æ
è
	`æ_image
(
üİ
);

149 
	`¿ndom_di¡Üt_image
(
üİ
, 
hue
, 
§tu¿tiÚ
, 
exposu»
);

156 
	`ä“_image
(
im
);

157 
X
.
v®s
[
i
] = 
üİ
.
d©a
;

158 
X
.
cŞs
 = 
üİ
.
h
*üİ.
w
*üİ.
c
;

160  
X
;

161 
	}
}

164 
box_Ïb–
 *
	$»ad_boxes
(*
f’ame
, *
n
)

166 
FILE
 *
fe
 = 
	`fİ’
(
f’ame
, "r");

167 if(!
fe
è
	`fe_”rÜ
(
f’ame
);

168 
x
, 
y
, 
h
, 
w
;

169 
id
;

170 
couÁ
 = 0;

171 
size
 = 64;

172 
box_Ïb–
 *
boxes
 = 
	`ÿÎoc
(
size
, (box_label));

173 
	`fsÿnf
(
fe
, "%d %à%à%à%f", &
id
, &
x
, &
y
, &
w
, &
h
) == 5){

174 if(
couÁ
 =ğ
size
) {

175 
size
 = size * 2;

176 
boxes
 = 
	`»®loc
(boxes, 
size
*(
box_Ïb–
));

178 
boxes
[
couÁ
].
id
 = id;

179 
boxes
[
couÁ
].
x
 = x;

180 
boxes
[
couÁ
].
y
 = y;

181 
boxes
[
couÁ
].
h
 = h;

182 
boxes
[
couÁ
].
w
 = w;

183 
boxes
[
couÁ
].
Ëá
 = 
x
 - 
w
/2;

184 
boxes
[
couÁ
].
right
 = 
x
 + 
w
/2;

185 
boxes
[
couÁ
].
tİ
 = 
y
 - 
h
/2;

186 
boxes
[
couÁ
].
bÙtom
 = 
y
 + 
h
/2;

187 ++
couÁ
;

189 
	`fşo£
(
fe
);

190 *
n
 = 
couÁ
;

191  
boxes
;

192 
	}
}

194 
	$¿ndomize_boxes
(
box_Ïb–
 *
b
, 
n
)

196 
i
;

197 
i
 = 0; i < 
n
; ++i){

198 
box_Ïb–
 
sw­
 = 
b
[
i
];

199 
šdex
 = 
	`¿nd
()%
n
;

200 
b
[
i
] = b[
šdex
];

201 
b
[
šdex
] = 
sw­
;

203 
	}
}

205 
	$cÜ»ù_boxes
(
box_Ïb–
 *
boxes
, 
n
, 
dx
, 
dy
, 
sx
, 
sy
, 
æ
)

207 
i
;

208 
i
 = 0; i < 
n
; ++i){

209 if(
boxes
[
i
].
x
 =ğ0 && boxes[i].
y
 == 0) {

210 
boxes
[
i
].
x
 = 999999;

211 
boxes
[
i
].
y
 = 999999;

212 
boxes
[
i
].
w
 = 999999;

213 
boxes
[
i
].
h
 = 999999;

216 
boxes
[
i
].
Ëá
 = boxes[i].Ëá * 
sx
 - 
dx
;

217 
boxes
[
i
].
right
 = boxes[i].righˆ* 
sx
 - 
dx
;

218 
boxes
[
i
].
tİ
 = boxes[i].tİ * 
sy
 - 
dy
;

219 
boxes
[
i
].
bÙtom
 = boxes[i].bÙtom* 
sy
 - 
dy
;

221 if(
æ
){

222 
sw­
 = 
boxes
[
i
].
Ëá
;

223 
boxes
[
i
].
Ëá
 = 1. - boxes[i].
right
;

224 
boxes
[
i
].
right
 = 1. - 
sw­
;

227 
boxes
[
i
].
Ëá
 = 
	`cÚ¡¿š
(0, 1, boxes[i].left);

228 
boxes
[
i
].
right
 = 
	`cÚ¡¿š
(0, 1, boxes[i].right);

229 
boxes
[
i
].
tİ
 = 
	`cÚ¡¿š
(0, 1, boxes[i].top);

230 
boxes
[
i
].
bÙtom
 = 
	`cÚ¡¿š
(0, 1, boxes[i].bottom);

232 
boxes
[
i
].
x
 = (boxes[i].
Ëá
+boxes[i].
right
)/2;

233 
boxes
[
i
].
y
 = (boxes[i].
tİ
+boxes[i].
bÙtom
)/2;

234 
boxes
[
i
].
w
 = (boxes[i].
right
 - boxes[i].
Ëá
);

235 
boxes
[
i
].
h
 = (boxes[i].
bÙtom
 - boxes[i].
tİ
);

237 
boxes
[
i
].
w
 = 
	`cÚ¡¿š
(0, 1, boxes[i].w);

238 
boxes
[
i
].
h
 = 
	`cÚ¡¿š
(0, 1, boxes[i].h);

240 
	}
}

242 
	$fl_Œuth_swag
(*
·th
, *
Œuth
, 
şas£s
, 
æ
, 
dx
, 
dy
, 
sx
, 
sy
)

244 
Ïb–·th
[4096];

245 
	`fšd_»¶aû
(
·th
, "images", "Ïb–s", 
Ïb–·th
);

246 
	`fšd_»¶aû
(
Ïb–·th
, "JPEGImages", "labels",†abelpath);

247 
	`fšd_»¶aû
(
Ïb–·th
, ".jpg", ".txt",†abelpath);

248 
	`fšd_»¶aû
(
Ïb–·th
, ".JPG", ".txt",†abelpath);

249 
	`fšd_»¶aû
(
Ïb–·th
, ".JPEG", ".txt",†abelpath);

251 
couÁ
 = 0;

252 
box_Ïb–
 *
boxes
 = 
	`»ad_boxes
(
Ïb–·th
, &
couÁ
);

253 
	`¿ndomize_boxes
(
boxes
, 
couÁ
);

254 
	`cÜ»ù_boxes
(
boxes
, 
couÁ
, 
dx
, 
dy
, 
sx
, 
sy
, 
æ
);

255 
x
,
y
,
w
,
h
;

256 
id
;

257 
i
;

259 
i
 = 0; i < 
couÁ
 && i < 90; ++i) {

260 
x
 = 
boxes
[
i
].x;

261 
y
 = 
boxes
[
i
].y;

262 
w
 = 
boxes
[
i
].w;

263 
h
 = 
boxes
[
i
].h;

264 
id
 = 
boxes
[
i
].id;

266 ià(
w
 < .0 || 
h
 < .0) ;

268 
šdex
 = (4+
şas£s
è* 
i
;

270 
Œuth
[
šdex
++] = 
x
;

271 
Œuth
[
šdex
++] = 
y
;

272 
Œuth
[
šdex
++] = 
w
;

273 
Œuth
[
šdex
++] = 
h
;

275 ià(
id
 < 
şas£s
è
Œuth
[
šdex
+id] = 1;

277 
	`ä“
(
boxes
);

278 
	}
}

280 
	$fl_Œuth_»giÚ
(*
·th
, *
Œuth
, 
şas£s
, 
num_boxes
, 
æ
, 
dx
, 
dy
, 
sx
, 
sy
)

282 
Ïb–·th
[4096];

283 
	`fšd_»¶aû
(
·th
, "images", "Ïb–s", 
Ïb–·th
);

284 
	`fšd_»¶aû
(
Ïb–·th
, "JPEGImages", "labels",†abelpath);

286 
	`fšd_»¶aû
(
Ïb–·th
, ".jpg", ".txt",†abelpath);

287 
	`fšd_»¶aû
(
Ïb–·th
, ".png", ".txt",†abelpath);

288 
	`fšd_»¶aû
(
Ïb–·th
, ".JPG", ".txt",†abelpath);

289 
	`fšd_»¶aû
(
Ïb–·th
, ".JPEG", ".txt",†abelpath);

290 
couÁ
 = 0;

291 
box_Ïb–
 *
boxes
 = 
	`»ad_boxes
(
Ïb–·th
, &
couÁ
);

292 
	`¿ndomize_boxes
(
boxes
, 
couÁ
);

293 
	`cÜ»ù_boxes
(
boxes
, 
couÁ
, 
dx
, 
dy
, 
sx
, 
sy
, 
æ
);

294 
x
,
y
,
w
,
h
;

295 
id
;

296 
i
;

298 
i
 = 0; i < 
couÁ
; ++i) {

299 
x
 = 
boxes
[
i
].x;

300 
y
 = 
boxes
[
i
].y;

301 
w
 = 
boxes
[
i
].w;

302 
h
 = 
boxes
[
i
].h;

303 
id
 = 
boxes
[
i
].id;

305 ià(
w
 < .005 || 
h
 < .005) ;

307 
cŞ
 = ()(
x
*
num_boxes
);

308 
row
 = ()(
y
*
num_boxes
);

310 
x
 = x*
num_boxes
 - 
cŞ
;

311 
y
 = y*
num_boxes
 - 
row
;

313 
šdex
 = (
cŞ
+
row
*
num_boxes
)*(5+
şas£s
);

314 ià(
Œuth
[
šdex
]) ;

315 
Œuth
[
šdex
++] = 1;

317 ià(
id
 < 
şas£s
è
Œuth
[
šdex
+id] = 1;

318 
šdex
 +ğ
şas£s
;

320 
Œuth
[
šdex
++] = 
x
;

321 
Œuth
[
šdex
++] = 
y
;

322 
Œuth
[
šdex
++] = 
w
;

323 
Œuth
[
šdex
++] = 
h
;

325 
	`ä“
(
boxes
);

326 
	}
}

328 
	$lßd_¾e
(
image
 
im
, *
¾e
, 
n
)

330 
couÁ
 = 0;

331 
cu¼
 = 0;

332 
i
,
j
;

333 
i
 = 0; i < 
n
; ++i){

334 
j
 = 0; j < 
¾e
[
i
]; ++j){

335 
im
.
d©a
[
couÁ
++] = 
cu¼
;

337 
cu¼
 = 1 - curr;

339 ; 
couÁ
 < 
im
.
h
*im.
w
*im.
c
; ++count){

340 
im
.
d©a
[
couÁ
] = 
cu¼
;

342 
	}
}

344 
	$Ü_image
(
image
 
¤c
, imag
de¡
, 
c
)

346 
i
;

347 
i
 = 0; i < 
¤c
.
w
*¤c.
h
; ++i){

348 if(
¤c
.
d©a
[
i
]è
de¡
.d©a[de¡.
w
*de¡.
h
*
c
 + i] = 1;

350 
	}
}

352 
	$exşusive_image
(
image
 
¤c
)

354 
k
, 
j
, 
i
;

355 
s
 = 
¤c
.
w
*¤c.
h
;

356 
k
 = 0; k < 
¤c
.
c
-1; ++k){

357 
i
 = 0; i < 
s
; ++i){

358 ià(
¤c
.
d©a
[
k
*
s
 + 
i
]){

359 
j
 = 
k
+1; j < 
¤c
.
c
; ++j){

360 
¤c
.
d©a
[
j
*
s
 + 
i
] = 0;

365 
	}
}

367 
box
 
	$bound_image
(
image
 
im
)

369 
x
,
y
;

370 
mšx
 = 
im
.
w
;

371 
mšy
 = 
im
.
h
;

372 
maxx
 = 0;

373 
maxy
 = 0;

374 
y
 = 0; y < 
im
.
h
; ++y){

375 
x
 = 0; x < 
im
.
w
; ++x){

376 if(
im
.
d©a
[
y
*im.
w
 + 
x
]){

377 
mšx
 = (
x
 < minx) ? x : minx;

378 
mšy
 = (
y
 < miny) ? y : miny;

379 
maxx
 = (
x
 > maxx) ? x : maxx;

380 
maxy
 = (
y
 > maxy) ? y : maxy;

384 
box
 
b
 = {
mšx
, 
mšy
, 
maxx
-mšx + 1, 
maxy
-miny + 1};

386  
b
;

387 
	}
}

389 
	$fl_Œuth_i£g
(*
·th
, 
num_boxes
, *
Œuth
, 
şas£s
, 
w
, 
h
, 
augm’t_¬gs
 
aug
, 
æ
, 
mw
, 
mh
)

391 
Ïb–·th
[4096];

392 
	`fšd_»¶aû
(
·th
, "images", "mask", 
Ïb–·th
);

393 
	`fšd_»¶aû
(
Ïb–·th
, "JPEGImages", "mask",†abelpath);

394 
	`fšd_»¶aû
(
Ïb–·th
, ".jpg", ".txt",†abelpath);

395 
	`fšd_»¶aû
(
Ïb–·th
, ".JPG", ".txt",†abelpath);

396 
	`fšd_»¶aû
(
Ïb–·th
, ".JPEG", ".txt",†abelpath);

397 
FILE
 *
fe
 = 
	`fİ’
(
Ïb–·th
, "r");

398 if(!
fe
è
	`fe_”rÜ
(
Ïb–·th
);

399 
buff
[32788];

400 
id
;

401 
i
 = 0;

402 
image
 
·¹
 = 
	`make_image
(
w
, 
h
, 1);

403 (
	`fsÿnf
(
fe
, "%d %s", &
id
, 
buff
è=ğ2è&& 
i
 < 
num_boxes
){

404 
n
 = 0;

405 *
¾e
 = 
	`»ad_ši¡
(
buff
, &
n
, 0);

406 
	`lßd_¾e
(
·¹
, 
¾e
, 
n
);

407 
image
 
sized
 = 
	`rÙ©e_üİ_image
(
·¹
, 
aug
.
¿d
,‡ug.
sÿË
,‡ug.
w
,‡ug.
h
,‡ug.
dx
,‡ug.
dy
,‡ug.
a¥eù
);

408 if(
æ
è
	`æ_image
(
sized
);

409 
box
 
b
 = 
	`bound_image
(
sized
);

410 if(
b
.
w
 > 0){

411 
image
 
üİ
 = 
	`üİ_image
(
sized
, 
b
.
x
, b.
y
, b.
w
, b.
h
);

412 
image
 
mask
 = 
	`»size_image
(
üİ
, 
mw
, 
mh
);

413 
Œuth
[
i
*(4 + 
mw
*
mh
 + 1è+ 0] = (
b
.
x
 + b.
w
/2.)/
sized
.w;

414 
Œuth
[
i
*(4 + 
mw
*
mh
 + 1è+ 1] = (
b
.
y
 + b.
h
/2.)/
sized
.h;

415 
Œuth
[
i
*(4 + 
mw
*
mh
 + 1è+ 2] = 
b
.
w
/
sized
.w;

416 
Œuth
[
i
*(4 + 
mw
*
mh
 + 1è+ 3] = 
b
.
h
/
sized
.h;

417 
j
;

418 
j
 = 0; j < 
mw
*
mh
; ++j){

419 
Œuth
[
i
*(4 + 
mw
*
mh
 + 1è+ 4 + 
j
] = 
mask
.
d©a
[j];

421 
Œuth
[
i
*(4 + 
mw
*
mh
 + 1è+ 4 + mw*mh] = 
id
;

422 
	`ä“_image
(
üİ
);

423 
	`ä“_image
(
mask
);

424 ++
i
;

426 
	`ä“_image
(
sized
);

427 
	`ä“
(
¾e
);

429 
	`fşo£
(
fe
);

430 
	`ä“_image
(
·¹
);

431 
	}
}

434 
	$fl_Œuth_d‘eùiÚ
(*
·th
, 
num_boxes
, *
Œuth
, 
şas£s
, 
æ
, 
dx
, 
dy
, 
sx
, 
sy
)

436 
Ïb–·th
[4096];

437 
	`fšd_»¶aû
(
·th
, "images", "Ïb–s", 
Ïb–·th
);

438 
	`fšd_»¶aû
(
Ïb–·th
, "JPEGImages", "labels",†abelpath);

440 
	`fšd_»¶aû
(
Ïb–·th
, "raw", "labels",†abelpath);

441 
	`fšd_»¶aû
(
Ïb–·th
, ".jpg", ".txt",†abelpath);

442 
	`fšd_»¶aû
(
Ïb–·th
, ".png", ".txt",†abelpath);

443 
	`fšd_»¶aû
(
Ïb–·th
, ".JPG", ".txt",†abelpath);

444 
	`fšd_»¶aû
(
Ïb–·th
, ".JPEG", ".txt",†abelpath);

445 
couÁ
 = 0;

446 
box_Ïb–
 *
boxes
 = 
	`»ad_boxes
(
Ïb–·th
, &
couÁ
);

447 
	`¿ndomize_boxes
(
boxes
, 
couÁ
);

448 
	`cÜ»ù_boxes
(
boxes
, 
couÁ
, 
dx
, 
dy
, 
sx
, 
sy
, 
æ
);

449 if(
couÁ
 > 
num_boxes
) count =‚um_boxes;

450 
x
,
y
,
w
,
h
;

451 
id
;

452 
i
;

453 
sub
 = 0;

455 
i
 = 0; i < 
couÁ
; ++i) {

456 
x
 = 
boxes
[
i
].x;

457 
y
 = 
boxes
[
i
].y;

458 
w
 = 
boxes
[
i
].w;

459 
h
 = 
boxes
[
i
].h;

460 
id
 = 
boxes
[
i
].id;

462 ià((
w
 < .001 || 
h
 < .001)) {

463 ++
sub
;

467 
Œuth
[(
i
-
sub
)*5+0] = 
x
;

468 
Œuth
[(
i
-
sub
)*5+1] = 
y
;

469 
Œuth
[(
i
-
sub
)*5+2] = 
w
;

470 
Œuth
[(
i
-
sub
)*5+3] = 
h
;

471 
Œuth
[(
i
-
sub
)*5+4] = 
id
;

473 
	`ä“
(
boxes
);

474 
	}
}

476 
	#NUMCHARS
 37

	)

478 
	$´št_Ë‰”s
(*
´ed
, 
n
)

480 
i
;

481 
i
 = 0; i < 
n
; ++i){

482 
šdex
 = 
	`max_šdex
(
´ed
+
i
*
NUMCHARS
, NUMCHARS);

483 
	`´štf
("%c", 
	`št_to_®phªum
(
šdex
));

485 
	`´štf
("\n");

486 
	}
}

488 
	$fl_Œuth_ÿ±cha
(*
·th
, 
n
, *
Œuth
)

490 *
begš
 = 
	`¡¼chr
(
·th
, '/');

491 ++
begš
;

492 
i
;

493 
i
 = 0; i < 
	`¡¾’
(
begš
è&& i < 
n
 && begin[i] != '.'; ++i){

494 
šdex
 = 
	`®phªum_to_št
(
begš
[
i
]);

495 if(
šdex
 > 35è
	`´štf
("Bad %c\n", 
begš
[
i
]);

496 
Œuth
[
i
*
NUMCHARS
+
šdex
] = 1;

498 ;
i
 < 
n
; ++i){

499 
Œuth
[
i
*
NUMCHARS
 + NUMCHARS-1] = 1;

501 
	}
}

503 
d©a
 
	$lßd_d©a_ÿ±cha
(**
·ths
, 
n
, 
m
, 
k
, 
w
, 
h
)

505 if(
m
è
·ths
 = 
	`g‘_¿ndom_·ths
Õ©hs, 
n
, m);

506 
d©a
 
d
 = {0};

507 
d
.
sh®low
 = 0;

508 
d
.
X
 = 
	`lßd_image_·ths
(
·ths
, 
n
, 
w
, 
h
);

509 
d
.
y
 = 
	`make_m©rix
(
n
, 
k
*
NUMCHARS
);

510 
i
;

511 
i
 = 0; i < 
n
; ++i){

512 
	`fl_Œuth_ÿ±cha
(
·ths
[
i
], 
k
, 
d
.
y
.
v®s
[i]);

514 if(
m
è
	`ä“
(
·ths
);

515  
d
;

516 
	}
}

518 
d©a
 
	$lßd_d©a_ÿ±cha_’code
(**
·ths
, 
n
, 
m
, 
w
, 
h
)

520 if(
m
è
·ths
 = 
	`g‘_¿ndom_·ths
Õ©hs, 
n
, m);

521 
d©a
 
d
 = {0};

522 
d
.
sh®low
 = 0;

523 
d
.
X
 = 
	`lßd_image_·ths
(
·ths
, 
n
, 
w
, 
h
);

524 
d
.
X
.
cŞs
 = 17100;

525 
d
.
y
 = d.
X
;

526 if(
m
è
	`ä“
(
·ths
);

527  
d
;

528 
	}
}

530 
	$fl_Œuth
(*
·th
, **
Ïb–s
, 
k
, *
Œuth
)

532 
i
;

533 
	`mem£t
(
Œuth
, 0, 
k
*());

534 
couÁ
 = 0;

535 
i
 = 0; i < 
k
; ++i){

536 if(
	`¡r¡r
(
·th
, 
Ïb–s
[
i
])){

537 
Œuth
[
i
] = 1;

538 ++
couÁ
;

542 if(
couÁ
 !ğ1 && (
k
 !ğ1 || couÁ !ğ0)è
	`´štf
("ToØmªy o¸toØãw†ab–s: %d, %s\n", couÁ, 
·th
);

543 
	}
}

545 
	$fl_h›¿rchy
(*
Œuth
, 
k
, 
Œ“
 *
h›¿rchy
)

547 
j
;

548 
j
 = 0; j < 
k
; ++j){

549 if(
Œuth
[
j
]){

550 
·»Á
 = 
h›¿rchy
->·»Á[
j
];

551 
·»Á
 >= 0){

552 
Œuth
[
·»Á
] = 1;

553 
·»Á
 = 
h›¿rchy
->parent[parent];

557 
i
;

558 
couÁ
 = 0;

559 
j
 = 0; j < 
h›¿rchy
->
groups
; ++j){

561 
mask
 = 1;

562 
i
 = 0; i < 
h›¿rchy
->
group_size
[
j
]; ++i){

563 if(
Œuth
[
couÁ
 + 
i
]){

564 
mask
 = 0;

568 ià(
mask
) {

569 
i
 = 0; i < 
h›¿rchy
->
group_size
[
j
]; ++i){

570 
Œuth
[
couÁ
 + 
i
] = 
SECRET_NUM
;

573 
couÁ
 +ğ
h›¿rchy
->
group_size
[
j
];

575 
	}
}

577 
m©rix
 
	$lßd_»g»ssiÚ_Ïb–s_·ths
(**
·ths
, 
n
, 
k
)

579 
m©rix
 
y
 = 
	`make_m©rix
(
n
, 
k
);

580 
i
,
j
;

581 
i
 = 0; i < 
n
; ++i){

582 
Ïb–·th
[4096];

583 
	`fšd_»¶aû
(
·ths
[
i
], "images", "Ïb–s", 
Ïb–·th
);

584 
	`fšd_»¶aû
(
Ïb–·th
, "JPEGImages", "labels",†abelpath);

585 
	`fšd_»¶aû
(
Ïb–·th
, ".BMP", ".txt",†abelpath);

586 
	`fšd_»¶aû
(
Ïb–·th
, ".JPEG", ".txt",†abelpath);

587 
	`fšd_»¶aû
(
Ïb–·th
, ".JPG", ".txt",†abelpath);

588 
	`fšd_»¶aû
(
Ïb–·th
, ".JPeG", ".txt",†abelpath);

589 
	`fšd_»¶aû
(
Ïb–·th
, ".Jpeg", ".txt",†abelpath);

590 
	`fšd_»¶aû
(
Ïb–·th
, ".PNG", ".txt",†abelpath);

591 
	`fšd_»¶aû
(
Ïb–·th
, ".TIF", ".txt",†abelpath);

592 
	`fšd_»¶aû
(
Ïb–·th
, ".bmp", ".txt",†abelpath);

593 
	`fšd_»¶aû
(
Ïb–·th
, ".jpeg", ".txt",†abelpath);

594 
	`fšd_»¶aû
(
Ïb–·th
, ".jpg", ".txt",†abelpath);

595 
	`fšd_»¶aû
(
Ïb–·th
, ".png", ".txt",†abelpath);

596 
	`fšd_»¶aû
(
Ïb–·th
, ".tif", ".txt",†abelpath);

598 
FILE
 *
fe
 = 
	`fİ’
(
Ïb–·th
, "r");

599 
j
 = 0; j < 
k
; ++j){

600 
	`fsÿnf
(
fe
, "%f", &(
y
.
v®s
[
i
][
j
]));

602 
	`fşo£
(
fe
);

604  
y
;

605 
	}
}

607 
m©rix
 
	$lßd_Ïb–s_·ths
(**
·ths
, 
n
, **
Ïb–s
, 
k
, 
Œ“
 *
h›¿rchy
)

609 
m©rix
 
y
 = 
	`make_m©rix
(
n
, 
k
);

610 
i
;

611 
i
 = 0; i < 
n
 && 
Ïb–s
; ++i){

612 
	`fl_Œuth
(
·ths
[
i
], 
Ïb–s
, 
k
, 
y
.
v®s
[i]);

613 if(
h›¿rchy
){

614 
	`fl_h›¿rchy
(
y
.
v®s
[
i
], 
k
, 
h›¿rchy
);

617  
y
;

618 
	}
}

620 
m©rix
 
	$lßd_gs_·ths
(**
·ths
, 
n
, 
k
)

622 
m©rix
 
y
 = 
	`make_m©rix
(
n
, 
k
);

623 
i
;

625 
i
 = 0; i < 
n
; ++i){

626 
Ïb–
[4096];

627 
	`fšd_»¶aû
(
·ths
[
i
], "images", "Ïb–s", 
Ïb–
);

628 
	`fšd_»¶aû
(
Ïb–
, ".jpg", ".txt",†abel);

629 
FILE
 *
fe
 = 
	`fİ’
(
Ïb–
, "r");

630 ià(!
fe
) ;

632 
g
;

633 
	`fsÿnf
(
fe
, "%d", &
g
) == 1){

634 if(
g
 < 
k
){

635 
y
.
v®s
[
i
][
g
] = 1;

638 
	`fşo£
(
fe
);

641  
y
;

642 
	}
}

644 **
	$g‘_Ïb–s
(*
f’ame
)

646 
li¡
 *
¶i¡
 = 
	`g‘_·ths
(
f’ame
);

647 **
Ïb–s
 = (**)
	`li¡_to_¬¿y
(
¶i¡
);

648 
	`ä“_li¡
(
¶i¡
);

649  
Ïb–s
;

650 
	}
}

652 
	$ä“_d©a
(
d©a
 
d
)

654 if(!
d
.
sh®low
){

655 
	`ä“_m©rix
(
d
.
X
);

656 
	`ä“_m©rix
(
d
.
y
);

658 
	`ä“
(
d
.
X
.
v®s
);

659 
	`ä“
(
d
.
y
.
v®s
);

661 
	}
}

663 
image
 
	$g‘_£gm’tiÚ_image
(*
·th
, 
w
, 
h
, 
şas£s
)

665 
Ïb–·th
[4096];

666 
	`fšd_»¶aû
(
·th
, "images", "mask", 
Ïb–·th
);

667 
	`fšd_»¶aû
(
Ïb–·th
, "JPEGImages", "mask",†abelpath);

668 
	`fšd_»¶aû
(
Ïb–·th
, ".jpg", ".txt",†abelpath);

669 
	`fšd_»¶aû
(
Ïb–·th
, ".JPG", ".txt",†abelpath);

670 
	`fšd_»¶aû
(
Ïb–·th
, ".JPEG", ".txt",†abelpath);

671 
image
 
mask
 = 
	`make_image
(
w
, 
h
, 
şas£s
);

672 
FILE
 *
fe
 = 
	`fİ’
(
Ïb–·th
, "r");

673 if(!
fe
è
	`fe_”rÜ
(
Ïb–·th
);

674 
buff
[32788];

675 
id
;

676 
image
 
·¹
 = 
	`make_image
(
w
, 
h
, 1);

677 
	`fsÿnf
(
fe
, "%d %s", &
id
, 
buff
) == 2){

678 
n
 = 0;

679 *
¾e
 = 
	`»ad_ši¡
(
buff
, &
n
, 0);

680 
	`lßd_¾e
(
·¹
, 
¾e
, 
n
);

681 
	`Ü_image
(
·¹
, 
mask
, 
id
);

682 
	`ä“
(
¾e
);

685 
	`fşo£
(
fe
);

686 
	`ä“_image
(
·¹
);

687  
mask
;

688 
	}
}

690 
image
 
	$g‘_£gm’tiÚ_image2
(*
·th
, 
w
, 
h
, 
şas£s
)

692 
Ïb–·th
[4096];

693 
	`fšd_»¶aû
(
·th
, "images", "mask", 
Ïb–·th
);

694 
	`fšd_»¶aû
(
Ïb–·th
, "JPEGImages", "mask",†abelpath);

695 
	`fšd_»¶aû
(
Ïb–·th
, ".jpg", ".txt",†abelpath);

696 
	`fšd_»¶aû
(
Ïb–·th
, ".JPG", ".txt",†abelpath);

697 
	`fšd_»¶aû
(
Ïb–·th
, ".JPEG", ".txt",†abelpath);

698 
image
 
mask
 = 
	`make_image
(
w
, 
h
, 
şas£s
+1);

699 
i
;

700 
i
 = 0; i < 
w
*
h
; ++i){

701 
mask
.
d©a
[
w
*
h
*
şas£s
 + 
i
] = 1;

703 
FILE
 *
fe
 = 
	`fİ’
(
Ïb–·th
, "r");

704 if(!
fe
è
	`fe_”rÜ
(
Ïb–·th
);

705 
buff
[32788];

706 
id
;

707 
image
 
·¹
 = 
	`make_image
(
w
, 
h
, 1);

708 
	`fsÿnf
(
fe
, "%d %s", &
id
, 
buff
) == 2){

709 
n
 = 0;

710 *
¾e
 = 
	`»ad_ši¡
(
buff
, &
n
, 0);

711 
	`lßd_¾e
(
·¹
, 
¾e
, 
n
);

712 
	`Ü_image
(
·¹
, 
mask
, 
id
);

713 
i
 = 0; i < 
w
*
h
; ++i){

714 if(
·¹
.
d©a
[
i
]è
mask
.d©a[
w
*
h
*
şas£s
 + i] = 0;

716 
	`ä“
(
¾e
);

719 
	`fşo£
(
fe
);

720 
	`ä“_image
(
·¹
);

721  
mask
;

722 
	}
}

724 
d©a
 
	$lßd_d©a_£g
(
n
, **
·ths
, 
m
, 
w
, 
h
, 
şas£s
, 
mš
, 
max
, 
ªgË
, 
a¥eù
, 
hue
, 
§tu¿tiÚ
, 
exposu»
, 
div
)

726 **
¿ndom_·ths
 = 
	`g‘_¿ndom_·ths
(
·ths
, 
n
, 
m
);

727 
i
;

728 
d©a
 
d
 = {0};

729 
d
.
sh®low
 = 0;

731 
d
.
X
.
rows
 = 
n
;

732 
d
.
X
.
v®s
 = 
	`ÿÎoc
(d.X.
rows
, (*));

733 
d
.
X
.
cŞs
 = 
h
*
w
*3;

736 
d
.
y
.
rows
 = 
n
;

737 
d
.
y
.
cŞs
 = 
h
*
w
*
şas£s
/
div
/div;

738 
d
.
y
.
v®s
 = 
	`ÿÎoc
(d.
X
.
rows
, (*));

740 
i
 = 0; i < 
n
; ++i){

741 
image
 
Üig
 = 
	`lßd_image_cŞÜ
(
¿ndom_·ths
[
i
], 0, 0);

742 
augm’t_¬gs
 
a
 = 
	`¿ndom_augm’t_¬gs
(
Üig
, 
ªgË
, 
a¥eù
, 
mš
, 
max
, 
w
, 
h
);

743 
image
 
sized
 = 
	`rÙ©e_üİ_image
(
Üig
, 
a
.
¿d
,‡.
sÿË
,‡.
w
,‡.
h
,‡.
dx
,‡.
dy
,‡.
a¥eù
);

745 
æ
 = 
	`¿nd
()%2;

746 if(
æ
è
	`æ_image
(
sized
);

747 
	`¿ndom_di¡Üt_image
(
sized
, 
hue
, 
§tu¿tiÚ
, 
exposu»
);

748 
d
.
X
.
v®s
[
i
] = 
sized
.
d©a
;

750 
image
 
mask
 = 
	`g‘_£gm’tiÚ_image
(
¿ndom_·ths
[
i
], 
Üig
.
w
, orig.
h
, 
şas£s
);

752 
image
 
sized_m
 = 
	`rÙ©e_üİ_image
(
mask
, 
a
.
¿d
,‡.
sÿË
/
div
,‡.
w
/div,‡.
h
/div,‡.
dx
/div,‡.
dy
/div,‡.
a¥eù
);

754 if(
æ
è
	`æ_image
(
sized_m
);

755 
d
.
y
.
v®s
[
i
] = 
sized_m
.
d©a
;

757 
	`ä“_image
(
Üig
);

758 
	`ä“_image
(
mask
);

768 
	`ä“
(
¿ndom_·ths
);

769  
d
;

770 
	}
}

772 
d©a
 
	$lßd_d©a_i£g
(
n
, **
·ths
, 
m
, 
w
, 
h
, 
şas£s
, 
boxes
, 
coÜds
, 
mš
, 
max
, 
ªgË
, 
a¥eù
, 
hue
, 
§tu¿tiÚ
, 
exposu»
)

774 **
¿ndom_·ths
 = 
	`g‘_¿ndom_·ths
(
·ths
, 
n
, 
m
);

775 
i
;

776 
d©a
 
d
 = {0};

777 
d
.
sh®low
 = 0;

779 
d
.
X
.
rows
 = 
n
;

780 
d
.
X
.
v®s
 = 
	`ÿÎoc
(d.X.
rows
, (*));

781 
d
.
X
.
cŞs
 = 
h
*
w
*3;

783 
d
.
y
 = 
	`make_m©rix
(
n
, (
coÜds
+1)*
boxes
);

785 
i
 = 0; i < 
n
; ++i){

786 
image
 
Üig
 = 
	`lßd_image_cŞÜ
(
¿ndom_·ths
[
i
], 0, 0);

787 
augm’t_¬gs
 
a
 = 
	`¿ndom_augm’t_¬gs
(
Üig
, 
ªgË
, 
a¥eù
, 
mš
, 
max
, 
w
, 
h
);

788 
image
 
sized
 = 
	`rÙ©e_üİ_image
(
Üig
, 
a
.
¿d
,‡.
sÿË
,‡.
w
,‡.
h
,‡.
dx
,‡.
dy
,‡.
a¥eù
);

790 
æ
 = 
	`¿nd
()%2;

791 if(
æ
è
	`æ_image
(
sized
);

792 
	`¿ndom_di¡Üt_image
(
sized
, 
hue
, 
§tu¿tiÚ
, 
exposu»
);

793 
d
.
X
.
v®s
[
i
] = 
sized
.
d©a
;

796 
	`fl_Œuth_i£g
(
¿ndom_·ths
[
i
], 
boxes
, 
d
.
y
.
v®s
[i], 
şas£s
, 
Üig
.
w
, orig.
h
, 
a
, 
æ
, 14, 14);

798 
	`ä“_image
(
Üig
);

808 
	`ä“
(
¿ndom_·ths
);

809  
d
;

810 
	}
}

812 
d©a
 
	$lßd_d©a_»giÚ
(
n
, **
·ths
, 
m
, 
w
, 
h
, 
size
, 
şas£s
, 
j™‹r
, 
hue
, 
§tu¿tiÚ
, 
exposu»
)

814 **
¿ndom_·ths
 = 
	`g‘_¿ndom_·ths
(
·ths
, 
n
, 
m
);

815 
i
;

816 
d©a
 
d
 = {0};

817 
d
.
sh®low
 = 0;

819 
d
.
X
.
rows
 = 
n
;

820 
d
.
X
.
v®s
 = 
	`ÿÎoc
(d.X.
rows
, (*));

821 
d
.
X
.
cŞs
 = 
h
*
w
*3;

824 
k
 = 
size
*size*(5+
şas£s
);

825 
d
.
y
 = 
	`make_m©rix
(
n
, 
k
);

826 
i
 = 0; i < 
n
; ++i){

827 
image
 
Üig
 = 
	`lßd_image_cŞÜ
(
¿ndom_·ths
[
i
], 0, 0);

829 
oh
 = 
Üig
.
h
;

830 
ow
 = 
Üig
.
w
;

832 
dw
 = (
ow
*
j™‹r
);

833 
dh
 = (
oh
*
j™‹r
);

835 
¶eá
 = 
	`¿nd_unifÜm
(-
dw
, dw);

836 
´ight
 = 
	`¿nd_unifÜm
(-
dw
, dw);

837 
±İ
 = 
	`¿nd_unifÜm
(-
dh
, dh);

838 
pbÙ
 = 
	`¿nd_unifÜm
(-
dh
, dh);

840 
swidth
 = 
ow
 - 
¶eá
 - 
´ight
;

841 
sheight
 = 
oh
 - 
±İ
 - 
pbÙ
;

843 
sx
 = ()
swidth
 / 
ow
;

844 
sy
 = ()
sheight
 / 
oh
;

846 
æ
 = 
	`¿nd
()%2;

847 
image
 
üİ³d
 = 
	`üİ_image
(
Üig
, 
¶eá
, 
±İ
, 
swidth
, 
sheight
);

849 
dx
 = (()
¶eá
/
ow
)/
sx
;

850 
dy
 = (()
±İ
 /
oh
)/
sy
;

852 
image
 
sized
 = 
	`»size_image
(
üİ³d
, 
w
, 
h
);

853 if(
æ
è
	`æ_image
(
sized
);

854 
	`¿ndom_di¡Üt_image
(
sized
, 
hue
, 
§tu¿tiÚ
, 
exposu»
);

855 
d
.
X
.
v®s
[
i
] = 
sized
.
d©a
;

857 
	`fl_Œuth_»giÚ
(
¿ndom_·ths
[
i
], 
d
.
y
.
v®s
[i], 
şas£s
, 
size
, 
æ
, 
dx
, 
dy
, 1./
sx
, 1./
sy
);

859 
	`ä“_image
(
Üig
);

860 
	`ä“_image
(
üİ³d
);

862 
	`ä“
(
¿ndom_·ths
);

863  
d
;

864 
	}
}

866 
d©a
 
	$lßd_d©a_com·»
(
n
, **
·ths
, 
m
, 
şas£s
, 
w
, 
h
)

868 if(
m
è
·ths
 = 
	`g‘_¿ndom_·ths
Õ©hs, 2*
n
, m);

869 
i
,
j
;

870 
d©a
 
d
 = {0};

871 
d
.
sh®low
 = 0;

873 
d
.
X
.
rows
 = 
n
;

874 
d
.
X
.
v®s
 = 
	`ÿÎoc
(d.X.
rows
, (*));

875 
d
.
X
.
cŞs
 = 
h
*
w
*6;

877 
k
 = 2*(
şas£s
);

878 
d
.
y
 = 
	`make_m©rix
(
n
, 
k
);

879 
i
 = 0; i < 
n
; ++i){

880 
image
 
im1
 = 
	`lßd_image_cŞÜ
(
·ths
[
i
*2], 
w
, 
h
);

881 
image
 
im2
 = 
	`lßd_image_cŞÜ
(
·ths
[
i
*2+1], 
w
, 
h
);

883 
d
.
X
.
v®s
[
i
] = 
	`ÿÎoc
(d.X.
cŞs
, ());

884 
	`memıy
(
d
.
X
.
v®s
[
i
], 
im1
.
d©a
, 
h
*
w
*3*());

885 
	`memıy
(
d
.
X
.
v®s
[
i
] + 
h
*
w
*3, 
im2
.
d©a
, h*w*3*());

887 
id
;

888 
iou
;

890 
imÏb–1
[4096];

891 
imÏb–2
[4096];

892 
	`fšd_»¶aû
(
·ths
[
i
*2], "imgs", "Ïb–s", 
imÏb–1
);

893 
	`fšd_»¶aû
(
imÏb–1
, "jpg", "txt", imlabel1);

894 
FILE
 *
å1
 = 
	`fİ’
(
imÏb–1
, "r");

896 
	`fsÿnf
(
å1
, "%d %f", &
id
, &
iou
) == 2){

897 ià(
d
.
y
.
v®s
[
i
][2*
id
] < 
iou
) d.y.vals[i][2*id] = iou;

900 
	`fšd_»¶aû
(
·ths
[
i
*2+1], "imgs", "Ïb–s", 
imÏb–2
);

901 
	`fšd_»¶aû
(
imÏb–2
, "jpg", "txt", imlabel2);

902 
FILE
 *
å2
 = 
	`fİ’
(
imÏb–2
, "r");

904 
	`fsÿnf
(
å2
, "%d %f", &
id
, &
iou
) == 2){

905 ià(
d
.
y
.
v®s
[
i
][2*
id
 + 1] < 
iou
) d.y.vals[i][2*id + 1] = iou;

908 
j
 = 0; j < 
şas£s
; ++j){

909 ià(
d
.
y
.
v®s
[
i
][2*
j
] > .5 && d.y.vals[i][2*j+1] < .5){

910 
d
.
y
.
v®s
[
i
][2*
j
] = 1;

911 
d
.
y
.
v®s
[
i
][2*
j
+1] = 0;

912 } ià(
d
.
y
.
v®s
[
i
][2*
j
] < .5 && d.y.vals[i][2*j+1] > .5){

913 
d
.
y
.
v®s
[
i
][2*
j
] = 0;

914 
d
.
y
.
v®s
[
i
][2*
j
+1] = 1;

916 
d
.
y
.
v®s
[
i
][2*
j
] = 
SECRET_NUM
;

917 
d
.
y
.
v®s
[
i
][2*
j
+1] = 
SECRET_NUM
;

920 
	`fşo£
(
å1
);

921 
	`fşo£
(
å2
);

923 
	`ä“_image
(
im1
);

924 
	`ä“_image
(
im2
);

926 if(
m
è
	`ä“
(
·ths
);

927  
d
;

928 
	}
}

930 
d©a
 
	$lßd_d©a_swag
(**
·ths
, 
n
, 
şas£s
, 
j™‹r
)

932 
šdex
 = 
	`¿nd
()%
n
;

933 *
¿ndom_·th
 = 
·ths
[
šdex
];

935 
image
 
Üig
 = 
	`lßd_image_cŞÜ
(
¿ndom_·th
, 0, 0);

936 
h
 = 
Üig
.h;

937 
w
 = 
Üig
.w;

939 
d©a
 
d
 = {0};

940 
d
.
sh®low
 = 0;

941 
d
.
w
 = w;

942 
d
.
h
 = h;

944 
d
.
X
.
rows
 = 1;

945 
d
.
X
.
v®s
 = 
	`ÿÎoc
(d.X.
rows
, (*));

946 
d
.
X
.
cŞs
 = 
h
*
w
*3;

948 
k
 = (4+
şas£s
)*90;

949 
d
.
y
 = 
	`make_m©rix
(1, 
k
);

951 
dw
 = 
w
*
j™‹r
;

952 
dh
 = 
h
*
j™‹r
;

954 
¶eá
 = 
	`¿nd_unifÜm
(-
dw
, dw);

955 
´ight
 = 
	`¿nd_unifÜm
(-
dw
, dw);

956 
±İ
 = 
	`¿nd_unifÜm
(-
dh
, dh);

957 
pbÙ
 = 
	`¿nd_unifÜm
(-
dh
, dh);

959 
swidth
 = 
w
 - 
¶eá
 - 
´ight
;

960 
sheight
 = 
h
 - 
±İ
 - 
pbÙ
;

962 
sx
 = ()
swidth
 / 
w
;

963 
sy
 = ()
sheight
 / 
h
;

965 
æ
 = 
	`¿nd
()%2;

966 
image
 
üİ³d
 = 
	`üİ_image
(
Üig
, 
¶eá
, 
±İ
, 
swidth
, 
sheight
);

968 
dx
 = (()
¶eá
/
w
)/
sx
;

969 
dy
 = (()
±İ
 /
h
)/
sy
;

971 
image
 
sized
 = 
	`»size_image
(
üİ³d
, 
w
, 
h
);

972 if(
æ
è
	`æ_image
(
sized
);

973 
d
.
X
.
v®s
[0] = 
sized
.
d©a
;

975 
	`fl_Œuth_swag
(
¿ndom_·th
, 
d
.
y
.
v®s
[0], 
şas£s
, 
æ
, 
dx
, 
dy
, 1./
sx
, 1./
sy
);

977 
	`ä“_image
(
Üig
);

978 
	`ä“_image
(
üİ³d
);

980  
d
;

981 
	}
}

983 
d©a
 
	$lßd_d©a_d‘eùiÚ
(
n
, **
·ths
, 
m
, 
w
, 
h
, 
boxes
, 
şas£s
, 
j™‹r
, 
hue
, 
§tu¿tiÚ
, 
exposu»
)

985 **
¿ndom_·ths
 = 
	`g‘_¿ndom_·ths
(
·ths
, 
n
, 
m
);

986 
i
;

987 
d©a
 
d
 = {0};

988 
d
.
sh®low
 = 0;

990 
d
.
X
.
rows
 = 
n
;

991 
d
.
X
.
v®s
 = 
	`ÿÎoc
(d.X.
rows
, (*));

992 
d
.
X
.
cŞs
 = 
h
*
w
*3;

994 
d
.
y
 = 
	`make_m©rix
(
n
, 5*
boxes
);

995 
i
 = 0; i < 
n
; ++i){

996 
image
 
Üig
 = 
	`lßd_image_cŞÜ
(
¿ndom_·ths
[
i
], 0, 0);

997 
image
 
sized
 = 
	`make_image
(
w
, 
h
, 
Üig
.
c
);

998 
	`fl_image
(
sized
, .5);

1000 
dw
 = 
j™‹r
 * 
Üig
.
w
;

1001 
dh
 = 
j™‹r
 * 
Üig
.
h
;

1003 
Ãw_¬
 = (
Üig
.
w
 + 
	`¿nd_unifÜm
(-
dw
, dw)è/ (Üig.
h
 +„ªd_unifÜm(-
dh
, dh));

1004 
sÿË
 = 
	`¿nd_unifÜm
(.25, 2);

1006 
nw
, 
nh
;

1008 if(
Ãw_¬
 < 1){

1009 
nh
 = 
sÿË
 * 
h
;

1010 
nw
 = 
nh
 * 
Ãw_¬
;

1012 
nw
 = 
sÿË
 * 
w
;

1013 
nh
 = 
nw
 / 
Ãw_¬
;

1016 
dx
 = 
	`¿nd_unifÜm
(0, 
w
 - 
nw
);

1017 
dy
 = 
	`¿nd_unifÜm
(0, 
h
 - 
nh
);

1019 
	`¶aû_image
(
Üig
, 
nw
, 
nh
, 
dx
, 
dy
, 
sized
);

1021 
	`¿ndom_di¡Üt_image
(
sized
, 
hue
, 
§tu¿tiÚ
, 
exposu»
);

1023 
æ
 = 
	`¿nd
()%2;

1024 if(
æ
è
	`æ_image
(
sized
);

1025 
d
.
X
.
v®s
[
i
] = 
sized
.
d©a
;

1028 
	`fl_Œuth_d‘eùiÚ
(
¿ndom_·ths
[
i
], 
boxes
, 
d
.
y
.
v®s
[i], 
şas£s
, 
æ
, -
dx
/
w
, -
dy
/
h
, 
nw
/w, 
nh
/h);

1030 
	`ä“_image
(
Üig
);

1032 
	`ä“
(
¿ndom_·ths
);

1033  
d
;

1034 
	}
}

1036 *
	$lßd_th»ad
(*
±r
)

1039 
lßd_¬gs
 
a
 = *(lßd_¬gs*)
±r
;

1040 if(
a
.
exposu»
 == 0)‡.exposure = 1;

1041 if(
a
.
§tu¿tiÚ
 == 0)‡.saturation = 1;

1042 if(
a
.
a¥eù
 == 0)‡.aspect = 1;

1044 ià(
a
.
ty³
 =ğ
OLD_CLASSIFICATION_DATA
){

1045 *
a
.
d
 = 
	`lßd_d©a_Şd
×.
·ths
,‡.
n
,‡.
m
,‡.
Ïb–s
,‡.
şas£s
,‡.
w
,‡.
h
);

1046 } ià(
a
.
ty³
 =ğ
REGRESSION_DATA
){

1047 *
a
.
d
 = 
	`lßd_d©a_»g»ssiÚ
×.
·ths
,‡.
n
,‡.
m
,‡.
şas£s
,‡.
mš
,‡.
max
,‡.
size
,‡.
ªgË
,‡.
a¥eù
,‡.
hue
,‡.
§tu¿tiÚ
,‡.
exposu»
);

1048 } ià(
a
.
ty³
 =ğ
CLASSIFICATION_DATA
){

1049 *
a
.
d
 = 
	`lßd_d©a_augm’t
×.
·ths
,‡.
n
,‡.
m
,‡.
Ïb–s
,‡.
şas£s
,‡.
h›¿rchy
,‡.
mš
,‡.
max
,‡.
size
,‡.
ªgË
,‡.
a¥eù
,‡.
hue
,‡.
§tu¿tiÚ
,‡.
exposu»
,‡.
ûÁ”
);

1050 } ià(
a
.
ty³
 =ğ
SUPER_DATA
){

1051 *
a
.
d
 = 
	`lßd_d©a_su³r
×.
·ths
,‡.
n
,‡.
m
,‡.
w
,‡.
h
,‡.
sÿË
);

1052 } ià(
a
.
ty³
 =ğ
WRITING_DATA
){

1053 *
a
.
d
 = 
	`lßd_d©a_wr™šg
×.
·ths
,‡.
n
,‡.
m
,‡.
w
,‡.
h
,‡.
out_w
,‡.
out_h
);

1054 } ià(
a
.
ty³
 =ğ
INSTANCE_DATA
){

1055 *
a
.
d
 = 
	`lßd_d©a_i£g
×.
n
,‡.
·ths
,‡.
m
,‡.
w
,‡.
h
,‡.
şas£s
,‡.
num_boxes
,‡.
coÜds
,‡.
mš
,‡.
max
,‡.
ªgË
,‡.
a¥eù
,‡.
hue
,‡.
§tu¿tiÚ
,‡.
exposu»
);

1056 } ià(
a
.
ty³
 =ğ
SEGMENTATION_DATA
){

1057 *
a
.
d
 = 
	`lßd_d©a_£g
×.
n
,‡.
·ths
,‡.
m
,‡.
w
,‡.
h
,‡.
şas£s
,‡.
mš
,‡.
max
,‡.
ªgË
,‡.
a¥eù
,‡.
hue
,‡.
§tu¿tiÚ
,‡.
exposu»
,‡.
sÿË
);

1058 } ià(
a
.
ty³
 =ğ
REGION_DATA
){

1059 *
a
.
d
 = 
	`lßd_d©a_»giÚ
×.
n
,‡.
·ths
,‡.
m
,‡.
w
,‡.
h
,‡.
num_boxes
,‡.
şas£s
,‡.
j™‹r
,‡.
hue
,‡.
§tu¿tiÚ
,‡.
exposu»
);

1060 } ià(
a
.
ty³
 =ğ
DETECTION_DATA
){

1061 *
a
.
d
 = 
	`lßd_d©a_d‘eùiÚ
×.
n
,‡.
·ths
,‡.
m
,‡.
w
,‡.
h
,‡.
num_boxes
,‡.
şas£s
,‡.
j™‹r
,‡.
hue
,‡.
§tu¿tiÚ
,‡.
exposu»
);

1062 } ià(
a
.
ty³
 =ğ
SWAG_DATA
){

1063 *
a
.
d
 = 
	`lßd_d©a_swag
×.
·ths
,‡.
n
,‡.
şas£s
,‡.
j™‹r
);

1064 } ià(
a
.
ty³
 =ğ
COMPARE_DATA
){

1065 *
a
.
d
 = 
	`lßd_d©a_com·»
×.
n
,‡.
·ths
,‡.
m
,‡.
şas£s
,‡.
w
,‡.
h
);

1066 } ià(
a
.
ty³
 =ğ
IMAGE_DATA
){

1067 *(
a
.
im
èğ
	`lßd_image_cŞÜ
×.
·th
, 0, 0);

1068 *(
a
.
»sized
èğ
	`»size_image
(*×.
im
),‡.
w
,‡.
h
);

1069 } ià(
a
.
ty³
 =ğ
LETTERBOX_DATA
){

1070 *(
a
.
im
èğ
	`lßd_image_cŞÜ
×.
·th
, 0, 0);

1071 *(
a
.
»sized
èğ
	`Ë‰”box_image
(*×.
im
),‡.
w
,‡.
h
);

1072 } ià(
a
.
ty³
 =ğ
TAG_DATA
){

1073 *
a
.
d
 = 
	`lßd_d©a_g
×.
·ths
,‡.
n
,‡.
m
,‡.
şas£s
,‡.
mš
,‡.
max
,‡.
size
,‡.
ªgË
,‡.
a¥eù
,‡.
hue
,‡.
§tu¿tiÚ
,‡.
exposu»
);

1075 
	`ä“
(
±r
);

1077 
	}
}

1079 
±h»ad_t
 
	$lßd_d©a_š_th»ad
(
lßd_¬gs
 
¬gs
)

1081 
±h»ad_t
 
th»ad
;

1082 
lßd_¬gs
 *
±r
 = 
	`ÿÎoc
(1, (load_args));

1083 *
±r
 = 
¬gs
;

1084 if(
	`±h»ad_ü—‹
(&
th»ad
, 0, 
lßd_th»ad
, 
±r
)è
	`”rÜ
("Thread creation failed");

1085  
th»ad
;

1086 
	}
}

1088 *
	$lßd_th»ads
(*
±r
)

1090 
i
;

1091 
lßd_¬gs
 
¬gs
 = *Ößd_¬g *)
±r
;

1092 ià(
¬gs
.
th»ads
 == 0)‡rgs.threads = 1;

1093 
d©a
 *
out
 = 
¬gs
.
d
;

1094 
tÙ®
 = 
¬gs
.
n
;

1095 
	`ä“
(
±r
);

1096 
d©a
 *
bufãrs
 = 
	`ÿÎoc
(
¬gs
.
th»ads
, (data));

1097 
±h»ad_t
 *
th»ads
 = 
	`ÿÎoc
(
¬gs
.threads, (pthread_t));

1098 
i
 = 0; i < 
¬gs
.
th»ads
; ++i){

1099 
¬gs
.
d
 = 
bufãrs
 + 
i
;

1100 
¬gs
.
n
 = (
i
+1è* 
tÙ®
/¬gs.
th»ads
 - i *otal/args.threads;

1101 
th»ads
[
i
] = 
	`lßd_d©a_š_th»ad
(
¬gs
);

1103 
i
 = 0; i < 
¬gs
.
th»ads
; ++i){

1104 
	`±h»ad_još
(
th»ads
[
i
], 0);

1106 *
out
 = 
	`cÚÿt_d©as
(
bufãrs
, 
¬gs
.
th»ads
);

1107 
out
->
sh®low
 = 0;

1108 
i
 = 0; i < 
¬gs
.
th»ads
; ++i){

1109 
bufãrs
[
i
].
sh®low
 = 1;

1110 
	`ä“_d©a
(
bufãrs
[
i
]);

1112 
	`ä“
(
bufãrs
);

1113 
	`ä“
(
th»ads
);

1115 
	}
}

1117 
	$lßd_d©a_blockšg
(
lßd_¬gs
 
¬gs
)

1119 
lßd_¬gs
 *
±r
 = 
	`ÿÎoc
(1, (load_args));

1120 *
±r
 = 
¬gs
;

1121 
	`lßd_th»ad
(
±r
);

1122 
	}
}

1124 
±h»ad_t
 
	$lßd_d©a
(
lßd_¬gs
 
¬gs
)

1126 
±h»ad_t
 
th»ad
;

1127 
lßd_¬gs
 *
±r
 = 
	`ÿÎoc
(1, (load_args));

1128 *
±r
 = 
¬gs
;

1129 if(
	`±h»ad_ü—‹
(&
th»ad
, 0, 
lßd_th»ads
, 
±r
)è
	`”rÜ
("Thread creation failed");

1130  
th»ad
;

1131 
	}
}

1133 
d©a
 
	$lßd_d©a_wr™šg
(**
·ths
, 
n
, 
m
, 
w
, 
h
, 
out_w
, 
out_h
)

1135 if(
m
è
·ths
 = 
	`g‘_¿ndom_·ths
Õ©hs, 
n
, m);

1136 **
»¶aû_·ths
 = 
	`fšd_»¶aû_·ths
(
·ths
, 
n
, ".png", "-label.png");

1137 
d©a
 
d
 = {0};

1138 
d
.
sh®low
 = 0;

1139 
d
.
X
 = 
	`lßd_image_·ths
(
·ths
, 
n
, 
w
, 
h
);

1140 
d
.
y
 = 
	`lßd_image_·ths_g¿y
(
»¶aû_·ths
, 
n
, 
out_w
, 
out_h
);

1141 if(
m
è
	`ä“
(
·ths
);

1142 
i
;

1143 
i
 = 0; i < 
n
; ++iè
	`ä“
(
»¶aû_·ths
[i]);

1144 
	`ä“
(
»¶aû_·ths
);

1145  
d
;

1146 
	}
}

1148 
d©a
 
	$lßd_d©a_Şd
(**
·ths
, 
n
, 
m
, **
Ïb–s
, 
k
, 
w
, 
h
)

1150 if(
m
è
·ths
 = 
	`g‘_¿ndom_·ths
Õ©hs, 
n
, m);

1151 
d©a
 
d
 = {0};

1152 
d
.
sh®low
 = 0;

1153 
d
.
X
 = 
	`lßd_image_·ths
(
·ths
, 
n
, 
w
, 
h
);

1154 
d
.
y
 = 
	`lßd_Ïb–s_·ths
(
·ths
, 
n
, 
Ïb–s
, 
k
, 0);

1155 if(
m
è
	`ä“
(
·ths
);

1156  
d
;

1157 
	}
}

1160 
d©a
 
	$lßd_d©a_uÃt
(**
·ths
, 
n
, 
m
, **
Ïb–s
, 
w
, 
h
)

1162 
·th_Ïb–s
* 
·th_Ïbs
;

1163 
·th_Ïbs
 = 
	`g‘_¿ndom_·ths_Ïb–s
(
·ths
, 
Ïb–s
, 
n
, 
m
);

1164 
d©a
 
d
 = {0};

1165 
d
.
sh®low
 = 0;

1166 
d
.
X
 = 
	`lßd_image_·ths
(
·th_Ïbs
->
¿ndom_·ths
, 
n
, 
w
, 
h
);

1167 
d
.
y
 = 
	`lßd_image_·ths_g¿y
(
·th_Ïbs
->
¿ndom_Ïb–s
, 
n
, 
w
, 
h
);

1168 if(
m
è
	`ä“
(
·ths
);

1169  
d
;

1170 
	}
}

1186 
d©a
 
	$lßd_d©a_su³r
(**
·ths
, 
n
, 
m
, 
w
, 
h
, 
sÿË
)

1188 if(
m
è
·ths
 = 
	`g‘_¿ndom_·ths
Õ©hs, 
n
, m);

1189 
d©a
 
d
 = {0};

1190 
d
.
sh®low
 = 0;

1192 
i
;

1193 
d
.
X
.
rows
 = 
n
;

1194 
d
.
X
.
v®s
 = 
	`ÿÎoc
(
n
, (*));

1195 
d
.
X
.
cŞs
 = 
w
*
h
*3;

1197 
d
.
y
.
rows
 = 
n
;

1198 
d
.
y
.
v®s
 = 
	`ÿÎoc
(
n
, (*));

1199 
d
.
y
.
cŞs
 = 
w
*
sÿË
 * 
h
*scale * 3;

1201 
i
 = 0; i < 
n
; ++i){

1202 
image
 
im
 = 
	`lßd_image_cŞÜ
(
·ths
[
i
], 0, 0);

1203 
image
 
üİ
 = 
	`¿ndom_üİ_image
(
im
, 
w
*
sÿË
, 
h
*scale);

1204 
æ
 = 
	`¿nd
()%2;

1205 ià(
æ
è
	`æ_image
(
üİ
);

1206 
image
 
»size
 = 
	`»size_image
(
üİ
, 
w
, 
h
);

1207 
d
.
X
.
v®s
[
i
] = 
»size
.
d©a
;

1208 
d
.
y
.
v®s
[
i
] = 
üİ
.
d©a
;

1209 
	`ä“_image
(
im
);

1212 if(
m
è
	`ä“
(
·ths
);

1213  
d
;

1214 
	}
}

1216 
d©a
 
	$lßd_d©a_»g»ssiÚ
(**
·ths
, 
n
, 
m
, 
k
, 
mš
, 
max
, 
size
, 
ªgË
, 
a¥eù
, 
hue
, 
§tu¿tiÚ
, 
exposu»
)

1218 if(
m
è
·ths
 = 
	`g‘_¿ndom_·ths
Õ©hs, 
n
, m);

1219 
d©a
 
d
 = {0};

1220 
d
.
sh®low
 = 0;

1221 
d
.
X
 = 
	`lßd_image_augm’t_·ths
(
·ths
, 
n
, 
mš
, 
max
, 
size
, 
ªgË
, 
a¥eù
, 
hue
, 
§tu¿tiÚ
, 
exposu»
, 0);

1222 
d
.
y
 = 
	`lßd_»g»ssiÚ_Ïb–s_·ths
(
·ths
, 
n
, 
k
);

1223 if(
m
è
	`ä“
(
·ths
);

1224  
d
;

1225 
	}
}

1227 
d©a
 
	$£Ëù_d©a
(
d©a
 *
Üig
, *
šds
)

1229 
d©a
 
d
 = {0};

1230 
d
.
sh®low
 = 1;

1231 
d
.
w
 = 
Üig
[0].w;

1232 
d
.
h
 = 
Üig
[0].h;

1234 
d
.
X
.
rows
 = 
Üig
[0].X.rows;

1235 
d
.
y
.
rows
 = 
Üig
[0].
X
.rows;

1237 
d
.
X
.
cŞs
 = 
Üig
[0].X.cols;

1238 
d
.
y
.
cŞs
 = 
Üig
[0].y.cols;

1240 
d
.
X
.
v®s
 = 
	`ÿÎoc
(
Üig
[0].X.
rows
, (*));

1241 
d
.
y
.
v®s
 = 
	`ÿÎoc
(
Üig
[0].y.
rows
, (*));

1242 
i
;

1243 
i
 = 0; i < 
d
.
X
.
rows
; ++i){

1244 
d
.
X
.
v®s
[
i
] = 
Üig
[
šds
[i]].X.vals[i];

1245 
d
.
y
.
v®s
[
i
] = 
Üig
[
šds
[i]].y.vals[i];

1247  
d
;

1248 
	}
}

1250 
d©a
 *
	$te_d©a
(
d©a
 
Üig
, 
divs
, 
size
)

1252 
d©a
 *
ds
 = 
	`ÿÎoc
(
divs
*divs, (data));

1253 
i
, 
j
;

1254 #´agm¨
omp
 
·¿Î–
 

1255 
i
 = 0; i < 
divs
*divs; ++i){

1256 
d©a
 
d
;

1257 
d
.
sh®low
 = 0;

1258 
d
.
w
 = 
Üig
.w/
divs
 * 
size
;

1259 
d
.
h
 = 
Üig
.h/
divs
 * 
size
;

1260 
d
.
X
.
rows
 = 
Üig
.X.rows;

1261 
d
.
X
.
cŞs
 = d.
w
*d.
h
*3;

1262 
d
.
X
.
v®s
 = 
	`ÿÎoc
(d.X.
rows
, (*));

1264 
d
.
y
 = 
	`cİy_m©rix
(
Üig
.y);

1265 #´agm¨
omp
 
·¿Î–
 

1266 
j
 = 0; j < 
Üig
.
X
.
rows
; ++j){

1267 
x
 = (
i
%
divs
è* 
Üig
.
w
 / div - (
d
.w - orig.w/divs)/2;

1268 
y
 = (
i
/
divs
è* 
Üig
.
h
 / div - (
d
.h - orig.h/divs)/2;

1269 
image
 
im
 = 
	`æßt_to_image
(
Üig
.
w
, orig.
h
, 3, orig.
X
.
v®s
[
j
]);

1270 
d
.
X
.
v®s
[
j
] = 
	`üİ_image
(
im
, 
x
, 
y
, d.
w
, d.
h
).
d©a
;

1272 
ds
[
i
] = 
d
;

1274  
ds
;

1275 
	}
}

1277 
d©a
 
	$»size_d©a
(
d©a
 
Üig
, 
w
, 
h
)

1279 
d©a
 
d
 = {0};

1280 
d
.
sh®low
 = 0;

1281 
d
.
w
 = w;

1282 
d
.
h
 = h;

1283 
i
;

1284 
d
.
X
.
rows
 = 
Üig
.X.rows;

1285 
d
.
X
.
cŞs
 = 
w
*
h
*3;

1286 
d
.
X
.
v®s
 = 
	`ÿÎoc
(d.X.
rows
, (*));

1288 
d
.
y
 = 
	`cİy_m©rix
(
Üig
.y);

1289 #´agm¨
omp
 
·¿Î–
 

1290 
i
 = 0; i < 
Üig
.
X
.
rows
; ++i){

1291 
image
 
im
 = 
	`æßt_to_image
(
Üig
.
w
, orig.
h
, 3, orig.
X
.
v®s
[
i
]);

1292 
d
.
X
.
v®s
[
i
] = 
	`»size_image
(
im
, 
w
, 
h
).
d©a
;

1294  
d
;

1295 
	}
}

1297 
d©a
 
	$lßd_d©a_augm’t
(**
·ths
, 
n
, 
m
, **
Ïb–s
, 
k
, 
Œ“
 *
h›¿rchy
, 
mš
, 
max
, 
size
, 
ªgË
, 
a¥eù
, 
hue
, 
§tu¿tiÚ
, 
exposu»
, 
ûÁ”
)

1299 if(
m
è
·ths
 = 
	`g‘_¿ndom_·ths
Õ©hs, 
n
, m);

1300 
d©a
 
d
 = {0};

1301 
d
.
sh®low
 = 0;

1302 
d
.
w
=
size
;

1303 
d
.
h
=
size
;

1304 
d
.
X
 = 
	`lßd_image_augm’t_·ths
(
·ths
, 
n
, 
mš
, 
max
, 
size
, 
ªgË
, 
a¥eù
, 
hue
, 
§tu¿tiÚ
, 
exposu»
, 
ûÁ”
);

1305 
d
.
y
 = 
	`lßd_Ïb–s_·ths
(
·ths
, 
n
, 
Ïb–s
, 
k
, 
h›¿rchy
);

1306 if(
m
è
	`ä“
(
·ths
);

1307  
d
;

1308 
	}
}

1310 
d©a
 
	$lßd_d©a_g
(**
·ths
, 
n
, 
m
, 
k
, 
mš
, 
max
, 
size
, 
ªgË
, 
a¥eù
, 
hue
, 
§tu¿tiÚ
, 
exposu»
)

1312 if(
m
è
·ths
 = 
	`g‘_¿ndom_·ths
Õ©hs, 
n
, m);

1313 
d©a
 
d
 = {0};

1314 
d
.
w
 = 
size
;

1315 
d
.
h
 = 
size
;

1316 
d
.
sh®low
 = 0;

1317 
d
.
X
 = 
	`lßd_image_augm’t_·ths
(
·ths
, 
n
, 
mš
, 
max
, 
size
, 
ªgË
, 
a¥eù
, 
hue
, 
§tu¿tiÚ
, 
exposu»
, 0);

1318 
d
.
y
 = 
	`lßd_gs_·ths
(
·ths
, 
n
, 
k
);

1319 if(
m
è
	`ä“
(
·ths
);

1320  
d
;

1321 
	}
}

1323 
m©rix
 
	$cÚÿt_m©rix
(
m©rix
 
m1
, m©rix 
m2
)

1325 
i
, 
couÁ
 = 0;

1326 
m©rix
 
m
;

1327 
m
.
cŞs
 = 
m1
.cols;

1328 
m
.
rows
 = 
m1
.rows+
m2
.rows;

1329 
m
.
v®s
 = 
	`ÿÎoc
(
m1
.
rows
 + 
m2
.rows, (*));

1330 
i
 = 0; i < 
m1
.
rows
; ++i){

1331 
m
.
v®s
[
couÁ
++] = 
m1
.v®s[
i
];

1333 
i
 = 0; i < 
m2
.
rows
; ++i){

1334 
m
.
v®s
[
couÁ
++] = 
m2
.v®s[
i
];

1336  
m
;

1337 
	}
}

1339 
d©a
 
	$cÚÿt_d©a
(
d©a
 
d1
, d©¨
d2
)

1341 
d©a
 
d
 = {0};

1342 
d
.
sh®low
 = 1;

1343 
d
.
X
 = 
	`cÚÿt_m©rix
(
d1
.X, 
d2
.X);

1344 
d
.
y
 = 
	`cÚÿt_m©rix
(
d1
.y, 
d2
.y);

1345 
d
.
w
 = 
d1
.w;

1346 
d
.
h
 = 
d1
.h;

1347  
d
;

1348 
	}
}

1350 
d©a
 
	$cÚÿt_d©as
(
d©a
 *
d
, 
n
)

1352 
i
;

1353 
d©a
 
out
 = {0};

1354 
i
 = 0; i < 
n
; ++i){

1355 
d©a
 
Ãw
 = 
	`cÚÿt_d©a
(
d
[
i
], 
out
);

1356 
	`ä“_d©a
(
out
);

1357 
out
 = 
Ãw
;

1359  
out
;

1360 
	}
}

1362 
d©a
 
	$lßd_ÿ‹gÜiÿl_d©a_csv
(*
f’ame
, 
rg‘
, 
k
)

1364 
d©a
 
d
 = {0};

1365 
d
.
sh®low
 = 0;

1366 
m©rix
 
X
 = 
	`csv_to_m©rix
(
f’ame
);

1367 *
Œuth_1d
 = 
	`pİ_cŞumn
(&
X
, 
rg‘
);

1368 **
Œuth
 = 
	`Úe_hÙ_’code
(
Œuth_1d
, 
X
.
rows
, 
k
);

1369 
m©rix
 
y
;

1370 
y
.
rows
 = 
X
.rows;

1371 
y
.
cŞs
 = 
k
;

1372 
y
.
v®s
 = 
Œuth
;

1373 
d
.
X
 = X;

1374 
d
.
y
 = y;

1375 
	`ä“
(
Œuth_1d
);

1376  
d
;

1377 
	}
}

1379 
d©a
 
	$lßd_ciçr10_d©a
(*
f’ame
)

1381 
d©a
 
d
 = {0};

1382 
d
.
sh®low
 = 0;

1383 
i
,
j
;

1384 
m©rix
 
X
 = 
	`make_m©rix
(10000, 3072);

1385 
m©rix
 
y
 = 
	`make_m©rix
(10000, 10);

1386 
d
.
X
 = X;

1387 
d
.
y
 = y;

1389 
FILE
 *
å
 = 
	`fİ’
(
f’ame
, "rb");

1390 if(!
å
è
	`fe_”rÜ
(
f’ame
);

1391 
i
 = 0; i < 10000; ++i){

1392 
by‹s
[3073];

1393 
	`ä—d
(
by‹s
, 1, 3073, 
å
);

1394 
şass
 = 
by‹s
[0];

1395 
y
.
v®s
[
i
][
şass
] = 1;

1396 
j
 = 0; j < 
X
.
cŞs
; ++j){

1397 
X
.
v®s
[
i
][
j
] = ()
by‹s
[j+1];

1400 
	`sÿË_d©a_rows
(
d
, 1./255);

1402 
	`fşo£
(
å
);

1403  
d
;

1404 
	}
}

1406 
	$g‘_¿ndom_b©ch
(
d©a
 
d
, 
n
, *
X
, *
y
)

1408 
j
;

1409 
j
 = 0; j < 
n
; ++j){

1410 
šdex
 = 
	`¿nd
()%
d
.
X
.
rows
;

1411 
	`memıy
(
X
+
j
*
d
.X.
cŞs
, d.X.
v®s
[
šdex
], d.X.cols*());

1412 
	`memıy
(
y
+
j
*
d
.y.
cŞs
, d.y.
v®s
[
šdex
], d.y.cols*());

1414 
	}
}

1416 
	$g‘_Ãxt_b©ch
(
d©a
 
d
, 
n
, 
off£t
, *
X
, *
y
)

1418 
j
;

1419 
j
 = 0; j < 
n
; ++j){

1420 
šdex
 = 
off£t
 + 
j
;

1421 
	`memıy
(
X
+
j
*
d
.X.
cŞs
, d.X.
v®s
[
šdex
], d.X.cols*());

1422 if(
y
è
	`memıy
(y+
j
*
d
.y.
cŞs
, d.y.
v®s
[
šdex
], d.y.cols*());

1424 
	}
}

1426 
	$smoÙh_d©a
(
d©a
 
d
)

1428 
i
, 
j
;

1429 
sÿË
 = 1. / 
d
.
y
.
cŞs
;

1430 
•s
 = .1;

1431 
i
 = 0; i < 
d
.
y
.
rows
; ++i){

1432 
j
 = 0; j < 
d
.
y
.
cŞs
; ++j){

1433 
d
.
y
.
v®s
[
i
][
j
] = 
•s
 * 
sÿË
 + (1-eps) * d.y.vals[i][j];

1436 
	}
}

1438 
d©a
 
	$lßd_®l_ciçr10
()

1440 
d©a
 
d
 = {0};

1441 
d
.
sh®low
 = 0;

1442 
i
,
j
,
b
;

1443 
m©rix
 
X
 = 
	`make_m©rix
(50000, 3072);

1444 
m©rix
 
y
 = 
	`make_m©rix
(50000, 10);

1445 
d
.
X
 = X;

1446 
d
.
y
 = y;

1448 
b
 = 0; b < 5; ++b){

1449 
buff
[256];

1450 
	`¥rštf
(
buff
, "d©a/ciçr/ciçr-10-b©ches-bš/d©a_b©ch_%d.bš", 
b
+1);

1451 
FILE
 *
å
 = 
	`fİ’
(
buff
, "rb");

1452 if(!
å
è
	`fe_”rÜ
(
buff
);

1453 
i
 = 0; i < 10000; ++i){

1454 
by‹s
[3073];

1455 
	`ä—d
(
by‹s
, 1, 3073, 
å
);

1456 
şass
 = 
by‹s
[0];

1457 
y
.
v®s
[
i
+
b
*10000][
şass
] = 1;

1458 
j
 = 0; j < 
X
.
cŞs
; ++j){

1459 
X
.
v®s
[
i
+
b
*10000][
j
] = ()
by‹s
[j+1];

1462 
	`fşo£
(
å
);

1465 
	`sÿË_d©a_rows
(
d
, 1./255);

1466 
	`smoÙh_d©a
(
d
);

1467  
d
;

1468 
	}
}

1470 
d©a
 
	$lßd_go
(*
f’ame
)

1472 
FILE
 *
å
 = 
	`fİ’
(
f’ame
, "rb");

1473 
m©rix
 
X
 = 
	`make_m©rix
(3363059, 361);

1474 
m©rix
 
y
 = 
	`make_m©rix
(3363059, 361);

1475 
row
, 
cŞ
;

1477 if(!
å
è
	`fe_”rÜ
(
f’ame
);

1478 *
Ïb–
;

1479 
couÁ
 = 0;

1480 (
Ïb–
 = 
	`fg‘l
(
å
))){

1481 
i
;

1482 if(
couÁ
 =ğ
X
.
rows
){

1483 
X
 = 
	`»size_m©rix
(X, 
couÁ
*2);

1484 
y
 = 
	`»size_m©rix
(y, 
couÁ
*2);

1486 
	`ssÿnf
(
Ïb–
, "%d %d", &
row
, &
cŞ
);

1487 *
bßrd
 = 
	`fg‘l
(
å
);

1489 
šdex
 = 
row
*19 + 
cŞ
;

1490 
y
.
v®s
[
couÁ
][
šdex
] = 1;

1492 
i
 = 0; i < 19*19; ++i){

1493 
v®
 = 0;

1494 if(
bßrd
[
i
] =ğ'1'è
v®
 = 1;

1495 if(
bßrd
[
i
] =ğ'2'è
v®
 = -1;

1496 
X
.
v®s
[
couÁ
][
i
] = 
v®
;

1498 ++
couÁ
;

1499 
	`ä“
(
Ïb–
);

1500 
	`ä“
(
bßrd
);

1502 
X
 = 
	`»size_m©rix
(X, 
couÁ
);

1503 
y
 = 
	`»size_m©rix
(y, 
couÁ
);

1505 
d©a
 
d
 = {0};

1506 
d
.
sh®low
 = 0;

1507 
d
.
X
 = X;

1508 
d
.
y
 = y;

1511 
	`fşo£
(
å
);

1513  
d
;

1514 
	}
}

1517 
	$¿ndomize_d©a
(
d©a
 
d
)

1519 
i
;

1520 
i
 = 
d
.
X
.
rows
-1; i > 0; --i){

1521 
šdex
 = 
	`¿nd
()%
i
;

1522 *
sw­
 = 
d
.
X
.
v®s
[
šdex
];

1523 
d
.
X
.
v®s
[
šdex
] = d.X.v®s[
i
];

1524 
d
.
X
.
v®s
[
i
] = 
sw­
;

1526 
sw­
 = 
d
.
y
.
v®s
[
šdex
];

1527 
d
.
y
.
v®s
[
šdex
] = d.y.v®s[
i
];

1528 
d
.
y
.
v®s
[
i
] = 
sw­
;

1530 
	}
}

1532 
	$sÿË_d©a_rows
(
d©a
 
d
, 
s
)

1534 
i
;

1535 
i
 = 0; i < 
d
.
X
.
rows
; ++i){

1536 
	`sÿË_¬¿y
(
d
.
X
.
v®s
[
i
], d.X.
cŞs
, 
s
);

1538 
	}
}

1540 
	$Œª¦©e_d©a_rows
(
d©a
 
d
, 
s
)

1542 
i
;

1543 
i
 = 0; i < 
d
.
X
.
rows
; ++i){

1544 
	`Œª¦©e_¬¿y
(
d
.
X
.
v®s
[
i
], d.X.
cŞs
, 
s
);

1546 
	}
}

1548 
d©a
 
	$cİy_d©a
(
d©a
 
d
)

1550 
d©a
 
c
 = {0};

1551 
c
.
w
 = 
d
.w;

1552 
c
.
h
 = 
d
.h;

1553 
c
.
sh®low
 = 0;

1554 
c
.
num_boxes
 = 
d
.num_boxes;

1555 
c
.
boxes
 = 
d
.boxes;

1556 
c
.
X
 = 
	`cİy_m©rix
(
d
.X);

1557 
c
.
y
 = 
	`cİy_m©rix
(
d
.y);

1558  
c
;

1559 
	}
}

1561 
	$nÜm®ize_d©a_rows
(
d©a
 
d
)

1563 
i
;

1564 
i
 = 0; i < 
d
.
X
.
rows
; ++i){

1565 
	`nÜm®ize_¬¿y
(
d
.
X
.
v®s
[
i
], d.X.
cŞs
);

1567 
	}
}

1569 
d©a
 
	$g‘_d©a_·¹
(
d©a
 
d
, 
·¹
, 
tÙ®
)

1571 
d©a
 
p
 = {0};

1572 
p
.
sh®low
 = 1;

1573 
p
.
X
.
rows
 = 
d
.X.row * (
·¹
 + 1è/ 
tÙ®
 - d.X.rows *…art /otal;

1574 
p
.
y
.
rows
 = 
d
.y.row * (
·¹
 + 1è/ 
tÙ®
 - d.y.rows *…art /otal;

1575 
p
.
X
.
cŞs
 = 
d
.X.cols;

1576 
p
.
y
.
cŞs
 = 
d
.y.cols;

1577 
p
.
X
.
v®s
 = 
d
.X.v® + d.X.
rows
 * 
·¹
 / 
tÙ®
;

1578 
p
.
y
.
v®s
 = 
d
.y.v® + d.y.
rows
 * 
·¹
 / 
tÙ®
;

1579  
p
;

1580 
	}
}

1582 
d©a
 
	$g‘_¿ndom_d©a
(
d©a
 
d
, 
num
)

1584 
d©a
 
r
 = {0};

1585 
r
.
sh®low
 = 1;

1587 
r
.
X
.
rows
 = 
num
;

1588 
r
.
y
.
rows
 = 
num
;

1590 
r
.
X
.
cŞs
 = 
d
.X.cols;

1591 
r
.
y
.
cŞs
 = 
d
.y.cols;

1593 
r
.
X
.
v®s
 = 
	`ÿÎoc
(
num
, (*));

1594 
r
.
y
.
v®s
 = 
	`ÿÎoc
(
num
, (*));

1596 
i
;

1597 
i
 = 0; i < 
num
; ++i){

1598 
šdex
 = 
	`¿nd
()%
d
.
X
.
rows
;

1599 
r
.
X
.
v®s
[
i
] = 
d
.X.v®s[
šdex
];

1600 
r
.
y
.
v®s
[
i
] = 
d
.y.v®s[
šdex
];

1602  
r
;

1603 
	}
}

1605 
d©a
 *
	$¥l™_d©a
(
d©a
 
d
, 
·¹
, 
tÙ®
)

1607 
d©a
 *
¥l™
 = 
	`ÿÎoc
(2, (data));

1608 
i
;

1609 
¡¬t
 = 
·¹
*
d
.
X
.
rows
/
tÙ®
;

1610 
’d
 = (
·¹
+1)*
d
.
X
.
rows
/
tÙ®
;

1611 
d©a
 
Œaš
;

1612 
d©a
 
‹¡
;

1613 
Œaš
.
sh®low
 = 
‹¡
.shallow = 1;

1615 
‹¡
.
X
.
rows
 =e¡.
y
.row ğ
’d
-
¡¬t
;

1616 
Œaš
.
X
.
rows
 =¿š.
y
.row ğ
d
.X.row - (
’d
-
¡¬t
);

1617 
Œaš
.
X
.
cŞs
 = 
‹¡
.X.cŞ ğ
d
.X.cols;

1618 
Œaš
.
y
.
cŞs
 = 
‹¡
.y.cŞ ğ
d
.y.cols;

1620 
Œaš
.
X
.
v®s
 = 
	`ÿÎoc
Ñ¿š.X.
rows
, (*));

1621 
‹¡
.
X
.
v®s
 = 
	`ÿÎoc
Ñe¡.X.
rows
, (*));

1622 
Œaš
.
y
.
v®s
 = 
	`ÿÎoc
Ñ¿š.y.
rows
, (*));

1623 
‹¡
.
y
.
v®s
 = 
	`ÿÎoc
Ñe¡.y.
rows
, (*));

1625 
i
 = 0; i < 
¡¬t
; ++i){

1626 
Œaš
.
X
.
v®s
[
i
] = 
d
.X.vals[i];

1627 
Œaš
.
y
.
v®s
[
i
] = 
d
.y.vals[i];

1629 
i
 = 
¡¬t
; i < 
’d
; ++i){

1630 
‹¡
.
X
.
v®s
[
i
-
¡¬t
] = 
d
.X.vals[i];

1631 
‹¡
.
y
.
v®s
[
i
-
¡¬t
] = 
d
.y.vals[i];

1633 
i
 = 
’d
; i < 
d
.
X
.
rows
; ++i){

1634 
Œaš
.
X
.
v®s
[
i
-(
’d
-
¡¬t
)] = 
d
.X.vals[i];

1635 
Œaš
.
y
.
v®s
[
i
-(
’d
-
¡¬t
)] = 
d
.y.vals[i];

1637 
¥l™
[0] = 
Œaš
;

1638 
¥l™
[1] = 
‹¡
;

1639  
¥l™
;

1640 
	}
}

	@data.h

1 #iâdeà
DATA_H


2 
	#DATA_H


	)

3 
	~<±h»ad.h
>

5 
	~"d¬kÃt.h
"

6 
	~"m©rix.h
"

7 
	~"li¡.h
"

8 
	~"image.h
"

9 
	~"Œ“.h
"

11 
šlše
 
	$di¡ªû_äom_edge
(
x
, 
max
)

13 
dx
 = (
max
/2è- 
x
;

14 ià(
dx
 < 0) dx = -dx;

15 
dx
 = (
max
/2) + 1 - dx;

16 
dx
 *= 2;

17 
di¡
 = ()
dx
/
max
;

18 ià(
di¡
 > 1) dist = 1;

19  
di¡
;

20 
	}
}

21 
lßd_d©a_blockšg
(
lßd_¬gs
 
¬gs
);

24 
´št_Ë‰”s
(*
´ed
, 
n
);

25 
d©a
 
lßd_d©a_ÿ±cha
(**
·ths
, 
n
, 
m
, 
k
, 
w
, 
h
);

26 
d©a
 
lßd_d©a_ÿ±cha_’code
(**
·ths
, 
n
, 
m
, 
w
, 
h
);

27 
d©a
 
lßd_d©a_d‘eùiÚ
(
n
, **
·ths
, 
m
, 
w
, 
h
, 
boxes
, 
şas£s
, 
j™‹r
, 
hue
, 
§tu¿tiÚ
, 
exposu»
);

28 
d©a
 
lßd_d©a_g
(**
·ths
, 
n
, 
m
, 
k
, 
mš
, 
max
, 
size
, 
ªgË
, 
a¥eù
, 
hue
, 
§tu¿tiÚ
, 
exposu»
);

29 
m©rix
 
lßd_image_augm’t_·ths
(**
·ths
, 
n
, 
mš
, 
max
, 
size
, 
ªgË
, 
a¥eù
, 
hue
, 
§tu¿tiÚ
, 
exposu»
, 
ûÁ”
);

30 
d©a
 
lßd_d©a_su³r
(**
·ths
, 
n
, 
m
, 
w
, 
h
, 
sÿË
);

31 
d©a
 
lßd_d©a_augm’t
(**
·ths
, 
n
, 
m
, **
Ïb–s
, 
k
, 
Œ“
 *
h›¿rchy
, 
mš
, 
max
, 
size
, 
ªgË
, 
a¥eù
, 
hue
, 
§tu¿tiÚ
, 
exposu»
, 
ûÁ”
);

32 
d©a
 
lßd_d©a_»g»ssiÚ
(**
·ths
, 
n
, 
m
, 
şas£s
, 
mš
, 
max
, 
size
, 
ªgË
, 
a¥eù
, 
hue
, 
§tu¿tiÚ
, 
exposu»
);

33 
d©a
 
lßd_go
(*
f’ame
);

34 
d©a
 
lßd_d©a_wr™šg
(**
·ths
, 
n
, 
m
, 
w
, 
h
, 
out_w
, 
out_h
);

37 
d©a
 
lßd_d©a_uÃt
(**
·ths
, 
n
, 
m
, **
Ïb–s
, 
w
, 
h
);

39 
g‘_¿ndom_b©ch
(
d©a
 
d
, 
n
, *
X
, *
y
);

40 
d©a
 
g‘_d©a_·¹
(d©¨
d
, 
·¹
, 
tÙ®
);

41 
d©a
 
g‘_¿ndom_d©a
(d©¨
d
, 
num
);

42 
d©a
 
lßd_ÿ‹gÜiÿl_d©a_csv
(*
f’ame
, 
rg‘
, 
k
);

43 
nÜm®ize_d©a_rows
(
d©a
 
d
);

44 
sÿË_d©a_rows
(
d©a
 
d
, 
s
);

45 
Œª¦©e_d©a_rows
(
d©a
 
d
, 
s
);

46 
¿ndomize_d©a
(
d©a
 
d
);

47 
d©a
 *
¥l™_d©a
(d©¨
d
, 
·¹
, 
tÙ®
);

48 
d©a
 
cÚÿt_d©as
(d©¨*
d
, 
n
);

49 
fl_Œuth
(*
·th
, **
Ïb–s
, 
k
, *
Œuth
);

	@deconvolutional_layer.c

1 
	~"decÚvŞutiÚ®_Ïy”.h
"

2 
	~"cÚvŞutiÚ®_Ïy”.h
"

3 
	~"b©chnÜm_Ïy”.h
"

4 
	~"uts.h
"

5 
	~"im2cŞ.h
"

6 
	~"cŞ2im.h
"

7 
	~"bÏs.h
"

8 
	~"gemm.h
"

10 
	~<¡dio.h
>

11 
	~<time.h
>

14 
size_t
 
	$g‘_wÜk¥aû_size
(
Ïy”
 
l
){

15  (
size_t
)
l
.
h
*l.
w
*l.
size
*l.size*l.
n
*();

16 
	}
}

18 
	$bš—r_š™
(
Ïy”
 
l
)

20 
i
,
j
,
f
;

21 
ûÁ”
 = (
l
.
size
-1) / 2.;

22 
f
 = 0; f < 
l
.
n
; ++f){

23 
j
 = 0; j < 
l
.
size
; ++j){

24 
i
 = 0; i < 
l
.
size
; ++i){

25 
v®
 = (1 - 
	`çbs
(
i
 - 
ûÁ”
)è* (1 - fabs(
j
 - center));

26 
c
 = 
f
%
l
.c;

27 
šd
 = 
f
*
l
.
size
*l.size*l.
c
 + c*l.size*l.siz+ 
j
*l.siz+ 
i
;

28 
l
.
weights
[
šd
] = 
v®
;

32 
	}
}

35 
Ïy”
 
	$make_decÚvŞutiÚ®_Ïy”
(
b©ch
, 
h
, 
w
, 
c
, 
n
, 
size
, 
¡ride
, 
·ddšg
, 
ACTIVATION
 
aùiv©iÚ
, 
b©ch_nÜm®ize
, 
adam
)

37 
i
;

38 
Ïy”
 
l
 = {0};

39 
l
.
ty³
 = 
DECONVOLUTIONAL
;

41 
l
.
h
 = h;

42 
l
.
w
 = w;

43 
l
.
c
 = c;

44 
l
.
n
 =‚;

45 
l
.
b©ch
 = batch;

46 
l
.
¡ride
 = stride;

47 
l
.
size
 = size;

49 
l
.
nweights
 = 
c
*
n
*
size
*size;

50 
l
.
nbŸ£s
 = 
n
;

52 
l
.
weights
 = 
	`ÿÎoc
(
c
*
n
*
size
*size, ());

53 
l
.
weight_upd©es
 = 
	`ÿÎoc
(
c
*
n
*
size
*size, ());

55 
l
.
bŸ£s
 = 
	`ÿÎoc
(
n
, ());

56 
l
.
bŸs_upd©es
 = 
	`ÿÎoc
(
n
, ());

59 
sÿË
 = .02;

60 
i
 = 0; i < 
c
*
n
*
size
*size; ++iè
l
.
weights
[i] = 
sÿË
*
	`¿nd_nÜm®
();

62 
i
 = 0; i < 
n
; ++i){

63 
l
.
bŸ£s
[
i
] = 0;

65 
l
.
·d
 = 
·ddšg
;

67 
l
.
out_h
 = (l.
h
 - 1è*†.
¡ride
 +†.
size
 - 2*l.
·d
;

68 
l
.
out_w
 = (l.
w
 - 1è*†.
¡ride
 +†.
size
 - 2*l.
·d
;

69 
l
.
out_c
 = 
n
;

70 
l
.
ouuts
 =†.
out_w
 *†.
out_h
 *†.
out_c
;

71 
l
.
šputs
 =†.
w
 *†.
h
 *†.
c
;

73 
	`sÿl_ıu
(
l
.
nweights
, (î.
out_w
*l.
out_h
/Ö.
w
*l.
h
),†.
weights
, 1);

75 
l
.
ouut
 = 
	`ÿÎoc
Ö.
b©ch
*l.
ouuts
, ());

76 
l
.
d–
 = 
	`ÿÎoc
Ö.
b©ch
*l.
ouuts
, ());

78 
l
.
fÜw¬d
 = 
fÜw¬d_decÚvŞutiÚ®_Ïy”
;

79 
l
.
backw¬d
 = 
backw¬d_decÚvŞutiÚ®_Ïy”
;

80 
l
.
upd©e
 = 
upd©e_decÚvŞutiÚ®_Ïy”
;

82 
l
.
b©ch_nÜm®ize
 = batch_normalize;

84 if(
b©ch_nÜm®ize
){

85 
l
.
sÿËs
 = 
	`ÿÎoc
(
n
, ());

86 
l
.
sÿË_upd©es
 = 
	`ÿÎoc
(
n
, ());

87 
i
 = 0; i < 
n
; ++i){

88 
l
.
sÿËs
[
i
] = 1;

91 
l
.
m—n
 = 
	`ÿÎoc
(
n
, ());

92 
l
.
v¬Ÿnû
 = 
	`ÿÎoc
(
n
, ());

94 
l
.
m—n_d–
 = 
	`ÿÎoc
(
n
, ());

95 
l
.
v¬Ÿnû_d–
 = 
	`ÿÎoc
(
n
, ());

97 
l
.
rŞlšg_m—n
 = 
	`ÿÎoc
(
n
, ());

98 
l
.
rŞlšg_v¬Ÿnû
 = 
	`ÿÎoc
(
n
, ());

99 
l
.
x
 = 
	`ÿÎoc
Ö.
b©ch
*l.
ouuts
, ());

100 
l
.
x_nÜm
 = 
	`ÿÎoc
Ö.
b©ch
*l.
ouuts
, ());

102 if(
adam
){

103 
l
.
m
 = 
	`ÿÎoc
(
c
*
n
*
size
*size, ());

104 
l
.
v
 = 
	`ÿÎoc
(
c
*
n
*
size
*size, ());

105 
l
.
bŸs_m
 = 
	`ÿÎoc
(
n
, ());

106 
l
.
sÿË_m
 = 
	`ÿÎoc
(
n
, ());

107 
l
.
bŸs_v
 = 
	`ÿÎoc
(
n
, ());

108 
l
.
sÿË_v
 = 
	`ÿÎoc
(
n
, ());

111 #ifdeà
GPU


112 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_decÚvŞutiÚ®_Ïy”_gpu
;

113 
l
.
backw¬d_gpu
 = 
backw¬d_decÚvŞutiÚ®_Ïy”_gpu
;

114 
l
.
upd©e_gpu
 = 
upd©e_decÚvŞutiÚ®_Ïy”_gpu
;

116 if(
gpu_šdex
 >= 0){

118 ià(
adam
) {

119 
l
.
m_gpu
 = 
	`cuda_make_¬¿y
Ö.
m
, 
c
*
n
*
size
*size);

120 
l
.
v_gpu
 = 
	`cuda_make_¬¿y
Ö.
v
, 
c
*
n
*
size
*size);

121 
l
.
bŸs_m_gpu
 = 
	`cuda_make_¬¿y
Ö.
bŸs_m
, 
n
);

122 
l
.
bŸs_v_gpu
 = 
	`cuda_make_¬¿y
Ö.
bŸs_v
, 
n
);

123 
l
.
sÿË_m_gpu
 = 
	`cuda_make_¬¿y
Ö.
sÿË_m
, 
n
);

124 
l
.
sÿË_v_gpu
 = 
	`cuda_make_¬¿y
Ö.
sÿË_v
, 
n
);

126 
l
.
weights_gpu
 = 
	`cuda_make_¬¿y
Ö.
weights
, 
c
*
n
*
size
*size);

127 
l
.
weight_upd©es_gpu
 = 
	`cuda_make_¬¿y
Ö.
weight_upd©es
, 
c
*
n
*
size
*size);

129 
l
.
bŸ£s_gpu
 = 
	`cuda_make_¬¿y
Ö.
bŸ£s
, 
n
);

130 
l
.
bŸs_upd©es_gpu
 = 
	`cuda_make_¬¿y
Ö.
bŸs_upd©es
, 
n
);

132 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
,†.
b©ch
*l.
out_h
*l.
out_w
*
n
);

133 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
,†.
b©ch
*l.
out_h
*l.
out_w
*
n
);

135 if(
b©ch_nÜm®ize
){

136 
l
.
m—n_gpu
 = 
	`cuda_make_¬¿y
(0, 
n
);

137 
l
.
v¬Ÿnû_gpu
 = 
	`cuda_make_¬¿y
(0, 
n
);

139 
l
.
rŞlšg_m—n_gpu
 = 
	`cuda_make_¬¿y
(0, 
n
);

140 
l
.
rŞlšg_v¬Ÿnû_gpu
 = 
	`cuda_make_¬¿y
(0, 
n
);

142 
l
.
m—n_d–_gpu
 = 
	`cuda_make_¬¿y
(0, 
n
);

143 
l
.
v¬Ÿnû_d–_gpu
 = 
	`cuda_make_¬¿y
(0, 
n
);

145 
l
.
sÿËs_gpu
 = 
	`cuda_make_¬¿y
Ö.
sÿËs
, 
n
);

146 
l
.
sÿË_upd©es_gpu
 = 
	`cuda_make_¬¿y
(0, 
n
);

148 
l
.
x_gpu
 = 
	`cuda_make_¬¿y
(0,†.
b©ch
*l.
out_h
*l.
out_w
*
n
);

149 
l
.
x_nÜm_gpu
 = 
	`cuda_make_¬¿y
(0,†.
b©ch
*l.
out_h
*l.
out_w
*
n
);

152 #ifdeà
CUDNN


153 
	`cudÂC»©eT’sÜDesütÜ
(&
l
.
d¡T’sÜDesc
);

154 
	`cudÂC»©eT’sÜDesütÜ
(&
l
.
nÜmT’sÜDesc
);

155 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
,†.
b©ch
,†.
out_c
,†.
out_h
,†.
out_w
);

156 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
nÜmT’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 1,†.
out_c
, 1, 1);

160 
l
.
aùiv©iÚ
 =‡ctivation;

161 
l
.
wÜk¥aû_size
 = 
	`g‘_wÜk¥aû_size
(l);

163 
	`årštf
(
¡d”r
, "decÚv%5d %2d x%2d /%2d %4d x%4d x%4d -> %4d x%4d x%4d\n", 
n
, 
size
, size, 
¡ride
, 
w
, 
h
, 
c
, 
l
.
out_w
,†.
out_h
,†.
out_c
);

165  
l
;

166 
	}
}

168 
	$d’Üm®ize_decÚvŞutiÚ®_Ïy”
(
Ïy”
 
l
)

170 
i
, 
j
;

171 
i
 = 0; i < 
l
.
n
; ++i){

172 
sÿË
 = 
l
.
sÿËs
[
i
]/
	`sq¹
Ö.
rŞlšg_v¬Ÿnû
[i] + .00001);

173 
j
 = 0; j < 
l
.
c
*l.
size
*l.size; ++j){

174 
l
.
weights
[
i
*l.
c
*l.
size
*l.siz+ 
j
] *ğ
sÿË
;

176 
l
.
bŸ£s
[
i
] -ğl.
rŞlšg_m—n
[i] * 
sÿË
;

177 
l
.
sÿËs
[
i
] = 1;

178 
l
.
rŞlšg_m—n
[
i
] = 0;

179 
l
.
rŞlšg_v¬Ÿnû
[
i
] = 1;

181 
	}
}

183 
	$»size_decÚvŞutiÚ®_Ïy”
(
Ïy”
 *
l
, 
h
, 
w
)

185 
l
->
h
 = h;

186 
l
->
w
 = w;

187 
l
->
out_h
 = (l->
h
 - 1è*†->
¡ride
 +†->
size
 - 2*l->
·d
;

188 
l
->
out_w
 = (l->
w
 - 1è*†->
¡ride
 +†->
size
 - 2*l->
·d
;

190 
l
->
ouuts
 =†->
out_h
 *†->
out_w
 *†->
out_c
;

191 
l
->
šputs
 =†->
w
 *†->
h
 *†->
c
;

193 
l
->
ouut
 = 
	`»®loc
Ö->ouut,†->
b©ch
*l->
ouuts
*());

194 
l
->
d–
 = 
	`»®loc
Ö->d–,†->
b©ch
*l->
ouuts
*());

195 if(
l
->
b©ch_nÜm®ize
){

196 
l
->
x
 = 
	`»®loc
Ö->x,†->
b©ch
*l->
ouuts
*());

197 
l
->
x_nÜm
 = 
	`»®loc
Ö->x_nÜm,†->
b©ch
*l->
ouuts
*());

200 #ifdeà
GPU


201 
	`cuda_ä“
(
l
->
d–_gpu
);

202 
	`cuda_ä“
(
l
->
ouut_gpu
);

204 
l
->
d–_gpu
 = 
	`cuda_make_¬¿y
Ö->
d–
,†->
b©ch
*l->
ouuts
);

205 
l
->
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö->
ouut
,†->
b©ch
*l->
ouuts
);

207 if(
l
->
b©ch_nÜm®ize
){

208 
	`cuda_ä“
(
l
->
x_gpu
);

209 
	`cuda_ä“
(
l
->
x_nÜm_gpu
);

211 
l
->
x_gpu
 = 
	`cuda_make_¬¿y
Ö->
ouut
,†->
b©ch
*l->
ouuts
);

212 
l
->
x_nÜm_gpu
 = 
	`cuda_make_¬¿y
Ö->
ouut
,†->
b©ch
*l->
ouuts
);

214 #ifdeà
CUDNN


215 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
,†->
b©ch
,†->
out_c
,†->
out_h
,†->
out_w
);

216 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
->
nÜmT’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 1,†->
out_c
, 1, 1);

219 
l
->
wÜk¥aû_size
 = 
	`g‘_wÜk¥aû_size
(*l);

220 
	}
}

222 
	$fÜw¬d_decÚvŞutiÚ®_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

224 
i
;

226 
m
 = 
l
.
size
*l.size*l.
n
;

227 
n
 = 
l
.
h
*l.
w
;

228 
k
 = 
l
.
c
;

230 
	`fl_ıu
(
l
.
ouuts
*l.
b©ch
, 0,†.
ouut
, 1);

232 
i
 = 0; i < 
l
.
b©ch
; ++i){

233 *
a
 = 
l
.
weights
;

234 *
b
 = 
Ãt
.
šput
 + 
i
*
l
.
c
*l.
h
*l.
w
;

235 *
c
 = 
Ãt
.
wÜk¥aû
;

237 
	`gemm_ıu
(1,0,
m
,
n
,
k
,1,
a
,m,
b
,n,0,
c
,n);

239 
	`cŞ2im_ıu
(
Ãt
.
wÜk¥aû
, 
l
.
out_c
,†.
out_h
,†.
out_w
,†.
size
,†.
¡ride
,†.
·d
,†.
ouut
+
i
*l.
ouuts
);

241 ià(
l
.
b©ch_nÜm®ize
) {

242 
	`fÜw¬d_b©chnÜm_Ïy”
(
l
, 
Ãt
);

244 
	`add_bŸs
(
l
.
ouut
,†.
bŸ£s
,†.
b©ch
,†.
n
,†.
out_w
*l.
out_h
);

246 
	`aùiv©e_¬¿y
(
l
.
ouut
,†.
b©ch
*l.
n
*l.
out_w
*l.
out_h
,†.
aùiv©iÚ
);

247 
	}
}

249 
	$backw¬d_decÚvŞutiÚ®_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

251 
i
;

253 
	`g¿d›Á_¬¿y
(
l
.
ouut
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
,†.
d–
);

255 if(
l
.
b©ch_nÜm®ize
){

256 
	`backw¬d_b©chnÜm_Ïy”
(
l
, 
Ãt
);

258 
	`backw¬d_bŸs
(
l
.
bŸs_upd©es
,†.
d–
,†.
b©ch
,†.
n
,†.
out_w
*l.
out_h
);

263 
i
 = 0; i < 
l
.
b©ch
; ++i){

264 
m
 = 
l
.
c
;

265 
n
 = 
l
.
size
*l.size*l.n;

266 
k
 = 
l
.
h
*l.
w
;

268 *
a
 = 
Ãt
.
šput
 + 
i
*
m
*
k
;

269 *
b
 = 
Ãt
.
wÜk¥aû
;

270 *
c
 = 
l
.
weight_upd©es
;

272 
	`im2cŞ_ıu
(
l
.
d–
 + 
i
*l.
ouuts
,†.
out_c
,†.
out_h
,†.
out_w
,

273 
l
.
size
,†.
¡ride
,†.
·d
, 
b
);

274 
	`gemm_ıu
(0,1,
m
,
n
,
k
,1,
a
,k,
b
,k,1,
c
,n);

276 if(
Ãt
.
d–
){

277 
m
 = 
l
.
c
;

278 
n
 = 
l
.
h
*l.
w
;

279 
k
 = 
l
.
size
*l.size*l.
n
;

281 *
a
 = 
l
.
weights
;

282 *
b
 = 
Ãt
.
wÜk¥aû
;

283 *
c
 = 
Ãt
.
d–
 + 
i
*
n
*
m
;

285 
	`gemm_ıu
(0,0,
m
,
n
,
k
,1,
a
,k,
b
,n,1,
c
,n);

288 
	}
}

290 
	$upd©e_decÚvŞutiÚ®_Ïy”
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
)

292 
Ë¬nšg_¿‹
 = 
a
.Ë¬nšg_¿‹*
l
.
Ë¬nšg_¿‹_sÿË
;

293 
mom’tum
 = 
a
.momentum;

294 
deÿy
 = 
a
.decay;

295 
b©ch
 = 
a
.batch;

297 
size
 = 
l
.size*l.size*l.
c
*l.
n
;

298 
	`axpy_ıu
(
l
.
n
, 
Ë¬nšg_¿‹
/
b©ch
,†.
bŸs_upd©es
, 1,†.
bŸ£s
, 1);

299 
	`sÿl_ıu
(
l
.
n
, 
mom’tum
,†.
bŸs_upd©es
, 1);

301 if(
l
.
sÿËs
){

302 
	`axpy_ıu
(
l
.
n
, 
Ë¬nšg_¿‹
/
b©ch
,†.
sÿË_upd©es
, 1,†.
sÿËs
, 1);

303 
	`sÿl_ıu
(
l
.
n
, 
mom’tum
,†.
sÿË_upd©es
, 1);

306 
	`axpy_ıu
(
size
, -
deÿy
*
b©ch
, 
l
.
weights
, 1,†.
weight_upd©es
, 1);

307 
	`axpy_ıu
(
size
, 
Ë¬nšg_¿‹
/
b©ch
, 
l
.
weight_upd©es
, 1,†.
weights
, 1);

308 
	`sÿl_ıu
(
size
, 
mom’tum
, 
l
.
weight_upd©es
, 1);

309 
	}
}

	@deconvolutional_layer.h

1 #iâdeà
DECONVOLUTIONAL_LAYER_H


2 
	#DECONVOLUTIONAL_LAYER_H


	)

4 
	~"cuda.h
"

5 
	~"image.h
"

6 
	~"aùiv©iÚs.h
"

7 
	~"Ïy”.h
"

8 
	~"ÃtwÜk.h
"

10 #ifdeà
GPU


11 
fÜw¬d_decÚvŞutiÚ®_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

12 
backw¬d_decÚvŞutiÚ®_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

13 
upd©e_decÚvŞutiÚ®_Ïy”_gpu
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
);

14 
push_decÚvŞutiÚ®_Ïy”
(
Ïy”
 
l
);

15 
puÎ_decÚvŞutiÚ®_Ïy”
(
Ïy”
 
l
);

18 
Ïy”
 
make_decÚvŞutiÚ®_Ïy”
(
b©ch
, 
h
, 
w
, 
c
, 
n
, 
size
, 
¡ride
, 
·ddšg
, 
ACTIVATION
 
aùiv©iÚ
, 
b©ch_nÜm®ize
, 
adam
);

19 
»size_decÚvŞutiÚ®_Ïy”
(
Ïy”
 *
l
, 
h
, 
w
);

20 
fÜw¬d_decÚvŞutiÚ®_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

21 
upd©e_decÚvŞutiÚ®_Ïy”
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
);

22 
backw¬d_decÚvŞutiÚ®_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

	@demo.c

1 
	~"ÃtwÜk.h
"

2 
	~"d‘eùiÚ_Ïy”.h
"

3 
	~"»giÚ_Ïy”.h
"

4 
	~"co¡_Ïy”.h
"

5 
	~"uts.h
"

6 
	~"·r£r.h
"

7 
	~"box.h
"

8 
	~"image.h
"

9 
	~"demo.h
"

10 
	~<sys/time.h
>

12 
	#DEMO
 1

	)

14 #ifdeà
OPENCV


16 **
	gdemo_Çmes
;

17 
image
 **
	gdemo_®phab‘
;

18 
	gdemo_şas£s
;

20 
ÃtwÜk
 *
	gÃt
;

21 
image
 
	gbuff
 [3];

22 
image
 
	gbuff_Ë‰”
[3];

23 
	gbuff_šdex
 = 0;

24 
CvC­tu»
 * 
	gÿp
;

25 
I¶Image
 * 
	gl
;

26 
	gås
 = 0;

27 
	gdemo_th»sh
 = 0;

28 
	gdemo_h›r
 = .5;

29 
	gruÂšg
 = 0;

31 
	gdemo_äame
 = 3;

32 
	gdemo_šdex
 = 0;

33 **
	g´ediùiÚs
;

34 *
	gavg
;

35 
	gdemo_dÚe
 = 0;

36 
	gdemo_tÙ®
 = 0;

37 
	gdemo_time
;

39 
d‘eùiÚ
 *
g‘_ÃtwÜk_boxes
(
ÃtwÜk
 *
Ãt
, 
w
, 
h
, 
th»sh
, 
h›r
, *
m­
, 
»Ïtive
, *
num
);

41 
	$size_ÃtwÜk
(
ÃtwÜk
 *
Ãt
)

43 
i
;

44 
couÁ
 = 0;

45 
i
 = 0; i < 
Ãt
->
n
; ++i){

46 
Ïy”
 
l
 = 
Ãt
->
Ïy”s
[
i
];

47 if(
l
.
ty³
 =ğ
YOLO
 ||†.ty³ =ğ
REGION
 ||†.ty³ =ğ
DETECTION
){

48 
couÁ
 +ğ
l
.
ouuts
;

51  
couÁ
;

52 
	}
}

54 
	$»memb”_ÃtwÜk
(
ÃtwÜk
 *
Ãt
)

56 
i
;

57 
couÁ
 = 0;

58 
i
 = 0; i < 
Ãt
->
n
; ++i){

59 
Ïy”
 
l
 = 
Ãt
->
Ïy”s
[
i
];

60 if(
l
.
ty³
 =ğ
YOLO
 ||†.ty³ =ğ
REGION
 ||†.ty³ =ğ
DETECTION
){

61 
	`memıy
(
´ediùiÚs
[
demo_šdex
] + 
couÁ
, 
Ãt
->
Ïy”s
[
i
].
ouut
, (è* 
l
.
ouuts
);

62 
couÁ
 +ğ
l
.
ouuts
;

65 
	}
}

67 
d‘eùiÚ
 *
	$avg_´ediùiÚs
(
ÃtwÜk
 *
Ãt
, *
nboxes
)

69 
i
, 
j
;

70 
couÁ
 = 0;

71 
	`fl_ıu
(
demo_tÙ®
, 0, 
avg
, 1);

72 
j
 = 0; j < 
demo_äame
; ++j){

73 
	`axpy_ıu
(
demo_tÙ®
, 1./
demo_äame
, 
´ediùiÚs
[
j
], 1, 
avg
, 1);

75 
i
 = 0; i < 
Ãt
->
n
; ++i){

76 
Ïy”
 
l
 = 
Ãt
->
Ïy”s
[
i
];

77 if(
l
.
ty³
 =ğ
YOLO
 ||†.ty³ =ğ
REGION
 ||†.ty³ =ğ
DETECTION
){

78 
	`memıy
(
l
.
ouut
, 
avg
 + 
couÁ
, (è*†.
ouuts
);

79 
couÁ
 +ğ
l
.
ouuts
;

82 
d‘eùiÚ
 *
d‘s
 = 
	`g‘_ÃtwÜk_boxes
(
Ãt
, 
buff
[0].
w
, buff[0].
h
, 
demo_th»sh
, 
demo_h›r
, 0, 1, 
nboxes
);

83  
d‘s
;

84 
	}
}

86 *
	$d‘eù_š_th»ad
(*
±r
)

88 
ruÂšg
 = 1;

89 
nms
 = .4;

91 
Ïy”
 
l
 = 
Ãt
->
Ïy”s
[Ãt->
n
-1];

92 *
X
 = 
buff_Ë‰”
[(
buff_šdex
+2)%3].
d©a
;

93 
	`ÃtwÜk_´ediù
(
Ãt
, 
X
);

99 
	`»memb”_ÃtwÜk
(
Ãt
);

100 
d‘eùiÚ
 *
d‘s
 = 0;

101 
nboxes
 = 0;

102 
d‘s
 = 
	`avg_´ediùiÚs
(
Ãt
, &
nboxes
);

126 ià(
nms
 > 0è
	`do_nms_obj
(
d‘s
, 
nboxes
, 
l
.
şas£s
,‚ms);

128 
	`´štf
("\033[2J");

129 
	`´štf
("\033[1;1H");

130 
	`´štf
("\nFPS:%.1f\n",
ås
);

131 
	`´štf
("Objects:\n\n");

132 
image
 
di¥Ïy
 = 
buff
[(
buff_šdex
+2) % 3];

133 
	`d¿w_d‘eùiÚs
(
di¥Ïy
, 
d‘s
, 
nboxes
, 
demo_th»sh
, 
demo_Çmes
, 
demo_®phab‘
, 
demo_şas£s
);

134 
	`ä“_d‘eùiÚs
(
d‘s
, 
nboxes
);

136 
demo_šdex
 = (demo_šdex + 1)%
demo_äame
;

137 
ruÂšg
 = 0;

139 
	}
}

141 *
	$ãtch_š_th»ad
(*
±r
)

143 
¡©us
 = 
	`fl_image_äom_¡»am
(
ÿp
, 
buff
[
buff_šdex
]);

144 
	`Ë‰”box_image_što
(
buff
[
buff_šdex
], 
Ãt
->
w
,‚‘->
h
, 
buff_Ë‰”
[buff_index]);

145 if(
¡©us
 =ğ0è
demo_dÚe
 = 1;

147 
	}
}

149 *
	$di¥Ïy_š_th»ad
(*
±r
)

151 
	`show_image_cv
(
buff
[(
buff_šdex
 + 1)%3], "Demo", 
l
);

152 
c
 = 
	`cvWa™Key
(1);

153 ià(
c
 != -1) c = c%256;

154 ià(
c
 == 27) {

155 
demo_dÚe
 = 1;

157 } ià(
c
 == 82) {

158 
demo_th»sh
 += .02;

159 } ià(
c
 == 84) {

160 
demo_th»sh
 -= .02;

161 if(
demo_th»sh
 <= .02) demo_thresh = .02;

162 } ià(
c
 == 83) {

163 
demo_h›r
 += .02;

164 } ià(
c
 == 81) {

165 
demo_h›r
 -= .02;

166 if(
demo_h›r
 <= .0) demo_hier = .0;

169 
	}
}

171 *
	$di¥Ïy_loİ
(*
±r
)

174 
	`di¥Ïy_š_th»ad
(0);

176 
	}
}

178 *
	$d‘eù_loİ
(*
±r
)

181 
	`d‘eù_š_th»ad
(0);

183 
	}
}

185 
	$demo
(*
cfgfe
, *
weightfe
, 
th»sh
, 
ÿm_šdex
, cÚ¡ *
f’ame
, **
Çmes
, 
şas£s
, 
d–ay
, *
´efix
, 
avg_äames
, 
h›r
, 
w
, 
h
, 
äames
, 
fuÎsü“n
)

188 
image
 **
®phab‘
 = 
	`lßd_®phab‘
();

189 
demo_Çmes
 = 
Çmes
;

190 
demo_®phab‘
 = 
®phab‘
;

191 
demo_şas£s
 = 
şas£s
;

192 
demo_th»sh
 = 
th»sh
;

193 
demo_h›r
 = 
h›r
;

194 
	`´štf
("Demo\n");

195 
Ãt
 = 
	`lßd_ÃtwÜk
(
cfgfe
, 
weightfe
, 0);

196 
	`£t_b©ch_ÃtwÜk
(
Ãt
, 1);

197 
±h»ad_t
 
d‘eù_th»ad
;

198 
±h»ad_t
 
ãtch_th»ad
;

200 
	`¤ªd
(2222222);

202 
i
;

203 
demo_tÙ®
 = 
	`size_ÃtwÜk
(
Ãt
);

204 
´ediùiÚs
 = 
	`ÿÎoc
(
demo_äame
, (*));

205 
i
 = 0; i < 
demo_äame
; ++i){

206 
´ediùiÚs
[
i
] = 
	`ÿÎoc
(
demo_tÙ®
, ());

208 
avg
 = 
	`ÿÎoc
(
demo_tÙ®
, ());

210 if(
f’ame
){

211 
	`´štf
("videØfe: %s\n", 
f’ame
);

212 
ÿp
 = 
	`cvC­tu»FromFe
(
f’ame
);

214 
ÿp
 = 
	`cvC­tu»FromCAM
(
ÿm_šdex
);

216 if(
w
){

217 
	`cvS‘C­tu»Prİ”ty
(
ÿp
, 
CV_CAP_PROP_FRAME_WIDTH
, 
w
);

219 if(
h
){

220 
	`cvS‘C­tu»Prİ”ty
(
ÿp
, 
CV_CAP_PROP_FRAME_HEIGHT
, 
h
);

222 if(
äames
){

223 
	`cvS‘C­tu»Prİ”ty
(
ÿp
, 
CV_CAP_PROP_FPS
, 
äames
);

227 if(!
ÿp
è
	`”rÜ
("Couldn't connecto webcam.\n");

229 
buff
[0] = 
	`g‘_image_äom_¡»am
(
ÿp
);

230 
buff
[1] = 
	`cİy_image
(buff[0]);

231 
buff
[2] = 
	`cİy_image
(buff[0]);

232 
buff_Ë‰”
[0] = 
	`Ë‰”box_image
(
buff
[0], 
Ãt
->
w
,‚‘->
h
);

233 
buff_Ë‰”
[1] = 
	`Ë‰”box_image
(
buff
[0], 
Ãt
->
w
,‚‘->
h
);

234 
buff_Ë‰”
[2] = 
	`Ë‰”box_image
(
buff
[0], 
Ãt
->
w
,‚‘->
h
);

235 
l
 = 
	`cvC»©eImage
(
	`cvSize
(
buff
[0].
w
,buff[0].
h
), 
IPL_DEPTH_8U
, buff[0].
c
);

237 
couÁ
 = 0;

238 if(!
´efix
){

239 
	`cvNamedWšdow
("Demo", 
CV_WINDOW_NORMAL
);

240 if(
fuÎsü“n
){

241 
	`cvS‘WšdowPrİ”ty
("Demo", 
CV_WND_PROP_FULLSCREEN
, 
CV_WINDOW_FULLSCREEN
);

243 
	`cvMoveWšdow
("Demo", 0, 0);

244 
	`cvResizeWšdow
("Demo", 1352, 1013);

248 
demo_time
 = 
	`wh©_time_is_™_now
();

250 !
demo_dÚe
){

251 
buff_šdex
 = (buff_index + 1) %3;

252 if(
	`±h»ad_ü—‹
(&
ãtch_th»ad
, 0, 
ãtch_š_th»ad
, 0)è
	`”rÜ
("Thread creation failed");

253 if(
	`±h»ad_ü—‹
(&
d‘eù_th»ad
, 0, 
d‘eù_š_th»ad
, 0)è
	`”rÜ
("Thread creation failed");

254 if(!
´efix
){

255 
ås
 = 1./(
	`wh©_time_is_™_now
(è- 
demo_time
);

256 
demo_time
 = 
	`wh©_time_is_™_now
();

257 
	`di¥Ïy_š_th»ad
(0);

259 
Çme
[256];

260 
	`¥rštf
(
Çme
, "%s_%08d", 
´efix
, 
couÁ
);

261 
	`§ve_image
(
buff
[(
buff_šdex
 + 1)%3], 
Çme
);

263 
	`±h»ad_još
(
ãtch_th»ad
, 0);

264 
	`±h»ad_još
(
d‘eù_th»ad
, 0);

265 ++
couÁ
;

267 
	}
}

359 
	$demo
(*
cfgfe
, *
weightfe
, 
th»sh
, 
ÿm_šdex
, cÚ¡ *
f’ame
, **
Çmes
, 
şas£s
, 
d–ay
, *
´efix
, 
avg
, 
h›r
, 
w
, 
h
, 
äames
, 
fuÎsü“n
)

361 
	`årštf
(
¡d”r
, "Demo‚eeds OpenCV for webcam images.\n");

362 
	}
}

	@demo.h

1 #iâdeà
DEMO_H


2 
	#DEMO_H


	)

4 
	~"image.h
"

	@detection_layer.c

1 
	~"d‘eùiÚ_Ïy”.h
"

2 
	~"aùiv©iÚs.h
"

3 
	~"soámax_Ïy”.h
"

4 
	~"bÏs.h
"

5 
	~"box.h
"

6 
	~"cuda.h
"

7 
	~"uts.h
"

9 
	~<¡dio.h
>

10 
	~<as£¹.h
>

11 
	~<¡ršg.h
>

12 
	~<¡dlib.h
>

14 
d‘eùiÚ_Ïy”
 
	$make_d‘eùiÚ_Ïy”
(
b©ch
, 
šputs
, 
n
, 
side
, 
şas£s
, 
coÜds
, 
»scÜe
)

16 
d‘eùiÚ_Ïy”
 
l
 = {0};

17 
l
.
ty³
 = 
DETECTION
;

19 
l
.
n
 =‚;

20 
l
.
b©ch
 = batch;

21 
l
.
šputs
 = inputs;

22 
l
.
şas£s
 = classes;

23 
l
.
coÜds
 = coords;

24 
l
.
»scÜe
 =„escore;

25 
l
.
side
 = side;

26 
l
.
w
 = 
side
;

27 
l
.
h
 = 
side
;

28 
	`as£¹
(
side
*side*((1 + 
l
.
coÜds
)*l.
n
 +†.
şas£s
è=ğ
šputs
);

29 
l
.
co¡
 = 
	`ÿÎoc
(1, ());

30 
l
.
ouuts
 =†.
šputs
;

31 
l
.
Œuths
 =†.
side
*l.side*(1+l.
coÜds
+l.
şas£s
);

32 
l
.
ouut
 = 
	`ÿÎoc
(
b©ch
*l.
ouuts
, ());

33 
l
.
d–
 = 
	`ÿÎoc
(
b©ch
*l.
ouuts
, ());

35 
l
.
fÜw¬d
 = 
fÜw¬d_d‘eùiÚ_Ïy”
;

36 
l
.
backw¬d
 = 
backw¬d_d‘eùiÚ_Ïy”
;

37 #ifdeà
GPU


38 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_d‘eùiÚ_Ïy”_gpu
;

39 
l
.
backw¬d_gpu
 = 
backw¬d_d‘eùiÚ_Ïy”_gpu
;

40 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
, 
b©ch
*l.
ouuts
);

41 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
, 
b©ch
*l.
ouuts
);

44 
	`årštf
(
¡d”r
, "Detection Layer\n");

45 
	`¤ªd
(0);

47  
l
;

48 
	}
}

50 
	$fÜw¬d_d‘eùiÚ_Ïy”
(cÚ¡ 
d‘eùiÚ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

52 
loÿtiÚs
 = 
l
.
side
*l.side;

53 
i
,
j
;

54 
	`memıy
(
l
.
ouut
, 
Ãt
.
šput
,†.
ouuts
*l.
b©ch
*());

56 
b
;

57 ià(
l
.
soámax
){

58 
b
 = 0; b < 
l
.
b©ch
; ++b){

59 
šdex
 = 
b
*
l
.
šputs
;

60 
i
 = 0; i < 
loÿtiÚs
; ++i) {

61 
off£t
 = 
i
*
l
.
şas£s
;

62 
	`soámax
(
l
.
ouut
 + 
šdex
 + 
off£t
,†.
şas£s
, 1, 1,

63 
l
.
ouut
 + 
šdex
 + 
off£t
);

67 if(
Ãt
.
Œaš
){

68 
avg_iou
 = 0;

69 
avg_ÿt
 = 0;

70 
avg_®lÿt
 = 0;

71 
avg_obj
 = 0;

72 
avg_ªyobj
 = 0;

73 
couÁ
 = 0;

74 *(
l
.
co¡
) = 0;

75 
size
 = 
l
.
šputs
 *†.
b©ch
;

76 
	`mem£t
(
l
.
d–
, 0, 
size
 * ());

77 
b
 = 0; b < 
l
.
b©ch
; ++b){

78 
šdex
 = 
b
*
l
.
šputs
;

79 
i
 = 0; i < 
loÿtiÚs
; ++i) {

80 
Œuth_šdex
 = (
b
*
loÿtiÚs
 + 
i
)*(1+
l
.
coÜds
+l.
şas£s
);

81 
is_obj
 = 
Ãt
.
Œuth
[
Œuth_šdex
];

82 
j
 = 0; j < 
l
.
n
; ++j) {

83 
p_šdex
 = 
šdex
 + 
loÿtiÚs
*
l
.
şas£s
 + 
i
*l.
n
 + 
j
;

84 
l
.
d–
[
p_šdex
] =†.
noobjeù_sÿË
*(0 -†.
ouut
[p_index]);

85 *(
l
.
co¡
è+ğl.
noobjeù_sÿË
*
	`pow
Ö.
ouut
[
p_šdex
], 2);

86 
avg_ªyobj
 +ğ
l
.
ouut
[
p_šdex
];

89 
be¡_šdex
 = -1;

90 
be¡_iou
 = 0;

91 
be¡_rm£
 = 20;

93 ià(!
is_obj
){

97 
şass_šdex
 = 
šdex
 + 
i
*
l
.
şas£s
;

98 
j
 = 0; j < 
l
.
şas£s
; ++j) {

99 
l
.
d–
[
şass_šdex
+
j
] =†.
şass_sÿË
 * (
Ãt
.
Œuth
[
Œuth_šdex
+1+j] -†.
ouut
[class_index+j]);

100 *(
l
.
co¡
è+ğl.
şass_sÿË
 * 
	`pow
(
Ãt
.
Œuth
[
Œuth_šdex
+1+
j
] -†.
ouut
[
şass_šdex
+j], 2);

101 if(
Ãt
.
Œuth
[
Œuth_šdex
 + 1 + 
j
]è
avg_ÿt
 +ğ
l
.
ouut
[
şass_šdex
+j];

102 
avg_®lÿt
 +ğ
l
.
ouut
[
şass_šdex
+
j
];

105 
box
 
Œuth
 = 
	`æßt_to_box
(
Ãt
.Œuth + 
Œuth_šdex
 + 1 + 
l
.
şas£s
, 1);

106 
Œuth
.
x
 /ğ
l
.
side
;

107 
Œuth
.
y
 /ğ
l
.
side
;

109 
j
 = 0; j < 
l
.
n
; ++j){

110 
box_šdex
 = 
šdex
 + 
loÿtiÚs
*(
l
.
şas£s
 +†.
n
è+ (
i
*l.À+ 
j
è*†.
coÜds
;

111 
box
 
out
 = 
	`æßt_to_box
(
l
.
ouut
 + 
box_šdex
, 1);

112 
out
.
x
 /ğ
l
.
side
;

113 
out
.
y
 /ğ
l
.
side
;

115 ià(
l
.
sq¹
){

116 
out
.
w
 = out.w*out.w;

117 
out
.
h
 = out.h*out.h;

120 
iou
 = 
	`box_iou
(
out
, 
Œuth
);

122 
rm£
 = 
	`box_rm£
(
out
, 
Œuth
);

123 if(
be¡_iou
 > 0 || 
iou
 > 0){

124 if(
iou
 > 
be¡_iou
){

125 
be¡_iou
 = 
iou
;

126 
be¡_šdex
 = 
j
;

129 if(
rm£
 < 
be¡_rm£
){

130 
be¡_rm£
 = 
rm£
;

131 
be¡_šdex
 = 
j
;

136 if(
l
.
fÜûd
){

137 if(
Œuth
.
w
*Œuth.
h
 < .1){

138 
be¡_šdex
 = 1;

140 
be¡_šdex
 = 0;

143 if(
l
.
¿ndom
 && *(
Ãt
.
£’
) < 64000){

144 
be¡_šdex
 = 
	`¿nd
()%
l
.
n
;

147 
box_šdex
 = 
šdex
 + 
loÿtiÚs
*(
l
.
şas£s
 +†.
n
è+ (
i
*l.À+ 
be¡_šdex
è*†.
coÜds
;

148 
tbox_šdex
 = 
Œuth_šdex
 + 1 + 
l
.
şas£s
;

150 
box
 
out
 = 
	`æßt_to_box
(
l
.
ouut
 + 
box_šdex
, 1);

151 
out
.
x
 /ğ
l
.
side
;

152 
out
.
y
 /ğ
l
.
side
;

153 ià(
l
.
sq¹
) {

154 
out
.
w
 = out.w*out.w;

155 
out
.
h
 = out.h*out.h;

157 
iou
 = 
	`box_iou
(
out
, 
Œuth
);

160 
p_šdex
 = 
šdex
 + 
loÿtiÚs
*
l
.
şas£s
 + 
i
*l.
n
 + 
be¡_šdex
;

161 *(
l
.
co¡
è-ğl.
noobjeù_sÿË
 * 
	`pow
Ö.
ouut
[
p_šdex
], 2);

162 *(
l
.
co¡
è+ğl.
objeù_sÿË
 * 
	`pow
(1-l.
ouut
[
p_šdex
], 2);

163 
avg_obj
 +ğ
l
.
ouut
[
p_šdex
];

164 
l
.
d–
[
p_šdex
] =†.
objeù_sÿË
 * (1.-l.
ouut
[p_index]);

166 if(
l
.
»scÜe
){

167 
l
.
d–
[
p_šdex
] =†.
objeù_sÿË
 * (
iou
 -†.
ouut
[p_index]);

170 
l
.
d–
[
box_šdex
+0] =†.
coÜd_sÿË
*(
Ãt
.
Œuth
[
tbox_šdex
 + 0] -†.
ouut
[box_index + 0]);

171 
l
.
d–
[
box_šdex
+1] =†.
coÜd_sÿË
*(
Ãt
.
Œuth
[
tbox_šdex
 + 1] -†.
ouut
[box_index + 1]);

172 
l
.
d–
[
box_šdex
+2] =†.
coÜd_sÿË
*(
Ãt
.
Œuth
[
tbox_šdex
 + 2] -†.
ouut
[box_index + 2]);

173 
l
.
d–
[
box_šdex
+3] =†.
coÜd_sÿË
*(
Ãt
.
Œuth
[
tbox_šdex
 + 3] -†.
ouut
[box_index + 3]);

174 if(
l
.
sq¹
){

175 
l
.
d–
[
box_šdex
+2] =†.
coÜd_sÿË
*(
	`sq¹
(
Ãt
.
Œuth
[
tbox_šdex
 + 2]è-†.
ouut
[box_index + 2]);

176 
l
.
d–
[
box_šdex
+3] =†.
coÜd_sÿË
*(
	`sq¹
(
Ãt
.
Œuth
[
tbox_šdex
 + 3]è-†.
ouut
[box_index + 3]);

179 *(
l
.
co¡
è+ğ
	`pow
(1-
iou
, 2);

180 
avg_iou
 +ğ
iou
;

181 ++
couÁ
;

186 *
co¡s
 = 
	`ÿÎoc
(
l
.
b©ch
*
loÿtiÚs
*l.
n
, ());

187 
b
 = 0; b < 
l
.
b©ch
; ++b) {

188 
šdex
 = 
b
*
l
.
šputs
;

189 
i
 = 0; i < 
loÿtiÚs
; ++i) {

190 
j
 = 0; j < 
l
.
n
; ++j) {

191 
p_šdex
 = 
šdex
 + 
loÿtiÚs
*
l
.
şas£s
 + 
i
*l.
n
 + 
j
;

192 
co¡s
[
b
*
loÿtiÚs
*
l
.
n
 + 
i
*l.À+ 
j
] =†.
d–
[
p_šdex
]*l.delta[p_index];

196 
šdexes
[100];

197 
	`tİ_k
(
co¡s
, 
l
.
b©ch
*
loÿtiÚs
*l.
n
, 100, 
šdexes
);

198 
cutoff
 = 
co¡s
[
šdexes
[99]];

199 
b
 = 0; b < 
l
.
b©ch
; ++b) {

200 
šdex
 = 
b
*
l
.
šputs
;

201 
i
 = 0; i < 
loÿtiÚs
; ++i) {

202 
j
 = 0; j < 
l
.
n
; ++j) {

203 
p_šdex
 = 
šdex
 + 
loÿtiÚs
*
l
.
şas£s
 + 
i
*l.
n
 + 
j
;

204 ià(
l
.
d–
[
p_šdex
]*l.d–[p_šdex] < 
cutoff
)†.delta[p_index] = 0;

208 
	`ä“
(
co¡s
);

212 *(
l
.
co¡
èğ
	`pow
(
	`mag_¬¿y
Ö.
d–
,†.
ouuts
 *†.
b©ch
), 2);

215 
	`´štf
("D‘eùiÚ Avg IOU: %f, Po C©: %f, AÎ C©: %f, Po Obj: %f, Any Obj: %f, couÁ: %d\n", 
avg_iou
/
couÁ
, 
avg_ÿt
/couÁ, 
avg_®lÿt
/(couÁ*
l
.
şas£s
), 
avg_obj
/couÁ, 
avg_ªyobj
/Ö.
b©ch
*
loÿtiÚs
*l.
n
), count);

218 
	}
}

220 
	$backw¬d_d‘eùiÚ_Ïy”
(cÚ¡ 
d‘eùiÚ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

222 
	`axpy_ıu
(
l
.
b©ch
*l.
šputs
, 1,†.
d–
, 1, 
Ãt
.delta, 1);

223 
	}
}

225 
	$g‘_d‘eùiÚ_d‘eùiÚs
(
Ïy”
 
l
, 
w
, 
h
, 
th»sh
, 
d‘eùiÚ
 *
d‘s
)

227 
i
,
j
,
n
;

228 *
´ediùiÚs
 = 
l
.
ouut
;

230 
i
 = 0; i < 
l
.
side
*l.side; ++i){

231 
row
 = 
i
 / 
l
.
side
;

232 
cŞ
 = 
i
 % 
l
.
side
;

233 
n
 = 0;‚ < 
l
.n; ++n){

234 
šdex
 = 
i
*
l
.
n
 +‚;

235 
p_šdex
 = 
l
.
side
*l.side*l.
şas£s
 + 
i
*l.
n
 +‚;

236 
sÿË
 = 
´ediùiÚs
[
p_šdex
];

237 
box_šdex
 = 
l
.
side
*l.side*Ö.
şas£s
 +†.
n
è+ (
i
*l.n +‚)*4;

238 
box
 
b
;

239 
b
.
x
 = (
´ediùiÚs
[
box_šdex
 + 0] + 
cŞ
è/ 
l
.
side
 * 
w
;

240 
b
.
y
 = (
´ediùiÚs
[
box_šdex
 + 1] + 
row
è/ 
l
.
side
 * 
h
;

241 
b
.
w
 = 
	`pow
(
´ediùiÚs
[
box_šdex
 + 2], (
l
.
sq¹
?2:1)) * w;

242 
b
.
h
 = 
	`pow
(
´ediùiÚs
[
box_šdex
 + 3], (
l
.
sq¹
?2:1)) * h;

243 
d‘s
[
šdex
].
bbox
 = 
b
;

244 
d‘s
[
šdex
].
objeùÃss
 = 
sÿË
;

245 
j
 = 0; j < 
l
.
şas£s
; ++j){

246 
şass_šdex
 = 
i
*
l
.
şas£s
;

247 
´ob
 = 
sÿË
*
´ediùiÚs
[
şass_šdex
+
j
];

248 
d‘s
[
šdex
].
´ob
[
j
] = (´ob > 
th»sh
) ?…rob : 0;

252 
	}
}

254 #ifdeà
GPU


256 
	$fÜw¬d_d‘eùiÚ_Ïy”_gpu
(cÚ¡ 
d‘eùiÚ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

258 if(!
Ãt
.
Œaš
){

259 
	`cİy_gpu
(
l
.
b©ch
*l.
šputs
, 
Ãt
.
šput_gpu
, 1,†.
ouut_gpu
, 1);

263 
	`cuda_puÎ_¬¿y
(
Ãt
.
šput_gpu
,‚‘.
šput
, 
l
.
b©ch
*l.
šputs
);

264 
	`fÜw¬d_d‘eùiÚ_Ïy”
(
l
, 
Ãt
);

265 
	`cuda_push_¬¿y
(
l
.
ouut_gpu
,†.
ouut
,†.
b©ch
*l.
ouuts
);

266 
	`cuda_push_¬¿y
(
l
.
d–_gpu
,†.
d–
,†.
b©ch
*l.
šputs
);

267 
	}
}

269 
	$backw¬d_d‘eùiÚ_Ïy”_gpu
(
d‘eùiÚ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

271 
	`axpy_gpu
(
l
.
b©ch
*l.
šputs
, 1,†.
d–_gpu
, 1, 
Ãt
.delta_gpu, 1);

273 
	}
}

	@detection_layer.h

1 #iâdeà
DETECTION_LAYER_H


2 
	#DETECTION_LAYER_H


	)

4 
	~"Ïy”.h
"

5 
	~"ÃtwÜk.h
"

7 
Ïy”
 
	td‘eùiÚ_Ïy”
;

9 
d‘eùiÚ_Ïy”
 
make_d‘eùiÚ_Ïy”
(
b©ch
, 
šputs
, 
n
, 
size
, 
şas£s
, 
coÜds
, 
»scÜe
);

10 
fÜw¬d_d‘eùiÚ_Ïy”
(cÚ¡ 
d‘eùiÚ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

11 
backw¬d_d‘eùiÚ_Ïy”
(cÚ¡ 
d‘eùiÚ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

13 #ifdeà
GPU


14 
fÜw¬d_d‘eùiÚ_Ïy”_gpu
(cÚ¡ 
d‘eùiÚ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

15 
backw¬d_d‘eùiÚ_Ïy”_gpu
(
d‘eùiÚ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

	@dropout_layer.c

1 
	~"drİout_Ïy”.h
"

2 
	~"uts.h
"

3 
	~"cuda.h
"

4 
	~<¡dlib.h
>

5 
	~<¡dio.h
>

7 
drİout_Ïy”
 
	$make_drİout_Ïy”
(
b©ch
, 
šputs
, 
´obab™y
)

9 
drİout_Ïy”
 
l
 = {0};

10 
l
.
ty³
 = 
DROPOUT
;

11 
l
.
´obab™y
 =…robability;

12 
l
.
šputs
 = inputs;

13 
l
.
ouuts
 = 
šputs
;

14 
l
.
b©ch
 = batch;

15 
l
.
¿nd
 = 
	`ÿÎoc
(
šputs
*
b©ch
, ());

16 
l
.
sÿË
 = 1./(1.-
´obab™y
);

17 
l
.
fÜw¬d
 = 
fÜw¬d_drİout_Ïy”
;

18 
l
.
backw¬d
 = 
backw¬d_drİout_Ïy”
;

19 #ifdeà
GPU


20 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_drİout_Ïy”_gpu
;

21 
l
.
backw¬d_gpu
 = 
backw¬d_drİout_Ïy”_gpu
;

22 
l
.
¿nd_gpu
 = 
	`cuda_make_¬¿y
Ö.
¿nd
, 
šputs
*
b©ch
);

24 
	`årštf
(
¡d”r
, "drİouˆ… = %.2à %4d -> %4d\n", 
´obab™y
, 
šputs
, inputs);

25  
l
;

26 
	}
}

28 
	$»size_drİout_Ïy”
(
drİout_Ïy”
 *
l
, 
šputs
)

30 
l
->
¿nd
 = 
	`»®loc
Ö->¿nd,†->
šputs
*l->
b©ch
*());

31 #ifdeà
GPU


32 
	`cuda_ä“
(
l
->
¿nd_gpu
);

34 
l
->
¿nd_gpu
 = 
	`cuda_make_¬¿y
Ö->
¿nd
, 
šputs
*l->
b©ch
);

36 
	}
}

38 
	$fÜw¬d_drİout_Ïy”
(
drİout_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

40 
i
;

41 ià(!
Ãt
.
Œaš
) ;

42 
i
 = 0; i < 
l
.
b©ch
 *†.
šputs
; ++i){

43 
r
 = 
	`¿nd_unifÜm
(0, 1);

44 
l
.
¿nd
[
i
] = 
r
;

45 if(
r
 < 
l
.
´obab™y
è
Ãt
.
šput
[
i
] = 0;

46 
Ãt
.
šput
[
i
] *ğ
l
.
sÿË
;

48 
	}
}

50 
	$backw¬d_drİout_Ïy”
(
drİout_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

52 
i
;

53 if(!
Ãt
.
d–
) ;

54 
i
 = 0; i < 
l
.
b©ch
 *†.
šputs
; ++i){

55 
r
 = 
l
.
¿nd
[
i
];

56 if(
r
 < 
l
.
´obab™y
è
Ãt
.
d–
[
i
] = 0;

57 
Ãt
.
d–
[
i
] *ğ
l
.
sÿË
;

59 
	}
}

	@dropout_layer.h

1 #iâdeà
DROPOUT_LAYER_H


2 
	#DROPOUT_LAYER_H


	)

4 
	~"Ïy”.h
"

5 
	~"ÃtwÜk.h
"

7 
Ïy”
 
	tdrİout_Ïy”
;

9 
drİout_Ïy”
 
make_drİout_Ïy”
(
b©ch
, 
šputs
, 
´obab™y
);

11 
fÜw¬d_drİout_Ïy”
(
drİout_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

12 
backw¬d_drİout_Ïy”
(
drİout_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

13 
»size_drİout_Ïy”
(
drİout_Ïy”
 *
l
, 
šputs
);

15 #ifdeà
GPU


16 
fÜw¬d_drİout_Ïy”_gpu
(
drİout_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

17 
backw¬d_drİout_Ïy”_gpu
(
drİout_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

	@gemm.c

1 
	~"gemm.h
"

2 
	~"uts.h
"

3 
	~"cuda.h
"

4 
	~<¡dlib.h
>

5 
	~<¡dio.h
>

6 
	~<m©h.h
>

8 
	$gemm_bš
(
M
, 
N
, 
K
, 
ALPHA
,

9 *
A
, 
lda
,

10 *
B
, 
ldb
,

11 *
C
, 
ldc
)

13 
i
,
j
,
k
;

14 
i
 = 0; i < 
M
; ++i){

15 
k
 = 0; k < 
K
; ++k){

16 
A_PART
 = 
A
[
i
*
lda
+
k
];

17 if(
A_PART
){

18 
j
 = 0; j < 
N
; ++j){

19 
C
[
i
*
ldc
+
j
] +ğ
B
[
k
*
ldb
+j];

22 
j
 = 0; j < 
N
; ++j){

23 
C
[
i
*
ldc
+
j
] -ğ
B
[
k
*
ldb
+j];

28 
	}
}

30 *
	$¿ndom_m©rix
(
rows
, 
cŞs
)

32 
i
;

33 *
m
 = 
	`ÿÎoc
(
rows
*
cŞs
, ());

34 
i
 = 0; i < 
rows
*
cŞs
; ++i){

35 
m
[
i
] = ()
	`¿nd
()/
RAND_MAX
;

37  
m
;

38 
	}
}

40 
	$time_¿ndom_m©rix
(
TA
, 
TB
, 
m
, 
k
, 
n
)

42 *
a
;

43 if(!
TA
è
a
 = 
	`¿ndom_m©rix
(
m
,
k
);

44 
a
 = 
	`¿ndom_m©rix
(
k
,
m
);

45 
lda
 = (!
TA
)?
k
:
m
;

46 *
b
;

47 if(!
TB
è
b
 = 
	`¿ndom_m©rix
(
k
,
n
);

48 
b
 = 
	`¿ndom_m©rix
(
n
,
k
);

49 
ldb
 = (!
TB
)?
n
:
k
;

51 *
c
 = 
	`¿ndom_m©rix
(
m
,
n
);

52 
i
;

53 
şock_t
 
¡¬t
 = 
	`şock
(), 
’d
;

54 
i
 = 0; i<10; ++i){

55 
	`gemm_ıu
(
TA
,
TB
,
m
,
n
,
k
,1,
a
,
lda
,
b
,
ldb
,1,
c
,n);

57 
’d
 = 
	`şock
();

58 
	`´štf
("M©rix MuÉliÿtiÚ %dx%d * %dx%d, TA=%d, TB=%d: %làms\n",
m
,
k
,k,
n
, 
TA
, 
TB
, ()(
’d
-
¡¬t
)/
CLOCKS_PER_SEC
);

59 
	`ä“
(
a
);

60 
	`ä“
(
b
);

61 
	`ä“
(
c
);

62 
	}
}

65 
	$gemm
(
TA
, 
TB
, 
M
, 
N
, 
K
, 
ALPHA
,

66 *
A
, 
lda
,

67 *
B
, 
ldb
,

68 
BETA
,

69 *
C
, 
ldc
)

71 
	`gemm_ıu
Ğ
TA
, 
TB
, 
M
, 
N
, 
K
, 
ALPHA
,
A
,
lda
, 
B
, 
ldb
,
BETA
,
C
,
ldc
);

72 
	}
}

74 
	$gemm_Â
(
M
, 
N
, 
K
, 
ALPHA
,

75 *
A
, 
lda
,

76 *
B
, 
ldb
,

77 *
C
, 
ldc
)

79 
i
,
j
,
k
;

80 #´agm¨
omp
 
·¿Î–
 

81 
i
 = 0; i < 
M
; ++i){

82 
k
 = 0; k < 
K
; ++k){

83 
A_PART
 = 
ALPHA
*
A
[
i
*
lda
+
k
];

84 
j
 = 0; j < 
N
; ++j){

85 
C
[
i
*
ldc
+
j
] +ğ
A_PART
*
B
[
k
*
ldb
+j];

89 
	}
}

91 
	$gemm_Á
(
M
, 
N
, 
K
, 
ALPHA
,

92 *
A
, 
lda
,

93 *
B
, 
ldb
,

94 *
C
, 
ldc
)

96 
i
,
j
,
k
;

97 #´agm¨
omp
 
·¿Î–
 

98 
i
 = 0; i < 
M
; ++i){

99 
j
 = 0; j < 
N
; ++j){

100 
sum
 = 0;

101 
k
 = 0; k < 
K
; ++k){

102 
sum
 +ğ
ALPHA
*
A
[
i
*
lda
+
k
]*
B
[
j
*
ldb
 + k];

104 
C
[
i
*
ldc
+
j
] +ğ
sum
;

107 
	}
}

109 
	$gemm_Š
(
M
, 
N
, 
K
, 
ALPHA
,

110 *
A
, 
lda
,

111 *
B
, 
ldb
,

112 *
C
, 
ldc
)

114 
i
,
j
,
k
;

115 #´agm¨
omp
 
·¿Î–
 

116 
i
 = 0; i < 
M
; ++i){

117 
k
 = 0; k < 
K
; ++k){

118 
A_PART
 = 
ALPHA
*
A
[
k
*
lda
+
i
];

119 
j
 = 0; j < 
N
; ++j){

120 
C
[
i
*
ldc
+
j
] +ğ
A_PART
*
B
[
k
*
ldb
+j];

124 
	}
}

126 
	$gemm_‰
(
M
, 
N
, 
K
, 
ALPHA
,

127 *
A
, 
lda
,

128 *
B
, 
ldb
,

129 *
C
, 
ldc
)

131 
i
,
j
,
k
;

132 #´agm¨
omp
 
·¿Î–
 

133 
i
 = 0; i < 
M
; ++i){

134 
j
 = 0; j < 
N
; ++j){

135 
sum
 = 0;

136 
k
 = 0; k < 
K
; ++k){

137 
sum
 +ğ
ALPHA
*
A
[
i
+
k
*
lda
]*
B
[k+
j
*
ldb
];

139 
C
[
i
*
ldc
+
j
] +ğ
sum
;

142 
	}
}

145 
	$gemm_ıu
(
TA
, 
TB
, 
M
, 
N
, 
K
, 
ALPHA
,

146 *
A
, 
lda
,

147 *
B
, 
ldb
,

148 
BETA
,

149 *
C
, 
ldc
)

152 
i
, 
j
;

153 
i
 = 0; i < 
M
; ++i){

154 
j
 = 0; j < 
N
; ++j){

155 
C
[
i
*
ldc
 + 
j
] *ğ
BETA
;

158 if(!
TA
 && !
TB
)

159 
	`gemm_Â
(
M
, 
N
, 
K
, 
ALPHA
,
A
,
lda
, 
B
, 
ldb
,
C
,
ldc
);

160 if(
TA
 && !
TB
)

161 
	`gemm_Š
(
M
, 
N
, 
K
, 
ALPHA
,
A
,
lda
, 
B
, 
ldb
,
C
,
ldc
);

162 if(!
TA
 && 
TB
)

163 
	`gemm_Á
(
M
, 
N
, 
K
, 
ALPHA
,
A
,
lda
, 
B
, 
ldb
,
C
,
ldc
);

165 
	`gemm_‰
(
M
, 
N
, 
K
, 
ALPHA
,
A
,
lda
, 
B
, 
ldb
,
C
,
ldc
);

166 
	}
}

168 #ifdeà
GPU


170 
	~<m©h.h
>

172 
	$gemm_gpu
(
TA
, 
TB
, 
M
, 
N
, 
K
, 
ALPHA
,

173 *
A_gpu
, 
lda
,

174 *
B_gpu
, 
ldb
,

175 
BETA
,

176 *
C_gpu
, 
ldc
)

178 
cubÏsHªdË_t
 
hªdË
 = 
	`bÏs_hªdË
();

179 
cudaE¼Ü_t
 
¡©us
 = 
	`cubÏsSgemm
(
hªdË
, (
TB
 ? 
CUBLAS_OP_T
 : 
CUBLAS_OP_N
),

180 (
TA
 ? 
CUBLAS_OP_T
 : 
CUBLAS_OP_N
), 
N
, 
M
, 
K
, &
ALPHA
, 
B_gpu
, 
ldb
, 
A_gpu
, 
lda
, &
BETA
, 
C_gpu
, 
ldc
);

181 
	`check_”rÜ
(
¡©us
);

182 
	}
}

184 
	~<¡dio.h
>

185 
	~<¡dlib.h
>

186 
	~<¡ršg.h
>

187 
	~<time.h
>

189 
	$time_gpu_¿ndom_m©rix
(
TA
, 
TB
, 
m
, 
k
, 
n
)

191 *
a
;

192 if(!
TA
è
a
 = 
	`¿ndom_m©rix
(
m
,
k
);

193 
a
 = 
	`¿ndom_m©rix
(
k
,
m
);

194 
lda
 = (!
TA
)?
k
:
m
;

195 *
b
;

196 if(!
TB
è
b
 = 
	`¿ndom_m©rix
(
k
,
n
);

197 
b
 = 
	`¿ndom_m©rix
(
n
,
k
);

198 
ldb
 = (!
TB
)?
n
:
k
;

200 *
c
 = 
	`¿ndom_m©rix
(
m
,
n
);

201 
i
;

202 
şock_t
 
¡¬t
 = 
	`şock
(), 
’d
;

203 
i
 = 0; i<32; ++i){

204 
	`gemm_gpu
(
TA
,
TB
,
m
,
n
,
k
,1,
a
,
lda
,
b
,
ldb
,1,
c
,n);

206 
’d
 = 
	`şock
();

207 
	`´štf
("M©rix MuÉliÿtiÚ %dx%d * %dx%d, TA=%d, TB=%d: %làs\n",
m
,
k
,k,
n
, 
TA
, 
TB
, ()(
’d
-
¡¬t
)/
CLOCKS_PER_SEC
);

208 
	`ä“
(
a
);

209 
	`ä“
(
b
);

210 
	`ä“
(
c
);

211 
	}
}

213 
	$time_gpu
(
TA
, 
TB
, 
m
, 
k
, 
n
)

215 
™”
 = 10;

216 *
a
 = 
	`¿ndom_m©rix
(
m
,
k
);

217 *
b
 = 
	`¿ndom_m©rix
(
k
,
n
);

219 
lda
 = (!
TA
)?
k
:
m
;

220 
ldb
 = (!
TB
)?
n
:
k
;

222 *
c
 = 
	`¿ndom_m©rix
(
m
,
n
);

224 *
a_ş
 = 
	`cuda_make_¬¿y
(
a
, 
m
*
k
);

225 *
b_ş
 = 
	`cuda_make_¬¿y
(
b
, 
k
*
n
);

226 *
c_ş
 = 
	`cuda_make_¬¿y
(
c
, 
m
*
n
);

228 
i
;

229 
şock_t
 
¡¬t
 = 
	`şock
(), 
’d
;

230 
i
 = 0; i<
™”
; ++i){

231 
	`gemm_gpu
(
TA
,
TB
,
m
,
n
,
k
,1,
a_ş
,
lda
,
b_ş
,
ldb
,1,
c_ş
,n);

232 
	`cudaTh»adSynchrÚize
();

234 
æİ
 = (()
m
)*
n
*(2.*
k
 + 2.)*
™”
;

235 
gæİ
 = 
æİ
/
	`pow
(10., 9);

236 
’d
 = 
	`şock
();

237 
£cÚds
 = 
	`£c
(
’d
-
¡¬t
);

238 
	`´štf
("M©rix MuÉliÿtiÚ %dx%d * %dx%d, TA=%d, TB=%d: %làs, %làGFLOPS\n",
m
,
k
,k,
n
, 
TA
, 
TB
, 
£cÚds
, 
gæİ
/seconds);

239 
	`cuda_ä“
(
a_ş
);

240 
	`cuda_ä“
(
b_ş
);

241 
	`cuda_ä“
(
c_ş
);

242 
	`ä“
(
a
);

243 
	`ä“
(
b
);

244 
	`ä“
(
c
);

245 
	}
}

248 
	$‹¡_gpu_accu¿cy
(
TA
, 
TB
, 
m
, 
k
, 
n
)

250 
	`¤ªd
(0);

251 *
a
;

252 if(!
TA
è
a
 = 
	`¿ndom_m©rix
(
m
,
k
);

253 
a
 = 
	`¿ndom_m©rix
(
k
,
m
);

254 
lda
 = (!
TA
)?
k
:
m
;

255 *
b
;

256 if(!
TB
è
b
 = 
	`¿ndom_m©rix
(
k
,
n
);

257 
b
 = 
	`¿ndom_m©rix
(
n
,
k
);

258 
ldb
 = (!
TB
)?
n
:
k
;

260 *
c
 = 
	`¿ndom_m©rix
(
m
,
n
);

261 *
c_gpu
 = 
	`¿ndom_m©rix
(
m
,
n
);

262 
	`mem£t
(
c
, 0, 
m
*
n
*());

263 
	`mem£t
(
c_gpu
, 0, 
m
*
n
*());

264 
i
;

266 
	`gemm_gpu
(
TA
,
TB
,
m
,
n
,
k
,1,
a
,
lda
,
b
,
ldb
,1,
c_gpu
,n);

270 
	`gemm_ıu
(
TA
,
TB
,
m
,
n
,
k
,1,
a
,
lda
,
b
,
ldb
,1,
c
,n);

273 
s£
 = 0;

274 
i
 = 0; i < 
m
*
n
; ++i) {

276 
s£
 +ğ
	`pow
(
c
[
i
]-
c_gpu
[i], 2);

278 
	`´štf
("M©rix MuÉliÿtiÚ %dx%d * %dx%d, TA=%d, TB=%d: %g SSE\n",
m
,
k
,k,
n
, 
TA
, 
TB
, 
s£
/(m*n));

279 
	`ä“
(
a
);

280 
	`ä“
(
b
);

281 
	`ä“
(
c
);

282 
	`ä“
(
c_gpu
);

283 
	}
}

285 
	$‹¡_gpu_bÏs
()

312 
	`time_gpu
(0,0,64,75,12544);

313 
	`time_gpu
(0,0,64,75,12544);

314 
	`time_gpu
(0,0,64,75,12544);

315 
	`time_gpu
(0,0,64,576,12544);

316 
	`time_gpu
(0,0,256,2304,784);

317 
	`time_gpu
(1,1,2304,256,784);

318 
	`time_gpu
(0,0,512,4608,196);

319 
	`time_gpu
(1,1,4608,512,196);

322 
	}
}

	@gemm.h

1 #iâdeà
GEMM_H


2 
	#GEMM_H


	)

4 
gemm_bš
(
M
, 
N
, 
K
, 
ALPHA
,

5 *
A
, 
lda
,

6 *
B
, 
ldb
,

7 *
C
, 
ldc
);

9 
gemm
(
TA
, 
TB
, 
M
, 
N
, 
K
, 
ALPHA
,

10 *
A
, 
lda
,

11 *
B
, 
ldb
,

12 
BETA
,

13 *
C
, 
ldc
);

15 
gemm_ıu
(
TA
, 
TB
, 
M
, 
N
, 
K
, 
ALPHA
,

16 *
A
, 
lda
,

17 *
B
, 
ldb
,

18 
BETA
,

19 *
C
, 
ldc
);

21 #ifdeà
GPU


22 
gemm_gpu
(
TA
, 
TB
, 
M
, 
N
, 
K
, 
ALPHA
,

23 *
A_gpu
, 
lda
,

24 *
B_gpu
, 
ldb
,

25 
BETA
,

26 *
C_gpu
, 
ldc
);

28 
gemm_gpu
(
TA
, 
TB
, 
M
, 
N
, 
K
, 
ALPHA
,

29 *
A
, 
lda
,

30 *
B
, 
ldb
,

31 
BETA
,

32 *
C
, 
ldc
);

	@gru_layer.c

1 
	~"gru_Ïy”.h
"

2 
	~"cÚÃùed_Ïy”.h
"

3 
	~"uts.h
"

4 
	~"cuda.h
"

5 
	~"bÏs.h
"

6 
	~"gemm.h
"

8 
	~<m©h.h
>

9 
	~<¡dio.h
>

10 
	~<¡dlib.h
>

11 
	~<¡ršg.h
>

13 
	$šüem’t_Ïy”
(
Ïy”
 *
l
, 
¡•s
)

15 
num
 = 
l
->
ouuts
*l->
b©ch
*
¡•s
;

16 
l
->
ouut
 +ğ
num
;

17 
l
->
d–
 +ğ
num
;

18 
l
->
x
 +ğ
num
;

19 
l
->
x_nÜm
 +ğ
num
;

21 #ifdeà
GPU


22 
l
->
ouut_gpu
 +ğ
num
;

23 
l
->
d–_gpu
 +ğ
num
;

24 
l
->
x_gpu
 +ğ
num
;

25 
l
->
x_nÜm_gpu
 +ğ
num
;

27 
	}
}

29 
Ïy”
 
	$make_gru_Ïy”
(
b©ch
, 
šputs
, 
ouuts
, 
¡•s
, 
b©ch_nÜm®ize
, 
adam
)

31 
	`årštf
(
¡d”r
, "GRU Lay”: %d iÅuts, %d ouuts\n", 
šputs
, 
ouuts
);

32 
b©ch
 = b©ch / 
¡•s
;

33 
Ïy”
 
l
 = {0};

34 
l
.
b©ch
 = batch;

35 
l
.
ty³
 = 
GRU
;

36 
l
.
¡•s
 = steps;

37 
l
.
šputs
 = inputs;

39 
l
.
uz
 = 
	`m®loc
((
Ïy”
));

40 
	`årštf
(
¡d”r
, "\t\t");

41 *(
l
.
uz
èğ
	`make_cÚÃùed_Ïy”
(
b©ch
*
¡•s
, 
šputs
, 
ouuts
, 
LINEAR
, 
b©ch_nÜm®ize
, 
adam
);

42 
l
.
uz
->
b©ch
 = batch;

44 
l
.
wz
 = 
	`m®loc
((
Ïy”
));

45 
	`årštf
(
¡d”r
, "\t\t");

46 *(
l
.
wz
èğ
	`make_cÚÃùed_Ïy”
(
b©ch
*
¡•s
, 
ouuts
, ouuts, 
LINEAR
, 
b©ch_nÜm®ize
, 
adam
);

47 
l
.
wz
->
b©ch
 = batch;

49 
l
.
ur
 = 
	`m®loc
((
Ïy”
));

50 
	`årštf
(
¡d”r
, "\t\t");

51 *(
l
.
ur
èğ
	`make_cÚÃùed_Ïy”
(
b©ch
*
¡•s
, 
šputs
, 
ouuts
, 
LINEAR
, 
b©ch_nÜm®ize
, 
adam
);

52 
l
.
ur
->
b©ch
 = batch;

54 
l
.
wr
 = 
	`m®loc
((
Ïy”
));

55 
	`årštf
(
¡d”r
, "\t\t");

56 *(
l
.
wr
èğ
	`make_cÚÃùed_Ïy”
(
b©ch
*
¡•s
, 
ouuts
, ouuts, 
LINEAR
, 
b©ch_nÜm®ize
, 
adam
);

57 
l
.
wr
->
b©ch
 = batch;

61 
l
.
uh
 = 
	`m®loc
((
Ïy”
));

62 
	`årštf
(
¡d”r
, "\t\t");

63 *(
l
.
uh
èğ
	`make_cÚÃùed_Ïy”
(
b©ch
*
¡•s
, 
šputs
, 
ouuts
, 
LINEAR
, 
b©ch_nÜm®ize
, 
adam
);

64 
l
.
uh
->
b©ch
 = batch;

66 
l
.
wh
 = 
	`m®loc
((
Ïy”
));

67 
	`årštf
(
¡d”r
, "\t\t");

68 *(
l
.
wh
èğ
	`make_cÚÃùed_Ïy”
(
b©ch
*
¡•s
, 
ouuts
, ouuts, 
LINEAR
, 
b©ch_nÜm®ize
, 
adam
);

69 
l
.
wh
->
b©ch
 = batch;

71 
l
.
b©ch_nÜm®ize
 = batch_normalize;

74 
l
.
ouuts
 = outputs;

75 
l
.
ouut
 = 
	`ÿÎoc
(
ouuts
*
b©ch
*
¡•s
, ());

76 
l
.
d–
 = 
	`ÿÎoc
(
ouuts
*
b©ch
*
¡•s
, ());

77 
l
.
¡©e
 = 
	`ÿÎoc
(
ouuts
*
b©ch
, ());

78 
l
.
´ev_¡©e
 = 
	`ÿÎoc
(
ouuts
*
b©ch
, ());

79 
l
.
fÜgÙ_¡©e
 = 
	`ÿÎoc
(
ouuts
*
b©ch
, ());

80 
l
.
fÜgÙ_d–
 = 
	`ÿÎoc
(
ouuts
*
b©ch
, ());

82 
l
.
r_ıu
 = 
	`ÿÎoc
(
ouuts
*
b©ch
, ());

83 
l
.
z_ıu
 = 
	`ÿÎoc
(
ouuts
*
b©ch
, ());

84 
l
.
h_ıu
 = 
	`ÿÎoc
(
ouuts
*
b©ch
, ());

86 
l
.
fÜw¬d
 = 
fÜw¬d_gru_Ïy”
;

87 
l
.
backw¬d
 = 
backw¬d_gru_Ïy”
;

88 
l
.
upd©e
 = 
upd©e_gru_Ïy”
;

90 #ifdeà
GPU


91 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_gru_Ïy”_gpu
;

92 
l
.
backw¬d_gpu
 = 
backw¬d_gru_Ïy”_gpu
;

93 
l
.
upd©e_gpu
 = 
upd©e_gru_Ïy”_gpu
;

95 
l
.
fÜgÙ_¡©e_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

96 
l
.
fÜgÙ_d–_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

97 
l
.
´ev_¡©e_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

98 
l
.
¡©e_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

99 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
*
¡•s
);

100 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
*
¡•s
);

101 
l
.
r_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

102 
l
.
z_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

103 
l
.
h_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

105 #ifdeà
CUDNN


106 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
uz
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 
b©ch
,†.uz->
out_c
,†.uz->
out_h
,†.uz->
out_w
);

107 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
uh
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 
b©ch
,†.uh->
out_c
,†.uh->
out_h
,†.uh->
out_w
);

108 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
ur
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 
b©ch
,†.ur->
out_c
,†.ur->
out_h
,†.ur->
out_w
);

109 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
wz
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 
b©ch
,†.wz->
out_c
,†.wz->
out_h
,†.wz->
out_w
);

110 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
wh
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 
b©ch
,†.wh->
out_c
,†.wh->
out_h
,†.wh->
out_w
);

111 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
wr
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 
b©ch
,†.wr->
out_c
,†.wr->
out_h
,†.wr->
out_w
);

115  
l
;

116 
	}
}

118 
	$upd©e_gru_Ïy”
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
)

120 
	`upd©e_cÚÃùed_Ïy”
(*(
l
.
ur
), 
a
);

121 
	`upd©e_cÚÃùed_Ïy”
(*(
l
.
uz
), 
a
);

122 
	`upd©e_cÚÃùed_Ïy”
(*(
l
.
uh
), 
a
);

123 
	`upd©e_cÚÃùed_Ïy”
(*(
l
.
wr
), 
a
);

124 
	`upd©e_cÚÃùed_Ïy”
(*(
l
.
wz
), 
a
);

125 
	`upd©e_cÚÃùed_Ïy”
(*(
l
.
wh
), 
a
);

126 
	}
}

128 
	$fÜw¬d_gru_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

130 
ÃtwÜk
 
s
 = 
Ãt
;

131 
s
.
Œaš
 = 
Ãt
.train;

132 
i
;

133 
Ïy”
 
uz
 = *(
l
.uz);

134 
Ïy”
 
ur
 = *(
l
.ur);

135 
Ïy”
 
uh
 = *(
l
.uh);

137 
Ïy”
 
wz
 = *(
l
.wz);

138 
Ïy”
 
wr
 = *(
l
.wr);

139 
Ïy”
 
wh
 = *(
l
.wh);

141 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
uz
.
d–
, 1);

142 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
ur
.
d–
, 1);

143 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
uh
.
d–
, 1);

145 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
wz
.
d–
, 1);

146 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
wr
.
d–
, 1);

147 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
wh
.
d–
, 1);

148 if(
Ãt
.
Œaš
) {

149 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0,†.
d–
, 1);

150 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
¡©e
, 1,†.
´ev_¡©e
, 1);

153 
i
 = 0; i < 
l
.
¡•s
; ++i) {

154 
s
.
šput
 = 
l
.
¡©e
;

155 
	`fÜw¬d_cÚÃùed_Ïy”
(
wz
, 
s
);

156 
	`fÜw¬d_cÚÃùed_Ïy”
(
wr
, 
s
);

158 
s
.
šput
 = 
Ãt
.input;

159 
	`fÜw¬d_cÚÃùed_Ïy”
(
uz
, 
s
);

160 
	`fÜw¬d_cÚÃùed_Ïy”
(
ur
, 
s
);

161 
	`fÜw¬d_cÚÃùed_Ïy”
(
uh
, 
s
);

164 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
, 
uz
.
ouut
, 1,†.
z_ıu
, 1);

165 
	`axpy_ıu
(
l
.
ouuts
*l.
b©ch
, 1, 
wz
.
ouut
, 1,†.
z_ıu
, 1);

167 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
, 
ur
.
ouut
, 1,†.
r_ıu
, 1);

168 
	`axpy_ıu
(
l
.
ouuts
*l.
b©ch
, 1, 
wr
.
ouut
, 1,†.
r_ıu
, 1);

170 
	`aùiv©e_¬¿y
(
l
.
z_ıu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

171 
	`aùiv©e_¬¿y
(
l
.
r_ıu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

173 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
¡©e
, 1,†.
fÜgÙ_¡©e
, 1);

174 
	`mul_ıu
(
l
.
ouuts
*l.
b©ch
,†.
r_ıu
, 1,†.
fÜgÙ_¡©e
, 1);

176 
s
.
šput
 = 
l
.
fÜgÙ_¡©e
;

177 
	`fÜw¬d_cÚÃùed_Ïy”
(
wh
, 
s
);

179 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
, 
uh
.
ouut
, 1,†.
h_ıu
, 1);

180 
	`axpy_ıu
(
l
.
ouuts
*l.
b©ch
, 1, 
wh
.
ouut
, 1,†.
h_ıu
, 1);

182 if(
l
.
nh
){

183 
	`aùiv©e_¬¿y
(
l
.
h_ıu
,†.
ouuts
*l.
b©ch
, 
TANH
);

185 
	`aùiv©e_¬¿y
(
l
.
h_ıu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

188 
	`weigh‹d_sum_ıu
(
l
.
¡©e
,†.
h_ıu
,†.
z_ıu
,†.
ouuts
*l.
b©ch
,†.
ouut
);

190 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
ouut
, 1,†.
¡©e
, 1);

192 
Ãt
.
šput
 +ğ
l
.
šputs
*l.
b©ch
;

193 
l
.
ouut
 +ğl.
ouuts
*l.
b©ch
;

194 
	`šüem’t_Ïy”
(&
uz
, 1);

195 
	`šüem’t_Ïy”
(&
ur
, 1);

196 
	`šüem’t_Ïy”
(&
uh
, 1);

198 
	`šüem’t_Ïy”
(&
wz
, 1);

199 
	`šüem’t_Ïy”
(&
wr
, 1);

200 
	`šüem’t_Ïy”
(&
wh
, 1);

202 
	}
}

204 
	$backw¬d_gru_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

206 
	}
}

208 #ifdeà
GPU


210 
	$puÎ_gru_Ïy”
(
Ïy”
 
l
)

212 
	}
}

214 
	$push_gru_Ïy”
(
Ïy”
 
l
)

216 
	}
}

218 
	$upd©e_gru_Ïy”_gpu
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
)

220 
	`upd©e_cÚÃùed_Ïy”_gpu
(*(
l
.
ur
), 
a
);

221 
	`upd©e_cÚÃùed_Ïy”_gpu
(*(
l
.
uz
), 
a
);

222 
	`upd©e_cÚÃùed_Ïy”_gpu
(*(
l
.
uh
), 
a
);

223 
	`upd©e_cÚÃùed_Ïy”_gpu
(*(
l
.
wr
), 
a
);

224 
	`upd©e_cÚÃùed_Ïy”_gpu
(*(
l
.
wz
), 
a
);

225 
	`upd©e_cÚÃùed_Ïy”_gpu
(*(
l
.
wh
), 
a
);

226 
	}
}

228 
	$fÜw¬d_gru_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

230 
ÃtwÜk
 
s
 = {0};

231 
s
.
Œaš
 = 
Ãt
.train;

232 
i
;

233 
Ïy”
 
uz
 = *(
l
.uz);

234 
Ïy”
 
ur
 = *(
l
.ur);

235 
Ïy”
 
uh
 = *(
l
.uh);

237 
Ïy”
 
wz
 = *(
l
.wz);

238 
Ïy”
 
wr
 = *(
l
.wr);

239 
Ïy”
 
wh
 = *(
l
.wh);

241 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
uz
.
d–_gpu
, 1);

242 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
ur
.
d–_gpu
, 1);

243 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
uh
.
d–_gpu
, 1);

245 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
wz
.
d–_gpu
, 1);

246 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
wr
.
d–_gpu
, 1);

247 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
wh
.
d–_gpu
, 1);

248 if(
Ãt
.
Œaš
) {

249 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0,†.
d–_gpu
, 1);

250 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
¡©e_gpu
, 1,†.
´ev_¡©e_gpu
, 1);

253 
i
 = 0; i < 
l
.
¡•s
; ++i) {

254 
s
.
šput_gpu
 = 
l
.
¡©e_gpu
;

255 
	`fÜw¬d_cÚÃùed_Ïy”_gpu
(
wz
, 
s
);

256 
	`fÜw¬d_cÚÃùed_Ïy”_gpu
(
wr
, 
s
);

258 
s
.
šput_gpu
 = 
Ãt
.input_gpu;

259 
	`fÜw¬d_cÚÃùed_Ïy”_gpu
(
uz
, 
s
);

260 
	`fÜw¬d_cÚÃùed_Ïy”_gpu
(
ur
, 
s
);

261 
	`fÜw¬d_cÚÃùed_Ïy”_gpu
(
uh
, 
s
);

263 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
uz
.
ouut_gpu
, 1,†.
z_gpu
, 1);

264 
	`axpy_gpu
(
l
.
ouuts
*l.
b©ch
, 1, 
wz
.
ouut_gpu
, 1,†.
z_gpu
, 1);

266 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
ur
.
ouut_gpu
, 1,†.
r_gpu
, 1);

267 
	`axpy_gpu
(
l
.
ouuts
*l.
b©ch
, 1, 
wr
.
ouut_gpu
, 1,†.
r_gpu
, 1);

269 
	`aùiv©e_¬¿y_gpu
(
l
.
z_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

270 
	`aùiv©e_¬¿y_gpu
(
l
.
r_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

272 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
¡©e_gpu
, 1,†.
fÜgÙ_¡©e_gpu
, 1);

273 
	`mul_gpu
(
l
.
ouuts
*l.
b©ch
,†.
r_gpu
, 1,†.
fÜgÙ_¡©e_gpu
, 1);

275 
s
.
šput_gpu
 = 
l
.
fÜgÙ_¡©e_gpu
;

276 
	`fÜw¬d_cÚÃùed_Ïy”_gpu
(
wh
, 
s
);

278 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
uh
.
ouut_gpu
, 1,†.
h_gpu
, 1);

279 
	`axpy_gpu
(
l
.
ouuts
*l.
b©ch
, 1, 
wh
.
ouut_gpu
, 1,†.
h_gpu
, 1);

281 if(
l
.
nh
){

282 
	`aùiv©e_¬¿y_gpu
(
l
.
h_gpu
,†.
ouuts
*l.
b©ch
, 
TANH
);

284 
	`aùiv©e_¬¿y_gpu
(
l
.
h_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

287 
	`weigh‹d_sum_gpu
(
l
.
¡©e_gpu
,†.
h_gpu
,†.
z_gpu
,†.
ouuts
*l.
b©ch
,†.
ouut_gpu
);

288 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
ouut_gpu
, 1,†.
¡©e_gpu
, 1);

290 
Ãt
.
šput_gpu
 +ğ
l
.
šputs
*l.
b©ch
;

291 
l
.
ouut_gpu
 +ğl.
ouuts
*l.
b©ch
;

292 
	`šüem’t_Ïy”
(&
uz
, 1);

293 
	`šüem’t_Ïy”
(&
ur
, 1);

294 
	`šüem’t_Ïy”
(&
uh
, 1);

296 
	`šüem’t_Ïy”
(&
wz
, 1);

297 
	`šüem’t_Ïy”
(&
wr
, 1);

298 
	`šüem’t_Ïy”
(&
wh
, 1);

300 
	}
}

302 
	$backw¬d_gru_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

304 
ÃtwÜk
 
s
 = {0};

305 
s
.
Œaš
 = 
Ãt
.train;

306 
i
;

307 
Ïy”
 
uz
 = *(
l
.uz);

308 
Ïy”
 
ur
 = *(
l
.ur);

309 
Ïy”
 
uh
 = *(
l
.uh);

311 
Ïy”
 
wz
 = *(
l
.wz);

312 
Ïy”
 
wr
 = *(
l
.wr);

313 
Ïy”
 
wh
 = *(
l
.wh);

315 
	`šüem’t_Ïy”
(&
uz
, 
l
.
¡•s
 - 1);

316 
	`šüem’t_Ïy”
(&
ur
, 
l
.
¡•s
 - 1);

317 
	`šüem’t_Ïy”
(&
uh
, 
l
.
¡•s
 - 1);

319 
	`šüem’t_Ïy”
(&
wz
, 
l
.
¡•s
 - 1);

320 
	`šüem’t_Ïy”
(&
wr
, 
l
.
¡•s
 - 1);

321 
	`šüem’t_Ïy”
(&
wh
, 
l
.
¡•s
 - 1);

323 
Ãt
.
šput_gpu
 +ğ
l
.
šputs
*l.
b©ch
*Ö.
¡•s
-1);

324 if(
Ãt
.
d–_gpu
èÃt.d–_gpu +ğ
l
.
šputs
*l.
b©ch
*Ö.
¡•s
-1);

325 
l
.
ouut_gpu
 +ğl.
ouuts
*l.
b©ch
*Ö.
¡•s
-1);

326 
l
.
d–_gpu
 +ğl.
ouuts
*l.
b©ch
*Ö.
¡•s
-1);

327 *
’d_¡©e
 = 
l
.
ouut_gpu
;

328 
i
 = 
l
.
¡•s
-1; i >= 0; --i) {

329 if(
i
 !ğ0è
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
ouut_gpu
 -†.ouuts*l.b©ch, 1,†.
¡©e_gpu
, 1);

330 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
´ev_¡©e_gpu
, 1,†.
¡©e_gpu
, 1);

331 *
´ev_d–_gpu
 = (
i
 =ğ0è? 0 : 
l
.
d–_gpu
 -†.
ouuts
*l.
b©ch
;

333 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
uz
.
ouut_gpu
, 1,†.
z_gpu
, 1);

334 
	`axpy_gpu
(
l
.
ouuts
*l.
b©ch
, 1, 
wz
.
ouut_gpu
, 1,†.
z_gpu
, 1);

336 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
ur
.
ouut_gpu
, 1,†.
r_gpu
, 1);

337 
	`axpy_gpu
(
l
.
ouuts
*l.
b©ch
, 1, 
wr
.
ouut_gpu
, 1,†.
r_gpu
, 1);

339 
	`aùiv©e_¬¿y_gpu
(
l
.
z_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

340 
	`aùiv©e_¬¿y_gpu
(
l
.
r_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

342 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
uh
.
ouut_gpu
, 1,†.
h_gpu
, 1);

343 
	`axpy_gpu
(
l
.
ouuts
*l.
b©ch
, 1, 
wh
.
ouut_gpu
, 1,†.
h_gpu
, 1);

345 if(
l
.
nh
){

346 
	`aùiv©e_¬¿y_gpu
(
l
.
h_gpu
,†.
ouuts
*l.
b©ch
, 
TANH
);

348 
	`aùiv©e_¬¿y_gpu
(
l
.
h_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

351 
	`weigh‹d_d–_gpu
(
l
.
¡©e_gpu
,†.
h_gpu
,†.
z_gpu
, 
´ev_d–_gpu
, 
uh
.
d–_gpu
, 
uz
.d–_gpu,†.
ouuts
*l.
b©ch
,†.delta_gpu);

353 if(
l
.
nh
){

354 
	`g¿d›Á_¬¿y_gpu
(
l
.
h_gpu
,†.
ouuts
*l.
b©ch
, 
TANH
, 
uh
.
d–_gpu
);

356 
	`g¿d›Á_¬¿y_gpu
(
l
.
h_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
, 
uh
.
d–_gpu
);

359 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
uh
.
d–_gpu
, 1, 
wh
.delta_gpu, 1);

361 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
¡©e_gpu
, 1,†.
fÜgÙ_¡©e_gpu
, 1);

362 
	`mul_gpu
(
l
.
ouuts
*l.
b©ch
,†.
r_gpu
, 1,†.
fÜgÙ_¡©e_gpu
, 1);

363 
	`fl_gpu
(
l
.
ouuts
*l.
b©ch
, 0,†.
fÜgÙ_d–_gpu
, 1);

365 
s
.
šput_gpu
 = 
l
.
fÜgÙ_¡©e_gpu
;

366 
s
.
d–_gpu
 = 
l
.
fÜgÙ_d–_gpu
;

368 
	`backw¬d_cÚÃùed_Ïy”_gpu
(
wh
, 
s
);

369 if(
´ev_d–_gpu
è
	`muÉ_add_što_gpu
(
l
.
ouuts
*l.
b©ch
,†.
fÜgÙ_d–_gpu
,†.
r_gpu
,…rev_delta_gpu);

370 
	`muÉ_add_što_gpu
(
l
.
ouuts
*l.
b©ch
,†.
fÜgÙ_d–_gpu
,†.
¡©e_gpu
, 
ur
.
d–_gpu
);

372 
	`g¿d›Á_¬¿y_gpu
(
l
.
r_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
, 
ur
.
d–_gpu
);

373 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
ur
.
d–_gpu
, 1, 
wr
.delta_gpu, 1);

375 
	`g¿d›Á_¬¿y_gpu
(
l
.
z_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
, 
uz
.
d–_gpu
);

376 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
uz
.
d–_gpu
, 1, 
wz
.delta_gpu, 1);

378 
s
.
šput_gpu
 = 
l
.
¡©e_gpu
;

379 
s
.
d–_gpu
 = 
´ev_d–_gpu
;

381 
	`backw¬d_cÚÃùed_Ïy”_gpu
(
wr
, 
s
);

382 
	`backw¬d_cÚÃùed_Ïy”_gpu
(
wz
, 
s
);

384 
s
.
šput_gpu
 = 
Ãt
.input_gpu;

385 
s
.
d–_gpu
 = 
Ãt
.delta_gpu;

387 
	`backw¬d_cÚÃùed_Ïy”_gpu
(
uh
, 
s
);

388 
	`backw¬d_cÚÃùed_Ïy”_gpu
(
ur
, 
s
);

389 
	`backw¬d_cÚÃùed_Ïy”_gpu
(
uz
, 
s
);

392 
Ãt
.
šput_gpu
 -ğ
l
.
šputs
*l.
b©ch
;

393 if(
Ãt
.
d–_gpu
èÃt.d–_gpu -ğ
l
.
šputs
*l.
b©ch
;

394 
l
.
ouut_gpu
 -ğl.
ouuts
*l.
b©ch
;

395 
l
.
d–_gpu
 -ğl.
ouuts
*l.
b©ch
;

396 
	`šüem’t_Ïy”
(&
uz
, -1);

397 
	`šüem’t_Ïy”
(&
ur
, -1);

398 
	`šüem’t_Ïy”
(&
uh
, -1);

400 
	`šüem’t_Ïy”
(&
wz
, -1);

401 
	`šüem’t_Ïy”
(&
wr
, -1);

402 
	`šüem’t_Ïy”
(&
wh
, -1);

404 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
’d_¡©e
, 1,†.
¡©e_gpu
, 1);

405 
	}
}

	@gru_layer.h

2 #iâdeà
GRU_LAYER_H


3 
	#GRU_LAYER_H


	)

5 
	~"aùiv©iÚs.h
"

6 
	~"Ïy”.h
"

7 
	~"ÃtwÜk.h
"

9 
Ïy”
 
make_gru_Ïy”
(
b©ch
, 
šputs
, 
ouuts
, 
¡•s
, 
b©ch_nÜm®ize
, 
adam
);

11 
fÜw¬d_gru_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
¡©e
);

12 
backw¬d_gru_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
¡©e
);

13 
upd©e_gru_Ïy”
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
);

15 #ifdeà
GPU


16 
fÜw¬d_gru_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
¡©e
);

17 
backw¬d_gru_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
¡©e
);

18 
upd©e_gru_Ïy”_gpu
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
);

19 
push_gru_Ïy”
(
Ïy”
 
l
);

20 
puÎ_gru_Ïy”
(
Ïy”
 
l
);

	@im2col.c

1 
	~"im2cŞ.h
"

2 
	~<¡dio.h
>

3 
	$im2cŞ_g‘_pix–
(*
im
, 
height
, 
width
, 
chªÃls
,

4 
row
, 
cŞ
, 
chªÃl
, 
·d
)

6 
row
 -ğ
·d
;

7 
cŞ
 -ğ
·d
;

9 ià(
row
 < 0 || 
cŞ
 < 0 ||

10 
row
 >ğ
height
 || 
cŞ
 >ğ
width
)  0;

11  
im
[
cŞ
 + 
width
*(
row
 + 
height
*
chªÃl
)];

12 
	}
}

16 
	$im2cŞ_ıu
(* 
d©a_im
,

17 
chªÃls
, 
height
, 
width
,

18 
ksize
, 
¡ride
, 
·d
, * 
d©a_cŞ
)

20 
c
,
h
,
w
;

21 
height_cŞ
 = (
height
 + 2*
·d
 - 
ksize
è/ 
¡ride
 + 1;

22 
width_cŞ
 = (
width
 + 2*
·d
 - 
ksize
è/ 
¡ride
 + 1;

24 
chªÃls_cŞ
 = 
chªÃls
 * 
ksize
 * ksize;

25 
c
 = 0; c < 
chªÃls_cŞ
; ++c) {

26 
w_off£t
 = 
c
 % 
ksize
;

27 
h_off£t
 = (
c
 / 
ksize
) % ksize;

28 
c_im
 = 
c
 / 
ksize
 / ksize;

29 
h
 = 0; h < 
height_cŞ
; ++h) {

30 
w
 = 0; w < 
width_cŞ
; ++w) {

31 
im_row
 = 
h_off£t
 + 
h
 * 
¡ride
;

32 
im_cŞ
 = 
w_off£t
 + 
w
 * 
¡ride
;

33 
cŞ_šdex
 = (
c
 * 
height_cŞ
 + 
h
è* 
width_cŞ
 + 
w
;

34 
d©a_cŞ
[
cŞ_šdex
] = 
	`im2cŞ_g‘_pix–
(
d©a_im
, 
height
, 
width
, 
chªÃls
,

35 
im_row
, 
im_cŞ
, 
c_im
, 
·d
);

39 
	}
}

	@im2col.h

1 #iâdeà
IM2COL_H


2 
	#IM2COL_H


	)

4 
im2cŞ_ıu
(* 
d©a_im
,

5 
chªÃls
, 
height
, 
width
,

6 
ksize
, 
¡ride
, 
·d
, * 
d©a_cŞ
);

8 #ifdeà
GPU


10 
im2cŞ_gpu
(*
im
,

11 
chªÃls
, 
height
, 
width
,

12 
ksize
, 
¡ride
, 
·d
,*
d©a_cŞ
);

	@image.c

1 
	~"image.h
"

2 
	~"uts.h
"

3 
	~"bÏs.h
"

4 
	~"cuda.h
"

5 
	~<¡dio.h
>

6 
	~<m©h.h
>

8 
	#STB_IMAGE_IMPLEMENTATION


	)

9 
	~"¡b_image.h
"

10 
	#STB_IMAGE_WRITE_IMPLEMENTATION


	)

11 
	~"¡b_image_wr™e.h
"

13 
	gwšdows
 = 0;

15 
	gcŞÜs
[6][3] = { {1,0,1}, {0,0,1},{0,1,1},{0,1,0},{1,1,0},{1,0,0} };

17 
	$g‘_cŞÜ
(
c
, 
x
, 
max
)

19 
¿tio
 = (()
x
/
max
)*5;

20 
i
 = 
	`æoÜ
(
¿tio
);

21 
j
 = 
	`û
(
¿tio
);

22 
¿tio
 -ğ
i
;

23 
r
 = (1-
¿tio
è* 
cŞÜs
[
i
][
c
] +„©io*cŞÜs[
j
][c];

25  
r
;

26 
	}
}

28 
image
 
	$mask_to_rgb
(
image
 
mask
)

30 
n
 = 
mask
.
c
;

31 
image
 
im
 = 
	`make_image
(
mask
.
w
, mask.
h
, 3);

32 
i
, 
j
;

33 
j
 = 0; j < 
n
; ++j){

34 
off£t
 = 
j
*123457 % 
n
;

35 
»d
 = 
	`g‘_cŞÜ
(2,
off£t
,
n
);

36 
g»’
 = 
	`g‘_cŞÜ
(1,
off£t
,
n
);

37 
blue
 = 
	`g‘_cŞÜ
(0,
off£t
,
n
);

38 
i
 = 0; i < 
im
.
w
*im.
h
; ++i){

39 
im
.
d©a
[
i
 + 0*im.
w
*im.
h
] +ğ
mask
.d©a[
j
*im.h*im.w + i]*
»d
;

40 
im
.
d©a
[
i
 + 1*im.
w
*im.
h
] +ğ
mask
.d©a[
j
*im.h*im.w + i]*
g»’
;

41 
im
.
d©a
[
i
 + 2*im.
w
*im.
h
] +ğ
mask
.d©a[
j
*im.h*im.w + i]*
blue
;

44  
im
;

45 
	}
}

47 
	$g‘_pix–
(
image
 
m
, 
x
, 
y
, 
c
)

49 
	`as£¹
(
x
 < 
m
.
w
 && 
y
 < m.
h
 && 
c
 < m.c);

50  
m
.
d©a
[
c
*m.
h
*m.
w
 + 
y
*m.w + 
x
];

51 
	}
}

52 
	$g‘_pix–_ex‹nd
(
image
 
m
, 
x
, 
y
, 
c
)

54 if(
x
 < 0 || x >ğ
m
.
w
 || 
y
 < 0 || y >ğm.
h
)  0;

61 if(
c
 < 0 || c >ğ
m
.c)  0;

62  
	`g‘_pix–
(
m
, 
x
, 
y
, 
c
);

63 
	}
}

64 
	$£t_pix–
(
image
 
m
, 
x
, 
y
, 
c
, 
v®
)

66 ià(
x
 < 0 || 
y
 < 0 || 
c
 < 0 || x >ğ
m
.
w
 || y >ğm.
h
 || c >= m.c) ;

67 
	`as£¹
(
x
 < 
m
.
w
 && 
y
 < m.
h
 && 
c
 < m.c);

68 
m
.
d©a
[
c
*m.
h
*m.
w
 + 
y
*m.w + 
x
] = 
v®
;

69 
	}
}

70 
	$add_pix–
(
image
 
m
, 
x
, 
y
, 
c
, 
v®
)

72 
	`as£¹
(
x
 < 
m
.
w
 && 
y
 < m.
h
 && 
c
 < m.c);

73 
m
.
d©a
[
c
*m.
h
*m.
w
 + 
y
*m.w + 
x
] +ğ
v®
;

74 
	}
}

76 
	$bš—r_š‹½Ş©e
(
image
 
im
, 
x
, 
y
, 
c
)

78 
ix
 = (è
	`æoÜf
(
x
);

79 
iy
 = (è
	`æoÜf
(
y
);

81 
dx
 = 
x
 - 
ix
;

82 
dy
 = 
y
 - 
iy
;

84 
v®
 = (1-
dy
è* (1-
dx
è* 
	`g‘_pix–_ex‹nd
(
im
, 
ix
, 
iy
, 
c
) +

85 
dy
 * (1-
dx
è* 
	`g‘_pix–_ex‹nd
(
im
, 
ix
, 
iy
+1, 
c
) +

86 (1-
dy
è* 
dx
 * 
	`g‘_pix–_ex‹nd
(
im
, 
ix
+1, 
iy
, 
c
) +

87 
dy
 * 
dx
 * 
	`g‘_pix–_ex‹nd
(
im
, 
ix
+1, 
iy
+1, 
c
);

88  
v®
;

89 
	}
}

92 
	$compos™e_image
(
image
 
sourû
, imag
de¡
, 
dx
, 
dy
)

94 
x
,
y
,
k
;

95 
k
 = 0; k < 
sourû
.
c
; ++k){

96 
y
 = 0; y < 
sourû
.
h
; ++y){

97 
x
 = 0; x < 
sourû
.
w
; ++x){

98 
v®
 = 
	`g‘_pix–
(
sourû
, 
x
, 
y
, 
k
);

99 
v®2
 = 
	`g‘_pix–_ex‹nd
(
de¡
, 
dx
+
x
, 
dy
+
y
, 
k
);

100 
	`£t_pix–
(
de¡
, 
dx
+
x
, 
dy
+
y
, 
k
, 
v®
 * 
v®2
);

104 
	}
}

106 
image
 
	$bÜd”_image
(
image
 
a
, 
bÜd”
)

108 
image
 
b
 = 
	`make_image
(
a
.
w
 + 2*
bÜd”
,‡.
h
 + 2*bÜd”,‡.
c
);

109 
x
,
y
,
k
;

110 
k
 = 0; k < 
b
.
c
; ++k){

111 
y
 = 0; y < 
b
.
h
; ++y){

112 
x
 = 0; x < 
b
.
w
; ++x){

113 
v®
 = 
	`g‘_pix–_ex‹nd
(
a
, 
x
 - 
bÜd”
, 
y
 - bÜd”, 
k
);

114 if(
x
 - 
bÜd”
 < 0 || x - bÜd” >ğ
a
.
w
 || 
y
 - bÜd” < 0 || y - bÜd” >ğa.
h
è
v®
 = 1;

115 
	`£t_pix–
(
b
, 
x
, 
y
, 
k
, 
v®
);

119  
b
;

120 
	}
}

122 
image
 
	$te_images
(
image
 
a
, imag
b
, 
dx
)

124 if(
a
.
w
 =ğ0è 
	`cİy_image
(
b
);

125 
image
 
c
 = 
	`make_image
(
a
.
w
 + 
b
.w + 
dx
, (a.
h
 > b.h) ?‡.h : b.h, (a.c > b.c) ?‡.c : b.c);

126 
	`fl_ıu
(
c
.
w
*c.
h
*c.c, 1, c.
d©a
, 1);

127 
	`embed_image
(
a
, 
c
, 0, 0);

128 
	`compos™e_image
(
b
, 
c
, 
a
.
w
 + 
dx
, 0);

129  
c
;

130 
	}
}

132 
image
 
	$g‘_Ïb–
(
image
 **
ch¬aù”s
, *
¡ršg
, 
size
)

134 
size
 = size/10;

135 if(
size
 > 7) size = 7;

136 
image
 
Ïb–
 = 
	`make_em±y_image
(0,0,0);

137 *
¡ršg
){

138 
image
 
l
 = 
ch¬aù”s
[
size
][()*
¡ršg
];

139 
image
 
n
 = 
	`te_images
(
Ïb–
, 
l
, -
size
 - 1 + (size+1)/2);

140 
	`ä“_image
(
Ïb–
);

141 
Ïb–
 = 
n
;

142 ++
¡ršg
;

144 
image
 
b
 = 
	`bÜd”_image
(
Ïb–
,†ab–.
h
*.25);

145 
	`ä“_image
(
Ïb–
);

146  
b
;

147 
	}
}

149 
	$d¿w_Ïb–
(
image
 
a
, 
r
, 
c
, imag
Ïb–
, cÚ¡ *
rgb
)

151 
w
 = 
Ïb–
.w;

152 
h
 = 
Ïb–
.h;

153 ià(
r
 - 
h
 >= 0)„ =„ - h;

155 
i
, 
j
, 
k
;

156 
j
 = 0; j < 
h
 && j + 
r
 < 
a
.h; ++j){

157 
i
 = 0; i < 
w
 && i + 
c
 < 
a
.w; ++i){

158 
k
 = 0; k < 
Ïb–
.
c
; ++k){

159 
v®
 = 
	`g‘_pix–
(
Ïb–
, 
i
, 
j
, 
k
);

160 
	`£t_pix–
(
a
, 
i
+
c
, 
j
+
r
, 
k
, 
rgb
[k] * 
v®
);

164 
	}
}

166 
	$d¿w_box
(
image
 
a
, 
x1
, 
y1
, 
x2
, 
y2
, 
r
, 
g
, 
b
)

169 
i
;

170 if(
x1
 < 0) x1 = 0;

171 if(
x1
 >ğ
a
.
w
) x1 =‡.w-1;

172 if(
x2
 < 0) x2 = 0;

173 if(
x2
 >ğ
a
.
w
) x2 =‡.w-1;

175 if(
y1
 < 0) y1 = 0;

176 if(
y1
 >ğ
a
.
h
) y1 =‡.h-1;

177 if(
y2
 < 0) y2 = 0;

178 if(
y2
 >ğ
a
.
h
) y2 =‡.h-1;

180 
i
 = 
x1
; i <ğ
x2
; ++i){

181 
a
.
d©a
[
i
 + 
y1
*a.
w
 + 0*a.w*a.
h
] = 
r
;

182 
a
.
d©a
[
i
 + 
y2
*a.
w
 + 0*a.w*a.
h
] = 
r
;

184 
a
.
d©a
[
i
 + 
y1
*a.
w
 + 1*a.w*a.
h
] = 
g
;

185 
a
.
d©a
[
i
 + 
y2
*a.
w
 + 1*a.w*a.
h
] = 
g
;

187 
a
.
d©a
[
i
 + 
y1
*a.
w
 + 2*a.w*a.
h
] = 
b
;

188 
a
.
d©a
[
i
 + 
y2
*a.
w
 + 2*a.w*a.
h
] = 
b
;

190 
i
 = 
y1
; i <ğ
y2
; ++i){

191 
a
.
d©a
[
x1
 + 
i
*a.
w
 + 0*a.w*a.
h
] = 
r
;

192 
a
.
d©a
[
x2
 + 
i
*a.
w
 + 0*a.w*a.
h
] = 
r
;

194 
a
.
d©a
[
x1
 + 
i
*a.
w
 + 1*a.w*a.
h
] = 
g
;

195 
a
.
d©a
[
x2
 + 
i
*a.
w
 + 1*a.w*a.
h
] = 
g
;

197 
a
.
d©a
[
x1
 + 
i
*a.
w
 + 2*a.w*a.
h
] = 
b
;

198 
a
.
d©a
[
x2
 + 
i
*a.
w
 + 2*a.w*a.
h
] = 
b
;

200 
	}
}

202 
	$d¿w_box_width
(
image
 
a
, 
x1
, 
y1
, 
x2
, 
y2
, 
w
, 
r
, 
g
, 
b
)

204 
i
;

205 
i
 = 0; i < 
w
; ++i){

206 
	`d¿w_box
(
a
, 
x1
+
i
, 
y1
+i, 
x2
-i, 
y2
-i, 
r
, 
g
, 
b
);

208 
	}
}

210 
	$d¿w_bbox
(
image
 
a
, 
box
 
bbox
, 
w
, 
r
, 
g
, 
b
)

212 
Ëá
 = (
bbox
.
x
-bbox.
w
/2)*
a
.w;

213 
right
 = (
bbox
.
x
+bbox.
w
/2)*
a
.w;

214 
tİ
 = (
bbox
.
y
-bbox.
h
/2)*
a
.h;

215 
bÙ
 = (
bbox
.
y
+bbox.
h
/2)*
a
.h;

217 
i
;

218 
i
 = 0; i < 
w
; ++i){

219 
	`d¿w_box
(
a
, 
Ëá
+
i
, 
tİ
+i, 
right
-i, 
bÙ
-i, 
r
, 
g
, 
b
);

221 
	}
}

223 
image
 **
	$lßd_®phab‘
()

225 
i
, 
j
;

226 cÚ¡ 
nsize
 = 8;

227 
image
 **
®phab‘s
 = 
	`ÿÎoc
(
nsize
, (image));

228 
j
 = 0; j < 
nsize
; ++j){

229 
®phab‘s
[
j
] = 
	`ÿÎoc
(128, (
image
));

230 
i
 = 32; i < 127; ++i){

231 
buff
[256];

232 
	`¥rštf
(
buff
, "d©a/Ïb–s/%d_%d.²g", 
i
, 
j
);

233 
®phab‘s
[
j
][
i
] = 
	`lßd_image_cŞÜ
(
buff
, 0, 0);

236  
®phab‘s
;

237 
	}
}

239 
	$d¿w_d‘eùiÚs
(
image
 
im
, 
d‘eùiÚ
 *
d‘s
, 
num
, 
th»sh
, **
Çmes
, imag**
®phab‘
, 
şas£s
)

241 
i
,
j
;

243 
i
 = 0; i < 
num
; ++i){

244 
Ïb–¡r
[4096] = {0};

245 
şass
 = -1;

246 
j
 = 0; j < 
şas£s
; ++j){

247 ià(
d‘s
[
i
].
´ob
[
j
] > 
th»sh
){

248 ià(
şass
 < 0) {

249 
	`¡rÿt
(
Ïb–¡r
, 
Çmes
[
j
]);

250 
şass
 = 
j
;

252 
	`¡rÿt
(
Ïb–¡r
, ", ");

253 
	`¡rÿt
(
Ïb–¡r
, 
Çmes
[
j
]);

255 
	`´štf
("%s: %.0f%%\n", 
Çmes
[
j
], 
d‘s
[
i
].
´ob
[j]*100);

258 if(
şass
 >= 0){

259 
width
 = 
im
.
h
 * .006;

269 
off£t
 = 
şass
*123457 % 
şas£s
;

270 
»d
 = 
	`g‘_cŞÜ
(2,
off£t
,
şas£s
);

271 
g»’
 = 
	`g‘_cŞÜ
(1,
off£t
,
şas£s
);

272 
blue
 = 
	`g‘_cŞÜ
(0,
off£t
,
şas£s
);

273 
rgb
[3];

277 
rgb
[0] = 
»d
;

278 
rgb
[1] = 
g»’
;

279 
rgb
[2] = 
blue
;

280 
box
 
b
 = 
d‘s
[
i
].
bbox
;

283 
Ëá
 = (
b
.
x
-b.
w
/2.)*
im
.w;

284 
right
 = (
b
.
x
+b.
w
/2.)*
im
.w;

285 
tİ
 = (
b
.
y
-b.
h
/2.)*
im
.h;

286 
bÙ
 = (
b
.
y
+b.
h
/2.)*
im
.h;

288 if(
Ëá
 < 0)†eft = 0;

289 if(
right
 > 
im
.
w
-1)„ight = im.w-1;

290 if(
tİ
 < 0)op = 0;

291 if(
bÙ
 > 
im
.
h
-1) bot = im.h-1;

293 
	`d¿w_box_width
(
im
, 
Ëá
, 
tİ
, 
right
, 
bÙ
, 
width
, 
»d
, 
g»’
, 
blue
);

294 ià(
®phab‘
) {

295 
image
 
Ïb–
 = 
	`g‘_Ïb–
(
®phab‘
, 
Ïb–¡r
, (
im
.
h
*.03));

296 
	`d¿w_Ïb–
(
im
, 
tİ
 + 
width
, 
Ëá
, 
Ïb–
, 
rgb
);

297 
	`ä“_image
(
Ïb–
);

299 ià(
d‘s
[
i
].
mask
){

300 
image
 
mask
 = 
	`æßt_to_image
(14, 14, 1, 
d‘s
[
i
].mask);

301 
image
 
»sized_mask
 = 
	`»size_image
(
mask
, 
b
.
w
*
im
.w, b.
h
*im.h);

302 
image
 
tmask
 = 
	`th»shŞd_image
(
»sized_mask
, .5);

303 
	`embed_image
(
tmask
, 
im
, 
Ëá
, 
tİ
);

304 
	`ä“_image
(
mask
);

305 
	`ä“_image
(
»sized_mask
);

306 
	`ä“_image
(
tmask
);

310 
	}
}

312 
	$Œª¥o£_image
(
image
 
im
)

314 
	`as£¹
(
im
.
w
 =ğim.
h
);

315 
n
, 
m
;

316 
c
;

317 
c
 = 0; c < 
im
.c; ++c){

318 
n
 = 0;‚ < 
im
.
w
-1; ++n){

319 
m
 = 
n
 + 1; m < 
im
.
w
; ++m){

320 
sw­
 = 
im
.
d©a
[
m
 + im.
w
*(
n
 + im.
h
*
c
)];

321 
im
.
d©a
[
m
 + im.
w
*(
n
 + im.
h
*
c
)] = im.data[n + im.w*(m + im.h*c)];

322 
im
.
d©a
[
n
 + im.
w
*(
m
 + im.
h
*
c
)] = 
sw­
;

326 
	}
}

328 
	$rÙ©e_image_cw
(
image
 
im
, 
times
)

330 
	`as£¹
(
im
.
w
 =ğim.
h
);

331 
times
 = (times + 400) % 4;

332 
i
, 
x
, 
y
, 
c
;

333 
n
 = 
im
.
w
;

334 
i
 = 0; i < 
times
; ++i){

335 
c
 = 0; c < 
im
.c; ++c){

336 
x
 = 0; x < 
n
/2; ++x){

337 
y
 = 0; y < (
n
-1)/2 + 1; ++y){

338 
‹mp
 = 
im
.
d©a
[
y
 + im.
w
*(
x
 + im.
h
*
c
)];

339 
im
.
d©a
[
y
 + im.
w
*(
x
 + im.
h
*
c
)] = im.d©a[
n
-1-x + im.w*(y + im.h*c)];

340 
im
.
d©a
[
n
-1-
x
 + im.
w
*(
y
 + im.
h
*
c
)] = im.data[n-1-y + im.w*(n-1-x + im.h*c)];

341 
im
.
d©a
[
n
-1-
y
 + im.
w
*Ò-1-
x
 + im.
h
*
c
)] = im.data[x + im.w*(n-1-y + im.h*c)];

342 
im
.
d©a
[
x
 + im.
w
*(
n
-1-
y
 + im.
h
*
c
)] = 
‹mp
;

347 
	}
}

349 
	$æ_image
(
image
 
a
)

351 
i
,
j
,
k
;

352 
k
 = 0; k < 
a
.
c
; ++k){

353 
i
 = 0; i < 
a
.
h
; ++i){

354 
j
 = 0; j < 
a
.
w
/2; ++j){

355 
šdex
 = 
j
 + 
a
.
w
*(
i
 +‡.
h
*(
k
));

356 
æ
 = (
a
.
w
 - 
j
 - 1è+‡.w*(
i
 +‡.
h
*(
k
));

357 
sw­
 = 
a
.
d©a
[
æ
];

358 
a
.
d©a
[
æ
] =‡.d©a[
šdex
];

359 
a
.
d©a
[
šdex
] = 
sw­
;

363 
	}
}

365 
image
 
	$image_di¡ªû
(
image
 
a
, imag
b
)

367 
i
,
j
;

368 
image
 
di¡
 = 
	`make_image
(
a
.
w
,‡.
h
, 1);

369 
i
 = 0; i < 
a
.
c
; ++i){

370 
j
 = 0; j < 
a
.
h
*a.
w
; ++j){

371 
di¡
.
d©a
[
j
] +ğ
	`pow
(
a
.d©a[
i
*a.
h
*a.
w
+j]-
b
.data[i*a.h*a.w+j],2);

374 
j
 = 0; j < 
a
.
h
*a.
w
; ++j){

375 
di¡
.
d©a
[
j
] = 
	`sq¹
(dist.data[j]);

377  
di¡
;

378 
	}
}

380 
	$gho¡_image
(
image
 
sourû
, imag
de¡
, 
dx
, 
dy
)

382 
x
,
y
,
k
;

383 
max_di¡
 = 
	`sq¹
((-
sourû
.
w
/2. + .5)*(-source.w/2. + .5));

384 
k
 = 0; k < 
sourû
.
c
; ++k){

385 
y
 = 0; y < 
sourû
.
h
; ++y){

386 
x
 = 0; x < 
sourû
.
w
; ++x){

387 
di¡
 = 
	`sq¹
((
x
 - 
sourû
.
w
/2. + .5)*(x - sourû.w/2. + .5è+ (
y
 - sourû.
h
/2. + .5)*(y - source.h/2. + .5));

388 
®pha
 = (1 - 
di¡
/
max_di¡
);

389 if(
®pha
 < 0)‡lpha = 0;

390 
v1
 = 
	`g‘_pix–
(
sourû
, 
x
,
y
,
k
);

391 
v2
 = 
	`g‘_pix–
(
de¡
, 
dx
+
x
,
dy
+
y
,
k
);

392 
v®
 = 
®pha
*
v1
 + (1-®pha)*
v2
;

393 
	`£t_pix–
(
de¡
, 
dx
+
x
, 
dy
+
y
, 
k
, 
v®
);

397 
	}
}

399 
	$blocky_image
(
image
 
im
, 
s
)

401 
i
,
j
,
k
;

402 
k
 = 0; k < 
im
.
c
; ++k){

403 
j
 = 0; j < 
im
.
h
; ++j){

404 
i
 = 0; i < 
im
.
w
; ++i){

405 
im
.
d©a
[
i
 + im.
w
*(
j
 + im.
h
*
k
)] = im.d©a[i/
s
*s + im.w*(j/s*s + im.h*k)];

409 
	}
}

411 
	$ûnsÜ_image
(
image
 
im
, 
dx
, 
dy
, 
w
, 
h
)

413 
i
,
j
,
k
;

414 
s
 = 32;

415 if(
dx
 < 0) dx = 0;

416 if(
dy
 < 0) dy = 0;

418 
k
 = 0; k < 
im
.
c
; ++k){

419 
j
 = 
dy
; j < dy + 
h
 && j < 
im
.h; ++j){

420 
i
 = 
dx
; i < dx + 
w
 && i < 
im
.w; ++i){

421 
im
.
d©a
[
i
 + im.
w
*(
j
 + im.
h
*
k
)] = im.d©a[i/
s
*s + im.w*(j/s*s + im.h*k)];

426 
	}
}

428 
	$embed_image
(
image
 
sourû
, imag
de¡
, 
dx
, 
dy
)

430 
x
,
y
,
k
;

431 
k
 = 0; k < 
sourû
.
c
; ++k){

432 
y
 = 0; y < 
sourû
.
h
; ++y){

433 
x
 = 0; x < 
sourû
.
w
; ++x){

434 
v®
 = 
	`g‘_pix–
(
sourû
, 
x
,
y
,
k
);

435 
	`£t_pix–
(
de¡
, 
dx
+
x
, 
dy
+
y
, 
k
, 
v®
);

439 
	}
}

441 
image
 
	$cŞÏp£_image_Ïy”s
(
image
 
sourû
, 
bÜd”
)

443 
h
 = 
sourû
.h;

444 
h
 = (h+
bÜd”
)*
sourû
.
c
 - border;

445 
image
 
de¡
 = 
	`make_image
(
sourû
.
w
, 
h
, 1);

446 
i
;

447 
i
 = 0; i < 
sourû
.
c
; ++i){

448 
image
 
Ïy”
 = 
	`g‘_image_Ïy”
(
sourû
, 
i
);

449 
h_off£t
 = 
i
*(
sourû
.
h
+
bÜd”
);

450 
	`embed_image
(
Ïy”
, 
de¡
, 0, 
h_off£t
);

451 
	`ä“_image
(
Ïy”
);

453  
de¡
;

454 
	}
}

456 
	$cÚ¡¿š_image
(
image
 
im
)

458 
i
;

459 
i
 = 0; i < 
im
.
w
*im.
h
*im.
c
; ++i){

460 if(
im
.
d©a
[
i
] < 0) im.data[i] = 0;

461 if(
im
.
d©a
[
i
] > 1) im.data[i] = 1;

463 
	}
}

465 
	$nÜm®ize_image
(
image
 
p
)

467 
i
;

468 
mš
 = 9999999;

469 
max
 = -999999;

471 
i
 = 0; i < 
p
.
h
*p.
w
*p.
c
; ++i){

472 
v
 = 
p
.
d©a
[
i
];

473 if(
v
 < 
mš
) min = v;

474 if(
v
 > 
max
) max = v;

476 if(
max
 - 
mš
 < .000000001){

477 
mš
 = 0;

478 
max
 = 1;

480 
i
 = 0; i < 
p
.
c
*p.
w
*p.
h
; ++i){

481 
p
.
d©a
[
i
] = (p.d©a[i] - 
mš
)/(
max
-min);

483 
	}
}

485 
	$nÜm®ize_image2
(
image
 
p
)

487 *
mš
 = 
	`ÿÎoc
(
p
.
c
, ());

488 *
max
 = 
	`ÿÎoc
(
p
.
c
, ());

489 
i
,
j
;

490 
i
 = 0; i < 
p
.
c
; ++iè
mš
[i] = 
max
[i] =….
d©a
[i*p.
h
*p.
w
];

492 
j
 = 0; j < 
p
.
c
; ++j){

493 
i
 = 0; i < 
p
.
h
*p.
w
; ++i){

494 
v
 = 
p
.
d©a
[
i
+
j
*p.
h
*p.
w
];

495 if(
v
 < 
mš
[
j
]) min[j] = v;

496 if(
v
 > 
max
[
j
]) max[j] = v;

499 
i
 = 0; i < 
p
.
c
; ++i){

500 if(
max
[
i
] - 
mš
[i] < .000000001){

501 
mš
[
i
] = 0;

502 
max
[
i
] = 1;

505 
j
 = 0; j < 
p
.
c
; ++j){

506 
i
 = 0; i < 
p
.
w
*p.
h
; ++i){

507 
p
.
d©a
[
i
+
j
*p.
h
*p.
w
] = (p.d©a[i+j*p.h*p.w] - 
mš
[j])/(
max
[j]-min[j]);

510 
	`ä“
(
mš
);

511 
	`ä“
(
max
);

512 
	}
}

514 
	$cİy_image_što
(
image
 
¤c
, imag
de¡
)

516 
	`memıy
(
de¡
.
d©a
, 
¤c
.d©a, src.
h
*¤c.
w
*¤c.
c
*());

517 
	}
}

519 
image
 
	$cİy_image
(
image
 
p
)

521 
image
 
cİy
 = 
p
;

522 
cİy
.
d©a
 = 
	`ÿÎoc
(
p
.
h
*p.
w
*p.
c
, ());

523 
	`memıy
(
cİy
.
d©a
, 
p
.d©a,….
h
*p.
w
*p.
c
*());

524  
cİy
;

525 
	}
}

527 
	$rgbgr_image
(
image
 
im
)

529 
i
;

530 
i
 = 0; i < 
im
.
w
*im.
h
; ++i){

531 
sw­
 = 
im
.
d©a
[
i
];

532 
im
.
d©a
[
i
] = im.d©a[i+im.
w
*im.
h
*2];

533 
im
.
d©a
[
i
+im.
w
*im.
h
*2] = 
sw­
;

535 
	}
}

537 #ifdeà
OPENCV


538 
	$show_image_cv
(
image
 
p
, cÚ¡ *
Çme
, 
I¶Image
 *
di¥
)

540 
x
,
y
,
k
;

541 if(
p
.
c
 =ğ3è
	`rgbgr_image
(p);

544 
buff
[256];

546 
	`¥rštf
(
buff
, "%s", 
Çme
);

548 
¡•
 = 
di¥
->
widthS‹p
;

549 
	`cvNamedWšdow
(
buff
, 
CV_WINDOW_NORMAL
);

551 ++
wšdows
;

552 
y
 = 0; y < 
p
.
h
; ++y){

553 
x
 = 0; x < 
p
.
w
; ++x){

554 
k
ğ0; k < 
p
.
c
; ++k){

555 
di¥
->
imageD©a
[
y
*
¡•
 + 
x
*
p
.
c
 + 
k
] = ()(
	`g‘_pix–
(p,x,y,k)*255);

560 
w
 = 448;

561 
h
 = 
w
*
p
.h/p.w;

562 if(
h
 > 1000){

563 
h
 = 1000;

564 
w
 = 
h
*
p
.w/p.h;

566 
I¶Image
 *
bufãr
 = 
di¥
;

567 
di¥
 = 
	`cvC»©eImage
(
	`cvSize
(
w
, 
h
), 
bufãr
->
d•th
, bufãr->
nChªÃls
);

568 
	`cvResize
(
bufãr
, 
di¥
, 
CV_INTER_LINEAR
);

569 
	`cvR–—£Image
(&
bufãr
);

571 
	`cvShowImage
(
buff
, 
di¥
);

572 
	}
}

575 
	$show_image
(
image
 
p
, cÚ¡ *
Çme
)

577 #ifdeà
OPENCV


578 
I¶Image
 *
di¥
 = 
	`cvC»©eImage
(
	`cvSize
(
p
.
w
,p.
h
), 
IPL_DEPTH_8U
,….
c
);

579 
image
 
cİy
 = 
	`cİy_image
(
p
);

580 
	`cÚ¡¿š_image
(
cİy
);

581 
	`show_image_cv
(
cİy
, 
Çme
, 
di¥
);

582 
	`ä“_image
(
cİy
);

583 
	`cvR–—£Image
(&
di¥
);

585 
	`årštf
(
¡d”r
, "NÙ comped w™h O³nCV, savšgØ%s.²g in¡—d\n", 
Çme
);

586 
	`§ve_image
(
p
, 
Çme
);

588 
	}
}

590 #ifdeà
OPENCV


592 
	$l_što_image
(
I¶Image
* 
¤c
, 
image
 
im
)

594 *
d©a
 = (*)
¤c
->
imageD©a
;

595 
h
 = 
¤c
->
height
;

596 
w
 = 
¤c
->
width
;

597 
c
 = 
¤c
->
nChªÃls
;

598 
¡•
 = 
¤c
->
widthS‹p
;

600 
i
, 
j
, 
k
;

601 
cc
 = 0;

602 
i
 = 0; i < 
h
; ++i){

603 
k
ğ0; k < 
c
; ++k){

604 
j
 = 0; j < 
w
; ++j){

605 ià(
c
 == 1){

606 
im
.
d©a
[
k
*
w
*
h
 + 
i
*w + 
j
] = d©a[i*
¡•
 + j*
c
 + k]/1.0;

607 
cc
 += 1;

610 if(
k
 == 0)

611 
im
.
d©a
[
k
*
w
*
h
 + 
i
*w + 
j
] = d©a[i*
¡•
 + j*
c
 + k]/1.0 - 103.939;

612 if(
k
 == 1)

613 
im
.
d©a
[
k
*
w
*
h
 + 
i
*w + 
j
] = d©a[i*
¡•
 + j*
c
 + k]/1.0 - 116.779;

614 if(
k
 == 2)

615 
im
.
d©a
[
k
*
w
*
h
 + 
i
*w + 
j
] = d©a[i*
¡•
 + j*
c
 + k]/1.0 - 123.68;

619 
	}
}

621 
image
 
	$l_to_image
(
I¶Image
* 
¤c
)

623 
h
 = 
¤c
->
height
;

624 
w
 = 
¤c
->
width
;

625 
c
 = 
¤c
->
nChªÃls
;

626 
image
 
out
 = 
	`make_image
(
w
, 
h
, 
c
);

627 
	`l_što_image
(
¤c
, 
out
);

628  
out
;

629 
	}
}

631 
image
 
	$lßd_image_cv
(*
f’ame
, 
chªÃls
)

633 
I¶Image
* 
¤c
 = 0;

634 
æag
 = -1;

635 ià(
chªÃls
 =ğ0è
æag
 = -1;

636 ià(
chªÃls
 =ğ1è
æag
 = 0;

637 ià(
chªÃls
 =ğ3è
æag
 = 1;

639 
	`årštf
(
¡d”r
, "O³nCV cª'ˆfÜû†ßd w™h %d chªÃls\n", 
chªÃls
);

642 ifĞ(
¤c
 = 
	`cvLßdImage
(
f’ame
, 
æag
)) == 0 )

644 
	`årštf
(
¡d”r
, "CªnÙ†ßd imag\"%s\"\n", 
f’ame
);

645 
buff
[256];

646 
	`¥rštf
(
buff
, "echØ% >> bad.li¡", 
f’ame
);

647 
	`sy¡em
(
buff
);

648  
	`make_image
(10,10,3);

651 
image
 
out
 = 
	`l_to_image
(
¤c
);

652 
	`cvR–—£Image
(&
¤c
);

653 ià(
chªÃls
 != 1)

654 
	`rgbgr_image
(
out
);

655  
out
;

656 
	}
}

658 
	$æush_¡»am_bufãr
(
CvC­tu»
 *
ÿp
, 
n
)

660 
i
;

661 
i
 = 0; i < 
n
; ++i) {

662 
	`cvQu”yF¿me
(
ÿp
);

664 
	}
}

666 
image
 
	$g‘_image_äom_¡»am
(
CvC­tu»
 *
ÿp
)

668 
I¶Image
* 
¤c
 = 
	`cvQu”yF¿me
(
ÿp
);

669 ià(!
¤c
è 
	`make_em±y_image
(0,0,0);

670 
image
 
im
 = 
	`l_to_image
(
¤c
);

671 
	`rgbgr_image
(
im
);

672  
im
;

673 
	}
}

675 
	$fl_image_äom_¡»am
(
CvC­tu»
 *
ÿp
, 
image
 
im
)

677 
I¶Image
* 
¤c
 = 
	`cvQu”yF¿me
(
ÿp
);

678 ià(!
¤c
)  0;

679 
	`l_što_image
(
¤c
, 
im
);

680 
	`rgbgr_image
(
im
);

682 
	}
}

684 
	$§ve_image_jpg
(
image
 
p
, cÚ¡ *
Çme
)

686 
image
 
cİy
 = 
	`cİy_image
(
p
);

687 if(
p
.
c
 =ğ3è
	`rgbgr_image
(
cİy
);

688 
x
,
y
,
k
;

690 
buff
[256];

691 
	`¥rštf
(
buff
, "%s.jpg", 
Çme
);

693 
I¶Image
 *
di¥
 = 
	`cvC»©eImage
(
	`cvSize
(
p
.
w
,p.
h
), 
IPL_DEPTH_8U
,….
c
);

694 
¡•
 = 
di¥
->
widthS‹p
;

695 
y
 = 0; y < 
p
.
h
; ++y){

696 
x
 = 0; x < 
p
.
w
; ++x){

697 
k
ğ0; k < 
p
.
c
; ++k){

698 
di¥
->
imageD©a
[
y
*
¡•
 + 
x
*
p
.
c
 + 
k
] = ()(
	`g‘_pix–
(
cİy
,x,y,k)*255);

702 
	`cvSaveImage
(
buff
, 
di¥
,0);

703 
	`cvR–—£Image
(&
di¥
);

704 
	`ä“_image
(
cİy
);

705 
	}
}

708 
	$§ve_image_²g
(
image
 
im
, cÚ¡ *
Çme
)

710 
buff
[256];

712 
	`¥rštf
(
buff
, "%s.²g", 
Çme
);

713 *
d©a
 = 
	`ÿÎoc
(
im
.
w
*im.
h
*im.
c
, ());

714 
i
,
k
;

715 
k
 = 0; k < 
im
.
c
; ++k){

716 
i
 = 0; i < 
im
.
w
*im.
h
; ++i){

717 
d©a
[
i
*
im
.
c
+
k
] = (è(255*im.d©a[˜+ k*im.
w
*im.
h
]);

720 
sucûss
 = 
	`¡bi_wr™e_²g
(
buff
, 
im
.
w
, im.
h
, im.
c
, 
d©a
, im.w*im.c);

721 
	`ä“
(
d©a
);

722 if(!
sucûss
è
	`årštf
(
¡d”r
, "FaedØwr™imag%s\n", 
buff
);

723 
	}
}

725 
	$§ve_image
(
image
 
im
, cÚ¡ *
Çme
)

727 #ifdeà
OPENCV


728 
	`§ve_image_jpg
(
im
, 
Çme
);

730 
	`§ve_image_²g
(
im
, 
Çme
);

732 
	}
}

735 
	$show_image_Ïy”s
(
image
 
p
, *
Çme
)

737 
i
;

738 
buff
[256];

739 
i
 = 0; i < 
p
.
c
; ++i){

740 
	`¥rštf
(
buff
, "% - Lay” %d", 
Çme
, 
i
);

741 
image
 
Ïy”
 = 
	`g‘_image_Ïy”
(
p
, 
i
);

742 
	`show_image
(
Ïy”
, 
buff
);

743 
	`ä“_image
(
Ïy”
);

745 
	}
}

747 
	$show_image_cŞÏp£d
(
image
 
p
, *
Çme
)

749 
image
 
c
 = 
	`cŞÏp£_image_Ïy”s
(
p
, 1);

750 
	`show_image
(
c
, 
Çme
);

751 
	`ä“_image
(
c
);

752 
	}
}

754 
image
 
	$make_em±y_image
(
w
, 
h
, 
c
)

756 
image
 
out
;

757 
out
.
d©a
 = 0;

758 
out
.
h
 = h;

759 
out
.
w
 = w;

760 
out
.
c
 = c;

761  
out
;

762 
	}
}

764 
image
 
	$make_image
(
w
, 
h
, 
c
)

766 
image
 
out
 = 
	`make_em±y_image
(
w
,
h
,
c
);

767 
out
.
d©a
 = 
	`ÿÎoc
(
h
*
w
*
c
, ());

768  
out
;

769 
	}
}

771 
image
 
	$make_¿ndom_image
(
w
, 
h
, 
c
)

773 
image
 
out
 = 
	`make_em±y_image
(
w
,
h
,
c
);

774 
out
.
d©a
 = 
	`ÿÎoc
(
h
*
w
*
c
, ());

775 
i
;

776 
i
 = 0; i < 
w
*
h
*
c
; ++i){

777 
out
.
d©a
[
i
] = (
	`¿nd_nÜm®
() * .25) + .5;

779  
out
;

780 
	}
}

782 
image
 
	$æßt_to_image
(
w
, 
h
, 
c
, *
d©a
)

784 
image
 
out
 = 
	`make_em±y_image
(
w
,
h
,
c
);

785 
out
.
d©a
 = data;

786  
out
;

787 
	}
}

789 
	$¶aû_image
(
image
 
im
, 
w
, 
h
, 
dx
, 
dy
, imag
ÿnvas
)

791 
x
, 
y
, 
c
;

792 
c
 = 0; c < 
im
.c; ++c){

793 
y
 = 0; y < 
h
; ++y){

794 
x
 = 0; x < 
w
; ++x){

795 
rx
 = (()
x
 / 
w
è* 
im
.w;

796 
ry
 = (()
y
 / 
h
è* 
im
.h;

797 
v®
 = 
	`bš—r_š‹½Ş©e
(
im
, 
rx
, 
ry
, 
c
);

798 
	`£t_pix–
(
ÿnvas
, 
x
 + 
dx
, 
y
 + 
dy
, 
c
, 
v®
);

802 
	}
}

804 
image
 
	$ûÁ”_üİ_image
(
image
 
im
, 
w
, 
h
)

806 
m
 = (
im
.
w
 < im.
h
) ? im.w : im.h;

807 
image
 
c
 = 
	`üİ_image
(
im
, (im.
w
 - 
m
è/ 2, (im.
h
 - m)/2, m, m);

808 
image
 
r
 = 
	`»size_image
(
c
, 
w
, 
h
);

809 
	`ä“_image
(
c
);

810  
r
;

811 
	}
}

813 
image
 
	$rÙ©e_üİ_image
(
image
 
im
, 
¿d
, 
s
, 
w
, 
h
, 
dx
, 
dy
, 
a¥eù
)

815 
x
, 
y
, 
c
;

816 
cx
 = 
im
.
w
/2.;

817 
cy
 = 
im
.
h
/2.;

818 
image
 
rÙ
 = 
	`make_image
(
w
, 
h
, 
im
.
c
);

819 
c
 = 0; c < 
im
.c; ++c){

820 
y
 = 0; y < 
h
; ++y){

821 
x
 = 0; x < 
w
; ++x){

822 
rx
 = 
	`cos
(
¿d
)*((
x
 - 
w
/2.)/
s
*
a¥eù
 + 
dx
/s*a¥eùè- 
	`sš
Ôad)*((
y
 - 
h
/2.)/ + 
dy
/sè+ 
cx
;

823 
ry
 = 
	`sš
(
¿d
)*((
x
 - 
w
/2.)/
s
*
a¥eù
 + 
dx
/s*a¥eùè+ 
	`cos
Ôad)*((
y
 - 
h
/2.)/ + 
dy
/sè+ 
cy
;

824 
v®
 = 
	`bš—r_š‹½Ş©e
(
im
, 
rx
, 
ry
, 
c
);

825 
	`£t_pix–
(
rÙ
, 
x
, 
y
, 
c
, 
v®
);

829  
rÙ
;

830 
	}
}

832 
image
 
	$rÙ©e_image
(
image
 
im
, 
¿d
)

834 
x
, 
y
, 
c
;

835 
cx
 = 
im
.
w
/2.;

836 
cy
 = 
im
.
h
/2.;

837 
image
 
rÙ
 = 
	`make_image
(
im
.
w
, im.
h
, im.
c
);

838 
c
 = 0; c < 
im
.c; ++c){

839 
y
 = 0; y < 
im
.
h
; ++y){

840 
x
 = 0; x < 
im
.
w
; ++x){

841 
rx
 = 
	`cos
(
¿d
)*(
x
-
cx
è- 
	`sš
Ôad)*(
y
-
cy
) + cx;

842 
ry
 = 
	`sš
(
¿d
)*(
x
-
cx
è+ 
	`cos
Ôad)*(
y
-
cy
) + cy;

843 
v®
 = 
	`bš—r_š‹½Ş©e
(
im
, 
rx
, 
ry
, 
c
);

844 
	`£t_pix–
(
rÙ
, 
x
, 
y
, 
c
, 
v®
);

848  
rÙ
;

849 
	}
}

851 
	$fl_image
(
image
 
m
, 
s
)

853 
i
;

854 
i
 = 0; i < 
m
.
h
*m.
w
*m.
c
; ++ièm.
d©a
[i] = 
s
;

855 
	}
}

857 
	$Œª¦©e_image
(
image
 
m
, 
s
)

859 
i
;

860 
i
 = 0; i < 
m
.
h
*m.
w
*m.
c
; ++ièm.
d©a
[i] +ğ
s
;

861 
	}
}

863 
	$sÿË_image
(
image
 
m
, 
s
)

865 
i
;

866 
i
 = 0; i < 
m
.
h
*m.
w
*m.
c
; ++ièm.
d©a
[i] *ğ
s
;

867 
	}
}

869 
image
 
	$üİ_image
(
image
 
im
, 
dx
, 
dy
, 
w
, 
h
)

871 
image
 
üİ³d
 = 
	`make_image
(
w
, 
h
, 
im
.
c
);

872 
i
, 
j
, 
k
;

873 
k
 = 0; k < 
im
.
c
; ++k){

874 
j
 = 0; j < 
h
; ++j){

875 
i
 = 0; i < 
w
; ++i){

876 
r
 = 
j
 + 
dy
;

877 
c
 = 
i
 + 
dx
;

878 
v®
 = 0;

879 
r
 = 
	`cÚ¡¿š_št
Ô, 0, 
im
.
h
-1);

880 
c
 = 
	`cÚ¡¿š_št
(c, 0, 
im
.
w
-1);

881 
v®
 = 
	`g‘_pix–
(
im
, 
c
, 
r
, 
k
);

882 
	`£t_pix–
(
üİ³d
, 
i
, 
j
, 
k
, 
v®
);

886  
üİ³d
;

887 
	}
}

889 
	$be¡_3d_shiá_r
(
image
 
a
, imag
b
, 
mš
, 
max
)

891 if(
mš
 =ğ
max
)  min;

892 
mid
 = 
	`æoÜ
((
mš
 + 
max
) / 2.);

893 
image
 
c1
 = 
	`üİ_image
(
b
, 0, 
mid
, b.
w
, b.
h
);

894 
image
 
c2
 = 
	`üİ_image
(
b
, 0, 
mid
+1, b.
w
, b.
h
);

895 
d1
 = 
	`di¡_¬¿y
(
c1
.
d©a
, 
a
.d©a,‡.
w
*a.
h
*a.
c
, 10);

896 
d2
 = 
	`di¡_¬¿y
(
c2
.
d©a
, 
a
.d©a,‡.
w
*a.
h
*a.
c
, 10);

897 
	`ä“_image
(
c1
);

898 
	`ä“_image
(
c2
);

899 if(
d1
 < 
d2
è 
	`be¡_3d_shiá_r
(
a
, 
b
, 
mš
, 
mid
);

900  
	`be¡_3d_shiá_r
(
a
, 
b
, 
mid
+1, 
max
);

901 
	}
}

903 
	$be¡_3d_shiá
(
image
 
a
, imag
b
, 
mš
, 
max
)

905 
i
;

906 
be¡
 = 0;

907 
be¡_di¡ªû
 = 
FLT_MAX
;

908 
i
 = 
mš
; i <ğ
max
; i += 2){

909 
image
 
c
 = 
	`üİ_image
(
b
, 0, 
i
, b.
w
, b.
h
);

910 
d
 = 
	`di¡_¬¿y
(
c
.
d©a
, 
a
.d©a,‡.
w
*a.
h
*a.c, 100);

911 if(
d
 < 
be¡_di¡ªû
){

912 
be¡_di¡ªû
 = 
d
;

913 
be¡
 = 
i
;

915 
	`´štf
("%d %f\n", 
i
, 
d
);

916 
	`ä“_image
(
c
);

918  
be¡
;

919 
	}
}

921 
	$compos™e_3d
(*
f1
, *
f2
, *
out
, 
d–
)

923 if(!
out
) out = "out";

924 
image
 
a
 = 
	`lßd_image
(
f1
, 0,0,0);

925 
image
 
b
 = 
	`lßd_image
(
f2
, 0,0,0);

926 
shiá
 = 
	`be¡_3d_shiá_r
(
a
, 
b
, -a.
h
/100,‡.h/100);

928 
image
 
c1
 = 
	`üİ_image
(
b
, 10, 
shiá
, b.
w
, b.
h
);

929 
d1
 = 
	`di¡_¬¿y
(
c1
.
d©a
, 
a
.d©a,‡.
w
*a.
h
*a.
c
, 100);

930 
image
 
c2
 = 
	`üİ_image
(
b
, -10, 
shiá
, b.
w
, b.
h
);

931 
d2
 = 
	`di¡_¬¿y
(
c2
.
d©a
, 
a
.d©a,‡.
w
*a.
h
*a.
c
, 100);

933 if(
d2
 < 
d1
 && 0){

934 
image
 
sw­
 = 
a
;

935 
a
 = 
b
;

936 
b
 = 
sw­
;

937 
shiá
 = -shift;

938 
	`´štf
("sw­³d, %d\n", 
shiá
);

941 
	`´štf
("%d\n", 
shiá
);

944 
image
 
c
 = 
	`üİ_image
(
b
, 
d–
, 
shiá
, 
a
.
w
,‡.
h
);

945 
i
;

946 
i
 = 0; i < 
c
.
w
*c.
h
; ++i){

947 
c
.
d©a
[
i
] = 
a
.data[i];

949 #ifdeà
OPENCV


950 
	`§ve_image_jpg
(
c
, 
out
);

952 
	`§ve_image
(
c
, 
out
);

954 
	}
}

956 
	$Ë‰”box_image_što
(
image
 
im
, 
w
, 
h
, imag
boxed
)

958 
Ãw_w
 = 
im
.
w
;

959 
Ãw_h
 = 
im
.
h
;

960 ià((()
w
/
im
.wè< (()
h
/im.h)) {

961 
Ãw_w
 = 
w
;

962 
Ãw_h
 = (
im
.
h
 * 
w
)/im.w;

964 
Ãw_h
 = 
h
;

965 
Ãw_w
 = (
im
.
w
 * 
h
)/im.h;

967 
image
 
»sized
 = 
	`»size_image
(
im
, 
Ãw_w
, 
Ãw_h
);

968 
	`embed_image
(
»sized
, 
boxed
, (
w
-
Ãw_w
)/2, (
h
-
Ãw_h
)/2);

969 
	`ä“_image
(
»sized
);

970 
	}
}

972 
image
 
	$Ë‰”box_image
(
image
 
im
, 
w
, 
h
)

974 
Ãw_w
 = 
im
.
w
;

975 
Ãw_h
 = 
im
.
h
;

976 ià((()
w
/
im
.wè< (()
h
/im.h)) {

977 
Ãw_w
 = 
w
;

978 
Ãw_h
 = (
im
.
h
 * 
w
)/im.w;

980 
Ãw_h
 = 
h
;

981 
Ãw_w
 = (
im
.
w
 * 
h
)/im.h;

983 
image
 
»sized
 = 
	`»size_image
(
im
, 
Ãw_w
, 
Ãw_h
);

984 
image
 
boxed
 = 
	`make_image
(
w
, 
h
, 
im
.
c
);

985 
	`fl_image
(
boxed
, .5);

988 
	`embed_image
(
»sized
, 
boxed
, (
w
-
Ãw_w
)/2, (
h
-
Ãw_h
)/2);

989 
	`ä“_image
(
»sized
);

990  
boxed
;

991 
	}
}

993 
image
 
	$»size_max
(
image
 
im
, 
max
)

995 
w
 = 
im
.w;

996 
h
 = 
im
.h;

997 if(
w
 > 
h
){

998 
h
 = (h * 
max
è/ 
w
;

999 
w
 = 
max
;

1001 
w
 = (w * 
max
è/ 
h
;

1002 
h
 = 
max
;

1004 if(
w
 =ğ
im
.w && 
h
 == im.h)  im;

1005 
image
 
»sized
 = 
	`»size_image
(
im
, 
w
, 
h
);

1006  
»sized
;

1007 
	}
}

1009 
image
 
	$»size_mš
(
image
 
im
, 
mš
)

1011 
w
 = 
im
.w;

1012 
h
 = 
im
.h;

1013 if(
w
 < 
h
){

1014 
h
 = (h * 
mš
è/ 
w
;

1015 
w
 = 
mš
;

1017 
w
 = (w * 
mš
è/ 
h
;

1018 
h
 = 
mš
;

1020 if(
w
 =ğ
im
.w && 
h
 == im.h)  im;

1021 
image
 
»sized
 = 
	`»size_image
(
im
, 
w
, 
h
);

1022  
»sized
;

1023 
	}
}

1025 
image
 
	$¿ndom_üİ_image
(
image
 
im
, 
w
, 
h
)

1027 
dx
 = 
	`¿nd_št
(0, 
im
.
w
 - w);

1028 
dy
 = 
	`¿nd_št
(0, 
im
.
h
 - h);

1029 
image
 
üİ
 = 
	`üİ_image
(
im
, 
dx
, 
dy
, 
w
, 
h
);

1030  
üİ
;

1031 
	}
}

1033 
augm’t_¬gs
 
	$¿ndom_augm’t_¬gs
(
image
 
im
, 
ªgË
, 
a¥eù
, 
low
, 
high
, 
w
, 
h
)

1035 
augm’t_¬gs
 
a
 = {0};

1036 
a¥eù
 = 
	`¿nd_sÿË
(aspect);

1037 
r
 = 
	`¿nd_št
(
low
, 
high
);

1038 
mš
 = (
im
.
h
 < im.
w
*
a¥eù
) ? im.h : im.w*aspect;

1039 
sÿË
 = ()
r
 / 
mš
;

1041 
¿d
 = 
	`¿nd_unifÜm
(-
ªgË
,‡ngËè* 
TWO_PI
 / 360.;

1043 
dx
 = (
im
.
w
*
sÿË
/
a¥eù
 - w) / 2.;

1044 
dy
 = (
im
.
h
*
sÿË
 - 
w
) / 2.;

1047 
dx
 = 
	`¿nd_unifÜm
(-dx, dx);

1048 
dy
 = 
	`¿nd_unifÜm
(-dy, dy);

1050 
a
.
¿d
 =„ad;

1051 
a
.
sÿË
 = scale;

1052 
a
.
w
 = w;

1053 
a
.
h
 = h;

1054 
a
.
dx
 = dx;

1055 
a
.
dy
 = dy;

1056 
a
.
a¥eù
 =‡spect;

1057  
a
;

1058 
	}
}

1060 
image
 
	$¿ndom_augm’t_image
(
image
 
im
, 
ªgË
, 
a¥eù
, 
low
, 
high
, 
w
, 
h
)

1062 
augm’t_¬gs
 
a
 = 
	`¿ndom_augm’t_¬gs
(
im
, 
ªgË
, 
a¥eù
, 
low
, 
high
, 
w
, 
h
);

1063 
image
 
üİ
 = 
	`rÙ©e_üİ_image
(
im
, 
a
.
¿d
,‡.
sÿË
,‡.
w
,‡.
h
,‡.
dx
,‡.
dy
,‡.
a¥eù
);

1064  
üİ
;

1065 
	}
}

1067 
	$th»e_way_max
(
a
, 
b
, 
c
)

1069  (
a
 > 
b
è? ( (¨> 
c
) ?‡ : c) : ( (b > c) ? b : c) ;

1070 
	}
}

1072 
	$th»e_way_mš
(
a
, 
b
, 
c
)

1074  (
a
 < 
b
è? ( (¨< 
c
) ?‡ : c) : ( (b < c) ? b : c) ;

1075 
	}
}

1077 
	$yuv_to_rgb
(
image
 
im
)

1079 
	`as£¹
(
im
.
c
 == 3);

1080 
i
, 
j
;

1081 
r
, 
g
, 
b
;

1082 
y
, 
u
, 
v
;

1083 
j
 = 0; j < 
im
.
h
; ++j){

1084 
i
 = 0; i < 
im
.
w
; ++i){

1085 
y
 = 
	`g‘_pix–
(
im
, 
i
 , 
j
, 0);

1086 
u
 = 
	`g‘_pix–
(
im
, 
i
 , 
j
, 1);

1087 
v
 = 
	`g‘_pix–
(
im
, 
i
 , 
j
, 2);

1089 
r
 = 
y
 + 1.13983*
v
;

1090 
g
 = 
y
 + -.39465*
u
 + -.58060*
v
;

1091 
b
 = 
y
 + 2.03211*
u
;

1093 
	`£t_pix–
(
im
, 
i
, 
j
, 0, 
r
);

1094 
	`£t_pix–
(
im
, 
i
, 
j
, 1, 
g
);

1095 
	`£t_pix–
(
im
, 
i
, 
j
, 2, 
b
);

1098 
	}
}

1100 
	$rgb_to_yuv
(
image
 
im
)

1102 
	`as£¹
(
im
.
c
 == 3);

1103 
i
, 
j
;

1104 
r
, 
g
, 
b
;

1105 
y
, 
u
, 
v
;

1106 
j
 = 0; j < 
im
.
h
; ++j){

1107 
i
 = 0; i < 
im
.
w
; ++i){

1108 
r
 = 
	`g‘_pix–
(
im
, 
i
 , 
j
, 0);

1109 
g
 = 
	`g‘_pix–
(
im
, 
i
 , 
j
, 1);

1110 
b
 = 
	`g‘_pix–
(
im
, 
i
 , 
j
, 2);

1112 
y
 = .299*
r
 + .587*
g
 + .114*
b
;

1113 
u
 = -.14713*
r
 + -.28886*
g
 + .436*
b
;

1114 
v
 = .615*
r
 + -.51499*
g
 + -.10001*
b
;

1116 
	`£t_pix–
(
im
, 
i
, 
j
, 0, 
y
);

1117 
	`£t_pix–
(
im
, 
i
, 
j
, 1, 
u
);

1118 
	`£t_pix–
(
im
, 
i
, 
j
, 2, 
v
);

1121 
	}
}

1124 
	$rgb_to_hsv
(
image
 
im
)

1126 
	`as£¹
(
im
.
c
 == 3);

1127 
i
, 
j
;

1128 
r
, 
g
, 
b
;

1129 
h
, 
s
, 
v
;

1130 
j
 = 0; j < 
im
.
h
; ++j){

1131 
i
 = 0; i < 
im
.
w
; ++i){

1132 
r
 = 
	`g‘_pix–
(
im
, 
i
 , 
j
, 0);

1133 
g
 = 
	`g‘_pix–
(
im
, 
i
 , 
j
, 1);

1134 
b
 = 
	`g‘_pix–
(
im
, 
i
 , 
j
, 2);

1135 
max
 = 
	`th»e_way_max
(
r
,
g
,
b
);

1136 
mš
 = 
	`th»e_way_mš
(
r
,
g
,
b
);

1137 
d–
 = 
max
 - 
mš
;

1138 
v
 = 
max
;

1139 if(
max
 == 0){

1140 
s
 = 0;

1141 
h
 = 0;

1143 
s
 = 
d–
/
max
;

1144 if(
r
 =ğ
max
){

1145 
h
 = (
g
 - 
b
è/ 
d–
;

1146 } ià(
g
 =ğ
max
) {

1147 
h
 = 2 + (
b
 - 
r
è/ 
d–
;

1149 
h
 = 4 + (
r
 - 
g
è/ 
d–
;

1151 ià(
h
 < 0) h += 6;

1152 
h
 = h/6.;

1154 
	`£t_pix–
(
im
, 
i
, 
j
, 0, 
h
);

1155 
	`£t_pix–
(
im
, 
i
, 
j
, 1, 
s
);

1156 
	`£t_pix–
(
im
, 
i
, 
j
, 2, 
v
);

1159 
	}
}

1161 
	$hsv_to_rgb
(
image
 
im
)

1163 
	`as£¹
(
im
.
c
 == 3);

1164 
i
, 
j
;

1165 
r
, 
g
, 
b
;

1166 
h
, 
s
, 
v
;

1167 
f
, 
p
, 
q
, 
t
;

1168 
j
 = 0; j < 
im
.
h
; ++j){

1169 
i
 = 0; i < 
im
.
w
; ++i){

1170 
h
 = 6 * 
	`g‘_pix–
(
im
, 
i
 , 
j
, 0);

1171 
s
 = 
	`g‘_pix–
(
im
, 
i
 , 
j
, 1);

1172 
v
 = 
	`g‘_pix–
(
im
, 
i
 , 
j
, 2);

1173 ià(
s
 == 0) {

1174 
r
 = 
g
 = 
b
 = 
v
;

1176 
šdex
 = 
	`æoÜ
(
h
);

1177 
f
 = 
h
 - 
šdex
;

1178 
p
 = 
v
*(1-
s
);

1179 
q
 = 
v
*(1-
s
*
f
);

1180 
t
 = 
v
*(1-
s
*(1-
f
));

1181 if(
šdex
 == 0){

1182 
r
 = 
v
; 
g
 = 
t
; 
b
 = 
p
;

1183 } if(
šdex
 == 1){

1184 
r
 = 
q
; 
g
 = 
v
; 
b
 = 
p
;

1185 } if(
šdex
 == 2){

1186 
r
 = 
p
; 
g
 = 
v
; 
b
 = 
t
;

1187 } if(
šdex
 == 3){

1188 
r
 = 
p
; 
g
 = 
q
; 
b
 = 
v
;

1189 } if(
šdex
 == 4){

1190 
r
 = 
t
; 
g
 = 
p
; 
b
 = 
v
;

1192 
r
 = 
v
; 
g
 = 
p
; 
b
 = 
q
;

1195 
	`£t_pix–
(
im
, 
i
, 
j
, 0, 
r
);

1196 
	`£t_pix–
(
im
, 
i
, 
j
, 1, 
g
);

1197 
	`£t_pix–
(
im
, 
i
, 
j
, 2, 
b
);

1200 
	}
}

1202 
	$g¿ysÿË_image_3c
(
image
 
im
)

1204 
	`as£¹
(
im
.
c
 == 3);

1205 
i
, 
j
, 
k
;

1206 
sÿË
[] = {0.299, 0.587, 0.114};

1207 
j
 = 0; j < 
im
.
h
; ++j){

1208 
i
 = 0; i < 
im
.
w
; ++i){

1209 
v®
 = 0;

1210 
k
 = 0; k < 3; ++k){

1211 
v®
 +ğ
sÿË
[
k
]*
	`g‘_pix–
(
im
, 
i
, 
j
, k);

1213 
im
.
d©a
[0*im.
h
*im.
w
 + im.w*
j
 + 
i
] = 
v®
;

1214 
im
.
d©a
[1*im.
h
*im.
w
 + im.w*
j
 + 
i
] = 
v®
;

1215 
im
.
d©a
[2*im.
h
*im.
w
 + im.w*
j
 + 
i
] = 
v®
;

1218 
	}
}

1220 
image
 
	$g¿ysÿË_image
(
image
 
im
)

1222 
	`as£¹
(
im
.
c
 == 3);

1223 
i
, 
j
, 
k
;

1224 
image
 
g¿y
 = 
	`make_image
(
im
.
w
, im.
h
, 1);

1225 
sÿË
[] = {0.299, 0.587, 0.114};

1226 
k
 = 0; k < 
im
.
c
; ++k){

1227 
j
 = 0; j < 
im
.
h
; ++j){

1228 
i
 = 0; i < 
im
.
w
; ++i){

1229 
g¿y
.
d©a
[
i
+
im
.
w
*
j
] +ğ
sÿË
[
k
]*
	`g‘_pix–
(im, i, j, k);

1233  
g¿y
;

1234 
	}
}

1236 
image
 
	$th»shŞd_image
(
image
 
im
, 
th»sh
)

1238 
i
;

1239 
image
 
t
 = 
	`make_image
(
im
.
w
, im.
h
, im.
c
);

1240 
i
 = 0; i < 
im
.
w
*im.
h
*im.
c
; ++i){

1241 
t
.
d©a
[
i
] = 
im
.d©a[i]>
th»sh
 ? 1 : 0;

1243  
t
;

1244 
	}
}

1246 
image
 
	$bËnd_image
(
image
 
fÜe
, imag
back
, 
®pha
)

1248 
	`as£¹
(
fÜe
.
w
 =ğ
back
.w && fÜe.
h
 =ğback.h && fÜe.
c
 == back.c);

1249 
image
 
bËnd
 = 
	`make_image
(
fÜe
.
w
, fÜe.
h
, fÜe.
c
);

1250 
i
, 
j
, 
k
;

1251 
k
 = 0; k < 
fÜe
.
c
; ++k){

1252 
j
 = 0; j < 
fÜe
.
h
; ++j){

1253 
i
 = 0; i < 
fÜe
.
w
; ++i){

1254 
v®
 = 
®pha
 * 
	`g‘_pix–
(
fÜe
, 
i
, 
j
, 
k
) +

1255 (1 - 
®pha
)* 
	`g‘_pix–
(
back
, 
i
, 
j
, 
k
);

1256 
	`£t_pix–
(
bËnd
, 
i
, 
j
, 
k
, 
v®
);

1260  
bËnd
;

1261 
	}
}

1263 
	$sÿË_image_chªÃl
(
image
 
im
, 
c
, 
v
)

1265 
i
, 
j
;

1266 
j
 = 0; j < 
im
.
h
; ++j){

1267 
i
 = 0; i < 
im
.
w
; ++i){

1268 
pix
 = 
	`g‘_pix–
(
im
, 
i
, 
j
, 
c
);

1269 
pix
 =…ix*
v
;

1270 
	`£t_pix–
(
im
, 
i
, 
j
, 
c
, 
pix
);

1273 
	}
}

1275 
	$Œª¦©e_image_chªÃl
(
image
 
im
, 
c
, 
v
)

1277 
i
, 
j
;

1278 
j
 = 0; j < 
im
.
h
; ++j){

1279 
i
 = 0; i < 
im
.
w
; ++i){

1280 
pix
 = 
	`g‘_pix–
(
im
, 
i
, 
j
, 
c
);

1281 
pix
 =…ix+
v
;

1282 
	`£t_pix–
(
im
, 
i
, 
j
, 
c
, 
pix
);

1285 
	}
}

1287 
image
 
	$bš¬ize_image
(
image
 
im
)

1289 
image
 
c
 = 
	`cİy_image
(
im
);

1290 
i
;

1291 
i
 = 0; i < 
im
.
w
 * im.
h
 * im.
c
; ++i){

1292 if(
c
.
d©a
[
i
] > .5) c.data[i] = 1;

1293 
c
.
d©a
[
i
] = 0;

1295  
c
;

1296 
	}
}

1298 
	$§tu¿‹_image
(
image
 
im
, 
§t
)

1300 
	`rgb_to_hsv
(
im
);

1301 
	`sÿË_image_chªÃl
(
im
, 1, 
§t
);

1302 
	`hsv_to_rgb
(
im
);

1303 
	`cÚ¡¿š_image
(
im
);

1304 
	}
}

1306 
	$hue_image
(
image
 
im
, 
hue
)

1308 
	`rgb_to_hsv
(
im
);

1309 
i
;

1310 
i
 = 0; i < 
im
.
w
*im.
h
; ++i){

1311 
im
.
d©a
[
i
] = im.d©a[i] + 
hue
;

1312 ià(
im
.
d©a
[
i
] > 1) im.data[i] -= 1;

1313 ià(
im
.
d©a
[
i
] < 0) im.data[i] += 1;

1315 
	`hsv_to_rgb
(
im
);

1316 
	`cÚ¡¿š_image
(
im
);

1317 
	}
}

1319 
	$exposu»_image
(
image
 
im
, 
§t
)

1321 
	`rgb_to_hsv
(
im
);

1322 
	`sÿË_image_chªÃl
(
im
, 2, 
§t
);

1323 
	`hsv_to_rgb
(
im
);

1324 
	`cÚ¡¿š_image
(
im
);

1325 
	}
}

1327 
	$di¡Üt_image
(
image
 
im
, 
hue
, 
§t
, 
v®
)

1329 
	`rgb_to_hsv
(
im
);

1330 
	`sÿË_image_chªÃl
(
im
, 1, 
§t
);

1331 
	`sÿË_image_chªÃl
(
im
, 2, 
v®
);

1332 
i
;

1333 
i
 = 0; i < 
im
.
w
*im.
h
; ++i){

1334 
im
.
d©a
[
i
] = im.d©a[i] + 
hue
;

1335 ià(
im
.
d©a
[
i
] > 1) im.data[i] -= 1;

1336 ià(
im
.
d©a
[
i
] < 0) im.data[i] += 1;

1338 
	`hsv_to_rgb
(
im
);

1339 
	`cÚ¡¿š_image
(
im
);

1340 
	}
}

1342 
	$¿ndom_di¡Üt_image
(
image
 
im
, 
hue
, 
§tu¿tiÚ
, 
exposu»
)

1344 
dhue
 = 
	`¿nd_unifÜm
(-
hue
, hue);

1345 
d§t
 = 
	`¿nd_sÿË
(
§tu¿tiÚ
);

1346 
dexp
 = 
	`¿nd_sÿË
(
exposu»
);

1347 
	`di¡Üt_image
(
im
, 
dhue
, 
d§t
, 
dexp
);

1348 
	}
}

1350 
	$§tu¿‹_exposu»_image
(
image
 
im
, 
§t
, 
exposu»
)

1352 
	`rgb_to_hsv
(
im
);

1353 
	`sÿË_image_chªÃl
(
im
, 1, 
§t
);

1354 
	`sÿË_image_chªÃl
(
im
, 2, 
exposu»
);

1355 
	`hsv_to_rgb
(
im
);

1356 
	`cÚ¡¿š_image
(
im
);

1357 
	}
}

1359 
image
 
	$»size_image
(
image
 
im
, 
w
, 
h
)

1361 
image
 
»sized
 = 
	`make_image
(
w
, 
h
, 
im
.
c
);

1362 
image
 
·¹
 = 
	`make_image
(
w
, 
im
.
h
, im.
c
);

1363 
r
, 
c
, 
k
;

1364 
w_sÿË
 = ()(
im
.
w
 - 1) / (w - 1);

1365 
h_sÿË
 = ()(
im
.
h
 - 1) / (h - 1);

1366 
k
 = 0; k < 
im
.
c
; ++k){

1367 
r
 = 0;„ < 
im
.
h
; ++r){

1368 
c
 = 0; c < 
w
; ++c){

1369 
v®
 = 0;

1370 if(
c
 =ğ
w
-1 || 
im
.w == 1){

1371 
v®
 = 
	`g‘_pix–
(
im
, im.
w
-1, 
r
, 
k
);

1373 
sx
 = 
c
*
w_sÿË
;

1374 
ix
 = (è
sx
;

1375 
dx
 = 
sx
 - 
ix
;

1376 
v®
 = (1 - 
dx
è* 
	`g‘_pix–
(
im
, 
ix
, 
r
, 
k
) + dx * get_pixel(im, ix+1,„, k);

1378 
	`£t_pix–
(
·¹
, 
c
, 
r
, 
k
, 
v®
);

1382 
k
 = 0; k < 
im
.
c
; ++k){

1383 
r
 = 0;„ < 
h
; ++r){

1384 
sy
 = 
r
*
h_sÿË
;

1385 
iy
 = (è
sy
;

1386 
dy
 = 
sy
 - 
iy
;

1387 
c
 = 0; c < 
w
; ++c){

1388 
v®
 = (1-
dy
è* 
	`g‘_pix–
(
·¹
, 
c
, 
iy
, 
k
);

1389 
	`£t_pix–
(
»sized
, 
c
, 
r
, 
k
, 
v®
);

1391 if(
r
 =ğ
h
-1 || 
im
.h == 1) ;

1392 
c
 = 0; c < 
w
; ++c){

1393 
v®
 = 
dy
 * 
	`g‘_pix–
(
·¹
, 
c
, 
iy
+1, 
k
);

1394 
	`add_pix–
(
»sized
, 
c
, 
r
, 
k
, 
v®
);

1399 
	`ä“_image
(
·¹
);

1400  
»sized
;

1401 
	}
}

1404 
	$‹¡_»size
(*
f’ame
)

1406 
image
 
im
 = 
	`lßd_image
(
f’ame
, 0,0, 3);

1407 
mag
 = 
	`mag_¬¿y
(
im
.
d©a
, im.
w
*im.
h
*im.
c
);

1408 
	`´štf
("L2 NÜm: %f\n", 
mag
);

1409 
image
 
g¿y
 = 
	`g¿ysÿË_image
(
im
);

1411 
image
 
c1
 = 
	`cİy_image
(
im
);

1412 
image
 
c2
 = 
	`cİy_image
(
im
);

1413 
image
 
c3
 = 
	`cİy_image
(
im
);

1414 
image
 
c4
 = 
	`cİy_image
(
im
);

1415 
	`di¡Üt_image
(
c1
, .1, 1.5, 1.5);

1416 
	`di¡Üt_image
(
c2
, -.1, .66666, .66666);

1417 
	`di¡Üt_image
(
c3
, .1, 1.5, .66666);

1418 
	`di¡Üt_image
(
c4
, .1, .66666, 1.5);

1421 
	`show_image
(
im
, "Original");

1422 
	`show_image
(
g¿y
, "Gray");

1423 
	`show_image
(
c1
, "C1");

1424 
	`show_image
(
c2
, "C2");

1425 
	`show_image
(
c3
, "C3");

1426 
	`show_image
(
c4
, "C4");

1427 #ifdeà
OPENCV


1429 
image
 
aug
 = 
	`¿ndom_augm’t_image
(
im
, 0, .75, 320, 448, 320, 320);

1430 
	`show_image
(
aug
, "aug");

1431 
	`ä“_image
(
aug
);

1434 
exposu»
 = 1.15;

1435 
§tu¿tiÚ
 = 1.15;

1436 
hue
 = .05;

1438 
image
 
c
 = 
	`cİy_image
(
im
);

1440 
dexp
 = 
	`¿nd_sÿË
(
exposu»
);

1441 
d§t
 = 
	`¿nd_sÿË
(
§tu¿tiÚ
);

1442 
dhue
 = 
	`¿nd_unifÜm
(-
hue
, hue);

1444 
	`di¡Üt_image
(
c
, 
dhue
, 
d§t
, 
dexp
);

1445 
	`show_image
(
c
, "rand");

1446 
	`´štf
("%à%à%f\n", 
dhue
, 
d§t
, 
dexp
);

1447 
	`ä“_image
(
c
);

1448 
	`cvWa™Key
(0);

1451 
	}
}

1454 
image
 
	$lßd_image_¡b
(*
f’ame
, 
chªÃls
)

1456 
w
, 
h
, 
c
;

1458 *
d©a
 = 
	`¡bi_lßd
(
f’ame
, &
w
, &
h
, &
c
, 
chªÃls
);

1459 ià(!
d©a
) {

1460 
	`årštf
(
¡d”r
, "CªnÙ†ßd imag\"%s\"\nSTB R—sÚ: %s\n", 
f’ame
, 
	`¡bi_çu»_»asÚ
());

1461 
	`ex™
(0);

1463 if(
chªÃls
è
c
 = channels;

1464 
i
,
j
,
k
;

1465 
image
 
im
 = 
	`make_image
(
w
, 
h
, 
c
);

1466 
k
 = 0; k < 
c
; ++k){

1467 
j
 = 0; j < 
h
; ++j){

1468 
i
 = 0; i < 
w
; ++i){

1469 
d¡_šdex
 = 
i
 + 
w
*
j
 + w*
h
*
k
;

1470 
¤c_šdex
 = 
k
 + 
c
*
i
 + c*
w
*
j
;

1471 
im
.
d©a
[
d¡_šdex
] = ()d©a[
¤c_šdex
]/255.;

1475 
	`ä“
(
d©a
);

1476  
im
;

1477 
	}
}

1479 
image
 
	$lßd_image
(*
f’ame
, 
w
, 
h
, 
c
)

1481 #ifdeà
OPENCV


1482 
image
 
out
 = 
	`lßd_image_cv
(
f’ame
, 
c
);

1484 
image
 
out
 = 
	`lßd_image_¡b
(
f’ame
, 
c
);

1486 if((
h
 && 
w
è&& (h !ğ
out
.h || w != out.w)){

1487 
image
 
»sized
 = 
	`»size_image
(
out
, 
w
, 
h
);

1488 
	`ä“_image
(
out
);

1489 
out
 = 
»sized
;

1491  
out
;

1492 
	}
}

1494 
image
 
	$lßd_image_cŞÜ
(*
f’ame
, 
w
, 
h
)

1496  
	`lßd_image
(
f’ame
, 
w
, 
h
, 3);

1497 
	}
}

1500 
image
 
	$lßd_image_g¿y
(*
f’ame
, 
w
, 
h
){

1501  
	`lßd_image
(
f’ame
, 
w
, 
h
, 1);

1502 
	}
}

1504 
image
 
	$g‘_image_Ïy”
(
image
 
m
, 
l
)

1506 
image
 
out
 = 
	`make_image
(
m
.
w
, m.
h
, 1);

1507 
i
;

1508 
i
 = 0; i < 
m
.
h
*m.
w
; ++i){

1509 
out
.
d©a
[
i
] = 
m
.d©a[i+
l
*m.
h
*m.
w
];

1511  
out
;

1512 
	}
}

1513 
	$´št_image
(
image
 
m
)

1515 
i
, 
j
, 
k
;

1516 
i
 =0 ; i < 
m
.
c
; ++i){

1517 
j
 =0 ; j < 
m
.
h
; ++j){

1518 
k
 = 0; k < 
m
.
w
; ++k){

1519 
	`´štf
("%.2lf, ", 
m
.
d©a
[
i
*m.
h
*m.
w
 + 
j
*m.w + 
k
]);

1520 if(
k
 > 30) ;

1522 
	`´štf
("\n");

1523 if(
j
 > 30) ;

1525 
	`´štf
("\n");

1527 
	`´štf
("\n");

1528 
	}
}

1530 
image
 
	$cŞÏp£_images_v”t
(
image
 *
ims
, 
n
)

1532 
cŞÜ
 = 1;

1533 
bÜd”
 = 1;

1534 
h
,
w
,
c
;

1535 
w
 = 
ims
[0].w;

1536 
h
 = (
ims
[0].h + 
bÜd”
è* 
n
 - border;

1537 
c
 = 
ims
[0].c;

1538 if(
c
 !ğ3 || !
cŞÜ
){

1539 
w
 = (w+
bÜd”
)*
c
 - border;

1540 
c
 = 1;

1543 
image
 
f‹rs
 = 
	`make_image
(
w
, 
h
, 
c
);

1544 
i
,
j
;

1545 
i
 = 0; i < 
n
; ++i){

1546 
h_off£t
 = 
i
*(
ims
[0].
h
+
bÜd”
);

1547 
image
 
cİy
 = 
	`cİy_image
(
ims
[
i
]);

1549 if(
c
 =ğ3 && 
cŞÜ
){

1550 
	`embed_image
(
cİy
, 
f‹rs
, 0, 
h_off£t
);

1553 
j
 = 0; j < 
cİy
.
c
; ++j){

1554 
w_off£t
 = 
j
*(
ims
[0].
w
+
bÜd”
);

1555 
image
 
Ïy”
 = 
	`g‘_image_Ïy”
(
cİy
, 
j
);

1556 
	`embed_image
(
Ïy”
, 
f‹rs
, 
w_off£t
, 
h_off£t
);

1557 
	`ä“_image
(
Ïy”
);

1560 
	`ä“_image
(
cİy
);

1562  
f‹rs
;

1563 
	}
}

1565 
image
 
	$cŞÏp£_images_hÜz
(
image
 *
ims
, 
n
)

1567 
cŞÜ
 = 1;

1568 
bÜd”
 = 1;

1569 
h
,
w
,
c
;

1570 
size
 = 
ims
[0].
h
;

1571 
h
 = 
size
;

1572 
w
 = (
ims
[0].w + 
bÜd”
è* 
n
 - border;

1573 
c
 = 
ims
[0].c;

1574 if(
c
 !ğ3 || !
cŞÜ
){

1575 
h
 = (h+
bÜd”
)*
c
 - border;

1576 
c
 = 1;

1579 
image
 
f‹rs
 = 
	`make_image
(
w
, 
h
, 
c
);

1580 
i
,
j
;

1581 
i
 = 0; i < 
n
; ++i){

1582 
w_off£t
 = 
i
*(
size
+
bÜd”
);

1583 
image
 
cİy
 = 
	`cİy_image
(
ims
[
i
]);

1585 if(
c
 =ğ3 && 
cŞÜ
){

1586 
	`embed_image
(
cİy
, 
f‹rs
, 
w_off£t
, 0);

1589 
j
 = 0; j < 
cİy
.
c
; ++j){

1590 
h_off£t
 = 
j
*(
size
+
bÜd”
);

1591 
image
 
Ïy”
 = 
	`g‘_image_Ïy”
(
cİy
, 
j
);

1592 
	`embed_image
(
Ïy”
, 
f‹rs
, 
w_off£t
, 
h_off£t
);

1593 
	`ä“_image
(
Ïy”
);

1596 
	`ä“_image
(
cİy
);

1598  
f‹rs
;

1599 
	}
}

1601 
	$show_image_nÜm®ized
(
image
 
im
, cÚ¡ *
Çme
)

1603 
image
 
c
 = 
	`cİy_image
(
im
);

1604 
	`nÜm®ize_image
(
c
);

1605 
	`show_image
(
c
, 
Çme
);

1606 
	`ä“_image
(
c
);

1607 
	}
}

1609 
	$show_images
(
image
 *
ims
, 
n
, *
wšdow
)

1611 
image
 
m
 = 
	`cŞÏp£_images_v”t
(
ims
, 
n
);

1621 
	`nÜm®ize_image
(
m
);

1622 
	`§ve_image
(
m
, 
wšdow
);

1623 
	`show_image
(
m
, 
wšdow
);

1624 
	`ä“_image
(
m
);

1625 
	}
}

1627 
	$ä“_image
(
image
 
m
)

1629 if(
m
.
d©a
){

1630 
	`ä“
(
m
.
d©a
);

1632 
	}
}

	@image.h

1 #iâdeà
IMAGE_H


2 
	#IMAGE_H


	)

4 
	~<¡dlib.h
>

5 
	~<¡dio.h
>

6 
	~<æßt.h
>

7 
	~<¡ršg.h
>

8 
	~<m©h.h
>

9 
	~"box.h
"

10 
	~"d¬kÃt.h
"

12 #iâdeà
__ılu¥lus


13 #ifdeà
OPENCV


14 
fl_image_äom_¡»am
(
CvC­tu»
 *
ÿp
, 
image
 
im
);

15 
image
 
l_to_image
(
I¶Image
* 
¤c
);

16 
l_što_image
(
I¶Image
* 
¤c
, 
image
 
im
);

17 
æush_¡»am_bufãr
(
CvC­tu»
 *
ÿp
, 
n
);

18 
show_image_cv
(
image
 
p
, cÚ¡ *
Çme
, 
I¶Image
 *
di¥
);

22 
g‘_cŞÜ
(
c
, 
x
, 
max
);

23 
d¿w_box
(
image
 
a
, 
x1
, 
y1
, 
x2
, 
y2
, 
r
, 
g
, 
b
);

24 
d¿w_bbox
(
image
 
a
, 
box
 
bbox
, 
w
, 
r
, 
g
, 
b
);

25 
wr™e_Ïb–
(
image
 
a
, 
r
, 
c
, imag*
ch¬aù”s
, *
¡ršg
, *
rgb
);

26 
image
 
image_di¡ªû
(imag
a
, imag
b
);

27 
sÿË_image
(
image
 
m
, 
s
);

28 
image
 
rÙ©e_üİ_image
(imag
im
, 
¿d
, 
s
, 
w
, 
h
, 
dx
, 
dy
, 
a¥eù
);

29 
image
 
¿ndom_üİ_image
(imag
im
, 
w
, 
h
);

30 
image
 
¿ndom_augm’t_image
(imag
im
, 
ªgË
, 
a¥eù
, 
low
, 
high
, 
w
, 
h
);

31 
augm’t_¬gs
 
¿ndom_augm’t_¬gs
(
image
 
im
, 
ªgË
, 
a¥eù
, 
low
, 
high
, 
w
, 
h
);

32 
Ë‰”box_image_što
(
image
 
im
, 
w
, 
h
, imag
boxed
);

33 
image
 
»size_max
(imag
im
, 
max
);

34 
Œª¦©e_image
(
image
 
m
, 
s
);

35 
embed_image
(
image
 
sourû
, imag
de¡
, 
dx
, 
dy
);

36 
¶aû_image
(
image
 
im
, 
w
, 
h
, 
dx
, 
dy
, imag
ÿnvas
);

37 
§tu¿‹_image
(
image
 
im
, 
§t
);

38 
exposu»_image
(
image
 
im
, 
§t
);

39 
di¡Üt_image
(
image
 
im
, 
hue
, 
§t
, 
v®
);

40 
§tu¿‹_exposu»_image
(
image
 
im
, 
§t
, 
exposu»
);

41 
rgb_to_hsv
(
image
 
im
);

42 
hsv_to_rgb
(
image
 
im
);

43 
yuv_to_rgb
(
image
 
im
);

44 
rgb_to_yuv
(
image
 
im
);

47 
image
 
cŞÏp£_image_Ïy”s
(imag
sourû
, 
bÜd”
);

48 
image
 
cŞÏp£_images_hÜz
(imag*
ims
, 
n
);

49 
image
 
cŞÏp£_images_v”t
(imag*
ims
, 
n
);

51 
show_image_nÜm®ized
(
image
 
im
, cÚ¡ *
Çme
);

52 
show_images
(
image
 *
ims
, 
n
, *
wšdow
);

53 
show_image_Ïy”s
(
image
 
p
, *
Çme
);

54 
show_image_cŞÏp£d
(
image
 
p
, *
Çme
);

56 
´št_image
(
image
 
m
);

58 
image
 
make_em±y_image
(
w
, 
h
, 
c
);

59 
cİy_image_što
(
image
 
¤c
, imag
de¡
);

61 
image
 
g‘_image_Ïy”
(imag
m
, 
l
);

	@l2norm_layer.c

1 
	~"l2nÜm_Ïy”.h
"

2 
	~"aùiv©iÚs.h
"

3 
	~"bÏs.h
"

4 
	~"cuda.h
"

6 
	~<æßt.h
>

7 
	~<m©h.h
>

8 
	~<¡dlib.h
>

9 
	~<¡dio.h
>

10 
	~<as£¹.h
>

12 
Ïy”
 
	$make_l2nÜm_Ïy”
(
b©ch
, 
šputs
)

14 
	`årštf
(
¡d”r
, "l2nÜm %4d\n", 
šputs
);

15 
Ïy”
 
l
 = {0};

16 
l
.
ty³
 = 
L2NORM
;

17 
l
.
b©ch
 = batch;

18 
l
.
šputs
 = inputs;

19 
l
.
ouuts
 = 
šputs
;

20 
l
.
ouut
 = 
	`ÿÎoc
(
šputs
*
b©ch
, ());

21 
l
.
sÿËs
 = 
	`ÿÎoc
(
šputs
*
b©ch
, ());

22 
l
.
d–
 = 
	`ÿÎoc
(
šputs
*
b©ch
, ());

24 
l
.
fÜw¬d
 = 
fÜw¬d_l2nÜm_Ïy”
;

25 
l
.
backw¬d
 = 
backw¬d_l2nÜm_Ïy”
;

26 #ifdeà
GPU


27 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_l2nÜm_Ïy”_gpu
;

28 
l
.
backw¬d_gpu
 = 
backw¬d_l2nÜm_Ïy”_gpu
;

30 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
, 
šputs
*
b©ch
);

31 
l
.
sÿËs_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
, 
šputs
*
b©ch
);

32 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
, 
šputs
*
b©ch
);

34  
l
;

35 
	}
}

37 
	$fÜw¬d_l2nÜm_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

39 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
, 
Ãt
.
šput
, 1,†.
ouut
, 1);

40 
	`l2nÜm®ize_ıu
(
l
.
ouut
,†.
sÿËs
,†.
b©ch
,†.
out_c
,†.
out_w
*l.
out_h
);

41 
	}
}

43 
	$backw¬d_l2nÜm_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

46 
	`axpy_ıu
(
l
.
šputs
*l.
b©ch
, 1,†.
d–
, 1, 
Ãt
.delta, 1);

47 
	}
}

49 #ifdeà
GPU


51 
	$fÜw¬d_l2nÜm_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

53 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
Ãt
.
šput_gpu
, 1,†.
ouut_gpu
, 1);

54 
	`l2nÜm®ize_gpu
(
l
.
ouut_gpu
,†.
sÿËs_gpu
,†.
b©ch
,†.
out_c
,†.
out_w
*l.
out_h
);

55 
	}
}

57 
	$backw¬d_l2nÜm_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

59 
	`axpy_gpu
(
l
.
b©ch
*l.
šputs
, 1,†.
sÿËs_gpu
, 1,†.
d–_gpu
, 1);

60 
	`axpy_gpu
(
l
.
b©ch
*l.
šputs
, 1,†.
d–_gpu
, 1, 
Ãt
.delta_gpu, 1);

61 
	}
}

	@l2norm_layer.h

1 #iâdeà
L2NORM_LAYER_H


2 
	#L2NORM_LAYER_H


	)

3 
	~"Ïy”.h
"

4 
	~"ÃtwÜk.h
"

6 
Ïy”
 
make_l2nÜm_Ïy”
(
b©ch
, 
šputs
);

7 
fÜw¬d_l2nÜm_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

8 
backw¬d_l2nÜm_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

10 #ifdeà
GPU


11 
fÜw¬d_l2nÜm_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

12 
backw¬d_l2nÜm_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

	@layer.c

1 
	~"Ïy”.h
"

2 
	~"cuda.h
"

4 
	~<¡dlib.h
>

6 
	$ä“_Ïy”
(
Ïy”
 
l
)

8 if(
l
.
ty³
 =ğ
DROPOUT
){

9 if(
l
.
¿nd
è
	`ä“
(l.rand);

10 #ifdeà
GPU


11 if(
l
.
¿nd_gpu
è
	`cuda_ä“
(l.rand_gpu);

15 if(
l
.
cweights
è
	`ä“
(l.cweights);

16 if(
l
.
šdexes
è
	`ä“
(l.indexes);

17 if(
l
.
šput_Ïy”s
è
	`ä“
(l.input_layers);

18 if(
l
.
šput_sizes
è
	`ä“
(l.input_sizes);

19 if(
l
.
m­
è
	`ä“
(l.map);

20 if(
l
.
¿nd
è
	`ä“
(l.rand);

21 if(
l
.
co¡
è
	`ä“
(l.cost);

22 if(
l
.
¡©e
è
	`ä“
(l.state);

23 if(
l
.
´ev_¡©e
è
	`ä“
(l.prev_state);

24 if(
l
.
fÜgÙ_¡©e
è
	`ä“
(l.forgot_state);

25 if(
l
.
fÜgÙ_d–
è
	`ä“
(l.forgot_delta);

26 if(
l
.
¡©e_d–
è
	`ä“
(l.state_delta);

27 if(
l
.
cÚÿt
è
	`ä“
(l.concat);

28 if(
l
.
cÚÿt_d–
è
	`ä“
(l.concat_delta);

29 if(
l
.
bš¬y_weights
è
	`ä“
(l.binary_weights);

30 if(
l
.
bŸ£s
è
	`ä“
(l.biases);

31 if(
l
.
bŸs_upd©es
è
	`ä“
(l.bias_updates);

32 if(
l
.
sÿËs
è
	`ä“
(l.scales);

33 if(
l
.
sÿË_upd©es
è
	`ä“
(l.scale_updates);

34 if(
l
.
weights
è
	`ä“
(l.weights);

35 if(
l
.
weight_upd©es
è
	`ä“
(l.weight_updates);

36 if(
l
.
d–
è
	`ä“
(l.delta);

37 if(
l
.
ouut
è
	`ä“
(l.output);

38 if(
l
.
squ¬ed
è
	`ä“
(l.squared);

39 if(
l
.
nÜms
è
	`ä“
(l.norms);

40 if(
l
.
¥©Ÿl_m—n
è
	`ä“
(l.spatial_mean);

41 if(
l
.
m—n
è
	`ä“
(l.mean);

42 if(
l
.
v¬Ÿnû
è
	`ä“
(l.variance);

43 if(
l
.
m—n_d–
è
	`ä“
(l.mean_delta);

44 if(
l
.
v¬Ÿnû_d–
è
	`ä“
(l.variance_delta);

45 if(
l
.
rŞlšg_m—n
è
	`ä“
(l.rolling_mean);

46 if(
l
.
rŞlšg_v¬Ÿnû
è
	`ä“
(l.rolling_variance);

47 if(
l
.
x
è
	`ä“
(l.x);

48 if(
l
.
x_nÜm
è
	`ä“
(l.x_norm);

49 if(
l
.
m
è
	`ä“
(l.m);

50 if(
l
.
v
è
	`ä“
(l.v);

51 if(
l
.
z_ıu
è
	`ä“
(l.z_cpu);

52 if(
l
.
r_ıu
è
	`ä“
(l.r_cpu);

53 if(
l
.
h_ıu
è
	`ä“
(l.h_cpu);

54 if(
l
.
bš¬y_šput
è
	`ä“
(l.binary_input);

56 #ifdeà
GPU


57 if(
l
.
šdexes_gpu
è
	`cuda_ä“
((*)l.indexes_gpu);

59 if(
l
.
z_gpu
è
	`cuda_ä“
(l.z_gpu);

60 if(
l
.
r_gpu
è
	`cuda_ä“
(l.r_gpu);

61 if(
l
.
h_gpu
è
	`cuda_ä“
(l.h_gpu);

62 if(
l
.
m_gpu
è
	`cuda_ä“
(l.m_gpu);

63 if(
l
.
v_gpu
è
	`cuda_ä“
(l.v_gpu);

64 if(
l
.
´ev_¡©e_gpu
è
	`cuda_ä“
(l.prev_state_gpu);

65 if(
l
.
fÜgÙ_¡©e_gpu
è
	`cuda_ä“
(l.forgot_state_gpu);

66 if(
l
.
fÜgÙ_d–_gpu
è
	`cuda_ä“
(l.forgot_delta_gpu);

67 if(
l
.
¡©e_gpu
è
	`cuda_ä“
(l.state_gpu);

68 if(
l
.
¡©e_d–_gpu
è
	`cuda_ä“
(l.state_delta_gpu);

69 if(
l
.
g©e_gpu
è
	`cuda_ä“
(l.gate_gpu);

70 if(
l
.
g©e_d–_gpu
è
	`cuda_ä“
(l.gate_delta_gpu);

71 if(
l
.
§ve_gpu
è
	`cuda_ä“
(l.save_gpu);

72 if(
l
.
§ve_d–_gpu
è
	`cuda_ä“
(l.save_delta_gpu);

73 if(
l
.
cÚÿt_gpu
è
	`cuda_ä“
(l.concat_gpu);

74 if(
l
.
cÚÿt_d–_gpu
è
	`cuda_ä“
(l.concat_delta_gpu);

75 if(
l
.
bš¬y_šput_gpu
è
	`cuda_ä“
(l.binary_input_gpu);

76 if(
l
.
bš¬y_weights_gpu
è
	`cuda_ä“
(l.binary_weights_gpu);

77 if(
l
.
m—n_gpu
è
	`cuda_ä“
(l.mean_gpu);

78 if(
l
.
v¬Ÿnû_gpu
è
	`cuda_ä“
(l.variance_gpu);

79 if(
l
.
rŞlšg_m—n_gpu
è
	`cuda_ä“
(l.rolling_mean_gpu);

80 if(
l
.
rŞlšg_v¬Ÿnû_gpu
è
	`cuda_ä“
(l.rolling_variance_gpu);

81 if(
l
.
v¬Ÿnû_d–_gpu
è
	`cuda_ä“
(l.variance_delta_gpu);

82 if(
l
.
m—n_d–_gpu
è
	`cuda_ä“
(l.mean_delta_gpu);

83 if(
l
.
x_gpu
è
	`cuda_ä“
(l.x_gpu);

84 if(
l
.
x_nÜm_gpu
è
	`cuda_ä“
(l.x_norm_gpu);

85 if(
l
.
weights_gpu
è
	`cuda_ä“
(l.weights_gpu);

86 if(
l
.
weight_upd©es_gpu
è
	`cuda_ä“
(l.weight_updates_gpu);

87 if(
l
.
bŸ£s_gpu
è
	`cuda_ä“
(l.biases_gpu);

88 if(
l
.
bŸs_upd©es_gpu
è
	`cuda_ä“
(l.bias_updates_gpu);

89 if(
l
.
sÿËs_gpu
è
	`cuda_ä“
(l.scales_gpu);

90 if(
l
.
sÿË_upd©es_gpu
è
	`cuda_ä“
(l.scale_updates_gpu);

91 if(
l
.
ouut_gpu
è
	`cuda_ä“
(l.output_gpu);

92 if(
l
.
d–_gpu
è
	`cuda_ä“
(l.delta_gpu);

93 if(
l
.
¿nd_gpu
è
	`cuda_ä“
(l.rand_gpu);

94 if(
l
.
squ¬ed_gpu
è
	`cuda_ä“
(l.squared_gpu);

95 if(
l
.
nÜms_gpu
è
	`cuda_ä“
(l.norms_gpu);

97 
	}
}

	@layer.h

1 
	~"d¬kÃt.h
"

	@list.c

1 
	~<¡dlib.h
>

2 
	~<¡ršg.h
>

3 
	~"li¡.h
"

5 
li¡
 *
	$make_li¡
()

7 
li¡
 *
l
 = 
	`m®loc
((list));

8 
l
->
size
 = 0;

9 
l
->
äÚt
 = 0;

10 
l
->
back
 = 0;

11  
l
;

12 
	}
}

28 *
	$li¡_pİ
(
li¡
 *
l
){

29 if(!
l
->
back
)  0;

30 
node
 *
b
 = 
l
->
back
;

31 *
v®
 = 
b
->val;

32 
l
->
back
 = 
b
->
´ev
;

33 if(
l
->
back
èl->back->
Ãxt
 = 0;

34 
	`ä“
(
b
);

35 --
l
->
size
;

37  
v®
;

38 
	}
}

40 
	$li¡_š£¹
(
li¡
 *
l
, *
v®
)

42 
node
 *
Ãw
 = 
	`m®loc
((node));

43 
Ãw
->
v®
 = val;

44 
Ãw
->
Ãxt
 = 0;

46 if(!
l
->
back
){

47 
l
->
äÚt
 = 
Ãw
;

48 
Ãw
->
´ev
 = 0;

50 
l
->
back
->
Ãxt
 = 
Ãw
;

51 
Ãw
->
´ev
 = 
l
->
back
;

53 
l
->
back
 = 
Ãw
;

54 ++
l
->
size
;

55 
	}
}

57 
	$ä“_node
(
node
 *
n
)

59 
node
 *
Ãxt
;

60 
n
) {

61 
Ãxt
 = 
n
->next;

62 
	`ä“
(
n
);

63 
n
 = 
Ãxt
;

65 
	}
}

67 
	$ä“_li¡
(
li¡
 *
l
)

69 
	`ä“_node
(
l
->
äÚt
);

70 
	`ä“
(
l
);

71 
	}
}

73 
	$ä“_li¡_cÚ‹Ás
(
li¡
 *
l
)

75 
node
 *
n
 = 
l
->
äÚt
;

76 
n
){

77 
	`ä“
(
n
->
v®
);

78 
n
 =‚->
Ãxt
;

80 
	}
}

82 **
	$li¡_to_¬¿y
(
li¡
 *
l
)

84 **
a
 = 
	`ÿÎoc
(
l
->
size
, (*));

85 
couÁ
 = 0;

86 
node
 *
n
 = 
l
->
äÚt
;

87 
n
){

88 
a
[
couÁ
++] = 
n
->
v®
;

89 
n
 =‚->
Ãxt
;

91  
a
;

92 
	}
}

	@list.h

1 #iâdeà
LIST_H


2 
	#LIST_H


	)

3 
	~"d¬kÃt.h
"

5 
li¡
 *
make_li¡
();

6 
li¡_fšd
(
li¡
 *
l
, *
v®
);

8 
li¡_š£¹
(
li¡
 *, *);

11 
ä“_li¡_cÚ‹Ás
(
li¡
 *
l
);

	@local_layer.c

1 
	~"loÿl_Ïy”.h
"

2 
	~"uts.h
"

3 
	~"im2cŞ.h
"

4 
	~"cŞ2im.h
"

5 
	~"bÏs.h
"

6 
	~"gemm.h
"

7 
	~<¡dio.h
>

8 
	~<time.h
>

10 
	$loÿl_out_height
(
loÿl_Ïy”
 
l
)

12 
h
 = 
l
.h;

13 ià(!
l
.
·d
è
h
 -ğl.
size
;

14 
h
 -= 1;

15  
h
/
l
.
¡ride
 + 1;

16 
	}
}

18 
	$loÿl_out_width
(
loÿl_Ïy”
 
l
)

20 
w
 = 
l
.w;

21 ià(!
l
.
·d
è
w
 -ğl.
size
;

22 
w
 -= 1;

23  
w
/
l
.
¡ride
 + 1;

24 
	}
}

26 
loÿl_Ïy”
 
	$make_loÿl_Ïy”
(
b©ch
, 
h
, 
w
, 
c
, 
n
, 
size
, 
¡ride
, 
·d
, 
ACTIVATION
 
aùiv©iÚ
)

28 
i
;

29 
loÿl_Ïy”
 
l
 = {0};

30 
l
.
ty³
 = 
LOCAL
;

32 
l
.
h
 = h;

33 
l
.
w
 = w;

34 
l
.
c
 = c;

35 
l
.
n
 =‚;

36 
l
.
b©ch
 = batch;

37 
l
.
¡ride
 = stride;

38 
l
.
size
 = size;

39 
l
.
·d
 =…ad;

41 
out_h
 = 
	`loÿl_out_height
(
l
);

42 
out_w
 = 
	`loÿl_out_width
(
l
);

43 
loÿtiÚs
 = 
out_h
*
out_w
;

44 
l
.
out_h
 = out_h;

45 
l
.
out_w
 = out_w;

46 
l
.
out_c
 = 
n
;

47 
l
.
ouuts
 =†.
out_h
 *†.
out_w
 *†.
out_c
;

48 
l
.
šputs
 =†.
w
 *†.
h
 *†.
c
;

50 
l
.
weights
 = 
	`ÿÎoc
(
c
*
n
*
size
*size*
loÿtiÚs
, ());

51 
l
.
weight_upd©es
 = 
	`ÿÎoc
(
c
*
n
*
size
*size*
loÿtiÚs
, ());

53 
l
.
bŸ£s
 = 
	`ÿÎoc
Ö.
ouuts
, ());

54 
l
.
bŸs_upd©es
 = 
	`ÿÎoc
Ö.
ouuts
, ());

57 
sÿË
 = 
	`sq¹
(2./(
size
*size*
c
));

58 
i
 = 0; i < 
c
*
n
*
size
*size; ++iè
l
.
weights
[i] = 
sÿË
*
	`¿nd_unifÜm
(-1,1);

60 
l
.
ouut
 = 
	`ÿÎoc
Ö.
b©ch
*
out_h
 * 
out_w
 * 
n
, ());

61 
l
.
d–
 = 
	`ÿÎoc
Ö.
b©ch
*
out_h
 * 
out_w
 * 
n
, ());

63 
l
.
wÜk¥aû_size
 = 
out_h
*
out_w
*
size
*size*
c
;

65 
l
.
fÜw¬d
 = 
fÜw¬d_loÿl_Ïy”
;

66 
l
.
backw¬d
 = 
backw¬d_loÿl_Ïy”
;

67 
l
.
upd©e
 = 
upd©e_loÿl_Ïy”
;

69 #ifdeà
GPU


70 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_loÿl_Ïy”_gpu
;

71 
l
.
backw¬d_gpu
 = 
backw¬d_loÿl_Ïy”_gpu
;

72 
l
.
upd©e_gpu
 = 
upd©e_loÿl_Ïy”_gpu
;

74 
l
.
weights_gpu
 = 
	`cuda_make_¬¿y
Ö.
weights
, 
c
*
n
*
size
*size*
loÿtiÚs
);

75 
l
.
weight_upd©es_gpu
 = 
	`cuda_make_¬¿y
Ö.
weight_upd©es
, 
c
*
n
*
size
*size*
loÿtiÚs
);

77 
l
.
bŸ£s_gpu
 = 
	`cuda_make_¬¿y
Ö.
bŸ£s
,†.
ouuts
);

78 
l
.
bŸs_upd©es_gpu
 = 
	`cuda_make_¬¿y
Ö.
bŸs_upd©es
,†.
ouuts
);

80 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
,†.
b©ch
*
out_h
*
out_w
*
n
);

81 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
,†.
b©ch
*
out_h
*
out_w
*
n
);

84 
l
.
aùiv©iÚ
 =‡ctivation;

86 
	`årštf
(
¡d”r
, "LoÿÈLay”: %d x %d x %d image, %d f‹r -> %d x %d x %d image\n", 
h
,
w
,
c
,
n
, 
out_h
, 
out_w
,‚);

88  
l
;

89 
	}
}

91 
	$fÜw¬d_loÿl_Ïy”
(cÚ¡ 
loÿl_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

93 
out_h
 = 
	`loÿl_out_height
(
l
);

94 
out_w
 = 
	`loÿl_out_width
(
l
);

95 
i
, 
j
;

96 
loÿtiÚs
 = 
out_h
 * 
out_w
;

98 
i
 = 0; i < 
l
.
b©ch
; ++i){

99 
	`cİy_ıu
(
l
.
ouuts
,†.
bŸ£s
, 1,†.
ouut
 + 
i
*l.outputs, 1);

102 
i
 = 0; i < 
l
.
b©ch
; ++i){

103 *
šput
 = 
Ãt
.špuˆ+ 
i
*
l
.
w
*l.
h
*l.
c
;

104 
	`im2cŞ_ıu
(
šput
, 
l
.
c
,†.
h
,†.
w
,

105 
l
.
size
,†.
¡ride
,†.
·d
, 
Ãt
.
wÜk¥aû
);

106 *
ouut
 = 
l
.ouuˆ+ 
i
*l.
ouuts
;

107 
j
 = 0; j < 
loÿtiÚs
; ++j){

108 *
a
 = 
l
.
weights
 + 
j
*l.
size
*l.size*l.
c
*l.
n
;

109 *
b
 = 
Ãt
.
wÜk¥aû
 + 
j
;

110 *
c
 = 
ouut
 + 
j
;

112 
m
 = 
l
.
n
;

113 
n
 = 1;

114 
k
 = 
l
.
size
*l.size*l.
c
;

116 
	`gemm
(0,0,
m
,
n
,
k
,1,
a
,k,
b
,
loÿtiÚs
,1,
c
,locations);

119 
	`aùiv©e_¬¿y
(
l
.
ouut
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
);

120 
	}
}

122 
	$backw¬d_loÿl_Ïy”
(
loÿl_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

124 
i
, 
j
;

125 
loÿtiÚs
 = 
l
.
out_w
*l.
out_h
;

127 
	`g¿d›Á_¬¿y
(
l
.
ouut
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
,†.
d–
);

129 
i
 = 0; i < 
l
.
b©ch
; ++i){

130 
	`axpy_ıu
(
l
.
ouuts
, 1,†.
d–
 + 
i
*l.ouuts, 1,†.
bŸs_upd©es
, 1);

133 
i
 = 0; i < 
l
.
b©ch
; ++i){

134 *
šput
 = 
Ãt
.špuˆ+ 
i
*
l
.
w
*l.
h
*l.
c
;

135 
	`im2cŞ_ıu
(
šput
, 
l
.
c
,†.
h
,†.
w
,

136 
l
.
size
,†.
¡ride
,†.
·d
, 
Ãt
.
wÜk¥aû
);

138 
j
 = 0; j < 
loÿtiÚs
; ++j){

139 *
a
 = 
l
.
d–
 + 
i
*l.
ouuts
 + 
j
;

140 *
b
 = 
Ãt
.
wÜk¥aû
 + 
j
;

141 *
c
 = 
l
.
weight_upd©es
 + 
j
*l.
size
*l.size*l.c*l.
n
;

142 
m
 = 
l
.
n
;

143 
n
 = 
l
.
size
*l.size*l.
c
;

144 
k
 = 1;

146 
	`gemm
(0,1,
m
,
n
,
k
,1,
a
,
loÿtiÚs
,
b
,loÿtiÚs,1,
c
,n);

149 if(
Ãt
.
d–
){

150 
j
 = 0; j < 
loÿtiÚs
; ++j){

151 *
a
 = 
l
.
weights
 + 
j
*l.
size
*l.size*l.
c
*l.
n
;

152 *
b
 = 
l
.
d–
 + 
i
*l.
ouuts
 + 
j
;

153 *
c
 = 
Ãt
.
wÜk¥aû
 + 
j
;

155 
m
 = 
l
.
size
*l.size*l.
c
;

156 
n
 = 1;

157 
k
 = 
l
.
n
;

159 
	`gemm
(1,0,
m
,
n
,
k
,1,
a
,m,
b
,
loÿtiÚs
,0,
c
,locations);

162 
	`cŞ2im_ıu
(
Ãt
.
wÜk¥aû
, 
l
.
c
,†.
h
,†.
w
,†.
size
,†.
¡ride
,†.
·d
,‚‘.
d–
+
i
*l.c*l.h*l.w);

165 
	}
}

167 
	$upd©e_loÿl_Ïy”
(
loÿl_Ïy”
 
l
, 
upd©e_¬gs
 
a
)

169 
Ë¬nšg_¿‹
 = 
a
.Ë¬nšg_¿‹*
l
.
Ë¬nšg_¿‹_sÿË
;

170 
mom’tum
 = 
a
.momentum;

171 
deÿy
 = 
a
.decay;

172 
b©ch
 = 
a
.batch;

174 
loÿtiÚs
 = 
l
.
out_w
*l.
out_h
;

175 
size
 = 
l
.size*l.size*l.
c
*l.
n
*
loÿtiÚs
;

176 
	`axpy_ıu
(
l
.
ouuts
, 
Ë¬nšg_¿‹
/
b©ch
,†.
bŸs_upd©es
, 1,†.
bŸ£s
, 1);

177 
	`sÿl_ıu
(
l
.
ouuts
, 
mom’tum
,†.
bŸs_upd©es
, 1);

179 
	`axpy_ıu
(
size
, -
deÿy
*
b©ch
, 
l
.
weights
, 1,†.
weight_upd©es
, 1);

180 
	`axpy_ıu
(
size
, 
Ë¬nšg_¿‹
/
b©ch
, 
l
.
weight_upd©es
, 1,†.
weights
, 1);

181 
	`sÿl_ıu
(
size
, 
mom’tum
, 
l
.
weight_upd©es
, 1);

182 
	}
}

184 #ifdeà
GPU


186 
	$fÜw¬d_loÿl_Ïy”_gpu
(cÚ¡ 
loÿl_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

188 
out_h
 = 
	`loÿl_out_height
(
l
);

189 
out_w
 = 
	`loÿl_out_width
(
l
);

190 
i
, 
j
;

191 
loÿtiÚs
 = 
out_h
 * 
out_w
;

193 
i
 = 0; i < 
l
.
b©ch
; ++i){

194 
	`cİy_gpu
(
l
.
ouuts
,†.
bŸ£s_gpu
, 1,†.
ouut_gpu
 + 
i
*l.outputs, 1);

197 
i
 = 0; i < 
l
.
b©ch
; ++i){

198 *
šput
 = 
Ãt
.
šput_gpu
 + 
i
*
l
.
w
*l.
h
*l.
c
;

199 
	`im2cŞ_gpu
(
šput
, 
l
.
c
,†.
h
,†.
w
,

200 
l
.
size
,†.
¡ride
,†.
·d
, 
Ãt
.
wÜk¥aû
);

201 *
ouut
 = 
l
.
ouut_gpu
 + 
i
*l.
ouuts
;

202 
j
 = 0; j < 
loÿtiÚs
; ++j){

203 *
a
 = 
l
.
weights_gpu
 + 
j
*l.
size
*l.size*l.
c
*l.
n
;

204 *
b
 = 
Ãt
.
wÜk¥aû
 + 
j
;

205 *
c
 = 
ouut
 + 
j
;

207 
m
 = 
l
.
n
;

208 
n
 = 1;

209 
k
 = 
l
.
size
*l.size*l.
c
;

211 
	`gemm_gpu
(0,0,
m
,
n
,
k
,1,
a
,k,
b
,
loÿtiÚs
,1,
c
,locations);

214 
	`aùiv©e_¬¿y_gpu
(
l
.
ouut_gpu
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
);

215 
	}
}

217 
	$backw¬d_loÿl_Ïy”_gpu
(
loÿl_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

219 
i
, 
j
;

220 
loÿtiÚs
 = 
l
.
out_w
*l.
out_h
;

222 
	`g¿d›Á_¬¿y_gpu
(
l
.
ouut_gpu
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
,†.
d–_gpu
);

223 
i
 = 0; i < 
l
.
b©ch
; ++i){

224 
	`axpy_gpu
(
l
.
ouuts
, 1,†.
d–_gpu
 + 
i
*l.ouuts, 1,†.
bŸs_upd©es_gpu
, 1);

227 
i
 = 0; i < 
l
.
b©ch
; ++i){

228 *
šput
 = 
Ãt
.
šput_gpu
 + 
i
*
l
.
w
*l.
h
*l.
c
;

229 
	`im2cŞ_gpu
(
šput
, 
l
.
c
,†.
h
,†.
w
,

230 
l
.
size
,†.
¡ride
,†.
·d
, 
Ãt
.
wÜk¥aû
);

232 
j
 = 0; j < 
loÿtiÚs
; ++j){

233 *
a
 = 
l
.
d–_gpu
 + 
i
*l.
ouuts
 + 
j
;

234 *
b
 = 
Ãt
.
wÜk¥aû
 + 
j
;

235 *
c
 = 
l
.
weight_upd©es_gpu
 + 
j
*l.
size
*l.size*l.c*l.
n
;

236 
m
 = 
l
.
n
;

237 
n
 = 
l
.
size
*l.size*l.
c
;

238 
k
 = 1;

240 
	`gemm_gpu
(0,1,
m
,
n
,
k
,1,
a
,
loÿtiÚs
,
b
,loÿtiÚs,1,
c
,n);

243 if(
Ãt
.
d–_gpu
){

244 
j
 = 0; j < 
loÿtiÚs
; ++j){

245 *
a
 = 
l
.
weights_gpu
 + 
j
*l.
size
*l.size*l.
c
*l.
n
;

246 *
b
 = 
l
.
d–_gpu
 + 
i
*l.
ouuts
 + 
j
;

247 *
c
 = 
Ãt
.
wÜk¥aû
 + 
j
;

249 
m
 = 
l
.
size
*l.size*l.
c
;

250 
n
 = 1;

251 
k
 = 
l
.
n
;

253 
	`gemm_gpu
(1,0,
m
,
n
,
k
,1,
a
,m,
b
,
loÿtiÚs
,0,
c
,locations);

256 
	`cŞ2im_gpu
(
Ãt
.
wÜk¥aû
, 
l
.
c
,†.
h
,†.
w
,†.
size
,†.
¡ride
,†.
·d
,‚‘.
d–_gpu
+
i
*l.c*l.h*l.w);

259 
	}
}

261 
	$upd©e_loÿl_Ïy”_gpu
(
loÿl_Ïy”
 
l
, 
upd©e_¬gs
 
a
)

263 
Ë¬nšg_¿‹
 = 
a
.Ë¬nšg_¿‹*
l
.
Ë¬nšg_¿‹_sÿË
;

264 
mom’tum
 = 
a
.momentum;

265 
deÿy
 = 
a
.decay;

266 
b©ch
 = 
a
.batch;

268 
loÿtiÚs
 = 
l
.
out_w
*l.
out_h
;

269 
size
 = 
l
.size*l.size*l.
c
*l.
n
*
loÿtiÚs
;

270 
	`axpy_gpu
(
l
.
ouuts
, 
Ë¬nšg_¿‹
/
b©ch
,†.
bŸs_upd©es_gpu
, 1,†.
bŸ£s_gpu
, 1);

271 
	`sÿl_gpu
(
l
.
ouuts
, 
mom’tum
,†.
bŸs_upd©es_gpu
, 1);

273 
	`axpy_gpu
(
size
, -
deÿy
*
b©ch
, 
l
.
weights_gpu
, 1,†.
weight_upd©es_gpu
, 1);

274 
	`axpy_gpu
(
size
, 
Ë¬nšg_¿‹
/
b©ch
, 
l
.
weight_upd©es_gpu
, 1,†.
weights_gpu
, 1);

275 
	`sÿl_gpu
(
size
, 
mom’tum
, 
l
.
weight_upd©es_gpu
, 1);

276 
	}
}

278 
	$puÎ_loÿl_Ïy”
(
loÿl_Ïy”
 
l
)

280 
loÿtiÚs
 = 
l
.
out_w
*l.
out_h
;

281 
size
 = 
l
.size*l.size*l.
c
*l.
n
*
loÿtiÚs
;

282 
	`cuda_puÎ_¬¿y
(
l
.
weights_gpu
,†.
weights
, 
size
);

283 
	`cuda_puÎ_¬¿y
(
l
.
bŸ£s_gpu
,†.
bŸ£s
,†.
ouuts
);

284 
	}
}

286 
	$push_loÿl_Ïy”
(
loÿl_Ïy”
 
l
)

288 
loÿtiÚs
 = 
l
.
out_w
*l.
out_h
;

289 
size
 = 
l
.size*l.size*l.
c
*l.
n
*
loÿtiÚs
;

290 
	`cuda_push_¬¿y
(
l
.
weights_gpu
,†.
weights
, 
size
);

291 
	`cuda_push_¬¿y
(
l
.
bŸ£s_gpu
,†.
bŸ£s
,†.
ouuts
);

292 
	}
}

	@local_layer.h

1 #iâdeà
LOCAL_LAYER_H


2 
	#LOCAL_LAYER_H


	)

4 
	~"cuda.h
"

5 
	~"image.h
"

6 
	~"aùiv©iÚs.h
"

7 
	~"Ïy”.h
"

8 
	~"ÃtwÜk.h
"

10 
Ïy”
 
	tloÿl_Ïy”
;

12 #ifdeà
GPU


13 
fÜw¬d_loÿl_Ïy”_gpu
(
loÿl_Ïy”
 
Ïy”
, 
ÃtwÜk
 
Ãt
);

14 
backw¬d_loÿl_Ïy”_gpu
(
loÿl_Ïy”
 
Ïy”
, 
ÃtwÜk
 
Ãt
);

15 
upd©e_loÿl_Ïy”_gpu
(
loÿl_Ïy”
 
Ïy”
, 
upd©e_¬gs
 
a
);

17 
push_loÿl_Ïy”
(
loÿl_Ïy”
 
Ïy”
);

18 
puÎ_loÿl_Ïy”
(
loÿl_Ïy”
 
Ïy”
);

21 
loÿl_Ïy”
 
make_loÿl_Ïy”
(
b©ch
, 
h
, 
w
, 
c
, 
n
, 
size
, 
¡ride
, 
·d
, 
ACTIVATION
 
aùiv©iÚ
);

23 
fÜw¬d_loÿl_Ïy”
(cÚ¡ 
loÿl_Ïy”
 
Ïy”
, 
ÃtwÜk
 
Ãt
);

24 
backw¬d_loÿl_Ïy”
(
loÿl_Ïy”
 
Ïy”
, 
ÃtwÜk
 
Ãt
);

25 
upd©e_loÿl_Ïy”
(
loÿl_Ïy”
 
Ïy”
, 
upd©e_¬gs
 
a
);

27 
bŸs_ouut
(*
ouut
, *
bŸ£s
, 
b©ch
, 
n
, 
size
);

28 
backw¬d_bŸs
(*
bŸs_upd©es
, *
d–
, 
b©ch
, 
n
, 
size
);

	@logistic_layer.c

1 
	~"logi¡ic_Ïy”.h
"

2 
	~"aùiv©iÚs.h
"

3 
	~"bÏs.h
"

4 
	~"cuda.h
"

6 
	~<æßt.h
>

7 
	~<m©h.h
>

8 
	~<¡dlib.h
>

9 
	~<¡dio.h
>

10 
	~<as£¹.h
>

12 
Ïy”
 
	$make_logi¡ic_Ïy”
(
b©ch
, 
šputs
)

14 
	`årštf
(
¡d”r
, "logi¡iøxƒÁrİy %4d\n", 
šputs
);

15 
Ïy”
 
l
 = {0};

16 
l
.
ty³
 = 
LOGXENT
;

17 
l
.
b©ch
 = batch;

18 
l
.
šputs
 = inputs;

19 
l
.
ouuts
 = 
šputs
;

20 
l
.
loss
 = 
	`ÿÎoc
(
šputs
*
b©ch
, ());

21 
l
.
ouut
 = 
	`ÿÎoc
(
šputs
*
b©ch
, ());

22 
l
.
d–
 = 
	`ÿÎoc
(
šputs
*
b©ch
, ());

23 
l
.
co¡
 = 
	`ÿÎoc
(1, ());

25 
l
.
fÜw¬d
 = 
fÜw¬d_logi¡ic_Ïy”
;

26 
l
.
backw¬d
 = 
backw¬d_logi¡ic_Ïy”
;

27 #ifdeà
GPU


28 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_logi¡ic_Ïy”_gpu
;

29 
l
.
backw¬d_gpu
 = 
backw¬d_logi¡ic_Ïy”_gpu
;

31 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
, 
šputs
*
b©ch
);

32 
l
.
loss_gpu
 = 
	`cuda_make_¬¿y
Ö.
loss
, 
šputs
*
b©ch
);

33 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
, 
šputs
*
b©ch
);

35  
l
;

36 
	}
}

38 
	$fÜw¬d_logi¡ic_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

40 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
, 
Ãt
.
šput
, 1,†.
ouut
, 1);

41 
	`aùiv©e_¬¿y
(
l
.
ouut
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

43 if(
Ãt
.
Œuth
){

44 
	`logi¡ic_x_’t_ıu
(
l
.
b©ch
*l.
šputs
,†.
ouut
, 
Ãt
.
Œuth
,†.
d–
,†.
loss
);

45 
i
;

46 
n
 = 
l
.
b©ch
*l.
šputs
;

47 
i
 = 0; i < 
n
; ++i){

55 
l
.
co¡
[0] =†.
loss
[0];

56 
	`´štf
("my co¡ i %à\n", (
l
.
loss
[0]));

59 
	}
}

61 
	$backw¬d_logi¡ic_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

63 
	`axpy_ıu
(
l
.
šputs
*l.
b©ch
, 1,†.
d–
, 1, 
Ãt
.delta, 1);

64 
	}
}

66 #ifdeà
GPU


68 
	$fÜw¬d_logi¡ic_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

70 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
Ãt
.
šput_gpu
, 1,†.
ouut_gpu
, 1);

71 
	`aùiv©e_¬¿y_gpu
(
l
.
ouut_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

72 if(
Ãt
.
Œuth
){

73 
	`logi¡ic_x_’t_gpu
(
l
.
b©ch
*l.
šputs
,†.
ouut_gpu
, 
Ãt
.
Œuth_gpu
,†.
d–_gpu
,†.
loss_gpu
,†.
loss_gpu_‹mp
);

74 
	`cuda_puÎ_¬¿y
(
l
.
loss_gpu
,†.
loss
,†.
b©ch
*l.
šputs
);

78 
	}
}

80 
	$backw¬d_logi¡ic_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

82 
	`axpy_gpu
(
l
.
b©ch
*l.
šputs
, 1,†.
d–_gpu
, 1, 
Ãt
.delta_gpu, 1);

83 
	}
}

	@logistic_layer.h

1 #iâdeà
LOGISTIC_LAYER_H


2 
	#LOGISTIC_LAYER_H


	)

3 
	~"Ïy”.h
"

4 
	~"ÃtwÜk.h
"

6 
Ïy”
 
make_logi¡ic_Ïy”
(
b©ch
, 
šputs
);

7 
fÜw¬d_logi¡ic_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

8 
backw¬d_logi¡ic_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

10 #ifdeà
GPU


11 
fÜw¬d_logi¡ic_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

12 
backw¬d_logi¡ic_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

	@lstm_layer.c

1 
	~"l¡m_Ïy”.h
"

2 
	~"cÚÃùed_Ïy”.h
"

3 
	~"uts.h
"

4 
	~"cuda.h
"

5 
	~"bÏs.h
"

6 
	~"gemm.h
"

8 
	~<m©h.h
>

9 
	~<¡dio.h
>

10 
	~<¡dlib.h
>

11 
	~<¡ršg.h
>

13 
	$šüem’t_Ïy”
(
Ïy”
 *
l
, 
¡•s
)

15 
num
 = 
l
->
ouuts
*l->
b©ch
*
¡•s
;

16 
l
->
ouut
 +ğ
num
;

17 
l
->
d–
 +ğ
num
;

18 
l
->
x
 +ğ
num
;

19 
l
->
x_nÜm
 +ğ
num
;

21 #ifdeà
GPU


22 
l
->
ouut_gpu
 +ğ
num
;

23 
l
->
d–_gpu
 +ğ
num
;

24 
l
->
x_gpu
 +ğ
num
;

25 
l
->
x_nÜm_gpu
 +ğ
num
;

27 
	}
}

29 
Ïy”
 
	$make_l¡m_Ïy”
(
b©ch
, 
šputs
, 
ouuts
, 
¡•s
, 
b©ch_nÜm®ize
, 
adam
)

31 
	`årštf
(
¡d”r
, "LSTM Lay”: %d iÅuts, %d ouuts\n", 
šputs
, 
ouuts
);

32 
b©ch
 = b©ch / 
¡•s
;

33 
Ïy”
 
l
 = { 0 };

34 
l
.
b©ch
 = batch;

35 
l
.
ty³
 = 
LSTM
;

36 
l
.
¡•s
 = steps;

37 
l
.
šputs
 = inputs;

39 
l
.
uf
 = 
	`m®loc
((
Ïy”
));

40 
	`årštf
(
¡d”r
, "\t\t");

41 *(
l
.
uf
èğ
	`make_cÚÃùed_Ïy”
(
b©ch
*
¡•s
, 
šputs
, 
ouuts
, 
LINEAR
, 
b©ch_nÜm®ize
, 
adam
);

42 
l
.
uf
->
b©ch
 = batch;

44 
l
.
ui
 = 
	`m®loc
((
Ïy”
));

45 
	`årštf
(
¡d”r
, "\t\t");

46 *(
l
.
ui
èğ
	`make_cÚÃùed_Ïy”
(
b©ch
*
¡•s
, 
šputs
, 
ouuts
, 
LINEAR
, 
b©ch_nÜm®ize
, 
adam
);

47 
l
.
ui
->
b©ch
 = batch;

49 
l
.
ug
 = 
	`m®loc
((
Ïy”
));

50 
	`årštf
(
¡d”r
, "\t\t");

51 *(
l
.
ug
èğ
	`make_cÚÃùed_Ïy”
(
b©ch
*
¡•s
, 
šputs
, 
ouuts
, 
LINEAR
, 
b©ch_nÜm®ize
, 
adam
);

52 
l
.
ug
->
b©ch
 = batch;

54 
l
.
uo
 = 
	`m®loc
((
Ïy”
));

55 
	`årštf
(
¡d”r
, "\t\t");

56 *(
l
.
uo
èğ
	`make_cÚÃùed_Ïy”
(
b©ch
*
¡•s
, 
šputs
, 
ouuts
, 
LINEAR
, 
b©ch_nÜm®ize
, 
adam
);

57 
l
.
uo
->
b©ch
 = batch;

59 
l
.
wf
 = 
	`m®loc
((
Ïy”
));

60 
	`årštf
(
¡d”r
, "\t\t");

61 *(
l
.
wf
èğ
	`make_cÚÃùed_Ïy”
(
b©ch
*
¡•s
, 
ouuts
, ouuts, 
LINEAR
, 
b©ch_nÜm®ize
, 
adam
);

62 
l
.
wf
->
b©ch
 = batch;

64 
l
.
wi
 = 
	`m®loc
((
Ïy”
));

65 
	`årštf
(
¡d”r
, "\t\t");

66 *(
l
.
wi
èğ
	`make_cÚÃùed_Ïy”
(
b©ch
*
¡•s
, 
ouuts
, ouuts, 
LINEAR
, 
b©ch_nÜm®ize
, 
adam
);

67 
l
.
wi
->
b©ch
 = batch;

69 
l
.
wg
 = 
	`m®loc
((
Ïy”
));

70 
	`årštf
(
¡d”r
, "\t\t");

71 *(
l
.
wg
èğ
	`make_cÚÃùed_Ïy”
(
b©ch
*
¡•s
, 
ouuts
, ouuts, 
LINEAR
, 
b©ch_nÜm®ize
, 
adam
);

72 
l
.
wg
->
b©ch
 = batch;

74 
l
.
wo
 = 
	`m®loc
((
Ïy”
));

75 
	`årštf
(
¡d”r
, "\t\t");

76 *(
l
.
wo
èğ
	`make_cÚÃùed_Ïy”
(
b©ch
*
¡•s
, 
ouuts
, ouuts, 
LINEAR
, 
b©ch_nÜm®ize
, 
adam
);

77 
l
.
wo
->
b©ch
 = batch;

79 
l
.
b©ch_nÜm®ize
 = batch_normalize;

80 
l
.
ouuts
 = outputs;

82 
l
.
ouut
 = 
	`ÿÎoc
(
ouuts
*
b©ch
*
¡•s
, ());

83 
l
.
¡©e
 = 
	`ÿÎoc
(
ouuts
*
b©ch
, ());

85 
l
.
fÜw¬d
 = 
fÜw¬d_l¡m_Ïy”
;

86 
l
.
upd©e
 = 
upd©e_l¡m_Ïy”
;

88 
l
.
´ev_¡©e_ıu
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

89 
l
.
´ev_ûÎ_ıu
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

90 
l
.
ûÎ_ıu
 = 
	`ÿÎoc
(
b©ch
*
ouuts
*
¡•s
, ());

92 
l
.
f_ıu
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

93 
l
.
i_ıu
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

94 
l
.
g_ıu
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

95 
l
.
o_ıu
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

96 
l
.
c_ıu
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

97 
l
.
h_ıu
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

98 
l
.
‹mp_ıu
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

99 
l
.
‹mp2_ıu
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

100 
l
.
‹mp3_ıu
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

101 
l
.
dc_ıu
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

102 
l
.
dh_ıu
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

104 #ifdeà
GPU


105 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_l¡m_Ïy”_gpu
;

106 
l
.
backw¬d_gpu
 = 
backw¬d_l¡m_Ïy”_gpu
;

107 
l
.
upd©e_gpu
 = 
upd©e_l¡m_Ïy”_gpu
;

109 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
*
¡•s
);

110 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*l.
ouuts
*
¡•s
);

112 
l
.
´ev_¡©e_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

113 
l
.
´ev_ûÎ_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

114 
l
.
ûÎ_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
*
¡•s
);

116 
l
.
f_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

117 
l
.
i_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

118 
l
.
g_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

119 
l
.
o_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

120 
l
.
c_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

121 
l
.
h_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

122 
l
.
‹mp_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

123 
l
.
‹mp2_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

124 
l
.
‹mp3_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

125 
l
.
dc_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

126 
l
.
dh_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

127 #ifdeà
CUDNN


128 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
wf
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 
b©ch
,†.wf->
out_c
,†.wf->
out_h
,†.wf->
out_w
);

129 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
wi
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 
b©ch
,†.wi->
out_c
,†.wi->
out_h
,†.wi->
out_w
);

130 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
wg
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 
b©ch
,†.wg->
out_c
,†.wg->
out_h
,†.wg->
out_w
);

131 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
wo
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 
b©ch
,†.wo->
out_c
,†.wo->
out_h
,†.wo->
out_w
);

133 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
uf
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 
b©ch
,†.uf->
out_c
,†.uf->
out_h
,†.uf->
out_w
);

134 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
ui
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 
b©ch
,†.ui->
out_c
,†.ui->
out_h
,†.ui->
out_w
);

135 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
ug
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 
b©ch
,†.ug->
out_c
,†.ug->
out_h
,†.ug->
out_w
);

136 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
uo
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 
b©ch
,†.uo->
out_c
,†.uo->
out_h
,†.uo->
out_w
);

141  
l
;

142 
	}
}

144 
	$upd©e_l¡m_Ïy”
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
)

146 
	`upd©e_cÚÃùed_Ïy”
(*(
l
.
wf
), 
a
);

147 
	`upd©e_cÚÃùed_Ïy”
(*(
l
.
wi
), 
a
);

148 
	`upd©e_cÚÃùed_Ïy”
(*(
l
.
wg
), 
a
);

149 
	`upd©e_cÚÃùed_Ïy”
(*(
l
.
wo
), 
a
);

150 
	`upd©e_cÚÃùed_Ïy”
(*(
l
.
uf
), 
a
);

151 
	`upd©e_cÚÃùed_Ïy”
(*(
l
.
ui
), 
a
);

152 
	`upd©e_cÚÃùed_Ïy”
(*(
l
.
ug
), 
a
);

153 
	`upd©e_cÚÃùed_Ïy”
(*(
l
.
uo
), 
a
);

154 
	}
}

156 
	$fÜw¬d_l¡m_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
¡©e
)

158 
ÃtwÜk
 
s
 = { 0 };

159 
s
.
Œaš
 = 
¡©e
.train;

160 
i
;

161 
Ïy”
 
wf
 = *(
l
.wf);

162 
Ïy”
 
wi
 = *(
l
.wi);

163 
Ïy”
 
wg
 = *(
l
.wg);

164 
Ïy”
 
wo
 = *(
l
.wo);

166 
Ïy”
 
uf
 = *(
l
.uf);

167 
Ïy”
 
ui
 = *(
l
.ui);

168 
Ïy”
 
ug
 = *(
l
.ug);

169 
Ïy”
 
uo
 = *(
l
.uo);

171 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
wf
.
d–
, 1);

172 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
wi
.
d–
, 1);

173 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
wg
.
d–
, 1);

174 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
wo
.
d–
, 1);

176 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
uf
.
d–
, 1);

177 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
ui
.
d–
, 1);

178 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
ug
.
d–
, 1);

179 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
uo
.
d–
, 1);

180 ià(
¡©e
.
Œaš
) {

181 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0,†.
d–
, 1);

184 
i
 = 0; i < 
l
.
¡•s
; ++i) {

185 
s
.
šput
 = 
l
.
h_ıu
;

186 
	`fÜw¬d_cÚÃùed_Ïy”
(
wf
, 
s
);

187 
	`fÜw¬d_cÚÃùed_Ïy”
(
wi
, 
s
);

188 
	`fÜw¬d_cÚÃùed_Ïy”
(
wg
, 
s
);

189 
	`fÜw¬d_cÚÃùed_Ïy”
(
wo
, 
s
);

191 
s
.
šput
 = 
¡©e
.input;

192 
	`fÜw¬d_cÚÃùed_Ïy”
(
uf
, 
s
);

193 
	`fÜw¬d_cÚÃùed_Ïy”
(
ui
, 
s
);

194 
	`fÜw¬d_cÚÃùed_Ïy”
(
ug
, 
s
);

195 
	`fÜw¬d_cÚÃùed_Ïy”
(
uo
, 
s
);

197 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
, 
wf
.
ouut
, 1,†.
f_ıu
, 1);

198 
	`axpy_ıu
(
l
.
ouuts
*l.
b©ch
, 1, 
uf
.
ouut
, 1,†.
f_ıu
, 1);

200 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
, 
wi
.
ouut
, 1,†.
i_ıu
, 1);

201 
	`axpy_ıu
(
l
.
ouuts
*l.
b©ch
, 1, 
ui
.
ouut
, 1,†.
i_ıu
, 1);

203 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
, 
wg
.
ouut
, 1,†.
g_ıu
, 1);

204 
	`axpy_ıu
(
l
.
ouuts
*l.
b©ch
, 1, 
ug
.
ouut
, 1,†.
g_ıu
, 1);

206 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
, 
wo
.
ouut
, 1,†.
o_ıu
, 1);

207 
	`axpy_ıu
(
l
.
ouuts
*l.
b©ch
, 1, 
uo
.
ouut
, 1,†.
o_ıu
, 1);

209 
	`aùiv©e_¬¿y
(
l
.
f_ıu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

210 
	`aùiv©e_¬¿y
(
l
.
i_ıu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

211 
	`aùiv©e_¬¿y
(
l
.
g_ıu
,†.
ouuts
*l.
b©ch
, 
TANH
);

212 
	`aùiv©e_¬¿y
(
l
.
o_ıu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

214 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
i_ıu
, 1,†.
‹mp_ıu
, 1);

215 
	`mul_ıu
(
l
.
ouuts
*l.
b©ch
,†.
g_ıu
, 1,†.
‹mp_ıu
, 1);

216 
	`mul_ıu
(
l
.
ouuts
*l.
b©ch
,†.
f_ıu
, 1,†.
c_ıu
, 1);

217 
	`axpy_ıu
(
l
.
ouuts
*l.
b©ch
, 1,†.
‹mp_ıu
, 1,†.
c_ıu
, 1);

219 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
c_ıu
, 1,†.
h_ıu
, 1);

220 
	`aùiv©e_¬¿y
(
l
.
h_ıu
,†.
ouuts
*l.
b©ch
, 
TANH
);

221 
	`mul_ıu
(
l
.
ouuts
*l.
b©ch
,†.
o_ıu
, 1,†.
h_ıu
, 1);

223 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
c_ıu
, 1,†.
ûÎ_ıu
, 1);

224 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
h_ıu
, 1,†.
ouut
, 1);

226 
¡©e
.
šput
 +ğ
l
.
šputs
*l.
b©ch
;

227 
l
.
ouut
 +ğl.
ouuts
*l.
b©ch
;

228 
l
.
ûÎ_ıu
 +ğl.
ouuts
*l.
b©ch
;

230 
	`šüem’t_Ïy”
(&
wf
, 1);

231 
	`šüem’t_Ïy”
(&
wi
, 1);

232 
	`šüem’t_Ïy”
(&
wg
, 1);

233 
	`šüem’t_Ïy”
(&
wo
, 1);

235 
	`šüem’t_Ïy”
(&
uf
, 1);

236 
	`šüem’t_Ïy”
(&
ui
, 1);

237 
	`šüem’t_Ïy”
(&
ug
, 1);

238 
	`šüem’t_Ïy”
(&
uo
, 1);

240 
	}
}

242 
	$backw¬d_l¡m_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
¡©e
)

244 
ÃtwÜk
 
s
 = { 0 };

245 
s
.
Œaš
 = 
¡©e
.train;

246 
i
;

247 
Ïy”
 
wf
 = *(
l
.wf);

248 
Ïy”
 
wi
 = *(
l
.wi);

249 
Ïy”
 
wg
 = *(
l
.wg);

250 
Ïy”
 
wo
 = *(
l
.wo);

252 
Ïy”
 
uf
 = *(
l
.uf);

253 
Ïy”
 
ui
 = *(
l
.ui);

254 
Ïy”
 
ug
 = *(
l
.ug);

255 
Ïy”
 
uo
 = *(
l
.uo);

257 
	`šüem’t_Ïy”
(&
wf
, 
l
.
¡•s
 - 1);

258 
	`šüem’t_Ïy”
(&
wi
, 
l
.
¡•s
 - 1);

259 
	`šüem’t_Ïy”
(&
wg
, 
l
.
¡•s
 - 1);

260 
	`šüem’t_Ïy”
(&
wo
, 
l
.
¡•s
 - 1);

262 
	`šüem’t_Ïy”
(&
uf
, 
l
.
¡•s
 - 1);

263 
	`šüem’t_Ïy”
(&
ui
, 
l
.
¡•s
 - 1);

264 
	`šüem’t_Ïy”
(&
ug
, 
l
.
¡•s
 - 1);

265 
	`šüem’t_Ïy”
(&
uo
, 
l
.
¡•s
 - 1);

267 
¡©e
.
šput
 +ğ
l
.
šputs
*l.
b©ch
*Ö.
¡•s
 - 1);

268 ià(
¡©e
.
d–
è¡©e.d– +ğ
l
.
šputs
*l.
b©ch
*Ö.
¡•s
 - 1);

270 
l
.
ouut
 +ğl.
ouuts
*l.
b©ch
*Ö.
¡•s
 - 1);

271 
l
.
ûÎ_ıu
 +ğl.
ouuts
*l.
b©ch
*Ö.
¡•s
 - 1);

272 
l
.
d–
 +ğl.
ouuts
*l.
b©ch
*Ö.
¡•s
 - 1);

274 
i
 = 
l
.
¡•s
 - 1; i >= 0; --i) {

275 ià(
i
 !ğ0è
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
ûÎ_ıu
 -†.ouuts*l.b©ch, 1,†.
´ev_ûÎ_ıu
, 1);

276 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
ûÎ_ıu
, 1,†.
c_ıu
, 1);

277 ià(
i
 !ğ0è
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
ouut
 -†.ouuts*l.b©ch, 1,†.
´ev_¡©e_ıu
, 1);

278 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
ouut
, 1,†.
h_ıu
, 1);

280 
l
.
dh_ıu
 = (
i
 =ğ0è? 0 :†.
d–
 -†.
ouuts
*l.
b©ch
;

282 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
, 
wf
.
ouut
, 1,†.
f_ıu
, 1);

283 
	`axpy_ıu
(
l
.
ouuts
*l.
b©ch
, 1, 
uf
.
ouut
, 1,†.
f_ıu
, 1);

285 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
, 
wi
.
ouut
, 1,†.
i_ıu
, 1);

286 
	`axpy_ıu
(
l
.
ouuts
*l.
b©ch
, 1, 
ui
.
ouut
, 1,†.
i_ıu
, 1);

288 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
, 
wg
.
ouut
, 1,†.
g_ıu
, 1);

289 
	`axpy_ıu
(
l
.
ouuts
*l.
b©ch
, 1, 
ug
.
ouut
, 1,†.
g_ıu
, 1);

291 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
, 
wo
.
ouut
, 1,†.
o_ıu
, 1);

292 
	`axpy_ıu
(
l
.
ouuts
*l.
b©ch
, 1, 
uo
.
ouut
, 1,†.
o_ıu
, 1);

294 
	`aùiv©e_¬¿y
(
l
.
f_ıu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

295 
	`aùiv©e_¬¿y
(
l
.
i_ıu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

296 
	`aùiv©e_¬¿y
(
l
.
g_ıu
,†.
ouuts
*l.
b©ch
, 
TANH
);

297 
	`aùiv©e_¬¿y
(
l
.
o_ıu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

299 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
d–
, 1,†.
‹mp3_ıu
, 1);

301 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
c_ıu
, 1,†.
‹mp_ıu
, 1);

302 
	`aùiv©e_¬¿y
(
l
.
‹mp_ıu
,†.
ouuts
*l.
b©ch
, 
TANH
);

304 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp3_ıu
, 1,†.
‹mp2_ıu
, 1);

305 
	`mul_ıu
(
l
.
ouuts
*l.
b©ch
,†.
o_ıu
, 1,†.
‹mp2_ıu
, 1);

307 
	`g¿d›Á_¬¿y
(
l
.
‹mp_ıu
,†.
ouuts
*l.
b©ch
, 
TANH
,†.
‹mp2_ıu
);

308 
	`axpy_ıu
(
l
.
ouuts
*l.
b©ch
, 1,†.
dc_ıu
, 1,†.
‹mp2_ıu
, 1);

310 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
c_ıu
, 1,†.
‹mp_ıu
, 1);

311 
	`aùiv©e_¬¿y
(
l
.
‹mp_ıu
,†.
ouuts
*l.
b©ch
, 
TANH
);

312 
	`mul_ıu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp3_ıu
, 1,†.
‹mp_ıu
, 1);

313 
	`g¿d›Á_¬¿y
(
l
.
o_ıu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
,†.
‹mp_ıu
);

314 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_ıu
, 1, 
wo
.
d–
, 1);

315 
s
.
šput
 = 
l
.
´ev_¡©e_ıu
;

316 
s
.
d–
 = 
l
.
dh_ıu
;

317 
	`backw¬d_cÚÃùed_Ïy”
(
wo
, 
s
);

319 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_ıu
, 1, 
uo
.
d–
, 1);

320 
s
.
šput
 = 
¡©e
.input;

321 
s
.
d–
 = 
¡©e
.delta;

322 
	`backw¬d_cÚÃùed_Ïy”
(
uo
, 
s
);

324 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp2_ıu
, 1,†.
‹mp_ıu
, 1);

325 
	`mul_ıu
(
l
.
ouuts
*l.
b©ch
,†.
i_ıu
, 1,†.
‹mp_ıu
, 1);

326 
	`g¿d›Á_¬¿y
(
l
.
g_ıu
,†.
ouuts
*l.
b©ch
, 
TANH
,†.
‹mp_ıu
);

327 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_ıu
, 1, 
wg
.
d–
, 1);

328 
s
.
šput
 = 
l
.
´ev_¡©e_ıu
;

329 
s
.
d–
 = 
l
.
dh_ıu
;

330 
	`backw¬d_cÚÃùed_Ïy”
(
wg
, 
s
);

332 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_ıu
, 1, 
ug
.
d–
, 1);

333 
s
.
šput
 = 
¡©e
.input;

334 
s
.
d–
 = 
¡©e
.delta;

335 
	`backw¬d_cÚÃùed_Ïy”
(
ug
, 
s
);

337 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp2_ıu
, 1,†.
‹mp_ıu
, 1);

338 
	`mul_ıu
(
l
.
ouuts
*l.
b©ch
,†.
g_ıu
, 1,†.
‹mp_ıu
, 1);

339 
	`g¿d›Á_¬¿y
(
l
.
i_ıu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
,†.
‹mp_ıu
);

340 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_ıu
, 1, 
wi
.
d–
, 1);

341 
s
.
šput
 = 
l
.
´ev_¡©e_ıu
;

342 
s
.
d–
 = 
l
.
dh_ıu
;

343 
	`backw¬d_cÚÃùed_Ïy”
(
wi
, 
s
);

345 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_ıu
, 1, 
ui
.
d–
, 1);

346 
s
.
šput
 = 
¡©e
.input;

347 
s
.
d–
 = 
¡©e
.delta;

348 
	`backw¬d_cÚÃùed_Ïy”
(
ui
, 
s
);

350 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp2_ıu
, 1,†.
‹mp_ıu
, 1);

351 
	`mul_ıu
(
l
.
ouuts
*l.
b©ch
,†.
´ev_ûÎ_ıu
, 1,†.
‹mp_ıu
, 1);

352 
	`g¿d›Á_¬¿y
(
l
.
f_ıu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
,†.
‹mp_ıu
);

353 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_ıu
, 1, 
wf
.
d–
, 1);

354 
s
.
šput
 = 
l
.
´ev_¡©e_ıu
;

355 
s
.
d–
 = 
l
.
dh_ıu
;

356 
	`backw¬d_cÚÃùed_Ïy”
(
wf
, 
s
);

358 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_ıu
, 1, 
uf
.
d–
, 1);

359 
s
.
šput
 = 
¡©e
.input;

360 
s
.
d–
 = 
¡©e
.delta;

361 
	`backw¬d_cÚÃùed_Ïy”
(
uf
, 
s
);

363 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp2_ıu
, 1,†.
‹mp_ıu
, 1);

364 
	`mul_ıu
(
l
.
ouuts
*l.
b©ch
,†.
f_ıu
, 1,†.
‹mp_ıu
, 1);

365 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_ıu
, 1,†.
dc_ıu
, 1);

367 
¡©e
.
šput
 -ğ
l
.
šputs
*l.
b©ch
;

368 ià(
¡©e
.
d–
è¡©e.d– -ğ
l
.
šputs
*l.
b©ch
;

369 
l
.
ouut
 -ğl.
ouuts
*l.
b©ch
;

370 
l
.
ûÎ_ıu
 -ğl.
ouuts
*l.
b©ch
;

371 
l
.
d–
 -ğl.
ouuts
*l.
b©ch
;

373 
	`šüem’t_Ïy”
(&
wf
, -1);

374 
	`šüem’t_Ïy”
(&
wi
, -1);

375 
	`šüem’t_Ïy”
(&
wg
, -1);

376 
	`šüem’t_Ïy”
(&
wo
, -1);

378 
	`šüem’t_Ïy”
(&
uf
, -1);

379 
	`šüem’t_Ïy”
(&
ui
, -1);

380 
	`šüem’t_Ïy”
(&
ug
, -1);

381 
	`šüem’t_Ïy”
(&
uo
, -1);

383 
	}
}

385 #ifdeà
GPU


386 
	$upd©e_l¡m_Ïy”_gpu
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
)

388 
	`upd©e_cÚÃùed_Ïy”_gpu
(*(
l
.
wf
), 
a
);

389 
	`upd©e_cÚÃùed_Ïy”_gpu
(*(
l
.
wi
), 
a
);

390 
	`upd©e_cÚÃùed_Ïy”_gpu
(*(
l
.
wg
), 
a
);

391 
	`upd©e_cÚÃùed_Ïy”_gpu
(*(
l
.
wo
), 
a
);

392 
	`upd©e_cÚÃùed_Ïy”_gpu
(*(
l
.
uf
), 
a
);

393 
	`upd©e_cÚÃùed_Ïy”_gpu
(*(
l
.
ui
), 
a
);

394 
	`upd©e_cÚÃùed_Ïy”_gpu
(*(
l
.
ug
), 
a
);

395 
	`upd©e_cÚÃùed_Ïy”_gpu
(*(
l
.
uo
), 
a
);

396 
	}
}

398 
	$fÜw¬d_l¡m_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
¡©e
)

400 
ÃtwÜk
 
s
 = { 0 };

401 
s
.
Œaš
 = 
¡©e
.train;

402 
i
;

403 
Ïy”
 
wf
 = *(
l
.wf);

404 
Ïy”
 
wi
 = *(
l
.wi);

405 
Ïy”
 
wg
 = *(
l
.wg);

406 
Ïy”
 
wo
 = *(
l
.wo);

408 
Ïy”
 
uf
 = *(
l
.uf);

409 
Ïy”
 
ui
 = *(
l
.ui);

410 
Ïy”
 
ug
 = *(
l
.ug);

411 
Ïy”
 
uo
 = *(
l
.uo);

413 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
wf
.
d–_gpu
, 1);

414 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
wi
.
d–_gpu
, 1);

415 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
wg
.
d–_gpu
, 1);

416 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
wo
.
d–_gpu
, 1);

418 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
uf
.
d–_gpu
, 1);

419 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
ui
.
d–_gpu
, 1);

420 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
ug
.
d–_gpu
, 1);

421 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
uo
.
d–_gpu
, 1);

422 ià(
¡©e
.
Œaš
) {

423 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0,†.
d–_gpu
, 1);

426 
i
 = 0; i < 
l
.
¡•s
; ++i) {

427 
s
.
šput_gpu
 = 
l
.
h_gpu
;

428 
	`fÜw¬d_cÚÃùed_Ïy”_gpu
(
wf
, 
s
);

429 
	`fÜw¬d_cÚÃùed_Ïy”_gpu
(
wi
, 
s
);

430 
	`fÜw¬d_cÚÃùed_Ïy”_gpu
(
wg
, 
s
);

431 
	`fÜw¬d_cÚÃùed_Ïy”_gpu
(
wo
, 
s
);

433 
s
.
šput_gpu
 = 
¡©e
.input_gpu;

434 
	`fÜw¬d_cÚÃùed_Ïy”_gpu
(
uf
, 
s
);

435 
	`fÜw¬d_cÚÃùed_Ïy”_gpu
(
ui
, 
s
);

436 
	`fÜw¬d_cÚÃùed_Ïy”_gpu
(
ug
, 
s
);

437 
	`fÜw¬d_cÚÃùed_Ïy”_gpu
(
uo
, 
s
);

439 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
wf
.
ouut_gpu
, 1,†.
f_gpu
, 1);

440 
	`axpy_gpu
(
l
.
ouuts
*l.
b©ch
, 1, 
uf
.
ouut_gpu
, 1,†.
f_gpu
, 1);

442 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
wi
.
ouut_gpu
, 1,†.
i_gpu
, 1);

443 
	`axpy_gpu
(
l
.
ouuts
*l.
b©ch
, 1, 
ui
.
ouut_gpu
, 1,†.
i_gpu
, 1);

445 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
wg
.
ouut_gpu
, 1,†.
g_gpu
, 1);

446 
	`axpy_gpu
(
l
.
ouuts
*l.
b©ch
, 1, 
ug
.
ouut_gpu
, 1,†.
g_gpu
, 1);

448 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
wo
.
ouut_gpu
, 1,†.
o_gpu
, 1);

449 
	`axpy_gpu
(
l
.
ouuts
*l.
b©ch
, 1, 
uo
.
ouut_gpu
, 1,†.
o_gpu
, 1);

451 
	`aùiv©e_¬¿y_gpu
(
l
.
f_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

452 
	`aùiv©e_¬¿y_gpu
(
l
.
i_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

453 
	`aùiv©e_¬¿y_gpu
(
l
.
g_gpu
,†.
ouuts
*l.
b©ch
, 
TANH
);

454 
	`aùiv©e_¬¿y_gpu
(
l
.
o_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

456 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
i_gpu
, 1,†.
‹mp_gpu
, 1);

457 
	`mul_gpu
(
l
.
ouuts
*l.
b©ch
,†.
g_gpu
, 1,†.
‹mp_gpu
, 1);

458 
	`mul_gpu
(
l
.
ouuts
*l.
b©ch
,†.
f_gpu
, 1,†.
c_gpu
, 1);

459 
	`axpy_gpu
(
l
.
ouuts
*l.
b©ch
, 1,†.
‹mp_gpu
, 1,†.
c_gpu
, 1);

461 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
c_gpu
, 1,†.
h_gpu
, 1);

462 
	`aùiv©e_¬¿y_gpu
(
l
.
h_gpu
,†.
ouuts
*l.
b©ch
, 
TANH
);

463 
	`mul_gpu
(
l
.
ouuts
*l.
b©ch
,†.
o_gpu
, 1,†.
h_gpu
, 1);

465 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
c_gpu
, 1,†.
ûÎ_gpu
, 1);

466 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
h_gpu
, 1,†.
ouut_gpu
, 1);

468 
¡©e
.
šput_gpu
 +ğ
l
.
šputs
*l.
b©ch
;

469 
l
.
ouut_gpu
 +ğl.
ouuts
*l.
b©ch
;

470 
l
.
ûÎ_gpu
 +ğl.
ouuts
*l.
b©ch
;

472 
	`šüem’t_Ïy”
(&
wf
, 1);

473 
	`šüem’t_Ïy”
(&
wi
, 1);

474 
	`šüem’t_Ïy”
(&
wg
, 1);

475 
	`šüem’t_Ïy”
(&
wo
, 1);

477 
	`šüem’t_Ïy”
(&
uf
, 1);

478 
	`šüem’t_Ïy”
(&
ui
, 1);

479 
	`šüem’t_Ïy”
(&
ug
, 1);

480 
	`šüem’t_Ïy”
(&
uo
, 1);

482 
	}
}

484 
	$backw¬d_l¡m_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
¡©e
)

486 
ÃtwÜk
 
s
 = { 0 };

487 
s
.
Œaš
 = 
¡©e
.train;

488 
i
;

489 
Ïy”
 
wf
 = *(
l
.wf);

490 
Ïy”
 
wi
 = *(
l
.wi);

491 
Ïy”
 
wg
 = *(
l
.wg);

492 
Ïy”
 
wo
 = *(
l
.wo);

494 
Ïy”
 
uf
 = *(
l
.uf);

495 
Ïy”
 
ui
 = *(
l
.ui);

496 
Ïy”
 
ug
 = *(
l
.ug);

497 
Ïy”
 
uo
 = *(
l
.uo);

499 
	`šüem’t_Ïy”
(&
wf
, 
l
.
¡•s
 - 1);

500 
	`šüem’t_Ïy”
(&
wi
, 
l
.
¡•s
 - 1);

501 
	`šüem’t_Ïy”
(&
wg
, 
l
.
¡•s
 - 1);

502 
	`šüem’t_Ïy”
(&
wo
, 
l
.
¡•s
 - 1);

504 
	`šüem’t_Ïy”
(&
uf
, 
l
.
¡•s
 - 1);

505 
	`šüem’t_Ïy”
(&
ui
, 
l
.
¡•s
 - 1);

506 
	`šüem’t_Ïy”
(&
ug
, 
l
.
¡•s
 - 1);

507 
	`šüem’t_Ïy”
(&
uo
, 
l
.
¡•s
 - 1);

509 
¡©e
.
šput_gpu
 +ğ
l
.
šputs
*l.
b©ch
*Ö.
¡•s
 - 1);

510 ià(
¡©e
.
d–_gpu
è¡©e.d–_gpu +ğ
l
.
šputs
*l.
b©ch
*Ö.
¡•s
 - 1);

512 
l
.
ouut_gpu
 +ğl.
ouuts
*l.
b©ch
*Ö.
¡•s
 - 1);

513 
l
.
ûÎ_gpu
 +ğl.
ouuts
*l.
b©ch
*Ö.
¡•s
 - 1);

514 
l
.
d–_gpu
 +ğl.
ouuts
*l.
b©ch
*Ö.
¡•s
 - 1);

516 
i
 = 
l
.
¡•s
 - 1; i >= 0; --i) {

517 ià(
i
 !ğ0è
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
ûÎ_gpu
 -†.ouuts*l.b©ch, 1,†.
´ev_ûÎ_gpu
, 1);

518 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
ûÎ_gpu
, 1,†.
c_gpu
, 1);

519 ià(
i
 !ğ0è
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
ouut_gpu
 -†.ouuts*l.b©ch, 1,†.
´ev_¡©e_gpu
, 1);

520 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
ouut_gpu
, 1,†.
h_gpu
, 1);

522 
l
.
dh_gpu
 = (
i
 =ğ0è? 0 :†.
d–_gpu
 -†.
ouuts
*l.
b©ch
;

524 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
wf
.
ouut_gpu
, 1,†.
f_gpu
, 1);

525 
	`axpy_gpu
(
l
.
ouuts
*l.
b©ch
, 1, 
uf
.
ouut_gpu
, 1,†.
f_gpu
, 1);

527 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
wi
.
ouut_gpu
, 1,†.
i_gpu
, 1);

528 
	`axpy_gpu
(
l
.
ouuts
*l.
b©ch
, 1, 
ui
.
ouut_gpu
, 1,†.
i_gpu
, 1);

530 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
wg
.
ouut_gpu
, 1,†.
g_gpu
, 1);

531 
	`axpy_gpu
(
l
.
ouuts
*l.
b©ch
, 1, 
ug
.
ouut_gpu
, 1,†.
g_gpu
, 1);

533 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
wo
.
ouut_gpu
, 1,†.
o_gpu
, 1);

534 
	`axpy_gpu
(
l
.
ouuts
*l.
b©ch
, 1, 
uo
.
ouut_gpu
, 1,†.
o_gpu
, 1);

536 
	`aùiv©e_¬¿y_gpu
(
l
.
f_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

537 
	`aùiv©e_¬¿y_gpu
(
l
.
i_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

538 
	`aùiv©e_¬¿y_gpu
(
l
.
g_gpu
,†.
ouuts
*l.
b©ch
, 
TANH
);

539 
	`aùiv©e_¬¿y_gpu
(
l
.
o_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
);

541 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
d–_gpu
, 1,†.
‹mp3_gpu
, 1);

543 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
c_gpu
, 1,†.
‹mp_gpu
, 1);

544 
	`aùiv©e_¬¿y_gpu
(
l
.
‹mp_gpu
,†.
ouuts
*l.
b©ch
, 
TANH
);

546 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp3_gpu
, 1,†.
‹mp2_gpu
, 1);

547 
	`mul_gpu
(
l
.
ouuts
*l.
b©ch
,†.
o_gpu
, 1,†.
‹mp2_gpu
, 1);

549 
	`g¿d›Á_¬¿y_gpu
(
l
.
‹mp_gpu
,†.
ouuts
*l.
b©ch
, 
TANH
,†.
‹mp2_gpu
);

550 
	`axpy_gpu
(
l
.
ouuts
*l.
b©ch
, 1,†.
dc_gpu
, 1,†.
‹mp2_gpu
, 1);

552 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
c_gpu
, 1,†.
‹mp_gpu
, 1);

553 
	`aùiv©e_¬¿y_gpu
(
l
.
‹mp_gpu
,†.
ouuts
*l.
b©ch
, 
TANH
);

554 
	`mul_gpu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp3_gpu
, 1,†.
‹mp_gpu
, 1);

555 
	`g¿d›Á_¬¿y_gpu
(
l
.
o_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
,†.
‹mp_gpu
);

556 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_gpu
, 1, 
wo
.
d–_gpu
, 1);

557 
s
.
šput_gpu
 = 
l
.
´ev_¡©e_gpu
;

558 
s
.
d–_gpu
 = 
l
.
dh_gpu
;

559 
	`backw¬d_cÚÃùed_Ïy”_gpu
(
wo
, 
s
);

561 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_gpu
, 1, 
uo
.
d–_gpu
, 1);

562 
s
.
šput_gpu
 = 
¡©e
.input_gpu;

563 
s
.
d–_gpu
 = 
¡©e
.delta_gpu;

564 
	`backw¬d_cÚÃùed_Ïy”_gpu
(
uo
, 
s
);

566 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp2_gpu
, 1,†.
‹mp_gpu
, 1);

567 
	`mul_gpu
(
l
.
ouuts
*l.
b©ch
,†.
i_gpu
, 1,†.
‹mp_gpu
, 1);

568 
	`g¿d›Á_¬¿y_gpu
(
l
.
g_gpu
,†.
ouuts
*l.
b©ch
, 
TANH
,†.
‹mp_gpu
);

569 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_gpu
, 1, 
wg
.
d–_gpu
, 1);

570 
s
.
šput_gpu
 = 
l
.
´ev_¡©e_gpu
;

571 
s
.
d–_gpu
 = 
l
.
dh_gpu
;

572 
	`backw¬d_cÚÃùed_Ïy”_gpu
(
wg
, 
s
);

574 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_gpu
, 1, 
ug
.
d–_gpu
, 1);

575 
s
.
šput_gpu
 = 
¡©e
.input_gpu;

576 
s
.
d–_gpu
 = 
¡©e
.delta_gpu;

577 
	`backw¬d_cÚÃùed_Ïy”_gpu
(
ug
, 
s
);

579 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp2_gpu
, 1,†.
‹mp_gpu
, 1);

580 
	`mul_gpu
(
l
.
ouuts
*l.
b©ch
,†.
g_gpu
, 1,†.
‹mp_gpu
, 1);

581 
	`g¿d›Á_¬¿y_gpu
(
l
.
i_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
,†.
‹mp_gpu
);

582 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_gpu
, 1, 
wi
.
d–_gpu
, 1);

583 
s
.
šput_gpu
 = 
l
.
´ev_¡©e_gpu
;

584 
s
.
d–_gpu
 = 
l
.
dh_gpu
;

585 
	`backw¬d_cÚÃùed_Ïy”_gpu
(
wi
, 
s
);

587 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_gpu
, 1, 
ui
.
d–_gpu
, 1);

588 
s
.
šput_gpu
 = 
¡©e
.input_gpu;

589 
s
.
d–_gpu
 = 
¡©e
.delta_gpu;

590 
	`backw¬d_cÚÃùed_Ïy”_gpu
(
ui
, 
s
);

592 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp2_gpu
, 1,†.
‹mp_gpu
, 1);

593 
	`mul_gpu
(
l
.
ouuts
*l.
b©ch
,†.
´ev_ûÎ_gpu
, 1,†.
‹mp_gpu
, 1);

594 
	`g¿d›Á_¬¿y_gpu
(
l
.
f_gpu
,†.
ouuts
*l.
b©ch
, 
LOGISTIC
,†.
‹mp_gpu
);

595 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_gpu
, 1, 
wf
.
d–_gpu
, 1);

596 
s
.
šput_gpu
 = 
l
.
´ev_¡©e_gpu
;

597 
s
.
d–_gpu
 = 
l
.
dh_gpu
;

598 
	`backw¬d_cÚÃùed_Ïy”_gpu
(
wf
, 
s
);

600 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_gpu
, 1, 
uf
.
d–_gpu
, 1);

601 
s
.
šput_gpu
 = 
¡©e
.input_gpu;

602 
s
.
d–_gpu
 = 
¡©e
.delta_gpu;

603 
	`backw¬d_cÚÃùed_Ïy”_gpu
(
uf
, 
s
);

605 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp2_gpu
, 1,†.
‹mp_gpu
, 1);

606 
	`mul_gpu
(
l
.
ouuts
*l.
b©ch
,†.
f_gpu
, 1,†.
‹mp_gpu
, 1);

607 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
‹mp_gpu
, 1,†.
dc_gpu
, 1);

609 
¡©e
.
šput_gpu
 -ğ
l
.
šputs
*l.
b©ch
;

610 ià(
¡©e
.
d–_gpu
è¡©e.d–_gpu -ğ
l
.
šputs
*l.
b©ch
;

611 
l
.
ouut_gpu
 -ğl.
ouuts
*l.
b©ch
;

612 
l
.
ûÎ_gpu
 -ğl.
ouuts
*l.
b©ch
;

613 
l
.
d–_gpu
 -ğl.
ouuts
*l.
b©ch
;

615 
	`šüem’t_Ïy”
(&
wf
, -1);

616 
	`šüem’t_Ïy”
(&
wi
, -1);

617 
	`šüem’t_Ïy”
(&
wg
, -1);

618 
	`šüem’t_Ïy”
(&
wo
, -1);

620 
	`šüem’t_Ïy”
(&
uf
, -1);

621 
	`šüem’t_Ïy”
(&
ui
, -1);

622 
	`šüem’t_Ïy”
(&
ug
, -1);

623 
	`šüem’t_Ïy”
(&
uo
, -1);

625 
	}
}

	@lstm_layer.h

1 #iâdeà
LSTM_LAYER_H


2 
	#LSTM_LAYER_H


	)

4 
	~"aùiv©iÚs.h
"

5 
	~"Ïy”.h
"

6 
	~"ÃtwÜk.h
"

7 
	#USET


	)

9 
Ïy”
 
make_l¡m_Ïy”
(
b©ch
, 
šputs
, 
ouuts
, 
¡•s
, 
b©ch_nÜm®ize
, 
adam
);

11 
fÜw¬d_l¡m_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

12 
upd©e_l¡m_Ïy”
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
);

14 #ifdeà
GPU


15 
fÜw¬d_l¡m_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

16 
backw¬d_l¡m_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

17 
upd©e_l¡m_Ïy”_gpu
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
);

	@matrix.c

1 
	~"m©rix.h
"

2 
	~"uts.h
"

3 
	~"bÏs.h
"

4 
	~<¡dio.h
>

5 
	~<¡dlib.h
>

6 
	~<¡ršg.h
>

7 
	~<as£¹.h
>

8 
	~<m©h.h
>

10 
	$ä“_m©rix
(
m©rix
 
m
)

12 
i
;

13 
i
 = 0; i < 
m
.
rows
; ++iè
	`ä“
(m.
v®s
[i]);

14 
	`ä“
(
m
.
v®s
);

15 
	}
}

17 
	$m©rix_tİk_accu¿cy
(
m©rix
 
Œuth
, m©rix 
guess
, 
k
)

19 *
šdexes
 = 
	`ÿÎoc
(
k
, ());

20 
n
 = 
Œuth
.
cŞs
;

21 
i
,
j
;

22 
cÜ»ù
 = 0;

23 
i
 = 0; i < 
Œuth
.
rows
; ++i){

24 
	`tİ_k
(
guess
.
v®s
[
i
], 
n
, 
k
, 
šdexes
);

25 
j
 = 0; j < 
k
; ++j){

26 
şass
 = 
šdexes
[
j
];

27 if(
Œuth
.
v®s
[
i
][
şass
]){

28 ++
cÜ»ù
;

33 
	`ä“
(
šdexes
);

34  ()
cÜ»ù
/
Œuth
.
rows
;

35 
	}
}

37 
	$sÿË_m©rix
(
m©rix
 
m
, 
sÿË
)

39 
i
,
j
;

40 
i
 = 0; i < 
m
.
rows
; ++i){

41 
j
 = 0; j < 
m
.
cŞs
; ++j){

42 
m
.
v®s
[
i
][
j
] *ğ
sÿË
;

45 
	}
}

47 
m©rix
 
	$»size_m©rix
(
m©rix
 
m
, 
size
)

49 
i
;

50 ià(
m
.
rows
 =ğ
size
)  m;

51 ià(
m
.
rows
 < 
size
) {

52 
m
.
v®s
 = 
	`»®loc
(m.v®s, 
size
*(*));

53 
i
 = 
m
.
rows
; i < 
size
; ++i) {

54 
m
.
v®s
[
i
] = 
	`ÿÎoc
(m.
cŞs
, ());

56 } ià(
m
.
rows
 > 
size
) {

57 
i
 = 
size
; i < 
m
.
rows
; ++i) {

58 
	`ä“
(
m
.
v®s
[
i
]);

60 
m
.
v®s
 = 
	`»®loc
(m.v®s, 
size
*(*));

62 
m
.
rows
 = 
size
;

63  
m
;

64 
	}
}

66 
	$m©rix_add_m©rix
(
m©rix
 
äom
, m©rix 
to
)

68 
	`as£¹
(
äom
.
rows
 =ğ
to
.row && from.
cŞs
 ==o.cols);

69 
i
,
j
;

70 
i
 = 0; i < 
äom
.
rows
; ++i){

71 
j
 = 0; j < 
äom
.
cŞs
; ++j){

72 
to
.
v®s
[
i
][
j
] +ğ
äom
.vals[i][j];

75 
	}
}

77 
m©rix
 
	$cİy_m©rix
(
m©rix
 
m
)

79 
m©rix
 
c
 = {0};

80 
c
.
rows
 = 
m
.rows;

81 
c
.
cŞs
 = 
m
.cols;

82 
c
.
v®s
 = 
	`ÿÎoc
(c.
rows
, (*));

83 
i
;

84 
i
 = 0; i < 
c
.
rows
; ++i){

85 
c
.
v®s
[
i
] = 
	`ÿÎoc
(c.
cŞs
, ());

86 
	`cİy_ıu
(
c
.
cŞs
, 
m
.
v®s
[
i
], 1, c.vals[i], 1);

88  
c
;

89 
	}
}

91 
m©rix
 
	$make_m©rix
(
rows
, 
cŞs
)

93 
i
;

94 
m©rix
 
m
;

95 
m
.
rows
 =„ows;

96 
m
.
cŞs
 = cols;

97 
m
.
v®s
 = 
	`ÿÎoc
(m.
rows
, (*));

98 
i
 = 0; i < 
m
.
rows
; ++i){

99 
m
.
v®s
[
i
] = 
	`ÿÎoc
(m.
cŞs
, ());

101  
m
;

102 
	}
}

104 
m©rix
 
	$hŞd_out_m©rix
(
m©rix
 *
m
, 
n
)

106 
i
;

107 
m©rix
 
h
;

108 
h
.
rows
 = 
n
;

109 
h
.
cŞs
 = 
m
->cols;

110 
h
.
v®s
 = 
	`ÿÎoc
(h.
rows
, (*));

111 
i
 = 0; i < 
n
; ++i){

112 
šdex
 = 
	`¿nd
()%
m
->
rows
;

113 
h
.
v®s
[
i
] = 
m
->v®s[
šdex
];

114 
m
->
v®s
[
šdex
] = m->v®s[--(m->
rows
)];

116  
h
;

117 
	}
}

119 *
	$pİ_cŞumn
(
m©rix
 *
m
, 
c
)

121 *
cŞ
 = 
	`ÿÎoc
(
m
->
rows
, ());

122 
i
, 
j
;

123 
i
 = 0; i < 
m
->
rows
; ++i){

124 
cŞ
[
i
] = 
m
->
v®s
[i][
c
];

125 
j
 = 
c
; j < 
m
->
cŞs
-1; ++j){

126 
m
->
v®s
[
i
][
j
] = m->vals[i][j+1];

129 --
m
->
cŞs
;

130  
cŞ
;

131 
	}
}

133 
m©rix
 
	$csv_to_m©rix
(*
f’ame
)

135 
FILE
 *
å
 = 
	`fİ’
(
f’ame
, "r");

136 if(!
å
è
	`fe_”rÜ
(
f’ame
);

138 
m©rix
 
m
;

139 
m
.
cŞs
 = -1;

141 *
lše
;

143 
n
 = 0;

144 
size
 = 1024;

145 
m
.
v®s
 = 
	`ÿÎoc
(
size
, (*));

146 (
lše
 = 
	`fg‘l
(
å
))){

147 if(
m
.
cŞs
 =ğ-1èm.cŞ ğ
	`couÁ_f›lds
(
lše
);

148 if(
n
 =ğ
size
){

149 
size
 *= 2;

150 
m
.
v®s
 = 
	`»®loc
(m.v®s, 
size
*(*));

152 
m
.
v®s
[
n
] = 
	`·r£_f›lds
(
lše
, m.
cŞs
);

153 
	`ä“
(
lše
);

154 ++
n
;

156 
m
.
v®s
 = 
	`»®loc
(m.v®s, 
n
*(*));

157 
m
.
rows
 = 
n
;

158  
m
;

159 
	}
}

161 
	$m©rix_to_csv
(
m©rix
 
m
)

163 
i
, 
j
;

165 
i
 = 0; i < 
m
.
rows
; ++i){

166 
j
 = 0; j < 
m
.
cŞs
; ++j){

167 if(
j
 > 0è
	`´štf
(",");

168 
	`´štf
("%.17g", 
m
.
v®s
[
i
][
j
]);

170 
	`´štf
("\n");

172 
	}
}

174 
	$´št_m©rix
(
m©rix
 
m
)

176 
i
, 
j
;

177 
	`´štf
("%d X %d M©rix:\n",
m
.
rows
, m.
cŞs
);

178 
	`´štf
(" __");

179 
j
 = 0; j < 16*
m
.
cŞs
-1; ++jè
	`´štf
(" ");

180 
	`´štf
("__ \n");

182 
	`´štf
("| ");

183 
j
 = 0; j < 16*
m
.
cŞs
-1; ++jè
	`´štf
(" ");

184 
	`´štf
(" |\n");

186 
i
 = 0; i < 
m
.
rows
; ++i){

187 
	`´štf
("| ");

188 
j
 = 0; j < 
m
.
cŞs
; ++j){

189 
	`´štf
("%15.7à", 
m
.
v®s
[
i
][
j
]);

191 
	`´štf
(" |\n");

193 
	`´štf
("|__");

194 
j
 = 0; j < 16*
m
.
cŞs
-1; ++jè
	`´štf
(" ");

195 
	`´štf
("__|\n");

196 
	}
}

	@matrix.h

1 #iâdeà
MATRIX_H


2 
	#MATRIX_H


	)

3 
	~"d¬kÃt.h
"

5 
m©rix
 
cİy_m©rix
(m©rix 
m
);

6 
´št_m©rix
(
m©rix
 
m
);

8 
m©rix
 
hŞd_out_m©rix
(m©rix *
m
, 
n
);

9 
m©rix
 
»size_m©rix
(m©rix 
m
, 
size
);

11 *
pİ_cŞumn
(
m©rix
 *
m
, 
c
);

	@maxpool_layer.c

1 
	~"maxpoŞ_Ïy”.h
"

2 
	~"cuda.h
"

3 
	~<¡dio.h
>

5 
image
 
	$g‘_maxpoŞ_image
(
maxpoŞ_Ïy”
 
l
)

7 
h
 = 
l
.
out_h
;

8 
w
 = 
l
.
out_w
;

9 
c
 = 
l
.c;

10  
	`æßt_to_image
(
w
,
h
,
c
,
l
.
ouut
);

11 
	}
}

13 
image
 
	$g‘_maxpoŞ_d–
(
maxpoŞ_Ïy”
 
l
)

15 
h
 = 
l
.
out_h
;

16 
w
 = 
l
.
out_w
;

17 
c
 = 
l
.c;

18  
	`æßt_to_image
(
w
,
h
,
c
,
l
.
d–
);

19 
	}
}

21 
maxpoŞ_Ïy”
 
	$make_maxpoŞ_Ïy”
(
b©ch
, 
h
, 
w
, 
c
, 
size
, 
¡ride
, 
·ddšg
)

23 
maxpoŞ_Ïy”
 
l
 = {0};

24 
l
.
ty³
 = 
MAXPOOL
;

25 
l
.
b©ch
 = batch;

26 
l
.
h
 = h;

27 
l
.
w
 = w;

28 
l
.
c
 = c;

29 
l
.
·d
 = 
·ddšg
;

30 
l
.
out_w
 = (
w
 + 2*
·ddšg
)/
¡ride
;

31 
l
.
out_h
 = (
h
 + 2*
·ddšg
)/
¡ride
;

32 
l
.
out_c
 = 
c
;

33 
l
.
ouuts
 =†.
out_h
 *†.
out_w
 *†.
out_c
;

34 
l
.
šputs
 = 
h
*
w
*
c
;

35 
l
.
size
 = size;

36 
l
.
¡ride
 = stride;

37 
ouut_size
 = 
l
.
out_h
 *†.
out_w
 *†.
out_c
 * 
b©ch
;

38 
l
.
šdexes
 = 
	`ÿÎoc
(
ouut_size
, ());

39 
l
.
ouut
 = 
	`ÿÎoc
(
ouut_size
, ());

40 
l
.
d–
 = 
	`ÿÎoc
(
ouut_size
, ());

41 
l
.
fÜw¬d
 = 
fÜw¬d_maxpoŞ_Ïy”
;

42 
l
.
backw¬d
 = 
backw¬d_maxpoŞ_Ïy”
;

43 #ifdeà
GPU


44 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_maxpoŞ_Ïy”_gpu
;

45 
l
.
backw¬d_gpu
 = 
backw¬d_maxpoŞ_Ïy”_gpu
;

46 
l
.
šdexes_gpu
 = 
	`cuda_make_št_¬¿y
(0, 
ouut_size
);

47 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
, 
ouut_size
);

48 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
, 
ouut_size
);

50 
	`årštf
(
¡d”r
, "max %d x %d / %d %4d x%4d x%4d -> %4d x%4d x%4d\n", 
size
, size, 
¡ride
, 
w
, 
h
, 
c
, 
l
.
out_w
,†.
out_h
,†.
out_c
);

51  
l
;

52 
	}
}

54 
	$»size_maxpoŞ_Ïy”
(
maxpoŞ_Ïy”
 *
l
, 
w
, 
h
)

56 
l
->
h
 = h;

57 
l
->
w
 = w;

58 
l
->
šputs
 = 
h
*
w
*l->
c
;

60 
l
->
out_w
 = (
w
 + 2*l->
·d
)/l->
¡ride
;

61 
l
->
out_h
 = (
h
 + 2*l->
·d
)/l->
¡ride
;

62 
l
->
ouuts
 =†->
out_w
 *†->
out_h
 *†->
c
;

63 
ouut_size
 = 
l
->
ouuts
 *†->
b©ch
;

65 
l
->
šdexes
 = 
	`»®loc
Ö->šdexes, 
ouut_size
 * ());

66 
l
->
ouut
 = 
	`»®loc
Ö->ouut, 
ouut_size
 * ());

67 
l
->
d–
 = 
	`»®loc
Ö->d–, 
ouut_size
 * ());

69 #ifdeà
GPU


70 
	`cuda_ä“
((*)
l
->
šdexes_gpu
);

71 
	`cuda_ä“
(
l
->
ouut_gpu
);

72 
	`cuda_ä“
(
l
->
d–_gpu
);

73 
l
->
šdexes_gpu
 = 
	`cuda_make_št_¬¿y
(0, 
ouut_size
);

74 
l
->
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö->
ouut
, 
ouut_size
);

75 
l
->
d–_gpu
 = 
	`cuda_make_¬¿y
Ö->
d–
, 
ouut_size
);

77 
	}
}

79 
	$fÜw¬d_maxpoŞ_Ïy”
(cÚ¡ 
maxpoŞ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

81 
b
,
i
,
j
,
k
,
m
,
n
;

82 
w_off£t
 = -
l
.
·d
;

83 
h_off£t
 = -
l
.
·d
;

85 
h
 = 
l
.
out_h
;

86 
w
 = 
l
.
out_w
;

87 
c
 = 
l
.c;

89 
b
 = 0; b < 
l
.
b©ch
; ++b){

90 
k
 = 0; k < 
c
; ++k){

91 
i
 = 0; i < 
h
; ++i){

92 
j
 = 0; j < 
w
; ++j){

93 
out_šdex
 = 
j
 + 
w
*(
i
 + 
h
*(
k
 + 
c
*
b
));

94 
max
 = -
FLT_MAX
;

95 
max_i
 = -1;

96 
n
 = 0;‚ < 
l
.
size
; ++n){

97 
m
 = 0; m < 
l
.
size
; ++m){

98 
cur_h
 = 
h_off£t
 + 
i
*
l
.
¡ride
 + 
n
;

99 
cur_w
 = 
w_off£t
 + 
j
*
l
.
¡ride
 + 
m
;

100 
šdex
 = 
cur_w
 + 
l
.
w
*(
cur_h
 +†.
h
*(
k
 + 
b
*l.
c
));

101 
v®id
 = (
cur_h
 >ğ0 && cur_h < 
l
.
h
 &&

102 
cur_w
 >ğ0 && cur_w < 
l
.
w
);

103 
v®
 = (
v®id
 !ğ0è? 
Ãt
.
šput
[
šdex
] : -
FLT_MAX
;

104 
max_i
 = (
v®
 > 
max
è? 
šdex
 : max_i;

105 
max
 = (
v®
 > max) ? val : max;

108 
l
.
ouut
[
out_šdex
] = 
max
;

109 
l
.
šdexes
[
out_šdex
] = 
max_i
;

114 
	}
}

116 
	$backw¬d_maxpoŞ_Ïy”
(cÚ¡ 
maxpoŞ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

118 
i
;

119 
h
 = 
l
.
out_h
;

120 
w
 = 
l
.
out_w
;

121 
c
 = 
l
.c;

122 
i
 = 0; i < 
h
*
w
*
c
*
l
.
b©ch
; ++i){

123 
šdex
 = 
l
.
šdexes
[
i
];

124 
Ãt
.
d–
[
šdex
] +ğ
l
.d–[
i
];

126 
	}
}

	@maxpool_layer.h

1 #iâdeà
MAXPOOL_LAYER_H


2 
	#MAXPOOL_LAYER_H


	)

4 
	~"image.h
"

5 
	~"cuda.h
"

6 
	~"Ïy”.h
"

7 
	~"ÃtwÜk.h
"

9 
Ïy”
 
	tmaxpoŞ_Ïy”
;

11 
image
 
g‘_maxpoŞ_image
(
maxpoŞ_Ïy”
 
l
);

12 
maxpoŞ_Ïy”
 
make_maxpoŞ_Ïy”
(
b©ch
, 
h
, 
w
, 
c
, 
size
, 
¡ride
, 
·ddšg
);

13 
»size_maxpoŞ_Ïy”
(
maxpoŞ_Ïy”
 *
l
, 
w
, 
h
);

14 
fÜw¬d_maxpoŞ_Ïy”
(cÚ¡ 
maxpoŞ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

15 
backw¬d_maxpoŞ_Ïy”
(cÚ¡ 
maxpoŞ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

17 #ifdeà
GPU


18 
fÜw¬d_maxpoŞ_Ïy”_gpu
(
maxpoŞ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

19 
backw¬d_maxpoŞ_Ïy”_gpu
(
maxpoŞ_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

	@network.c

1 
	~<¡dio.h
>

2 
	~<time.h
>

3 
	~<as£¹.h
>

4 
	~"ÃtwÜk.h
"

5 
	~"image.h
"

6 
	~"d©a.h
"

7 
	~"uts.h
"

8 
	~"bÏs.h
"

10 
	~"üİ_Ïy”.h
"

11 
	~"cÚÃùed_Ïy”.h
"

12 
	~"gru_Ïy”.h
"

13 
	~"ºn_Ïy”.h
"

14 
	~"üÂ_Ïy”.h
"

15 
	~"loÿl_Ïy”.h
"

16 
	~"cÚvŞutiÚ®_Ïy”.h
"

17 
	~"aùiv©iÚ_Ïy”.h
"

18 
	~"d‘eùiÚ_Ïy”.h
"

19 
	~"»giÚ_Ïy”.h
"

20 
	~"yŞo_Ïy”.h
"

21 
	~"nÜm®iz©iÚ_Ïy”.h
"

22 
	~"b©chnÜm_Ïy”.h
"

23 
	~"maxpoŞ_Ïy”.h
"

24 
	~"»Üg_Ïy”.h
"

25 
	~"avgpoŞ_Ïy”.h
"

26 
	~"co¡_Ïy”.h
"

27 
	~"soámax_Ïy”.h
"

28 
	~"drİout_Ïy”.h
"

29 
	~"rou‹_Ïy”.h
"

30 
	~"up§m¶e_Ïy”.h
"

31 
	~"shÜtcut_Ïy”.h
"

32 
	~"·r£r.h
"

33 
	~"d©a.h
"

35 
lßd_¬gs
 
	$g‘_ba£_¬gs
(
ÃtwÜk
 *
Ãt
)

37 
lßd_¬gs
 
¬gs
 = {0};

38 
¬gs
.
w
 = 
Ãt
->w;

39 
¬gs
.
h
 = 
Ãt
->h;

40 
¬gs
.
size
 = 
Ãt
->
w
;

42 
¬gs
.
mš
 = 
Ãt
->
mš_üİ
;

43 
¬gs
.
max
 = 
Ãt
->
max_üİ
;

44 
¬gs
.
ªgË
 = 
Ãt
->angle;

45 
¬gs
.
a¥eù
 = 
Ãt
->aspect;

46 
¬gs
.
exposu»
 = 
Ãt
->exposure;

47 
¬gs
.
ûÁ”
 = 
Ãt
->center;

48 
¬gs
.
§tu¿tiÚ
 = 
Ãt
->saturation;

49 
¬gs
.
hue
 = 
Ãt
->hue;

50  
¬gs
;

51 
	}
}

53 
ÃtwÜk
 *
	$lßd_ÃtwÜk
(*
cfg
, *
weights
, 
ş—r
)

55 
ÃtwÜk
 *
Ãt
 = 
	`·r£_ÃtwÜk_cfg
(
cfg
);

56 if(
weights
 && weights[0] != 0){

57 
	`lßd_weights
(
Ãt
, 
weights
);

59 if(
ş—r
è(*
Ãt
->
£’
) = 0;

60  
Ãt
;

61 
	}
}

63 
size_t
 
	$g‘_cu¼’t_b©ch
(
ÃtwÜk
 *
Ãt
)

65 
size_t
 
b©ch_num
 = (*
Ãt
->
£’
)/Ò‘->
b©ch
*Ãt->
subdivisiÚs
);

66  
b©ch_num
;

67 
	}
}

69 
	$»£t_ÃtwÜk_¡©e
(
ÃtwÜk
 *
Ãt
, 
b
)

71 
i
;

72 
i
 = 0; i < 
Ãt
->
n
; ++i) {

73 #ifdeà
GPU


74 
Ïy”
 
l
 = 
Ãt
->
Ïy”s
[
i
];

75 if(
l
.
¡©e_gpu
){

76 
	`fl_gpu
(
l
.
ouuts
, 0,†.
¡©e_gpu
 +†.ouuts*
b
, 1);

78 if(
l
.
h_gpu
){

79 
	`fl_gpu
(
l
.
ouuts
, 0,†.
h_gpu
 +†.ouuts*
b
, 1);

83 
	}
}

85 
	$»£t_ºn
(
ÃtwÜk
 *
Ãt
)

87 
	`»£t_ÃtwÜk_¡©e
(
Ãt
, 0);

88 
	}
}

90 
	$g‘_cu¼’t_¿‹
(
ÃtwÜk
 *
Ãt
)

92 
size_t
 
b©ch_num
 = 
	`g‘_cu¼’t_b©ch
(
Ãt
);

93 
i
;

94 
¿‹
;

95 ià(
b©ch_num
 < 
Ãt
->
buº_š
è‚‘->
Ë¬nšg_¿‹
 * 
	`pow
(()b©ch_num /‚‘->buº_š,‚‘->
pow”
);

96 
Ãt
->
pŞicy
) {

97 
CONSTANT
:

98  
Ãt
->
Ë¬nšg_¿‹
;

99 
STEP
:

100  
Ãt
->
Ë¬nšg_¿‹
 * 
	`pow
Ò‘->
sÿË
, 
b©ch_num
/Ãt->
¡•
);

101 
STEPS
:

102 
¿‹
 = 
Ãt
->
Ë¬nšg_¿‹
;

103 
i
 = 0; i < 
Ãt
->
num_¡•s
; ++i){

104 if(
Ãt
->
¡•s
[
i
] > 
b©ch_num
è 
¿‹
;

105 
¿‹
 *ğ
Ãt
->
sÿËs
[
i
];

107  
¿‹
;

108 
EXP
:

109  
Ãt
->
Ë¬nšg_¿‹
 * 
	`pow
Ò‘->
gamma
, 
b©ch_num
);

110 
POLY
:

111  
Ãt
->
Ë¬nšg_¿‹
 * 
	`pow
(1 - ()
b©ch_num
 /‚‘->
max_b©ches
,‚‘->
pow”
);

112 
RANDOM
:

113  
Ãt
->
Ë¬nšg_¿‹
 * 
	`pow
(
	`¿nd_unifÜm
(0,1),‚‘->
pow”
);

114 
SIG
:

115  
Ãt
->
Ë¬nšg_¿‹
 * (1./(1.+
	`exp
Ò‘->
gamma
*(
b©ch_num
 -‚‘->
¡•
))));

117 
	`årštf
(
¡d”r
, "Policy is weird!\n");

118  
Ãt
->
Ë¬nšg_¿‹
;

120 
	}
}

122 *
	$g‘_Ïy”_¡ršg
(
LAYER_TYPE
 
a
)

124 
a
){

125 
CONVOLUTIONAL
:

127 
ACTIVE
:

129 
LOCAL
:

131 
DECONVOLUTIONAL
:

133 
CONNECTED
:

135 
RNN
:

137 
GRU
:

139 
LSTM
:

141 
CRNN
:

143 
MAXPOOL
:

145 
REORG
:

147 
AVGPOOL
:

149 
SOFTMAX
:

151 
DETECTION
:

153 
REGION
:

155 
YOLO
:

157 
DROPOUT
:

159 
CROP
:

161 
COST
:

163 
ROUTE
:

165 
SHORTCUT
:

167 
NORMALIZATION
:

169 
BATCHNORM
:

175 
	}
}

177 
ÃtwÜk
 *
	$make_ÃtwÜk
(
n
)

179 
ÃtwÜk
 *
Ãt
 = 
	`ÿÎoc
(1, (network));

180 
Ãt
->
n
 =‚;

181 
Ãt
->
Ïy”s
 = 
	`ÿÎoc
Ò‘->
n
, (
Ïy”
));

182 
Ãt
->
£’
 = 
	`ÿÎoc
(1, (
size_t
));

183 
Ãt
->
t
 = 
	`ÿÎoc
(1, ());

184 
Ãt
->
co¡
 = 
	`ÿÎoc
(1, ());

185  
Ãt
;

186 
	}
}

188 
	$fÜw¬d_ÃtwÜk
(
ÃtwÜk
 *
Ã
)

190 #ifdeà
GPU


191 if(
Ã
->
gpu_šdex
 >= 0){

192 
	`fÜw¬d_ÃtwÜk_gpu
(
Ã
);

196 
ÃtwÜk
 
Ãt
 = *
Ã
;

197 
i
;

198 
i
 = 0; i < 
Ãt
.
n
; ++i){

199 
Ãt
.
šdex
 = 
i
;

200 
Ïy”
 
l
 = 
Ãt
.
Ïy”s
[
i
];

201 if(
l
.
d–
){

202 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
, 0,†.
d–
, 1);

204 
l
.
	`fÜw¬d
Ö, 
Ãt
);

205 
Ãt
.
šput
 = 
l
.
ouut
;

206 if(
l
.
Œuth
) {

207 
Ãt
.
Œuth
 = 
l
.
ouut
;

210 
	`ÿlc_ÃtwÜk_co¡
(
Ã
);

211 
	}
}

213 
	$upd©e_ÃtwÜk
(
ÃtwÜk
 *
Ã
)

215 #ifdeà
GPU


216 if(
Ã
->
gpu_šdex
 >= 0){

217 
	`upd©e_ÃtwÜk_gpu
(
Ã
);

221 
ÃtwÜk
 
Ãt
 = *
Ã
;

222 
i
;

223 
upd©e_¬gs
 
a
 = {0};

224 
a
.
b©ch
 = 
Ãt
.b©ch*Ãt.
subdivisiÚs
;

225 
a
.
Ë¬nšg_¿‹
 = 
	`g‘_cu¼’t_¿‹
(
Ã
);

226 
a
.
mom’tum
 = 
Ãt
.momentum;

227 
a
.
deÿy
 = 
Ãt
.decay;

228 
a
.
adam
 = 
Ãt
.adam;

229 
a
.
B1
 = 
Ãt
.B1;

230 
a
.
B2
 = 
Ãt
.B2;

231 
a
.
•s
 = 
Ãt
.eps;

232 ++*
Ãt
.
t
;

233 
a
.
t
 = *
Ãt
.t;

235 
i
 = 0; i < 
Ãt
.
n
; ++i){

236 
Ïy”
 
l
 = 
Ãt
.
Ïy”s
[
i
];

237 if(
l
.
upd©e
){

238 
l
.
	`upd©e
Ö, 
a
);

241 
	}
}

243 
	$ÿlc_ÃtwÜk_co¡
(
ÃtwÜk
 *
Ã
)

245 
ÃtwÜk
 
Ãt
 = *
Ã
;

246 
i
;

247 
sum
 = 0;

248 
couÁ
 = 0;

249 
i
 = 0; i < 
Ãt
.
n
; ++i){

250 if(
Ãt
.
Ïy”s
[
i
].
co¡
){

251 
sum
 +ğ
Ãt
.
Ïy”s
[
i
].
co¡
[0];

253 ++
couÁ
;

256 *
Ãt
.
co¡
 = 
sum
/
couÁ
;

257 
	}
}

259 
	$g‘_´ediùed_şass_ÃtwÜk
(
ÃtwÜk
 *
Ãt
)

261  
	`max_šdex
(
Ãt
->
ouut
,‚‘->
ouuts
);

262 
	}
}

264 
	$backw¬d_ÃtwÜk
(
ÃtwÜk
 *
Ã
)

266 #ifdeà
GPU


267 if(
Ã
->
gpu_šdex
 >= 0){

268 
	`backw¬d_ÃtwÜk_gpu
(
Ã
);

272 
ÃtwÜk
 
Ãt
 = *
Ã
;

273 
i
;

274 
ÃtwÜk
 
Üig
 = 
Ãt
;

275 
i
 = 
Ãt
.
n
-1; i >= 0; --i){

276 
Ïy”
 
l
 = 
Ãt
.
Ïy”s
[
i
];

277 if(
l
.
¡İbackw¬d
) ;

278 if(
i
 == 0){

279 
Ãt
 = 
Üig
;

281 
Ïy”
 
´ev
 = 
Ãt
.
Ïy”s
[
i
-1];

282 
Ãt
.
šput
 = 
´ev
.
ouut
;

283 
Ãt
.
d–
 = 
´ev
.delta;

285 
Ãt
.
šdex
 = 
i
;

286 
l
.
	`backw¬d
Ö, 
Ãt
);

288 
	}
}

290 
	$Œaš_ÃtwÜk_d©um
(
ÃtwÜk
 *
Ãt
)

292 *
Ãt
->
£’
 +ğÃt->
b©ch
;

293 
Ãt
->
Œaš
 = 1;

294 
	`fÜw¬d_ÃtwÜk
(
Ãt
);

295 
	`backw¬d_ÃtwÜk
(
Ãt
);

296 
”rÜ
 = *
Ãt
->
co¡
;

297 
	`´štf
 ("Àb©høi %f\n", 
”rÜ
);

298 if(((*
Ãt
->
£’
)/Ãt->
b©ch
)%Ãt->
subdivisiÚs
 =ğ0è
	`upd©e_ÃtwÜk
(net);

299  
”rÜ
;

300 
	}
}

302 
	$Œaš_ÃtwÜk_sgd
(
ÃtwÜk
 *
Ãt
, 
d©a
 
d
, 
n
)

304 
b©ch
 = 
Ãt
->batch;

306 
i
;

307 
sum
 = 0;

308 
i
 = 0; i < 
n
; ++i){

309 
	`g‘_¿ndom_b©ch
(
d
, 
b©ch
, 
Ãt
->
šput
,‚‘->
Œuth
);

310 
”r
 = 
	`Œaš_ÃtwÜk_d©um
(
Ãt
);

311 
sum
 +ğ
”r
;

313  ()
sum
/(
n
*
b©ch
);

314 
	}
}

316 
	$Œaš_ÃtwÜk
(
ÃtwÜk
 *
Ãt
, 
d©a
 
d
)

318 
	`as£¹
(
d
.
X
.
rows
 % 
Ãt
->
b©ch
 == 0);

319 
b©ch
 = 
Ãt
->batch;

320 
n
 = 
d
.
X
.
rows
 / 
b©ch
;

322 
i
;

323 
sum
 = 0;

324 
i
 = 0; i < 
n
; ++i){

325 
	`g‘_Ãxt_b©ch
(
d
, 
b©ch
, 
i
*b©ch, 
Ãt
->
šput
,‚‘->
Œuth
);

327 
”r
 = 
	`Œaš_ÃtwÜk_d©um
(
Ãt
);

328 
sum
 +ğ
”r
;

330  ()
sum
/(
n
*
b©ch
);

331 
	}
}

333 
	$£t_‹mp_ÃtwÜk
(
ÃtwÜk
 *
Ãt
, 
t
)

335 
i
;

336 
i
 = 0; i < 
Ãt
->
n
; ++i){

337 
Ãt
->
Ïy”s
[
i
].
‹m³¿tu»
 = 
t
;

339 
	}
}

342 
	$£t_b©ch_ÃtwÜk
(
ÃtwÜk
 *
Ãt
, 
b
)

344 
Ãt
->
b©ch
 = 
b
;

345 
i
;

346 
i
 = 0; i < 
Ãt
->
n
; ++i){

347 
Ãt
->
Ïy”s
[
i
].
b©ch
 = 
b
;

348 #ifdeà
CUDNN


349 if(
Ãt
->
Ïy”s
[
i
].
ty³
 =ğ
CONVOLUTIONAL
){

350 
	`cudÂ_cÚvŞutiÚ®_£tup
(
Ãt
->
Ïy”s
 + 
i
);

352 if(
Ãt
->
Ïy”s
[
i
].
ty³
 =ğ
DECONVOLUTIONAL
){

353 
Ïy”
 *
l
 = 
Ãt
->
Ïy”s
 + 
i
;

354 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 1,†->
out_c
,†->
out_h
,†->
out_w
);

355 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
->
nÜmT’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 1,†->
out_c
, 1, 1);

359 
	}
}

361 
	$»size_ÃtwÜk
(
ÃtwÜk
 *
Ãt
, 
w
, 
h
)

363 #ifdeà
GPU


364 
	`cuda_£t_deviû
(
Ãt
->
gpu_šdex
);

365 
	`cuda_ä“
(
Ãt
->
wÜk¥aû
);

367 
i
;

369 
Ãt
->
w
 = w;

370 
Ãt
->
h
 = h;

371 
šputs
 = 0;

372 
size_t
 
wÜk¥aû_size
 = 0;

375 
i
 = 0; i < 
Ãt
->
n
; ++i){

376 
Ïy”
 
l
 = 
Ãt
->
Ïy”s
[
i
];

377 if(
l
.
ty³
 =ğ
CONVOLUTIONAL
){

378 
	`»size_cÚvŞutiÚ®_Ïy”
(&
l
, 
w
, 
h
);

379 }if(
l
.
ty³
 =ğ
CROP
){

380 
	`»size_üİ_Ïy”
(&
l
, 
w
, 
h
);

381 }if(
l
.
ty³
 =ğ
MAXPOOL
){

382 
	`»size_maxpoŞ_Ïy”
(&
l
, 
w
, 
h
);

383 }if(
l
.
ty³
 =ğ
REGION
){

384 
	`»size_»giÚ_Ïy”
(&
l
, 
w
, 
h
);

385 }if(
l
.
ty³
 =ğ
YOLO
){

386 
	`»size_yŞo_Ïy”
(&
l
, 
w
, 
h
);

387 }if(
l
.
ty³
 =ğ
ROUTE
){

388 
	`»size_rou‹_Ïy”
(&
l
, 
Ãt
);

389 }if(
l
.
ty³
 =ğ
SHORTCUT
){

390 
	`»size_shÜtcut_Ïy”
(&
l
, 
w
, 
h
);

391 }if(
l
.
ty³
 =ğ
UPSAMPLE
){

392 
	`»size_up§m¶e_Ïy”
(&
l
, 
w
, 
h
);

393 }if(
l
.
ty³
 =ğ
REORG
){

394 
	`»size_»Üg_Ïy”
(&
l
, 
w
, 
h
);

395 }if(
l
.
ty³
 =ğ
AVGPOOL
){

396 
	`»size_avgpoŞ_Ïy”
(&
l
, 
w
, 
h
);

397 }if(
l
.
ty³
 =ğ
NORMALIZATION
){

398 
	`»size_nÜm®iz©iÚ_Ïy”
(&
l
, 
w
, 
h
);

399 }if(
l
.
ty³
 =ğ
COST
){

400 
	`»size_co¡_Ïy”
(&
l
, 
šputs
);

402 
	`”rÜ
("Cannot„esizehisype of†ayer");

404 if(
l
.
wÜk¥aû_size
 > workspace_size) workspace_size =†.workspace_size;

405 if(
l
.
wÜk¥aû_size
 > 2000000000è
	`as£¹
(0);

406 
šputs
 = 
l
.
ouuts
;

407 
Ãt
->
Ïy”s
[
i
] = 
l
;

408 
w
 = 
l
.
out_w
;

409 
h
 = 
l
.
out_h
;

410 if(
l
.
ty³
 =ğ
AVGPOOL
) ;

412 
Ïy”
 
out
 = 
	`g‘_ÃtwÜk_ouut_Ïy”
(
Ãt
);

413 
Ãt
->
šputs
 =‚‘->
Ïy”s
[0].inputs;

414 
Ãt
->
ouuts
 = 
out
.outputs;

415 
Ãt
->
Œuths
 = 
out
.
ouuts
;

416 if(
Ãt
->
Ïy”s
[Ãt->
n
-1].
Œuths
)‚et->truths =‚et->layers[net->n-1].truths;

417 
Ãt
->
ouut
 = 
out
.output;

418 
	`ä“
(
Ãt
->
šput
);

419 
	`ä“
(
Ãt
->
Œuth
);

420 
Ãt
->
šput
 = 
	`ÿÎoc
Ò‘->
šputs
*Ãt->
b©ch
, ());

421 
Ãt
->
Œuth
 = 
	`ÿÎoc
Ò‘->
Œuths
*Ãt->
b©ch
, ());

422 #ifdeà
GPU


423 if(
gpu_šdex
 >= 0){

424 
	`cuda_ä“
(
Ãt
->
šput_gpu
);

425 
	`cuda_ä“
(
Ãt
->
Œuth_gpu
);

426 
Ãt
->
šput_gpu
 = 
	`cuda_make_¬¿y
Ò‘->
šput
,‚‘->
šputs
*Ãt->
b©ch
);

427 
Ãt
->
Œuth_gpu
 = 
	`cuda_make_¬¿y
Ò‘->
Œuth
,‚‘->
Œuths
*Ãt->
b©ch
);

428 if(
wÜk¥aû_size
){

429 
Ãt
->
wÜk¥aû
 = 
	`cuda_make_¬¿y
(0, (
wÜk¥aû_size
-1)/()+1);

432 
	`ä“
(
Ãt
->
wÜk¥aû
);

433 
Ãt
->
wÜk¥aû
 = 
	`ÿÎoc
(1, 
wÜk¥aû_size
);

436 
	`ä“
(
Ãt
->
wÜk¥aû
);

437 
Ãt
->
wÜk¥aû
 = 
	`ÿÎoc
(1, 
wÜk¥aû_size
);

441 
	}
}

443 
Ïy”
 
	$g‘_ÃtwÜk_d‘eùiÚ_Ïy”
(
ÃtwÜk
 *
Ãt
)

445 
i
;

446 
i
 = 0; i < 
Ãt
->
n
; ++i){

447 if(
Ãt
->
Ïy”s
[
i
].
ty³
 =ğ
DETECTION
){

448  
Ãt
->
Ïy”s
[
i
];

451 
	`årštf
(
¡d”r
, "Detection†ayer‚ot found!!\n");

452 
Ïy”
 
l
 = {0};

453  
l
;

454 
	}
}

456 
image
 
	$g‘_ÃtwÜk_image_Ïy”
(
ÃtwÜk
 *
Ãt
, 
i
)

458 
Ïy”
 
l
 = 
Ãt
->
Ïy”s
[
i
];

459 #ifdeà
GPU


462 ià(
l
.
out_w
 &&†.
out_h
 &&†.
out_c
){

463  
	`æßt_to_image
(
l
.
out_w
,†.
out_h
,†.
out_c
,†.
ouut
);

465 
image
 
def
 = {0};

466  
def
;

467 
	}
}

469 
image
 
	$g‘_ÃtwÜk_image
(
ÃtwÜk
 *
Ãt
)

471 
i
;

472 
i
 = 
Ãt
->
n
-1; i >= 0; --i){

473 
image
 
m
 = 
	`g‘_ÃtwÜk_image_Ïy”
(
Ãt
, 
i
);

474 if(
m
.
h
 != 0)  m;

476 
image
 
def
 = {0};

477  
def
;

478 
	}
}

480 
	$visu®ize_ÃtwÜk
(
ÃtwÜk
 *
Ãt
)

482 
image
 *
´ev
 = 0;

483 
i
;

484 
buff
[256];

485 
i
 = 0; i < 
Ãt
->
n
; ++i){

486 
	`¥rštf
(
buff
, "Lay” %d", 
i
);

487 
Ïy”
 
l
 = 
Ãt
->
Ïy”s
[
i
];

488 if(
l
.
ty³
 =ğ
CONVOLUTIONAL
){

489 
´ev
 = 
	`visu®ize_cÚvŞutiÚ®_Ïy”
(
l
, 
buff
,…rev);

492 
	}
}

494 
	$tİ_´ediùiÚs
(
ÃtwÜk
 *
Ãt
, 
k
, *
šdex
)

496 
	`tİ_k
(
Ãt
->
ouut
,‚‘->
ouuts
, 
k
, 
šdex
);

497 
	}
}

500 *
	$ÃtwÜk_´ediù
(
ÃtwÜk
 *
Ãt
, *
šput
)

502 
ÃtwÜk
 
Üig
 = *
Ãt
;

503 
Ãt
->
šput
 = input;

504 
Ãt
->
Œuth
 = 0;

505 
Ãt
->
Œaš
 = 0;

506 
Ãt
->
d–
 = 0;

507 
	`fÜw¬d_ÃtwÜk
(
Ãt
);

508 *
out
 = 
Ãt
->
ouut
;

509 *
Ãt
 = 
Üig
;

510  
out
;

511 
	}
}

513 
	$num_d‘eùiÚs
(
ÃtwÜk
 *
Ãt
, 
th»sh
)

515 
i
;

516 
s
 = 0;

517 
i
 = 0; i < 
Ãt
->
n
; ++i){

518 
Ïy”
 
l
 = 
Ãt
->
Ïy”s
[
i
];

519 if(
l
.
ty³
 =ğ
YOLO
){

520 
s
 +ğ
	`yŞo_num_d‘eùiÚs
(
l
, 
th»sh
);

522 if(
l
.
ty³
 =ğ
DETECTION
 ||†.ty³ =ğ
REGION
){

523 
s
 +ğ
l
.
w
*l.
h
*l.
n
;

526  
s
;

527 
	}
}

529 
d‘eùiÚ
 *
	$make_ÃtwÜk_boxes
(
ÃtwÜk
 *
Ãt
, 
th»sh
, *
num
)

531 
Ïy”
 
l
 = 
Ãt
->
Ïy”s
[Ãt->
n
 - 1];

532 
i
;

533 
nboxes
 = 
	`num_d‘eùiÚs
(
Ãt
, 
th»sh
);

534 if(
num
è*num = 
nboxes
;

535 
d‘eùiÚ
 *
d‘s
 = 
	`ÿÎoc
(
nboxes
, (detection));

536 
i
 = 0; i < 
nboxes
; ++i){

537 
d‘s
[
i
].
´ob
 = 
	`ÿÎoc
(
l
.
şas£s
, ());

538 if(
l
.
coÜds
 > 4){

539 
d‘s
[
i
].
mask
 = 
	`ÿÎoc
(
l
.
coÜds
-4, ());

542  
d‘s
;

543 
	}
}

545 
	$fl_ÃtwÜk_boxes
(
ÃtwÜk
 *
Ãt
, 
w
, 
h
, 
th»sh
, 
h›r
, *
m­
, 
»Ïtive
, 
d‘eùiÚ
 *
d‘s
)

547 
j
;

548 
j
 = 0; j < 
Ãt
->
n
; ++j){

549 
Ïy”
 
l
 = 
Ãt
->
Ïy”s
[
j
];

550 if(
l
.
ty³
 =ğ
YOLO
){

551 
couÁ
 = 
	`g‘_yŞo_d‘eùiÚs
(
l
, 
w
, 
h
, 
Ãt
->w,‚‘->h, 
th»sh
, 
m­
, 
»Ïtive
, 
d‘s
);

552 
d‘s
 +ğ
couÁ
;

554 if(
l
.
ty³
 =ğ
REGION
){

555 
	`g‘_»giÚ_d‘eùiÚs
(
l
, 
w
, 
h
, 
Ãt
->w,‚‘->h, 
th»sh
, 
m­
, 
h›r
, 
»Ïtive
, 
d‘s
);

556 
d‘s
 +ğ
l
.
w
*l.
h
*l.
n
;

558 if(
l
.
ty³
 =ğ
DETECTION
){

559 
	`g‘_d‘eùiÚ_d‘eùiÚs
(
l
, 
w
, 
h
, 
th»sh
, 
d‘s
);

560 
d‘s
 +ğ
l
.
w
*l.
h
*l.
n
;

563 
	}
}

565 
d‘eùiÚ
 *
	$g‘_ÃtwÜk_boxes
(
ÃtwÜk
 *
Ãt
, 
w
, 
h
, 
th»sh
, 
h›r
, *
m­
, 
»Ïtive
, *
num
)

567 
d‘eùiÚ
 *
d‘s
 = 
	`make_ÃtwÜk_boxes
(
Ãt
, 
th»sh
, 
num
);

568 
	`fl_ÃtwÜk_boxes
(
Ãt
, 
w
, 
h
, 
th»sh
, 
h›r
, 
m­
, 
»Ïtive
, 
d‘s
);

569  
d‘s
;

570 
	}
}

572 
	$ä“_d‘eùiÚs
(
d‘eùiÚ
 *
d‘s
, 
n
)

574 
i
;

575 
i
 = 0; i < 
n
; ++i){

576 
	`ä“
(
d‘s
[
i
].
´ob
);

577 if(
d‘s
[
i
].
mask
è
	`ä“
(dets[i].mask);

579 
	`ä“
(
d‘s
);

580 
	}
}

582 *
	$ÃtwÜk_´ediù_image
(
ÃtwÜk
 *
Ãt
, 
image
 
im
)

584 
image
 
imr
 = 
	`Ë‰”box_image
(
im
, 
Ãt
->
w
,‚‘->
h
);

585 
	`£t_b©ch_ÃtwÜk
(
Ãt
, 1);

586 *
p
 = 
	`ÃtwÜk_´ediù
(
Ãt
, 
imr
.
d©a
);

587 
	`ä“_image
(
imr
);

588  
p
;

589 
	}
}

591 
	$ÃtwÜk_width
(
ÃtwÜk
 *
Ãt
){‚‘->
w
;
	}
}

592 
	$ÃtwÜk_height
(
ÃtwÜk
 *
Ãt
){‚‘->
h
;
	}
}

594 
m©rix
 
	$ÃtwÜk_´ediù_d©a_muÉi
(
ÃtwÜk
 *
Ãt
, 
d©a
 
‹¡
, 
n
)

596 
i
,
j
,
b
,
m
;

597 
k
 = 
Ãt
->
ouuts
;

598 
m©rix
 
´ed
 = 
	`make_m©rix
(
‹¡
.
X
.
rows
, 
k
);

599 *
X
 = 
	`ÿÎoc
(
Ãt
->
b©ch
*
‹¡
.X.
rows
, ());

600 
i
 = 0; i < 
‹¡
.
X
.
rows
; i +ğ
Ãt
->
b©ch
){

601 
b
 = 0; b < 
Ãt
->
b©ch
; ++b){

602 if(
i
+
b
 =ğ
‹¡
.
X
.
rows
) ;

603 
	`memıy
(
X
+
b
*
‹¡
.X.
cŞs
,e¡.X.
v®s
[
i
+b],est.X.cols*());

605 
m
 = 0; m < 
n
; ++m){

606 *
out
 = 
	`ÃtwÜk_´ediù
(
Ãt
, 
X
);

607 
b
 = 0; b < 
Ãt
->
b©ch
; ++b){

608 if(
i
+
b
 =ğ
‹¡
.
X
.
rows
) ;

609 
j
 = 0; j < 
k
; ++j){

610 
´ed
.
v®s
[
i
+
b
][
j
] +ğ
out
[j+b*
k
]/
n
;

615 
	`ä“
(
X
);

616  
´ed
;

617 
	}
}

619 
m©rix
 
	$ÃtwÜk_´ediù_d©a
(
ÃtwÜk
 *
Ãt
, 
d©a
 
‹¡
)

621 
i
,
j
,
b
;

622 
k
 = 
Ãt
->
ouuts
;

623 
m©rix
 
´ed
 = 
	`make_m©rix
(
‹¡
.
X
.
rows
, 
k
);

624 *
X
 = 
	`ÿÎoc
(
Ãt
->
b©ch
*
‹¡
.X.
cŞs
, ());

625 
i
 = 0; i < 
‹¡
.
X
.
rows
; i +ğ
Ãt
->
b©ch
){

626 
b
 = 0; b < 
Ãt
->
b©ch
; ++b){

627 if(
i
+
b
 =ğ
‹¡
.
X
.
rows
) ;

628 
	`memıy
(
X
+
b
*
‹¡
.X.
cŞs
,e¡.X.
v®s
[
i
+b],est.X.cols*());

630 *
out
 = 
	`ÃtwÜk_´ediù
(
Ãt
, 
X
);

631 
b
 = 0; b < 
Ãt
->
b©ch
; ++b){

632 if(
i
+
b
 =ğ
‹¡
.
X
.
rows
) ;

633 
j
 = 0; j < 
k
; ++j){

634 
´ed
.
v®s
[
i
+
b
][
j
] = 
out
[j+b*
k
];

638 
	`ä“
(
X
);

639  
´ed
;

640 
	}
}

642 
	$´št_ÃtwÜk
(
ÃtwÜk
 *
Ãt
)

644 
i
,
j
;

645 
i
 = 0; i < 
Ãt
->
n
; ++i){

646 
Ïy”
 
l
 = 
Ãt
->
Ïy”s
[
i
];

647 *
ouut
 = 
l
.output;

648 
n
 = 
l
.
ouuts
;

649 
m—n
 = 
	`m—n_¬¿y
(
ouut
, 
n
);

650 
v¬i
 = 
	`v¬Ÿnû_¬¿y
(
ouut
, 
n
);

651 
	`årštf
(
¡d”r
, "Lay” %d - M—n: %f, V¬Ÿnû: %f\n",
i
,
m—n
, 
v¬i
);

652 if(
n
 > 100)‚ = 100;

653 
j
 = 0; j < 
n
; ++jè
	`årštf
(
¡d”r
, "%f, ", 
ouut
[j]);

654 if(
n
 =ğ100)
	`årštf
(
¡d”r
,".....\n");

655 
	`årštf
(
¡d”r
, "\n");

657 
	}
}

659 
	$com·»_ÃtwÜks
(
ÃtwÜk
 *
n1
,‚‘wÜk *
n2
, 
d©a
 
‹¡
)

661 
m©rix
 
g1
 = 
	`ÃtwÜk_´ediù_d©a
(
n1
, 
‹¡
);

662 
m©rix
 
g2
 = 
	`ÃtwÜk_´ediù_d©a
(
n2
, 
‹¡
);

663 
i
;

664 
a
,
b
,
c
,
d
;

665 
a
 = 
b
 = 
c
 = 
d
 = 0;

666 
i
 = 0; i < 
g1
.
rows
; ++i){

667 
Œuth
 = 
	`max_šdex
(
‹¡
.
y
.
v®s
[
i
],e¡.y.
cŞs
);

668 
p1
 = 
	`max_šdex
(
g1
.
v®s
[
i
], g1.
cŞs
);

669 
p2
 = 
	`max_šdex
(
g2
.
v®s
[
i
], g2.
cŞs
);

670 if(
p1
 =ğ
Œuth
){

671 if(
p2
 =ğ
Œuth
è++
d
;

672 ++
c
;

674 if(
p2
 =ğ
Œuth
è++
b
;

675 ++
a
;

678 
	`´štf
("%5d %5d\n%5d %5d\n", 
a
, 
b
, 
c
, 
d
);

679 
num
 = 
	`pow
((
	`abs
(
b
 - 
c
) - 1.), 2.);

680 
d’
 = 
b
 + 
c
;

681 
	`´štf
("%f\n", 
num
/
d’
);

682 
	}
}

684 
	$ÃtwÜk_accu¿cy
(
ÃtwÜk
 *
Ãt
, 
d©a
 
d
)

686 
m©rix
 
guess
 = 
	`ÃtwÜk_´ediù_d©a
(
Ãt
, 
d
);

687 
acc
 = 
	`m©rix_tİk_accu¿cy
(
d
.
y
, 
guess
,1);

688 
	`ä“_m©rix
(
guess
);

689  
acc
;

690 
	}
}

692 *
	$ÃtwÜk_accu¿c›s
(
ÃtwÜk
 *
Ãt
, 
d©a
 
d
, 
n
)

694 
acc
[2];

695 
m©rix
 
guess
 = 
	`ÃtwÜk_´ediù_d©a
(
Ãt
, 
d
);

696 
acc
[0] = 
	`m©rix_tİk_accu¿cy
(
d
.
y
, 
guess
, 1);

697 
acc
[1] = 
	`m©rix_tİk_accu¿cy
(
d
.
y
, 
guess
, 
n
);

698 
	`ä“_m©rix
(
guess
);

699  
acc
;

700 
	}
}

702 
Ïy”
 
	$g‘_ÃtwÜk_ouut_Ïy”
(
ÃtwÜk
 *
Ãt
)

704 
i
;

705 
i
 = 
Ãt
->
n
 - 1; i >= 0; --i){

706 if(
Ãt
->
Ïy”s
[
i
].
ty³
 !ğ
COST
) ;

708  
Ãt
->
Ïy”s
[
i
];

709 
	}
}

711 
	$ÃtwÜk_accu¿cy_muÉi
(
ÃtwÜk
 *
Ãt
, 
d©a
 
d
, 
n
)

713 
m©rix
 
guess
 = 
	`ÃtwÜk_´ediù_d©a_muÉi
(
Ãt
, 
d
, 
n
);

714 
acc
 = 
	`m©rix_tİk_accu¿cy
(
d
.
y
, 
guess
,1);

715 
	`ä“_m©rix
(
guess
);

716  
acc
;

717 
	}
}

719 
	$ä“_ÃtwÜk
(
ÃtwÜk
 *
Ãt
)

721 
i
;

722 
i
 = 0; i < 
Ãt
->
n
; ++i){

723 
	`ä“_Ïy”
(
Ãt
->
Ïy”s
[
i
]);

725 
	`ä“
(
Ãt
->
Ïy”s
);

726 if(
Ãt
->
šput
è
	`ä“
(net->input);

727 if(
Ãt
->
Œuth
è
	`ä“
(net->truth);

728 #ifdeà
GPU


729 if(
Ãt
->
šput_gpu
è
	`cuda_ä“
(net->input_gpu);

730 if(
Ãt
->
Œuth_gpu
è
	`cuda_ä“
(net->truth_gpu);

732 
	`ä“
(
Ãt
);

733 
	}
}

739 
Ïy”
 
	$ÃtwÜk_ouut_Ïy”
(
ÃtwÜk
 *
Ãt
)

741 
i
;

742 
i
 = 
Ãt
->
n
 - 1; i >= 0; --i){

743 if(
Ãt
->
Ïy”s
[
i
].
ty³
 !ğ
COST
) ;

745  
Ãt
->
Ïy”s
[
i
];

746 
	}
}

748 
	$ÃtwÜk_šputs
(
ÃtwÜk
 *
Ãt
)

750  
Ãt
->
Ïy”s
[0].
šputs
;

751 
	}
}

753 
	$ÃtwÜk_ouuts
(
ÃtwÜk
 *
Ãt
)

755  
	`ÃtwÜk_ouut_Ïy”
(
Ãt
).
ouuts
;

756 
	}
}

758 *
	$ÃtwÜk_ouut
(
ÃtwÜk
 *
Ãt
)

760  
	`ÃtwÜk_ouut_Ïy”
(
Ãt
).
ouut
;

761 
	}
}

763 #ifdeà
GPU


765 
	$fÜw¬d_ÃtwÜk_gpu
(
ÃtwÜk
 *
Ã
)

767 
ÃtwÜk
 
Ãt
 = *
Ã
;

768 
	`cuda_£t_deviû
(
Ãt
.
gpu_šdex
);

769 
	`cuda_push_¬¿y
(
Ãt
.
šput_gpu
,‚‘.
šput
,‚‘.
šputs
*Ãt.
b©ch
);

770 if(
Ãt
.
Œuth
){

771 
	`cuda_push_¬¿y
(
Ãt
.
Œuth_gpu
,‚‘.
Œuth
,‚‘.
Œuths
*Ãt.
b©ch
);

774 
i
;

775 
i
 = 0; i < 
Ãt
.
n
; ++i){

776 
Ãt
.
šdex
 = 
i
;

777 
Ïy”
 
l
 = 
Ãt
.
Ïy”s
[
i
];

779 if(
l
.
d–_gpu
){

780 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
, 0,†.
d–_gpu
, 1);

782 
l
.
	`fÜw¬d_gpu
Ö, 
Ãt
);

783 
Ãt
.
šput_gpu
 = 
l
.
ouut_gpu
;

784 
Ãt
.
šput
 = 
l
.
ouut
;

785 if(
l
.
Œuth
) {

786 
Ãt
.
Œuth_gpu
 = 
l
.
ouut_gpu
;

787 
Ãt
.
Œuth
 = 
l
.
ouut
;

790 
	`puÎ_ÃtwÜk_ouut
(
Ã
);

791 
	`ÿlc_ÃtwÜk_co¡
(
Ã
);

792 
	}
}

794 
	$backw¬d_ÃtwÜk_gpu
(
ÃtwÜk
 *
Ã
)

796 
i
;

797 
ÃtwÜk
 
Ãt
 = *
Ã
;

798 
ÃtwÜk
 
Üig
 = 
Ãt
;

799 
	`cuda_£t_deviû
(
Ãt
.
gpu_šdex
);

800 
i
 = 
Ãt
.
n
-1; i >= 0; --i){

801 
Ïy”
 
l
 = 
Ãt
.
Ïy”s
[
i
];

802 if(
l
.
¡İbackw¬d
) ;

803 if(
i
 == 0){

804 
Ãt
 = 
Üig
;

806 
Ïy”
 
´ev
 = 
Ãt
.
Ïy”s
[
i
-1];

807 
Ãt
.
šput
 = 
´ev
.
ouut
;

808 
Ãt
.
d–
 = 
´ev
.delta;

809 
Ãt
.
šput_gpu
 = 
´ev
.
ouut_gpu
;

810 
Ãt
.
d–_gpu
 = 
´ev
.delta_gpu;

812 
Ãt
.
šdex
 = 
i
;

813 
l
.
	`backw¬d_gpu
Ö, 
Ãt
);

815 
	}
}

817 
	$upd©e_ÃtwÜk_gpu
(
ÃtwÜk
 *
Ã
)

819 
ÃtwÜk
 
Ãt
 = *
Ã
;

820 
	`cuda_£t_deviû
(
Ãt
.
gpu_šdex
);

821 
i
;

822 
upd©e_¬gs
 
a
 = {0};

823 
a
.
b©ch
 = 
Ãt
.b©ch*Ãt.
subdivisiÚs
;

824 
a
.
Ë¬nšg_¿‹
 = 
	`g‘_cu¼’t_¿‹
(
Ã
);

825 
a
.
mom’tum
 = 
Ãt
.momentum;

826 
a
.
deÿy
 = 
Ãt
.decay;

827 
a
.
adam
 = 
Ãt
.adam;

828 
a
.
B1
 = 
Ãt
.B1;

829 
a
.
B2
 = 
Ãt
.B2;

830 
a
.
•s
 = 
Ãt
.eps;

831 ++*
Ãt
.
t
;

832 
a
.
t
 = (*
Ãt
.t);

834 
i
 = 0; i < 
Ãt
.
n
; ++i){

835 
Ïy”
 
l
 = 
Ãt
.
Ïy”s
[
i
];

836 if(
l
.
upd©e_gpu
){

837 
l
.
	`upd©e_gpu
Ö, 
a
);

840 
	}
}

842 
	$h¬mËss_upd©e_ÃtwÜk_gpu
(
ÃtwÜk
 *
Ã
)

844 
ÃtwÜk
 
Ãt
 = *
Ã
;

845 
	`cuda_£t_deviû
(
Ãt
.
gpu_šdex
);

846 
i
;

847 
i
 = 0; i < 
Ãt
.
n
; ++i){

848 
Ïy”
 
l
 = 
Ãt
.
Ïy”s
[
i
];

849 if(
l
.
weight_upd©es_gpu
è
	`fl_gpu
Ö.
nweights
, 0,†.weight_updates_gpu, 1);

850 if(
l
.
bŸs_upd©es_gpu
è
	`fl_gpu
Ö.
nbŸ£s
, 0,†.bias_updates_gpu, 1);

851 if(
l
.
sÿË_upd©es_gpu
è
	`fl_gpu
Ö.
nbŸ£s
, 0,†.scale_updates_gpu, 1);

853 
	}
}

856 
ÃtwÜk
 *
	mÃt
;

857 
d©a
 
	md
;

858 *
	m”r
;

859 } 
	tŒaš_¬gs
;

861 *
	$Œaš_th»ad
(*
±r
)

863 
Œaš_¬gs
 
¬gs
 = *Ñ¿š_¬gs*)
±r
;

864 
	`ä“
(
±r
);

865 
	`cuda_£t_deviû
(
¬gs
.
Ãt
->
gpu_šdex
);

866 *
¬gs
.
”r
 = 
	`Œaš_ÃtwÜk
×rgs.
Ãt
,‡rgs.
d
);

868 
	}
}

870 
±h»ad_t
 
	$Œaš_ÃtwÜk_š_th»ad
(
ÃtwÜk
 *
Ãt
, 
d©a
 
d
, *
”r
)

872 
±h»ad_t
 
th»ad
;

873 
Œaš_¬gs
 *
±r
 = (Œaš_¬g *)
	`ÿÎoc
(1, (train_args));

874 
±r
->
Ãt
 =‚et;

875 
±r
->
d
 = d;

876 
±r
->
”r
 =ƒrr;

877 if(
	`±h»ad_ü—‹
(&
th»ad
, 0, 
Œaš_th»ad
, 
±r
)è
	`”rÜ
("Thread creation failed");

878  
th»ad
;

879 
	}
}

881 
	$m”ge_weights
(
Ïy”
 
l
,†ay” 
ba£
)

883 ià(
l
.
ty³
 =ğ
CONVOLUTIONAL
) {

884 
	`axpy_ıu
(
l
.
n
, 1,†.
bŸs_upd©es
, 1, 
ba£
.
bŸ£s
, 1);

885 
	`axpy_ıu
(
l
.
nweights
, 1,†.
weight_upd©es
, 1, 
ba£
.
weights
, 1);

886 ià(
l
.
sÿËs
) {

887 
	`axpy_ıu
(
l
.
n
, 1,†.
sÿË_upd©es
, 1, 
ba£
.
sÿËs
, 1);

889 } if(
l
.
ty³
 =ğ
CONNECTED
) {

890 
	`axpy_ıu
(
l
.
ouuts
, 1,†.
bŸs_upd©es
, 1, 
ba£
.
bŸ£s
, 1);

891 
	`axpy_ıu
(
l
.
ouuts
*l.
šputs
, 1,†.
weight_upd©es
, 1, 
ba£
.
weights
, 1);

893 
	}
}

895 
	$sÿË_weights
(
Ïy”
 
l
, 
s
)

897 ià(
l
.
ty³
 =ğ
CONVOLUTIONAL
) {

898 
	`sÿl_ıu
(
l
.
n
, 
s
,†.
bŸ£s
, 1);

899 
	`sÿl_ıu
(
l
.
nweights
, 
s
,†.
weights
, 1);

900 ià(
l
.
sÿËs
) {

901 
	`sÿl_ıu
(
l
.
n
, 
s
,†.
sÿËs
, 1);

903 } if(
l
.
ty³
 =ğ
CONNECTED
) {

904 
	`sÿl_ıu
(
l
.
ouuts
, 
s
,†.
bŸ£s
, 1);

905 
	`sÿl_ıu
(
l
.
ouuts
*l.
šputs
, 
s
,†.
weights
, 1);

907 
	}
}

910 
	$puÎ_weights
(
Ïy”
 
l
)

912 if(
l
.
ty³
 =ğ
CONVOLUTIONAL
 ||†.ty³ =ğ
DECONVOLUTIONAL
){

913 
	`cuda_puÎ_¬¿y
(
l
.
bŸ£s_gpu
,†.
bŸs_upd©es
,†.
n
);

914 
	`cuda_puÎ_¬¿y
(
l
.
weights_gpu
,†.
weight_upd©es
,†.
nweights
);

915 if(
l
.
sÿËs
è
	`cuda_puÎ_¬¿y
Ö.
sÿËs_gpu
,†.
sÿË_upd©es
,†.
n
);

916 } if(
l
.
ty³
 =ğ
CONNECTED
){

917 
	`cuda_puÎ_¬¿y
(
l
.
bŸ£s_gpu
,†.
bŸs_upd©es
,†.
ouuts
);

918 
	`cuda_puÎ_¬¿y
(
l
.
weights_gpu
,†.
weight_upd©es
,†.
ouuts
*l.
šputs
);

920 
	}
}

922 
	$push_weights
(
Ïy”
 
l
)

924 if(
l
.
ty³
 =ğ
CONVOLUTIONAL
 ||†.ty³ =ğ
DECONVOLUTIONAL
){

925 
	`cuda_push_¬¿y
(
l
.
bŸ£s_gpu
,†.
bŸ£s
,†.
n
);

926 
	`cuda_push_¬¿y
(
l
.
weights_gpu
,†.
weights
,†.
nweights
);

927 if(
l
.
sÿËs
è
	`cuda_push_¬¿y
Ö.
sÿËs_gpu
,†.sÿËs,†.
n
);

928 } if(
l
.
ty³
 =ğ
CONNECTED
){

929 
	`cuda_push_¬¿y
(
l
.
bŸ£s_gpu
,†.
bŸ£s
,†.
ouuts
);

930 
	`cuda_push_¬¿y
(
l
.
weights_gpu
,†.
weights
,†.
ouuts
*l.
šputs
);

932 
	}
}

934 
	$di¡ribu‹_weights
(
Ïy”
 
l
,†ay” 
ba£
)

936 ià(
l
.
ty³
 =ğ
CONVOLUTIONAL
 ||†.ty³ =ğ
DECONVOLUTIONAL
) {

937 
	`cuda_push_¬¿y
(
l
.
bŸ£s_gpu
, 
ba£
.
bŸ£s
,†.
n
);

938 
	`cuda_push_¬¿y
(
l
.
weights_gpu
, 
ba£
.
weights
,†.
nweights
);

939 ià(
ba£
.
sÿËs
è
	`cuda_push_¬¿y
(
l
.
sÿËs_gpu
, ba£.sÿËs,†.
n
);

940 } ià(
l
.
ty³
 =ğ
CONNECTED
) {

941 
	`cuda_push_¬¿y
(
l
.
bŸ£s_gpu
, 
ba£
.
bŸ£s
,†.
ouuts
);

942 
	`cuda_push_¬¿y
(
l
.
weights_gpu
, 
ba£
.
weights
,†.
ouuts
*l.
šputs
);

944 
	}
}

1031 
	$sync_Ïy”
(
ÃtwÜk
 **
Ãts
, 
n
, 
j
)

1033 
i
;

1034 
ÃtwÜk
 *
Ãt
 = 
Ãts
[0];

1035 
Ïy”
 
ba£
 = 
Ãt
->
Ïy”s
[
j
];

1036 
	`sÿË_weights
(
ba£
, 0);

1037 
i
 = 0; i < 
n
; ++i) {

1038 
	`cuda_£t_deviû
(
Ãts
[
i
]->
gpu_šdex
);

1039 
Ïy”
 
l
 = 
Ãts
[
i
]->
Ïy”s
[
j
];

1040 
	`puÎ_weights
(
l
);

1041 
	`m”ge_weights
(
l
, 
ba£
);

1043 
	`sÿË_weights
(
ba£
, 1./
n
);

1044 
i
 = 0; i < 
n
; ++i) {

1045 
	`cuda_£t_deviû
(
Ãts
[
i
]->
gpu_šdex
);

1046 
Ïy”
 
l
 = 
Ãts
[
i
]->
Ïy”s
[
j
];

1047 
	`di¡ribu‹_weights
(
l
, 
ba£
);

1049 
	}
}

1052 
ÃtwÜk
 **
	mÃts
;

1053 
	mn
;

1054 
	mj
;

1055 } 
	tsync_¬gs
;

1057 *
	$sync_Ïy”_th»ad
(*
±r
)

1059 
sync_¬gs
 
¬gs
 = *(sync_¬gs*)
±r
;

1060 
	`sync_Ïy”
(
¬gs
.
Ãts
,‡rgs.
n
,‡rgs.
j
);

1061 
	`ä“
(
±r
);

1063 
	}
}

1065 
±h»ad_t
 
	$sync_Ïy”_š_th»ad
(
ÃtwÜk
 **
Ãts
, 
n
, 
j
)

1067 
±h»ad_t
 
th»ad
;

1068 
sync_¬gs
 *
±r
 = (sync_¬g *)
	`ÿÎoc
(1, (sync_args));

1069 
±r
->
Ãts
 =‚ets;

1070 
±r
->
n
 =‚;

1071 
±r
->
j
 = j;

1072 if(
	`±h»ad_ü—‹
(&
th»ad
, 0, 
sync_Ïy”_th»ad
, 
±r
)è
	`”rÜ
("Thread creation failed");

1073  
th»ad
;

1074 
	}
}

1076 
	$sync_Ãts
(
ÃtwÜk
 **
Ãts
, 
n
, 
š‹rv®
)

1078 
j
;

1079 
Ïy”s
 = 
Ãts
[0]->
n
;

1080 
±h»ad_t
 *
th»ads
 = (±h»ad_ˆ*è
	`ÿÎoc
(
Ïy”s
, (pthread_t));

1082 *(
Ãts
[0]->
£’
è+ğ
š‹rv®
 * (
n
-1è*‚‘s[0]->
b©ch
 *‚‘s[0]->
subdivisiÚs
;

1083 
j
 = 0; j < 
n
; ++j){

1084 *(
Ãts
[
j
]->
£’
) = *(nets[0]->seen);

1086 
j
 = 0; j < 
Ïy”s
; ++j) {

1087 
th»ads
[
j
] = 
	`sync_Ïy”_š_th»ad
(
Ãts
, 
n
, j);

1089 
j
 = 0; j < 
Ïy”s
; ++j) {

1090 
	`±h»ad_još
(
th»ads
[
j
], 0);

1092 
	`ä“
(
th»ads
);

1093 
	}
}

1095 
	$Œaš_ÃtwÜks
(
ÃtwÜk
 **
Ãts
, 
n
, 
d©a
 
d
, 
š‹rv®
)

1097 
i
;

1098 
b©ch
 = 
Ãts
[0]->batch;

1099 
subdivisiÚs
 = 
Ãts
[0]->subdivisions;

1100 
	`as£¹
(
b©ch
 * 
subdivisiÚs
 * 
n
 =ğ
d
.
X
.
rows
);

1101 
±h»ad_t
 *
th»ads
 = (±h»ad_ˆ*è
	`ÿÎoc
(
n
, (pthread_t));

1102 *
”rÜs
 = (*è
	`ÿÎoc
(
n
, ());

1104 
sum
 = 0;

1105 
i
 = 0; i < 
n
; ++i){

1106 
d©a
 
p
 = 
	`g‘_d©a_·¹
(
d
, 
i
, 
n
);

1107 
th»ads
[
i
] = 
	`Œaš_ÃtwÜk_š_th»ad
(
Ãts
[i], 
p
, 
”rÜs
 + i);

1109 
i
 = 0; i < 
n
; ++i){

1110 
	`±h»ad_još
(
th»ads
[
i
], 0);

1112 
sum
 +ğ
”rÜs
[
i
];

1115 ià(
	`g‘_cu¼’t_b©ch
(
Ãts
[0]è% 
š‹rv®
 == 0) {

1116 
	`´štf
("Syncing... ");

1117 
	`fæush
(
¡dout
);

1118 
	`sync_Ãts
(
Ãts
, 
n
, 
š‹rv®
);

1119 
	`´štf
("Done!\n");

1122 
	`ä“
(
th»ads
);

1123 
	`ä“
(
”rÜs
);

1124  ()
sum
/(
n
);

1125 
	}
}

1127 
	$puÎ_ÃtwÜk_ouut
(
ÃtwÜk
 *
Ãt
)

1129 
Ïy”
 
l
 = 
	`g‘_ÃtwÜk_ouut_Ïy”
(
Ãt
);

1130 
	`cuda_puÎ_¬¿y
(
l
.
ouut_gpu
,†.
ouut
,†.
ouuts
*l.
b©ch
);

1131 
	}
}

	@network.h

2 #iâdeà
NETWORK_H


3 
	#NETWORK_H


	)

4 
	~"d¬kÃt.h
"

6 
	~"image.h
"

7 
	~"Ïy”.h
"

8 
	~"d©a.h
"

9 
	~"Œ“.h
"

12 #ifdeà
GPU


13 
puÎ_ÃtwÜk_ouut
(
ÃtwÜk
 *
Ãt
);

16 
com·»_ÃtwÜks
(
ÃtwÜk
 *
n1
,‚‘wÜk *
n2
, 
d©a
 
d
);

17 *
g‘_Ïy”_¡ršg
(
LAYER_TYPE
 
a
);

19 
ÃtwÜk
 *
make_ÃtwÜk
(
n
);

22 
ÃtwÜk_accu¿cy_muÉi
(
ÃtwÜk
 *
Ãt
, 
d©a
 
d
, 
n
);

23 
g‘_´ediùed_şass_ÃtwÜk
(
ÃtwÜk
 *
Ãt
);

24 
´št_ÃtwÜk
(
ÃtwÜk
 *
Ãt
);

25 
»size_ÃtwÜk
(
ÃtwÜk
 *
Ãt
, 
w
, 
h
);

26 
ÿlc_ÃtwÜk_co¡
(
ÃtwÜk
 *
Ãt
);

	@normalization_layer.c

1 
	~"nÜm®iz©iÚ_Ïy”.h
"

2 
	~"bÏs.h
"

4 
	~<¡dio.h
>

6 
Ïy”
 
	$make_nÜm®iz©iÚ_Ïy”
(
b©ch
, 
w
, 
h
, 
c
, 
size
, 
®pha
, 
b‘a
, 
k­·
)

8 
	`årštf
(
¡d”r
, "LoÿÈRe¥Ú£ NÜm®iz©iÚ Lay”: %d x %d x %d image, %d size\n", 
w
,
h
,
c
,
size
);

9 
Ïy”
†ayer = {0};

10 
Ïy”
.
ty³
 = 
NORMALIZATION
;

11 
Ïy”
.
b©ch
 = batch;

12 
Ïy”
.
h
 =†ay”.
out_h
 = h;

13 
Ïy”
.
w
 =†ay”.
out_w
 = w;

14 
Ïy”
.
c
 =†ay”.
out_c
 = c;

15 
Ïy”
.
k­·
 = kappa;

16 
Ïy”
.
size
 = size;

17 
Ïy”
.
®pha
 =‡lpha;

18 
Ïy”
.
b‘a
 = beta;

19 
Ïy”
.
ouut
 = 
	`ÿÎoc
(
h
 * 
w
 * 
c
 * 
b©ch
, ());

20 
Ïy”
.
d–
 = 
	`ÿÎoc
(
h
 * 
w
 * 
c
 * 
b©ch
, ());

21 
Ïy”
.
squ¬ed
 = 
	`ÿÎoc
(
h
 * 
w
 * 
c
 * 
b©ch
, ());

22 
Ïy”
.
nÜms
 = 
	`ÿÎoc
(
h
 * 
w
 * 
c
 * 
b©ch
, ());

23 
Ïy”
.
šputs
 = 
w
*
h
*
c
;

24 
Ïy”
.
ouuts
 =†ay”.
šputs
;

26 
Ïy”
.
fÜw¬d
 = 
fÜw¬d_nÜm®iz©iÚ_Ïy”
;

27 
Ïy”
.
backw¬d
 = 
backw¬d_nÜm®iz©iÚ_Ïy”
;

28 #ifdeà
GPU


29 
Ïy”
.
fÜw¬d_gpu
 = 
fÜw¬d_nÜm®iz©iÚ_Ïy”_gpu
;

30 
Ïy”
.
backw¬d_gpu
 = 
backw¬d_nÜm®iz©iÚ_Ïy”_gpu
;

32 
Ïy”
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Öay”.
ouut
, 
h
 * 
w
 * 
c
 * 
b©ch
);

33 
Ïy”
.
d–_gpu
 = 
	`cuda_make_¬¿y
Öay”.
d–
, 
h
 * 
w
 * 
c
 * 
b©ch
);

34 
Ïy”
.
squ¬ed_gpu
 = 
	`cuda_make_¬¿y
Öay”.
squ¬ed
, 
h
 * 
w
 * 
c
 * 
b©ch
);

35 
Ïy”
.
nÜms_gpu
 = 
	`cuda_make_¬¿y
Öay”.
nÜms
, 
h
 * 
w
 * 
c
 * 
b©ch
);

37  
Ïy”
;

38 
	}
}

40 
	$»size_nÜm®iz©iÚ_Ïy”
(
Ïy”
 *Ïy”, 
w
, 
h
)

42 
c
 = 
Ïy”
->c;

43 
b©ch
 = 
Ïy”
->batch;

44 
Ïy”
->
h
 = h;

45 
Ïy”
->
w
 = w;

46 
Ïy”
->
out_h
 = 
h
;

47 
Ïy”
->
out_w
 = 
w
;

48 
Ïy”
->
šputs
 = 
w
*
h
*
c
;

49 
Ïy”
->
ouuts
 =†ay”->
šputs
;

50 
Ïy”
->
ouut
 = 
	`»®loc
Öay”->ouut, 
h
 * 
w
 * 
c
 * 
b©ch
 * ());

51 
Ïy”
->
d–
 = 
	`»®loc
Öay”->d–, 
h
 * 
w
 * 
c
 * 
b©ch
 * ());

52 
Ïy”
->
squ¬ed
 = 
	`»®loc
Öay”->squ¬ed, 
h
 * 
w
 * 
c
 * 
b©ch
 * ());

53 
Ïy”
->
nÜms
 = 
	`»®loc
Öay”->nÜms, 
h
 * 
w
 * 
c
 * 
b©ch
 * ());

54 #ifdeà
GPU


55 
	`cuda_ä“
(
Ïy”
->
ouut_gpu
);

56 
	`cuda_ä“
(
Ïy”
->
d–_gpu
);

57 
	`cuda_ä“
(
Ïy”
->
squ¬ed_gpu
);

58 
	`cuda_ä“
(
Ïy”
->
nÜms_gpu
);

59 
Ïy”
->
ouut_gpu
 = 
	`cuda_make_¬¿y
Öay”->
ouut
, 
h
 * 
w
 * 
c
 * 
b©ch
);

60 
Ïy”
->
d–_gpu
 = 
	`cuda_make_¬¿y
Öay”->
d–
, 
h
 * 
w
 * 
c
 * 
b©ch
);

61 
Ïy”
->
squ¬ed_gpu
 = 
	`cuda_make_¬¿y
Öay”->
squ¬ed
, 
h
 * 
w
 * 
c
 * 
b©ch
);

62 
Ïy”
->
nÜms_gpu
 = 
	`cuda_make_¬¿y
Öay”->
nÜms
, 
h
 * 
w
 * 
c
 * 
b©ch
);

64 
	}
}

66 
	$fÜw¬d_nÜm®iz©iÚ_Ïy”
(cÚ¡ 
Ïy”
†ay”, 
ÃtwÜk
 
Ãt
)

68 
k
,
b
;

69 
w
 = 
Ïy”
.w;

70 
h
 = 
Ïy”
.h;

71 
c
 = 
Ïy”
.c;

72 
	`sÿl_ıu
(
w
*
h
*
c
*
Ïy”
.
b©ch
, 0,†ay”.
squ¬ed
, 1);

74 
b
 = 0; b < 
Ïy”
.
b©ch
; ++b){

75 *
squ¬ed
 = 
Ïy”
.squ¬ed + 
w
*
h
*
c
*
b
;

76 *
nÜms
 = 
Ïy”
.nÜm + 
w
*
h
*
c
*
b
;

77 *
šput
 = 
Ãt
.špuˆ+ 
w
*
h
*
c
*
b
;

78 
	`pow_ıu
(
w
*
h
*
c
, 2, 
šput
, 1, 
squ¬ed
, 1);

80 
	`cÚ¡_ıu
(
w
*
h
, 
Ïy”
.
k­·
, 
nÜms
, 1);

81 
k
 = 0; k < 
Ïy”
.
size
/2; ++k){

82 
	`axpy_ıu
(
w
*
h
, 
Ïy”
.
®pha
, 
squ¬ed
 + w*h*
k
, 1, 
nÜms
, 1);

85 
k
 = 1; k < 
Ïy”
.
c
; ++k){

86 
	`cİy_ıu
(
w
*
h
, 
nÜms
 + w*h*(
k
-1), 1,‚orms + w*h*k, 1);

87 
´ev
 = 
k
 - ((
Ïy”
.
size
-1)/2) - 1;

88 
Ãxt
 = 
k
 + (
Ïy”
.
size
/2);

89 if(
´ev
 >ğ0è
	`axpy_ıu
(
w
*
h
, -
Ïy”
.
®pha
, 
squ¬ed
 + w*h*´ev, 1, 
nÜms
 + w*h*
k
, 1);

90 if(
Ãxt
 < 
Ïy”
.
c
è
	`axpy_ıu
(
w
*
h
,†ay”.
®pha
, 
squ¬ed
 + w*h*Ãxt, 1, 
nÜms
 + w*h*
k
, 1);

93 
	`pow_ıu
(
w
*
h
*
c
*
Ïy”
.
b©ch
, -Ïy”.
b‘a
,†ay”.
nÜms
, 1,†ay”.
ouut
, 1);

94 
	`mul_ıu
(
w
*
h
*
c
*
Ïy”
.
b©ch
, 
Ãt
.
šput
, 1,†ay”.
ouut
, 1);

95 
	}
}

97 
	$backw¬d_nÜm®iz©iÚ_Ïy”
(cÚ¡ 
Ïy”
†ay”, 
ÃtwÜk
 
Ãt
)

102 
w
 = 
Ïy”
.w;

103 
h
 = 
Ïy”
.h;

104 
c
 = 
Ïy”
.c;

105 
	`pow_ıu
(
w
*
h
*
c
*
Ïy”
.
b©ch
, -Ïy”.
b‘a
,†ay”.
nÜms
, 1, 
Ãt
.
d–
, 1);

106 
	`mul_ıu
(
w
*
h
*
c
*
Ïy”
.
b©ch
,†ay”.
d–
, 1, 
Ãt
.delta, 1);

107 
	}
}

109 #ifdeà
GPU


110 
	$fÜw¬d_nÜm®iz©iÚ_Ïy”_gpu
(cÚ¡ 
Ïy”
†ay”, 
ÃtwÜk
 
Ãt
)

112 
k
,
b
;

113 
w
 = 
Ïy”
.w;

114 
h
 = 
Ïy”
.h;

115 
c
 = 
Ïy”
.c;

116 
	`sÿl_gpu
(
w
*
h
*
c
*
Ïy”
.
b©ch
, 0,†ay”.
squ¬ed_gpu
, 1);

118 
b
 = 0; b < 
Ïy”
.
b©ch
; ++b){

119 *
squ¬ed
 = 
Ïy”
.
squ¬ed_gpu
 + 
w
*
h
*
c
*
b
;

120 *
nÜms
 = 
Ïy”
.
nÜms_gpu
 + 
w
*
h
*
c
*
b
;

121 *
šput
 = 
Ãt
.
šput_gpu
 + 
w
*
h
*
c
*
b
;

122 
	`pow_gpu
(
w
*
h
*
c
, 2, 
šput
, 1, 
squ¬ed
, 1);

124 
	`cÚ¡_gpu
(
w
*
h
, 
Ïy”
.
k­·
, 
nÜms
, 1);

125 
k
 = 0; k < 
Ïy”
.
size
/2; ++k){

126 
	`axpy_gpu
(
w
*
h
, 
Ïy”
.
®pha
, 
squ¬ed
 + w*h*
k
, 1, 
nÜms
, 1);

129 
k
 = 1; k < 
Ïy”
.
c
; ++k){

130 
	`cİy_gpu
(
w
*
h
, 
nÜms
 + w*h*(
k
-1), 1,‚orms + w*h*k, 1);

131 
´ev
 = 
k
 - ((
Ïy”
.
size
-1)/2) - 1;

132 
Ãxt
 = 
k
 + (
Ïy”
.
size
/2);

133 if(
´ev
 >ğ0è
	`axpy_gpu
(
w
*
h
, -
Ïy”
.
®pha
, 
squ¬ed
 + w*h*´ev, 1, 
nÜms
 + w*h*
k
, 1);

134 if(
Ãxt
 < 
Ïy”
.
c
è
	`axpy_gpu
(
w
*
h
,†ay”.
®pha
, 
squ¬ed
 + w*h*Ãxt, 1, 
nÜms
 + w*h*
k
, 1);

137 
	`pow_gpu
(
w
*
h
*
c
*
Ïy”
.
b©ch
, -Ïy”.
b‘a
,†ay”.
nÜms_gpu
, 1,†ay”.
ouut_gpu
, 1);

138 
	`mul_gpu
(
w
*
h
*
c
*
Ïy”
.
b©ch
, 
Ãt
.
šput_gpu
, 1,†ay”.
ouut_gpu
, 1);

139 
	}
}

141 
	$backw¬d_nÜm®iz©iÚ_Ïy”_gpu
(cÚ¡ 
Ïy”
†ay”, 
ÃtwÜk
 
Ãt
)

145 
w
 = 
Ïy”
.w;

146 
h
 = 
Ïy”
.h;

147 
c
 = 
Ïy”
.c;

148 
	`pow_gpu
(
w
*
h
*
c
*
Ïy”
.
b©ch
, -Ïy”.
b‘a
,†ay”.
nÜms_gpu
, 1, 
Ãt
.
d–_gpu
, 1);

149 
	`mul_gpu
(
w
*
h
*
c
*
Ïy”
.
b©ch
,†ay”.
d–_gpu
, 1, 
Ãt
.delta_gpu, 1);

150 
	}
}

	@normalization_layer.h

1 #iâdeà
NORMALIZATION_LAYER_H


2 
	#NORMALIZATION_LAYER_H


	)

4 
	~"image.h
"

5 
	~"Ïy”.h
"

6 
	~"ÃtwÜk.h
"

8 
Ïy”
 
make_nÜm®iz©iÚ_Ïy”
(
b©ch
, 
w
, 
h
, 
c
, 
size
, 
®pha
, 
b‘a
, 
k­·
);

9 
»size_nÜm®iz©iÚ_Ïy”
(
Ïy”
 *Ïy”, 
h
, 
w
);

10 
fÜw¬d_nÜm®iz©iÚ_Ïy”
(cÚ¡ 
Ïy”
†ay”, 
ÃtwÜk
 
Ãt
);

11 
backw¬d_nÜm®iz©iÚ_Ïy”
(cÚ¡ 
Ïy”
†ay”, 
ÃtwÜk
 
Ãt
);

12 
visu®ize_nÜm®iz©iÚ_Ïy”
(
Ïy”
†ay”, *
wšdow
);

14 #ifdeà
GPU


15 
fÜw¬d_nÜm®iz©iÚ_Ïy”_gpu
(cÚ¡ 
Ïy”
†ay”, 
ÃtwÜk
 
Ãt
);

16 
backw¬d_nÜm®iz©iÚ_Ïy”_gpu
(cÚ¡ 
Ïy”
†ay”, 
ÃtwÜk
 
Ãt
);

	@option_list.c

1 
	~<¡dlib.h
>

2 
	~<¡dio.h
>

3 
	~<¡ršg.h
>

4 
	~"İtiÚ_li¡.h
"

5 
	~"uts.h
"

7 
li¡
 *
	$»ad_d©a_cfg
(*
f’ame
)

9 
FILE
 *
fe
 = 
	`fİ’
(
f’ame
, "r");

10 if(
fe
 =ğ0è
	`fe_”rÜ
(
f’ame
);

11 *
lše
;

12 
nu
 = 0;

13 
li¡
 *
İtiÚs
 = 
	`make_li¡
();

14 (
lše
=
	`fg‘l
(
fe
)) != 0){

15 ++ 
nu
;

16 
	`¡r
(
lše
);

17 
lše
[0]){

21 
	`ä“
(
lše
);

24 if(!
	`»ad_İtiÚ
(
lše
, 
İtiÚs
)){

25 
	`årštf
(
¡d”r
, "CÚfig f”rÜ†š%d, could…¬£: %s\n", 
nu
, 
lše
);

26 
	`ä“
(
lše
);

31 
	`fşo£
(
fe
);

32  
İtiÚs
;

33 
	}
}

35 
m‘ad©a
 
	$g‘_m‘ad©a
(*
fe
)

37 
m‘ad©a
 
m
 = {0};

38 
li¡
 *
İtiÚs
 = 
	`»ad_d©a_cfg
(
fe
);

40 *
Çme_li¡
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "names", 0);

41 if(!
Çme_li¡
èÇme_li¡ = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "labels", 0);

42 if(!
Çme_li¡
) {

43 
	`årštf
(
¡d”r
, "No‚ames or†abels found\n");

45 
m
.
Çmes
 = 
	`g‘_Ïb–s
(
Çme_li¡
);

47 
m
.
şas£s
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "classes", 2);

48 
	`ä“_li¡
(
İtiÚs
);

49  
m
;

50 
	}
}

52 
	$»ad_İtiÚ
(*
s
, 
li¡
 *
İtiÚs
)

54 
size_t
 
i
;

55 
size_t
 
Ën
 = 
	`¡¾’
(
s
);

56 *
v®
 = 0;

57 
i
 = 0; i < 
Ën
; ++i){

58 if(
s
[
i
] == '='){

59 
s
[
i
] = '\0';

60 
v®
 = 
s
+
i
+1;

64 if(
i
 =ğ
Ën
-1)  0;

65 *
key
 = 
s
;

66 
	`İtiÚ_š£¹
(
İtiÚs
, 
key
, 
v®
);

68 
	}
}

70 
	$İtiÚ_š£¹
(
li¡
 *
l
, *
key
, *
v®
)

72 
kvp
 *
p
 = 
	`m®loc
((kvp));

73 
p
->
key
 = key;

74 
p
->
v®
 = val;

75 
p
->
u£d
 = 0;

76 
	`li¡_š£¹
(
l
, 
p
);

77 
	}
}

79 
	$İtiÚ_unu£d
(
li¡
 *
l
)

81 
node
 *
n
 = 
l
->
äÚt
;

82 
n
){

83 
kvp
 *
p
 = (kv°*)
n
->
v®
;

84 if(!
p
->
u£d
){

85 
	`årštf
(
¡d”r
, "Unu£d f›ld: '% ğ%s'\n", 
p
->
key
,…->
v®
);

87 
n
 =‚->
Ãxt
;

89 
	}
}

91 *
	$İtiÚ_fšd
(
li¡
 *
l
, *
key
)

93 
node
 *
n
 = 
l
->
äÚt
;

94 
n
){

95 
kvp
 *
p
 = (kv°*)
n
->
v®
;

96 if(
	`¡rcmp
(
p
->
key
, key) == 0){

97 
p
->
u£d
 = 1;

98  
p
->
v®
;

100 
n
 =‚->
Ãxt
;

103 
	}
}

104 *
	$İtiÚ_fšd_¡r
(
li¡
 *
l
, *
key
, *
def
)

106 *
v
 = 
	`İtiÚ_fšd
(
l
, 
key
);

107 if(
v
)  v;

108 if(
def
è
	`årštf
(
¡d”r
, "%s: Usšg deçuÉ '%s'\n", 
key
, def);

109  
def
;

110 
	}
}

112 
	$İtiÚ_fšd_št
(
li¡
 *
l
, *
key
, 
def
)

114 *
v
 = 
	`İtiÚ_fšd
(
l
, 
key
);

115 if(
v
è 
	`©oi
(v);

116 
	`årštf
(
¡d”r
, "%s: Usšg deçuÉ '%d'\n", 
key
, 
def
);

117  
def
;

118 
	}
}

120 
	$İtiÚ_fšd_št_qu›t
(
li¡
 *
l
, *
key
, 
def
)

122 *
v
 = 
	`İtiÚ_fšd
(
l
, 
key
);

123 if(
v
è 
	`©oi
(v);

124  
def
;

125 
	}
}

127 
	$İtiÚ_fšd_æßt_qu›t
(
li¡
 *
l
, *
key
, 
def
)

129 *
v
 = 
	`İtiÚ_fšd
(
l
, 
key
);

130 if(
v
è 
	`©of
(v);

131  
def
;

132 
	}
}

134 
	$İtiÚ_fšd_æßt
(
li¡
 *
l
, *
key
, 
def
)

136 *
v
 = 
	`İtiÚ_fšd
(
l
, 
key
);

137 if(
v
è 
	`©of
(v);

138 
	`årštf
(
¡d”r
, "%s: Usšg deçuÉ '%lf'\n", 
key
, 
def
);

139  
def
;

140 
	}
}

	@option_list.h

1 #iâdeà
OPTION_LIST_H


2 
	#OPTION_LIST_H


	)

3 
	~"li¡.h
"

6 *
	mkey
;

7 *
	mv®
;

8 
	mu£d
;

9 } 
	tkvp
;

12 
»ad_İtiÚ
(*
s
, 
li¡
 *
İtiÚs
);

13 
İtiÚ_š£¹
(
li¡
 *
l
, *
key
, *
v®
);

14 *
İtiÚ_fšd
(
li¡
 *
l
, *
key
);

15 
İtiÚ_fšd_æßt
(
li¡
 *
l
, *
key
, 
def
);

16 
İtiÚ_fšd_æßt_qu›t
(
li¡
 *
l
, *
key
, 
def
);

17 
İtiÚ_unu£d
(
li¡
 *
l
);

	@parser.c

1 
	~<¡dio.h
>

2 
	~<¡ršg.h
>

3 
	~<¡dlib.h
>

4 
	~<as£¹.h
>

6 
	~"aùiv©iÚ_Ïy”.h
"

7 
	~"logi¡ic_Ïy”.h
"

8 
	~"l2nÜm_Ïy”.h
"

9 
	~"aùiv©iÚs.h
"

10 
	~"avgpoŞ_Ïy”.h
"

11 
	~"b©chnÜm_Ïy”.h
"

12 
	~"bÏs.h
"

13 
	~"cÚÃùed_Ïy”.h
"

14 
	~"decÚvŞutiÚ®_Ïy”.h
"

15 
	~"cÚvŞutiÚ®_Ïy”.h
"

16 
	~"co¡_Ïy”.h
"

17 
	~"üÂ_Ïy”.h
"

18 
	~"üİ_Ïy”.h
"

19 
	~"d‘eùiÚ_Ïy”.h
"

20 
	~"drİout_Ïy”.h
"

21 
	~"gru_Ïy”.h
"

22 
	~"li¡.h
"

23 
	~"loÿl_Ïy”.h
"

24 
	~"maxpoŞ_Ïy”.h
"

25 
	~"nÜm®iz©iÚ_Ïy”.h
"

26 
	~"İtiÚ_li¡.h
"

27 
	~"·r£r.h
"

28 
	~"»giÚ_Ïy”.h
"

29 
	~"yŞo_Ïy”.h
"

30 
	~"»Üg_Ïy”.h
"

31 
	~"ºn_Ïy”.h
"

32 
	~"rou‹_Ïy”.h
"

33 
	~"up§m¶e_Ïy”.h
"

34 
	~"shÜtcut_Ïy”.h
"

35 
	~"soámax_Ïy”.h
"

36 
	~"l¡m_Ïy”.h
"

37 
	~"uts.h
"

40 *
	mty³
;

41 
li¡
 *
	mİtiÚs
;

42 }
	t£ùiÚ
;

44 
li¡
 *
»ad_cfg
(*
f’ame
);

46 
LAYER_TYPE
 
	$¡ršg_to_Ïy”_ty³
(* 
ty³
)

49 ià(
	`¡rcmp
(
ty³
, "[shÜtcut]")==0è 
SHORTCUT
;

50 ià(
	`¡rcmp
(
ty³
, "[üİ]")==0è 
CROP
;

51 ià(
	`¡rcmp
(
ty³
, "[co¡]")==0è 
COST
;

52 ià(
	`¡rcmp
(
ty³
, "[d‘eùiÚ]")==0è 
DETECTION
;

53 ià(
	`¡rcmp
(
ty³
, "[»giÚ]")==0è 
REGION
;

54 ià(
	`¡rcmp
(
ty³
, "[yŞo]")==0è 
YOLO
;

55 ià(
	`¡rcmp
(
ty³
, "[loÿl]")==0è 
LOCAL
;

56 ià(
	`¡rcmp
(
ty³
, "[conv]")==0

57 || 
	`¡rcmp
(
ty³
, "[cÚvŞutiÚ®]")==0è 
CONVOLUTIONAL
;

58 ià(
	`¡rcmp
(
ty³
, "[deconv]")==0

59 || 
	`¡rcmp
(
ty³
, "[decÚvŞutiÚ®]")==0è 
DECONVOLUTIONAL
;

60 ià(
	`¡rcmp
(
ty³
, "[aùiv©iÚ]")==0è 
ACTIVE
;

61 ià(
	`¡rcmp
(
ty³
, "[logi¡ic]")==0è 
LOGXENT
;

62 ià(
	`¡rcmp
(
ty³
, "[l2nÜm]")==0è 
L2NORM
;

63 ià(
	`¡rcmp
(
ty³
, "[net]")==0

64 || 
	`¡rcmp
(
ty³
, "[ÃtwÜk]")==0è 
NETWORK
;

65 ià(
	`¡rcmp
(
ty³
, "[üÂ]")==0è 
CRNN
;

66 ià(
	`¡rcmp
(
ty³
, "[gru]")==0è 
GRU
;

67 ià(
	`¡rcmp
(
ty³
, "[l¡m]"è=ğ0è 
LSTM
;

68 ià(
	`¡rcmp
(
ty³
, "[ºn]")==0è 
RNN
;

69 ià(
	`¡rcmp
(
ty³
, "[conn]")==0

70 || 
	`¡rcmp
(
ty³
, "[cÚÃùed]")==0è 
CONNECTED
;

71 ià(
	`¡rcmp
(
ty³
, "[max]")==0

72 || 
	`¡rcmp
(
ty³
, "[maxpoŞ]")==0è 
MAXPOOL
;

73 ià(
	`¡rcmp
(
ty³
, "[»Üg]")==0è 
REORG
;

74 ià(
	`¡rcmp
(
ty³
, "[avg]")==0

75 || 
	`¡rcmp
(
ty³
, "[avgpoŞ]")==0è 
AVGPOOL
;

76 ià(
	`¡rcmp
(
ty³
, "[drİout]")==0è 
DROPOUT
;

77 ià(
	`¡rcmp
(
ty³
, "[lrn]")==0

78 || 
	`¡rcmp
(
ty³
, "[nÜm®iz©iÚ]")==0è 
NORMALIZATION
;

79 ià(
	`¡rcmp
(
ty³
, "[b©chnÜm]")==0è 
BATCHNORM
;

80 ià(
	`¡rcmp
(
ty³
, "[soft]")==0

81 || 
	`¡rcmp
(
ty³
, "[soámax]")==0è 
SOFTMAX
;

82 ià(
	`¡rcmp
(
ty³
, "[rou‹]")==0è 
ROUTE
;

83 ià(
	`¡rcmp
(
ty³
, "[up§m¶e]")==0è 
UPSAMPLE
;

84  
BLANK
;

85 
	}
}

87 
	$ä“_£ùiÚ
(
£ùiÚ
 *
s
)

89 
	`ä“
(
s
->
ty³
);

90 
node
 *
n
 = 
s
->
İtiÚs
->
äÚt
;

91 
n
){

92 
kvp
 *
·œ
 = (kv°*)
n
->
v®
;

93 
	`ä“
(
·œ
->
key
);

94 
	`ä“
(
·œ
);

95 
node
 *
Ãxt
 = 
n
->next;

96 
	`ä“
(
n
);

97 
n
 = 
Ãxt
;

99 
	`ä“
(
s
->
İtiÚs
);

100 
	`ä“
(
s
);

101 
	}
}

103 
	$·r£_d©a
(*
d©a
, *
a
, 
n
)

105 
i
;

106 if(!
d©a
) ;

107 *
cu¼
 = 
d©a
;

108 *
Ãxt
 = 
d©a
;

109 
dÚe
 = 0;

110 
i
 = 0; i < 
n
 && !
dÚe
; ++i){

111 *++
Ãxt
 !='\0' && *next != ',');

112 if(*
Ãxt
 =ğ'\0'è
dÚe
 = 1;

113 *
Ãxt
 = '\0';

114 
	`ssÿnf
(
cu¼
, "%g", &
a
[
i
]);

115 
cu¼
 = 
Ãxt
+1;

117 
	}
}

119 
	ssize_·¿ms
{

120 
	mb©ch
;

121 
	mšputs
;

122 
	mh
;

123 
	mw
;

124 
	mc
;

125 
	mšdex
;

126 
	mtime_¡•s
;

127 
ÃtwÜk
 *
	mÃt
;

128 } 
	tsize_·¿ms
;

130 
loÿl_Ïy”
 
	$·r£_loÿl
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

132 
n
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "filters",1);

133 
size
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "size",1);

134 
¡ride
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "stride",1);

135 
·d
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "pad",0);

136 *
aùiv©iÚ_s
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "activation", "logistic");

137 
ACTIVATION
 
aùiv©iÚ
 = 
	`g‘_aùiv©iÚ
(
aùiv©iÚ_s
);

139 
b©ch
,
h
,
w
,
c
;

140 
h
 = 
·¿ms
.h;

141 
w
 = 
·¿ms
.w;

142 
c
 = 
·¿ms
.c;

143 
b©ch
=
·¿ms
.batch;

144 if(!(
h
 && 
w
 && 
c
)è
	`”rÜ
("Layer before†ocal†ayer must output image.");

146 
loÿl_Ïy”
 
Ïy”
 = 
	`make_loÿl_Ïy”
(
b©ch
,
h
,
w
,
c
,
n
,
size
,
¡ride
,
·d
,
aùiv©iÚ
);

148  
Ïy”
;

149 
	}
}

151 
Ïy”
 
	$·r£_decÚvŞutiÚ®
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

153 
n
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "filters",1);

154 
size
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "size",1);

155 
¡ride
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "stride",1);

157 *
aùiv©iÚ_s
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "activation", "logistic");

158 
ACTIVATION
 
aùiv©iÚ
 = 
	`g‘_aùiv©iÚ
(
aùiv©iÚ_s
);

160 
b©ch
,
h
,
w
,
c
;

161 
h
 = 
·¿ms
.h;

162 
w
 = 
·¿ms
.w;

163 
c
 = 
·¿ms
.c;

164 
b©ch
=
·¿ms
.batch;

165 if(!(
h
 && 
w
 && 
c
)è
	`”rÜ
("Layer before deconvolutional†ayer must output image.");

166 
b©ch_nÜm®ize
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "batch_normalize", 0);

167 
·d
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "pad",0);

168 
·ddšg
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "padding",0);

169 if(
·d
è
·ddšg
 = 
size
/2;

171 
Ïy”
 
l
 = 
	`make_decÚvŞutiÚ®_Ïy”
(
b©ch
,
h
,
w
,
c
,
n
,
size
,
¡ride
,
·ddšg
, 
aùiv©iÚ
, 
b©ch_nÜm®ize
, 
·¿ms
.
Ãt
->
adam
);

173  
l
;

174 
	}
}

177 
cÚvŞutiÚ®_Ïy”
 
	$·r£_cÚvŞutiÚ®
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

179 
n
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "filters",1);

180 
size
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "size",1);

181 
¡ride
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "stride",1);

182 
·d
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "pad",0);

183 
·ddšg
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "padding",0);

184 
groups
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "groups", 1);

185 if(
·d
è
·ddšg
 = 
size
/2;

187 *
aùiv©iÚ_s
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "activation", "logistic");

188 
ACTIVATION
 
aùiv©iÚ
 = 
	`g‘_aùiv©iÚ
(
aùiv©iÚ_s
);

190 
b©ch
,
h
,
w
,
c
;

191 
h
 = 
·¿ms
.h;

192 
w
 = 
·¿ms
.w;

193 
c
 = 
·¿ms
.c;

194 
b©ch
=
·¿ms
.batch;

195 if(!(
h
 && 
w
 && 
c
)è
	`”rÜ
("Layer before convolutional†ayer must output image.");

196 
b©ch_nÜm®ize
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "batch_normalize", 0);

197 
bš¬y
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "binary", 0);

198 
xnÜ
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "xnor", 0);

200 
cÚvŞutiÚ®_Ïy”
 
Ïy”
 = 
	`make_cÚvŞutiÚ®_Ïy”
(
b©ch
,
h
,
w
,
c
,
n
,
groups
,
size
,
¡ride
,
·ddšg
,
aùiv©iÚ
, 
b©ch_nÜm®ize
, 
bš¬y
, 
xnÜ
, 
·¿ms
.
Ãt
->
adam
);

201 
Ïy”
.
æ³d
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "flipped", 0);

202 
Ïy”
.
dÙ
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "dot", 0);

204  
Ïy”
;

205 
	}
}

207 
Ïy”
 
	$·r£_üÂ
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

209 
ouut_f‹rs
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "output_filters",1);

210 
hidd’_f‹rs
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "hidden_filters",1);

211 *
aùiv©iÚ_s
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "activation", "logistic");

212 
ACTIVATION
 
aùiv©iÚ
 = 
	`g‘_aùiv©iÚ
(
aùiv©iÚ_s
);

213 
b©ch_nÜm®ize
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "batch_normalize", 0);

215 
Ïy”
 
l
 = 
	`make_üÂ_Ïy”
(
·¿ms
.
b©ch
,…¬ams.
w
,…¬ams.
h
,…¬ams.
c
, 
hidd’_f‹rs
, 
ouut_f‹rs
,…¬ams.
time_¡•s
, 
aùiv©iÚ
, 
b©ch_nÜm®ize
);

217 
l
.
shÜtcut
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "shortcut", 0);

219  
l
;

220 
	}
}

222 
Ïy”
 
	$·r£_ºn
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

224 
ouut
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "output",1);

225 *
aùiv©iÚ_s
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "activation", "logistic");

226 
ACTIVATION
 
aùiv©iÚ
 = 
	`g‘_aùiv©iÚ
(
aùiv©iÚ_s
);

227 
b©ch_nÜm®ize
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "batch_normalize", 0);

229 
Ïy”
 
l
 = 
	`make_ºn_Ïy”
(
·¿ms
.
b©ch
,…¬ams.
šputs
, 
ouut
,…¬ams.
time_¡•s
, 
aùiv©iÚ
, 
b©ch_nÜm®ize
,…¬ams.
Ãt
->
adam
);

231 
l
.
shÜtcut
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "shortcut", 0);

233  
l
;

234 
	}
}

236 
Ïy”
 
	$·r£_gru
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

238 
ouut
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "output",1);

239 
b©ch_nÜm®ize
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "batch_normalize", 0);

241 
Ïy”
 
l
 = 
	`make_gru_Ïy”
(
·¿ms
.
b©ch
,…¬ams.
šputs
, 
ouut
,…¬ams.
time_¡•s
, 
b©ch_nÜm®ize
,…¬ams.
Ãt
->
adam
);

242 
l
.
nh
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "tanh", 0);

244  
l
;

245 
	}
}

247 
Ïy”
 
	$·r£_l¡m
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

249 
ouut
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "output", 1);

250 
b©ch_nÜm®ize
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "batch_normalize", 0);

252 
Ïy”
 
l
 = 
	`make_l¡m_Ïy”
(
·¿ms
.
b©ch
,…¬ams.
šputs
, 
ouut
,…¬ams.
time_¡•s
, 
b©ch_nÜm®ize
,…¬ams.
Ãt
->
adam
);

254  
l
;

255 
	}
}

257 
Ïy”
 
	$·r£_cÚÃùed
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

259 
ouut
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "output",1);

260 *
aùiv©iÚ_s
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "activation", "logistic");

261 
ACTIVATION
 
aùiv©iÚ
 = 
	`g‘_aùiv©iÚ
(
aùiv©iÚ_s
);

262 
b©ch_nÜm®ize
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "batch_normalize", 0);

264 
Ïy”
 
l
 = 
	`make_cÚÃùed_Ïy”
(
·¿ms
.
b©ch
,…¬ams.
šputs
, 
ouut
, 
aùiv©iÚ
, 
b©ch_nÜm®ize
,…¬ams.
Ãt
->
adam
);

265  
l
;

266 
	}
}

268 
soámax_Ïy”
 
	$·r£_soámax
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

270 
groups
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "groups",1);

271 
soámax_Ïy”
 
Ïy”
 = 
	`make_soámax_Ïy”
(
·¿ms
.
b©ch
,…¬ams.
šputs
, 
groups
);

272 
Ïy”
.
‹m³¿tu»
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "temperature", 1);

273 *
Œ“_fe
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "tree", 0);

274 ià(
Œ“_fe
è
Ïy”
.
soámax_Œ“
 = 
	`»ad_Œ“
(tree_file);

275 
Ïy”
.
w
 = 
·¿ms
.w;

276 
Ïy”
.
h
 = 
·¿ms
.h;

277 
Ïy”
.
c
 = 
·¿ms
.c;

278 
Ïy”
.
¥©Ÿl
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "spatial", 0);

279  
Ïy”
;

280 
	}
}

282 *
	$·r£_yŞo_mask
(*
a
, *
num
)

284 *
mask
 = 0;

285 if(
a
){

286 
Ën
 = 
	`¡¾’
(
a
);

287 
n
 = 1;

288 
i
;

289 
i
 = 0; i < 
Ën
; ++i){

290 ià(
a
[
i
] =ğ','è++
n
;

292 
mask
 = 
	`ÿÎoc
(
n
, ());

293 
i
 = 0; i < 
n
; ++i){

294 
v®
 = 
	`©oi
(
a
);

295 
mask
[
i
] = 
v®
;

296 
a
 = 
	`¡rchr
(a, ',')+1;

298 *
num
 = 
n
;

300  
mask
;

301 
	}
}

303 
Ïy”
 
	$·r£_yŞo
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

305 
şas£s
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "classes", 20);

306 
tÙ®
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "num", 1);

307 
num
 = 
tÙ®
;

309 *
a
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "mask", 0);

310 *
mask
 = 
	`·r£_yŞo_mask
(
a
, &
num
);

311 
Ïy”
 
l
 = 
	`make_yŞo_Ïy”
(
·¿ms
.
b©ch
,…¬ams.
w
,…¬ams.
h
, 
num
, 
tÙ®
, 
mask
, 
şas£s
);

312 
	`as£¹
(
l
.
ouuts
 =ğ
·¿ms
.
šputs
);

314 
l
.
max_boxes
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "max",90);

315 
l
.
j™‹r
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "jitter", .2);

317 
l
.
ignÜe_th»sh
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "ignore_thresh", .5);

318 
l
.
Œuth_th»sh
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "truth_thresh", 1);

319 
l
.
¿ndom
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "random", 0);

321 *
m­_fe
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "map", 0);

322 ià(
m­_fe
è
l
.
m­
 = 
	`»ad_m­
(map_file);

324 
a
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "anchors", 0);

325 if(
a
){

326 
Ën
 = 
	`¡¾’
(
a
);

327 
n
 = 1;

328 
i
;

329 
i
 = 0; i < 
Ën
; ++i){

330 ià(
a
[
i
] =ğ','è++
n
;

332 
i
 = 0; i < 
n
; ++i){

333 
bŸs
 = 
	`©of
(
a
);

334 
l
.
bŸ£s
[
i
] = 
bŸs
;

335 
a
 = 
	`¡rchr
(a, ',')+1;

338  
l
;

339 
	}
}

341 
Ïy”
 
	$·r£_»giÚ
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

343 
coÜds
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "coords", 4);

344 
şas£s
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "classes", 20);

345 
num
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "num", 1);

347 
Ïy”
 
l
 = 
	`make_»giÚ_Ïy”
(
·¿ms
.
b©ch
,…¬ams.
w
,…¬ams.
h
, 
num
, 
şas£s
, 
coÜds
);

348 
	`as£¹
(
l
.
ouuts
 =ğ
·¿ms
.
šputs
);

350 
l
.
log
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "log", 0);

351 
l
.
sq¹
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "sqrt", 0);

353 
l
.
soámax
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "softmax", 0);

354 
l
.
background
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "background", 0);

355 
l
.
max_boxes
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "max",30);

356 
l
.
j™‹r
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "jitter", .2);

357 
l
.
»scÜe
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "rescore",0);

359 
l
.
th»sh
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "thresh", .5);

360 
l
.
şassfix
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "classfix", 0);

361 
l
.
absŞu‹
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "absolute", 0);

362 
l
.
¿ndom
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "random", 0);

364 
l
.
coÜd_sÿË
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "coord_scale", 1);

365 
l
.
objeù_sÿË
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "object_scale", 1);

366 
l
.
noobjeù_sÿË
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "noobject_scale", 1);

367 
l
.
mask_sÿË
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "mask_scale", 1);

368 
l
.
şass_sÿË
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "class_scale", 1);

369 
l
.
bŸs_m©ch
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "bias_match",0);

371 *
Œ“_fe
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "tree", 0);

372 ià(
Œ“_fe
è
l
.
soámax_Œ“
 = 
	`»ad_Œ“
(tree_file);

373 *
m­_fe
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "map", 0);

374 ià(
m­_fe
è
l
.
m­
 = 
	`»ad_m­
(map_file);

376 *
a
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "anchors", 0);

377 if(
a
){

378 
Ën
 = 
	`¡¾’
(
a
);

379 
n
 = 1;

380 
i
;

381 
i
 = 0; i < 
Ën
; ++i){

382 ià(
a
[
i
] =ğ','è++
n
;

384 
i
 = 0; i < 
n
; ++i){

385 
bŸs
 = 
	`©of
(
a
);

386 
l
.
bŸ£s
[
i
] = 
bŸs
;

387 
a
 = 
	`¡rchr
(a, ',')+1;

390  
l
;

391 
	}
}

393 
d‘eùiÚ_Ïy”
 
	$·r£_d‘eùiÚ
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

395 
coÜds
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "coords", 1);

396 
şas£s
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "classes", 1);

397 
»scÜe
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "rescore", 0);

398 
num
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "num", 1);

399 
side
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "side", 7);

400 
d‘eùiÚ_Ïy”
 
Ïy”
 = 
	`make_d‘eùiÚ_Ïy”
(
·¿ms
.
b©ch
,…¬ams.
šputs
, 
num
, 
side
, 
şas£s
, 
coÜds
, 
»scÜe
);

402 
Ïy”
.
soámax
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "softmax", 0);

403 
Ïy”
.
sq¹
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "sqrt", 0);

405 
Ïy”
.
max_boxes
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "max",90);

406 
Ïy”
.
coÜd_sÿË
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "coord_scale", 1);

407 
Ïy”
.
fÜûd
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "forced", 0);

408 
Ïy”
.
objeù_sÿË
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "object_scale", 1);

409 
Ïy”
.
noobjeù_sÿË
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "noobject_scale", 1);

410 
Ïy”
.
şass_sÿË
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "class_scale", 1);

411 
Ïy”
.
j™‹r
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "jitter", .2);

412 
Ïy”
.
¿ndom
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "random", 0);

413 
Ïy”
.
»Üg
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "reorg", 0);

414  
Ïy”
;

415 
	}
}

417 
co¡_Ïy”
 
	$·r£_co¡
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

419 *
ty³_s
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "type", "sse");

420 
COST_TYPE
 
ty³
 = 
	`g‘_co¡_ty³
(
ty³_s
);

421 
sÿË
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "scale",1);

422 
co¡_Ïy”
 
Ïy”
 = 
	`make_co¡_Ïy”
(
·¿ms
.
b©ch
,…¬ams.
šputs
, 
ty³
, 
sÿË
);

423 
Ïy”
.
¿tio
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "ratio",0);

424 
Ïy”
.
noobjeù_sÿË
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "noobj", 1);

425 
Ïy”
.
th»sh
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "thresh",0);

426  
Ïy”
;

427 
	}
}

429 
üİ_Ïy”
 
	$·r£_üİ
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

431 
üİ_height
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "crop_height",1);

432 
üİ_width
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "crop_width",1);

433 
æ
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "flip",0);

434 
ªgË
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "angle",0);

435 
§tu¿tiÚ
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "saturation",1);

436 
exposu»
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "exposure",1);

438 
b©ch
,
h
,
w
,
c
;

439 
h
 = 
·¿ms
.h;

440 
w
 = 
·¿ms
.w;

441 
c
 = 
·¿ms
.c;

442 
b©ch
=
·¿ms
.batch;

443 if(!(
h
 && 
w
 && 
c
)è
	`”rÜ
("Layer before crop†ayer must output image.");

445 
nßdju¡
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "noadjust",0);

447 
üİ_Ïy”
 
l
 = 
	`make_üİ_Ïy”
(
b©ch
,
h
,
w
,
c
,
üİ_height
,
üİ_width
,
æ
, 
ªgË
, 
§tu¿tiÚ
, 
exposu»
);

448 
l
.
shiá
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "shift", 0);

449 
l
.
nßdju¡
 =‚oadjust;

450  
l
;

451 
	}
}

453 
Ïy”
 
	$·r£_»Üg
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

455 
¡ride
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "stride",1);

456 
»v”£
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "reverse",0);

457 
æ©‹n
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "flatten",0);

458 
exŒa
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "extra",0);

460 
b©ch
,
h
,
w
,
c
;

461 
h
 = 
·¿ms
.h;

462 
w
 = 
·¿ms
.w;

463 
c
 = 
·¿ms
.c;

464 
b©ch
=
·¿ms
.batch;

465 if(!(
h
 && 
w
 && 
c
)è
	`”rÜ
("Layer before„eorg†ayer must output image.");

467 
Ïy”
†ay” = 
	`make_»Üg_Ïy”
(
b©ch
,
w
,
h
,
c
,
¡ride
,
»v”£
, 
æ©‹n
, 
exŒa
);

468  
Ïy”
;

469 
	}
}

471 
maxpoŞ_Ïy”
 
	$·r£_maxpoŞ
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

473 
¡ride
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "stride",1);

474 
size
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "size",
¡ride
);

475 
·ddšg
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "·ddšg", (
size
-1)/2);

477 
b©ch
,
h
,
w
,
c
;

478 
h
 = 
·¿ms
.h;

479 
w
 = 
·¿ms
.w;

480 
c
 = 
·¿ms
.c;

481 
b©ch
=
·¿ms
.batch;

482 if(!(
h
 && 
w
 && 
c
)è
	`”rÜ
("Layer before maxpool†ayer must output image.");

484 
maxpoŞ_Ïy”
 
Ïy”
 = 
	`make_maxpoŞ_Ïy”
(
b©ch
,
h
,
w
,
c
,
size
,
¡ride
,
·ddšg
);

485  
Ïy”
;

486 
	}
}

488 
avgpoŞ_Ïy”
 
	$·r£_avgpoŞ
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

490 
b©ch
,
w
,
h
,
c
;

491 
w
 = 
·¿ms
.w;

492 
h
 = 
·¿ms
.h;

493 
c
 = 
·¿ms
.c;

494 
b©ch
=
·¿ms
.batch;

495 if(!(
h
 && 
w
 && 
c
)è
	`”rÜ
("Layer before‡vgpool†ayer must output image.");

497 
avgpoŞ_Ïy”
 
Ïy”
 = 
	`make_avgpoŞ_Ïy”
(
b©ch
,
w
,
h
,
c
);

498  
Ïy”
;

499 
	}
}

501 
drİout_Ïy”
 
	$·r£_drİout
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

503 
´obab™y
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "probability", .5);

504 
drİout_Ïy”
 
Ïy”
 = 
	`make_drİout_Ïy”
(
·¿ms
.
b©ch
,…¬ams.
šputs
, 
´obab™y
);

505 
Ïy”
.
out_w
 = 
·¿ms
.
w
;

506 
Ïy”
.
out_h
 = 
·¿ms
.
h
;

507 
Ïy”
.
out_c
 = 
·¿ms
.
c
;

508  
Ïy”
;

509 
	}
}

511 
Ïy”
 
	$·r£_nÜm®iz©iÚ
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

513 
®pha
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "alpha", .0001);

514 
b‘a
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "beta" , .75);

515 
k­·
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "kappa", 1);

516 
size
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "size", 5);

517 
Ïy”
 
l
 = 
	`make_nÜm®iz©iÚ_Ïy”
(
·¿ms
.
b©ch
,…¬ams.
w
,…¬ams.
h
,…¬ams.
c
, 
size
, 
®pha
, 
b‘a
, 
k­·
);

518  
l
;

519 
	}
}

521 
Ïy”
 
	$·r£_b©chnÜm
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

523 
Ïy”
 
l
 = 
	`make_b©chnÜm_Ïy”
(
·¿ms
.
b©ch
,…¬ams.
w
,…¬ams.
h
,…¬ams.
c
);

524  
l
;

525 
	}
}

527 
Ïy”
 
	$·r£_shÜtcut
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
, 
ÃtwÜk
 *
Ãt
)

529 *
l
 = 
	`İtiÚ_fšd
(
İtiÚs
, "from");

530 
šdex
 = 
	`©oi
(
l
);

531 if(
šdex
 < 0èšdex = 
·¿ms
.index + index;

533 
b©ch
 = 
·¿ms
.batch;

534 
Ïy”
 
äom
 = 
Ãt
->
Ïy”s
[
šdex
];

536 
Ïy”
 
s
 = 
	`make_shÜtcut_Ïy”
(
b©ch
, 
šdex
, 
·¿ms
.
w
,…¬ams.
h
,…¬ams.
c
, 
äom
.
out_w
, from.
out_h
, from.
out_c
);

538 *
aùiv©iÚ_s
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "activation", "linear");

539 
ACTIVATION
 
aùiv©iÚ
 = 
	`g‘_aùiv©iÚ
(
aùiv©iÚ_s
);

540 
s
.
aùiv©iÚ
 =‡ctivation;

541 
s
.
®pha
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "alpha", 1);

542 
s
.
b‘a
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "beta", 1);

543  
s
;

544 
	}
}

547 
Ïy”
 
	$·r£_l2nÜm
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

549 
Ïy”
 
l
 = 
	`make_l2nÜm_Ïy”
(
·¿ms
.
b©ch
,…¬ams.
šputs
);

550 
l
.
h
 =†.
out_h
 = 
·¿ms
.h;

551 
l
.
w
 =†.
out_w
 = 
·¿ms
.w;

552 
l
.
c
 =†.
out_c
 = 
·¿ms
.c;

553  
l
;

554 
	}
}

557 
Ïy”
 
	$·r£_logi¡ic
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

559 
Ïy”
 
l
 = 
	`make_logi¡ic_Ïy”
(
·¿ms
.
b©ch
,…¬ams.
šputs
);

560 
l
.
h
 =†.
out_h
 = 
·¿ms
.h;

561 
l
.
w
 =†.
out_w
 = 
·¿ms
.w;

562 
l
.
c
 =†.
out_c
 = 
·¿ms
.c;

563  
l
;

564 
	}
}

566 
Ïy”
 
	$·r£_aùiv©iÚ
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
)

568 *
aùiv©iÚ_s
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "activation", "logistic");

569 
ACTIVATION
 
aùiv©iÚ
 = 
	`g‘_aùiv©iÚ
(
aùiv©iÚ_s
);

571 
Ïy”
 
l
 = 
	`make_aùiv©iÚ_Ïy”
(
·¿ms
.
b©ch
,…¬ams.
šputs
, 
aùiv©iÚ
);

573 
l
.
h
 =†.
out_h
 = 
·¿ms
.h;

574 
l
.
w
 =†.
out_w
 = 
·¿ms
.w;

575 
l
.
c
 =†.
out_c
 = 
·¿ms
.c;

577  
l
;

578 
	}
}

580 
Ïy”
 
	$·r£_up§m¶e
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
, 
ÃtwÜk
 *
Ãt
)

583 
¡ride
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "stride",2);

584 
Ïy”
 
l
 = 
	`make_up§m¶e_Ïy”
(
·¿ms
.
b©ch
,…¬ams.
w
,…¬ams.
h
,…¬ams.
c
, 
¡ride
);

585 
l
.
sÿË
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "scale", 1);

586  
l
;

587 
	}
}

589 
rou‹_Ïy”
 
	$·r£_rou‹
(
li¡
 *
İtiÚs
, 
size_·¿ms
 
·¿ms
, 
ÃtwÜk
 *
Ãt
)

591 *
l
 = 
	`İtiÚ_fšd
(
İtiÚs
, "layers");

592 
Ën
 = 
	`¡¾’
(
l
);

593 if(!
l
è
	`”rÜ
("Route Layer must specify input†ayers");

594 
n
 = 1;

595 
i
;

596 
i
 = 0; i < 
Ën
; ++i){

597 ià(
l
[
i
] =ğ','è++
n
;

600 *
Ïy”s
 = 
	`ÿÎoc
(
n
, ());

601 *
sizes
 = 
	`ÿÎoc
(
n
, ());

602 
i
 = 0; i < 
n
; ++i){

603 
šdex
 = 
	`©oi
(
l
);

604 
l
 = 
	`¡rchr
(l, ',')+1;

605 if(
šdex
 < 0èšdex = 
·¿ms
.index + index;

606 
Ïy”s
[
i
] = 
šdex
;

607 
sizes
[
i
] = 
Ãt
->
Ïy”s
[
šdex
].
ouuts
;

609 
b©ch
 = 
·¿ms
.batch;

611 
rou‹_Ïy”
 
Ïy”
 = 
	`make_rou‹_Ïy”
(
b©ch
, 
n
, 
Ïy”s
, 
sizes
);

613 
cÚvŞutiÚ®_Ïy”
 
fœ¡
 = 
Ãt
->
Ïy”s
[layers[0]];

614 
Ïy”
.
out_w
 = 
fœ¡
.out_w;

615 
Ïy”
.
out_h
 = 
fœ¡
.out_h;

616 
Ïy”
.
out_c
 = 
fœ¡
.out_c;

617 
i
 = 1; i < 
n
; ++i){

618 
šdex
 = 
Ïy”s
[
i
];

619 
cÚvŞutiÚ®_Ïy”
 
Ãxt
 = 
Ãt
->
Ïy”s
[
šdex
];

620 if(
Ãxt
.
out_w
 =ğ
fœ¡
.out_w &&‚ext.
out_h
 == first.out_h){

621 
Ïy”
.
out_c
 +ğ
Ãxt
.out_c;

623 
Ïy”
.
out_h
 =†ay”.
out_w
 =†ay”.
out_c
 = 0;

627  
Ïy”
;

628 
	}
}

630 
Ë¬nšg_¿‹_pŞicy
 
	$g‘_pŞicy
(*
s
)

632 ià(
	`¡rcmp
(
s
, "¿ndom")==0è 
RANDOM
;

633 ià(
	`¡rcmp
(
s
, "pŞy")==0è 
POLY
;

634 ià(
	`¡rcmp
(
s
, "cÚ¡ªt")==0è 
CONSTANT
;

635 ià(
	`¡rcmp
(
s
, "¡•")==0è 
STEP
;

636 ià(
	`¡rcmp
(
s
, "exp")==0è 
EXP
;

637 ià(
	`¡rcmp
(
s
, "sigmoid")==0è 
SIG
;

638 ià(
	`¡rcmp
(
s
, "¡•s")==0è 
STEPS
;

639 
	`årštf
(
¡d”r
, "Couldn'ˆfšd…Şicy %s, gošg w™h cÚ¡ªt\n", 
s
);

640  
CONSTANT
;

641 
	}
}

643 
	$·r£_Ãt_İtiÚs
(
li¡
 *
İtiÚs
, 
ÃtwÜk
 *
Ãt
)

645 
Ãt
->
b©ch
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "batch",1);

646 
Ãt
->
Ë¬nšg_¿‹
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "learning_rate", .001);

647 
Ãt
->
mom’tum
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "momentum", .9);

648 
Ãt
->
deÿy
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "decay", .0001);

649 
subdivs
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "subdivisions",1);

650 
Ãt
->
time_¡•s
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "time_steps",1);

651 
Ãt
->
nÙruth
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "notruth",0);

652 
Ãt
->
b©ch
 /ğ
subdivs
;

653 
Ãt
->
b©ch
 *ğÃt->
time_¡•s
;

654 
Ãt
->
subdivisiÚs
 = 
subdivs
;

655 
Ãt
->
¿ndom
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "random", 0);

657 
Ãt
->
adam
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "adam", 0);

658 if(
Ãt
->
adam
){

659 
Ãt
->
B1
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "B1", .9);

660 
Ãt
->
B2
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "B2", .999);

661 
Ãt
->
•s
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "eps", .0000001);

664 
Ãt
->
h
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "height",0);

665 
Ãt
->
w
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "width",0);

666 
Ãt
->
c
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "channels",0);

667 
Ãt
->
šputs
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "šputs",‚‘->
h
 *‚‘->
w
 *‚‘->
c
);

668 
Ãt
->
max_üİ
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "max_üİ",Ãt->
w
*2);

669 
Ãt
->
mš_üİ
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "mš_üİ",Ãt->
w
);

670 
Ãt
->
max_¿tio
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "max_¿tio", (èÃt->
max_üİ
 /‚‘->
w
);

671 
Ãt
->
mš_¿tio
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "mš_¿tio", (èÃt->
mš_üİ
 /‚‘->
w
);

672 
Ãt
->
ûÁ”
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "center",0);

673 
Ãt
->
ş
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "clip", 0);

675 
Ãt
->
ªgË
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "angle", 0);

676 
Ãt
->
a¥eù
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "aspect", 1);

677 
Ãt
->
§tu¿tiÚ
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "saturation", 1);

678 
Ãt
->
exposu»
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "exposure", 1);

679 
Ãt
->
hue
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "hue", 0);

681 if(!
Ãt
->
šputs
 && !Ò‘->
h
 &&‚‘->
w
 &&‚‘->
c
)è
	`”rÜ
("No input…arameters supplied");

683 *
pŞicy_s
 = 
	`İtiÚ_fšd_¡r
(
İtiÚs
, "policy", "constant");

684 
Ãt
->
pŞicy
 = 
	`g‘_pŞicy
(
pŞicy_s
);

685 
Ãt
->
buº_š
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "burn_in", 0);

686 
Ãt
->
pow”
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "power", 4);

687 if(
Ãt
->
pŞicy
 =ğ
STEP
){

688 
Ãt
->
¡•
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "step", 1);

689 
Ãt
->
sÿË
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "scale", 1);

690 } ià(
Ãt
->
pŞicy
 =ğ
STEPS
){

691 *
l
 = 
	`İtiÚ_fšd
(
İtiÚs
, "steps");

692 *
p
 = 
	`İtiÚ_fšd
(
İtiÚs
, "scales");

693 if(!
l
 || !
p
è
	`”rÜ
("STEPS…olicy must have steps‡nd scales in cfg file");

695 
Ën
 = 
	`¡¾’
(
l
);

696 
n
 = 1;

697 
i
;

698 
i
 = 0; i < 
Ën
; ++i){

699 ià(
l
[
i
] =ğ','è++
n
;

701 *
¡•s
 = 
	`ÿÎoc
(
n
, ());

702 *
sÿËs
 = 
	`ÿÎoc
(
n
, ());

703 
i
 = 0; i < 
n
; ++i){

704 
¡•
 = 
	`©oi
(
l
);

705 
sÿË
 = 
	`©of
(
p
);

706 
l
 = 
	`¡rchr
(l, ',')+1;

707 
p
 = 
	`¡rchr
(p, ',')+1;

708 
¡•s
[
i
] = 
¡•
;

709 
sÿËs
[
i
] = 
sÿË
;

711 
Ãt
->
sÿËs
 = scales;

712 
Ãt
->
¡•s
 = steps;

713 
Ãt
->
num_¡•s
 = 
n
;

714 } ià(
Ãt
->
pŞicy
 =ğ
EXP
){

715 
Ãt
->
gamma
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "gamma", 1);

716 } ià(
Ãt
->
pŞicy
 =ğ
SIG
){

717 
Ãt
->
gamma
 = 
	`İtiÚ_fšd_æßt
(
İtiÚs
, "gamma", 1);

718 
Ãt
->
¡•
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "step", 1);

719 } ià(
Ãt
->
pŞicy
 =ğ
POLY
 ||‚‘->pŞicy =ğ
RANDOM
){

721 
Ãt
->
max_b©ches
 = 
	`İtiÚ_fšd_št
(
İtiÚs
, "max_batches", 0);

722 
	}
}

724 
	$is_ÃtwÜk
(
£ùiÚ
 *
s
)

726  (
	`¡rcmp
(
s
->
ty³
, "[net]")==0

727 || 
	`¡rcmp
(
s
->
ty³
, "[network]")==0);

728 
	}
}

730 
ÃtwÜk
 *
	$·r£_ÃtwÜk_cfg
(*
f’ame
)

732 
li¡
 *
£ùiÚs
 = 
	`»ad_cfg
(
f’ame
);

733 
node
 *
n
 = 
£ùiÚs
->
äÚt
;

734 if(!
n
è
	`”rÜ
("Config file has‚o sections");

735 
ÃtwÜk
 *
Ãt
 = 
	`make_ÃtwÜk
(
£ùiÚs
->
size
 - 1);

736 
Ãt
->
gpu_šdex
 = gpu_index;

737 
size_·¿ms
 
·¿ms
;

739 
£ùiÚ
 *
s
 = (£ùiÚ *)
n
->
v®
;

740 
li¡
 *
İtiÚs
 = 
s
->options;

741 if(!
	`is_ÃtwÜk
(
s
)è
	`”rÜ
("First section must be [net] or [network]");

742 
	`·r£_Ãt_İtiÚs
(
İtiÚs
, 
Ãt
);

744 
·¿ms
.
h
 = 
Ãt
->h;

745 
·¿ms
.
w
 = 
Ãt
->w;

746 
·¿ms
.
c
 = 
Ãt
->c;

747 
·¿ms
.
šputs
 = 
Ãt
->inputs;

748 
·¿ms
.
b©ch
 = 
Ãt
->batch;

749 
·¿ms
.
time_¡•s
 = 
Ãt
->time_steps;

750 
·¿ms
.
Ãt
 =‚et;

752 
size_t
 
wÜk¥aû_size
 = 0;

753 
n
 =‚->
Ãxt
;

754 
couÁ
 = 0;

755 
	`ä“_£ùiÚ
(
s
);

756 
	`årštf
(
¡d”r
, "layer filters size input output\n");

757 
n
){

758 
·¿ms
.
šdex
 = 
couÁ
;

759 
	`årštf
(
¡d”r
, "%5d ", 
couÁ
);

760 
s
 = (
£ùiÚ
 *)
n
->
v®
;

761 
İtiÚs
 = 
s
->options;

762 
Ïy”
 
l
 = {0};

763 
LAYER_TYPE
 
É
 = 
	`¡ršg_to_Ïy”_ty³
(
s
->
ty³
);

764 if(
É
 =ğ
CONVOLUTIONAL
){

765 
l
 = 
	`·r£_cÚvŞutiÚ®
(
İtiÚs
, 
·¿ms
);

766 }if(
É
 =ğ
DECONVOLUTIONAL
){

767 
l
 = 
	`·r£_decÚvŞutiÚ®
(
İtiÚs
, 
·¿ms
);

768 }if(
É
 =ğ
LOCAL
){

769 
l
 = 
	`·r£_loÿl
(
İtiÚs
, 
·¿ms
);

770 }if(
É
 =ğ
ACTIVE
){

771 
l
 = 
	`·r£_aùiv©iÚ
(
İtiÚs
, 
·¿ms
);

772 }if(
É
 =ğ
LOGXENT
){

773 
l
 = 
	`·r£_logi¡ic
(
İtiÚs
, 
·¿ms
);

774 }if(
É
 =ğ
L2NORM
){

775 
l
 = 
	`·r£_l2nÜm
(
İtiÚs
, 
·¿ms
);

776 }if(
É
 =ğ
RNN
){

777 
l
 = 
	`·r£_ºn
(
İtiÚs
, 
·¿ms
);

778 }if(
É
 =ğ
GRU
){

779 
l
 = 
	`·r£_gru
(
İtiÚs
, 
·¿ms
);

780 }ià(
É
 =ğ
LSTM
) {

781 
l
 = 
	`·r£_l¡m
(
İtiÚs
, 
·¿ms
);

782 }if(
É
 =ğ
CRNN
){

783 
l
 = 
	`·r£_üÂ
(
İtiÚs
, 
·¿ms
);

784 }if(
É
 =ğ
CONNECTED
){

785 
l
 = 
	`·r£_cÚÃùed
(
İtiÚs
, 
·¿ms
);

786 }if(
É
 =ğ
CROP
){

787 
l
 = 
	`·r£_üİ
(
İtiÚs
, 
·¿ms
);

788 }if(
É
 =ğ
COST
){

789 
l
 = 
	`·r£_co¡
(
İtiÚs
, 
·¿ms
);

790 }if(
É
 =ğ
REGION
){

791 
l
 = 
	`·r£_»giÚ
(
İtiÚs
, 
·¿ms
);

792 }if(
É
 =ğ
YOLO
){

793 
l
 = 
	`·r£_yŞo
(
İtiÚs
, 
·¿ms
);

794 }if(
É
 =ğ
DETECTION
){

795 
l
 = 
	`·r£_d‘eùiÚ
(
İtiÚs
, 
·¿ms
);

796 }if(
É
 =ğ
SOFTMAX
){

797 
l
 = 
	`·r£_soámax
(
İtiÚs
, 
·¿ms
);

798 
Ãt
->
h›¿rchy
 = 
l
.
soámax_Œ“
;

799 }if(
É
 =ğ
NORMALIZATION
){

800 
l
 = 
	`·r£_nÜm®iz©iÚ
(
İtiÚs
, 
·¿ms
);

801 }if(
É
 =ğ
BATCHNORM
){

802 
l
 = 
	`·r£_b©chnÜm
(
İtiÚs
, 
·¿ms
);

803 }if(
É
 =ğ
MAXPOOL
){

804 
l
 = 
	`·r£_maxpoŞ
(
İtiÚs
, 
·¿ms
);

805 }if(
É
 =ğ
REORG
){

806 
l
 = 
	`·r£_»Üg
(
İtiÚs
, 
·¿ms
);

807 }if(
É
 =ğ
AVGPOOL
){

808 
l
 = 
	`·r£_avgpoŞ
(
İtiÚs
, 
·¿ms
);

809 }if(
É
 =ğ
ROUTE
){

810 
l
 = 
	`·r£_rou‹
(
İtiÚs
, 
·¿ms
, 
Ãt
);

811 }if(
É
 =ğ
UPSAMPLE
){

812 
l
 = 
	`·r£_up§m¶e
(
İtiÚs
, 
·¿ms
, 
Ãt
);

813 }if(
É
 =ğ
SHORTCUT
){

814 
l
 = 
	`·r£_shÜtcut
(
İtiÚs
, 
·¿ms
, 
Ãt
);

815 }if(
É
 =ğ
DROPOUT
){

816 
l
 = 
	`·r£_drİout
(
İtiÚs
, 
·¿ms
);

817 
l
.
ouut
 = 
Ãt
->
Ïy”s
[
couÁ
-1].output;

818 
l
.
d–
 = 
Ãt
->
Ïy”s
[
couÁ
-1].delta;

819 #ifdeà
GPU


820 
l
.
ouut_gpu
 = 
Ãt
->
Ïy”s
[
couÁ
-1].output_gpu;

821 
l
.
d–_gpu
 = 
Ãt
->
Ïy”s
[
couÁ
-1].delta_gpu;

824 
	`årštf
(
¡d”r
, "Ty³‚Ù„ecognized: %s\n", 
s
->
ty³
);

826 
l
.
ş
 = 
Ãt
->clip;

827 
l
.
Œuth
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "truth", 0);

828 
l
.
ÚlyfÜw¬d
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "onlyforward", 0);

829 
l
.
¡İbackw¬d
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "stopbackward", 0);

830 
l
.
dÚt§ve
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "dontsave", 0);

831 
l
.
dÚßd
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "dontload", 0);

832 
l
.
dÚßdsÿËs
 = 
	`İtiÚ_fšd_št_qu›t
(
İtiÚs
, "dontloadscales", 0);

833 
l
.
Ë¬nšg_¿‹_sÿË
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "learning_rate", 1);

834 
l
.
smoÙh
 = 
	`İtiÚ_fšd_æßt_qu›t
(
İtiÚs
, "smooth", 0);

835 
	`İtiÚ_unu£d
(
İtiÚs
);

836 
Ãt
->
Ïy”s
[
couÁ
] = 
l
;

837 ià(
l
.
wÜk¥aû_size
 > workspace_size) workspace_size =†.workspace_size;

838 
	`ä“_£ùiÚ
(
s
);

839 
n
 =‚->
Ãxt
;

840 ++
couÁ
;

841 if(
n
){

842 
·¿ms
.
h
 = 
l
.
out_h
;

843 
·¿ms
.
w
 = 
l
.
out_w
;

844 
·¿ms
.
c
 = 
l
.
out_c
;

845 
·¿ms
.
šputs
 = 
l
.
ouuts
;

848 
	`ä“_li¡
(
£ùiÚs
);

849 
Ïy”
 
out
 = 
	`g‘_ÃtwÜk_ouut_Ïy”
(
Ãt
);

850 
Ãt
->
ouuts
 = 
out
.outputs;

851 
Ãt
->
Œuths
 = 
out
.
ouuts
;

852 if(
Ãt
->
Ïy”s
[Ãt->
n
-1].
Œuths
)‚et->truths =‚et->layers[net->n-1].truths;

853 
Ãt
->
ouut
 = 
out
.output;

854 
Ãt
->
šput
 = 
	`ÿÎoc
Ò‘->
šputs
*Ãt->
b©ch
, ());

855 
Ãt
->
Œuth
 = 
	`ÿÎoc
Ò‘->
Œuths
*Ãt->
b©ch
, ());

856 #ifdeà
GPU


857 
Ãt
->
ouut_gpu
 = 
out
.output_gpu;

858 
Ãt
->
šput_gpu
 = 
	`cuda_make_¬¿y
Ò‘->
šput
,‚‘->
šputs
*Ãt->
b©ch
);

859 
Ãt
->
Œuth_gpu
 = 
	`cuda_make_¬¿y
Ò‘->
Œuth
,‚‘->
Œuths
*Ãt->
b©ch
);

861 if(
wÜk¥aû_size
){

863 #ifdeà
GPU


864 if(
gpu_šdex
 >= 0){

865 
Ãt
->
wÜk¥aû
 = 
	`cuda_make_¬¿y
(0, (
wÜk¥aû_size
-1)/()+1);

867 
Ãt
->
wÜk¥aû
 = 
	`ÿÎoc
(1, 
wÜk¥aû_size
);

870 
Ãt
->
wÜk¥aû
 = 
	`ÿÎoc
(1, 
wÜk¥aû_size
);

873  
Ãt
;

874 
	}
}

876 
li¡
 *
	$»ad_cfg
(*
f’ame
)

878 
FILE
 *
fe
 = 
	`fİ’
(
f’ame
, "r");

879 if(
fe
 =ğ0è
	`fe_”rÜ
(
f’ame
);

880 *
lše
;

881 
nu
 = 0;

882 
li¡
 *
İtiÚs
 = 
	`make_li¡
();

883 
£ùiÚ
 *
cu¼’t
 = 0;

884 (
lše
=
	`fg‘l
(
fe
)) != 0){

885 ++ 
nu
;

886 
	`¡r
(
lše
);

887 
lše
[0]){

889 
cu¼’t
 = 
	`m®loc
((
£ùiÚ
));

890 
	`li¡_š£¹
(
İtiÚs
, 
cu¼’t
);

891 
cu¼’t
->
İtiÚs
 = 
	`make_li¡
();

892 
cu¼’t
->
ty³
 = 
lše
;

897 
	`ä“
(
lše
);

900 if(!
	`»ad_İtiÚ
(
lše
, 
cu¼’t
->
İtiÚs
)){

901 
	`årštf
(
¡d”r
, "CÚfig f”rÜ†š%d, could…¬£: %s\n", 
nu
, 
lše
);

902 
	`ä“
(
lše
);

907 
	`fşo£
(
fe
);

908  
İtiÚs
;

909 
	}
}

911 
	$§ve_cÚvŞutiÚ®_weights_bš¬y
(
Ïy”
 
l
, 
FILE
 *
å
)

913 #ifdeà
GPU


914 if(
gpu_šdex
 >= 0){

915 
	`puÎ_cÚvŞutiÚ®_Ïy”
(
l
);

918 
	`bš¬ize_weights
(
l
.
weights
,†.
n
,†.
c
*l.
size
*l.size,†.
bš¬y_weights
);

919 
size
 = 
l
.
c
*l.size*l.size;

920 
i
, 
j
, 
k
;

921 
	`fwr™e
(
l
.
bŸ£s
, (),†.
n
, 
å
);

922 ià(
l
.
b©ch_nÜm®ize
){

923 
	`fwr™e
(
l
.
sÿËs
, (),†.
n
, 
å
);

924 
	`fwr™e
(
l
.
rŞlšg_m—n
, (),†.
n
, 
å
);

925 
	`fwr™e
(
l
.
rŞlšg_v¬Ÿnû
, (),†.
n
, 
å
);

927 
i
 = 0; i < 
l
.
n
; ++i){

928 
m—n
 = 
l
.
bš¬y_weights
[
i
*
size
];

929 if(
m—n
 < 0) mean = -mean;

930 
	`fwr™e
(&
m—n
, (), 1, 
å
);

931 
j
 = 0; j < 
size
/8; ++j){

932 
šdex
 = 
i
*
size
 + 
j
*8;

933 
c
 = 0;

934 
k
 = 0; k < 8; ++k){

935 ià(
j
*8 + 
k
 >ğ
size
) ;

936 ià(
l
.
bš¬y_weights
[
šdex
 + 
k
] > 0è
c
 = (c | 1<<k);

938 
	`fwr™e
(&
c
, (), 1, 
å
);

941 
	}
}

943 
	$§ve_cÚvŞutiÚ®_weights
(
Ïy”
 
l
, 
FILE
 *
å
)

945 if(
l
.
bš¬y
){

949 #ifdeà
GPU


950 if(
gpu_šdex
 >= 0){

951 
	`puÎ_cÚvŞutiÚ®_Ïy”
(
l
);

954 
num
 = 
l
.
nweights
;

955 
	`fwr™e
(
l
.
bŸ£s
, (),†.
n
, 
å
);

956 ià(
l
.
b©ch_nÜm®ize
){

957 
	`fwr™e
(
l
.
sÿËs
, (),†.
n
, 
å
);

958 
	`fwr™e
(
l
.
rŞlšg_m—n
, (),†.
n
, 
å
);

959 
	`fwr™e
(
l
.
rŞlšg_v¬Ÿnû
, (),†.
n
, 
å
);

961 
	`fwr™e
(
l
.
weights
, (), 
num
, 
å
);

962 
	}
}

964 
	$§ve_b©chnÜm_weights
(
Ïy”
 
l
, 
FILE
 *
å
)

966 #ifdeà
GPU


967 if(
gpu_šdex
 >= 0){

968 
	`puÎ_b©chnÜm_Ïy”
(
l
);

971 
	`fwr™e
(
l
.
sÿËs
, (),†.
c
, 
å
);

972 
	`fwr™e
(
l
.
rŞlšg_m—n
, (),†.
c
, 
å
);

973 
	`fwr™e
(
l
.
rŞlšg_v¬Ÿnû
, (),†.
c
, 
å
);

974 
	}
}

976 
	$§ve_cÚÃùed_weights
(
Ïy”
 
l
, 
FILE
 *
å
)

978 #ifdeà
GPU


979 if(
gpu_šdex
 >= 0){

980 
	`puÎ_cÚÃùed_Ïy”
(
l
);

983 
	`fwr™e
(
l
.
bŸ£s
, (),†.
ouuts
, 
å
);

984 
	`fwr™e
(
l
.
weights
, (),†.
ouuts
*l.
šputs
, 
å
);

985 ià(
l
.
b©ch_nÜm®ize
){

986 
	`fwr™e
(
l
.
sÿËs
, (),†.
ouuts
, 
å
);

987 
	`fwr™e
(
l
.
rŞlšg_m—n
, (),†.
ouuts
, 
å
);

988 
	`fwr™e
(
l
.
rŞlšg_v¬Ÿnû
, (),†.
ouuts
, 
å
);

990 
	}
}

992 
	$§ve_weights_u±o
(
ÃtwÜk
 *
Ãt
, *
f’ame
, 
cutoff
)

994 #ifdeà
GPU


995 if(
Ãt
->
gpu_šdex
 >= 0){

996 
	`cuda_£t_deviû
(
Ãt
->
gpu_šdex
);

999 
	`årštf
(
¡d”r
, "Savšg weight tØ%s\n", 
f’ame
);

1000 
FILE
 *
å
 = 
	`fİ’
(
f’ame
, "wb");

1001 if(!
å
è
	`fe_”rÜ
(
f’ame
);

1003 
majÜ
 = 0;

1004 
mšÜ
 = 2;

1005 
»visiÚ
 = 0;

1006 
	`fwr™e
(&
majÜ
, (), 1, 
å
);

1007 
	`fwr™e
(&
mšÜ
, (), 1, 
å
);

1008 
	`fwr™e
(&
»visiÚ
, (), 1, 
å
);

1009 
	`fwr™e
(
Ãt
->
£’
, (
size_t
), 1, 
å
);

1011 
i
;

1012 
i
 = 0; i < 
Ãt
->
n
 && i < 
cutoff
; ++i){

1013 
Ïy”
 
l
 = 
Ãt
->
Ïy”s
[
i
];

1014 ià(
l
.
dÚt§ve
) ;

1015 if(
l
.
ty³
 =ğ
CONVOLUTIONAL
 ||†.ty³ =ğ
DECONVOLUTIONAL
){

1016 
	`§ve_cÚvŞutiÚ®_weights
(
l
, 
å
);

1017 } if(
l
.
ty³
 =ğ
CONNECTED
){

1018 
	`§ve_cÚÃùed_weights
(
l
, 
å
);

1019 } if(
l
.
ty³
 =ğ
BATCHNORM
){

1020 
	`§ve_b©chnÜm_weights
(
l
, 
å
);

1021 } if(
l
.
ty³
 =ğ
RNN
){

1022 
	`§ve_cÚÃùed_weights
(*(
l
.
šput_Ïy”
), 
å
);

1023 
	`§ve_cÚÃùed_weights
(*(
l
.
£lf_Ïy”
), 
å
);

1024 
	`§ve_cÚÃùed_weights
(*(
l
.
ouut_Ïy”
), 
å
);

1025 } ià(
l
.
ty³
 =ğ
LSTM
) {

1026 
	`§ve_cÚÃùed_weights
(*(
l
.
wi
), 
å
);

1027 
	`§ve_cÚÃùed_weights
(*(
l
.
wf
), 
å
);

1028 
	`§ve_cÚÃùed_weights
(*(
l
.
wo
), 
å
);

1029 
	`§ve_cÚÃùed_weights
(*(
l
.
wg
), 
å
);

1030 
	`§ve_cÚÃùed_weights
(*(
l
.
ui
), 
å
);

1031 
	`§ve_cÚÃùed_weights
(*(
l
.
uf
), 
å
);

1032 
	`§ve_cÚÃùed_weights
(*(
l
.
uo
), 
å
);

1033 
	`§ve_cÚÃùed_weights
(*(
l
.
ug
), 
å
);

1034 } ià(
l
.
ty³
 =ğ
GRU
) {

1036 
	`§ve_cÚÃùed_weights
(*(
l
.
wz
), 
å
);

1037 
	`§ve_cÚÃùed_weights
(*(
l
.
wr
), 
å
);

1038 
	`§ve_cÚÃùed_weights
(*(
l
.
wh
), 
å
);

1039 
	`§ve_cÚÃùed_weights
(*(
l
.
uz
), 
å
);

1040 
	`§ve_cÚÃùed_weights
(*(
l
.
ur
), 
å
);

1041 
	`§ve_cÚÃùed_weights
(*(
l
.
uh
), 
å
);

1043 
	`§ve_cÚÃùed_weights
(*(
l
.
»£t_Ïy”
), 
å
);

1044 
	`§ve_cÚÃùed_weights
(*(
l
.
upd©e_Ïy”
), 
å
);

1045 
	`§ve_cÚÃùed_weights
(*(
l
.
¡©e_Ïy”
), 
å
);

1047 } if(
l
.
ty³
 =ğ
CRNN
){

1048 
	`§ve_cÚvŞutiÚ®_weights
(*(
l
.
šput_Ïy”
), 
å
);

1049 
	`§ve_cÚvŞutiÚ®_weights
(*(
l
.
£lf_Ïy”
), 
å
);

1050 
	`§ve_cÚvŞutiÚ®_weights
(*(
l
.
ouut_Ïy”
), 
å
);

1051 } if(
l
.
ty³
 =ğ
LOCAL
){

1052 #ifdeà
GPU


1053 if(
gpu_šdex
 >= 0){

1054 
	`puÎ_loÿl_Ïy”
(
l
);

1057 
loÿtiÚs
 = 
l
.
out_w
*l.
out_h
;

1058 
size
 = 
l
.size*l.size*l.
c
*l.
n
*
loÿtiÚs
;

1059 
	`fwr™e
(
l
.
bŸ£s
, (),†.
ouuts
, 
å
);

1060 
	`fwr™e
(
l
.
weights
, (), 
size
, 
å
);

1063 
	`fşo£
(
å
);

1064 
	}
}

1065 
	$§ve_weights
(
ÃtwÜk
 *
Ãt
, *
f’ame
)

1067 
	`§ve_weights_u±o
(
Ãt
, 
f’ame
,‚‘->
n
);

1068 
	}
}

1070 
	$Œª¥o£_m©rix
(*
a
, 
rows
, 
cŞs
)

1072 *
Œª¥o£
 = 
	`ÿÎoc
(
rows
*
cŞs
, ());

1073 
x
, 
y
;

1074 
x
 = 0; x < 
rows
; ++x){

1075 
y
 = 0; y < 
cŞs
; ++y){

1076 
Œª¥o£
[
y
*
rows
 + 
x
] = 
a
[x*
cŞs
 + y];

1079 
	`memıy
(
a
, 
Œª¥o£
, 
rows
*
cŞs
*());

1080 
	`ä“
(
Œª¥o£
);

1081 
	}
}

1083 
	$lßd_cÚÃùed_weights
(
Ïy”
 
l
, 
FILE
 *
å
, 
Œª¥o£
)

1085 
	`ä—d
(
l
.
bŸ£s
, (),†.
ouuts
, 
å
);

1086 
	`ä—d
(
l
.
weights
, (),†.
ouuts
*l.
šputs
, 
å
);

1087 if(
Œª¥o£
){

1088 
	`Œª¥o£_m©rix
(
l
.
weights
,†.
šputs
,†.
ouuts
);

1092 ià(
l
.
b©ch_nÜm®ize
 && (!l.
dÚßdsÿËs
)){

1093 
	`ä—d
(
l
.
sÿËs
, (),†.
ouuts
, 
å
);

1094 
	`ä—d
(
l
.
rŞlšg_m—n
, (),†.
ouuts
, 
å
);

1095 
	`ä—d
(
l
.
rŞlšg_v¬Ÿnû
, (),†.
ouuts
, 
å
);

1100 #ifdeà
GPU


1101 if(
gpu_šdex
 >= 0){

1102 
	`push_cÚÃùed_Ïy”
(
l
);

1105 
	}
}

1107 
	$lßd_b©chnÜm_weights
(
Ïy”
 
l
, 
FILE
 *
å
)

1109 
	`ä—d
(
l
.
sÿËs
, (),†.
c
, 
å
);

1110 
	`ä—d
(
l
.
rŞlšg_m—n
, (),†.
c
, 
å
);

1111 
	`ä—d
(
l
.
rŞlšg_v¬Ÿnû
, (),†.
c
, 
å
);

1112 #ifdeà
GPU


1113 if(
gpu_šdex
 >= 0){

1114 
	`push_b©chnÜm_Ïy”
(
l
);

1117 
	}
}

1119 
	$lßd_cÚvŞutiÚ®_weights_bš¬y
(
Ïy”
 
l
, 
FILE
 *
å
)

1121 
	`ä—d
(
l
.
bŸ£s
, (),†.
n
, 
å
);

1122 ià(
l
.
b©ch_nÜm®ize
 && (!l.
dÚßdsÿËs
)){

1123 
	`ä—d
(
l
.
sÿËs
, (),†.
n
, 
å
);

1124 
	`ä—d
(
l
.
rŞlšg_m—n
, (),†.
n
, 
å
);

1125 
	`ä—d
(
l
.
rŞlšg_v¬Ÿnû
, (),†.
n
, 
å
);

1127 
size
 = 
l
.
c
*l.size*l.size;

1128 
i
, 
j
, 
k
;

1129 
i
 = 0; i < 
l
.
n
; ++i){

1130 
m—n
 = 0;

1131 
	`ä—d
(&
m—n
, (), 1, 
å
);

1132 
j
 = 0; j < 
size
/8; ++j){

1133 
šdex
 = 
i
*
size
 + 
j
*8;

1134 
c
 = 0;

1135 
	`ä—d
(&
c
, (), 1, 
å
);

1136 
k
 = 0; k < 8; ++k){

1137 ià(
j
*8 + 
k
 >ğ
size
) ;

1138 
l
.
weights
[
šdex
 + 
k
] = (
c
 & 1<<kè? 
m—n
 : -mean;

1142 #ifdeà
GPU


1143 if(
gpu_šdex
 >= 0){

1144 
	`push_cÚvŞutiÚ®_Ïy”
(
l
);

1147 
	}
}

1149 
	$lßd_cÚvŞutiÚ®_weights
(
Ïy”
 
l
, 
FILE
 *
å
)

1151 if(
l
.
bš¬y
){

1155 
num
 = 
l
.
nweights
;

1156 
	`ä—d
(
l
.
bŸ£s
, (),†.
n
, 
å
);

1157 ià(
l
.
b©ch_nÜm®ize
 && (!l.
dÚßdsÿËs
)){

1158 
	`ä—d
(
l
.
sÿËs
, (),†.
n
, 
å
);

1159 
	`ä—d
(
l
.
rŞlšg_m—n
, (),†.
n
, 
å
);

1160 
	`ä—d
(
l
.
rŞlšg_v¬Ÿnû
, (),†.
n
, 
å
);

1162 
i
;

1163 
i
 = 0; i < 
l
.
n
; ++i){

1164 
	`´štf
("%g, ", 
l
.
rŞlšg_m—n
[
i
]);

1166 
	`´štf
("\n");

1167 
i
 = 0; i < 
l
.
n
; ++i){

1168 
	`´štf
("%g, ", 
l
.
rŞlšg_v¬Ÿnû
[
i
]);

1170 
	`´štf
("\n");

1173 
	`fl_ıu
(
l
.
n
, 0,†.
rŞlšg_m—n
, 1);

1174 
	`fl_ıu
(
l
.
n
, 0,†.
rŞlšg_v¬Ÿnû
, 1);

1177 
i
;

1178 
i
 = 0; i < 
l
.
n
; ++i){

1179 
	`´štf
("%g, ", 
l
.
rŞlšg_m—n
[
i
]);

1181 
	`´štf
("\n");

1182 
i
 = 0; i < 
l
.
n
; ++i){

1183 
	`´štf
("%g, ", 
l
.
rŞlšg_v¬Ÿnû
[
i
]);

1185 
	`´štf
("\n");

1188 
	`ä—d
(
l
.
weights
, (), 
num
, 
å
);

1190 ià(
l
.
æ³d
) {

1191 
	`Œª¥o£_m©rix
(
l
.
weights
,†.
c
*l.
size
*l.size,†.
n
);

1194 #ifdeà
GPU


1195 if(
gpu_šdex
 >= 0){

1196 
	`push_cÚvŞutiÚ®_Ïy”
(
l
);

1199 
	}
}

1202 
	$lßd_weights_u±o
(
ÃtwÜk
 *
Ãt
, *
f’ame
, 
¡¬t
, 
cutoff
)

1204 #ifdeà
GPU


1205 if(
Ãt
->
gpu_šdex
 >= 0){

1206 
	`cuda_£t_deviû
(
Ãt
->
gpu_šdex
);

1209 
	`årštf
(
¡d”r
, "Lßdšg weight äom %s...", 
f’ame
);

1210 
	`fæush
(
¡dout
);

1211 
FILE
 *
å
 = 
	`fİ’
(
f’ame
, "rb");

1212 if(!
å
è
	`fe_”rÜ
(
f’ame
);

1214 
majÜ
;

1215 
mšÜ
;

1216 
»visiÚ
;

1217 
	`ä—d
(&
majÜ
, (), 1, 
å
);

1218 
	`ä—d
(&
mšÜ
, (), 1, 
å
);

1219 
	`ä—d
(&
»visiÚ
, (), 1, 
å
);

1220 ià((
majÜ
*10 + 
mšÜ
) >= 2 && major < 1000 && minor < 1000){

1221 
	`ä—d
(
Ãt
->
£’
, (
size_t
), 1, 
å
);

1223 
i£’
 = 0;

1224 
	`ä—d
(&
i£’
, (), 1, 
å
);

1225 *
Ãt
->
£’
 = 
i£’
;

1227 
Œª¥o£
 = (
majÜ
 > 1000è|| (
mšÜ
 > 1000);

1229 
i
;

1230 
i
 = 
¡¬t
; i < 
Ãt
->
n
 && i < 
cutoff
; ++i){

1231 
Ïy”
 
l
 = 
Ãt
->
Ïy”s
[
i
];

1232 ià(
l
.
dÚßd
) ;

1233 if(
l
.
ty³
 =ğ
CONVOLUTIONAL
 ||†.ty³ =ğ
DECONVOLUTIONAL
){

1234 
	`lßd_cÚvŞutiÚ®_weights
(
l
, 
å
);

1236 if(
l
.
ty³
 =ğ
CONNECTED
){

1237 
	`lßd_cÚÃùed_weights
(
l
, 
å
, 
Œª¥o£
);

1239 if(
l
.
ty³
 =ğ
BATCHNORM
){

1240 
	`lßd_b©chnÜm_weights
(
l
, 
å
);

1242 if(
l
.
ty³
 =ğ
CRNN
){

1243 
	`lßd_cÚvŞutiÚ®_weights
(*(
l
.
šput_Ïy”
), 
å
);

1244 
	`lßd_cÚvŞutiÚ®_weights
(*(
l
.
£lf_Ïy”
), 
å
);

1245 
	`lßd_cÚvŞutiÚ®_weights
(*(
l
.
ouut_Ïy”
), 
å
);

1247 if(
l
.
ty³
 =ğ
RNN
){

1248 
	`lßd_cÚÃùed_weights
(*(
l
.
šput_Ïy”
), 
å
, 
Œª¥o£
);

1249 
	`lßd_cÚÃùed_weights
(*(
l
.
£lf_Ïy”
), 
å
, 
Œª¥o£
);

1250 
	`lßd_cÚÃùed_weights
(*(
l
.
ouut_Ïy”
), 
å
, 
Œª¥o£
);

1252 ià(
l
.
ty³
 =ğ
LSTM
) {

1253 
	`lßd_cÚÃùed_weights
(*(
l
.
wi
), 
å
, 
Œª¥o£
);

1254 
	`lßd_cÚÃùed_weights
(*(
l
.
wf
), 
å
, 
Œª¥o£
);

1255 
	`lßd_cÚÃùed_weights
(*(
l
.
wo
), 
å
, 
Œª¥o£
);

1256 
	`lßd_cÚÃùed_weights
(*(
l
.
wg
), 
å
, 
Œª¥o£
);

1257 
	`lßd_cÚÃùed_weights
(*(
l
.
ui
), 
å
, 
Œª¥o£
);

1258 
	`lßd_cÚÃùed_weights
(*(
l
.
uf
), 
å
, 
Œª¥o£
);

1259 
	`lßd_cÚÃùed_weights
(*(
l
.
uo
), 
å
, 
Œª¥o£
);

1260 
	`lßd_cÚÃùed_weights
(*(
l
.
ug
), 
å
, 
Œª¥o£
);

1262 ià(
l
.
ty³
 =ğ
GRU
) {

1264 
	`lßd_cÚÃùed_weights
(*(
l
.
wz
), 
å
, 
Œª¥o£
);

1265 
	`lßd_cÚÃùed_weights
(*(
l
.
wr
), 
å
, 
Œª¥o£
);

1266 
	`lßd_cÚÃùed_weights
(*(
l
.
wh
), 
å
, 
Œª¥o£
);

1267 
	`lßd_cÚÃùed_weights
(*(
l
.
uz
), 
å
, 
Œª¥o£
);

1268 
	`lßd_cÚÃùed_weights
(*(
l
.
ur
), 
å
, 
Œª¥o£
);

1269 
	`lßd_cÚÃùed_weights
(*(
l
.
uh
), 
å
, 
Œª¥o£
);

1271 
	`lßd_cÚÃùed_weights
(*(
l
.
»£t_Ïy”
), 
å
, 
Œª¥o£
);

1272 
	`lßd_cÚÃùed_weights
(*(
l
.
upd©e_Ïy”
), 
å
, 
Œª¥o£
);

1273 
	`lßd_cÚÃùed_weights
(*(
l
.
¡©e_Ïy”
), 
å
, 
Œª¥o£
);

1276 if(
l
.
ty³
 =ğ
LOCAL
){

1277 
loÿtiÚs
 = 
l
.
out_w
*l.
out_h
;

1278 
size
 = 
l
.size*l.size*l.
c
*l.
n
*
loÿtiÚs
;

1279 
	`ä—d
(
l
.
bŸ£s
, (),†.
ouuts
, 
å
);

1280 
	`ä—d
(
l
.
weights
, (), 
size
, 
å
);

1281 #ifdeà
GPU


1282 if(
gpu_šdex
 >= 0){

1283 
	`push_loÿl_Ïy”
(
l
);

1288 
	`årštf
(
¡d”r
, "Done!\n");

1289 
	`fşo£
(
å
);

1290 
	}
}

1292 
	$lßd_weights
(
ÃtwÜk
 *
Ãt
, *
f’ame
)

1294 
	`lßd_weights_u±o
(
Ãt
, 
f’ame
, 0,‚‘->
n
);

1295 
	}
}

	@parser.h

1 #iâdeà
PARSER_H


2 
	#PARSER_H


	)

3 
	~"d¬kÃt.h
"

4 
	~"ÃtwÜk.h
"

6 
§ve_ÃtwÜk
(
ÃtwÜk
 
Ãt
, *
f’ame
);

7 
§ve_weights_doubË
(
ÃtwÜk
 
Ãt
, *
f’ame
);

	@region_layer.c

1 
	~"»giÚ_Ïy”.h
"

2 
	~"aùiv©iÚs.h
"

3 
	~"bÏs.h
"

4 
	~"box.h
"

5 
	~"cuda.h
"

6 
	~"uts.h
"

8 
	~<¡dio.h
>

9 
	~<as£¹.h
>

10 
	~<¡ršg.h
>

11 
	~<¡dlib.h
>

13 
Ïy”
 
	$make_»giÚ_Ïy”
(
b©ch
, 
w
, 
h
, 
n
, 
şas£s
, 
coÜds
)

15 
Ïy”
 
l
 = {0};

16 
l
.
ty³
 = 
REGION
;

18 
l
.
n
 =‚;

19 
l
.
b©ch
 = batch;

20 
l
.
h
 = h;

21 
l
.
w
 = w;

22 
l
.
c
 = 
n
*(
şas£s
 + 
coÜds
 + 1);

23 
l
.
out_w
 =†.
w
;

24 
l
.
out_h
 =†.
h
;

25 
l
.
out_c
 =†.
c
;

26 
l
.
şas£s
 = classes;

27 
l
.
coÜds
 = coords;

28 
l
.
co¡
 = 
	`ÿÎoc
(1, ());

29 
l
.
bŸ£s
 = 
	`ÿÎoc
(
n
*2, ());

30 
l
.
bŸs_upd©es
 = 
	`ÿÎoc
(
n
*2, ());

31 
l
.
ouuts
 = 
h
*
w
*
n
*(
şas£s
 + 
coÜds
 + 1);

32 
l
.
šputs
 =†.
ouuts
;

33 
l
.
Œuths
 = 30*Ö.
coÜds
 + 1);

34 
l
.
d–
 = 
	`ÿÎoc
(
b©ch
*l.
ouuts
, ());

35 
l
.
ouut
 = 
	`ÿÎoc
(
b©ch
*l.
ouuts
, ());

36 
i
;

37 
i
 = 0; i < 
n
*2; ++i){

38 
l
.
bŸ£s
[
i
] = .5;

41 
l
.
fÜw¬d
 = 
fÜw¬d_»giÚ_Ïy”
;

42 
l
.
backw¬d
 = 
backw¬d_»giÚ_Ïy”
;

43 #ifdeà
GPU


44 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_»giÚ_Ïy”_gpu
;

45 
l
.
backw¬d_gpu
 = 
backw¬d_»giÚ_Ïy”_gpu
;

46 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
, 
b©ch
*l.
ouuts
);

47 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
, 
b©ch
*l.
ouuts
);

50 
	`årštf
(
¡d”r
, "detection\n");

51 
	`¤ªd
(0);

53  
l
;

54 
	}
}

56 
	$»size_»giÚ_Ïy”
(
Ïy”
 *
l
, 
w
, 
h
)

58 
l
->
w
 = w;

59 
l
->
h
 = h;

61 
l
->
ouuts
 = 
h
*
w
*l->
n
*Ö->
şas£s
 +†->
coÜds
 + 1);

62 
l
->
šputs
 =†->
ouuts
;

64 
l
->
ouut
 = 
	`»®loc
Ö->ouut,†->
b©ch
*l->
ouuts
*());

65 
l
->
d–
 = 
	`»®loc
Ö->d–,†->
b©ch
*l->
ouuts
*());

67 #ifdeà
GPU


68 
	`cuda_ä“
(
l
->
d–_gpu
);

69 
	`cuda_ä“
(
l
->
ouut_gpu
);

71 
l
->
d–_gpu
 = 
	`cuda_make_¬¿y
Ö->
d–
,†->
b©ch
*l->
ouuts
);

72 
l
->
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö->
ouut
,†->
b©ch
*l->
ouuts
);

74 
	}
}

76 
box
 
	$g‘_»giÚ_box
(*
x
, *
bŸ£s
, 
n
, 
šdex
, 
i
, 
j
, 
w
, 
h
, 
¡ride
)

78 
box
 
b
;

79 
b
.
x
 = (
i
 + x[
šdex
 + 0*
¡ride
]è/ 
w
;

80 
b
.
y
 = (
j
 + 
x
[
šdex
 + 1*
¡ride
]è/ 
h
;

81 
b
.
w
 = 
	`exp
(
x
[
šdex
 + 2*
¡ride
]è* 
bŸ£s
[2*
n
] / w;

82 
b
.
h
 = 
	`exp
(
x
[
šdex
 + 3*
¡ride
]è* 
bŸ£s
[2*
n
+1] / h;

83  
b
;

84 
	}
}

86 
	$d–_»giÚ_box
(
box
 
Œuth
, *
x
, *
bŸ£s
, 
n
, 
šdex
, 
i
, 
j
, 
w
, 
h
, *
d–
, 
sÿË
, 
¡ride
)

88 
box
 
´ed
 = 
	`g‘_»giÚ_box
(
x
, 
bŸ£s
, 
n
, 
šdex
, 
i
, 
j
, 
w
, 
h
, 
¡ride
);

89 
iou
 = 
	`box_iou
(
´ed
, 
Œuth
);

91 
tx
 = (
Œuth
.
x
*
w
 - 
i
);

92 
ty
 = (
Œuth
.
y
*
h
 - 
j
);

93 
tw
 = 
	`log
(
Œuth
.
w
*w / 
bŸ£s
[2*
n
]);

94 
th
 = 
	`log
(
Œuth
.
h
*h / 
bŸ£s
[2*
n
 + 1]);

96 
d–
[
šdex
 + 0*
¡ride
] = 
sÿË
 * (
tx
 - 
x
[index + 0*stride]);

97 
d–
[
šdex
 + 1*
¡ride
] = 
sÿË
 * (
ty
 - 
x
[index + 1*stride]);

98 
d–
[
šdex
 + 2*
¡ride
] = 
sÿË
 * (
tw
 - 
x
[index + 2*stride]);

99 
d–
[
šdex
 + 3*
¡ride
] = 
sÿË
 * (
th
 - 
x
[index + 3*stride]);

100  
iou
;

101 
	}
}

103 
	$d–_»giÚ_mask
(*
Œuth
, *
x
, 
n
, 
šdex
, *
d–
, 
¡ride
, 
sÿË
)

105 
i
;

106 
i
 = 0; i < 
n
; ++i){

107 
d–
[
šdex
 + 
i
*
¡ride
] = 
sÿË
*(
Œuth
[i] - 
x
[index + i*stride]);

109 
	}
}

112 
	$d–_»giÚ_şass
(*
ouut
, *
d–
, 
šdex
, 
şass
, 
şas£s
, 
Œ“
 *
h›r
, 
sÿË
, 
¡ride
, *
avg_ÿt
, 
g
)

114 
i
, 
n
;

115 if(
h›r
){

116 
´ed
 = 1;

117 
şass
 >= 0){

118 
´ed
 *ğ
ouut
[
šdex
 + 
¡ride
*
şass
];

119 
g
 = 
h›r
->
group
[
şass
];

120 
off£t
 = 
h›r
->
group_off£t
[
g
];

121 
i
 = 0; i < 
h›r
->
group_size
[
g
]; ++i){

122 
d–
[
šdex
 + 
¡ride
*(
off£t
 + 
i
)] = 
sÿË
 * (0 - 
ouut
[index + stride*(offset + i)]);

124 
d–
[
šdex
 + 
¡ride
*
şass
] = 
sÿË
 * (1 - 
ouut
[index + stride*class]);

126 
şass
 = 
h›r
->
·»Á
[class];

128 *
avg_ÿt
 +ğ
´ed
;

130 ià(
d–
[
šdex
] && 
g
){

131 
d–
[
šdex
 + 
¡ride
*
şass
] = 
sÿË
 * (1 - 
ouut
[index + stride*class]);

134 
n
 = 0;‚ < 
şas£s
; ++n){

135 
d–
[
šdex
 + 
¡ride
*
n
] = 
sÿË
 * ((Ò =ğ
şass
)?1 : 0è- 
ouut
[index + stride*n]);

136 if(
n
 =ğ
şass
è*
avg_ÿt
 +ğ
ouut
[
šdex
 + 
¡ride
*n];

139 
	}
}

141 
	$log™
(
x
)

143  
	`log
(
x
/(1.-x));

144 
	}
}

146 
	$ti¢ª
(
x
)

148  (
x
 != x);

149 
	}
}

151 
	$’Œy_šdex
(
Ïy”
 
l
, 
b©ch
, 
loÿtiÚ
, 
’Œy
)

153 
n
 = 
loÿtiÚ
 / (
l
.
w
*l.
h
);

154 
loc
 = 
loÿtiÚ
 % (
l
.
w
*l.
h
);

155  
b©ch
*
l
.
ouuts
 + 
n
*l.
w
*l.
h
*Ö.
coÜds
+l.
şas£s
+1è+ 
’Œy
*l.w*l.h + 
loc
;

156 
	}
}

158 
	$fÜw¬d_»giÚ_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

160 
i
,
j
,
b
,
t
,
n
;

161 
	`memıy
(
l
.
ouut
, 
Ãt
.
šput
,†.
ouuts
*l.
b©ch
*());

163 #iâdeà
GPU


164 
b
 = 0; b < 
l
.
b©ch
; ++b){

165 
n
 = 0;‚ < 
l
.n; ++n){

166 
šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
, 0);

167 
	`aùiv©e_¬¿y
(
l
.
ouut
 + 
šdex
, 2*l.
w
*l.
h
, 
LOGISTIC
);

168 
šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
,†.
coÜds
);

169 if(!
l
.
background
è
	`aùiv©e_¬¿y
Ö.
ouut
 + 
šdex
,†.
w
*l.
h
, 
LOGISTIC
);

170 
šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
,†.
coÜds
 + 1);

171 if(!
l
.
soámax
 && !l.
soámax_Œ“
è
	`aùiv©e_¬¿y
Ö.
ouut
 + 
šdex
,†.
şas£s
*l.
w
*l.
h
, 
LOGISTIC
);

174 ià(
l
.
soámax_Œ“
){

175 
i
;

176 
couÁ
 = 
l
.
coÜds
 + 1;

177 
i
 = 0; i < 
l
.
soámax_Œ“
->
groups
; ++i) {

178 
group_size
 = 
l
.
soámax_Œ“
->group_size[
i
];

179 
	`soámax_ıu
(
Ãt
.
šput
 + 
couÁ
, 
group_size
, 
l
.
b©ch
,†.
šputs
,†.
n
*l.
w
*l.
h
, 1,†.n*l.w*l.h,†.
‹m³¿tu»
,†.
ouut
 + count);

180 
couÁ
 +ğ
group_size
;

182 } ià(
l
.
soámax
){

183 
šdex
 = 
	`’Œy_šdex
(
l
, 0, 0,†.
coÜds
 + !l.
background
);

184 
	`soámax_ıu
(
Ãt
.
šput
 + 
šdex
, 
l
.
şas£s
 +†.
background
,†.
b©ch
*l.
n
,†.
šputs
/l.n,†.
w
*l.
h
, 1,†.w*l.h, 1,†.
ouut
 + index);

188 
	`mem£t
(
l
.
d–
, 0,†.
ouuts
 *†.
b©ch
 * ());

189 if(!
Ãt
.
Œaš
) ;

190 
avg_iou
 = 0;

191 
»ÿÎ
 = 0;

192 
avg_ÿt
 = 0;

193 
avg_obj
 = 0;

194 
avg_ªyobj
 = 0;

195 
couÁ
 = 0;

196 
şass_couÁ
 = 0;

197 *(
l
.
co¡
) = 0;

198 
b
 = 0; b < 
l
.
b©ch
; ++b) {

199 if(
l
.
soámax_Œ“
){

200 
Úlyşass
 = 0;

201 
t
 = 0; < 30; ++t){

202 
box
 
Œuth
 = 
	`æßt_to_box
(
Ãt
.Œuth + 
t
*(
l
.
coÜds
 + 1è+ 
b
*l.
Œuths
, 1);

203 if(!
Œuth
.
x
) ;

204 
şass
 = 
Ãt
.
Œuth
[
t
*(
l
.
coÜds
 + 1è+ 
b
*l.
Œuths
 +†.coords];

205 
maxp
 = 0;

206 
maxi
 = 0;

207 if(
Œuth
.
x
 > 100000 &&ruth.
y
 > 100000){

208 
n
 = 0;‚ < 
l
.n*l.
w
*l.
h
; ++n){

209 
şass_šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
,†.
coÜds
 + 1);

210 
obj_šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
,†.
coÜds
);

211 
sÿË
 = 
l
.
ouut
[
obj_šdex
];

212 
l
.
d–
[
obj_šdex
] =†.
noobjeù_sÿË
 * (0 -†.
ouut
[obj_index]);

213 
p
 = 
sÿË
*
	`g‘_h›¿rchy_´obab™y
(
l
.
ouut
 + 
şass_šdex
,†.
soámax_Œ“
, 
şass
,†.
w
*l.
h
);

214 if(
p
 > 
maxp
){

215 
maxp
 = 
p
;

216 
maxi
 = 
n
;

219 
şass_šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
maxi
,†.
coÜds
 + 1);

220 
obj_šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
maxi
,†.
coÜds
);

221 
	`d–_»giÚ_şass
(
l
.
ouut
,†.
d–
, 
şass_šdex
, 
şass
,†.
şas£s
,†.
soámax_Œ“
,†.
şass_sÿË
,†.
w
*l.
h
, &
avg_ÿt
, !l.
soámax
);

222 if(
l
.
ouut
[
obj_šdex
] < .3èl.
d–
[obj_šdex] =†.
objeù_sÿË
 * (.3 -†.output[obj_index]);

223 
l
.
d–
[
obj_šdex
] = 0;

224 
l
.
d–
[
obj_šdex
] = 0;

225 ++
şass_couÁ
;

226 
Úlyşass
 = 1;

230 if(
Úlyşass
) ;

232 
j
 = 0; j < 
l
.
h
; ++j) {

233 
i
 = 0; i < 
l
.
w
; ++i) {

234 
n
 = 0;‚ < 
l
.n; ++n) {

235 
box_šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
 + 
j
*l.w + 
i
, 0);

236 
box
 
´ed
 = 
	`g‘_»giÚ_box
(
l
.
ouut
,†.
bŸ£s
, 
n
, 
box_šdex
, 
i
, 
j
,†.
w
,†.
h
,†.w*l.h);

237 
be¡_iou
 = 0;

238 
t
 = 0; < 30; ++t){

239 
box
 
Œuth
 = 
	`æßt_to_box
(
Ãt
.Œuth + 
t
*(
l
.
coÜds
 + 1è+ 
b
*l.
Œuths
, 1);

240 if(!
Œuth
.
x
) ;

241 
iou
 = 
	`box_iou
(
´ed
, 
Œuth
);

242 ià(
iou
 > 
be¡_iou
) {

243 
be¡_iou
 = 
iou
;

246 
obj_šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
 + 
j
*l.w + 
i
,†.
coÜds
);

247 
avg_ªyobj
 +ğ
l
.
ouut
[
obj_šdex
];

248 
l
.
d–
[
obj_šdex
] =†.
noobjeù_sÿË
 * (0 -†.
ouut
[obj_index]);

249 if(
l
.
background
èl.
d–
[
obj_šdex
] =†.
noobjeù_sÿË
 * (1 -†.
ouut
[obj_index]);

250 ià(
be¡_iou
 > 
l
.
th»sh
) {

251 
l
.
d–
[
obj_šdex
] = 0;

254 if(*(
Ãt
.
£’
) < 12800){

255 
box
 
Œuth
 = {0};

256 
Œuth
.
x
 = (
i
 + .5)/
l
.
w
;

257 
Œuth
.
y
 = (
j
 + .5)/
l
.
h
;

258 
Œuth
.
w
 = 
l
.
bŸ£s
[2*
n
]/l.w;

259 
Œuth
.
h
 = 
l
.
bŸ£s
[2*
n
+1]/l.h;

260 
	`d–_»giÚ_box
(
Œuth
, 
l
.
ouut
,†.
bŸ£s
, 
n
, 
box_šdex
, 
i
, 
j
,†.
w
,†.
h
,†.
d–
, .01,†.w*l.h);

265 
t
 = 0; < 30; ++t){

266 
box
 
Œuth
 = 
	`æßt_to_box
(
Ãt
.Œuth + 
t
*(
l
.
coÜds
 + 1è+ 
b
*l.
Œuths
, 1);

268 if(!
Œuth
.
x
) ;

269 
be¡_iou
 = 0;

270 
be¡_n
 = 0;

271 
i
 = (
Œuth
.
x
 * 
l
.
w
);

272 
j
 = (
Œuth
.
y
 * 
l
.
h
);

273 
box
 
Œuth_shiá
 = 
Œuth
;

274 
Œuth_shiá
.
x
 = 0;

275 
Œuth_shiá
.
y
 = 0;

276 
n
 = 0;‚ < 
l
.n; ++n){

277 
box_šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
 + 
j
*l.w + 
i
, 0);

278 
box
 
´ed
 = 
	`g‘_»giÚ_box
(
l
.
ouut
,†.
bŸ£s
, 
n
, 
box_šdex
, 
i
, 
j
,†.
w
,†.
h
,†.w*l.h);

279 if(
l
.
bŸs_m©ch
){

280 
´ed
.
w
 = 
l
.
bŸ£s
[2*
n
]/l.w;

281 
´ed
.
h
 = 
l
.
bŸ£s
[2*
n
+1]/l.h;

283 
´ed
.
x
 = 0;

284 
´ed
.
y
 = 0;

285 
iou
 = 
	`box_iou
(
´ed
, 
Œuth_shiá
);

286 ià(
iou
 > 
be¡_iou
){

287 
be¡_iou
 = 
iou
;

288 
be¡_n
 = 
n
;

292 
box_šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
be¡_n
*l.
w
*l.
h
 + 
j
*l.w + 
i
, 0);

293 
iou
 = 
	`d–_»giÚ_box
(
Œuth
, 
l
.
ouut
,†.
bŸ£s
, 
be¡_n
, 
box_šdex
, 
i
, 
j
,†.
w
,†.
h
,†.
d–
,†.
coÜd_sÿË
 * (2 -ruth.w*truth.h),†.w*l.h);

294 if(
l
.
coÜds
 > 4){

295 
mask_šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
be¡_n
*l.
w
*l.
h
 + 
j
*l.w + 
i
, 4);

296 
	`d–_»giÚ_mask
(
Ãt
.
Œuth
 + 
t
*(
l
.
coÜds
 + 1è+ 
b
*l.
Œuths
 + 5,†.
ouut
,†.coÜd - 4, 
mask_šdex
,†.
d–
,†.
w
*l.
h
,†.
mask_sÿË
);

298 if(
iou
 > .5è
»ÿÎ
 += 1;

299 
avg_iou
 +ğ
iou
;

301 
obj_šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
be¡_n
*l.
w
*l.
h
 + 
j
*l.w + 
i
,†.
coÜds
);

302 
avg_obj
 +ğ
l
.
ouut
[
obj_šdex
];

303 
l
.
d–
[
obj_šdex
] =†.
objeù_sÿË
 * (1 -†.
ouut
[obj_index]);

304 ià(
l
.
»scÜe
) {

305 
l
.
d–
[
obj_šdex
] =†.
objeù_sÿË
 * (
iou
 -†.
ouut
[obj_index]);

307 if(
l
.
background
){

308 
l
.
d–
[
obj_šdex
] =†.
objeù_sÿË
 * (0 -†.
ouut
[obj_index]);

311 
şass
 = 
Ãt
.
Œuth
[
t
*(
l
.
coÜds
 + 1è+ 
b
*l.
Œuths
 +†.coords];

312 ià(
l
.
m­
è
şass
 =†.map[class];

313 
şass_šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
be¡_n
*l.
w
*l.
h
 + 
j
*l.w + 
i
,†.
coÜds
 + 1);

314 
	`d–_»giÚ_şass
(
l
.
ouut
,†.
d–
, 
şass_šdex
, 
şass
,†.
şas£s
,†.
soámax_Œ“
,†.
şass_sÿË
,†.
w
*l.
h
, &
avg_ÿt
, !l.
soámax
);

315 ++
couÁ
;

316 ++
şass_couÁ
;

319 *(
l
.
co¡
èğ
	`pow
(
	`mag_¬¿y
Ö.
d–
,†.
ouuts
 *†.
b©ch
), 2);

320 
	`´štf
("RegiÚ Avg IOU: %f, CÏss: %f, Obj: %f, NØObj: %f, Avg ReÿÎ: %f, couÁ: %d\n", 
avg_iou
/
couÁ
, 
avg_ÿt
/
şass_couÁ
, 
avg_obj
/couÁ, 
avg_ªyobj
/(
l
.
w
*l.
h
*l.
n
*l.
b©ch
), 
»ÿÎ
/count, count);

321 
	}
}

323 
	$backw¬d_»giÚ_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

334 
	}
}

336 
	$cÜ»ù_»giÚ_boxes
(
d‘eùiÚ
 *
d‘s
, 
n
, 
w
, 
h
, 
Ãtw
, 
Ãth
, 
»Ïtive
)

338 
i
;

339 
Ãw_w
=0;

340 
Ãw_h
=0;

341 ià((()
Ãtw
/
w
è< (()
Ãth
/
h
)) {

342 
Ãw_w
 = 
Ãtw
;

343 
Ãw_h
 = (
h
 * 
Ãtw
)/
w
;

345 
Ãw_h
 = 
Ãth
;

346 
Ãw_w
 = (
w
 * 
Ãth
)/
h
;

348 
i
 = 0; i < 
n
; ++i){

349 
box
 
b
 = 
d‘s
[
i
].
bbox
;

350 
b
.
x
 = (b.x - (
Ãtw
 - 
Ãw_w
)/2./netw) / (()new_w/netw);

351 
b
.
y
 = (b.y - (
Ãth
 - 
Ãw_h
)/2./neth) / (()new_h/neth);

352 
b
.
w
 *ğ()
Ãtw
/
Ãw_w
;

353 
b
.
h
 *ğ()
Ãth
/
Ãw_h
;

354 if(!
»Ïtive
){

355 
b
.
x
 *ğ
w
;

356 
b
.
w
 *= w;

357 
b
.
y
 *ğ
h
;

358 
b
.
h
 *= h;

360 
d‘s
[
i
].
bbox
 = 
b
;

362 
	}
}

364 
	$g‘_»giÚ_d‘eùiÚs
(
Ïy”
 
l
, 
w
, 
h
, 
Ãtw
, 
Ãth
, 
th»sh
, *
m­
, 
Œ“_th»sh
, 
»Ïtive
, 
d‘eùiÚ
 *
d‘s
)

366 
i
,
j
,
n
,
z
;

367 *
´ediùiÚs
 = 
l
.
ouut
;

368 ià(
l
.
b©ch
 == 2) {

369 *
æ
 = 
l
.
ouut
 +†.
ouuts
;

370 
j
 = 0; j < 
l
.
h
; ++j) {

371 
i
 = 0; i < 
l
.
w
/2; ++i) {

372 
n
 = 0;‚ < 
l
.n; ++n) {

373 
z
 = 0; z < 
l
.
şas£s
 +†.
coÜds
 + 1; ++z){

374 
i1
 = 
z
*
l
.
w
*l.
h
*l.
n
 +‚*l.w*l.h + 
j
*l.w + 
i
;

375 
i2
 = 
z
*
l
.
w
*l.
h
*l.
n
 +‚*l.w*l.h + 
j
*l.w + (l.w - 
i
 - 1);

376 
sw­
 = 
æ
[
i1
];

377 
æ
[
i1
] = fl[
i2
];

378 
æ
[
i2
] = 
sw­
;

379 if(
z
 == 0){

380 
æ
[
i1
] = -flip[i1];

381 
æ
[
i2
] = -flip[i2];

387 
i
 = 0; i < 
l
.
ouuts
; ++i){

388 
l
.
ouut
[
i
] = (l.ouut[i] + 
æ
[i])/2.;

391 
i
 = 0; i < 
l
.
w
*l.
h
; ++i){

392 
row
 = 
i
 / 
l
.
w
;

393 
cŞ
 = 
i
 % 
l
.
w
;

394 
n
 = 0;‚ < 
l
.n; ++n){

395 
šdex
 = 
n
*
l
.
w
*l.
h
 + 
i
;

396 
j
 = 0; j < 
l
.
şas£s
; ++j){

397 
d‘s
[
šdex
].
´ob
[
j
] = 0;

399 
obj_šdex
 = 
	`’Œy_šdex
(
l
, 0, 
n
*l.
w
*l.
h
 + 
i
,†.
coÜds
);

400 
box_šdex
 = 
	`’Œy_šdex
(
l
, 0, 
n
*l.
w
*l.
h
 + 
i
, 0);

401 
mask_šdex
 = 
	`’Œy_šdex
(
l
, 0, 
n
*l.
w
*l.
h
 + 
i
, 4);

402 
sÿË
 = 
l
.
background
 ? 1 : 
´ediùiÚs
[
obj_šdex
];

403 
d‘s
[
šdex
].
bbox
 = 
	`g‘_»giÚ_box
(
´ediùiÚs
, 
l
.
bŸ£s
, 
n
, 
box_šdex
, 
cŞ
, 
row
,†.
w
,†.
h
,†.w*l.h);

404 
d‘s
[
šdex
].
objeùÃss
 = 
sÿË
 > 
th»sh
 ? scale : 0;

405 if(
d‘s
[
šdex
].
mask
){

406 
j
 = 0; j < 
l
.
coÜds
 - 4; ++j){

407 
d‘s
[
šdex
].
mask
[
j
] = 
l
.
ouut
[
mask_šdex
 + j*l.
w
*l.
h
];

411 
şass_šdex
 = 
	`’Œy_šdex
(
l
, 0, 
n
*l.
w
*l.
h
 + 
i
,†.
coÜds
 + !l.
background
);

412 if(
l
.
soámax_Œ“
){

414 
	`h›¿rchy_´ediùiÚs
(
´ediùiÚs
 + 
şass_šdex
, 
l
.
şas£s
,†.
soámax_Œ“
, 0,†.
w
*l.
h
);

415 if(
m­
){

416 
j
 = 0; j < 200; ++j){

417 
şass_šdex
 = 
	`’Œy_šdex
(
l
, 0, 
n
*l.
w
*l.
h
 + 
i
,†.
coÜds
 + 1 + 
m­
[
j
]);

418 
´ob
 = 
sÿË
*
´ediùiÚs
[
şass_šdex
];

419 
d‘s
[
šdex
].
´ob
[
j
] = (´ob > 
th»sh
) ?…rob : 0;

422 
j
 = 
	`h›¿rchy_tİ_´ediùiÚ
(
´ediùiÚs
 + 
şass_šdex
, 
l
.
soámax_Œ“
, 
Œ“_th»sh
,†.
w
*l.
h
);

423 
d‘s
[
šdex
].
´ob
[
j
] = (
sÿË
 > 
th»sh
) ? scale : 0;

426 if(
d‘s
[
šdex
].
objeùÃss
){

427 
j
 = 0; j < 
l
.
şas£s
; ++j){

428 
şass_šdex
 = 
	`’Œy_šdex
(
l
, 0, 
n
*l.
w
*l.
h
 + 
i
,†.
coÜds
 + 1 + 
j
);

429 
´ob
 = 
sÿË
*
´ediùiÚs
[
şass_šdex
];

430 
d‘s
[
šdex
].
´ob
[
j
] = (´ob > 
th»sh
) ?…rob : 0;

436 
	`cÜ»ù_»giÚ_boxes
(
d‘s
, 
l
.
w
*l.
h
*l.
n
, w, h, 
Ãtw
, 
Ãth
, 
»Ïtive
);

437 
	}
}

439 #ifdeà
GPU


441 
	$fÜw¬d_»giÚ_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

443 
	`cİy_gpu
(
l
.
b©ch
*l.
šputs
, 
Ãt
.
šput_gpu
, 1,†.
ouut_gpu
, 1);

444 
b
, 
n
;

445 
b
 = 0; b < 
l
.
b©ch
; ++b){

446 
n
 = 0;‚ < 
l
.n; ++n){

447 
šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
, 0);

448 
	`aùiv©e_¬¿y_gpu
(
l
.
ouut_gpu
 + 
šdex
, 2*l.
w
*l.
h
, 
LOGISTIC
);

449 if(
l
.
coÜds
 > 4){

450 
šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
, 4);

451 
	`aùiv©e_¬¿y_gpu
(
l
.
ouut_gpu
 + 
šdex
, (l.
coÜds
 - 4)*l.
w
*l.
h
, 
LOGISTIC
);

453 
šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
,†.
coÜds
);

454 if(!
l
.
background
è
	`aùiv©e_¬¿y_gpu
Ö.
ouut_gpu
 + 
šdex
,†.
w
*l.
h
, 
LOGISTIC
);

455 
šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
,†.
coÜds
 + 1);

456 if(!
l
.
soámax
 && !l.
soámax_Œ“
è
	`aùiv©e_¬¿y_gpu
Ö.
ouut_gpu
 + 
šdex
,†.
şas£s
*l.
w
*l.
h
, 
LOGISTIC
);

459 ià(
l
.
soámax_Œ“
){

460 
šdex
 = 
	`’Œy_šdex
(
l
, 0, 0,†.
coÜds
 + 1);

461 
	`soámax_Œ“
(
Ãt
.
šput_gpu
 + 
šdex
, 
l
.
w
*l.
h
,†.
b©ch
*l.
n
,†.
šputs
/l.n, 1,†.
ouut_gpu
 + index, *l.
soámax_Œ“
);

462 } ià(
l
.
soámax
) {

463 
šdex
 = 
	`’Œy_šdex
(
l
, 0, 0,†.
coÜds
 + !l.
background
);

464 
	`soámax_gpu
(
Ãt
.
šput_gpu
 + 
šdex
, 
l
.
şas£s
 +†.
background
,†.
b©ch
*l.
n
,†.
šputs
/l.n,†.
w
*l.
h
, 1,†.w*l.h, 1,†.
ouut_gpu
 + index);

466 if(!
Ãt
.
Œaš
 || 
l
.
ÚlyfÜw¬d
){

467 
	`cuda_puÎ_¬¿y
(
l
.
ouut_gpu
,†.
ouut
,†.
b©ch
*l.
ouuts
);

471 
	`cuda_puÎ_¬¿y
(
l
.
ouut_gpu
, 
Ãt
.
šput
,†.
b©ch
*l.
šputs
);

472 
	`fÜw¬d_»giÚ_Ïy”
(
l
, 
Ãt
);

474 if(!
Ãt
.
Œaš
) ;

475 
	`cuda_push_¬¿y
(
l
.
d–_gpu
,†.
d–
,†.
b©ch
*l.
ouuts
);

476 
	}
}

478 
	$backw¬d_»giÚ_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

480 
b
, 
n
;

481 
b
 = 0; b < 
l
.
b©ch
; ++b){

482 
n
 = 0;‚ < 
l
.n; ++n){

483 
šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
, 0);

484 
	`g¿d›Á_¬¿y_gpu
(
l
.
ouut_gpu
 + 
šdex
, 2*l.
w
*l.
h
, 
LOGISTIC
,†.
d–_gpu
 + index);

485 if(
l
.
coÜds
 > 4){

486 
šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
, 4);

487 
	`g¿d›Á_¬¿y_gpu
(
l
.
ouut_gpu
 + 
šdex
, (l.
coÜds
 - 4)*l.
w
*l.
h
, 
LOGISTIC
,†.
d–_gpu
 + index);

489 
šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
,†.
coÜds
);

490 if(!
l
.
background
è
	`g¿d›Á_¬¿y_gpu
Ö.
ouut_gpu
 + 
šdex
,†.
w
*l.
h
, 
LOGISTIC
,†.
d–_gpu
 + index);

493 
	`axpy_gpu
(
l
.
b©ch
*l.
šputs
, 1,†.
d–_gpu
, 1, 
Ãt
.delta_gpu, 1);

494 
	}
}

497 
	$z”o_objeùÃss
(
Ïy”
 
l
)

499 
i
, 
n
;

500 
i
 = 0; i < 
l
.
w
*l.
h
; ++i){

501 
n
 = 0;‚ < 
l
.n; ++n){

502 
obj_šdex
 = 
	`’Œy_šdex
(
l
, 0, 
n
*l.
w
*l.
h
 + 
i
,†.
coÜds
);

503 
l
.
ouut
[
obj_šdex
] = 0;

506 
	}
}

	@region_layer.h

1 #iâdeà
REGION_LAYER_H


2 
	#REGION_LAYER_H


	)

4 
	~"d¬kÃt.h
"

5 
	~"Ïy”.h
"

6 
	~"ÃtwÜk.h
"

8 
Ïy”
 
make_»giÚ_Ïy”
(
b©ch
, 
w
, 
h
, 
n
, 
şas£s
, 
coÜds
);

9 
fÜw¬d_»giÚ_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

10 
backw¬d_»giÚ_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

11 
»size_»giÚ_Ïy”
(
Ïy”
 *
l
, 
w
, 
h
);

13 #ifdeà
GPU


14 
fÜw¬d_»giÚ_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

15 
backw¬d_»giÚ_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

	@reorg_layer.c

1 
	~"»Üg_Ïy”.h
"

2 
	~"cuda.h
"

3 
	~"bÏs.h
"

5 
	~<¡dio.h
>

8 
Ïy”
 
	$make_»Üg_Ïy”
(
b©ch
, 
w
, 
h
, 
c
, 
¡ride
, 
»v”£
, 
æ©‹n
, 
exŒa
)

10 
Ïy”
 
l
 = {0};

11 
l
.
ty³
 = 
REORG
;

12 
l
.
b©ch
 = batch;

13 
l
.
¡ride
 = stride;

14 
l
.
exŒa
 =ƒxtra;

15 
l
.
h
 = h;

16 
l
.
w
 = w;

17 
l
.
c
 = c;

18 
l
.
æ©‹n
 = flatten;

19 if(
»v”£
){

20 
l
.
out_w
 = 
w
*
¡ride
;

21 
l
.
out_h
 = 
h
*
¡ride
;

22 
l
.
out_c
 = 
c
/(
¡ride
*stride);

24 
l
.
out_w
 = 
w
/
¡ride
;

25 
l
.
out_h
 = 
h
/
¡ride
;

26 
l
.
out_c
 = 
c
*(
¡ride
*stride);

28 
l
.
»v”£
 =„everse;

30 
l
.
ouuts
 =†.
out_h
 *†.
out_w
 *†.
out_c
;

31 
l
.
šputs
 = 
h
*
w
*
c
;

32 if(
l
.
exŒa
){

33 
l
.
out_w
 =†.
out_h
 =†.
out_c
 = 0;

34 
l
.
ouuts
 =†.
šputs
 +†.
exŒa
;

37 if(
exŒa
){

38 
	`årštf
(
¡d”r
, "»Üg %4d -> %4d\n", 
l
.
šputs
,†.
ouuts
);

40 
	`årštf
(
¡d”r
, "»Üg /%2d %4d x%4d x%4d -> %4d x%4d x%4d\n", 
¡ride
, 
w
, 
h
, 
c
, 
l
.
out_w
,†.
out_h
,†.
out_c
);

42 
ouut_size
 = 
l
.
ouuts
 * 
b©ch
;

43 
l
.
ouut
 = 
	`ÿÎoc
(
ouut_size
, ());

44 
l
.
d–
 = 
	`ÿÎoc
(
ouut_size
, ());

46 
l
.
fÜw¬d
 = 
fÜw¬d_»Üg_Ïy”
;

47 
l
.
backw¬d
 = 
backw¬d_»Üg_Ïy”
;

48 #ifdeà
GPU


49 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_»Üg_Ïy”_gpu
;

50 
l
.
backw¬d_gpu
 = 
backw¬d_»Üg_Ïy”_gpu
;

52 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
, 
ouut_size
);

53 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
, 
ouut_size
);

55  
l
;

56 
	}
}

58 
	$»size_»Üg_Ïy”
(
Ïy”
 *
l
, 
w
, 
h
)

60 
¡ride
 = 
l
->stride;

61 
c
 = 
l
->c;

63 
l
->
h
 = h;

64 
l
->
w
 = w;

66 if(
l
->
»v”£
){

67 
l
->
out_w
 = 
w
*
¡ride
;

68 
l
->
out_h
 = 
h
*
¡ride
;

69 
l
->
out_c
 = 
c
/(
¡ride
*stride);

71 
l
->
out_w
 = 
w
/
¡ride
;

72 
l
->
out_h
 = 
h
/
¡ride
;

73 
l
->
out_c
 = 
c
*(
¡ride
*stride);

76 
l
->
ouuts
 =†->
out_h
 *†->
out_w
 *†->
out_c
;

77 
l
->
šputs
 =†->
ouuts
;

78 
ouut_size
 = 
l
->
ouuts
 *†->
b©ch
;

80 
l
->
ouut
 = 
	`»®loc
Ö->ouut, 
ouut_size
 * ());

81 
l
->
d–
 = 
	`»®loc
Ö->d–, 
ouut_size
 * ());

83 #ifdeà
GPU


84 
	`cuda_ä“
(
l
->
ouut_gpu
);

85 
	`cuda_ä“
(
l
->
d–_gpu
);

86 
l
->
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö->
ouut
, 
ouut_size
);

87 
l
->
d–_gpu
 = 
	`cuda_make_¬¿y
Ö->
d–
, 
ouut_size
);

89 
	}
}

91 
	$fÜw¬d_»Üg_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

93 
i
;

94 if(
l
.
æ©‹n
){

95 
	`memıy
(
l
.
ouut
, 
Ãt
.
šput
,†.
ouuts
*l.
b©ch
*());

96 if(
l
.
»v”£
){

97 
	`æ©‹n
(
l
.
ouut
,†.
w
*l.
h
,†.
c
,†.
b©ch
, 0);

99 
	`æ©‹n
(
l
.
ouut
,†.
w
*l.
h
,†.
c
,†.
b©ch
, 1);

101 } ià(
l
.
exŒa
) {

102 
i
 = 0; i < 
l
.
b©ch
; ++i){

103 
	`cİy_ıu
(
l
.
šputs
, 
Ãt
.
šput
 + 
i
*l.šputs, 1,†.
ouut
 + i*l.
ouuts
, 1);

105 } ià(
l
.
»v”£
){

106 
	`»Üg_ıu
(
Ãt
.
šput
, 
l
.
w
,†.
h
,†.
c
,†.
b©ch
,†.
¡ride
, 1,†.
ouut
);

108 
	`»Üg_ıu
(
Ãt
.
šput
, 
l
.
w
,†.
h
,†.
c
,†.
b©ch
,†.
¡ride
, 0,†.
ouut
);

110 
	}
}

112 
	$backw¬d_»Üg_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

114 
i
;

115 if(
l
.
æ©‹n
){

116 
	`memıy
(
Ãt
.
d–
, 
l
.d–,†.
ouuts
*l.
b©ch
*());

117 if(
l
.
»v”£
){

118 
	`æ©‹n
(
Ãt
.
d–
, 
l
.
w
*l.
h
,†.
c
,†.
b©ch
, 1);

120 
	`æ©‹n
(
Ãt
.
d–
, 
l
.
w
*l.
h
,†.
c
,†.
b©ch
, 0);

122 } if(
l
.
»v”£
){

123 
	`»Üg_ıu
(
l
.
d–
,†.
w
,†.
h
,†.
c
,†.
b©ch
,†.
¡ride
, 0, 
Ãt
.delta);

124 } ià(
l
.
exŒa
) {

125 
i
 = 0; i < 
l
.
b©ch
; ++i){

126 
	`cİy_ıu
(
l
.
šputs
,†.
d–
 + 
i
*l.
ouuts
, 1, 
Ãt
.delta + i*l.inputs, 1);

129 
	`»Üg_ıu
(
l
.
d–
,†.
w
,†.
h
,†.
c
,†.
b©ch
,†.
¡ride
, 1, 
Ãt
.delta);

131 
	}
}

133 #ifdeà
GPU


134 
	$fÜw¬d_»Üg_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

136 
i
;

137 if(
l
.
æ©‹n
){

138 if(
l
.
»v”£
){

139 
	`æ©‹n_gpu
(
Ãt
.
šput_gpu
, 
l
.
w
*l.
h
,†.
c
,†.
b©ch
, 0,†.
ouut_gpu
);

141 
	`æ©‹n_gpu
(
Ãt
.
šput_gpu
, 
l
.
w
*l.
h
,†.
c
,†.
b©ch
, 1,†.
ouut_gpu
);

143 } ià(
l
.
exŒa
) {

144 
i
 = 0; i < 
l
.
b©ch
; ++i){

145 
	`cİy_gpu
(
l
.
šputs
, 
Ãt
.
šput_gpu
 + 
i
*l.šputs, 1,†.
ouut_gpu
 + i*l.
ouuts
, 1);

147 } ià(
l
.
»v”£
) {

148 
	`»Üg_gpu
(
Ãt
.
šput_gpu
, 
l
.
w
,†.
h
,†.
c
,†.
b©ch
,†.
¡ride
, 1,†.
ouut_gpu
);

150 
	`»Üg_gpu
(
Ãt
.
šput_gpu
, 
l
.
w
,†.
h
,†.
c
,†.
b©ch
,†.
¡ride
, 0,†.
ouut_gpu
);

152 
	}
}

154 
	$backw¬d_»Üg_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

156 if(
l
.
æ©‹n
){

157 if(
l
.
»v”£
){

158 
	`æ©‹n_gpu
(
l
.
d–_gpu
,†.
w
*l.
h
,†.
c
,†.
b©ch
, 1, 
Ãt
.delta_gpu);

160 
	`æ©‹n_gpu
(
l
.
d–_gpu
,†.
w
*l.
h
,†.
c
,†.
b©ch
, 0, 
Ãt
.delta_gpu);

162 } ià(
l
.
exŒa
) {

163 
i
;

164 
i
 = 0; i < 
l
.
b©ch
; ++i){

165 
	`cİy_gpu
(
l
.
šputs
,†.
d–_gpu
 + 
i
*l.
ouuts
, 1, 
Ãt
.delta_gpu + i*l.inputs, 1);

167 } if(
l
.
»v”£
){

168 
	`»Üg_gpu
(
l
.
d–_gpu
,†.
w
,†.
h
,†.
c
,†.
b©ch
,†.
¡ride
, 0, 
Ãt
.delta_gpu);

170 
	`»Üg_gpu
(
l
.
d–_gpu
,†.
w
,†.
h
,†.
c
,†.
b©ch
,†.
¡ride
, 1, 
Ãt
.delta_gpu);

172 
	}
}

	@reorg_layer.h

1 #iâdeà
REORG_LAYER_H


2 
	#REORG_LAYER_H


	)

4 
	~"image.h
"

5 
	~"cuda.h
"

6 
	~"Ïy”.h
"

7 
	~"ÃtwÜk.h
"

9 
Ïy”
 
make_»Üg_Ïy”
(
b©ch
, 
w
, 
h
, 
c
, 
¡ride
, 
»v”£
, 
æ©‹n
, 
exŒa
);

10 
»size_»Üg_Ïy”
(
Ïy”
 *
l
, 
w
, 
h
);

11 
fÜw¬d_»Üg_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

12 
backw¬d_»Üg_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

14 #ifdeà
GPU


15 
fÜw¬d_»Üg_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

16 
backw¬d_»Üg_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

	@rnn_layer.c

1 
	~"ºn_Ïy”.h
"

2 
	~"cÚÃùed_Ïy”.h
"

3 
	~"uts.h
"

4 
	~"cuda.h
"

5 
	~"bÏs.h
"

6 
	~"gemm.h
"

8 
	~<m©h.h
>

9 
	~<¡dio.h
>

10 
	~<¡dlib.h
>

11 
	~<¡ršg.h
>

13 
	$šüem’t_Ïy”
(
Ïy”
 *
l
, 
¡•s
)

15 
num
 = 
l
->
ouuts
*l->
b©ch
*
¡•s
;

16 
l
->
ouut
 +ğ
num
;

17 
l
->
d–
 +ğ
num
;

18 
l
->
x
 +ğ
num
;

19 
l
->
x_nÜm
 +ğ
num
;

21 #ifdeà
GPU


22 
l
->
ouut_gpu
 +ğ
num
;

23 
l
->
d–_gpu
 +ğ
num
;

24 
l
->
x_gpu
 +ğ
num
;

25 
l
->
x_nÜm_gpu
 +ğ
num
;

27 
	}
}

29 
Ïy”
 
	$make_ºn_Ïy”
(
b©ch
, 
šputs
, 
ouuts
, 
¡•s
, 
ACTIVATION
 
aùiv©iÚ
, 
b©ch_nÜm®ize
, 
adam
)

31 
	`årštf
(
¡d”r
, "RNN Lay”: %d iÅuts, %d ouuts\n", 
šputs
, 
ouuts
);

32 
b©ch
 = b©ch / 
¡•s
;

33 
Ïy”
 
l
 = {0};

34 
l
.
b©ch
 = batch;

35 
l
.
ty³
 = 
RNN
;

36 
l
.
¡•s
 = steps;

37 
l
.
šputs
 = inputs;

39 
l
.
¡©e
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

40 
l
.
´ev_¡©e
 = 
	`ÿÎoc
(
b©ch
*
ouuts
, ());

42 
l
.
šput_Ïy”
 = 
	`m®loc
((
Ïy”
));

43 
	`årštf
(
¡d”r
, "\t\t");

44 *(
l
.
šput_Ïy”
èğ
	`make_cÚÃùed_Ïy”
(
b©ch
*
¡•s
, 
šputs
, 
ouuts
, 
aùiv©iÚ
, 
b©ch_nÜm®ize
, 
adam
);

45 
l
.
šput_Ïy”
->
b©ch
 = batch;

47 
l
.
£lf_Ïy”
 = 
	`m®loc
((
Ïy”
));

48 
	`årštf
(
¡d”r
, "\t\t");

49 *(
l
.
£lf_Ïy”
èğ
	`make_cÚÃùed_Ïy”
(
b©ch
*
¡•s
, 
ouuts
, ouuts, 
aùiv©iÚ
, 
b©ch_nÜm®ize
, 
adam
);

50 
l
.
£lf_Ïy”
->
b©ch
 = batch;

52 
l
.
ouut_Ïy”
 = 
	`m®loc
((
Ïy”
));

53 
	`årštf
(
¡d”r
, "\t\t");

54 *(
l
.
ouut_Ïy”
èğ
	`make_cÚÃùed_Ïy”
(
b©ch
*
¡•s
, 
ouuts
, ouuts, 
aùiv©iÚ
, 
b©ch_nÜm®ize
, 
adam
);

55 
l
.
ouut_Ïy”
->
b©ch
 = batch;

57 
l
.
ouuts
 = outputs;

58 
l
.
ouut
 =†.
ouut_Ïy”
->output;

59 
l
.
d–
 =†.
ouut_Ïy”
->delta;

61 
l
.
fÜw¬d
 = 
fÜw¬d_ºn_Ïy”
;

62 
l
.
backw¬d
 = 
backw¬d_ºn_Ïy”
;

63 
l
.
upd©e
 = 
upd©e_ºn_Ïy”
;

64 #ifdeà
GPU


65 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_ºn_Ïy”_gpu
;

66 
l
.
backw¬d_gpu
 = 
backw¬d_ºn_Ïy”_gpu
;

67 
l
.
upd©e_gpu
 = 
upd©e_ºn_Ïy”_gpu
;

68 
l
.
¡©e_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

69 
l
.
´ev_¡©e_gpu
 = 
	`cuda_make_¬¿y
(0, 
b©ch
*
ouuts
);

70 
l
.
ouut_gpu
 =†.
ouut_Ïy”
->output_gpu;

71 
l
.
d–_gpu
 =†.
ouut_Ïy”
->delta_gpu;

72 #ifdeà
CUDNN


73 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
šput_Ïy”
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 
b©ch
,†.šput_Ïy”->
out_c
,†.šput_Ïy”->
out_h
,†.šput_Ïy”->
out_w
);

74 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
£lf_Ïy”
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 
b©ch
,†.£lf_Ïy”->
out_c
,†.£lf_Ïy”->
out_h
,†.£lf_Ïy”->
out_w
);

75 
	`cudÂS‘T’sÜ4dDesütÜ
(
l
.
ouut_Ïy”
->
d¡T’sÜDesc
, 
CUDNN_TENSOR_NCHW
, 
CUDNN_DATA_FLOAT
, 
b©ch
,†.ouut_Ïy”->
out_c
,†.ouut_Ïy”->
out_h
,†.ouut_Ïy”->
out_w
);

79  
l
;

80 
	}
}

82 
	$upd©e_ºn_Ïy”
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
)

84 
	`upd©e_cÚÃùed_Ïy”
(*(
l
.
šput_Ïy”
), 
a
);

85 
	`upd©e_cÚÃùed_Ïy”
(*(
l
.
£lf_Ïy”
), 
a
);

86 
	`upd©e_cÚÃùed_Ïy”
(*(
l
.
ouut_Ïy”
), 
a
);

87 
	}
}

89 
	$fÜw¬d_ºn_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

91 
ÃtwÜk
 
s
 = 
Ãt
;

92 
s
.
Œaš
 = 
Ãt
.train;

93 
i
;

94 
Ïy”
 
šput_Ïy”
 = *(
l
.input_layer);

95 
Ïy”
 
£lf_Ïy”
 = *(
l
.self_layer);

96 
Ïy”
 
ouut_Ïy”
 = *(
l
.output_layer);

98 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
ouut_Ïy”
.
d–
, 1);

99 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
£lf_Ïy”
.
d–
, 1);

100 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
šput_Ïy”
.
d–
, 1);

101 if(
Ãt
.
Œaš
è
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
, 0,†.
¡©e
, 1);

103 
i
 = 0; i < 
l
.
¡•s
; ++i) {

104 
s
.
šput
 = 
Ãt
.input;

105 
	`fÜw¬d_cÚÃùed_Ïy”
(
šput_Ïy”
, 
s
);

107 
s
.
šput
 = 
l
.
¡©e
;

108 
	`fÜw¬d_cÚÃùed_Ïy”
(
£lf_Ïy”
, 
s
);

110 *
Şd_¡©e
 = 
l
.
¡©e
;

111 if(
Ãt
.
Œaš
è
l
.
¡©e
 +ğl.
ouuts
*l.
b©ch
;

112 if(
l
.
shÜtcut
){

113 
	`cİy_ıu
(
l
.
ouuts
 *†.
b©ch
, 
Şd_¡©e
, 1,†.
¡©e
, 1);

115 
	`fl_ıu
(
l
.
ouuts
 *†.
b©ch
, 0,†.
¡©e
, 1);

117 
	`axpy_ıu
(
l
.
ouuts
 *†.
b©ch
, 1, 
šput_Ïy”
.
ouut
, 1,†.
¡©e
, 1);

118 
	`axpy_ıu
(
l
.
ouuts
 *†.
b©ch
, 1, 
£lf_Ïy”
.
ouut
, 1,†.
¡©e
, 1);

120 
s
.
šput
 = 
l
.
¡©e
;

121 
	`fÜw¬d_cÚÃùed_Ïy”
(
ouut_Ïy”
, 
s
);

123 
Ãt
.
šput
 +ğ
l
.
šputs
*l.
b©ch
;

124 
	`šüem’t_Ïy”
(&
šput_Ïy”
, 1);

125 
	`šüem’t_Ïy”
(&
£lf_Ïy”
, 1);

126 
	`šüem’t_Ïy”
(&
ouut_Ïy”
, 1);

128 
	}
}

130 
	$backw¬d_ºn_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

132 
ÃtwÜk
 
s
 = 
Ãt
;

133 
s
.
Œaš
 = 
Ãt
.train;

134 
i
;

135 
Ïy”
 
šput_Ïy”
 = *(
l
.input_layer);

136 
Ïy”
 
£lf_Ïy”
 = *(
l
.self_layer);

137 
Ïy”
 
ouut_Ïy”
 = *(
l
.output_layer);

139 
	`šüem’t_Ïy”
(&
šput_Ïy”
, 
l
.
¡•s
-1);

140 
	`šüem’t_Ïy”
(&
£lf_Ïy”
, 
l
.
¡•s
-1);

141 
	`šüem’t_Ïy”
(&
ouut_Ïy”
, 
l
.
¡•s
-1);

143 
l
.
¡©e
 +ğl.
ouuts
*l.
b©ch
*l.
¡•s
;

144 
i
 = 
l
.
¡•s
-1; i >= 0; --i) {

145 
	`cİy_ıu
(
l
.
ouuts
 *†.
b©ch
, 
šput_Ïy”
.
ouut
, 1,†.
¡©e
, 1);

146 
	`axpy_ıu
(
l
.
ouuts
 *†.
b©ch
, 1, 
£lf_Ïy”
.
ouut
, 1,†.
¡©e
, 1);

148 
s
.
šput
 = 
l
.
¡©e
;

149 
s
.
d–
 = 
£lf_Ïy”
.delta;

150 
	`backw¬d_cÚÃùed_Ïy”
(
ouut_Ïy”
, 
s
);

152 
l
.
¡©e
 -ğl.
ouuts
*l.
b©ch
;

162 
s
.
šput
 = 
l
.
¡©e
;

163 
s
.
d–
 = 
£lf_Ïy”
.d– - 
l
.
ouuts
*l.
b©ch
;

164 ià(
i
 =ğ0è
s
.
d–
 = 0;

165 
	`backw¬d_cÚÃùed_Ïy”
(
£lf_Ïy”
, 
s
);

167 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
, 
£lf_Ïy”
.
d–
, 1, 
šput_Ïy”
.delta, 1);

168 ià(
i
 > 0 && 
l
.
shÜtcut
è
	`axpy_ıu
Ö.
ouuts
*l.
b©ch
, 1, 
£lf_Ïy”
.
d–
, 1, self_layer.delta -†.outputs*l.batch, 1);

169 
s
.
šput
 = 
Ãt
.špuˆ+ 
i
*
l
.
šputs
*l.
b©ch
;

170 if(
Ãt
.
d–
è
s
.d– =‚‘.d– + 
i
*
l
.
šputs
*l.
b©ch
;

171 
s
.
d–
 = 0;

172 
	`backw¬d_cÚÃùed_Ïy”
(
šput_Ïy”
, 
s
);

174 
	`šüem’t_Ïy”
(&
šput_Ïy”
, -1);

175 
	`šüem’t_Ïy”
(&
£lf_Ïy”
, -1);

176 
	`šüem’t_Ïy”
(&
ouut_Ïy”
, -1);

178 
	}
}

180 #ifdeà
GPU


182 
	$puÎ_ºn_Ïy”
(
Ïy”
 
l
)

184 
	`puÎ_cÚÃùed_Ïy”
(*(
l
.
šput_Ïy”
));

185 
	`puÎ_cÚÃùed_Ïy”
(*(
l
.
£lf_Ïy”
));

186 
	`puÎ_cÚÃùed_Ïy”
(*(
l
.
ouut_Ïy”
));

187 
	}
}

189 
	$push_ºn_Ïy”
(
Ïy”
 
l
)

191 
	`push_cÚÃùed_Ïy”
(*(
l
.
šput_Ïy”
));

192 
	`push_cÚÃùed_Ïy”
(*(
l
.
£lf_Ïy”
));

193 
	`push_cÚÃùed_Ïy”
(*(
l
.
ouut_Ïy”
));

194 
	}
}

196 
	$upd©e_ºn_Ïy”_gpu
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
)

198 
	`upd©e_cÚÃùed_Ïy”_gpu
(*(
l
.
šput_Ïy”
), 
a
);

199 
	`upd©e_cÚÃùed_Ïy”_gpu
(*(
l
.
£lf_Ïy”
), 
a
);

200 
	`upd©e_cÚÃùed_Ïy”_gpu
(*(
l
.
ouut_Ïy”
), 
a
);

201 
	}
}

203 
	$fÜw¬d_ºn_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

205 
ÃtwÜk
 
s
 = {0};

206 
s
.
Œaš
 = 
Ãt
.train;

207 
i
;

208 
Ïy”
 
šput_Ïy”
 = *(
l
.input_layer);

209 
Ïy”
 
£lf_Ïy”
 = *(
l
.self_layer);

210 
Ïy”
 
ouut_Ïy”
 = *(
l
.output_layer);

212 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
ouut_Ïy”
.
d–_gpu
, 1);

213 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
£lf_Ïy”
.
d–_gpu
, 1);

214 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0, 
šput_Ïy”
.
d–_gpu
, 1);

216 if(
Ãt
.
Œaš
) {

217 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
 *†.
¡•s
, 0,†.
d–_gpu
, 1);

218 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
¡©e_gpu
, 1,†.
´ev_¡©e_gpu
, 1);

221 
i
 = 0; i < 
l
.
¡•s
; ++i) {

222 
s
.
šput_gpu
 = 
Ãt
.input_gpu;

223 
	`fÜw¬d_cÚÃùed_Ïy”_gpu
(
šput_Ïy”
, 
s
);

225 
s
.
šput_gpu
 = 
l
.
¡©e_gpu
;

226 
	`fÜw¬d_cÚÃùed_Ïy”_gpu
(
£lf_Ïy”
, 
s
);

228 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
, 0,†.
¡©e_gpu
, 1);

229 
	`axpy_gpu
(
l
.
ouuts
 *†.
b©ch
, 1, 
šput_Ïy”
.
ouut_gpu
, 1,†.
¡©e_gpu
, 1);

230 
	`axpy_gpu
(
l
.
ouuts
 *†.
b©ch
, 1, 
£lf_Ïy”
.
ouut_gpu
, 1,†.
¡©e_gpu
, 1);

232 
s
.
šput_gpu
 = 
l
.
¡©e_gpu
;

233 
	`fÜw¬d_cÚÃùed_Ïy”_gpu
(
ouut_Ïy”
, 
s
);

235 
Ãt
.
šput_gpu
 +ğ
l
.
šputs
*l.
b©ch
;

236 
	`šüem’t_Ïy”
(&
šput_Ïy”
, 1);

237 
	`šüem’t_Ïy”
(&
£lf_Ïy”
, 1);

238 
	`šüem’t_Ïy”
(&
ouut_Ïy”
, 1);

240 
	}
}

242 
	$backw¬d_ºn_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

244 
ÃtwÜk
 
s
 = {0};

245 
s
.
Œaš
 = 
Ãt
.train;

246 
i
;

247 
Ïy”
 
šput_Ïy”
 = *(
l
.input_layer);

248 
Ïy”
 
£lf_Ïy”
 = *(
l
.self_layer);

249 
Ïy”
 
ouut_Ïy”
 = *(
l
.output_layer);

250 
	`šüem’t_Ïy”
(&
šput_Ïy”
, 
l
.
¡•s
 - 1);

251 
	`šüem’t_Ïy”
(&
£lf_Ïy”
, 
l
.
¡•s
 - 1);

252 
	`šüem’t_Ïy”
(&
ouut_Ïy”
, 
l
.
¡•s
 - 1);

253 *
Ï¡_šput
 = 
šput_Ïy”
.
ouut_gpu
;

254 *
Ï¡_£lf
 = 
£lf_Ïy”
.
ouut_gpu
;

255 
i
 = 
l
.
¡•s
-1; i >= 0; --i) {

256 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
, 0,†.
¡©e_gpu
, 1);

257 
	`axpy_gpu
(
l
.
ouuts
 *†.
b©ch
, 1, 
šput_Ïy”
.
ouut_gpu
, 1,†.
¡©e_gpu
, 1);

258 
	`axpy_gpu
(
l
.
ouuts
 *†.
b©ch
, 1, 
£lf_Ïy”
.
ouut_gpu
, 1,†.
¡©e_gpu
, 1);

260 
s
.
šput_gpu
 = 
l
.
¡©e_gpu
;

261 
s
.
d–_gpu
 = 
£lf_Ïy”
.delta_gpu;

262 
	`backw¬d_cÚÃùed_Ïy”_gpu
(
ouut_Ïy”
, 
s
);

264 if(
i
 != 0) {

265 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
, 0,†.
¡©e_gpu
, 1);

266 
	`axpy_gpu
(
l
.
ouuts
 *†.
b©ch
, 1, 
šput_Ïy”
.
ouut_gpu
 -†.ouuts*l.b©ch, 1,†.
¡©e_gpu
, 1);

267 
	`axpy_gpu
(
l
.
ouuts
 *†.
b©ch
, 1, 
£lf_Ïy”
.
ouut_gpu
 -†.ouuts*l.b©ch, 1,†.
¡©e_gpu
, 1);

269 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
´ev_¡©e_gpu
, 1,†.
¡©e_gpu
, 1);

272 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
£lf_Ïy”
.
d–_gpu
, 1, 
šput_Ïy”
.delta_gpu, 1);

274 
s
.
šput_gpu
 = 
l
.
¡©e_gpu
;

275 
s
.
d–_gpu
 = (
i
 > 0è? 
£lf_Ïy”
.d–_gpu - 
l
.
ouuts
*l.
b©ch
 : 0;

276 ià(
i
 =ğ0è
s
.
d–_gpu
 = 0;

277 
	`backw¬d_cÚÃùed_Ïy”_gpu
(
£lf_Ïy”
, 
s
);

279 
s
.
šput_gpu
 = 
Ãt
.šput_gpu + 
i
*
l
.
šputs
*l.
b©ch
;

280 if(
Ãt
.
d–_gpu
è
s
.d–_gpu =‚‘.d–_gpu + 
i
*
l
.
šputs
*l.
b©ch
;

281 
s
.
d–_gpu
 = 0;

282 
	`backw¬d_cÚÃùed_Ïy”_gpu
(
šput_Ïy”
, 
s
);

284 
	`šüem’t_Ïy”
(&
šput_Ïy”
, -1);

285 
	`šüem’t_Ïy”
(&
£lf_Ïy”
, -1);

286 
	`šüem’t_Ïy”
(&
ouut_Ïy”
, -1);

288 
	`fl_gpu
(
l
.
ouuts
 *†.
b©ch
, 0,†.
¡©e_gpu
, 1);

289 
	`axpy_gpu
(
l
.
ouuts
 *†.
b©ch
, 1, 
Ï¡_šput
, 1,†.
¡©e_gpu
, 1);

290 
	`axpy_gpu
(
l
.
ouuts
 *†.
b©ch
, 1, 
Ï¡_£lf
, 1,†.
¡©e_gpu
, 1);

291 
	}
}

	@rnn_layer.h

2 #iâdeà
RNN_LAYER_H


3 
	#RNN_LAYER_H


	)

5 
	~"aùiv©iÚs.h
"

6 
	~"Ïy”.h
"

7 
	~"ÃtwÜk.h
"

8 
	#USET


	)

10 
Ïy”
 
make_ºn_Ïy”
(
b©ch
, 
šputs
, 
ouuts
, 
¡•s
, 
ACTIVATION
 
aùiv©iÚ
, 
b©ch_nÜm®ize
, 
adam
);

12 
fÜw¬d_ºn_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

13 
backw¬d_ºn_Ïy”
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

14 
upd©e_ºn_Ïy”
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
);

16 #ifdeà
GPU


17 
fÜw¬d_ºn_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

18 
backw¬d_ºn_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

19 
upd©e_ºn_Ïy”_gpu
(
Ïy”
 
l
, 
upd©e_¬gs
 
a
);

20 
push_ºn_Ïy”
(
Ïy”
 
l
);

21 
puÎ_ºn_Ïy”
(
Ïy”
 
l
);

	@route_layer.c

1 
	~"rou‹_Ïy”.h
"

2 
	~"cuda.h
"

3 
	~"bÏs.h
"

5 
	~<¡dio.h
>

7 
rou‹_Ïy”
 
	$make_rou‹_Ïy”
(
b©ch
, 
n
, *
šput_Ïy”s
, *
šput_sizes
)

9 
	`årštf
(
¡d”r
,"route ");

10 
rou‹_Ïy”
 
l
 = {0};

11 
l
.
ty³
 = 
ROUTE
;

12 
l
.
b©ch
 = batch;

13 
l
.
n
 =‚;

14 
l
.
šput_Ïy”s
 = input_layers;

15 
l
.
šput_sizes
 = input_sizes;

16 
i
;

17 
ouuts
 = 0;

18 
i
 = 0; i < 
n
; ++i){

19 
	`årštf
(
¡d”r
," %d", 
šput_Ïy”s
[
i
]);

20 
ouuts
 +ğ
šput_sizes
[
i
];

22 
	`årštf
(
¡d”r
, "\n");

23 
l
.
ouuts
 = outputs;

24 
l
.
šputs
 = 
ouuts
;

25 
l
.
d–
 = 
	`ÿÎoc
(
ouuts
*
b©ch
, ());

26 
l
.
ouut
 = 
	`ÿÎoc
(
ouuts
*
b©ch
, ());;

28 
l
.
fÜw¬d
 = 
fÜw¬d_rou‹_Ïy”
;

29 
l
.
backw¬d
 = 
backw¬d_rou‹_Ïy”
;

30 #ifdeà
GPU


31 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_rou‹_Ïy”_gpu
;

32 
l
.
backw¬d_gpu
 = 
backw¬d_rou‹_Ïy”_gpu
;

34 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
, 
ouuts
*
b©ch
);

35 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
, 
ouuts
*
b©ch
);

37  
l
;

38 
	}
}

40 
	$»size_rou‹_Ïy”
(
rou‹_Ïy”
 *
l
, 
ÃtwÜk
 *
Ãt
)

42 
i
;

43 
Ïy”
 
fœ¡
 = 
Ãt
->
Ïy”s
[
l
->
šput_Ïy”s
[0]];

44 
l
->
out_w
 = 
fœ¡
.out_w;

45 
l
->
out_h
 = 
fœ¡
.out_h;

46 
l
->
out_c
 = 
fœ¡
.out_c;

47 
l
->
ouuts
 = 
fœ¡
.outputs;

48 
l
->
šput_sizes
[0] = 
fœ¡
.
ouuts
;

49 
i
 = 1; i < 
l
->
n
; ++i){

50 
šdex
 = 
l
->
šput_Ïy”s
[
i
];

51 
Ïy”
 
Ãxt
 = 
Ãt
->
Ïy”s
[
šdex
];

52 
l
->
ouuts
 +ğ
Ãxt
.outputs;

53 
l
->
šput_sizes
[
i
] = 
Ãxt
.
ouuts
;

54 if(
Ãxt
.
out_w
 =ğ
fœ¡
.out_w &&‚ext.
out_h
 == first.out_h){

55 
l
->
out_c
 +ğ
Ãxt
.out_c;

57 
	`´štf
("%d %d, %d %d\n", 
Ãxt
.
out_w
,‚ext.
out_h
, 
fœ¡
.out_w, first.out_h);

58 
l
->
out_h
 =†->
out_w
 =†->
out_c
 = 0;

61 
l
->
šputs
 =†->
ouuts
;

62 
l
->
d–
 = 
	`»®loc
Ö->d–,†->
ouuts
*l->
b©ch
*());

63 
l
->
ouut
 = 
	`»®loc
Ö->ouut,†->
ouuts
*l->
b©ch
*());

65 #ifdeà
GPU


66 
	`cuda_ä“
(
l
->
ouut_gpu
);

67 
	`cuda_ä“
(
l
->
d–_gpu
);

68 
l
->
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö->
ouut
,†->
ouuts
*l->
b©ch
);

69 
l
->
d–_gpu
 = 
	`cuda_make_¬¿y
Ö->
d–
,†->
ouuts
*l->
b©ch
);

72 
	}
}

74 
	$fÜw¬d_rou‹_Ïy”
(cÚ¡ 
rou‹_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

76 
i
, 
j
;

77 
off£t
 = 0;

78 
i
 = 0; i < 
l
.
n
; ++i){

79 
šdex
 = 
l
.
šput_Ïy”s
[
i
];

80 *
šput
 = 
Ãt
.
Ïy”s
[
šdex
].
ouut
;

81 
šput_size
 = 
l
.
šput_sizes
[
i
];

82 
j
 = 0; j < 
l
.
b©ch
; ++j){

83 
	`cİy_ıu
(
šput_size
, 
šput
 + 
j
*šput_size, 1, 
l
.
ouut
 + 
off£t
 + j*l.
ouuts
, 1);

85 
off£t
 +ğ
šput_size
;

87 
	}
}

89 
	$backw¬d_rou‹_Ïy”
(cÚ¡ 
rou‹_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

91 
i
, 
j
;

92 
off£t
 = 0;

93 
i
 = 0; i < 
l
.
n
; ++i){

94 
šdex
 = 
l
.
šput_Ïy”s
[
i
];

95 *
d–
 = 
Ãt
.
Ïy”s
[
šdex
].delta;

96 
šput_size
 = 
l
.
šput_sizes
[
i
];

97 
j
 = 0; j < 
l
.
b©ch
; ++j){

98 
	`axpy_ıu
(
šput_size
, 1, 
l
.
d–
 + 
off£t
 + 
j
*l.
ouuts
, 1, delta + j*input_size, 1);

100 
off£t
 +ğ
šput_size
;

102 
	}
}

104 #ifdeà
GPU


105 
	$fÜw¬d_rou‹_Ïy”_gpu
(cÚ¡ 
rou‹_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

107 
i
, 
j
;

108 
off£t
 = 0;

109 
i
 = 0; i < 
l
.
n
; ++i){

110 
šdex
 = 
l
.
šput_Ïy”s
[
i
];

111 *
šput
 = 
Ãt
.
Ïy”s
[
šdex
].
ouut_gpu
;

112 
šput_size
 = 
l
.
šput_sizes
[
i
];

113 
j
 = 0; j < 
l
.
b©ch
; ++j){

114 
	`cİy_gpu
(
šput_size
, 
šput
 + 
j
*šput_size, 1, 
l
.
ouut_gpu
 + 
off£t
 + j*l.
ouuts
, 1);

116 
off£t
 +ğ
šput_size
;

118 
	}
}

120 
	$backw¬d_rou‹_Ïy”_gpu
(cÚ¡ 
rou‹_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

122 
i
, 
j
;

123 
off£t
 = 0;

124 
i
 = 0; i < 
l
.
n
; ++i){

125 
šdex
 = 
l
.
šput_Ïy”s
[
i
];

126 *
d–
 = 
Ãt
.
Ïy”s
[
šdex
].
d–_gpu
;

127 
šput_size
 = 
l
.
šput_sizes
[
i
];

128 
j
 = 0; j < 
l
.
b©ch
; ++j){

129 
	`axpy_gpu
(
šput_size
, 1, 
l
.
d–_gpu
 + 
off£t
 + 
j
*l.
ouuts
, 1, 
d–
 + j*input_size, 1);

131 
off£t
 +ğ
šput_size
;

133 
	}
}

	@route_layer.h

1 #iâdeà
ROUTE_LAYER_H


2 
	#ROUTE_LAYER_H


	)

3 
	~"ÃtwÜk.h
"

4 
	~"Ïy”.h
"

6 
Ïy”
 
	trou‹_Ïy”
;

8 
rou‹_Ïy”
 
make_rou‹_Ïy”
(
b©ch
, 
n
, *
šput_Ïy”s
, *
šput_size
);

9 
fÜw¬d_rou‹_Ïy”
(cÚ¡ 
rou‹_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

10 
backw¬d_rou‹_Ïy”
(cÚ¡ 
rou‹_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

11 
»size_rou‹_Ïy”
(
rou‹_Ïy”
 *
l
, 
ÃtwÜk
 *
Ãt
);

13 #ifdeà
GPU


14 
fÜw¬d_rou‹_Ïy”_gpu
(cÚ¡ 
rou‹_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

15 
backw¬d_rou‹_Ïy”_gpu
(cÚ¡ 
rou‹_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

	@shortcut_layer.c

1 
	~"shÜtcut_Ïy”.h
"

2 
	~"cuda.h
"

3 
	~"bÏs.h
"

4 
	~"aùiv©iÚs.h
"

6 
	~<¡dio.h
>

7 
	~<as£¹.h
>

9 
Ïy”
 
	$make_shÜtcut_Ïy”
(
b©ch
, 
šdex
, 
w
, 
h
, 
c
, 
w2
, 
h2
, 
c2
)

11 
	`årštf
(
¡d”r
, "»  %3d %4d x%4d x%4d -> %4d x%4d x%4d\n",
šdex
, 
w2
,
h2
,
c2
, 
w
,
h
,
c
);

12 
Ïy”
 
l
 = {0};

13 
l
.
ty³
 = 
SHORTCUT
;

14 
l
.
b©ch
 = batch;

15 
l
.
w
 = 
w2
;

16 
l
.
h
 = 
h2
;

17 
l
.
c
 = 
c2
;

18 
l
.
out_w
 = 
w
;

19 
l
.
out_h
 = 
h
;

20 
l
.
out_c
 = 
c
;

21 
l
.
ouuts
 = 
w
*
h
*
c
;

22 
l
.
šputs
 =†.
ouuts
;

24 
l
.
šdex
 = index;

26 
l
.
d–
 = 
	`ÿÎoc
Ö.
ouuts
*
b©ch
, ());

27 
l
.
ouut
 = 
	`ÿÎoc
Ö.
ouuts
*
b©ch
, ());;

29 
l
.
fÜw¬d
 = 
fÜw¬d_shÜtcut_Ïy”
;

30 
l
.
backw¬d
 = 
backw¬d_shÜtcut_Ïy”
;

31 #ifdeà
GPU


32 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_shÜtcut_Ïy”_gpu
;

33 
l
.
backw¬d_gpu
 = 
backw¬d_shÜtcut_Ïy”_gpu
;

35 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
,†.
ouuts
*
b©ch
);

36 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
,†.
ouuts
*
b©ch
);

38  
l
;

39 
	}
}

41 
	$»size_shÜtcut_Ïy”
(
Ïy”
 *
l
, 
w
, 
h
)

43 
	`as£¹
(
l
->
w
 =ğl->
out_w
);

44 
	`as£¹
(
l
->
h
 =ğl->
out_h
);

45 
l
->
w
 =†->
out_w
 = w;

46 
l
->
h
 =†->
out_h
 = h;

47 
l
->
ouuts
 = 
w
*
h
*l->
out_c
;

48 
l
->
šputs
 =†->
ouuts
;

49 
l
->
d–
 = 
	`»®loc
Ö->d–,†->
ouuts
*l->
b©ch
*());

50 
l
->
ouut
 = 
	`»®loc
Ö->ouut,†->
ouuts
*l->
b©ch
*());

52 #ifdeà
GPU


53 
	`cuda_ä“
(
l
->
ouut_gpu
);

54 
	`cuda_ä“
(
l
->
d–_gpu
);

55 
l
->
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö->
ouut
,†->
ouuts
*l->
b©ch
);

56 
l
->
d–_gpu
 = 
	`cuda_make_¬¿y
Ö->
d–
,†->
ouuts
*l->
b©ch
);

59 
	}
}

62 
	$fÜw¬d_shÜtcut_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

64 
	`cİy_ıu
(
l
.
ouuts
*l.
b©ch
, 
Ãt
.
šput
, 1,†.
ouut
, 1);

65 
	`shÜtcut_ıu
(
l
.
b©ch
,†.
w
,†.
h
,†.
c
, 
Ãt
.
Ïy”s
[l.
šdex
].
ouut
,†.
out_w
,†.
out_h
,†.
out_c
,†.
®pha
,†.
b‘a
,†.output);

66 
	`aùiv©e_¬¿y
(
l
.
ouut
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
);

67 
	}
}

69 
	$backw¬d_shÜtcut_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

71 
	`g¿d›Á_¬¿y
(
l
.
ouut
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
,†.
d–
);

72 
	`axpy_ıu
(
l
.
ouuts
*l.
b©ch
,†.
®pha
,†.
d–
, 1, 
Ãt
.delta, 1);

73 
	`shÜtcut_ıu
(
l
.
b©ch
,†.
out_w
,†.
out_h
,†.
out_c
,†.
d–
,†.
w
,†.
h
,†.
c
, 1,†.
b‘a
, 
Ãt
.
Ïy”s
[l.
šdex
].delta);

74 
	}
}

76 #ifdeà
GPU


77 
	$fÜw¬d_shÜtcut_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

79 
	`cİy_gpu
(
l
.
ouuts
*l.
b©ch
, 
Ãt
.
šput_gpu
, 1,†.
ouut_gpu
, 1);

80 
	`shÜtcut_gpu
(
l
.
b©ch
,†.
w
,†.
h
,†.
c
, 
Ãt
.
Ïy”s
[l.
šdex
].
ouut_gpu
,†.
out_w
,†.
out_h
,†.
out_c
,†.
®pha
,†.
b‘a
,†.output_gpu);

81 
	`aùiv©e_¬¿y_gpu
(
l
.
ouut_gpu
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
);

82 
	}
}

84 
	$backw¬d_shÜtcut_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

86 
	`g¿d›Á_¬¿y_gpu
(
l
.
ouut_gpu
,†.
ouuts
*l.
b©ch
,†.
aùiv©iÚ
,†.
d–_gpu
);

87 
	`axpy_gpu
(
l
.
ouuts
*l.
b©ch
,†.
®pha
,†.
d–_gpu
, 1, 
Ãt
.delta_gpu, 1);

88 
	`shÜtcut_gpu
(
l
.
b©ch
,†.
out_w
,†.
out_h
,†.
out_c
,†.
d–_gpu
,†.
w
,†.
h
,†.
c
, 1,†.
b‘a
, 
Ãt
.
Ïy”s
[l.
šdex
].delta_gpu);

89 
	}
}

	@shortcut_layer.h

1 #iâdeà
SHORTCUT_LAYER_H


2 
	#SHORTCUT_LAYER_H


	)

4 
	~"Ïy”.h
"

5 
	~"ÃtwÜk.h
"

7 
Ïy”
 
make_shÜtcut_Ïy”
(
b©ch
, 
šdex
, 
w
, 
h
, 
c
, 
w2
, 
h2
, 
c2
);

8 
fÜw¬d_shÜtcut_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

9 
backw¬d_shÜtcut_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

10 
»size_shÜtcut_Ïy”
(
Ïy”
 *
l
, 
w
, 
h
);

12 #ifdeà
GPU


13 
fÜw¬d_shÜtcut_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

14 
backw¬d_shÜtcut_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

	@softmax_layer.c

1 
	~"soámax_Ïy”.h
"

2 
	~"bÏs.h
"

3 
	~"cuda.h
"

5 
	~<æßt.h
>

6 
	~<m©h.h
>

7 
	~<¡dlib.h
>

8 
	~<¡dio.h
>

9 
	~<as£¹.h
>

11 
soámax_Ïy”
 
	$make_soámax_Ïy”
(
b©ch
, 
šputs
, 
groups
)

13 
	`as£¹
(
šputs
%
groups
 == 0);

14 
	`årštf
(
¡d”r
, "soámax %4d\n", 
šputs
);

15 
soámax_Ïy”
 
l
 = {0};

16 
l
.
ty³
 = 
SOFTMAX
;

17 
l
.
b©ch
 = batch;

18 
l
.
groups
 = groups;

19 
l
.
šputs
 = inputs;

20 
l
.
ouuts
 = 
šputs
;

21 
l
.
loss
 = 
	`ÿÎoc
(
šputs
*
b©ch
, ());

22 
l
.
ouut
 = 
	`ÿÎoc
(
šputs
*
b©ch
, ());

23 
l
.
d–
 = 
	`ÿÎoc
(
šputs
*
b©ch
, ());

24 
l
.
co¡
 = 
	`ÿÎoc
(1, ());

26 
l
.
fÜw¬d
 = 
fÜw¬d_soámax_Ïy”
;

27 
l
.
backw¬d
 = 
backw¬d_soámax_Ïy”
;

28 #ifdeà
GPU


29 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_soámax_Ïy”_gpu
;

30 
l
.
backw¬d_gpu
 = 
backw¬d_soámax_Ïy”_gpu
;

32 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
, 
šputs
*
b©ch
);

33 
l
.
loss_gpu
 = 
	`cuda_make_¬¿y
Ö.
loss
, 
šputs
*
b©ch
);

34 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
, 
šputs
*
b©ch
);

36  
l
;

37 
	}
}

39 
	$fÜw¬d_soámax_Ïy”
(cÚ¡ 
soámax_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

41 if(
l
.
soámax_Œ“
){

42 
i
;

43 
couÁ
 = 0;

44 
i
 = 0; i < 
l
.
soámax_Œ“
->
groups
; ++i) {

45 
group_size
 = 
l
.
soámax_Œ“
->group_size[
i
];

46 
	`soámax_ıu
(
Ãt
.
šput
 + 
couÁ
, 
group_size
, 
l
.
b©ch
,†.
šputs
, 1, 0, 1,†.
‹m³¿tu»
,†.
ouut
 + count);

47 
couÁ
 +ğ
group_size
;

50 
	`soámax_ıu
(
Ãt
.
šput
, 
l
.
šputs
/l.
groups
,†.
b©ch
,†.šputs,†.groups,†.šputs/l.groups, 1,†.
‹m³¿tu»
,†.
ouut
);

53 if(
Ãt
.
Œuth
){

54 
	`soámax_x_’t_ıu
(
l
.
b©ch
*l.
šputs
,†.
ouut
, 
Ãt
.
Œuth
,†.
d–
,†.
loss
);

55 
l
.
co¡
[0] = 
	`sum_¬¿y
Ö.
loss
,†.
b©ch
*l.
šputs
);

56 
	`´štf
("ÿmh”dadada%à\n", 
l
.
co¡
[0]);

58 
	}
}

60 
	$backw¬d_soámax_Ïy”
(cÚ¡ 
soámax_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

62 
	`axpy_ıu
(
l
.
šputs
*l.
b©ch
, 1,†.
d–
, 1, 
Ãt
.delta, 1);

63 
	}
}

65 #ifdeà
GPU


67 
	$puÎ_soámax_Ïy”_ouut
(cÚ¡ 
soámax_Ïy”
 
Ïy”
)

69 
	`cuda_puÎ_¬¿y
(
Ïy”
.
ouut_gpu
,†ay”.
ouut
,†ay”.
šputs
*Ïy”.
b©ch
);

70 
	}
}

72 
	$fÜw¬d_soámax_Ïy”_gpu
(cÚ¡ 
soámax_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

74 if(
l
.
soámax_Œ“
){

75 
	`soámax_Œ“
(
Ãt
.
šput_gpu
, 1, 
l
.
b©ch
,†.
šputs
,†.
‹m³¿tu»
,†.
ouut_gpu
, *l.
soámax_Œ“
);

86 if(
l
.
¥©Ÿl
){

87 
	`soámax_gpu
(
Ãt
.
šput_gpu
, 
l
.
c
,†.
b©ch
*l.c,†.
šputs
/l.c,†.
w
*l.
h
, 1,†.w*l.h, 1,†.
ouut_gpu
);

89 
	`soámax_gpu
(
Ãt
.
šput_gpu
, 
l
.
šputs
/l.
groups
,†.
b©ch
,†.šputs,†.groups,†.šputs/l.groups, 1,†.
‹m³¿tu»
,†.
ouut_gpu
);

92 if(
Ãt
.
Œuth
){

93 
	`soámax_x_’t_gpu
(
l
.
b©ch
*l.
šputs
,†.
ouut_gpu
, 
Ãt
.
Œuth_gpu
,†.
d–_gpu
,†.
loss_gpu
);

94 if(
l
.
soámax_Œ“
){

95 
	`mask_gpu
(
l
.
b©ch
*l.
šputs
,†.
d–_gpu
, 
SECRET_NUM
, 
Ãt
.
Œuth_gpu
, 0);

96 
	`mask_gpu
(
l
.
b©ch
*l.
šputs
,†.
loss_gpu
, 
SECRET_NUM
, 
Ãt
.
Œuth_gpu
, 0);

98 
	`cuda_puÎ_¬¿y
(
l
.
loss_gpu
,†.
loss
,†.
b©ch
*l.
šputs
);

99 
l
.
co¡
[0] = 
	`sum_¬¿y
Ö.
loss
,†.
b©ch
*l.
šputs
);

101 
	}
}

103 
	$backw¬d_soámax_Ïy”_gpu
(cÚ¡ 
soámax_Ïy”
 
Ïy”
, 
ÃtwÜk
 
Ãt
)

105 
	`axpy_gpu
(
Ïy”
.
b©ch
*Ïy”.
šputs
, 1,†ay”.
d–_gpu
, 1, 
Ãt
.delta_gpu, 1);

106 
	}
}

	@softmax_layer.h

1 #iâdeà
SOFTMAX_LAYER_H


2 
	#SOFTMAX_LAYER_H


	)

3 
	~"Ïy”.h
"

4 
	~"ÃtwÜk.h
"

6 
Ïy”
 
	tsoámax_Ïy”
;

8 
soámax_¬¿y
(*
šput
, 
n
, 
‹mp
, *
ouut
);

9 
soámax_Ïy”
 
make_soámax_Ïy”
(
b©ch
, 
šputs
, 
groups
);

10 
fÜw¬d_soámax_Ïy”
(cÚ¡ 
soámax_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

11 
backw¬d_soámax_Ïy”
(cÚ¡ 
soámax_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

13 #ifdeà
GPU


14 
puÎ_soámax_Ïy”_ouut
(cÚ¡ 
soámax_Ïy”
 
l
);

15 
fÜw¬d_soámax_Ïy”_gpu
(cÚ¡ 
soámax_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

16 
backw¬d_soámax_Ïy”_gpu
(cÚ¡ 
soámax_Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

	@stb_image.h

106 #iâdeà
STBI_INCLUDE_STB_IMAGE_H


107 
	#STBI_INCLUDE_STB_IMAGE_H


	)

306 #iâdeà
STBI_NO_STDIO


307 
	~<¡dio.h
>

310 
	#STBI_VERSION
 1

	)

314 
	mSTBI_deçuÉ
 = 0,

316 
	mSTBI_g»y
 = 1,

317 
	mSTBI_g»y_®pha
 = 2,

318 
	mSTBI_rgb
 = 3,

319 
	mSTBI_rgb_®pha
 = 4

322 
	t¡bi_uc
;

323 
	t¡bi_us
;

325 #ifdeà
__ılu¥lus


329 #ifdeà
STB_IMAGE_STATIC


330 
	#STBIDEF
 

	)

332 
	#STBIDEF
 

	)

346 (*
»ad
è(*
u£r
,*
d©a
,
size
);

347 (*
sk
è(*
u£r
,
n
);

348 (*
eof
è(*
u£r
);

349 } 
	t¡bi_io_ÿÎbacks
;

356 
STBIDEF
 
¡bi_uc
 *
¡bi_lßd_äom_memÜy
 (¡bi_uøcÚ¡ *
bufãr
, 
Ën
 , *
x
, *
y
, *
chªÃls_š_fe
, 
desœed_chªÃls
);

357 
STBIDEF
 
¡bi_uc
 *
¡bi_lßd_äom_ÿÎbacks
(
¡bi_io_ÿÎbacks
 cÚ¡ *
şbk
 , *
u£r
, *
x
, *
y
, *
chªÃls_š_fe
, 
desœed_chªÃls
);

358 #iâdeà
STBI_NO_GIF


359 
STBIDEF
 
¡bi_uc
 *
¡bi_lßd_gif_äom_memÜy
(¡bi_uøcÚ¡ *
bufãr
, 
Ën
, **
d–ays
, *
x
, *
y
, *
z
, *
comp
, 
»q_comp
);

363 #iâdeà
STBI_NO_STDIO


364 
STBIDEF
 
¡bi_uc
 *
¡bi_lßd
 (cÚ¡ *
f’ame
, *
x
, *
y
, *
chªÃls_š_fe
, 
desœed_chªÃls
);

365 
STBIDEF
 
¡bi_uc
 *
¡bi_lßd_äom_fe
 (
FILE
 *
f
, *
x
, *
y
, *
chªÃls_š_fe
, 
desœed_chªÃls
);

374 
STBIDEF
 
¡bi_us
 *
¡bi_lßd_16_äom_memÜy
 (
¡bi_uc
 cÚ¡ *
bufãr
, 
Ën
, *
x
, *
y
, *
chªÃls_š_fe
, 
desœed_chªÃls
);

375 
STBIDEF
 
¡bi_us
 *
¡bi_lßd_16_äom_ÿÎbacks
(
¡bi_io_ÿÎbacks
 cÚ¡ *
şbk
, *
u£r
, *
x
, *
y
, *
chªÃls_š_fe
, 
desœed_chªÃls
);

377 #iâdeà
STBI_NO_STDIO


378 
STBIDEF
 
¡bi_us
 *
¡bi_lßd_16
 (cÚ¡ *
f’ame
, *
x
, *
y
, *
chªÃls_š_fe
, 
desœed_chªÃls
);

379 
STBIDEF
 
¡bi_us
 *
¡bi_lßd_äom_fe_16
(
FILE
 *
f
, *
x
, *
y
, *
chªÃls_š_fe
, 
desœed_chªÃls
);

386 #iâdeà
STBI_NO_LINEAR


387 
STBIDEF
 *
¡bi_lßdf_äom_memÜy
 (
¡bi_uc
 cÚ¡ *
bufãr
, 
Ën
, *
x
, *
y
, *
chªÃls_š_fe
, 
desœed_chªÃls
);

388 
STBIDEF
 *
¡bi_lßdf_äom_ÿÎbacks
 (
¡bi_io_ÿÎbacks
 cÚ¡ *
şbk
, *
u£r
, *
x
, *
y
, *
chªÃls_š_fe
, 
desœed_chªÃls
);

390 #iâdeà
STBI_NO_STDIO


391 
STBIDEF
 *
¡bi_lßdf
 (cÚ¡ *
f’ame
, *
x
, *
y
, *
chªÃls_š_fe
, 
desœed_chªÃls
);

392 
STBIDEF
 *
¡bi_lßdf_äom_fe
 (
FILE
 *
f
, *
x
, *
y
, *
chªÃls_š_fe
, 
desœed_chªÃls
);

396 #iâdeà
STBI_NO_HDR


397 
STBIDEF
 
¡bi_hdr_to_ldr_gamma
(
gamma
);

398 
STBIDEF
 
¡bi_hdr_to_ldr_sÿË
(
sÿË
);

401 #iâdeà
STBI_NO_LINEAR


402 
STBIDEF
 
¡bi_ldr_to_hdr_gamma
(
gamma
);

403 
STBIDEF
 
¡bi_ldr_to_hdr_sÿË
(
sÿË
);

407 
STBIDEF
 
¡bi_is_hdr_äom_ÿÎbacks
(
¡bi_io_ÿÎbacks
 cÚ¡ *
şbk
, *
u£r
);

408 
STBIDEF
 
¡bi_is_hdr_äom_memÜy
(
¡bi_uc
 cÚ¡ *
bufãr
, 
Ën
);

409 #iâdeà
STBI_NO_STDIO


410 
STBIDEF
 
¡bi_is_hdr
 (cÚ¡ *
f’ame
);

411 
STBIDEF
 
¡bi_is_hdr_äom_fe
(
FILE
 *
f
);

417 
STBIDEF
 cÚ¡ *
¡bi_çu»_»asÚ
 ();

420 
STBIDEF
 
¡bi_image_ä“
 (*
»tv®_äom_¡bi_lßd
);

423 
STBIDEF
 
¡bi_šfo_äom_memÜy
(
¡bi_uc
 cÚ¡ *
bufãr
, 
Ën
, *
x
, *
y
, *
comp
);

424 
STBIDEF
 
¡bi_šfo_äom_ÿÎbacks
(
¡bi_io_ÿÎbacks
 cÚ¡ *
şbk
, *
u£r
, *
x
, *
y
, *
comp
);

425 
STBIDEF
 
¡bi_is_16_b™_äom_memÜy
(
¡bi_uc
 cÚ¡ *
bufãr
, 
Ën
);

426 
STBIDEF
 
¡bi_is_16_b™_äom_ÿÎbacks
(
¡bi_io_ÿÎbacks
 cÚ¡ *
şbk
, *
u£r
);

428 #iâdeà
STBI_NO_STDIO


429 
STBIDEF
 
¡bi_šfo
 (cÚ¡ *
f’ame
, *
x
, *
y
, *
comp
);

430 
STBIDEF
 
¡bi_šfo_äom_fe
 (
FILE
 *
f
, *
x
, *
y
, *
comp
);

431 
STBIDEF
 
¡bi_is_16_b™
 (cÚ¡ *
f’ame
);

432 
STBIDEF
 
¡bi_is_16_b™_äom_fe
(
FILE
 *
f
);

440 
STBIDEF
 
¡bi_£t_uÅ»muÉly_Ú_lßd
(
æag_Œue_if_should_uÅ»muÉly
);

444 
STBIDEF
 
¡bi_cÚv”t_hÚe_²g_to_rgb
(
æag_Œue_if_should_cÚv”t
);

447 
STBIDEF
 
¡bi_£t_æ_v”tiÿÎy_Ú_lßd
(
æag_Œue_if_should_æ
);

451 
STBIDEF
 *
¡bi_zlib_decode_m®loc_guesssize
(cÚ¡ *
bufãr
, 
Ën
, 
š™Ÿl_size
, *
ou’
);

452 
STBIDEF
 *
¡bi_zlib_decode_m®loc_guesssize_h—d”æag
(cÚ¡ *
bufãr
, 
Ën
, 
š™Ÿl_size
, *
ou’
, 
·r£_h—d”
);

453 
STBIDEF
 *
¡bi_zlib_decode_m®loc
(cÚ¡ *
bufãr
, 
Ën
, *
ou’
);

454 
STBIDEF
 
¡bi_zlib_decode_bufãr
(*
obufãr
, 
Ş’
, cÚ¡ *
ibufãr
, 
’
);

456 
STBIDEF
 *
¡bi_zlib_decode_noh—d”_m®loc
(cÚ¡ *
bufãr
, 
Ën
, *
ou’
);

457 
STBIDEF
 
¡bi_zlib_decode_noh—d”_bufãr
(*
obufãr
, 
Ş’
, cÚ¡ *
ibufãr
, 
’
);

460 #ifdeà
__ılu¥lus


469 #ifdeà
STB_IMAGE_IMPLEMENTATION


471 #ià
defšed
(
STBI_ONLY_JPEG
è|| defšed(
STBI_ONLY_PNG
è|| defšed(
STBI_ONLY_BMP
) \

472 || 
defšed
(
STBI_ONLY_TGA
è|| defšed(
STBI_ONLY_GIF
è|| defšed(
STBI_ONLY_PSD
) \

473 || 
defšed
(
STBI_ONLY_HDR
è|| defšed(
STBI_ONLY_PIC
è|| defšed(
STBI_ONLY_PNM
) \

474 || 
	$defšed
(
STBI_ONLY_ZLIB
)

475 #iâdeà
STBI_ONLY_JPEG


476 
	#STBI_NO_JPEG


	)

478 #iâdeà
STBI_ONLY_PNG


479 
	#STBI_NO_PNG


	)

481 #iâdeà
STBI_ONLY_BMP


482 
	#STBI_NO_BMP


	)

484 #iâdeà
STBI_ONLY_PSD


485 
	#STBI_NO_PSD


	)

487 #iâdeà
STBI_ONLY_TGA


488 
	#STBI_NO_TGA


	)

490 #iâdeà
STBI_ONLY_GIF


491 
	#STBI_NO_GIF


	)

493 #iâdeà
STBI_ONLY_HDR


494 
	#STBI_NO_HDR


	)

496 #iâdeà
STBI_ONLY_PIC


497 
	#STBI_NO_PIC


	)

499 #iâdeà
STBI_ONLY_PNM


500 
	#STBI_NO_PNM


	)

504 #ià
	`defšed
(
STBI_NO_PNG
è&& !defšed(
STBI_SUPPORT_ZLIB
è&& !defšed(
STBI_NO_ZLIB
)

505 
	#STBI_NO_ZLIB


	)

509 
	~<¡d¬g.h
>

510 
	~<¡ddef.h
>

511 
	~<¡dlib.h
>

512 
	~<¡ršg.h
>

513 
	~<lim™s.h
>

515 #ià!
	`defšed
(
STBI_NO_LINEAR
è|| !defšed(
STBI_NO_HDR
)

516 
	~<m©h.h
>

519 #iâdeà
STBI_NO_STDIO


520 
	~<¡dio.h
>

523 #iâdeà
STBI_ASSERT


524 
	~<as£¹.h
>

525 
	#STBI_ASSERT
(
x
è
	`as£¹
(x)

	)

529 #iâdeà
_MSC_VER


530 #ifdeà
__ılu¥lus


531 
	#¡bi_šlše
 
šlše


	)

533 
	#¡bi_šlše


	)

536 
	#¡bi_šlše
 
__fÜûšlše


	)

540 #ifdeà
_MSC_VER


541 
	t¡bi__ušt16
;

542 sigÃd 
	t¡bi__št16
;

543 
	t¡bi__ušt32
;

544 sigÃd 
	t¡bi__št32
;

546 
	~<¡dšt.h
>

547 
ušt16_t
 
	t¡bi__ušt16
;

548 
št16_t
 
	t¡bi__št16
;

549 
ušt32_t
 
	t¡bi__ušt32
;

550 
št32_t
 
	t¡bi__št32
;

554 
	tv®id©e_ušt32
[(
¡bi__ušt32
)==4 ? 1 : -1];

556 #ifdeà
_MSC_VER


557 
	#STBI_NOTUSED
(
v
è()(v)

	)

559 
	#STBI_NOTUSED
(
v
è()(v)

	)

562 #ifdeà
_MSC_VER


563 
	#STBI_HAS_LROTL


	)

566 #ifdeà
STBI_HAS_LROTL


567 
	#¡bi_ÌÙ
(
x
,
y
è
	`_ÌÙl
(x,y)

	)

569 
	#¡bi_ÌÙ
(
x
,
y
è(((xè<< (y)è| ((xè>> (32 - (y))))

	)

572 #ià
	`defšed
(
STBI_MALLOC
è&& defšed(
STBI_FREE
è&& (defšed(
STBI_REALLOC
è|| defšed(
STBI_REALLOC_SIZED
))

574 #–ià!
	`defšed
(
STBI_MALLOC
è&& !defšed(
STBI_FREE
è&& !defšed(
STBI_REALLOC
è&& !defšed(
STBI_REALLOC_SIZED
)

580 #iâdeà
STBI_MALLOC


581 
	#STBI_MALLOC
(
sz
è
	`m®loc
(sz)

	)

582 
	#STBI_REALLOC
(
p
,
Ãwsz
è
	`»®loc
Õ,Ãwsz)

	)

583 
	#STBI_FREE
(
p
è
	`ä“
Õ)

	)

586 #iâdeà
STBI_REALLOC_SIZED


587 
	#STBI_REALLOC_SIZED
(
p
,
Şdsz
,
Ãwsz
è
	`STBI_REALLOC
Õ,Ãwsz)

	)

591 #ià
	`defšed
(
__x86_64__
è|| defšed(
_M_X64
)

592 
	#STBI__X64_TARGET


	)

593 #–ià
	`defšed
(
__i386
è|| defšed(
_M_IX86
)

594 
	#STBI__X86_TARGET


	)

597 #ià
	`defšed
(
__GNUC__
è&& defšed(
STBI__X86_TARGET
è&& !defšed(
__SSE2__
è&& !defšed(
STBI_NO_SIMD
)

605 
	#STBI_NO_SIMD


	)

608 #ià
	`defšed
(
__MINGW32__
è&& defšed(
STBI__X86_TARGET
è&& !defšed(
STBI_MINGW_ENABLE_SSE2
è&& !defšed(
STBI_NO_SIMD
)

620 
	#STBI_NO_SIMD


	)

623 #ià!
	`defšed
(
STBI_NO_SIMD
è&& (defšed(
STBI__X86_TARGET
è|| defšed(
STBI__X64_TARGET
))

624 
	#STBI_SSE2


	)

625 
	~<emmšŒš.h
>

627 #ifdeà
_MSC_VER


629 #ià
_MSC_VER
 >= 1400

630 
	~<šŒš.h
>

631 
	$¡bi__ıuid3
()

633 
šfo
[4];

634 
	`__ıuid
(
šfo
,1);

635  
šfo
[3];

636 
	}
}

638 
	$¡bi__ıuid3
()

640 
»s
;

641 
__asm
 {

642 
mov
 
—x
,1

643 
ıuid


644 
mov
 
»s
,
edx


646  
»s
;

647 
	}
}

650 
	#STBI_SIMD_ALIGN
(
ty³
, 
Çme
è
	`__deş¥ec
(
	`®ign
(16)èty³ 
	)
name

652 
	$¡bi__s£2_avaabË
()

654 
šfo3
 = 
	`¡bi__ıuid3
();

655  ((
šfo3
 >> 26) & 1) != 0;

656 
	}
}

658 
	#STBI_SIMD_ALIGN
(
ty³
, 
Çme
èty³‚am
	`__©Œibu‹__
((
	`®igÃd
(16)))

	)

660 
	$¡bi__s£2_avaabË
()

666 
	}
}

671 #ià
defšed
(
STBI_NO_SIMD
è&& defšed(
STBI_NEON
)

672 #undeà
STBI_NEON


675 #ifdeà
STBI_NEON


676 
	~<¬m_ÃÚ.h
>

678 
	#STBI_SIMD_ALIGN
(
ty³
, 
Çme
èty³‚am
	`__©Œibu‹__
((
	`®igÃd
(16)))

	)

681 #iâdeà
STBI_SIMD_ALIGN


682 
	#STBI_SIMD_ALIGN
(
ty³
, 
Çme
èty³ 
	)
name

693 
¡bi__ušt32
 
	mimg_x
, 
	mimg_y
;

694 
	mimg_n
, 
	mimg_out_n
;

696 
¡bi_io_ÿÎbacks
 
	mio
;

697 *
	mio_u£r_d©a
;

699 
	m»ad_äom_ÿÎbacks
;

700 
	mbuæ’
;

701 
¡bi_uc
 
	mbufãr_¡¬t
[128];

703 
¡bi_uc
 *
	mimg_bufãr
, *
	mimg_bufãr_’d
;

704 
¡bi_uc
 *
	mimg_bufãr_Üigš®
, *
	mimg_bufãr_Üigš®_’d
;

705 } 
	t¡bi__cÚ‹xt
;

708 
¡bi__»fl_bufãr
(
¡bi__cÚ‹xt
 *
s
);

711 
	$¡bi__¡¬t_mem
(
¡bi__cÚ‹xt
 *
s
, 
¡bi_uc
 cÚ¡ *
bufãr
, 
Ën
)

713 
s
->
io
.
»ad
 = 
NULL
;

714 
s
->
»ad_äom_ÿÎbacks
 = 0;

715 
s
->
img_bufãr
 = s->
img_bufãr_Üigš®
 = (
¡bi_uc
 *è
bufãr
;

716 
s
->
img_bufãr_’d
 = s->
img_bufãr_Üigš®_’d
 = (
¡bi_uc
 *è
bufãr
+
Ën
;

717 
	}
}

720 
	$¡bi__¡¬t_ÿÎbacks
(
¡bi__cÚ‹xt
 *
s
, 
¡bi_io_ÿÎbacks
 *
c
, *
u£r
)

722 
s
->
io
 = *
c
;

723 
s
->
io_u£r_d©a
 = 
u£r
;

724 
s
->
buæ’
 = (s->
bufãr_¡¬t
);

725 
s
->
»ad_äom_ÿÎbacks
 = 1;

726 
s
->
img_bufãr_Üigš®
 = s->
bufãr_¡¬t
;

727 
	`¡bi__»fl_bufãr
(
s
);

728 
s
->
img_bufãr_Üigš®_’d
 = s->
img_bufãr_’d
;

729 
	}
}

731 #iâdeà
STBI_NO_STDIO


733 
	$¡bi__¡dio_»ad
(*
u£r
, *
d©a
, 
size
)

735  (è
	`ä—d
(
d©a
,1,
size
,(
FILE
*è
u£r
);

736 
	}
}

738 
	$¡bi__¡dio_sk
(*
u£r
, 
n
)

740 
	`f£ek
((
FILE
*è
u£r
, 
n
, 
SEEK_CUR
);

741 
	}
}

743 
	$¡bi__¡dio_eof
(*
u£r
)

745  
	`ãof
((
FILE
*è
u£r
);

746 
	}
}

748 
¡bi_io_ÿÎbacks
 
	g¡bi__¡dio_ÿÎbacks
 =

750 
¡bi__¡dio_»ad
,

751 
¡bi__¡dio_sk
,

752 
¡bi__¡dio_eof
,

755 
	$¡bi__¡¬t_fe
(
¡bi__cÚ‹xt
 *
s
, 
FILE
 *
f
)

757 
	`¡bi__¡¬t_ÿÎbacks
(
s
, &
¡bi__¡dio_ÿÎbacks
, (*è
f
);

758 
	}
}

764 
	$¡bi__»wšd
(
¡bi__cÚ‹xt
 *
s
)

769 
s
->
img_bufãr
 = s->
img_bufãr_Üigš®
;

770 
s
->
img_bufãr_’d
 = s->
img_bufãr_Üigš®_’d
;

771 
	}
}

775 
	mSTBI_ORDER_RGB
,

776 
	mSTBI_ORDER_BGR


781 
	mb™s_³r_chªÃl
;

782 
	mnum_chªÃls
;

783 
	mchªÃl_Üd”
;

784 } 
	t¡bi__»suÉ_šfo
;

786 #iâdeà
STBI_NO_JPEG


787 
¡bi__j³g_‹¡
(
¡bi__cÚ‹xt
 *
s
);

788 *
¡bi__j³g_lßd
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
);

789 
¡bi__j³g_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
);

792 #iâdeà
STBI_NO_PNG


793 
¡bi__²g_‹¡
(
¡bi__cÚ‹xt
 *
s
);

794 *
¡bi__²g_lßd
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
);

795 
¡bi__²g_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
);

796 
¡bi__²g_is16
(
¡bi__cÚ‹xt
 *
s
);

799 #iâdeà
STBI_NO_BMP


800 
¡bi__bmp_‹¡
(
¡bi__cÚ‹xt
 *
s
);

801 *
¡bi__bmp_lßd
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
);

802 
¡bi__bmp_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
);

805 #iâdeà
STBI_NO_TGA


806 
¡bi__tga_‹¡
(
¡bi__cÚ‹xt
 *
s
);

807 *
¡bi__tga_lßd
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
);

808 
¡bi__tga_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
);

811 #iâdeà
STBI_NO_PSD


812 
¡bi__psd_‹¡
(
¡bi__cÚ‹xt
 *
s
);

813 *
¡bi__psd_lßd
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
, 
bpc
);

814 
¡bi__psd_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
);

815 
¡bi__psd_is16
(
¡bi__cÚ‹xt
 *
s
);

818 #iâdeà
STBI_NO_HDR


819 
¡bi__hdr_‹¡
(
¡bi__cÚ‹xt
 *
s
);

820 *
¡bi__hdr_lßd
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
);

821 
¡bi__hdr_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
);

824 #iâdeà
STBI_NO_PIC


825 
¡bi__pic_‹¡
(
¡bi__cÚ‹xt
 *
s
);

826 *
¡bi__pic_lßd
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
);

827 
¡bi__pic_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
);

830 #iâdeà
STBI_NO_GIF


831 
¡bi__gif_‹¡
(
¡bi__cÚ‹xt
 *
s
);

832 *
¡bi__gif_lßd
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
);

833 *
¡bi__lßd_gif_maš
(
¡bi__cÚ‹xt
 *
s
, **
d–ays
, *
x
, *
y
, *
z
, *
comp
, 
»q_comp
);

834 
¡bi__gif_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
);

837 #iâdeà
STBI_NO_PNM


838 
¡bi__²m_‹¡
(
¡bi__cÚ‹xt
 *
s
);

839 *
¡bi__²m_lßd
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
);

840 
¡bi__²m_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
);

844 cÚ¡ *
	g¡bi__g_çu»_»asÚ
;

846 
STBIDEF
 cÚ¡ *
	$¡bi_çu»_»asÚ
()

848  
¡bi__g_çu»_»asÚ
;

849 
	}
}

851 
	$¡bi__”r
(cÚ¡ *
¡r
)

853 
¡bi__g_çu»_»asÚ
 = 
¡r
;

855 
	}
}

857 *
	$¡bi__m®loc
(
size_t
 
size
)

859  
	`STBI_MALLOC
(
size
);

860 
	}
}

874 
	$¡bi__addsizes_v®id
(
a
, 
b
)

876 ià(
b
 < 0)  0;

881  
a
 <ğ
INT_MAX
 - 
b
;

882 
	}
}

886 
	$¡bi__mul2sizes_v®id
(
a
, 
b
)

888 ià(
a
 < 0 || 
b
 < 0)  0;

889 ià(
b
 == 0)  1;

891  
a
 <ğ
INT_MAX
/
b
;

892 
	}
}

895 
	$¡bi__mad2sizes_v®id
(
a
, 
b
, 
add
)

897  
	`¡bi__mul2sizes_v®id
(
a
, 
b
è&& 
	`¡bi__addsizes_v®id
×*b, 
add
);

898 
	}
}

901 
	$¡bi__mad3sizes_v®id
(
a
, 
b
, 
c
, 
add
)

903  
	`¡bi__mul2sizes_v®id
(
a
, 
b
è&& stbi__mul2sizes_v®id×*b, 
c
) &&

904 
	`¡bi__addsizes_v®id
(
a
*
b
*
c
, 
add
);

905 
	}
}

908 #ià!
defšed
(
STBI_NO_LINEAR
è|| !defšed(
STBI_NO_HDR
)

909 
	$¡bi__mad4sizes_v®id
(
a
, 
b
, 
c
, 
d
, 
add
)

911  
	`¡bi__mul2sizes_v®id
(
a
, 
b
è&& stbi__mul2sizes_v®id×*b, 
c
) &&

912 
	`¡bi__mul2sizes_v®id
(
a
*
b
*
c
, 
d
è&& 
	`¡bi__addsizes_v®id
×*b*c*d, 
add
);

913 
	}
}

917 *
	$¡bi__m®loc_mad2
(
a
, 
b
, 
add
)

919 ià(!
	`¡bi__mad2sizes_v®id
(
a
, 
b
, 
add
)è 
NULL
;

920  
	`¡bi__m®loc
(
a
*
b
 + 
add
);

921 
	}
}

923 *
	$¡bi__m®loc_mad3
(
a
, 
b
, 
c
, 
add
)

925 ià(!
	`¡bi__mad3sizes_v®id
(
a
, 
b
, 
c
, 
add
)è 
NULL
;

926  
	`¡bi__m®loc
(
a
*
b
*
c
 + 
add
);

927 
	}
}

929 #ià!
defšed
(
STBI_NO_LINEAR
è|| !defšed(
STBI_NO_HDR
)

930 *
	$¡bi__m®loc_mad4
(
a
, 
b
, 
c
, 
d
, 
add
)

932 ià(!
	`¡bi__mad4sizes_v®id
(
a
, 
b
, 
c
, 
d
, 
add
)è 
NULL
;

933  
	`¡bi__m®loc
(
a
*
b
*
c
*
d
 + 
add
);

934 
	}
}

941 #ifdeà
STBI_NO_FAILURE_STRINGS


942 
	#¡bi__”r
(
x
,
y
è0

	)

943 #–ià
defšed
(
STBI_FAILURE_USERMSG
)

944 
	#¡bi__”r
(
x
,
y
è
	`¡bi__”r
(y)

	)

946 
	#¡bi__”r
(
x
,
y
è
	`¡bi__”r
(x)

	)

949 
	#¡bi__”½f
(
x
,
y
è((*)(
size_t
è(
	`¡bi__”r
(x,y)?
NULL
:NULL))

	)

950 
	#¡bi__”½uc
(
x
,
y
è((*)(
size_t
è(
	`¡bi__”r
(x,y)?
NULL
:NULL))

	)

952 
STBIDEF
 
	$¡bi_image_ä“
(*
»tv®_äom_¡bi_lßd
)

954 
	`STBI_FREE
(
»tv®_äom_¡bi_lßd
);

955 
	}
}

957 #iâdeà
STBI_NO_LINEAR


958 *
¡bi__ldr_to_hdr
(
¡bi_uc
 *
d©a
, 
x
, 
y
, 
comp
);

961 #iâdeà
STBI_NO_HDR


962 
¡bi_uc
 *
¡bi__hdr_to_ldr
(*
d©a
, 
x
, 
y
, 
comp
);

965 
	g¡bi__v”tiÿÎy_æ_Ú_lßd
 = 0;

967 
STBIDEF
 
	$¡bi_£t_æ_v”tiÿÎy_Ú_lßd
(
æag_Œue_if_should_æ
)

969 
¡bi__v”tiÿÎy_æ_Ú_lßd
 = 
æag_Œue_if_should_æ
;

970 
	}
}

972 *
	$¡bi__lßd_maš
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
, 
bpc
)

974 
	`mem£t
(
ri
, 0, (*ri));

975 
ri
->
b™s_³r_chªÃl
 = 8;

976 
ri
->
chªÃl_Üd”
 = 
STBI_ORDER_RGB
;

977 
ri
->
num_chªÃls
 = 0;

979 #iâdeà
STBI_NO_JPEG


980 ià(
	`¡bi__j³g_‹¡
(
s
)è 
	`¡bi__j³g_lßd
(s,
x
,
y
,
comp
,
»q_comp
, 
ri
);

982 #iâdeà
STBI_NO_PNG


983 ià(
	`¡bi__²g_‹¡
(
s
)è 
	`¡bi__²g_lßd
(s,
x
,
y
,
comp
,
»q_comp
, 
ri
);

985 #iâdeà
STBI_NO_BMP


986 ià(
	`¡bi__bmp_‹¡
(
s
)è 
	`¡bi__bmp_lßd
(s,
x
,
y
,
comp
,
»q_comp
, 
ri
);

988 #iâdeà
STBI_NO_GIF


989 ià(
	`¡bi__gif_‹¡
(
s
)è 
	`¡bi__gif_lßd
(s,
x
,
y
,
comp
,
»q_comp
, 
ri
);

991 #iâdeà
STBI_NO_PSD


992 ià(
	`¡bi__psd_‹¡
(
s
)è 
	`¡bi__psd_lßd
(s,
x
,
y
,
comp
,
»q_comp
, 
ri
, 
bpc
);

994 #iâdeà
STBI_NO_PIC


995 ià(
	`¡bi__pic_‹¡
(
s
)è 
	`¡bi__pic_lßd
(s,
x
,
y
,
comp
,
»q_comp
, 
ri
);

997 #iâdeà
STBI_NO_PNM


998 ià(
	`¡bi__²m_‹¡
(
s
)è 
	`¡bi__²m_lßd
(s,
x
,
y
,
comp
,
»q_comp
, 
ri
);

1001 #iâdeà
STBI_NO_HDR


1002 ià(
	`¡bi__hdr_‹¡
(
s
)) {

1003 *
hdr
 = 
	`¡bi__hdr_lßd
(
s
, 
x
,
y
,
comp
,
»q_comp
, 
ri
);

1004  
	`¡bi__hdr_to_ldr
(
hdr
, *
x
, *
y
, 
»q_comp
 ?„eq_com°: *
comp
);

1008 #iâdeà
STBI_NO_TGA


1010 ià(
	`¡bi__tga_‹¡
(
s
))

1011  
	`¡bi__tga_lßd
(
s
,
x
,
y
,
comp
,
»q_comp
, 
ri
);

1014  
	`¡bi__”½uc
("unknown imageype", "Image‚ot of‡ny knownype, or corrupt");

1015 
	}
}

1017 
¡bi_uc
 *
	$¡bi__cÚv”t_16_to_8
(
¡bi__ušt16
 *
Üig
, 
w
, 
h
, 
chªÃls
)

1019 
i
;

1020 
img_Ën
 = 
w
 * 
h
 * 
chªÃls
;

1021 
¡bi_uc
 *
»duûd
;

1023 
»duûd
 = (
¡bi_uc
 *è
	`¡bi__m®loc
(
img_Ën
);

1024 ià(
»duûd
 =ğ
NULL
è 
	`¡bi__”½uc
("outofmem", "Out of memory");

1026 
i
 = 0; i < 
img_Ën
; ++i)

1027 
»duûd
[
i
] = (
¡bi_uc
)((
Üig
[i] >> 8) & 0xFF);

1029 
	`STBI_FREE
(
Üig
);

1030  
»duûd
;

1031 
	}
}

1033 
¡bi__ušt16
 *
	$¡bi__cÚv”t_8_to_16
(
¡bi_uc
 *
Üig
, 
w
, 
h
, 
chªÃls
)

1035 
i
;

1036 
img_Ën
 = 
w
 * 
h
 * 
chªÃls
;

1037 
¡bi__ušt16
 *
’Ïrged
;

1039 
’Ïrged
 = (
¡bi__ušt16
 *è
	`¡bi__m®loc
(
img_Ën
*2);

1040 ià(
’Ïrged
 =ğ
NULL
è (
¡bi__ušt16
 *è
	`¡bi__”½uc
("outofmem", "Out of memory");

1042 
i
 = 0; i < 
img_Ën
; ++i)

1043 
’Ïrged
[
i
] = (
¡bi__ušt16
)((
Üig
[i] << 8) + orig[i]);

1045 
	`STBI_FREE
(
Üig
);

1046  
’Ïrged
;

1047 
	}
}

1049 
	$¡bi__v”tiÿl_æ
(*
image
, 
w
, 
h
, 
by‹s_³r_pix–
)

1051 
row
;

1052 
size_t
 
by‹s_³r_row
 = (size_t)
w
 * 
by‹s_³r_pix–
;

1053 
¡bi_uc
 
‹mp
[2048];

1054 
¡bi_uc
 *
by‹s
 = (¡bi_uø*)
image
;

1056 
row
 = 0;„ow < (
h
>>1);„ow++) {

1057 
¡bi_uc
 *
row0
 = 
by‹s
 + 
row
*
by‹s_³r_row
;

1058 
¡bi_uc
 *
row1
 = 
by‹s
 + (
h
 - 
row
 - 1)*
by‹s_³r_row
;

1060 
size_t
 
by‹s_Ëá
 = 
by‹s_³r_row
;

1061 
by‹s_Ëá
) {

1062 
size_t
 
by‹s_cİy
 = (
by‹s_Ëá
 < (
‹mp
)) ? bytes_left : (temp);

1063 
	`memıy
(
‹mp
, 
row0
, 
by‹s_cİy
);

1064 
	`memıy
(
row0
, 
row1
, 
by‹s_cİy
);

1065 
	`memıy
(
row1
, 
‹mp
, 
by‹s_cİy
);

1066 
row0
 +ğ
by‹s_cİy
;

1067 
row1
 +ğ
by‹s_cİy
;

1068 
by‹s_Ëá
 -ğ
by‹s_cİy
;

1071 
	}
}

1073 
	$¡bi__v”tiÿl_æ_¦iûs
(*
image
, 
w
, 
h
, 
z
, 
by‹s_³r_pix–
)

1075 
¦iû
;

1076 
¦iû_size
 = 
w
 * 
h
 * 
by‹s_³r_pix–
;

1078 
¡bi_uc
 *
by‹s
 = (¡bi_uø*)
image
;

1079 
¦iû
 = 0; sliû < 
z
; ++slice) {

1080 
	`¡bi__v”tiÿl_æ
(
by‹s
, 
w
, 
h
, 
by‹s_³r_pix–
);

1081 
by‹s
 +ğ
¦iû_size
;

1083 
	}
}

1085 *
	$¡bi__lßd_ªd_po¡´oûss_8b™
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
)

1087 
¡bi__»suÉ_šfo
 
ri
;

1088 *
»suÉ
 = 
	`¡bi__lßd_maš
(
s
, 
x
, 
y
, 
comp
, 
»q_comp
, &
ri
, 8);

1090 ià(
»suÉ
 =ğ
NULL
)

1091  
NULL
;

1093 ià(
ri
.
b™s_³r_chªÃl
 != 8) {

1094 
	`STBI_ASSERT
(
ri
.
b™s_³r_chªÃl
 == 16);

1095 
»suÉ
 = 
	`¡bi__cÚv”t_16_to_8
((
¡bi__ušt16
 *è»suÉ, *
x
, *
y
, 
»q_comp
 =ğ0 ? *
comp
 :„eq_comp);

1096 
ri
.
b™s_³r_chªÃl
 = 8;

1101 ià(
¡bi__v”tiÿÎy_æ_Ú_lßd
) {

1102 
chªÃls
 = 
»q_comp
 ?„eq_com°: *
comp
;

1103 
	`¡bi__v”tiÿl_æ
(
»suÉ
, *
x
, *
y
, 
chªÃls
 * (
¡bi_uc
));

1106  (*è
»suÉ
;

1107 
	}
}

1109 
¡bi__ušt16
 *
	$¡bi__lßd_ªd_po¡´oûss_16b™
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
)

1111 
¡bi__»suÉ_šfo
 
ri
;

1112 *
»suÉ
 = 
	`¡bi__lßd_maš
(
s
, 
x
, 
y
, 
comp
, 
»q_comp
, &
ri
, 16);

1114 ià(
»suÉ
 =ğ
NULL
)

1115  
NULL
;

1117 ià(
ri
.
b™s_³r_chªÃl
 != 16) {

1118 
	`STBI_ASSERT
(
ri
.
b™s_³r_chªÃl
 == 8);

1119 
»suÉ
 = 
	`¡bi__cÚv”t_8_to_16
((
¡bi_uc
 *è»suÉ, *
x
, *
y
, 
»q_comp
 =ğ0 ? *
comp
 :„eq_comp);

1120 
ri
.
b™s_³r_chªÃl
 = 16;

1126 ià(
¡bi__v”tiÿÎy_æ_Ú_lßd
) {

1127 
chªÃls
 = 
»q_comp
 ?„eq_com°: *
comp
;

1128 
	`¡bi__v”tiÿl_æ
(
»suÉ
, *
x
, *
y
, 
chªÃls
 * (
¡bi__ušt16
));

1131  (
¡bi__ušt16
 *è
»suÉ
;

1132 
	}
}

1134 #ià!
defšed
(
STBI_NO_HDR
è|| !defšed(
STBI_NO_LINEAR
)

1135 
	$¡bi__æßt_po¡´oûss
(*
»suÉ
, *
x
, *
y
, *
comp
, 
»q_comp
)

1137 ià(
¡bi__v”tiÿÎy_æ_Ú_lßd
 && 
»suÉ
 !ğ
NULL
) {

1138 
chªÃls
 = 
»q_comp
 ?„eq_com°: *
comp
;

1139 
	`¡bi__v”tiÿl_æ
(
»suÉ
, *
x
, *
y
, 
chªÃls
 * ());

1141 
	}
}

1144 #iâdeà
STBI_NO_STDIO


1146 
FILE
 *
	$¡bi__fİ’
(cÚ¡ *
f’ame
, cÚ¡ *
mode
)

1148 
FILE
 *
f
;

1149 #ià
	`defšed
(
_MSC_VER
) && _MSC_VER >= 1400

1150 ià(0 !ğ
	`fİ’_s
(&
f
, 
f’ame
, 
mode
))

1151 
f
=0;

1153 
f
 = 
	`fİ’
(
f’ame
, 
mode
);

1155  
f
;

1156 
	}
}

1159 
STBIDEF
 
¡bi_uc
 *
	$¡bi_lßd
(cÚ¡ *
f’ame
, *
x
, *
y
, *
comp
, 
»q_comp
)

1161 
FILE
 *
f
 = 
	`¡bi__fİ’
(
f’ame
, "rb");

1162 *
»suÉ
;

1163 ià(!
f
è 
	`¡bi__”½uc
("can't fopen", "Unableo open file");

1164 
»suÉ
 = 
	`¡bi_lßd_äom_fe
(
f
,
x
,
y
,
comp
,
»q_comp
);

1165 
	`fşo£
(
f
);

1166  
»suÉ
;

1167 
	}
}

1169 
STBIDEF
 
¡bi_uc
 *
	$¡bi_lßd_äom_fe
(
FILE
 *
f
, *
x
, *
y
, *
comp
, 
»q_comp
)

1171 *
»suÉ
;

1172 
¡bi__cÚ‹xt
 
s
;

1173 
	`¡bi__¡¬t_fe
(&
s
,
f
);

1174 
»suÉ
 = 
	`¡bi__lßd_ªd_po¡´oûss_8b™
(&
s
,
x
,
y
,
comp
,
»q_comp
);

1175 ià(
»suÉ
) {

1177 
	`f£ek
(
f
, - (è(
s
.
img_bufãr_’d
 - s.
img_bufãr
), 
SEEK_CUR
);

1179  
»suÉ
;

1180 
	}
}

1182 
STBIDEF
 
¡bi__ušt16
 *
	$¡bi_lßd_äom_fe_16
(
FILE
 *
f
, *
x
, *
y
, *
comp
, 
»q_comp
)

1184 
¡bi__ušt16
 *
»suÉ
;

1185 
¡bi__cÚ‹xt
 
s
;

1186 
	`¡bi__¡¬t_fe
(&
s
,
f
);

1187 
»suÉ
 = 
	`¡bi__lßd_ªd_po¡´oûss_16b™
(&
s
,
x
,
y
,
comp
,
»q_comp
);

1188 ià(
»suÉ
) {

1190 
	`f£ek
(
f
, - (è(
s
.
img_bufãr_’d
 - s.
img_bufãr
), 
SEEK_CUR
);

1192  
»suÉ
;

1193 
	}
}

1195 
STBIDEF
 
¡bi_us
 *
	$¡bi_lßd_16
(cÚ¡ *
f’ame
, *
x
, *
y
, *
comp
, 
»q_comp
)

1197 
FILE
 *
f
 = 
	`¡bi__fİ’
(
f’ame
, "rb");

1198 
¡bi__ušt16
 *
»suÉ
;

1199 ià(!
f
è (
¡bi_us
 *è
	`¡bi__”½uc
("can't fopen", "Unableo open file");

1200 
»suÉ
 = 
	`¡bi_lßd_äom_fe_16
(
f
,
x
,
y
,
comp
,
»q_comp
);

1201 
	`fşo£
(
f
);

1202  
»suÉ
;

1203 
	}
}

1208 
STBIDEF
 
¡bi_us
 *
	$¡bi_lßd_16_äom_memÜy
(
¡bi_uc
 cÚ¡ *
bufãr
, 
Ën
, *
x
, *
y
, *
chªÃls_š_fe
, 
desœed_chªÃls
)

1210 
¡bi__cÚ‹xt
 
s
;

1211 
	`¡bi__¡¬t_mem
(&
s
,
bufãr
,
Ën
);

1212  
	`¡bi__lßd_ªd_po¡´oûss_16b™
(&
s
,
x
,
y
,
chªÃls_š_fe
,
desœed_chªÃls
);

1213 
	}
}

1215 
STBIDEF
 
¡bi_us
 *
	$¡bi_lßd_16_äom_ÿÎbacks
(
¡bi_io_ÿÎbacks
 cÚ¡ *
şbk
, *
u£r
, *
x
, *
y
, *
chªÃls_š_fe
, 
desœed_chªÃls
)

1217 
¡bi__cÚ‹xt
 
s
;

1218 
	`¡bi__¡¬t_ÿÎbacks
(&
s
, (
¡bi_io_ÿÎbacks
 *)
şbk
, 
u£r
);

1219  
	`¡bi__lßd_ªd_po¡´oûss_16b™
(&
s
,
x
,
y
,
chªÃls_š_fe
,
desœed_chªÃls
);

1220 
	}
}

1222 
STBIDEF
 
¡bi_uc
 *
	$¡bi_lßd_äom_memÜy
(
¡bi_uc
 cÚ¡ *
bufãr
, 
Ën
, *
x
, *
y
, *
comp
, 
»q_comp
)

1224 
¡bi__cÚ‹xt
 
s
;

1225 
	`¡bi__¡¬t_mem
(&
s
,
bufãr
,
Ën
);

1226  
	`¡bi__lßd_ªd_po¡´oûss_8b™
(&
s
,
x
,
y
,
comp
,
»q_comp
);

1227 
	}
}

1229 
STBIDEF
 
¡bi_uc
 *
	$¡bi_lßd_äom_ÿÎbacks
(
¡bi_io_ÿÎbacks
 cÚ¡ *
şbk
, *
u£r
, *
x
, *
y
, *
comp
, 
»q_comp
)

1231 
¡bi__cÚ‹xt
 
s
;

1232 
	`¡bi__¡¬t_ÿÎbacks
(&
s
, (
¡bi_io_ÿÎbacks
 *è
şbk
, 
u£r
);

1233  
	`¡bi__lßd_ªd_po¡´oûss_8b™
(&
s
,
x
,
y
,
comp
,
»q_comp
);

1234 
	}
}

1236 #iâdeà
STBI_NO_GIF


1237 
STBIDEF
 
¡bi_uc
 *
	$¡bi_lßd_gif_äom_memÜy
(
¡bi_uc
 cÚ¡ *
bufãr
, 
Ën
, **
d–ays
, *
x
, *
y
, *
z
, *
comp
, 
»q_comp
)

1239 *
»suÉ
;

1240 
¡bi__cÚ‹xt
 
s
;

1241 
	`¡bi__¡¬t_mem
(&
s
,
bufãr
,
Ën
);

1243 
»suÉ
 = (*è
	`¡bi__lßd_gif_maš
(&
s
, 
d–ays
, 
x
, 
y
, 
z
, 
comp
, 
»q_comp
);

1244 ià(
¡bi__v”tiÿÎy_æ_Ú_lßd
) {

1245 
	`¡bi__v”tiÿl_æ_¦iûs
Ğ
»suÉ
, *
x
, *
y
, *
z
, *
comp
 );

1248  
»suÉ
;

1249 
	}
}

1252 #iâdeà
STBI_NO_LINEAR


1253 *
	$¡bi__lßdf_maš
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
)

1255 *
d©a
;

1256 #iâdeà
STBI_NO_HDR


1257 ià(
	`¡bi__hdr_‹¡
(
s
)) {

1258 
¡bi__»suÉ_šfo
 
ri
;

1259 *
hdr_d©a
 = 
	`¡bi__hdr_lßd
(
s
,
x
,
y
,
comp
,
»q_comp
, &
ri
);

1260 ià(
hdr_d©a
)

1261 
	`¡bi__æßt_po¡´oûss
(
hdr_d©a
,
x
,
y
,
comp
,
»q_comp
);

1262  
hdr_d©a
;

1265 
d©a
 = 
	`¡bi__lßd_ªd_po¡´oûss_8b™
(
s
, 
x
, 
y
, 
comp
, 
»q_comp
);

1266 ià(
d©a
)

1267  
	`¡bi__ldr_to_hdr
(
d©a
, *
x
, *
y
, 
»q_comp
 ?„eq_com°: *
comp
);

1268  
	`¡bi__”½f
("unknown imageype", "Image‚ot of‡ny knownype, or corrupt");

1269 
	}
}

1271 
STBIDEF
 *
	$¡bi_lßdf_äom_memÜy
(
¡bi_uc
 cÚ¡ *
bufãr
, 
Ën
, *
x
, *
y
, *
comp
, 
»q_comp
)

1273 
¡bi__cÚ‹xt
 
s
;

1274 
	`¡bi__¡¬t_mem
(&
s
,
bufãr
,
Ën
);

1275  
	`¡bi__lßdf_maš
(&
s
,
x
,
y
,
comp
,
»q_comp
);

1276 
	}
}

1278 
STBIDEF
 *
	$¡bi_lßdf_äom_ÿÎbacks
(
¡bi_io_ÿÎbacks
 cÚ¡ *
şbk
, *
u£r
, *
x
, *
y
, *
comp
, 
»q_comp
)

1280 
¡bi__cÚ‹xt
 
s
;

1281 
	`¡bi__¡¬t_ÿÎbacks
(&
s
, (
¡bi_io_ÿÎbacks
 *è
şbk
, 
u£r
);

1282  
	`¡bi__lßdf_maš
(&
s
,
x
,
y
,
comp
,
»q_comp
);

1283 
	}
}

1285 #iâdeà
STBI_NO_STDIO


1286 
STBIDEF
 *
	$¡bi_lßdf
(cÚ¡ *
f’ame
, *
x
, *
y
, *
comp
, 
»q_comp
)

1288 *
»suÉ
;

1289 
FILE
 *
f
 = 
	`¡bi__fİ’
(
f’ame
, "rb");

1290 ià(!
f
è 
	`¡bi__”½f
("can't fopen", "Unableo open file");

1291 
»suÉ
 = 
	`¡bi_lßdf_äom_fe
(
f
,
x
,
y
,
comp
,
»q_comp
);

1292 
	`fşo£
(
f
);

1293  
»suÉ
;

1294 
	}
}

1296 
STBIDEF
 *
	$¡bi_lßdf_äom_fe
(
FILE
 *
f
, *
x
, *
y
, *
comp
, 
»q_comp
)

1298 
¡bi__cÚ‹xt
 
s
;

1299 
	`¡bi__¡¬t_fe
(&
s
,
f
);

1300  
	`¡bi__lßdf_maš
(&
s
,
x
,
y
,
comp
,
»q_comp
);

1301 
	}
}

1310 
STBIDEF
 
	$¡bi_is_hdr_äom_memÜy
(
¡bi_uc
 cÚ¡ *
bufãr
, 
Ën
)

1312 #iâdeà
STBI_NO_HDR


1313 
¡bi__cÚ‹xt
 
s
;

1314 
	`¡bi__¡¬t_mem
(&
s
,
bufãr
,
Ën
);

1315  
	`¡bi__hdr_‹¡
(&
s
);

1317 
	`STBI_NOTUSED
(
bufãr
);

1318 
	`STBI_NOTUSED
(
Ën
);

1321 
	}
}

1323 #iâdeà
STBI_NO_STDIO


1324 
STBIDEF
 
	$¡bi_is_hdr
 (cÚ¡ *
f’ame
)

1326 
FILE
 *
f
 = 
	`¡bi__fİ’
(
f’ame
, "rb");

1327 
»suÉ
=0;

1328 ià(
f
) {

1329 
»suÉ
 = 
	`¡bi_is_hdr_äom_fe
(
f
);

1330 
	`fşo£
(
f
);

1332  
»suÉ
;

1333 
	}
}

1335 
STBIDEF
 
	$¡bi_is_hdr_äom_fe
(
FILE
 *
f
)

1337 #iâdeà
STBI_NO_HDR


1338 
pos
 = 
	`á–l
(
f
);

1339 
»s
;

1340 
¡bi__cÚ‹xt
 
s
;

1341 
	`¡bi__¡¬t_fe
(&
s
,
f
);

1342 
»s
 = 
	`¡bi__hdr_‹¡
(&
s
);

1343 
	`f£ek
(
f
, 
pos
, 
SEEK_SET
);

1344  
»s
;

1346 
	`STBI_NOTUSED
(
f
);

1349 
	}
}

1352 
STBIDEF
 
	$¡bi_is_hdr_äom_ÿÎbacks
(
¡bi_io_ÿÎbacks
 cÚ¡ *
şbk
, *
u£r
)

1354 #iâdeà
STBI_NO_HDR


1355 
¡bi__cÚ‹xt
 
s
;

1356 
	`¡bi__¡¬t_ÿÎbacks
(&
s
, (
¡bi_io_ÿÎbacks
 *è
şbk
, 
u£r
);

1357  
	`¡bi__hdr_‹¡
(&
s
);

1359 
	`STBI_NOTUSED
(
şbk
);

1360 
	`STBI_NOTUSED
(
u£r
);

1363 
	}
}

1365 #iâdeà
STBI_NO_LINEAR


1366 
	g¡bi__l2h_gamma
=2.2f, 
	g¡bi__l2h_sÿË
=1.0f;

1368 
STBIDEF
 
	$¡bi_ldr_to_hdr_gamma
(
gamma
è{ 
¡bi__l2h_gamma
 = gamma; 
	}
}

1369 
STBIDEF
 
	$¡bi_ldr_to_hdr_sÿË
(
sÿË
è{ 
¡bi__l2h_sÿË
 = sÿË; 
	}
}

1372 
	g¡bi__h2l_gamma_i
=1.0f/2.2f, 
	g¡bi__h2l_sÿË_i
=1.0f;

1374 
STBIDEF
 
	$¡bi_hdr_to_ldr_gamma
(
gamma
è{ 
¡bi__h2l_gamma_i
 = 1/gamma; 
	}
}

1375 
STBIDEF
 
	$¡bi_hdr_to_ldr_sÿË
(
sÿË
è{ 
¡bi__h2l_sÿË_i
 = 1/sÿË; 
	}
}

1385 
	mSTBI__SCAN_lßd
=0,

1386 
	mSTBI__SCAN_ty³
,

1387 
	mSTBI__SCAN_h—d”


1390 
	$¡bi__»fl_bufãr
(
¡bi__cÚ‹xt
 *
s
)

1392 
n
 = (
s
->
io
.
»ad
)(s->
io_u£r_d©a
,(*)s->
bufãr_¡¬t
,s->
buæ’
);

1393 ià(
n
 == 0) {

1396 
s
->
»ad_äom_ÿÎbacks
 = 0;

1397 
s
->
img_bufãr
 = s->
bufãr_¡¬t
;

1398 
s
->
img_bufãr_’d
 = s->
bufãr_¡¬t
+1;

1399 *
s
->
img_bufãr
 = 0;

1401 
s
->
img_bufãr
 = s->
bufãr_¡¬t
;

1402 
s
->
img_bufãr_’d
 = s->
bufãr_¡¬t
 + 
n
;

1404 
	}
}

1406 
¡bi_šlše
 
¡bi_uc
 
	$¡bi__g‘8
(
¡bi__cÚ‹xt
 *
s
)

1408 ià(
s
->
img_bufãr
 < s->
img_bufãr_’d
)

1409  *
s
->
img_bufãr
++;

1410 ià(
s
->
»ad_äom_ÿÎbacks
) {

1411 
	`¡bi__»fl_bufãr
(
s
);

1412  *
s
->
img_bufãr
++;

1415 
	}
}

1417 
¡bi_šlše
 
	$¡bi__©_eof
(
¡bi__cÚ‹xt
 *
s
)

1419 ià(
s
->
io
.
»ad
) {

1420 ià(!(
s
->
io
.
eof
)(s->
io_u£r_d©a
))  0;

1423 ià(
s
->
»ad_äom_ÿÎbacks
 == 0)  1;

1426  
s
->
img_bufãr
 >ğs->
img_bufãr_’d
;

1427 
	}
}

1429 
	$¡bi__sk
(
¡bi__cÚ‹xt
 *
s
, 
n
)

1431 ià(
n
 < 0) {

1432 
s
->
img_bufãr
 = s->
img_bufãr_’d
;

1435 ià(
s
->
io
.
»ad
) {

1436 
bËn
 = (è(
s
->
img_bufãr_’d
 - s->
img_bufãr
);

1437 ià(
bËn
 < 
n
) {

1438 
s
->
img_bufãr
 = s->
img_bufãr_’d
;

1439 (
s
->
io
.
sk
)(s->
io_u£r_d©a
, 
n
 - 
bËn
);

1443 
s
->
img_bufãr
 +ğ
n
;

1444 
	}
}

1446 
	$¡bi__g‘n
(
¡bi__cÚ‹xt
 *
s
, 
¡bi_uc
 *
bufãr
, 
n
)

1448 ià(
s
->
io
.
»ad
) {

1449 
bËn
 = (è(
s
->
img_bufãr_’d
 - s->
img_bufãr
);

1450 ià(
bËn
 < 
n
) {

1451 
»s
, 
couÁ
;

1453 
	`memıy
(
bufãr
, 
s
->
img_bufãr
, 
bËn
);

1455 
couÁ
 = (
s
->
io
.
»ad
)(s->
io_u£r_d©a
, (*è
bufãr
 + 
bËn
, 
n
 - blen);

1456 
»s
 = (
couÁ
 =ğ(
n
-
bËn
));

1457 
s
->
img_bufãr
 = s->
img_bufãr_’d
;

1458  
»s
;

1462 ià(
s
->
img_bufãr
+
n
 <ğs->
img_bufãr_’d
) {

1463 
	`memıy
(
bufãr
, 
s
->
img_bufãr
, 
n
);

1464 
s
->
img_bufãr
 +ğ
n
;

1468 
	}
}

1470 
	$¡bi__g‘16be
(
¡bi__cÚ‹xt
 *
s
)

1472 
z
 = 
	`¡bi__g‘8
(
s
);

1473  (
z
 << 8è+ 
	`¡bi__g‘8
(
s
);

1474 
	}
}

1476 
¡bi__ušt32
 
	$¡bi__g‘32be
(
¡bi__cÚ‹xt
 *
s
)

1478 
¡bi__ušt32
 
z
 = 
	`¡bi__g‘16be
(
s
);

1479  (
z
 << 16è+ 
	`¡bi__g‘16be
(
s
);

1480 
	}
}

1482 #ià
defšed
(
STBI_NO_BMP
è&& defšed(
STBI_NO_TGA
è&& defšed(
STBI_NO_GIF
)

1485 
	$¡bi__g‘16Ë
(
¡bi__cÚ‹xt
 *
s
)

1487 
z
 = 
	`¡bi__g‘8
(
s
);

1488  
z
 + (
	`¡bi__g‘8
(
s
) << 8);

1489 
	}
}

1492 #iâdeà
STBI_NO_BMP


1493 
¡bi__ušt32
 
	$¡bi__g‘32Ë
(
¡bi__cÚ‹xt
 *
s
)

1495 
¡bi__ušt32
 
z
 = 
	`¡bi__g‘16Ë
(
s
);

1496  
z
 + (
	`¡bi__g‘16Ë
(
s
) << 16);

1497 
	}
}

1500 
	#STBI__BYTECAST
(
x
è((
¡bi_uc
) ((x) & 255))

1501 

	)

1514 
¡bi_uc
 
	$¡bi__compu‹_y
(
r
, 
g
, 
b
)

1516  (
¡bi_uc
è(((
r
*77è+ (
g
*150è+ (29*
b
)) >> 8);

1517 
	}
}

1519 *
	$¡bi__cÚv”t_fÜm©
(*
d©a
, 
img_n
, 
»q_comp
, 
x
, 
y
)

1521 
i
,
j
;

1522 *
good
;

1524 ià(
»q_comp
 =ğ
img_n
è 
d©a
;

1525 
	`STBI_ASSERT
(
»q_comp
 >= 1 &&„eq_comp <= 4);

1527 
good
 = (*è
	`¡bi__m®loc_mad3
(
»q_comp
, 
x
, 
y
, 0);

1528 ià(
good
 =ğ
NULL
) {

1529 
	`STBI_FREE
(
d©a
);

1530  
	`¡bi__”½uc
("outofmem", "Out of memory");

1533 
j
=0; j < (è
y
; ++j) {

1534 *
¤c
 = 
d©a
 + 
j
 * 
x
 * 
img_n
 ;

1535 *
de¡
 = 
good
 + 
j
 * 
x
 * 
»q_comp
;

1537 
	#STBI__COMBO
(
a
,
b
è(×)*8+(b))

	)

1538 
	#STBI__CASE
(
a
,
b
è
	`STBI__COMBO
×,b): 
i
=
x
-1; i >ğ0; --i, 
¤c
 +ğa, 
de¡
 +ğb)

	)

1541 
	`STBI__COMBO
(
img_n
, 
»q_comp
)) {

1542 
	`STBI__CASE
(1,2è{ 
de¡
[0]=
¤c
[0], dest[1]=255; } ;

1543 
	`STBI__CASE
(1,3è{ 
de¡
[0]=de¡[1]=de¡[2]=
¤c
[0]; } ;

1544 
	`STBI__CASE
(1,4è{ 
de¡
[0]=de¡[1]=de¡[2]=
¤c
[0], dest[3]=255; } ;

1545 
	`STBI__CASE
(2,1è{ 
de¡
[0]=
¤c
[0]; } ;

1546 
	`STBI__CASE
(2,3è{ 
de¡
[0]=de¡[1]=de¡[2]=
¤c
[0]; } ;

1547 
	`STBI__CASE
(2,4è{ 
de¡
[0]=de¡[1]=de¡[2]=
¤c
[0], dest[3]=src[1]; } ;

1548 
	`STBI__CASE
(3,4è{ 
de¡
[0]=
¤c
[0],dest[1]=src[1],dest[2]=src[2],dest[3]=255; } ;

1549 
	`STBI__CASE
(3,1è{ 
de¡
[0]=
	`¡bi__compu‹_y
(
¤c
[0],src[1],src[2]); } ;

1550 
	`STBI__CASE
(3,2è{ 
de¡
[0]=
	`¡bi__compu‹_y
(
¤c
[0],src[1],src[2]), dest[1] = 255; } ;

1551 
	`STBI__CASE
(4,1è{ 
de¡
[0]=
	`¡bi__compu‹_y
(
¤c
[0],src[1],src[2]); } ;

1552 
	`STBI__CASE
(4,2è{ 
de¡
[0]=
	`¡bi__compu‹_y
(
¤c
[0],src[1],src[2]), dest[1] = src[3]; } ;

1553 
	`STBI__CASE
(4,3è{ 
de¡
[0]=
¤c
[0],dest[1]=src[1],dest[2]=src[2]; } ;

1554 : 
	`STBI_ASSERT
(0);

1556 #undeà
STBI__CASE


1559 
	`STBI_FREE
(
d©a
);

1560  
good
;

1561 
	}
}

1563 
¡bi__ušt16
 
	$¡bi__compu‹_y_16
(
r
, 
g
, 
b
)

1565  (
¡bi__ušt16
è(((
r
*77è+ (
g
*150è+ (29*
b
)) >> 8);

1566 
	}
}

1568 
¡bi__ušt16
 *
	$¡bi__cÚv”t_fÜm©16
(
¡bi__ušt16
 *
d©a
, 
img_n
, 
»q_comp
, 
x
, 
y
)

1570 
i
,
j
;

1571 
¡bi__ušt16
 *
good
;

1573 ià(
»q_comp
 =ğ
img_n
è 
d©a
;

1574 
	`STBI_ASSERT
(
»q_comp
 >= 1 &&„eq_comp <= 4);

1576 
good
 = (
¡bi__ušt16
 *è
	`¡bi__m®loc
(
»q_comp
 * 
x
 * 
y
 * 2);

1577 ià(
good
 =ğ
NULL
) {

1578 
	`STBI_FREE
(
d©a
);

1579  (
¡bi__ušt16
 *è
	`¡bi__”½uc
("outofmem", "Out of memory");

1582 
j
=0; j < (è
y
; ++j) {

1583 
¡bi__ušt16
 *
¤c
 = 
d©a
 + 
j
 * 
x
 * 
img_n
 ;

1584 
¡bi__ušt16
 *
de¡
 = 
good
 + 
j
 * 
x
 * 
»q_comp
;

1586 
	#STBI__COMBO
(
a
,
b
è(×)*8+(b))

	)

1587 
	#STBI__CASE
(
a
,
b
è
	`STBI__COMBO
×,b): 
i
=
x
-1; i >ğ0; --i, 
¤c
 +ğa, 
de¡
 +ğb)

	)

1590 
	`STBI__COMBO
(
img_n
, 
»q_comp
)) {

1591 
	`STBI__CASE
(1,2è{ 
de¡
[0]=
¤c
[0], dest[1]=0xffff; } ;

1592 
	`STBI__CASE
(1,3è{ 
de¡
[0]=de¡[1]=de¡[2]=
¤c
[0]; } ;

1593 
	`STBI__CASE
(1,4è{ 
de¡
[0]=de¡[1]=de¡[2]=
¤c
[0], dest[3]=0xffff; } ;

1594 
	`STBI__CASE
(2,1è{ 
de¡
[0]=
¤c
[0]; } ;

1595 
	`STBI__CASE
(2,3è{ 
de¡
[0]=de¡[1]=de¡[2]=
¤c
[0]; } ;

1596 
	`STBI__CASE
(2,4è{ 
de¡
[0]=de¡[1]=de¡[2]=
¤c
[0], dest[3]=src[1]; } ;

1597 
	`STBI__CASE
(3,4è{ 
de¡
[0]=
¤c
[0],dest[1]=src[1],dest[2]=src[2],dest[3]=0xffff; } ;

1598 
	`STBI__CASE
(3,1è{ 
de¡
[0]=
	`¡bi__compu‹_y_16
(
¤c
[0],src[1],src[2]); } ;

1599 
	`STBI__CASE
(3,2è{ 
de¡
[0]=
	`¡bi__compu‹_y_16
(
¤c
[0],src[1],src[2]), dest[1] = 0xffff; } ;

1600 
	`STBI__CASE
(4,1è{ 
de¡
[0]=
	`¡bi__compu‹_y_16
(
¤c
[0],src[1],src[2]); } ;

1601 
	`STBI__CASE
(4,2è{ 
de¡
[0]=
	`¡bi__compu‹_y_16
(
¤c
[0],src[1],src[2]), dest[1] = src[3]; } ;

1602 
	`STBI__CASE
(4,3è{ 
de¡
[0]=
¤c
[0],dest[1]=src[1],dest[2]=src[2]; } ;

1603 : 
	`STBI_ASSERT
(0);

1605 #undeà
STBI__CASE


1608 
	`STBI_FREE
(
d©a
);

1609  
good
;

1610 
	}
}

1612 #iâdeà
STBI_NO_LINEAR


1613 *
	$¡bi__ldr_to_hdr
(
¡bi_uc
 *
d©a
, 
x
, 
y
, 
comp
)

1615 
i
,
k
,
n
;

1616 *
ouut
;

1617 ià(!
d©a
è 
NULL
;

1618 
ouut
 = (*è
	`¡bi__m®loc_mad4
(
x
, 
y
, 
comp
, (), 0);

1619 ià(
ouut
 =ğ
NULL
è{ 
	`STBI_FREE
(
d©a
);  
	`¡bi__”½f
("outofmem", "Out of memory"); }

1621 ià(
comp
 & 1è
n
 = comp; n = comp-1;

1622 
i
=0; i < 
x
*
y
; ++i) {

1623 
k
=0; k < 
n
; ++k) {

1624 
ouut
[
i
*
comp
 + 
k
] = (è(
	`pow
(
d©a
[i*comp+k]/255.0f, 
¡bi__l2h_gamma
è* 
¡bi__l2h_sÿË
);

1626 ià(
k
 < 
comp
è
ouut
[
i
*com°+ k] = 
d©a
[i*comp+k]/255.0f;

1628 
	`STBI_FREE
(
d©a
);

1629  
ouut
;

1630 
	}
}

1633 #iâdeà
STBI_NO_HDR


1634 
	#¡bi__æßt2št
(
x
è((è(x))

	)

1635 
¡bi_uc
 *
	$¡bi__hdr_to_ldr
(*
d©a
, 
x
, 
y
, 
comp
)

1637 
i
,
k
,
n
;

1638 
¡bi_uc
 *
ouut
;

1639 ià(!
d©a
è 
NULL
;

1640 
ouut
 = (
¡bi_uc
 *è
	`¡bi__m®loc_mad3
(
x
, 
y
, 
comp
, 0);

1641 ià(
ouut
 =ğ
NULL
è{ 
	`STBI_FREE
(
d©a
);  
	`¡bi__”½uc
("outofmem", "Out of memory"); }

1643 ià(
comp
 & 1è
n
 = comp; n = comp-1;

1644 
i
=0; i < 
x
*
y
; ++i) {

1645 
k
=0; k < 
n
; ++k) {

1646 
z
 = (è
	`pow
(
d©a
[
i
*
comp
+
k
]*
¡bi__h2l_sÿË_i
, 
¡bi__h2l_gamma_i
) * 255 + 0.5f;

1647 ià(
z
 < 0) z = 0;

1648 ià(
z
 > 255) z = 255;

1649 
ouut
[
i
*
comp
 + 
k
] = (
¡bi_uc
è
	`¡bi__æßt2št
(
z
);

1651 ià(
k
 < 
comp
) {

1652 
z
 = 
d©a
[
i
*
comp
+
k
] * 255 + 0.5f;

1653 ià(
z
 < 0) z = 0;

1654 ià(
z
 > 255) z = 255;

1655 
ouut
[
i
*
comp
 + 
k
] = (
¡bi_uc
è
	`¡bi__æßt2št
(
z
);

1658 
	`STBI_FREE
(
d©a
);

1659  
ouut
;

1660 
	}
}

1684 #iâdeà
STBI_NO_JPEG


1687 
	#FAST_BITS
 9

1688 

	)

1691 
¡bi_uc
 
	mç¡
[1 << 
FAST_BITS
];

1693 
¡bi__ušt16
 
	mcode
[256];

1694 
¡bi_uc
 
	mv®ues
[256];

1695 
¡bi_uc
 
	msize
[257];

1696 
	mmaxcode
[18];

1697 
	md–
[17];

1698 } 
	t¡bi__huffmª
;

1702 
¡bi__cÚ‹xt
 *
	ms
;

1703 
¡bi__huffmª
 
	mhuff_dc
[4];

1704 
¡bi__huffmª
 
	mhuff_ac
[4];

1705 
¡bi__ušt16
 
	mdequªt
[4][64];

1706 
¡bi__št16
 
	mç¡_ac
[4][1 << 
FAST_BITS
];

1709 
	mimg_h_max
, 
	mimg_v_max
;

1710 
	mimg_mcu_x
, 
	mimg_mcu_y
;

1711 
	mimg_mcu_w
, 
	mimg_mcu_h
;

1716 
	mid
;

1717 
	mh
,
	mv
;

1718 
	mtq
;

1719 
	mhd
,
	mha
;

1720 
	mdc_´ed
;

1722 
	mx
,
	my
,
	mw2
,
	mh2
;

1723 
¡bi_uc
 *
	md©a
;

1724 *
	m¿w_d©a
, *
	m¿w_cÛff
;

1725 
¡bi_uc
 *
	mlšebuf
;

1726 *
	mcÛff
;

1727 
	mcÛff_w
, 
	mcÛff_h
;

1728 } 
	mimg_comp
[4];

1730 
¡bi__ušt32
 
	mcode_bufãr
;

1731 
	mcode_b™s
;

1732 
	mm¬k”
;

1733 
	mnomÜe
;

1735 
	m´og»ssive
;

1736 
	m¥ec_¡¬t
;

1737 
	m¥ec_’d
;

1738 
	msucc_high
;

1739 
	msucc_low
;

1740 
	meob_run
;

1741 
	mjfif
;

1742 
	m­p14_cŞÜ_ŒªsfÜm
;

1743 
	mrgb
;

1745 
	msÿn_n
, 
	mÜd”
[4];

1746 
	m»¡¬t_š‹rv®
, 
	mtodo
;

1749 (*
	midù_block_k”Ãl
)(
¡bi_uc
 *
	mout
, 
	mout_¡ride
, 
	md©a
[64]);

1750 (*
	mYCbCr_to_RGB_k”Ãl
)(
¡bi_uc
 *
	mout
, cÚ¡ stbi_uø*
	my
, cÚ¡ stbi_uø*
	mpcb
, cÚ¡ stbi_uø*
	mpü
, 
	mcouÁ
, 
	m¡•
);

1751 
	m¡bi_uc
 *(*
	m»§m¶e_row_hv_2_k”Ãl
)(
¡bi_uc
 *
	mout
, stbi_uø*
	mš_Ã¬
, stbi_uø*
	mš_çr
, 
	mw
, 
	mhs
);

1752 } 
	t¡bi__j³g
;

1754 
	$¡bi__bud_huffmª
(
¡bi__huffmª
 *
h
, *
couÁ
)

1756 
i
,
j
,
k
=0;

1757 
code
;

1759 
i
=0; i < 16; ++i)

1760 
j
=0; j < 
couÁ
[
i
]; ++j)

1761 
h
->
size
[
k
++] = (
¡bi_uc
è(
i
+1);

1762 
h
->
size
[
k
] = 0;

1765 
code
 = 0;

1766 
k
 = 0;

1767 
j
=1; j <= 16; ++j) {

1769 
h
->
d–
[
j
] = 
k
 - 
code
;

1770 ià(
h
->
size
[
k
] =ğ
j
) {

1771 
h
->
size
[
k
] =ğ
j
)

1772 
h
->
code
[
k
++] = (
¡bi__ušt16
) (code++);

1773 ià(
code
-1 >ğ(1u << 
j
)è 
	`¡bi__”r
("bad code†engths","Corrupt JPEG");

1776 
h
->
maxcode
[
j
] = 
code
 << (16-j);

1777 
code
 <<= 1;

1779 
h
->
maxcode
[
j
] = 0xffffffff;

1782 
	`mem£t
(
h
->
ç¡
, 255, 1 << 
FAST_BITS
);

1783 
i
=0; i < 
k
; ++i) {

1784 
s
 = 
h
->
size
[
i
];

1785 ià(
s
 <ğ
FAST_BITS
) {

1786 
c
 = 
h
->
code
[
i
] << (
FAST_BITS
-
s
);

1787 
m
 = 1 << (
FAST_BITS
-
s
);

1788 
j
=0; j < 
m
; ++j) {

1789 
h
->
ç¡
[
c
+
j
] = (
¡bi_uc
è
i
;

1794 
	}
}

1798 
	$¡bi__bud_ç¡_ac
(
¡bi__št16
 *
ç¡_ac
, 
¡bi__huffmª
 *
h
)

1800 
i
;

1801 
i
=0; i < (1 << 
FAST_BITS
); ++i) {

1802 
¡bi_uc
 
ç¡
 = 
h
->ç¡[
i
];

1803 
ç¡_ac
[
i
] = 0;

1804 ià(
ç¡
 < 255) {

1805 
rs
 = 
h
->
v®ues
[
ç¡
];

1806 
run
 = (
rs
 >> 4) & 15;

1807 
magb™s
 = 
rs
 & 15;

1808 
Ën
 = 
h
->
size
[
ç¡
];

1810 ià(
magb™s
 && 
Ën
 + magb™ <ğ
FAST_BITS
) {

1812 
k
 = ((
i
 << 
Ën
è& ((1 << 
FAST_BITS
è- 1)è>> (FAST_BITS - 
magb™s
);

1813 
m
 = 1 << (
magb™s
 - 1);

1814 ià(
k
 < 
m
èk +ğ(~0U << 
magb™s
) + 1;

1816 ià(
k
 >= -128 && k <= 127)

1817 
ç¡_ac
[
i
] = (
¡bi__št16
è((
k
 * 256è+ (
run
 * 16è+ (
Ën
 + 
magb™s
));

1821 
	}
}

1823 
	$¡bi__grow_bufãr_un§ã
(
¡bi__j³g
 *
j
)

1826 
b
 = 
j
->
nomÜe
 ? 0 : 
	`¡bi__g‘8
(j->
s
);

1827 ià(
b
 == 0xff) {

1828 
c
 = 
	`¡bi__g‘8
(
j
->
s
);

1829 
c
 =ğ0xffèøğ
	`¡bi__g‘8
(
j
->
s
);

1830 ià(
c
 != 0) {

1831 
j
->
m¬k”
 = (è
c
;

1832 
j
->
nomÜe
 = 1;

1836 
j
->
code_bufãr
 |ğ
b
 << (24 - j->
code_b™s
);

1837 
j
->
code_b™s
 += 8;

1838 } 
j
->
code_b™s
 <= 24);

1839 
	}
}

1842 cÚ¡ 
¡bi__ušt32
 
	g¡bi__bmask
[17]={0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535};

1845 
¡bi_šlše
 
	$¡bi__j³g_huff_decode
(
¡bi__j³g
 *
j
, 
¡bi__huffmª
 *
h
)

1847 
‹mp
;

1848 
c
,
k
;

1850 ià(
j
->
code_b™s
 < 16è
	`¡bi__grow_bufãr_un§ã
(j);

1854 
c
 = (
j
->
code_bufãr
 >> (32 - 
FAST_BITS
)) & ((1 << FAST_BITS)-1);

1855 
k
 = 
h
->
ç¡
[
c
];

1856 ià(
k
 < 255) {

1857 
s
 = 
h
->
size
[
k
];

1858 ià(
s
 > 
j
->
code_b™s
)

1860 
j
->
code_bufãr
 <<ğ
s
;

1861 
j
->
code_b™s
 -ğ
s
;

1862  
h
->
v®ues
[
k
];

1871 
‹mp
 = 
j
->
code_bufãr
 >> 16;

1872 
k
=
FAST_BITS
+1 ; ; ++k)

1873 ià(
‹mp
 < 
h
->
maxcode
[
k
])

1875 ià(
k
 == 17) {

1877 
j
->
code_b™s
 -= 16;

1881 ià(
k
 > 
j
->
code_b™s
)

1885 
c
 = ((
j
->
code_bufãr
 >> (32 - 
k
)è& 
¡bi__bmask
[k]è+ 
h
->
d–
[k];

1886 
	`STBI_ASSERT
((((
j
->
code_bufãr
è>> (32 - 
h
->
size
[
c
])è& 
¡bi__bmask
[h->size[c]]è=ğh->
code
[c]);

1889 
j
->
code_b™s
 -ğ
k
;

1890 
j
->
code_bufãr
 <<ğ
k
;

1891  
h
->
v®ues
[
c
];

1892 
	}
}

1895 cÚ¡ 
	g¡bi__jbŸs
[16] = {0,-1,-3,-7,-15,-31,-63,-127,-255,-511,-1023,-2047,-4095,-8191,-16383,-32767};

1899 
¡bi_šlše
 
	$¡bi__ex‹nd_»ûive
(
¡bi__j³g
 *
j
, 
n
)

1901 
k
;

1902 
sgn
;

1903 ià(
j
->
code_b™s
 < 
n
è
	`¡bi__grow_bufãr_un§ã
(j);

1905 
sgn
 = (
¡bi__št32
)
j
->
code_bufãr
 >> 31;

1906 
k
 = 
	`¡bi_ÌÙ
(
j
->
code_bufãr
, 
n
);

1907 
	`STBI_ASSERT
(
n
 >ğ0 &&‚ < (è((
¡bi__bmask
)/(*stbi__bmask)));

1908 
j
->
code_bufãr
 = 
k
 & ~
¡bi__bmask
[
n
];

1909 
k
 &ğ
¡bi__bmask
[
n
];

1910 
j
->
code_b™s
 -ğ
n
;

1911  
k
 + (
¡bi__jbŸs
[
n
] & ~
sgn
);

1912 
	}
}

1915 
¡bi_šlše
 
	$¡bi__j³g_g‘_b™s
(
¡bi__j³g
 *
j
, 
n
)

1917 
k
;

1918 ià(
j
->
code_b™s
 < 
n
è
	`¡bi__grow_bufãr_un§ã
(j);

1919 
k
 = 
	`¡bi_ÌÙ
(
j
->
code_bufãr
, 
n
);

1920 
j
->
code_bufãr
 = 
k
 & ~
¡bi__bmask
[
n
];

1921 
k
 &ğ
¡bi__bmask
[
n
];

1922 
j
->
code_b™s
 -ğ
n
;

1923  
k
;

1924 
	}
}

1926 
¡bi_šlše
 
	$¡bi__j³g_g‘_b™
(
¡bi__j³g
 *
j
)

1928 
k
;

1929 ià(
j
->
code_b™s
 < 1è
	`¡bi__grow_bufãr_un§ã
(j);

1930 
k
 = 
j
->
code_bufãr
;

1931 
j
->
code_bufãr
 <<= 1;

1932 --
j
->
code_b™s
;

1933  
k
 & 0x80000000;

1934 
	}
}

1938 cÚ¡ 
¡bi_uc
 
	g¡bi__j³g_dezigzag
[64+15] =

1954 
	$¡bi__j³g_decode_block
(
¡bi__j³g
 *
j
, 
d©a
[64], 
¡bi__huffmª
 *
hdc
, stbi__huffmª *
hac
, 
¡bi__št16
 *
çc
, 
b
, 
¡bi__ušt16
 *
dequªt
)

1956 
diff
,
dc
,
k
;

1957 
t
;

1959 ià(
j
->
code_b™s
 < 16è
	`¡bi__grow_bufãr_un§ã
(j);

1960 
t
 = 
	`¡bi__j³g_huff_decode
(
j
, 
hdc
);

1961 ià(
t
 < 0è 
	`¡bi__”r
("bad huffman code","Corrupt JPEG");

1964 
	`mem£t
(
d©a
,0,64*(data[0]));

1966 
diff
 = 
t
 ? 
	`¡bi__ex‹nd_»ûive
(
j
,) : 0;

1967 
dc
 = 
j
->
img_comp
[
b
].
dc_´ed
 + 
diff
;

1968 
j
->
img_comp
[
b
].
dc_´ed
 = 
dc
;

1969 
d©a
[0] = (è(
dc
 * 
dequªt
[0]);

1972 
k
 = 1;

1974 
zig
;

1975 
c
,
r
,
s
;

1976 ià(
j
->
code_b™s
 < 16è
	`¡bi__grow_bufãr_un§ã
(j);

1977 
c
 = (
j
->
code_bufãr
 >> (32 - 
FAST_BITS
)) & ((1 << FAST_BITS)-1);

1978 
r
 = 
çc
[
c
];

1979 ià(
r
) {

1980 
k
 +ğ(
r
 >> 4) & 15;

1981 
s
 = 
r
 & 15;

1982 
j
->
code_bufãr
 <<ğ
s
;

1983 
j
->
code_b™s
 -ğ
s
;

1985 
zig
 = 
¡bi__j³g_dezigzag
[
k
++];

1986 
d©a
[
zig
] = (è((
r
 >> 8è* 
dequªt
[zig]);

1988 
rs
 = 
	`¡bi__j³g_huff_decode
(
j
, 
hac
);

1989 ià(
rs
 < 0è 
	`¡bi__”r
("bad huffman code","Corrupt JPEG");

1990 
s
 = 
rs
 & 15;

1991 
r
 = 
rs
 >> 4;

1992 ià(
s
 == 0) {

1993 ià(
rs
 != 0xf0) ;

1994 
k
 += 16;

1996 
k
 +ğ
r
;

1998 
zig
 = 
¡bi__j³g_dezigzag
[
k
++];

1999 
d©a
[
zig
] = (è(
	`¡bi__ex‹nd_»ûive
(
j
,
s
è* 
dequªt
[zig]);

2002 } 
k
 < 64);

2004 
	}
}

2006 
	$¡bi__j³g_decode_block_´og_dc
(
¡bi__j³g
 *
j
, 
d©a
[64], 
¡bi__huffmª
 *
hdc
, 
b
)

2008 
diff
,
dc
;

2009 
t
;

2010 ià(
j
->
¥ec_’d
 !ğ0è 
	`¡bi__”r
("can't merge dc‡nd‡c", "Corrupt JPEG");

2012 ià(
j
->
code_b™s
 < 16è
	`¡bi__grow_bufãr_un§ã
(j);

2014 ià(
j
->
succ_high
 == 0) {

2016 
	`mem£t
(
d©a
,0,64*(data[0]));

2017 
t
 = 
	`¡bi__j³g_huff_decode
(
j
, 
hdc
);

2018 
diff
 = 
t
 ? 
	`¡bi__ex‹nd_»ûive
(
j
,) : 0;

2020 
dc
 = 
j
->
img_comp
[
b
].
dc_´ed
 + 
diff
;

2021 
j
->
img_comp
[
b
].
dc_´ed
 = 
dc
;

2022 
d©a
[0] = (è(
dc
 << 
j
->
succ_low
);

2025 ià(
	`¡bi__j³g_g‘_b™
(
j
))

2026 
d©a
[0] +ğ(è(1 << 
j
->
succ_low
);

2029 
	}
}

2033 
	$¡bi__j³g_decode_block_´og_ac
(
¡bi__j³g
 *
j
, 
d©a
[64], 
¡bi__huffmª
 *
hac
, 
¡bi__št16
 *
çc
)

2035 
k
;

2036 ià(
j
->
¥ec_¡¬t
 =ğ0è 
	`¡bi__”r
("can't merge dc‡nd‡c", "Corrupt JPEG");

2038 ià(
j
->
succ_high
 == 0) {

2039 
shiá
 = 
j
->
succ_low
;

2041 ià(
j
->
eob_run
) {

2042 --
j
->
eob_run
;

2046 
k
 = 
j
->
¥ec_¡¬t
;

2048 
zig
;

2049 
c
,
r
,
s
;

2050 ià(
j
->
code_b™s
 < 16è
	`¡bi__grow_bufãr_un§ã
(j);

2051 
c
 = (
j
->
code_bufãr
 >> (32 - 
FAST_BITS
)) & ((1 << FAST_BITS)-1);

2052 
r
 = 
çc
[
c
];

2053 ià(
r
) {

2054 
k
 +ğ(
r
 >> 4) & 15;

2055 
s
 = 
r
 & 15;

2056 
j
->
code_bufãr
 <<ğ
s
;

2057 
j
->
code_b™s
 -ğ
s
;

2058 
zig
 = 
¡bi__j³g_dezigzag
[
k
++];

2059 
d©a
[
zig
] = (è((
r
 >> 8è<< 
shiá
);

2061 
rs
 = 
	`¡bi__j³g_huff_decode
(
j
, 
hac
);

2062 ià(
rs
 < 0è 
	`¡bi__”r
("bad huffman code","Corrupt JPEG");

2063 
s
 = 
rs
 & 15;

2064 
r
 = 
rs
 >> 4;

2065 ià(
s
 == 0) {

2066 ià(
r
 < 15) {

2067 
j
->
eob_run
 = (1 << 
r
);

2068 ià(
r
)

2069 
j
->
eob_run
 +ğ
	`¡bi__j³g_g‘_b™s
(j, 
r
);

2070 --
j
->
eob_run
;

2073 
k
 += 16;

2075 
k
 +ğ
r
;

2076 
zig
 = 
¡bi__j³g_dezigzag
[
k
++];

2077 
d©a
[
zig
] = (è(
	`¡bi__ex‹nd_»ûive
(
j
,
s
è<< 
shiá
);

2080 } 
k
 <ğ
j
->
¥ec_’d
);

2084 
b™
 = (è(1 << 
j
->
succ_low
);

2086 ià(
j
->
eob_run
) {

2087 --
j
->
eob_run
;

2088 
k
 = 
j
->
¥ec_¡¬t
; k <ğj->
¥ec_’d
; ++k) {

2089 *
p
 = &
d©a
[
¡bi__j³g_dezigzag
[
k
]];

2090 ià(*
p
 != 0)

2091 ià(
	`¡bi__j³g_g‘_b™
(
j
))

2092 ià((*
p
 & 
b™
)==0) {

2093 ià(*
p
 > 0)

2094 *
p
 +ğ
b™
;

2096 *
p
 -ğ
b™
;

2100 
k
 = 
j
->
¥ec_¡¬t
;

2102 
r
,
s
;

2103 
rs
 = 
	`¡bi__j³g_huff_decode
(
j
, 
hac
);

2104 ià(
rs
 < 0è 
	`¡bi__”r
("bad huffman code","Corrupt JPEG");

2105 
s
 = 
rs
 & 15;

2106 
r
 = 
rs
 >> 4;

2107 ià(
s
 == 0) {

2108 ià(
r
 < 15) {

2109 
j
->
eob_run
 = (1 << 
r
) - 1;

2110 ià(
r
)

2111 
j
->
eob_run
 +ğ
	`¡bi__j³g_g‘_b™s
(j, 
r
);

2112 
r
 = 64;

2119 ià(
s
 !ğ1è 
	`¡bi__”r
("bad huffman code", "Corrupt JPEG");

2121 ià(
	`¡bi__j³g_g‘_b™
(
j
))

2122 
s
 = 
b™
;

2124 
s
 = -
b™
;

2128 
k
 <ğ
j
->
¥ec_’d
) {

2129 *
p
 = &
d©a
[
¡bi__j³g_dezigzag
[
k
++]];

2130 ià(*
p
 != 0) {

2131 ià(
	`¡bi__j³g_g‘_b™
(
j
))

2132 ià((*
p
 & 
b™
)==0) {

2133 ià(*
p
 > 0)

2134 *
p
 +ğ
b™
;

2136 *
p
 -ğ
b™
;

2139 ià(
r
 == 0) {

2140 *
p
 = (è
s
;

2143 --
r
;

2146 } 
k
 <ğ
j
->
¥ec_’d
);

2150 
	}
}

2153 
¡bi_šlše
 
¡bi_uc
 
	$¡bi__şamp
(
x
)

2156 ià((è
x
 > 255) {

2157 ià(
x
 < 0)  0;

2158 ià(
x
 > 255)  255;

2160  (
¡bi_uc
è
x
;

2161 
	}
}

2163 
	#¡bi__f2f
(
x
è((è(((xè* 4096 + 0.5)))

	)

2164 
	#¡bi__fsh
(
x
è((xè* 4096)

	)

2167 
	#STBI__IDCT_1D
(
s0
,
s1
,
s2
,
s3
,
s4
,
s5
,
s6
,
s7
) \

2168 
t0
,
t1
,
t2
,
t3
,
p1
,
p2
,
p3
,
p4
,
p5
,
x0
,
x1
,
x2
,
x3
; \

2169 
p2
 = 
s2
; \

2170 
p3
 = 
s6
; \

2171 
p1
 = (
p2
+
p3
è* 
	`¡bi__f2f
(0.5411961f); \

2172 
t2
 = 
p1
 + 
p3
*
	`¡bi__f2f
(-1.847759065f); \

2173 
t3
 = 
p1
 + 
p2
*
	`¡bi__f2f
( 0.765366865f); \

2174 
p2
 = 
s0
; \

2175 
p3
 = 
s4
; \

2176 
t0
 = 
	`¡bi__fsh
(
p2
+
p3
); \

2177 
t1
 = 
	`¡bi__fsh
(
p2
-
p3
); \

2178 
x0
 = 
t0
+
t3
; \

2179 
x3
 = 
t0
-
t3
; \

2180 
x1
 = 
t1
+
t2
; \

2181 
x2
 = 
t1
-
t2
; \

2182 
t0
 = 
s7
; \

2183 
t1
 = 
s5
; \

2184 
t2
 = 
s3
; \

2185 
t3
 = 
s1
; \

2186 
p3
 = 
t0
+
t2
; \

2187 
p4
 = 
t1
+
t3
; \

2188 
p1
 = 
t0
+
t3
; \

2189 
p2
 = 
t1
+
t2
; \

2190 
p5
 = (
p3
+
p4
)*
	`¡bi__f2f
( 1.175875602f); \

2191 
t0
 =0*
	`¡bi__f2f
( 0.298631336f); \

2192 
t1
 =1*
	`¡bi__f2f
( 2.053119869f); \

2193 
t2
 =2*
	`¡bi__f2f
( 3.072711026f); \

2194 
t3
 =3*
	`¡bi__f2f
( 1.501321110f); \

2195 
p1
 = 
p5
 +…1*
	`¡bi__f2f
(-0.899976223f); \

2196 
p2
 = 
p5
 +…2*
	`¡bi__f2f
(-2.562915447f); \

2197 
p3
 =…3*
	`¡bi__f2f
(-1.961570560f); \

2198 
p4
 =…4*
	`¡bi__f2f
(-0.390180644f); \

2199 
t3
 +ğ
p1
+
p4
; \

2200 
t2
 +ğ
p2
+
p3
; \

2201 
t1
 +ğ
p2
+
p4
; \

2202 
t0
 +ğ
p1
+
p3
;

	)

2204 
	$¡bi__idù_block
(
¡bi_uc
 *
out
, 
out_¡ride
, 
d©a
[64])

2206 
i
,
v®
[64],*
v
=val;

2207 
¡bi_uc
 *
o
;

2208 *
d
 = 
d©a
;

2211 
i
=0; i < 8; ++i,++
d
, ++
v
) {

2213 ià(
d
[ 8]==0 && d[16]==0 && d[24]==0 && d[32]==0

2214 && 
d
[40]==0 && d[48]==0 && d[56]==0) {

2219 
dù”m
 = 
d
[0]*4;

2220 
v
[0] = v[8] = v[16] = v[24] = v[32] = v[40] = v[48] = v[56] = 
dù”m
;

2222 
	`STBI__IDCT_1D
(
d
[ 0],d[ 8],d[16],d[24],d[32],d[40],d[48],d[56])

2225 
x0
 +ğ512; 
x1
 +ğ512; 
x2
 +ğ512; 
x3
 += 512;

2226 
v
[ 0] = (
x0
+
t3
) >> 10;

2227 
v
[56] = (
x0
-
t3
) >> 10;

2228 
v
[ 8] = (
x1
+
t2
) >> 10;

2229 
v
[48] = (
x1
-
t2
) >> 10;

2230 
v
[16] = (
x2
+
t1
) >> 10;

2231 
v
[40] = (
x2
-
t1
) >> 10;

2232 
v
[24] = (
x3
+
t0
) >> 10;

2233 
v
[32] = (
x3
-
t0
) >> 10;

2237 
i
=0, 
v
=
v®
, 
o
=
out
; i < 8; ++i,v+=8,o+=
out_¡ride
) {

2239 
	`STBI__IDCT_1D
(
v
[0],v[1],v[2],v[3],v[4],v[5],v[6],v[7])

2246 
x0
 += 65536 + (128<<17);

2247 
x1
 += 65536 + (128<<17);

2248 
x2
 += 65536 + (128<<17);

2249 
x3
 += 65536 + (128<<17);

2252 
o
[0] = 
	`¡bi__şamp
((
x0
+
t3
) >> 17);

2253 
o
[7] = 
	`¡bi__şamp
((
x0
-
t3
) >> 17);

2254 
o
[1] = 
	`¡bi__şamp
((
x1
+
t2
) >> 17);

2255 
o
[6] = 
	`¡bi__şamp
((
x1
-
t2
) >> 17);

2256 
o
[2] = 
	`¡bi__şamp
((
x2
+
t1
) >> 17);

2257 
o
[5] = 
	`¡bi__şamp
((
x2
-
t1
) >> 17);

2258 
o
[3] = 
	`¡bi__şamp
((
x3
+
t0
) >> 17);

2259 
o
[4] = 
	`¡bi__şamp
((
x3
-
t0
) >> 17);

2261 
	}
}

2263 #ifdeà
STBI_SSE2


2267 
	$¡bi__idù_simd
(
¡bi_uc
 *
out
, 
out_¡ride
, 
d©a
[64])

2270 
__m128i
 
row0
, 
row1
, 
row2
, 
row3
, 
row4
, 
row5
, 
row6
, 
row7
;

2271 
__m128i
 
tmp
;

2274 
	#dù_cÚ¡
(
x
,
y
è
	`_mm_£Œ_•i16
((x),(y),(x),(y),(x),(y),(x),(y))

	)

2278 
	#dù_rÙ
(
out0
,
out1
, 
x
,
y
,
c0
,
c1
) \

2279 
__m128i
 
c0
##
lo
 = 
	`_mm_uÅacklo_•i16
((
x
),(
y
)); \

2280 
__m128i
 
c0
##
hi
 = 
	`_mm_uÅackhi_•i16
((
x
),(
y
)); \

2281 
__m128i
 
out0
##
_l
 = 
	`_mm_madd_•i16
(
c0
##
lo
, c0); \

2282 
__m128i
 
out0
##
_h
 = 
	`_mm_madd_•i16
(
c0
##
hi
, c0); \

2283 
__m128i
 
out1
##
_l
 = 
	`_mm_madd_•i16
(
c0
##
lo
, 
c1
); \

2284 
__m128i
 
out1
##
_h
 = 
	`_mm_madd_•i16
(
c0
##
hi
, 
c1
)

	)

2287 
	#dù_wid’
(
out
, 
š
) \

2288 
__m128i
 
out
##
_l
 = 
	`_mm_¤ai_•i32
(
	`_mm_uÅacklo_•i16
(
	`_mm_£tz”o_si128
(), (
š
)), 4); \

2289 
__m128i
 
out
##
_h
 = 
	`_mm_¤ai_•i32
(
	`_mm_uÅackhi_•i16
(
	`_mm_£tz”o_si128
(), (
š
)), 4)

	)

2292 
	#dù_wadd
(
out
, 
a
, 
b
) \

2293 
__m128i
 
out
##
_l
 = 
	`_mm_add_•i32
(
a
##_l, 
b
##_l); \

2294 
__m128i
 
out
##
_h
 = 
	`_mm_add_•i32
(
a
##_h, 
b
##_h)

	)

2297 
	#dù_wsub
(
out
, 
a
, 
b
) \

2298 
__m128i
 
out
##
_l
 = 
	`_mm_sub_•i32
(
a
##_l, 
b
##_l); \

2299 
__m128i
 
out
##
_h
 = 
	`_mm_sub_•i32
(
a
##_h, 
b
##_h)

	)

2302 
	#dù_bæy32o
(
out0
, 
out1
, 
a
,
b
,
bŸs
,
s
) \

2304 
__m128i
 
abŸ£d_l
 = 
	`_mm_add_•i32
(
a
##
_l
, 
bŸs
); \

2305 
__m128i
 
abŸ£d_h
 = 
	`_mm_add_•i32
(
a
##
_h
, 
bŸs
); \

2306 
	`dù_wadd
(
sum
, 
abŸ£d
, 
b
); \

2307 
	`dù_wsub
(
dif
, 
abŸ£d
, 
b
); \

2308 
out0
 = 
	`_mm_·cks_•i32
(
	`_mm_¤ai_•i32
(
sum_l
, 
s
), _mm_¤ai_•i32(
sum_h
, s)); \

2309 
out1
 = 
	`_mm_·cks_•i32
(
	`_mm_¤ai_•i32
(
dif_l
, 
s
), _mm_¤ai_•i32(
dif_h
, s)); \

2310 }

	)

2313 
	#dù_š‹¾—ve8
(
a
, 
b
) \

2314 
tmp
 = 
a
; \

2315 
a
 = 
	`_mm_uÅacklo_•i8
×, 
b
); \

2316 
b
 = 
	`_mm_uÅackhi_•i8
(
tmp
, b)

	)

2319 
	#dù_š‹¾—ve16
(
a
, 
b
) \

2320 
tmp
 = 
a
; \

2321 
a
 = 
	`_mm_uÅacklo_•i16
×, 
b
); \

2322 
b
 = 
	`_mm_uÅackhi_•i16
(
tmp
, b)

	)

2324 
	#dù_·ss
(
bŸs
,
shiá
) \

2327 
	`dù_rÙ
(
t2e
,
t3e
, 
row2
,
row6
, 
rÙ0_0
,
rÙ0_1
); \

2328 
__m128i
 
sum04
 = 
	`_mm_add_•i16
(
row0
, 
row4
); \

2329 
__m128i
 
dif04
 = 
	`_mm_sub_•i16
(
row0
, 
row4
); \

2330 
	`dù_wid’
(
t0e
, 
sum04
); \

2331 
	`dù_wid’
(
t1e
, 
dif04
); \

2332 
	`dù_wadd
(
x0
, 
t0e
, 
t3e
); \

2333 
	`dù_wsub
(
x3
, 
t0e
, 
t3e
); \

2334 
	`dù_wadd
(
x1
, 
t1e
, 
t2e
); \

2335 
	`dù_wsub
(
x2
, 
t1e
, 
t2e
); \

2337 
	`dù_rÙ
(
y0o
,
y2o
, 
row7
,
row3
, 
rÙ2_0
,
rÙ2_1
); \

2338 
	`dù_rÙ
(
y1o
,
y3o
, 
row5
,
row1
, 
rÙ3_0
,
rÙ3_1
); \

2339 
__m128i
 
sum17
 = 
	`_mm_add_•i16
(
row1
, 
row7
); \

2340 
__m128i
 
sum35
 = 
	`_mm_add_•i16
(
row3
, 
row5
); \

2341 
	`dù_rÙ
(
y4o
,
y5o
, 
sum17
,
sum35
, 
rÙ1_0
,
rÙ1_1
); \

2342 
	`dù_wadd
(
x4
, 
y0o
, 
y4o
); \

2343 
	`dù_wadd
(
x5
, 
y1o
, 
y5o
); \

2344 
	`dù_wadd
(
x6
, 
y2o
, 
y5o
); \

2345 
	`dù_wadd
(
x7
, 
y3o
, 
y4o
); \

2346 
	`dù_bæy32o
(
row0
,
row7
, 
x0
,
x7
,
bŸs
,
shiá
); \

2347 
	`dù_bæy32o
(
row1
,
row6
, 
x1
,
x6
,
bŸs
,
shiá
); \

2348 
	`dù_bæy32o
(
row2
,
row5
, 
x2
,
x5
,
bŸs
,
shiá
); \

2349 
	`dù_bæy32o
(
row3
,
row4
, 
x3
,
x4
,
bŸs
,
shiá
); \

2350 }

	)

2352 
__m128i
 
rÙ0_0
 = 
	`dù_cÚ¡
(
	`¡bi__f2f
(0.5411961f), stbi__f2f(0.5411961f) + stbi__f2f(-1.847759065f));

2353 
__m128i
 
rÙ0_1
 = 
	`dù_cÚ¡
(
	`¡bi__f2f
(0.5411961f) + stbi__f2f( 0.765366865f), stbi__f2f(0.5411961f));

2354 
__m128i
 
rÙ1_0
 = 
	`dù_cÚ¡
(
	`¡bi__f2f
(1.175875602f) + stbi__f2f(-0.899976223f), stbi__f2f(1.175875602f));

2355 
__m128i
 
rÙ1_1
 = 
	`dù_cÚ¡
(
	`¡bi__f2f
(1.175875602f), stbi__f2f(1.175875602f) + stbi__f2f(-2.562915447f));

2356 
__m128i
 
rÙ2_0
 = 
	`dù_cÚ¡
(
	`¡bi__f2f
(-1.961570560f) + stbi__f2f( 0.298631336f), stbi__f2f(-1.961570560f));

2357 
__m128i
 
rÙ2_1
 = 
	`dù_cÚ¡
(
	`¡bi__f2f
(-1.961570560f), stbi__f2f(-1.961570560f) + stbi__f2f( 3.072711026f));

2358 
__m128i
 
rÙ3_0
 = 
	`dù_cÚ¡
(
	`¡bi__f2f
(-0.390180644f) + stbi__f2f( 2.053119869f), stbi__f2f(-0.390180644f));

2359 
__m128i
 
rÙ3_1
 = 
	`dù_cÚ¡
(
	`¡bi__f2f
(-0.390180644f), stbi__f2f(-0.390180644f) + stbi__f2f( 1.501321110f));

2362 
__m128i
 
bŸs_0
 = 
	`_mm_£t1_•i32
(512);

2363 
__m128i
 
bŸs_1
 = 
	`_mm_£t1_•i32
(65536 + (128<<17));

2366 
row0
 = 
	`_mm_lßd_si128
((cÚ¡ 
__m128i
 *è(
d©a
 + 0*8));

2367 
row1
 = 
	`_mm_lßd_si128
((cÚ¡ 
__m128i
 *è(
d©a
 + 1*8));

2368 
row2
 = 
	`_mm_lßd_si128
((cÚ¡ 
__m128i
 *è(
d©a
 + 2*8));

2369 
row3
 = 
	`_mm_lßd_si128
((cÚ¡ 
__m128i
 *è(
d©a
 + 3*8));

2370 
row4
 = 
	`_mm_lßd_si128
((cÚ¡ 
__m128i
 *è(
d©a
 + 4*8));

2371 
row5
 = 
	`_mm_lßd_si128
((cÚ¡ 
__m128i
 *è(
d©a
 + 5*8));

2372 
row6
 = 
	`_mm_lßd_si128
((cÚ¡ 
__m128i
 *è(
d©a
 + 6*8));

2373 
row7
 = 
	`_mm_lßd_si128
((cÚ¡ 
__m128i
 *è(
d©a
 + 7*8));

2376 
	`dù_·ss
(
bŸs_0
, 10);

2380 
	`dù_š‹¾—ve16
(
row0
, 
row4
);

2381 
	`dù_š‹¾—ve16
(
row1
, 
row5
);

2382 
	`dù_š‹¾—ve16
(
row2
, 
row6
);

2383 
	`dù_š‹¾—ve16
(
row3
, 
row7
);

2386 
	`dù_š‹¾—ve16
(
row0
, 
row2
);

2387 
	`dù_š‹¾—ve16
(
row1
, 
row3
);

2388 
	`dù_š‹¾—ve16
(
row4
, 
row6
);

2389 
	`dù_š‹¾—ve16
(
row5
, 
row7
);

2392 
	`dù_š‹¾—ve16
(
row0
, 
row1
);

2393 
	`dù_š‹¾—ve16
(
row2
, 
row3
);

2394 
	`dù_š‹¾—ve16
(
row4
, 
row5
);

2395 
	`dù_š‹¾—ve16
(
row6
, 
row7
);

2399 
	`dù_·ss
(
bŸs_1
, 17);

2403 
__m128i
 
p0
 = 
	`_mm_·ckus_•i16
(
row0
, 
row1
);

2404 
__m128i
 
p1
 = 
	`_mm_·ckus_•i16
(
row2
, 
row3
);

2405 
__m128i
 
p2
 = 
	`_mm_·ckus_•i16
(
row4
, 
row5
);

2406 
__m128i
 
p3
 = 
	`_mm_·ckus_•i16
(
row6
, 
row7
);

2409 
	`dù_š‹¾—ve8
(
p0
, 
p2
);

2410 
	`dù_š‹¾—ve8
(
p1
, 
p3
);

2413 
	`dù_š‹¾—ve8
(
p0
, 
p1
);

2414 
	`dù_š‹¾—ve8
(
p2
, 
p3
);

2417 
	`dù_š‹¾—ve8
(
p0
, 
p2
);

2418 
	`dù_š‹¾—ve8
(
p1
, 
p3
);

2421 
	`_mm_¡Ü–_•i64
((
__m128i
 *è
out
, 
p0
); ouˆ+ğ
out_¡ride
;

2422 
	`_mm_¡Ü–_•i64
((
__m128i
 *è
out
, 
	`_mm_shufæe_•i32
(
p0
, 0x4e)); ouˆ+ğ
out_¡ride
;

2423 
	`_mm_¡Ü–_•i64
((
__m128i
 *è
out
, 
p2
); ouˆ+ğ
out_¡ride
;

2424 
	`_mm_¡Ü–_•i64
((
__m128i
 *è
out
, 
	`_mm_shufæe_•i32
(
p2
, 0x4e)); ouˆ+ğ
out_¡ride
;

2425 
	`_mm_¡Ü–_•i64
((
__m128i
 *è
out
, 
p1
); ouˆ+ğ
out_¡ride
;

2426 
	`_mm_¡Ü–_•i64
((
__m128i
 *è
out
, 
	`_mm_shufæe_•i32
(
p1
, 0x4e)); ouˆ+ğ
out_¡ride
;

2427 
	`_mm_¡Ü–_•i64
((
__m128i
 *è
out
, 
p3
); ouˆ+ğ
out_¡ride
;

2428 
	`_mm_¡Ü–_•i64
((
__m128i
 *è
out
, 
	`_mm_shufæe_•i32
(
p3
, 0x4e));

2431 #undeà
dù_cÚ¡


2432 #undeà
dù_rÙ


2433 #undeà
dù_wid’


2434 #undeà
dù_wadd


2435 #undeà
dù_wsub


2436 #undeà
dù_bæy32o


2437 #undeà
dù_š‹¾—ve8


2438 #undeà
dù_š‹¾—ve16


2439 #undeà
dù_·ss


2440 
	}
}

2444 #ifdeà
STBI_NEON


2448 
	$¡bi__idù_simd
(
¡bi_uc
 *
out
, 
out_¡ride
, 
d©a
[64])

2450 
št16x8_t
 
row0
, 
row1
, 
row2
, 
row3
, 
row4
, 
row5
, 
row6
, 
row7
;

2452 
št16x4_t
 
rÙ0_0
 = 
	`vdup_n_s16
(
	`¡bi__f2f
(0.5411961f));

2453 
št16x4_t
 
rÙ0_1
 = 
	`vdup_n_s16
(
	`¡bi__f2f
(-1.847759065f));

2454 
št16x4_t
 
rÙ0_2
 = 
	`vdup_n_s16
(
	`¡bi__f2f
( 0.765366865f));

2455 
št16x4_t
 
rÙ1_0
 = 
	`vdup_n_s16
(
	`¡bi__f2f
( 1.175875602f));

2456 
št16x4_t
 
rÙ1_1
 = 
	`vdup_n_s16
(
	`¡bi__f2f
(-0.899976223f));

2457 
št16x4_t
 
rÙ1_2
 = 
	`vdup_n_s16
(
	`¡bi__f2f
(-2.562915447f));

2458 
št16x4_t
 
rÙ2_0
 = 
	`vdup_n_s16
(
	`¡bi__f2f
(-1.961570560f));

2459 
št16x4_t
 
rÙ2_1
 = 
	`vdup_n_s16
(
	`¡bi__f2f
(-0.390180644f));

2460 
št16x4_t
 
rÙ3_0
 = 
	`vdup_n_s16
(
	`¡bi__f2f
( 0.298631336f));

2461 
št16x4_t
 
rÙ3_1
 = 
	`vdup_n_s16
(
	`¡bi__f2f
( 2.053119869f));

2462 
št16x4_t
 
rÙ3_2
 = 
	`vdup_n_s16
(
	`¡bi__f2f
( 3.072711026f));

2463 
št16x4_t
 
rÙ3_3
 = 
	`vdup_n_s16
(
	`¡bi__f2f
( 1.501321110f));

2465 
	#dù_lÚg_mul
(
out
, 
šq
, 
cÛff
) \

2466 
št32x4_t
 
out
##
_l
 = 
	`vmuÎ_s16
(
	`vg‘_low_s16
(
šq
), 
cÛff
); \

2467 
št32x4_t
 
out
##
_h
 = 
	`vmuÎ_s16
(
	`vg‘_high_s16
(
šq
), 
cÛff
)

	)

2469 
	#dù_lÚg_mac
(
out
, 
acc
, 
šq
, 
cÛff
) \

2470 
št32x4_t
 
out
##
_l
 = 
	`vmÏl_s16
(
acc
##_l, 
	`vg‘_low_s16
(
šq
), 
cÛff
); \

2471 
št32x4_t
 
out
##
_h
 = 
	`vmÏl_s16
(
acc
##_h, 
	`vg‘_high_s16
(
šq
), 
cÛff
)

	)

2473 
	#dù_wid’
(
out
, 
šq
) \

2474 
št32x4_t
 
out
##
_l
 = 
	`vshÎ_n_s16
(
	`vg‘_low_s16
(
šq
), 12); \

2475 
št32x4_t
 
out
##
_h
 = 
	`vshÎ_n_s16
(
	`vg‘_high_s16
(
šq
), 12)

	)

2478 
	#dù_wadd
(
out
, 
a
, 
b
) \

2479 
št32x4_t
 
out
##
_l
 = 
	`vaddq_s32
(
a
##_l, 
b
##_l); \

2480 
št32x4_t
 
out
##
_h
 = 
	`vaddq_s32
(
a
##_h, 
b
##_h)

	)

2483 
	#dù_wsub
(
out
, 
a
, 
b
) \

2484 
št32x4_t
 
out
##
_l
 = 
	`vsubq_s32
(
a
##_l, 
b
##_l); \

2485 
št32x4_t
 
out
##
_h
 = 
	`vsubq_s32
(
a
##_h, 
b
##_h)

	)

2488 
	#dù_bæy32o
(
out0
,
out1
, 
a
,
b
,
shiáİ
,
s
) \

2490 
	`dù_wadd
(
sum
, 
a
, 
b
); \

2491 
	`dù_wsub
(
dif
, 
a
, 
b
); \

2492 
out0
 = 
	`vcombše_s16
(
	`shiáİ
(
sum_l
, 
s
), shiáİ(
sum_h
, s)); \

2493 
out1
 = 
	`vcombše_s16
(
	`shiáİ
(
dif_l
, 
s
), shiáİ(
dif_h
, s)); \

2494 }

	)

2496 
	#dù_·ss
(
shiáİ
, 
shiá
) \

2499 
št16x8_t
 
sum26
 = 
	`vaddq_s16
(
row2
, 
row6
); \

2500 
	`dù_lÚg_mul
(
p1e
, 
sum26
, 
rÙ0_0
); \

2501 
	`dù_lÚg_mac
(
t2e
, 
p1e
, 
row6
, 
rÙ0_1
); \

2502 
	`dù_lÚg_mac
(
t3e
, 
p1e
, 
row2
, 
rÙ0_2
); \

2503 
št16x8_t
 
sum04
 = 
	`vaddq_s16
(
row0
, 
row4
); \

2504 
št16x8_t
 
dif04
 = 
	`vsubq_s16
(
row0
, 
row4
); \

2505 
	`dù_wid’
(
t0e
, 
sum04
); \

2506 
	`dù_wid’
(
t1e
, 
dif04
); \

2507 
	`dù_wadd
(
x0
, 
t0e
, 
t3e
); \

2508 
	`dù_wsub
(
x3
, 
t0e
, 
t3e
); \

2509 
	`dù_wadd
(
x1
, 
t1e
, 
t2e
); \

2510 
	`dù_wsub
(
x2
, 
t1e
, 
t2e
); \

2512 
št16x8_t
 
sum15
 = 
	`vaddq_s16
(
row1
, 
row5
); \

2513 
št16x8_t
 
sum17
 = 
	`vaddq_s16
(
row1
, 
row7
); \

2514 
št16x8_t
 
sum35
 = 
	`vaddq_s16
(
row3
, 
row5
); \

2515 
št16x8_t
 
sum37
 = 
	`vaddq_s16
(
row3
, 
row7
); \

2516 
št16x8_t
 
sumodd
 = 
	`vaddq_s16
(
sum17
, 
sum35
); \

2517 
	`dù_lÚg_mul
(
p5o
, 
sumodd
, 
rÙ1_0
); \

2518 
	`dù_lÚg_mac
(
p1o
, 
p5o
, 
sum17
, 
rÙ1_1
); \

2519 
	`dù_lÚg_mac
(
p2o
, 
p5o
, 
sum35
, 
rÙ1_2
); \

2520 
	`dù_lÚg_mul
(
p3o
, 
sum37
, 
rÙ2_0
); \

2521 
	`dù_lÚg_mul
(
p4o
, 
sum15
, 
rÙ2_1
); \

2522 
	`dù_wadd
(
sump13o
, 
p1o
, 
p3o
); \

2523 
	`dù_wadd
(
sump24o
, 
p2o
, 
p4o
); \

2524 
	`dù_wadd
(
sump23o
, 
p2o
, 
p3o
); \

2525 
	`dù_wadd
(
sump14o
, 
p1o
, 
p4o
); \

2526 
	`dù_lÚg_mac
(
x4
, 
sump13o
, 
row7
, 
rÙ3_0
); \

2527 
	`dù_lÚg_mac
(
x5
, 
sump24o
, 
row5
, 
rÙ3_1
); \

2528 
	`dù_lÚg_mac
(
x6
, 
sump23o
, 
row3
, 
rÙ3_2
); \

2529 
	`dù_lÚg_mac
(
x7
, 
sump14o
, 
row1
, 
rÙ3_3
); \

2530 
	`dù_bæy32o
(
row0
,
row7
, 
x0
,
x7
,
shiáİ
,
shiá
); \

2531 
	`dù_bæy32o
(
row1
,
row6
, 
x1
,
x6
,
shiáİ
,
shiá
); \

2532 
	`dù_bæy32o
(
row2
,
row5
, 
x2
,
x5
,
shiáİ
,
shiá
); \

2533 
	`dù_bæy32o
(
row3
,
row4
, 
x3
,
x4
,
shiáİ
,
shiá
); \

2534 }

	)

2537 
row0
 = 
	`vld1q_s16
(
d©a
 + 0*8);

2538 
row1
 = 
	`vld1q_s16
(
d©a
 + 1*8);

2539 
row2
 = 
	`vld1q_s16
(
d©a
 + 2*8);

2540 
row3
 = 
	`vld1q_s16
(
d©a
 + 3*8);

2541 
row4
 = 
	`vld1q_s16
(
d©a
 + 4*8);

2542 
row5
 = 
	`vld1q_s16
(
d©a
 + 5*8);

2543 
row6
 = 
	`vld1q_s16
(
d©a
 + 6*8);

2544 
row7
 = 
	`vld1q_s16
(
d©a
 + 7*8);

2547 
row0
 = 
	`vaddq_s16
Ôow0, 
	`v£tq_ÏÃ_s16
(1024, 
	`vdupq_n_s16
(0), 0));

2550 
	`dù_·ss
(
vrshº_n_s32
, 10);

2556 
	#dù_Œn16
(
x
, 
y
è{ 
št16x8x2_t
 
t
 = 
	`vŒnq_s16
(x, y); x =.
v®
[0]; y =.v®[1]; }

	)

2557 
	#dù_Œn32
(
x
, 
y
è{ 
št32x4x2_t
 
t
 = 
	`vŒnq_s32
(
	`v»š‹½»tq_s32_s16
(x), v»š‹½»tq_s32_s16(y)); x = 
	`v»š‹½»tq_s16_s32
Ñ.
v®
[0]); y = v»š‹½»tq_s16_s32Ñ.v®[1]); }

	)

2558 
	#dù_Œn64
(
x
, 
y
è{ 
št16x8_t
 
x0
 = x; iÁ16x8_ˆ
y0
 = y; x = 
	`vcombše_s16
(
	`vg‘_low_s16
(x0), vg‘_low_s16(y0)); y = vcombše_s16(
	`vg‘_high_s16
(x0), vg‘_high_s16(y0)); }

	)

2561 
	`dù_Œn16
(
row0
, 
row1
);

2562 
	`dù_Œn16
(
row2
, 
row3
);

2563 
	`dù_Œn16
(
row4
, 
row5
);

2564 
	`dù_Œn16
(
row6
, 
row7
);

2567 
	`dù_Œn32
(
row0
, 
row2
);

2568 
	`dù_Œn32
(
row1
, 
row3
);

2569 
	`dù_Œn32
(
row4
, 
row6
);

2570 
	`dù_Œn32
(
row5
, 
row7
);

2573 
	`dù_Œn64
(
row0
, 
row4
);

2574 
	`dù_Œn64
(
row1
, 
row5
);

2575 
	`dù_Œn64
(
row2
, 
row6
);

2576 
	`dù_Œn64
(
row3
, 
row7
);

2578 #undeà
dù_Œn16


2579 #undeà
dù_Œn32


2580 #undeà
dù_Œn64


2587 
	`dù_·ss
(
vshº_n_s32
, 16);

2591 
ušt8x8_t
 
p0
 = 
	`vqrshrun_n_s16
(
row0
, 1);

2592 
ušt8x8_t
 
p1
 = 
	`vqrshrun_n_s16
(
row1
, 1);

2593 
ušt8x8_t
 
p2
 = 
	`vqrshrun_n_s16
(
row2
, 1);

2594 
ušt8x8_t
 
p3
 = 
	`vqrshrun_n_s16
(
row3
, 1);

2595 
ušt8x8_t
 
p4
 = 
	`vqrshrun_n_s16
(
row4
, 1);

2596 
ušt8x8_t
 
p5
 = 
	`vqrshrun_n_s16
(
row5
, 1);

2597 
ušt8x8_t
 
p6
 = 
	`vqrshrun_n_s16
(
row6
, 1);

2598 
ušt8x8_t
 
p7
 = 
	`vqrshrun_n_s16
(
row7
, 1);

2601 
	#dù_Œn8_8
(
x
, 
y
è{ 
ušt8x8x2_t
 
t
 = 
	`vŒn_u8
(x, y); x =.
v®
[0]; y =.v®[1]; }

	)

2602 
	#dù_Œn8_16
(
x
, 
y
è{ 
ušt16x4x2_t
 
t
 = 
	`vŒn_u16
(
	`v»š‹½»t_u16_u8
(x), v»š‹½»t_u16_u8(y)); x = 
	`v»š‹½»t_u8_u16
Ñ.
v®
[0]); y = v»š‹½»t_u8_u16Ñ.v®[1]); }

	)

2603 
	#dù_Œn8_32
(
x
, 
y
è{ 
ušt32x2x2_t
 
t
 = 
	`vŒn_u32
(
	`v»š‹½»t_u32_u8
(x), v»š‹½»t_u32_u8(y)); x = 
	`v»š‹½»t_u8_u32
Ñ.
v®
[0]); y = v»š‹½»t_u8_u32Ñ.v®[1]); }

	)

2609 
	`dù_Œn8_8
(
p0
, 
p1
);

2610 
	`dù_Œn8_8
(
p2
, 
p3
);

2611 
	`dù_Œn8_8
(
p4
, 
p5
);

2612 
	`dù_Œn8_8
(
p6
, 
p7
);

2615 
	`dù_Œn8_16
(
p0
, 
p2
);

2616 
	`dù_Œn8_16
(
p1
, 
p3
);

2617 
	`dù_Œn8_16
(
p4
, 
p6
);

2618 
	`dù_Œn8_16
(
p5
, 
p7
);

2621 
	`dù_Œn8_32
(
p0
, 
p4
);

2622 
	`dù_Œn8_32
(
p1
, 
p5
);

2623 
	`dù_Œn8_32
(
p2
, 
p6
);

2624 
	`dù_Œn8_32
(
p3
, 
p7
);

2627 
	`v¡1_u8
(
out
, 
p0
); ouˆ+ğ
out_¡ride
;

2628 
	`v¡1_u8
(
out
, 
p1
); ouˆ+ğ
out_¡ride
;

2629 
	`v¡1_u8
(
out
, 
p2
); ouˆ+ğ
out_¡ride
;

2630 
	`v¡1_u8
(
out
, 
p3
); ouˆ+ğ
out_¡ride
;

2631 
	`v¡1_u8
(
out
, 
p4
); ouˆ+ğ
out_¡ride
;

2632 
	`v¡1_u8
(
out
, 
p5
); ouˆ+ğ
out_¡ride
;

2633 
	`v¡1_u8
(
out
, 
p6
); ouˆ+ğ
out_¡ride
;

2634 
	`v¡1_u8
(
out
, 
p7
);

2636 #undeà
dù_Œn8_8


2637 #undeà
dù_Œn8_16


2638 #undeà
dù_Œn8_32


2641 #undeà
dù_lÚg_mul


2642 #undeà
dù_lÚg_mac


2643 #undeà
dù_wid’


2644 #undeà
dù_wadd


2645 #undeà
dù_wsub


2646 #undeà
dù_bæy32o


2647 #undeà
dù_·ss


2648 
	}
}

2652 
	#STBI__MARKER_nÚe
 0xff

	)

2656 
¡bi_uc
 
	$¡bi__g‘_m¬k”
(
¡bi__j³g
 *
j
)

2658 
¡bi_uc
 
x
;

2659 ià(
j
->
m¬k”
 !ğ
STBI__MARKER_nÚe
è{ 
x
 = j->marker; j->marker = STBI__MARKER_none;  x; }

2660 
x
 = 
	`¡bi__g‘8
(
j
->
s
);

2661 ià(
x
 !ğ0xffè 
STBI__MARKER_nÚe
;

2662 
x
 == 0xff)

2663 
x
 = 
	`¡bi__g‘8
(
j
->
s
);

2664  
x
;

2665 
	}
}

2669 
	#STBI__RESTART
(
x
è((xè>ğ0xd0 && (xè<ğ0xd7)

	)

2673 
	$¡bi__j³g_»£t
(
¡bi__j³g
 *
j
)

2675 
j
->
code_b™s
 = 0;

2676 
j
->
code_bufãr
 = 0;

2677 
j
->
nomÜe
 = 0;

2678 
j
->
img_comp
[0].
dc_´ed
 = j->img_comp[1].dc_pred = j->img_comp[2].dc_pred = j->img_comp[3].dc_pred = 0;

2679 
j
->
m¬k”
 = 
STBI__MARKER_nÚe
;

2680 
j
->
todo
 = j->
»¡¬t_š‹rv®
 ? j->restart_interval : 0x7fffffff;

2681 
j
->
eob_run
 = 0;

2684 
	}
}

2686 
	$¡bi__·r£_’Œİy_coded_d©a
(
¡bi__j³g
 *
z
)

2688 
	`¡bi__j³g_»£t
(
z
);

2689 ià(!
z
->
´og»ssive
) {

2690 ià(
z
->
sÿn_n
 == 1) {

2691 
i
,
j
;

2692 
	`STBI_SIMD_ALIGN
(, 
d©a
[64]);

2693 
n
 = 
z
->
Üd”
[0];

2698 
w
 = (
z
->
img_comp
[
n
].
x
+7) >> 3;

2699 
h
 = (
z
->
img_comp
[
n
].
y
+7) >> 3;

2700 
j
=0; j < 
h
; ++j) {

2701 
i
=0; i < 
w
; ++i) {

2702 
ha
 = 
z
->
img_comp
[
n
].ha;

2703 ià(!
	`¡bi__j³g_decode_block
(
z
, 
d©a
, z->
huff_dc
+z->
img_comp
[
n
].
hd
, z->
huff_ac
+
ha
, z->
ç¡_ac
[ha],‚, z->
dequªt
[z->img_comp[n].
tq
]))  0;

2704 
z
->
	`idù_block_k”Ãl
(z->
img_comp
[
n
].
d©a
+z->img_comp[n].
w2
*
j
*8+
i
*8, z->img_comp[n].w2, data);

2706 ià(--
z
->
todo
 <= 0) {

2707 ià(
z
->
code_b™s
 < 24è
	`¡bi__grow_bufãr_un§ã
(z);

2710 ià(!
	`STBI__RESTART
(
z
->
m¬k”
))  1;

2711 
	`¡bi__j³g_»£t
(
z
);

2717 
i
,
j
,
k
,
x
,
y
;

2718 
	`STBI_SIMD_ALIGN
(, 
d©a
[64]);

2719 
j
=0; j < 
z
->
img_mcu_y
; ++j) {

2720 
i
=0; i < 
z
->
img_mcu_x
; ++i) {

2722 
k
=0; k < 
z
->
sÿn_n
; ++k) {

2723 
n
 = 
z
->
Üd”
[
k
];

2726 
y
=0; y < 
z
->
img_comp
[
n
].
v
; ++y) {

2727 
x
=0; x < 
z
->
img_comp
[
n
].
h
; ++x) {

2728 
x2
 = (
i
*
z
->
img_comp
[
n
].
h
 + 
x
)*8;

2729 
y2
 = (
j
*
z
->
img_comp
[
n
].
v
 + 
y
)*8;

2730 
ha
 = 
z
->
img_comp
[
n
].ha;

2731 ià(!
	`¡bi__j³g_decode_block
(
z
, 
d©a
, z->
huff_dc
+z->
img_comp
[
n
].
hd
, z->
huff_ac
+
ha
, z->
ç¡_ac
[ha],‚, z->
dequªt
[z->img_comp[n].
tq
]))  0;

2732 
z
->
	`idù_block_k”Ãl
(z->
img_comp
[
n
].
d©a
+z->img_comp[n].
w2
*
y2
+
x2
, z->img_comp[n].w2, data);

2738 ià(--
z
->
todo
 <= 0) {

2739 ià(
z
->
code_b™s
 < 24è
	`¡bi__grow_bufãr_un§ã
(z);

2740 ià(!
	`STBI__RESTART
(
z
->
m¬k”
))  1;

2741 
	`¡bi__j³g_»£t
(
z
);

2748 ià(
z
->
sÿn_n
 == 1) {

2749 
i
,
j
;

2750 
n
 = 
z
->
Üd”
[0];

2755 
w
 = (
z
->
img_comp
[
n
].
x
+7) >> 3;

2756 
h
 = (
z
->
img_comp
[
n
].
y
+7) >> 3;

2757 
j
=0; j < 
h
; ++j) {

2758 
i
=0; i < 
w
; ++i) {

2759 *
d©a
 = 
z
->
img_comp
[
n
].
cÛff
 + 64 * (
i
 + 
j
 * z->img_comp[n].
cÛff_w
);

2760 ià(
z
->
¥ec_¡¬t
 == 0) {

2761 ià(!
	`¡bi__j³g_decode_block_´og_dc
(
z
, 
d©a
, &z->
huff_dc
[z->
img_comp
[
n
].
hd
],‚))

2764 
ha
 = 
z
->
img_comp
[
n
].ha;

2765 ià(!
	`¡bi__j³g_decode_block_´og_ac
(
z
, 
d©a
, &z->
huff_ac
[
ha
], z->
ç¡_ac
[ha]))

2769 ià(--
z
->
todo
 <= 0) {

2770 ià(
z
->
code_b™s
 < 24è
	`¡bi__grow_bufãr_un§ã
(z);

2771 ià(!
	`STBI__RESTART
(
z
->
m¬k”
))  1;

2772 
	`¡bi__j³g_»£t
(
z
);

2778 
i
,
j
,
k
,
x
,
y
;

2779 
j
=0; j < 
z
->
img_mcu_y
; ++j) {

2780 
i
=0; i < 
z
->
img_mcu_x
; ++i) {

2782 
k
=0; k < 
z
->
sÿn_n
; ++k) {

2783 
n
 = 
z
->
Üd”
[
k
];

2786 
y
=0; y < 
z
->
img_comp
[
n
].
v
; ++y) {

2787 
x
=0; x < 
z
->
img_comp
[
n
].
h
; ++x) {

2788 
x2
 = (
i
*
z
->
img_comp
[
n
].
h
 + 
x
);

2789 
y2
 = (
j
*
z
->
img_comp
[
n
].
v
 + 
y
);

2790 *
d©a
 = 
z
->
img_comp
[
n
].
cÛff
 + 64 * (
x2
 + 
y2
 * z->img_comp[n].
cÛff_w
);

2791 ià(!
	`¡bi__j³g_decode_block_´og_dc
(
z
, 
d©a
, &z->
huff_dc
[z->
img_comp
[
n
].
hd
],‚))

2798 ià(--
z
->
todo
 <= 0) {

2799 ià(
z
->
code_b™s
 < 24è
	`¡bi__grow_bufãr_un§ã
(z);

2800 ià(!
	`STBI__RESTART
(
z
->
m¬k”
))  1;

2801 
	`¡bi__j³g_»£t
(
z
);

2808 
	}
}

2810 
	$¡bi__j³g_dequªtize
(*
d©a
, 
¡bi__ušt16
 *
dequªt
)

2812 
i
;

2813 
i
=0; i < 64; ++i)

2814 
d©a
[
i
] *ğ
dequªt
[i];

2815 
	}
}

2817 
	$¡bi__j³g_fšish
(
¡bi__j³g
 *
z
)

2819 ià(
z
->
´og»ssive
) {

2821 
i
,
j
,
n
;

2822 
n
=0;‚ < 
z
->
s
->
img_n
; ++n) {

2823 
w
 = (
z
->
img_comp
[
n
].
x
+7) >> 3;

2824 
h
 = (
z
->
img_comp
[
n
].
y
+7) >> 3;

2825 
j
=0; j < 
h
; ++j) {

2826 
i
=0; i < 
w
; ++i) {

2827 *
d©a
 = 
z
->
img_comp
[
n
].
cÛff
 + 64 * (
i
 + 
j
 * z->img_comp[n].
cÛff_w
);

2828 
	`¡bi__j³g_dequªtize
(
d©a
, 
z
->
dequªt
[z->
img_comp
[
n
].
tq
]);

2829 
z
->
	`idù_block_k”Ãl
(z->
img_comp
[
n
].
d©a
+z->img_comp[n].
w2
*
j
*8+
i
*8, z->img_comp[n].w2, data);

2834 
	}
}

2836 
	$¡bi__´oûss_m¬k”
(
¡bi__j³g
 *
z
, 
m
)

2838 
L
;

2839 
m
) {

2840 
STBI__MARKER_nÚe
:

2841  
	`¡bi__”r
("expected marker","Corrupt JPEG");

2844 ià(
	`¡bi__g‘16be
(
z
->
s
è!ğ4è 
	`¡bi__”r
("bad DRI†en","Corrupt JPEG");

2845 
z
->
»¡¬t_š‹rv®
 = 
	`¡bi__g‘16be
(z->
s
);

2849 
L
 = 
	`¡bi__g‘16be
(
z
->
s
)-2;

2850 
L
 > 0) {

2851 
q
 = 
	`¡bi__g‘8
(
z
->
s
);

2852 
p
 = 
q
 >> 4, 
six‹’
 = (p != 0);

2853 
t
 = 
q
 & 15,
i
;

2854 ià(
p
 !ğ0 &&… !ğ1è 
	`¡bi__”r
("bad DQType","Corrupt JPEG");

2855 ià(
t
 > 3è 
	`¡bi__”r
("bad DQTable","Corrupt JPEG");

2857 
i
=0; i < 64; ++i)

2858 
z
->
dequªt
[
t
][
¡bi__j³g_dezigzag
[
i
]] = (
¡bi__ušt16
)(
six‹’
 ? 
	`¡bi__g‘16be
(z->
s
è: 
	`¡bi__g‘8
(z->s));

2859 
L
 -ğ(
six‹’
 ? 129 : 65);

2861  
L
==0;

2864 
L
 = 
	`¡bi__g‘16be
(
z
->
s
)-2;

2865 
L
 > 0) {

2866 
¡bi_uc
 *
v
;

2867 
sizes
[16],
i
,
n
=0;

2868 
q
 = 
	`¡bi__g‘8
(
z
->
s
);

2869 
tc
 = 
q
 >> 4;

2870 
th
 = 
q
 & 15;

2871 ià(
tc
 > 1 || 
th
 > 3è 
	`¡bi__”r
("bad DHT header","Corrupt JPEG");

2872 
i
=0; i < 16; ++i) {

2873 
sizes
[
i
] = 
	`¡bi__g‘8
(
z
->
s
);

2874 
n
 +ğ
sizes
[
i
];

2876 
L
 -= 17;

2877 ià(
tc
 == 0) {

2878 ià(!
	`¡bi__bud_huffmª
(
z
->
huff_dc
+
th
, 
sizes
))  0;

2879 
v
 = 
z
->
huff_dc
[
th
].
v®ues
;

2881 ià(!
	`¡bi__bud_huffmª
(
z
->
huff_ac
+
th
, 
sizes
))  0;

2882 
v
 = 
z
->
huff_ac
[
th
].
v®ues
;

2884 
i
=0; i < 
n
; ++i)

2885 
v
[
i
] = 
	`¡bi__g‘8
(
z
->
s
);

2886 ià(
tc
 != 0)

2887 
	`¡bi__bud_ç¡_ac
(
z
->
ç¡_ac
[
th
], z->
huff_ac
 +h);

2888 
L
 -ğ
n
;

2890  
L
==0;

2894 ià((
m
 >= 0xE0 && m <= 0xEF) || m == 0xFE) {

2895 
L
 = 
	`¡bi__g‘16be
(
z
->
s
);

2896 ià(
L
 < 2) {

2897 ià(
m
 == 0xFE)

2898  
	`¡bi__”r
("bad COM†en","Corrupt JPEG");

2900  
	`¡bi__”r
("bad APP†en","Corrupt JPEG");

2902 
L
 -= 2;

2904 ià(
m
 =ğ0xE0 && 
L
 >= 5) {

2905 cÚ¡ 
g
[5] = {'J','F','I','F','\0'};

2906 
ok
 = 1;

2907 
i
;

2908 
i
=0; i < 5; ++i)

2909 ià(
	`¡bi__g‘8
(
z
->
s
è!ğ
g
[
i
])

2910 
ok
 = 0;

2911 
L
 -= 5;

2912 ià(
ok
)

2913 
z
->
jfif
 = 1;

2914 } ià(
m
 =ğ0xEE && 
L
 >= 12) {

2915 cÚ¡ 
g
[6] = {'A','d','o','b','e','\0'};

2916 
ok
 = 1;

2917 
i
;

2918 
i
=0; i < 6; ++i)

2919 ià(
	`¡bi__g‘8
(
z
->
s
è!ğ
g
[
i
])

2920 
ok
 = 0;

2921 
L
 -= 6;

2922 ià(
ok
) {

2923 
	`¡bi__g‘8
(
z
->
s
);

2924 
	`¡bi__g‘16be
(
z
->
s
);

2925 
	`¡bi__g‘16be
(
z
->
s
);

2926 
z
->
­p14_cŞÜ_ŒªsfÜm
 = 
	`¡bi__g‘8
(z->
s
);

2927 
L
 -= 6;

2931 
	`¡bi__sk
(
z
->
s
, 
L
);

2935  
	`¡bi__”r
("unknown marker","Corrupt JPEG");

2936 
	}
}

2939 
	$¡bi__´oûss_sÿn_h—d”
(
¡bi__j³g
 *
z
)

2941 
i
;

2942 
Ls
 = 
	`¡bi__g‘16be
(
z
->
s
);

2943 
z
->
sÿn_n
 = 
	`¡bi__g‘8
(z->
s
);

2944 ià(
z
->
sÿn_n
 < 1 || z->sÿn_À> 4 || z->sÿn_À> (èz->
s
->
img_n
è 
	`¡bi__”r
("bad SOS component count","Corrupt JPEG");

2945 ià(
Ls
 !ğ6+2*
z
->
sÿn_n
è 
	`¡bi__”r
("bad SOS†en","Corrupt JPEG");

2946 
i
=0; i < 
z
->
sÿn_n
; ++i) {

2947 
id
 = 
	`¡bi__g‘8
(
z
->
s
), 
which
;

2948 
q
 = 
	`¡bi__g‘8
(
z
->
s
);

2949 
which
 = 0; which < 
z
->
s
->
img_n
; ++which)

2950 ià(
z
->
img_comp
[
which
].
id
 == id)

2952 ià(
which
 =ğ
z
->
s
->
img_n
)  0;

2953 
z
->
img_comp
[
which
].
hd
 = 
q
 >> 4; ià(z->img_comp[which].hd > 3è 
	`¡bi__”r
("bad DC huff","Corrupt JPEG");

2954 
z
->
img_comp
[
which
].
ha
 = 
q
 & 15; ià(z->img_comp[which].h¨> 3è 
	`¡bi__”r
("bad AC huff","Corrupt JPEG");

2955 
z
->
Üd”
[
i
] = 
which
;

2959 
¯
;

2960 
z
->
¥ec_¡¬t
 = 
	`¡bi__g‘8
(z->
s
);

2961 
z
->
¥ec_’d
 = 
	`¡bi__g‘8
(z->
s
);

2962 
¯
 = 
	`¡bi__g‘8
(
z
->
s
);

2963 
z
->
succ_high
 = (
¯
 >> 4);

2964 
z
->
succ_low
 = (
¯
 & 15);

2965 ià(
z
->
´og»ssive
) {

2966 ià(
z
->
¥ec_¡¬t
 > 63 || z->
¥ec_’d
 > 63 || z->¥ec_¡¬ˆ> z->¥ec_’d || z->
succ_high
 > 13 || z->
succ_low
 > 13)

2967  
	`¡bi__”r
("bad SOS", "Corrupt JPEG");

2969 ià(
z
->
¥ec_¡¬t
 !ğ0è 
	`¡bi__”r
("bad SOS","Corrupt JPEG");

2970 ià(
z
->
succ_high
 !ğ0 || z->
succ_low
 !ğ0è 
	`¡bi__”r
("bad SOS","Corrupt JPEG");

2971 
z
->
¥ec_’d
 = 63;

2976 
	}
}

2978 
	$¡bi__ä“_j³g_compÚ’ts
(
¡bi__j³g
 *
z
, 
ncomp
, 
why
)

2980 
i
;

2981 
i
=0; i < 
ncomp
; ++i) {

2982 ià(
z
->
img_comp
[
i
].
¿w_d©a
) {

2983 
	`STBI_FREE
(
z
->
img_comp
[
i
].
¿w_d©a
);

2984 
z
->
img_comp
[
i
].
¿w_d©a
 = 
NULL
;

2985 
z
->
img_comp
[
i
].
d©a
 = 
NULL
;

2987 ià(
z
->
img_comp
[
i
].
¿w_cÛff
) {

2988 
	`STBI_FREE
(
z
->
img_comp
[
i
].
¿w_cÛff
);

2989 
z
->
img_comp
[
i
].
¿w_cÛff
 = 0;

2990 
z
->
img_comp
[
i
].
cÛff
 = 0;

2992 ià(
z
->
img_comp
[
i
].
lšebuf
) {

2993 
	`STBI_FREE
(
z
->
img_comp
[
i
].
lšebuf
);

2994 
z
->
img_comp
[
i
].
lšebuf
 = 
NULL
;

2997  
why
;

2998 
	}
}

3000 
	$¡bi__´oûss_äame_h—d”
(
¡bi__j³g
 *
z
, 
sÿn
)

3002 
¡bi__cÚ‹xt
 *
s
 = 
z
->s;

3003 
Lf
,
p
,
i
,
q
, 
h_max
=1,
v_max
=1,
c
;

3004 
Lf
 = 
	`¡bi__g‘16be
(
s
); ià(Là< 11è 
	`¡bi__”r
("bad SOF†en","Corrupt JPEG");

3005 
p
 = 
	`¡bi__g‘8
(
s
); iàÕ !ğ8è 
	`¡bi__”r
("only 8-bit","JPEG format‚ot supported: 8-bit only");

3006 
s
->
img_y
 = 
	`¡bi__g‘16be
(s); ià(s->img_y =ğ0è 
	`¡bi__”r
("no header height", "JPEG format‚ot supported: delayed height");

3007 
s
->
img_x
 = 
	`¡bi__g‘16be
(s); ià(s->img_x =ğ0è 
	`¡bi__”r
("0 width","Corrupt JPEG");

3008 
c
 = 
	`¡bi__g‘8
(
s
);

3009 ià(
c
 !ğ3 && c !ğ1 && c !ğ4è 
	`¡bi__”r
("bad component count","Corrupt JPEG");

3010 
s
->
img_n
 = 
c
;

3011 
i
=0; i < 
c
; ++i) {

3012 
z
->
img_comp
[
i
].
d©a
 = 
NULL
;

3013 
z
->
img_comp
[
i
].
lšebuf
 = 
NULL
;

3016 ià(
Lf
 !ğ8+3*
s
->
img_n
è 
	`¡bi__”r
("bad SOF†en","Corrupt JPEG");

3018 
z
->
rgb
 = 0;

3019 
i
=0; i < 
s
->
img_n
; ++i) {

3020 cÚ¡ 
rgb
[3] = { 'R', 'G', 'B' };

3021 
z
->
img_comp
[
i
].
id
 = 
	`¡bi__g‘8
(
s
);

3022 ià(
s
->
img_n
 =ğ3 && 
z
->
img_comp
[
i
].
id
 =ğ
rgb
[i])

3023 ++
z
->
rgb
;

3024 
q
 = 
	`¡bi__g‘8
(
s
);

3025 
z
->
img_comp
[
i
].
h
 = (
q
 >> 4); ià(!z->img_comp[i].h || z->img_comp[i].h > 4è 
	`¡bi__”r
("bad H","Corrupt JPEG");

3026 
z
->
img_comp
[
i
].
v
 = 
q
 & 15; ià(!z->img_comp[i].v || z->img_comp[i].v > 4è 
	`¡bi__”r
("bad V","Corrupt JPEG");

3027 
z
->
img_comp
[
i
].
tq
 = 
	`¡bi__g‘8
(
s
); ià(z->img_comp[i].tq > 3è 
	`¡bi__”r
("bad TQ","Corrupt JPEG");

3030 ià(
sÿn
 !ğ
STBI__SCAN_lßd
)  1;

3032 ià(!
	`¡bi__mad3sizes_v®id
(
s
->
img_x
, s->
img_y
, s->
img_n
, 0)è 
	`¡bi__”r
("too†arge", "Imageoo†argeo decode");

3034 
i
=0; i < 
s
->
img_n
; ++i) {

3035 ià(
z
->
img_comp
[
i
].
h
 > 
h_max
) h_max = z->img_comp[i].h;

3036 ià(
z
->
img_comp
[
i
].
v
 > 
v_max
) v_max = z->img_comp[i].v;

3040 
z
->
img_h_max
 = 
h_max
;

3041 
z
->
img_v_max
 = 
v_max
;

3042 
z
->
img_mcu_w
 = 
h_max
 * 8;

3043 
z
->
img_mcu_h
 = 
v_max
 * 8;

3045 
z
->
img_mcu_x
 = (
s
->
img_x
 + z->
img_mcu_w
-1) / z->img_mcu_w;

3046 
z
->
img_mcu_y
 = (
s
->
img_y
 + z->
img_mcu_h
-1) / z->img_mcu_h;

3048 
i
=0; i < 
s
->
img_n
; ++i) {

3050 
z
->
img_comp
[
i
].
x
 = (
s
->
img_x
 * z->img_comp[i].
h
 + 
h_max
-1) / h_max;

3051 
z
->
img_comp
[
i
].
y
 = (
s
->
img_y
 * z->img_comp[i].
v
 + 
v_max
-1) / v_max;

3059 
z
->
img_comp
[
i
].
w2
 = z->
img_mcu_x
 * z->img_comp[i].
h
 * 8;

3060 
z
->
img_comp
[
i
].
h2
 = z->
img_mcu_y
 * z->img_comp[i].
v
 * 8;

3061 
z
->
img_comp
[
i
].
cÛff
 = 0;

3062 
z
->
img_comp
[
i
].
¿w_cÛff
 = 0;

3063 
z
->
img_comp
[
i
].
lšebuf
 = 
NULL
;

3064 
z
->
img_comp
[
i
].
¿w_d©a
 = 
	`¡bi__m®loc_mad2
(z->img_comp[i].
w2
, z->img_comp[i].
h2
, 15);

3065 ià(
z
->
img_comp
[
i
].
¿w_d©a
 =ğ
NULL
)

3066  
	`¡bi__ä“_j³g_compÚ’ts
(
z
, 
i
+1, 
	`¡bi__”r
("outofmem", "Out of memory"));

3068 
z
->
img_comp
[
i
].
d©a
 = (
¡bi_uc
*è(((
size_t
èz->img_comp[i].
¿w_d©a
 + 15) & ~15);

3069 ià(
z
->
´og»ssive
) {

3071 
z
->
img_comp
[
i
].
cÛff_w
 = z->img_comp[i].
w2
 / 8;

3072 
z
->
img_comp
[
i
].
cÛff_h
 = z->img_comp[i].
h2
 / 8;

3073 
z
->
img_comp
[
i
].
¿w_cÛff
 = 
	`¡bi__m®loc_mad3
(z->img_comp[i].
w2
, z->img_comp[i].
h2
, (), 15);

3074 ià(
z
->
img_comp
[
i
].
¿w_cÛff
 =ğ
NULL
)

3075  
	`¡bi__ä“_j³g_compÚ’ts
(
z
, 
i
+1, 
	`¡bi__”r
("outofmem", "Out of memory"));

3076 
z
->
img_comp
[
i
].
cÛff
 = (*è(((
size_t
èz->img_comp[i].
¿w_cÛff
 + 15) & ~15);

3081 
	}
}

3084 
	#¡bi__DNL
(
x
è((xè=ğ0xdc)

	)

3085 
	#¡bi__SOI
(
x
è((xè=ğ0xd8)

	)

3086 
	#¡bi__EOI
(
x
è((xè=ğ0xd9)

	)

3087 
	#¡bi__SOF
(
x
è((xè=ğ0xc0 || (xè=ğ0xc1 || (xè=ğ0xc2)

	)

3088 
	#¡bi__SOS
(
x
è((xè=ğ0xda)

	)

3090 
	#¡bi__SOF_´og»ssive
(
x
è((xè=ğ0xc2)

	)

3092 
	$¡bi__decode_j³g_h—d”
(
¡bi__j³g
 *
z
, 
sÿn
)

3094 
m
;

3095 
z
->
jfif
 = 0;

3096 
z
->
­p14_cŞÜ_ŒªsfÜm
 = -1;

3097 
z
->
m¬k”
 = 
STBI__MARKER_nÚe
;

3098 
m
 = 
	`¡bi__g‘_m¬k”
(
z
);

3099 ià(!
	`¡bi__SOI
(
m
)è 
	`¡bi__”r
("no SOI","Corrupt JPEG");

3100 ià(
sÿn
 =ğ
STBI__SCAN_ty³
)  1;

3101 
m
 = 
	`¡bi__g‘_m¬k”
(
z
);

3102 !
	`¡bi__SOF
(
m
)) {

3103 ià(!
	`¡bi__´oûss_m¬k”
(
z
,
m
))  0;

3104 
m
 = 
	`¡bi__g‘_m¬k”
(
z
);

3105 
m
 =ğ
STBI__MARKER_nÚe
) {

3107 ià(
	`¡bi__©_eof
(
z
->
s
)è 
	`¡bi__”r
("no SOF", "Corrupt JPEG");

3108 
m
 = 
	`¡bi__g‘_m¬k”
(
z
);

3111 
z
->
´og»ssive
 = 
	`¡bi__SOF_´og»ssive
(
m
);

3112 ià(!
	`¡bi__´oûss_äame_h—d”
(
z
, 
sÿn
))  0;

3114 
	}
}

3117 
	$¡bi__decode_j³g_image
(
¡bi__j³g
 *
j
)

3119 
m
;

3120 
m
 = 0; m < 4; m++) {

3121 
j
->
img_comp
[
m
].
¿w_d©a
 = 
NULL
;

3122 
j
->
img_comp
[
m
].
¿w_cÛff
 = 
NULL
;

3124 
j
->
»¡¬t_š‹rv®
 = 0;

3125 ià(!
	`¡bi__decode_j³g_h—d”
(
j
, 
STBI__SCAN_lßd
))  0;

3126 
m
 = 
	`¡bi__g‘_m¬k”
(
j
);

3127 !
	`¡bi__EOI
(
m
)) {

3128 ià(
	`¡bi__SOS
(
m
)) {

3129 ià(!
	`¡bi__´oûss_sÿn_h—d”
(
j
))  0;

3130 ià(!
	`¡bi__·r£_’Œİy_coded_d©a
(
j
))  0;

3131 ià(
j
->
m¬k”
 =ğ
STBI__MARKER_nÚe
 ) {

3133 !
	`¡bi__©_eof
(
j
->
s
)) {

3134 
x
 = 
	`¡bi__g‘8
(
j
->
s
);

3135 ià(
x
 == 255) {

3136 
j
->
m¬k”
 = 
	`¡bi__g‘8
(j->
s
);

3142 } ià(
	`¡bi__DNL
(
m
)) {

3143 
Ld
 = 
	`¡bi__g‘16be
(
j
->
s
);

3144 
¡bi__ušt32
 
NL
 = 
	`¡bi__g‘16be
(
j
->
s
);

3145 ià(
Ld
 !ğ4è 
	`¡bi__”r
("bad DNL†en", "Corrupt JPEG");

3146 ià(
NL
 !ğ
j
->
s
->
img_y
è 
	`¡bi__”r
("bad DNL height", "Corrupt JPEG");

3148 ià(!
	`¡bi__´oûss_m¬k”
(
j
, 
m
))  0;

3150 
m
 = 
	`¡bi__g‘_m¬k”
(
j
);

3152 ià(
j
->
´og»ssive
)

3153 
	`¡bi__j³g_fšish
(
j
);

3155 
	}
}

3159 
	g¡bi_uc
 *(*
	t»§m¶e_row_func
)(
	t¡bi_uc
 *
	tout
, stbi_uø*
	tš0
, stbi_uø*
	tš1
,

3160 
	tw
, 
	ths
);

3162 
	#¡bi__div4
(
x
è((
¡bi_uc
è((xè>> 2))

	)

3164 
¡bi_uc
 *
	$»§m¶e_row_1
(
¡bi_uc
 *
out
, stbi_uø*
š_Ã¬
, stbi_uø*
š_çr
, 
w
, 
hs
)

3166 
	`STBI_NOTUSED
(
out
);

3167 
	`STBI_NOTUSED
(
š_çr
);

3168 
	`STBI_NOTUSED
(
w
);

3169 
	`STBI_NOTUSED
(
hs
);

3170  
š_Ã¬
;

3171 
	}
}

3173 
¡bi_uc
* 
	$¡bi__»§m¶e_row_v_2
(
¡bi_uc
 *
out
, stbi_uø*
š_Ã¬
, stbi_uø*
š_çr
, 
w
, 
hs
)

3176 
i
;

3177 
	`STBI_NOTUSED
(
hs
);

3178 
i
=0; i < 
w
; ++i)

3179 
out
[
i
] = 
	`¡bi__div4
(3*
š_Ã¬
[i] + 
š_çr
[i] + 2);

3180  
out
;

3181 
	}
}

3183 
¡bi_uc
* 
	$¡bi__»§m¶e_row_h_2
(
¡bi_uc
 *
out
, stbi_uø*
š_Ã¬
, stbi_uø*
š_çr
, 
w
, 
hs
)

3186 
i
;

3187 
¡bi_uc
 *
šput
 = 
š_Ã¬
;

3189 ià(
w
 == 1) {

3191 
out
[0] = out[1] = 
šput
[0];

3192  
out
;

3195 
out
[0] = 
šput
[0];

3196 
out
[1] = 
	`¡bi__div4
(
šput
[0]*3 + input[1] + 2);

3197 
i
=1; i < 
w
-1; ++i) {

3198 
n
 = 3*
šput
[
i
]+2;

3199 
out
[
i
*2+0] = 
	`¡bi__div4
(
n
+
šput
[i-1]);

3200 
out
[
i
*2+1] = 
	`¡bi__div4
(
n
+
šput
[i+1]);

3202 
out
[
i
*2+0] = 
	`¡bi__div4
(
šput
[
w
-2]*3 + input[w-1] + 2);

3203 
out
[
i
*2+1] = 
šput
[
w
-1];

3205 
	`STBI_NOTUSED
(
š_çr
);

3206 
	`STBI_NOTUSED
(
hs
);

3208  
out
;

3209 
	}
}

3211 
	#¡bi__div16
(
x
è((
¡bi_uc
è((xè>> 4))

	)

3213 
¡bi_uc
 *
	$¡bi__»§m¶e_row_hv_2
(
¡bi_uc
 *
out
, stbi_uø*
š_Ã¬
, stbi_uø*
š_çr
, 
w
, 
hs
)

3216 
i
,
t0
,
t1
;

3217 ià(
w
 == 1) {

3218 
out
[0] = out[1] = 
	`¡bi__div4
(3*
š_Ã¬
[0] + 
š_çr
[0] + 2);

3219  
out
;

3222 
t1
 = 3*
š_Ã¬
[0] + 
š_çr
[0];

3223 
out
[0] = 
	`¡bi__div4
(
t1
+2);

3224 
i
=1; i < 
w
; ++i) {

3225 
t0
 = 
t1
;

3226 
t1
 = 3*
š_Ã¬
[
i
]+
š_çr
[i];

3227 
out
[
i
*2-1] = 
	`¡bi__div16
(3*
t0
 + 
t1
 + 8);

3228 
out
[
i
*2 ] = 
	`¡bi__div16
(3*
t1
 + 
t0
 + 8);

3230 
out
[
w
*2-1] = 
	`¡bi__div4
(
t1
+2);

3232 
	`STBI_NOTUSED
(
hs
);

3234  
out
;

3235 
	}
}

3237 #ià
defšed
(
STBI_SSE2
è|| defšed(
STBI_NEON
)

3238 
¡bi_uc
 *
	$¡bi__»§m¶e_row_hv_2_simd
(
¡bi_uc
 *
out
, stbi_uø*
š_Ã¬
, stbi_uø*
š_çr
, 
w
, 
hs
)

3241 
i
=0,
t0
,
t1
;

3243 ià(
w
 == 1) {

3244 
out
[0] = out[1] = 
	`¡bi__div4
(3*
š_Ã¬
[0] + 
š_çr
[0] + 2);

3245  
out
;

3248 
t1
 = 3*
š_Ã¬
[0] + 
š_çr
[0];

3252 ; 
i
 < ((
w
-1) & ~7); i += 8) {

3253 #ià
	`defšed
(
STBI_SSE2
)

3256 
__m128i
 
z”o
 = 
	`_mm_£tz”o_si128
();

3257 
__m128i
 
çrb
 = 
	`_mm_lßdl_•i64
((__m128˜*è(
š_çr
 + 
i
));

3258 
__m128i
 
Ã¬b
 = 
	`_mm_lßdl_•i64
((__m128˜*è(
š_Ã¬
 + 
i
));

3259 
__m128i
 
çrw
 = 
	`_mm_uÅacklo_•i8
(
çrb
, 
z”o
);

3260 
__m128i
 
Ã¬w
 = 
	`_mm_uÅacklo_•i8
(
Ã¬b
, 
z”o
);

3261 
__m128i
 
diff
 = 
	`_mm_sub_•i16
(
çrw
, 
Ã¬w
);

3262 
__m128i
 
Ã¬s
 = 
	`_mm_¦li_•i16
(
Ã¬w
, 2);

3263 
__m128i
 
cu¼
 = 
	`_mm_add_•i16
(
Ã¬s
, 
diff
);

3270 
__m128i
 
´v0
 = 
	`_mm_¦li_si128
(
cu¼
, 2);

3271 
__m128i
 
nxt0
 = 
	`_mm_¤li_si128
(
cu¼
, 2);

3272 
__m128i
 
´ev
 = 
	`_mm_š£¹_•i16
(
´v0
, 
t1
, 0);

3273 
__m128i
 
Ãxt
 = 
	`_mm_š£¹_•i16
(
nxt0
, 3*
š_Ã¬
[
i
+8] + 
š_çr
[i+8], 7);

3279 
__m128i
 
bŸs
 = 
	`_mm_£t1_•i16
(8);

3280 
__m128i
 
curs
 = 
	`_mm_¦li_•i16
(
cu¼
, 2);

3281 
__m128i
 
´vd
 = 
	`_mm_sub_•i16
(
´ev
, 
cu¼
);

3282 
__m128i
 
nxtd
 = 
	`_mm_sub_•i16
(
Ãxt
, 
cu¼
);

3283 
__m128i
 
curb
 = 
	`_mm_add_•i16
(
curs
, 
bŸs
);

3284 
__m128i
 
ev’
 = 
	`_mm_add_•i16
(
´vd
, 
curb
);

3285 
__m128i
 
odd
 = 
	`_mm_add_•i16
(
nxtd
, 
curb
);

3288 
__m128i
 
št0
 = 
	`_mm_uÅacklo_•i16
(
ev’
, 
odd
);

3289 
__m128i
 
št1
 = 
	`_mm_uÅackhi_•i16
(
ev’
, 
odd
);

3290 
__m128i
 
de0
 = 
	`_mm_¤li_•i16
(
št0
, 4);

3291 
__m128i
 
de1
 = 
	`_mm_¤li_•i16
(
št1
, 4);

3294 
__m128i
 
outv
 = 
	`_mm_·ckus_•i16
(
de0
, 
de1
);

3295 
	`_mm_¡Üeu_si128
((
__m128i
 *è(
out
 + 
i
*2), 
outv
);

3296 #–ià
	`defšed
(
STBI_NEON
)

3299 
ušt8x8_t
 
çrb
 = 
	`vld1_u8
(
š_çr
 + 
i
);

3300 
ušt8x8_t
 
Ã¬b
 = 
	`vld1_u8
(
š_Ã¬
 + 
i
);

3301 
št16x8_t
 
diff
 = 
	`v»š‹½»tq_s16_u16
(
	`vsubl_u8
(
çrb
, 
Ã¬b
));

3302 
št16x8_t
 
Ã¬s
 = 
	`v»š‹½»tq_s16_u16
(
	`vshÎ_n_u8
(
Ã¬b
, 2));

3303 
št16x8_t
 
cu¼
 = 
	`vaddq_s16
(
Ã¬s
, 
diff
);

3310 
št16x8_t
 
´v0
 = 
	`vextq_s16
(
cu¼
, curr, 7);

3311 
št16x8_t
 
nxt0
 = 
	`vextq_s16
(
cu¼
, curr, 1);

3312 
št16x8_t
 
´ev
 = 
	`v£tq_ÏÃ_s16
(
t1
, 
´v0
, 0);

3313 
št16x8_t
 
Ãxt
 = 
	`v£tq_ÏÃ_s16
(3*
š_Ã¬
[
i
+8] + 
š_çr
[i+8], 
nxt0
, 7);

3319 
št16x8_t
 
curs
 = 
	`vshlq_n_s16
(
cu¼
, 2);

3320 
št16x8_t
 
´vd
 = 
	`vsubq_s16
(
´ev
, 
cu¼
);

3321 
št16x8_t
 
nxtd
 = 
	`vsubq_s16
(
Ãxt
, 
cu¼
);

3322 
št16x8_t
 
ev’
 = 
	`vaddq_s16
(
curs
, 
´vd
);

3323 
št16x8_t
 
odd
 = 
	`vaddq_s16
(
curs
, 
nxtd
);

3326 
ušt8x8x2_t
 
o
;

3327 
o
.
v®
[0] = 
	`vqrshrun_n_s16
(
ev’
, 4);

3328 
o
.
v®
[1] = 
	`vqrshrun_n_s16
(
odd
, 4);

3329 
	`v¡2_u8
(
out
 + 
i
*2, 
o
);

3333 
t1
 = 3*
š_Ã¬
[
i
+7] + 
š_çr
[i+7];

3336 
t0
 = 
t1
;

3337 
t1
 = 3*
š_Ã¬
[
i
] + 
š_çr
[i];

3338 
out
[
i
*2] = 
	`¡bi__div16
(3*
t1
 + 
t0
 + 8);

3340 ++
i
; i < 
w
; ++i) {

3341 
t0
 = 
t1
;

3342 
t1
 = 3*
š_Ã¬
[
i
]+
š_çr
[i];

3343 
out
[
i
*2-1] = 
	`¡bi__div16
(3*
t0
 + 
t1
 + 8);

3344 
out
[
i
*2 ] = 
	`¡bi__div16
(3*
t1
 + 
t0
 + 8);

3346 
out
[
w
*2-1] = 
	`¡bi__div4
(
t1
+2);

3348 
	`STBI_NOTUSED
(
hs
);

3350  
out
;

3351 
	}
}

3354 
¡bi_uc
 *
	$¡bi__»§m¶e_row_g’”ic
(
¡bi_uc
 *
out
, stbi_uø*
š_Ã¬
, stbi_uø*
š_çr
, 
w
, 
hs
)

3357 
i
,
j
;

3358 
	`STBI_NOTUSED
(
š_çr
);

3359 
i
=0; i < 
w
; ++i)

3360 
j
=0; j < 
hs
; ++j)

3361 
out
[
i
*
hs
+
j
] = 
š_Ã¬
[i];

3362  
out
;

3363 
	}
}

3367 
	#¡bi__æßt2fixed
(
x
è(((è((xè* 4096.0à+ 0.5f)è<< 8)

	)

3368 
	$¡bi__YCbCr_to_RGB_row
(
¡bi_uc
 *
out
, cÚ¡ stbi_uø*
y
, cÚ¡ stbi_uø*
pcb
, cÚ¡ stbi_uø*
pü
, 
couÁ
, 
¡•
)

3370 
i
;

3371 
i
=0; i < 
couÁ
; ++i) {

3372 
y_fixed
 = (
y
[
i
] << 20) + (1<<19);

3373 
r
,
g
,
b
;

3374 
ü
 = 
pü
[
i
] - 128;

3375 
cb
 = 
pcb
[
i
] - 128;

3376 
r
 = 
y_fixed
 + 
ü
* 
	`¡bi__æßt2fixed
(1.40200f);

3377 
g
 = 
y_fixed
 + (
ü
*-
	`¡bi__æßt2fixed
(0.71414f)è+ ((
cb
*-stbi__float2fixed(0.34414f)) & 0xffff0000);

3378 
b
 = 
y_fixed
 + 
cb
* 
	`¡bi__æßt2fixed
(1.77200f);

3379 
r
 >>= 20;

3380 
g
 >>= 20;

3381 
b
 >>= 20;

3382 ià((è
r
 > 255) { if (r < 0)„ = 0; r = 255; }

3383 ià((è
g
 > 255) { if (g < 0) g = 0; g = 255; }

3384 ià((è
b
 > 255) { if (b < 0) b = 0; b = 255; }

3385 
out
[0] = (
¡bi_uc
)
r
;

3386 
out
[1] = (
¡bi_uc
)
g
;

3387 
out
[2] = (
¡bi_uc
)
b
;

3388 
out
[3] = 255;

3389 
out
 +ğ
¡•
;

3391 
	}
}

3393 #ià
defšed
(
STBI_SSE2
è|| defšed(
STBI_NEON
)

3394 
	$¡bi__YCbCr_to_RGB_simd
(
¡bi_uc
 *
out
, stbi_uøcÚ¡ *
y
, stbi_uøcÚ¡ *
pcb
, stbi_uøcÚ¡ *
pü
, 
couÁ
, 
¡•
)

3396 
i
 = 0;

3398 #ifdeà
STBI_SSE2


3402 ià(
¡•
 == 4) {

3404 
__m128i
 
signæ
 = 
	`_mm_£t1_•i8
(-0x80);

3405 
__m128i
 
ü_cÚ¡0
 = 
	`_mm_£t1_•i16
( () ( 1.40200f*4096.0f+0.5f));

3406 
__m128i
 
ü_cÚ¡1
 = 
	`_mm_£t1_•i16
( - () ( 0.71414f*4096.0f+0.5f));

3407 
__m128i
 
cb_cÚ¡0
 = 
	`_mm_£t1_•i16
( - () ( 0.34414f*4096.0f+0.5f));

3408 
__m128i
 
cb_cÚ¡1
 = 
	`_mm_£t1_•i16
( () ( 1.77200f*4096.0f+0.5f));

3409 
__m128i
 
y_bŸs
 = 
	`_mm_£t1_•i8
(() () 128);

3410 
__m128i
 
xw
 = 
	`_mm_£t1_•i16
(255);

3412 ; 
i
+7 < 
couÁ
; i += 8) {

3414 
__m128i
 
y_by‹s
 = 
	`_mm_lßdl_•i64
((__m128˜*è(
y
+
i
));

3415 
__m128i
 
ü_by‹s
 = 
	`_mm_lßdl_•i64
((__m128˜*è(
pü
+
i
));

3416 
__m128i
 
cb_by‹s
 = 
	`_mm_lßdl_•i64
((__m128˜*è(
pcb
+
i
));

3417 
__m128i
 
ü_bŸ£d
 = 
	`_mm_xÜ_si128
(
ü_by‹s
, 
signæ
);

3418 
__m128i
 
cb_bŸ£d
 = 
	`_mm_xÜ_si128
(
cb_by‹s
, 
signæ
);

3421 
__m128i
 
yw
 = 
	`_mm_uÅacklo_•i8
(
y_bŸs
, 
y_by‹s
);

3422 
__m128i
 
üw
 = 
	`_mm_uÅacklo_•i8
(
	`_mm_£tz”o_si128
(), 
ü_bŸ£d
);

3423 
__m128i
 
cbw
 = 
	`_mm_uÅacklo_•i8
(
	`_mm_£tz”o_si128
(), 
cb_bŸ£d
);

3426 
__m128i
 
yws
 = 
	`_mm_¤li_•i16
(
yw
, 4);

3427 
__m128i
 
ü0
 = 
	`_mm_mulhi_•i16
(
ü_cÚ¡0
, 
üw
);

3428 
__m128i
 
cb0
 = 
	`_mm_mulhi_•i16
(
cb_cÚ¡0
, 
cbw
);

3429 
__m128i
 
cb1
 = 
	`_mm_mulhi_•i16
(
cbw
, 
cb_cÚ¡1
);

3430 
__m128i
 
ü1
 = 
	`_mm_mulhi_•i16
(
üw
, 
ü_cÚ¡1
);

3431 
__m128i
 
rws
 = 
	`_mm_add_•i16
(
ü0
, 
yws
);

3432 
__m128i
 
gwt
 = 
	`_mm_add_•i16
(
cb0
, 
yws
);

3433 
__m128i
 
bws
 = 
	`_mm_add_•i16
(
yws
, 
cb1
);

3434 
__m128i
 
gws
 = 
	`_mm_add_•i16
(
gwt
, 
ü1
);

3437 
__m128i
 
rw
 = 
	`_mm_¤ai_•i16
(
rws
, 4);

3438 
__m128i
 
bw
 = 
	`_mm_¤ai_•i16
(
bws
, 4);

3439 
__m128i
 
gw
 = 
	`_mm_¤ai_•i16
(
gws
, 4);

3442 
__m128i
 
brb
 = 
	`_mm_·ckus_•i16
(
rw
, 
bw
);

3443 
__m128i
 
gxb
 = 
	`_mm_·ckus_•i16
(
gw
, 
xw
);

3446 
__m128i
 
t0
 = 
	`_mm_uÅacklo_•i8
(
brb
, 
gxb
);

3447 
__m128i
 
t1
 = 
	`_mm_uÅackhi_•i8
(
brb
, 
gxb
);

3448 
__m128i
 
o0
 = 
	`_mm_uÅacklo_•i16
(
t0
, 
t1
);

3449 
__m128i
 
o1
 = 
	`_mm_uÅackhi_•i16
(
t0
, 
t1
);

3452 
	`_mm_¡Üeu_si128
((
__m128i
 *è(
out
 + 0), 
o0
);

3453 
	`_mm_¡Üeu_si128
((
__m128i
 *è(
out
 + 16), 
o1
);

3454 
out
 += 32;

3459 #ifdeà
STBI_NEON


3461 ià(
¡•
 == 4) {

3463 
ušt8x8_t
 
signæ
 = 
	`vdup_n_u8
(0x80);

3464 
št16x8_t
 
ü_cÚ¡0
 = 
	`vdupq_n_s16
( () ( 1.40200f*4096.0f+0.5f));

3465 
št16x8_t
 
ü_cÚ¡1
 = 
	`vdupq_n_s16
( - () ( 0.71414f*4096.0f+0.5f));

3466 
št16x8_t
 
cb_cÚ¡0
 = 
	`vdupq_n_s16
( - () ( 0.34414f*4096.0f+0.5f));

3467 
št16x8_t
 
cb_cÚ¡1
 = 
	`vdupq_n_s16
( () ( 1.77200f*4096.0f+0.5f));

3469 ; 
i
+7 < 
couÁ
; i += 8) {

3471 
ušt8x8_t
 
y_by‹s
 = 
	`vld1_u8
(
y
 + 
i
);

3472 
ušt8x8_t
 
ü_by‹s
 = 
	`vld1_u8
(
pü
 + 
i
);

3473 
ušt8x8_t
 
cb_by‹s
 = 
	`vld1_u8
(
pcb
 + 
i
);

3474 
št8x8_t
 
ü_bŸ£d
 = 
	`v»š‹½»t_s8_u8
(
	`vsub_u8
(
ü_by‹s
, 
signæ
));

3475 
št8x8_t
 
cb_bŸ£d
 = 
	`v»š‹½»t_s8_u8
(
	`vsub_u8
(
cb_by‹s
, 
signæ
));

3478 
št16x8_t
 
yws
 = 
	`v»š‹½»tq_s16_u16
(
	`vshÎ_n_u8
(
y_by‹s
, 4));

3479 
št16x8_t
 
üw
 = 
	`vshÎ_n_s8
(
ü_bŸ£d
, 7);

3480 
št16x8_t
 
cbw
 = 
	`vshÎ_n_s8
(
cb_bŸ£d
, 7);

3483 
št16x8_t
 
ü0
 = 
	`vqdmulhq_s16
(
üw
, 
ü_cÚ¡0
);

3484 
št16x8_t
 
cb0
 = 
	`vqdmulhq_s16
(
cbw
, 
cb_cÚ¡0
);

3485 
št16x8_t
 
ü1
 = 
	`vqdmulhq_s16
(
üw
, 
ü_cÚ¡1
);

3486 
št16x8_t
 
cb1
 = 
	`vqdmulhq_s16
(
cbw
, 
cb_cÚ¡1
);

3487 
št16x8_t
 
rws
 = 
	`vaddq_s16
(
yws
, 
ü0
);

3488 
št16x8_t
 
gws
 = 
	`vaddq_s16
(vaddq_s16(
yws
, 
cb0
), 
ü1
);

3489 
št16x8_t
 
bws
 = 
	`vaddq_s16
(
yws
, 
cb1
);

3492 
ušt8x8x4_t
 
o
;

3493 
o
.
v®
[0] = 
	`vqrshrun_n_s16
(
rws
, 4);

3494 
o
.
v®
[1] = 
	`vqrshrun_n_s16
(
gws
, 4);

3495 
o
.
v®
[2] = 
	`vqrshrun_n_s16
(
bws
, 4);

3496 
o
.
v®
[3] = 
	`vdup_n_u8
(255);

3499 
	`v¡4_u8
(
out
, 
o
);

3500 
out
 += 8*4;

3505 ; 
i
 < 
couÁ
; ++i) {

3506 
y_fixed
 = (
y
[
i
] << 20) + (1<<19);

3507 
r
,
g
,
b
;

3508 
ü
 = 
pü
[
i
] - 128;

3509 
cb
 = 
pcb
[
i
] - 128;

3510 
r
 = 
y_fixed
 + 
ü
* 
	`¡bi__æßt2fixed
(1.40200f);

3511 
g
 = 
y_fixed
 + 
ü
*-
	`¡bi__æßt2fixed
(0.71414fè+ ((
cb
*-stbi__float2fixed(0.34414f)) & 0xffff0000);

3512 
b
 = 
y_fixed
 + 
cb
* 
	`¡bi__æßt2fixed
(1.77200f);

3513 
r
 >>= 20;

3514 
g
 >>= 20;

3515 
b
 >>= 20;

3516 ià((è
r
 > 255) { if (r < 0)„ = 0; r = 255; }

3517 ià((è
g
 > 255) { if (g < 0) g = 0; g = 255; }

3518 ià((è
b
 > 255) { if (b < 0) b = 0; b = 255; }

3519 
out
[0] = (
¡bi_uc
)
r
;

3520 
out
[1] = (
¡bi_uc
)
g
;

3521 
out
[2] = (
¡bi_uc
)
b
;

3522 
out
[3] = 255;

3523 
out
 +ğ
¡•
;

3525 
	}
}

3529 
	$¡bi__£tup_j³g
(
¡bi__j³g
 *
j
)

3531 
j
->
idù_block_k”Ãl
 = 
¡bi__idù_block
;

3532 
j
->
YCbCr_to_RGB_k”Ãl
 = 
¡bi__YCbCr_to_RGB_row
;

3533 
j
->
»§m¶e_row_hv_2_k”Ãl
 = 
¡bi__»§m¶e_row_hv_2
;

3535 #ifdeà
STBI_SSE2


3536 ià(
	`¡bi__s£2_avaabË
()) {

3537 
j
->
idù_block_k”Ãl
 = 
¡bi__idù_simd
;

3538 
j
->
YCbCr_to_RGB_k”Ãl
 = 
¡bi__YCbCr_to_RGB_simd
;

3539 
j
->
»§m¶e_row_hv_2_k”Ãl
 = 
¡bi__»§m¶e_row_hv_2_simd
;

3543 #ifdeà
STBI_NEON


3544 
j
->
idù_block_k”Ãl
 = 
¡bi__idù_simd
;

3545 
j
->
YCbCr_to_RGB_k”Ãl
 = 
¡bi__YCbCr_to_RGB_simd
;

3546 
j
->
»§m¶e_row_hv_2_k”Ãl
 = 
¡bi__»§m¶e_row_hv_2_simd
;

3548 
	}
}

3551 
	$¡bi__ş—nup_j³g
(
¡bi__j³g
 *
j
)

3553 
	`¡bi__ä“_j³g_compÚ’ts
(
j
, j->
s
->
img_n
, 0);

3554 
	}
}

3558 
»§m¶e_row_func
 
	m»§m¶e
;

3559 
¡bi_uc
 *
	mlše0
,*
	mlše1
;

3560 
	mhs
,
	mvs
;

3561 
	mw_lÜes
;

3562 
	my¡•
;

3563 
	mypos
;

3564 } 
	t¡bi__»§m¶e
;

3567 
¡bi_uc
 
	$¡bi__blšn_8x8
(
¡bi_uc
 
x
, stbi_uø
y
)

3569 
t
 = 
x
*
y
 + 128;

3570  (
¡bi_uc
è((
t
 + (t >>8)) >> 8);

3571 
	}
}

3573 
¡bi_uc
 *
	$lßd_j³g_image
(
¡bi__j³g
 *
z
, *
out_x
, *
out_y
, *
comp
, 
»q_comp
)

3575 
n
, 
decode_n
, 
is_rgb
;

3576 
z
->
s
->
img_n
 = 0;

3579 ià(
»q_comp
 < 0 ||„eq_com°> 4è 
	`¡bi__”½uc
("bad„eq_comp", "Internalƒrror");

3582 ià(!
	`¡bi__decode_j³g_image
(
z
)è{ 
	`¡bi__ş—nup_j³g
(z);  
NULL
; }

3585 
n
 = 
»q_comp
 ?„eq_com°: 
z
->
s
->
img_n
 >= 3 ? 3 : 1;

3587 
is_rgb
 = 
z
->
s
->
img_n
 =ğ3 && (z->
rgb
 =ğ3 || (z->
­p14_cŞÜ_ŒªsfÜm
 =ğ0 && !z->
jfif
));

3589 ià(
z
->
s
->
img_n
 =ğ3 && 
n
 < 3 && !
is_rgb
)

3590 
decode_n
 = 1;

3592 
decode_n
 = 
z
->
s
->
img_n
;

3596 
k
;

3597 
i
,
j
;

3598 
¡bi_uc
 *
ouut
;

3599 
¡bi_uc
 *
couut
[4];

3601 
¡bi__»§m¶e
 
»s_comp
[4];

3603 
k
=0; k < 
decode_n
; ++k) {

3604 
¡bi__»§m¶e
 *
r
 = &
»s_comp
[
k
];

3608 
z
->
img_comp
[
k
].
lšebuf
 = (
¡bi_uc
 *è
	`¡bi__m®loc
(z->
s
->
img_x
 + 3);

3609 ià(!
z
->
img_comp
[
k
].
lšebuf
è{ 
	`¡bi__ş—nup_j³g
(z);  
	`¡bi__”½uc
("outofmem", "Out of memory"); }

3611 
r
->
hs
 = 
z
->
img_h_max
 / z->
img_comp
[
k
].
h
;

3612 
r
->
vs
 = 
z
->
img_v_max
 / z->
img_comp
[
k
].
v
;

3613 
r
->
y¡•
 =„->
vs
 >> 1;

3614 
r
->
w_lÜes
 = (
z
->
s
->
img_x
 +„->
hs
-1) /„->hs;

3615 
r
->
ypos
 = 0;

3616 
r
->
lše0
 =„->
lše1
 = 
z
->
img_comp
[
k
].
d©a
;

3618 ià(
r
->
hs
 =ğ1 &&„->
vs
 =ğ1èr->
»§m¶e
 = 
»§m¶e_row_1
;

3619 ià(
r
->
hs
 =ğ1 &&„->
vs
 =ğ2èr->
»§m¶e
 = 
¡bi__»§m¶e_row_v_2
;

3620 ià(
r
->
hs
 =ğ2 &&„->
vs
 =ğ1èr->
»§m¶e
 = 
¡bi__»§m¶e_row_h_2
;

3621 ià(
r
->
hs
 =ğ2 &&„->
vs
 =ğ2èr->
»§m¶e
 = 
z
->
»§m¶e_row_hv_2_k”Ãl
;

3622 
r
->
»§m¶e
 = 
¡bi__»§m¶e_row_g’”ic
;

3626 
ouut
 = (
¡bi_uc
 *è
	`¡bi__m®loc_mad3
(
n
, 
z
->
s
->
img_x
, z->s->
img_y
, 1);

3627 ià(!
ouut
è{ 
	`¡bi__ş—nup_j³g
(
z
);  
	`¡bi__”½uc
("outofmem", "Out of memory"); }

3630 
j
=0; j < 
z
->
s
->
img_y
; ++j) {

3631 
¡bi_uc
 *
out
 = 
ouut
 + 
n
 * 
z
->
s
->
img_x
 * 
j
;

3632 
k
=0; k < 
decode_n
; ++k) {

3633 
¡bi__»§m¶e
 *
r
 = &
»s_comp
[
k
];

3634 
y_bÙ
 = 
r
->
y¡•
 >ğÔ->
vs
 >> 1);

3635 
couut
[
k
] = 
r
->
	`»§m¶e
(
z
->
img_comp
[k].
lšebuf
,

3636 
y_bÙ
 ? 
r
->
lše1
 :„->
lše0
,

3637 
y_bÙ
 ? 
r
->
lše0
 :„->
lše1
,

3638 
r
->
w_lÜes
,„->
hs
);

3639 ià(++
r
->
y¡•
 >ğr->
vs
) {

3640 
r
->
y¡•
 = 0;

3641 
r
->
lše0
 =„->
lše1
;

3642 ià(++
r
->
ypos
 < 
z
->
img_comp
[
k
].
y
)

3643 
r
->
lše1
 +ğ
z
->
img_comp
[
k
].
w2
;

3646 ià(
n
 >= 3) {

3647 
¡bi_uc
 *
y
 = 
couut
[0];

3648 ià(
z
->
s
->
img_n
 == 3) {

3649 ià(
is_rgb
) {

3650 
i
=0; i < 
z
->
s
->
img_x
; ++i) {

3651 
out
[0] = 
y
[
i
];

3652 
out
[1] = 
couut
[1][
i
];

3653 
out
[2] = 
couut
[2][
i
];

3654 
out
[3] = 255;

3655 
out
 +ğ
n
;

3658 
z
->
	`YCbCr_to_RGB_k”Ãl
(
out
, 
y
, 
couut
[1], couut[2], z->
s
->
img_x
, 
n
);

3660 } ià(
z
->
s
->
img_n
 == 4) {

3661 ià(
z
->
­p14_cŞÜ_ŒªsfÜm
 == 0) {

3662 
i
=0; i < 
z
->
s
->
img_x
; ++i) {

3663 
¡bi_uc
 
m
 = 
couut
[3][
i
];

3664 
out
[0] = 
	`¡bi__blšn_8x8
(
couut
[0][
i
], 
m
);

3665 
out
[1] = 
	`¡bi__blšn_8x8
(
couut
[1][
i
], 
m
);

3666 
out
[2] = 
	`¡bi__blšn_8x8
(
couut
[2][
i
], 
m
);

3667 
out
[3] = 255;

3668 
out
 +ğ
n
;

3670 } ià(
z
->
­p14_cŞÜ_ŒªsfÜm
 == 2) {

3671 
z
->
	`YCbCr_to_RGB_k”Ãl
(
out
, 
y
, 
couut
[1], couut[2], z->
s
->
img_x
, 
n
);

3672 
i
=0; i < 
z
->
s
->
img_x
; ++i) {

3673 
¡bi_uc
 
m
 = 
couut
[3][
i
];

3674 
out
[0] = 
	`¡bi__blšn_8x8
(255 - out[0], 
m
);

3675 
out
[1] = 
	`¡bi__blšn_8x8
(255 - out[1], 
m
);

3676 
out
[2] = 
	`¡bi__blšn_8x8
(255 - out[2], 
m
);

3677 
out
 +ğ
n
;

3680 
z
->
	`YCbCr_to_RGB_k”Ãl
(
out
, 
y
, 
couut
[1], couut[2], z->
s
->
img_x
, 
n
);

3683 
i
=0; i < 
z
->
s
->
img_x
; ++i) {

3684 
out
[0] = out[1] = out[2] = 
y
[
i
];

3685 
out
[3] = 255;

3686 
out
 +ğ
n
;

3689 ià(
is_rgb
) {

3690 ià(
n
 == 1)

3691 
i
=0; i < 
z
->
s
->
img_x
; ++i)

3692 *
out
++ = 
	`¡bi__compu‹_y
(
couut
[0][
i
], coutput[1][i], coutput[2][i]);

3694 
i
=0; i < 
z
->
s
->
img_x
; ++i, 
out
 += 2) {

3695 
out
[0] = 
	`¡bi__compu‹_y
(
couut
[0][
i
], coutput[1][i], coutput[2][i]);

3696 
out
[1] = 255;

3699 } ià(
z
->
s
->
img_n
 =ğ4 && z->
­p14_cŞÜ_ŒªsfÜm
 == 0) {

3700 
i
=0; i < 
z
->
s
->
img_x
; ++i) {

3701 
¡bi_uc
 
m
 = 
couut
[3][
i
];

3702 
¡bi_uc
 
r
 = 
	`¡bi__blšn_8x8
(
couut
[0][
i
], 
m
);

3703 
¡bi_uc
 
g
 = 
	`¡bi__blšn_8x8
(
couut
[1][
i
], 
m
);

3704 
¡bi_uc
 
b
 = 
	`¡bi__blšn_8x8
(
couut
[2][
i
], 
m
);

3705 
out
[0] = 
	`¡bi__compu‹_y
(
r
, 
g
, 
b
);

3706 
out
[1] = 255;

3707 
out
 +ğ
n
;

3709 } ià(
z
->
s
->
img_n
 =ğ4 && z->
­p14_cŞÜ_ŒªsfÜm
 == 2) {

3710 
i
=0; i < 
z
->
s
->
img_x
; ++i) {

3711 
out
[0] = 
	`¡bi__blšn_8x8
(255 - 
couut
[0][
i
], coutput[3][i]);

3712 
out
[1] = 255;

3713 
out
 +ğ
n
;

3716 
¡bi_uc
 *
y
 = 
couut
[0];

3717 ià(
n
 == 1)

3718 
i
=0; i < 
z
->
s
->
img_x
; ++iè
out
[i] = 
y
[i];

3720 
i
=0; i < 
z
->
s
->
img_x
; ++iè*
out
++ = 
y
[i], *out++ = 255;

3724 
	`¡bi__ş—nup_j³g
(
z
);

3725 *
out_x
 = 
z
->
s
->
img_x
;

3726 *
out_y
 = 
z
->
s
->
img_y
;

3727 ià(
comp
è*com°ğ
z
->
s
->
img_n
 >= 3 ? 3 : 1;

3728  
ouut
;

3730 
	}
}

3732 *
	$¡bi__j³g_lßd
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
)

3734 * 
»suÉ
;

3735 
¡bi__j³g
* 
j
 = (¡bi__j³g*è
	`¡bi__m®loc
((stbi__jpeg));

3736 
	`STBI_NOTUSED
(
ri
);

3737 
j
->
s
 = s;

3738 
	`¡bi__£tup_j³g
(
j
);

3739 
»suÉ
 = 
	`lßd_j³g_image
(
j
, 
x
,
y
,
comp
,
»q_comp
);

3740 
	`STBI_FREE
(
j
);

3741  
»suÉ
;

3742 
	}
}

3744 
	$¡bi__j³g_‹¡
(
¡bi__cÚ‹xt
 *
s
)

3746 
r
;

3747 
¡bi__j³g
* 
j
 = (¡bi__j³g*)
	`¡bi__m®loc
((stbi__jpeg));

3748 
j
->
s
 = s;

3749 
	`¡bi__£tup_j³g
(
j
);

3750 
r
 = 
	`¡bi__decode_j³g_h—d”
(
j
, 
STBI__SCAN_ty³
);

3751 
	`¡bi__»wšd
(
s
);

3752 
	`STBI_FREE
(
j
);

3753  
r
;

3754 
	}
}

3756 
	$¡bi__j³g_šfo_¿w
(
¡bi__j³g
 *
j
, *
x
, *
y
, *
comp
)

3758 ià(!
	`¡bi__decode_j³g_h—d”
(
j
, 
STBI__SCAN_h—d”
)) {

3759 
	`¡bi__»wšd
Ğ
j
->
s
 );

3762 ià(
x
è*x = 
j
->
s
->
img_x
;

3763 ià(
y
è*y = 
j
->
s
->
img_y
;

3764 ià(
comp
è*com°ğ
j
->
s
->
img_n
 >= 3 ? 3 : 1;

3766 
	}
}

3768 
	$¡bi__j³g_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
)

3770 
»suÉ
;

3771 
¡bi__j³g
* 
j
 = (¡bi__j³g*è(
	`¡bi__m®loc
((stbi__jpeg)));

3772 
j
->
s
 = s;

3773 
»suÉ
 = 
	`¡bi__j³g_šfo_¿w
(
j
, 
x
, 
y
, 
comp
);

3774 
	`STBI_FREE
(
j
);

3775  
»suÉ
;

3776 
	}
}

3786 #iâdeà
STBI_NO_ZLIB


3789 
	#STBI__ZFAST_BITS
 9

3790 
	#STBI__ZFAST_MASK
 ((1 << 
STBI__ZFAST_BITS
è- 1)

	)

3796 
¡bi__ušt16
 
	mç¡
[1 << 
STBI__ZFAST_BITS
];

3797 
¡bi__ušt16
 
	mfœ¡code
[16];

3798 
	mmaxcode
[17];

3799 
¡bi__ušt16
 
	mfœ¡symbŞ
[16];

3800 
¡bi_uc
 
	msize
[288];

3801 
¡bi__ušt16
 
	mv®ue
[288];

3802 } 
	t¡bi__zhuffmª
;

3804 
¡bi_šlše
 
	$¡bi__b™»v”£16
(
n
)

3806 
n
 = ((n & 0xAAAA) >> 1) | ((n & 0x5555) << 1);

3807 
n
 = ((n & 0xCCCC) >> 2) | ((n & 0x3333) << 2);

3808 
n
 = ((n & 0xF0F0) >> 4) | ((n & 0x0F0F) << 4);

3809 
n
 = ((n & 0xFF00) >> 8) | ((n & 0x00FF) << 8);

3810  
n
;

3811 
	}
}

3813 
¡bi_šlše
 
	$¡bi__b™_»v”£
(
v
, 
b™s
)

3815 
	`STBI_ASSERT
(
b™s
 <= 16);

3818  
	`¡bi__b™»v”£16
(
v
è>> (16-
b™s
);

3819 
	}
}

3821 
	$¡bi__zbud_huffmª
(
¡bi__zhuffmª
 *
z
, cÚ¡ 
¡bi_uc
 *
siz–i¡
, 
num
)

3823 
i
,
k
=0;

3824 
code
, 
Ãxt_code
[16], 
sizes
[17];

3827 
	`mem£t
(
sizes
, 0, (sizes));

3828 
	`mem£t
(
z
->
ç¡
, 0, (z->fast));

3829 
i
=0; i < 
num
; ++i)

3830 ++
sizes
[
siz–i¡
[
i
]];

3831 
sizes
[0] = 0;

3832 
i
=1; i < 16; ++i)

3833 ià(
sizes
[
i
] > (1 << i))

3834  
	`¡bi__”r
("bad sizes", "Corrupt PNG");

3835 
code
 = 0;

3836 
i
=1; i < 16; ++i) {

3837 
Ãxt_code
[
i
] = 
code
;

3838 
z
->
fœ¡code
[
i
] = (
¡bi__ušt16
è
code
;

3839 
z
->
fœ¡symbŞ
[
i
] = (
¡bi__ušt16
è
k
;

3840 
code
 = (cod+ 
sizes
[
i
]);

3841 ià(
sizes
[
i
])

3842 ià(
code
-1 >ğ(1 << 
i
)è 
	`¡bi__”r
("bad codelengths","Corrupt PNG");

3843 
z
->
maxcode
[
i
] = 
code
 << (16-i);

3844 
code
 <<= 1;

3845 
k
 +ğ
sizes
[
i
];

3847 
z
->
maxcode
[16] = 0x10000;

3848 
i
=0; i < 
num
; ++i) {

3849 
s
 = 
siz–i¡
[
i
];

3850 ià(
s
) {

3851 
c
 = 
Ãxt_code
[
s
] - 
z
->
fœ¡code
[s] + z->
fœ¡symbŞ
[s];

3852 
¡bi__ušt16
 
ç¡v
 = (¡bi__ušt16è((
s
 << 9è| 
i
);

3853 
z
->
size
 [
c
] = (
¡bi_uc
 ) 
s
;

3854 
z
->
v®ue
[
c
] = (
¡bi__ušt16
è
i
;

3855 ià(
s
 <ğ
STBI__ZFAST_BITS
) {

3856 
j
 = 
	`¡bi__b™_»v”£
(
Ãxt_code
[
s
],s);

3857 
j
 < (1 << 
STBI__ZFAST_BITS
)) {

3858 
z
->
ç¡
[
j
] = 
ç¡v
;

3859 
j
 +ğ(1 << 
s
);

3862 ++
Ãxt_code
[
s
];

3866 
	}
}

3876 
¡bi_uc
 *
	mzbufãr
, *
	mzbufãr_’d
;

3877 
	mnum_b™s
;

3878 
¡bi__ušt32
 
	mcode_bufãr
;

3880 *
	mzout
;

3881 *
	mzout_¡¬t
;

3882 *
	mzout_’d
;

3883 
	mz_ex·ndabË
;

3885 
¡bi__zhuffmª
 
	mz_Ëngth
, 
	mz_di¡ªû
;

3886 } 
	t¡bi__zbuf
;

3888 
¡bi_šlše
 
¡bi_uc
 
	$¡bi__zg‘8
(
¡bi__zbuf
 *
z
)

3890 ià(
z
->
zbufãr
 >ğz->
zbufãr_’d
)  0;

3891  *
z
->
zbufãr
++;

3892 
	}
}

3894 
	$¡bi__fl_b™s
(
¡bi__zbuf
 *
z
)

3897 
	`STBI_ASSERT
(
z
->
code_bufãr
 < (1U << z->
num_b™s
));

3898 
z
->
code_bufãr
 |ğ(è
	`¡bi__zg‘8
(zè<< z->
num_b™s
;

3899 
z
->
num_b™s
 += 8;

3900 } 
z
->
num_b™s
 <= 24);

3901 
	}
}

3903 
¡bi_šlše
 
	$¡bi__z»ûive
(
¡bi__zbuf
 *
z
, 
n
)

3905 
k
;

3906 ià(
z
->
num_b™s
 < 
n
è
	`¡bi__fl_b™s
(z);

3907 
k
 = 
z
->
code_bufãr
 & ((1 << 
n
) - 1);

3908 
z
->
code_bufãr
 >>ğ
n
;

3909 
z
->
num_b™s
 -ğ
n
;

3910  
k
;

3911 
	}
}

3913 
	$¡bi__zhuffmª_decode_¦ow·th
(
¡bi__zbuf
 *
a
, 
¡bi__zhuffmª
 *
z
)

3915 
b
,
s
,
k
;

3918 
k
 = 
	`¡bi__b™_»v”£
(
a
->
code_bufãr
, 16);

3919 
s
=
STBI__ZFAST_BITS
+1; ; ++s)

3920 ià(
k
 < 
z
->
maxcode
[
s
])

3922 ià(
s
 == 16)  -1;

3924 
b
 = (
k
 >> (16-
s
)è- 
z
->
fœ¡code
[s] + z->
fœ¡symbŞ
[s];

3925 
	`STBI_ASSERT
(
z
->
size
[
b
] =ğ
s
);

3926 
a
->
code_bufãr
 >>ğ
s
;

3927 
a
->
num_b™s
 -ğ
s
;

3928  
z
->
v®ue
[
b
];

3929 
	}
}

3931 
¡bi_šlše
 
	$¡bi__zhuffmª_decode
(
¡bi__zbuf
 *
a
, 
¡bi__zhuffmª
 *
z
)

3933 
b
,
s
;

3934 ià(
a
->
num_b™s
 < 16è
	`¡bi__fl_b™s
(a);

3935 
b
 = 
z
->
ç¡
[
a
->
code_bufãr
 & 
STBI__ZFAST_MASK
];

3936 ià(
b
) {

3937 
s
 = 
b
 >> 9;

3938 
a
->
code_bufãr
 >>ğ
s
;

3939 
a
->
num_b™s
 -ğ
s
;

3940  
b
 & 511;

3942  
	`¡bi__zhuffmª_decode_¦ow·th
(
a
, 
z
);

3943 
	}
}

3945 
	$¡bi__zex·nd
(
¡bi__zbuf
 *
z
, *
zout
, 
n
)

3947 *
q
;

3948 
cur
, 
lim™
, 
Şd_lim™
;

3949 
z
->
zout
 = zout;

3950 ià(!
z
->
z_ex·ndabË
è 
	`¡bi__”r
("output buffer†imit","Corrupt PNG");

3951 
cur
 = (è(
z
->
zout
 - z->
zout_¡¬t
);

3952 
lim™
 = 
Şd_lim™
 = (è(
z
->
zout_’d
 - z->
zout_¡¬t
);

3953 
cur
 + 
n
 > 
lim™
)

3954 
lim™
 *= 2;

3955 
q
 = (*è
	`STBI_REALLOC_SIZED
(
z
->
zout_¡¬t
, 
Şd_lim™
, 
lim™
);

3956 
	`STBI_NOTUSED
(
Şd_lim™
);

3957 ià(
q
 =ğ
NULL
è 
	`¡bi__”r
("outofmem", "Out of memory");

3958 
z
->
zout_¡¬t
 = 
q
;

3959 
z
->
zout
 = 
q
 + 
cur
;

3960 
z
->
zout_’d
 = 
q
 + 
lim™
;

3962 
	}
}

3964 cÚ¡ 
	g¡bi__zËngth_ba£
[31] = {

3969 cÚ¡ 
	g¡bi__zËngth_exŒa
[31]=

3972 cÚ¡ 
	g¡bi__zdi¡_ba£
[32] = { 1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,

3975 cÚ¡ 
	g¡bi__zdi¡_exŒa
[32] =

3978 
	$¡bi__·r£_huffmª_block
(
¡bi__zbuf
 *
a
)

3980 *
zout
 = 
a
->zout;

3982 
z
 = 
	`¡bi__zhuffmª_decode
(
a
, &a->
z_Ëngth
);

3983 ià(
z
 < 256) {

3984 ià(
z
 < 0è 
	`¡bi__”r
("bad huffman code","Corrupt PNG");

3985 ià(
zout
 >ğ
a
->
zout_’d
) {

3986 ià(!
	`¡bi__zex·nd
(
a
, 
zout
, 1))  0;

3987 
zout
 = 
a
->zout;

3989 *
zout
++ = (è
z
;

3991 
¡bi_uc
 *
p
;

3992 
Ën
,
di¡
;

3993 ià(
z
 == 256) {

3994 
a
->
zout
 = zout;

3997 
z
 -= 257;

3998 
Ën
 = 
¡bi__zËngth_ba£
[
z
];

3999 ià(
¡bi__zËngth_exŒa
[
z
]è
Ën
 +ğ
	`¡bi__z»ûive
(
a
, stbi__zlength_extra[z]);

4000 
z
 = 
	`¡bi__zhuffmª_decode
(
a
, &a->
z_di¡ªû
);

4001 ià(
z
 < 0è 
	`¡bi__”r
("bad huffman code","Corrupt PNG");

4002 
di¡
 = 
¡bi__zdi¡_ba£
[
z
];

4003 ià(
¡bi__zdi¡_exŒa
[
z
]è
di¡
 +ğ
	`¡bi__z»ûive
(
a
, stbi__zdist_extra[z]);

4004 ià(
zout
 - 
a
->
zout_¡¬t
 < 
di¡
è 
	`¡bi__”r
("bad dist","Corrupt PNG");

4005 ià(
zout
 + 
Ën
 > 
a
->
zout_’d
) {

4006 ià(!
	`¡bi__zex·nd
(
a
, 
zout
, 
Ën
))  0;

4007 
zout
 = 
a
->zout;

4009 
p
 = (
¡bi_uc
 *è(
zout
 - 
di¡
);

4010 ià(
di¡
 == 1) {

4011 
¡bi_uc
 
v
 = *
p
;

4012 ià(
Ën
è{ dØ*
zout
++ = 
v
; --len); }

4014 ià(
Ën
è{ dØ*
zout
++ = *
p
++; --len); }

4018 
	}
}

4020 
	$¡bi__compu‹_huffmª_codes
(
¡bi__zbuf
 *
a
)

4022 cÚ¡ 
¡bi_uc
 
Ëngth_dezigzag
[19] = { 16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15 };

4023 
¡bi__zhuffmª
 
z_cod–’gth
;

4024 
¡bi_uc
 
Ëncodes
[286+32+137];

4025 
¡bi_uc
 
cod–’gth_sizes
[19];

4026 
i
,
n
;

4028 
hl™
 = 
	`¡bi__z»ûive
(
a
,5) + 257;

4029 
hdi¡
 = 
	`¡bi__z»ûive
(
a
,5) + 1;

4030 
hş’
 = 
	`¡bi__z»ûive
(
a
,4) + 4;

4031 
ÁÙ
 = 
hl™
 + 
hdi¡
;

4033 
	`mem£t
(
cod–’gth_sizes
, 0, (codelength_sizes));

4034 
i
=0; i < 
hş’
; ++i) {

4035 
s
 = 
	`¡bi__z»ûive
(
a
,3);

4036 
cod–’gth_sizes
[
Ëngth_dezigzag
[
i
]] = (
¡bi_uc
è
s
;

4038 ià(!
	`¡bi__zbud_huffmª
(&
z_cod–’gth
, 
cod–’gth_sizes
, 19))  0;

4040 
n
 = 0;

4041 
n
 < 
ÁÙ
) {

4042 
c
 = 
	`¡bi__zhuffmª_decode
(
a
, &
z_cod–’gth
);

4043 ià(
c
 < 0 || c >ğ19è 
	`¡bi__”r
("bad codelengths", "Corrupt PNG");

4044 ià(
c
 < 16)

4045 
Ëncodes
[
n
++] = (
¡bi_uc
è
c
;

4047 
¡bi_uc
 
fl
 = 0;

4048 ià(
c
 == 16) {

4049 
c
 = 
	`¡bi__z»ûive
(
a
,2)+3;

4050 ià(
n
 =ğ0è 
	`¡bi__”r
("bad codelengths", "Corrupt PNG");

4051 
fl
 = 
Ëncodes
[
n
-1];

4052 } ià(
c
 == 17)

4053 
c
 = 
	`¡bi__z»ûive
(
a
,3)+3;

4055 
	`STBI_ASSERT
(
c
 == 18);

4056 
c
 = 
	`¡bi__z»ûive
(
a
,7)+11;

4058 ià(
ÁÙ
 - 
n
 < 
c
è 
	`¡bi__”r
("bad codelengths", "Corrupt PNG");

4059 
	`mem£t
(
Ëncodes
+
n
, 
fl
, 
c
);

4060 
n
 +ğ
c
;

4063 ià(
n
 !ğ
ÁÙ
è 
	`¡bi__”r
("bad codelengths","Corrupt PNG");

4064 ià(!
	`¡bi__zbud_huffmª
(&
a
->
z_Ëngth
, 
Ëncodes
, 
hl™
))  0;

4065 ià(!
	`¡bi__zbud_huffmª
(&
a
->
z_di¡ªû
, 
Ëncodes
+
hl™
, 
hdi¡
))  0;

4067 
	}
}

4069 
	$¡bi__·r£_uncom´es£d_block
(
¡bi__zbuf
 *
a
)

4071 
¡bi_uc
 
h—d”
[4];

4072 
Ën
,
Æ’
,
k
;

4073 ià(
a
->
num_b™s
 & 7)

4074 
	`¡bi__z»ûive
(
a
,‡->
num_b™s
 & 7);

4076 
k
 = 0;

4077 
a
->
num_b™s
 > 0) {

4078 
h—d”
[
k
++] = (
¡bi_uc
è(
a
->
code_bufãr
 & 255);

4079 
a
->
code_bufãr
 >>= 8;

4080 
a
->
num_b™s
 -= 8;

4082 
	`STBI_ASSERT
(
a
->
num_b™s
 == 0);

4084 
k
 < 4)

4085 
h—d”
[
k
++] = 
	`¡bi__zg‘8
(
a
);

4086 
Ën
 = 
h—d”
[1] * 256 + header[0];

4087 
Æ’
 = 
h—d”
[3] * 256 + header[2];

4088 ià(
Æ’
 !ğ(
Ën
 ^ 0xffff)è 
	`¡bi__”r
("zlib corrupt","Corrupt PNG");

4089 ià(
a
->
zbufãr
 + 
Ën
 >‡->
zbufãr_’d
è 
	`¡bi__”r
("read…ast buffer","Corrupt PNG");

4090 ià(
a
->
zout
 + 
Ën
 >‡->
zout_’d
)

4091 ià(!
	`¡bi__zex·nd
(
a
,‡->
zout
, 
Ën
))  0;

4092 
	`memıy
(
a
->
zout
,‡->
zbufãr
, 
Ën
);

4093 
a
->
zbufãr
 +ğ
Ën
;

4094 
a
->
zout
 +ğ
Ën
;

4096 
	}
}

4098 
	$¡bi__·r£_zlib_h—d”
(
¡bi__zbuf
 *
a
)

4100 
cmf
 = 
	`¡bi__zg‘8
(
a
);

4101 
cm
 = 
cmf
 & 15;

4103 
æg
 = 
	`¡bi__zg‘8
(
a
);

4104 ià((
cmf
*256+
æg
è% 31 !ğ0è 
	`¡bi__”r
("bad zlib header","Corrupt PNG");

4105 ià(
æg
 & 32è 
	`¡bi__”r
("no…reset dict","Corrupt PNG");

4106 ià(
cm
 !ğ8è 
	`¡bi__”r
("bad compression","Corrupt PNG");

4109 
	}
}

4111 cÚ¡ 
¡bi_uc
 
	g¡bi__zdeçuÉ_Ëngth
[288] =

4123 cÚ¡ 
¡bi_uc
 
	g¡bi__zdeçuÉ_di¡ªû
[32] =

4140 
	$¡bi__·r£_zlib
(
¡bi__zbuf
 *
a
, 
·r£_h—d”
)

4142 
fš®
, 
ty³
;

4143 ià(
·r£_h—d”
)

4144 ià(!
	`¡bi__·r£_zlib_h—d”
(
a
))  0;

4145 
a
->
num_b™s
 = 0;

4146 
a
->
code_bufãr
 = 0;

4148 
fš®
 = 
	`¡bi__z»ûive
(
a
,1);

4149 
ty³
 = 
	`¡bi__z»ûive
(
a
,2);

4150 ià(
ty³
 == 0) {

4151 ià(!
	`¡bi__·r£_uncom´es£d_block
(
a
))  0;

4152 } ià(
ty³
 == 3) {

4155 ià(
ty³
 == 1) {

4157 ià(!
	`¡bi__zbud_huffmª
(&
a
->
z_Ëngth
 , 
¡bi__zdeçuÉ_Ëngth
 , 288))  0;

4158 ià(!
	`¡bi__zbud_huffmª
(&
a
->
z_di¡ªû
, 
¡bi__zdeçuÉ_di¡ªû
, 32))  0;

4160 ià(!
	`¡bi__compu‹_huffmª_codes
(
a
))  0;

4162 ià(!
	`¡bi__·r£_huffmª_block
(
a
))  0;

4164 } !
fš®
);

4166 
	}
}

4168 
	$¡bi__do_zlib
(
¡bi__zbuf
 *
a
, *
obuf
, 
Ş’
, 
exp
, 
·r£_h—d”
)

4170 
a
->
zout_¡¬t
 = 
obuf
;

4171 
a
->
zout
 = 
obuf
;

4172 
a
->
zout_’d
 = 
obuf
 + 
Ş’
;

4173 
a
->
z_ex·ndabË
 = 
exp
;

4175  
	`¡bi__·r£_zlib
(
a
, 
·r£_h—d”
);

4176 
	}
}

4178 
STBIDEF
 *
	$¡bi_zlib_decode_m®loc_guesssize
(cÚ¡ *
bufãr
, 
Ën
, 
š™Ÿl_size
, *
ou’
)

4180 
¡bi__zbuf
 
a
;

4181 *
p
 = (*è
	`¡bi__m®loc
(
š™Ÿl_size
);

4182 ià(
p
 =ğ
NULL
)  NULL;

4183 
a
.
zbufãr
 = (
¡bi_uc
 *è
bufãr
;

4184 
a
.
zbufãr_’d
 = (
¡bi_uc
 *è
bufãr
 + 
Ën
;

4185 ià(
	`¡bi__do_zlib
(&
a
, 
p
, 
š™Ÿl_size
, 1, 1)) {

4186 ià(
ou’
è*ou’ = (è(
a
.
zout
 -‡.
zout_¡¬t
);

4187  
a
.
zout_¡¬t
;

4189 
	`STBI_FREE
(
a
.
zout_¡¬t
);

4190  
NULL
;

4192 
	}
}

4194 
STBIDEF
 *
	$¡bi_zlib_decode_m®loc
(cÚ¡ *
bufãr
, 
Ën
, *
ou’
)

4196  
	`¡bi_zlib_decode_m®loc_guesssize
(
bufãr
, 
Ën
, 16384, 
ou’
);

4197 
	}
}

4199 
STBIDEF
 *
	$¡bi_zlib_decode_m®loc_guesssize_h—d”æag
(cÚ¡ *
bufãr
, 
Ën
, 
š™Ÿl_size
, *
ou’
, 
·r£_h—d”
)

4201 
¡bi__zbuf
 
a
;

4202 *
p
 = (*è
	`¡bi__m®loc
(
š™Ÿl_size
);

4203 ià(
p
 =ğ
NULL
)  NULL;

4204 
a
.
zbufãr
 = (
¡bi_uc
 *è
bufãr
;

4205 
a
.
zbufãr_’d
 = (
¡bi_uc
 *è
bufãr
 + 
Ën
;

4206 ià(
	`¡bi__do_zlib
(&
a
, 
p
, 
š™Ÿl_size
, 1, 
·r£_h—d”
)) {

4207 ià(
ou’
è*ou’ = (è(
a
.
zout
 -‡.
zout_¡¬t
);

4208  
a
.
zout_¡¬t
;

4210 
	`STBI_FREE
(
a
.
zout_¡¬t
);

4211  
NULL
;

4213 
	}
}

4215 
STBIDEF
 
	$¡bi_zlib_decode_bufãr
(*
obufãr
, 
Ş’
, cÚ¡ *
ibufãr
, 
’
)

4217 
¡bi__zbuf
 
a
;

4218 
a
.
zbufãr
 = (
¡bi_uc
 *è
ibufãr
;

4219 
a
.
zbufãr_’d
 = (
¡bi_uc
 *è
ibufãr
 + 
’
;

4220 ià(
	`¡bi__do_zlib
(&
a
, 
obufãr
, 
Ş’
, 0, 1))

4221  (è(
a
.
zout
 -‡.
zout_¡¬t
);

4224 
	}
}

4226 
STBIDEF
 *
	$¡bi_zlib_decode_noh—d”_m®loc
(cÚ¡ *
bufãr
, 
Ën
, *
ou’
)

4228 
¡bi__zbuf
 
a
;

4229 *
p
 = (*è
	`¡bi__m®loc
(16384);

4230 ià(
p
 =ğ
NULL
)  NULL;

4231 
a
.
zbufãr
 = (
¡bi_uc
 *è
bufãr
;

4232 
a
.
zbufãr_’d
 = (
¡bi_uc
 *è
bufãr
+
Ën
;

4233 ià(
	`¡bi__do_zlib
(&
a
, 
p
, 16384, 1, 0)) {

4234 ià(
ou’
è*ou’ = (è(
a
.
zout
 -‡.
zout_¡¬t
);

4235  
a
.
zout_¡¬t
;

4237 
	`STBI_FREE
(
a
.
zout_¡¬t
);

4238  
NULL
;

4240 
	}
}

4242 
STBIDEF
 
	$¡bi_zlib_decode_noh—d”_bufãr
(*
obufãr
, 
Ş’
, cÚ¡ *
ibufãr
, 
’
)

4244 
¡bi__zbuf
 
a
;

4245 
a
.
zbufãr
 = (
¡bi_uc
 *è
ibufãr
;

4246 
a
.
zbufãr_’d
 = (
¡bi_uc
 *è
ibufãr
 + 
’
;

4247 ià(
	`¡bi__do_zlib
(&
a
, 
obufãr
, 
Ş’
, 0, 0))

4248  (è(
a
.
zout
 -‡.
zout_¡¬t
);

4251 
	}
}

4264 #iâdeà
STBI_NO_PNG


4267 
¡bi__ušt32
 
	mËngth
;

4268 
¡bi__ušt32
 
	mty³
;

4269 } 
	t¡bi__²gchunk
;

4271 
¡bi__²gchunk
 
	$¡bi__g‘_chunk_h—d”
(
¡bi__cÚ‹xt
 *
s
)

4273 
¡bi__²gchunk
 
c
;

4274 
c
.
Ëngth
 = 
	`¡bi__g‘32be
(
s
);

4275 
c
.
ty³
 = 
	`¡bi__g‘32be
(
s
);

4276  
c
;

4277 
	}
}

4279 
	$¡bi__check_²g_h—d”
(
¡bi__cÚ‹xt
 *
s
)

4281 cÚ¡ 
¡bi_uc
 
²g_sig
[8] = { 137,80,78,71,13,10,26,10 };

4282 
i
;

4283 
i
=0; i < 8; ++i)

4284 ià(
	`¡bi__g‘8
(
s
è!ğ
²g_sig
[
i
]è 
	`¡bi__”r
("bad…ng sig","Not‡ PNG");

4286 
	}
}

4290 
¡bi__cÚ‹xt
 *
	ms
;

4291 
¡bi_uc
 *
	mid©a
, *
	mex·nded
, *
	mout
;

4292 
	md•th
;

4293 } 
	t¡bi__²g
;

4297 
	mSTBI__F_nÚe
=0,

4298 
	mSTBI__F_sub
=1,

4299 
	mSTBI__F_up
=2,

4300 
	mSTBI__F_avg
=3,

4301 
	mSTBI__F_·‘h
=4,

4303 
	mSTBI__F_avg_fœ¡
,

4304 
	mSTBI__F_·‘h_fœ¡


4307 
¡bi_uc
 
	gfœ¡_row_f‹r
[5] =

4309 
STBI__F_nÚe
,

4310 
STBI__F_sub
,

4311 
STBI__F_nÚe
,

4312 
STBI__F_avg_fœ¡
,

4313 
STBI__F_·‘h_fœ¡


4316 
	$¡bi__·‘h
(
a
, 
b
, 
c
)

4318 
p
 = 
a
 + 
b
 - 
c
;

4319 
·
 = 
	`abs
(
p
-
a
);

4320 
pb
 = 
	`abs
(
p
-
b
);

4321 
pc
 = 
	`abs
(
p
-
c
);

4322 ià(
·
 <ğ
pb
 &&…¨<ğ
pc
è 
a
;

4323 ià(
pb
 <ğ
pc
è 
b
;

4324  
c
;

4325 
	}
}

4327 cÚ¡ 
¡bi_uc
 
	g¡bi__d•th_sÿË_bË
[9] = { 0, 0xff, 0x55, 0, 0x11, 0,0,0, 0x01 };

4330 
	$¡bi__ü—‹_²g_image_¿w
(
¡bi__²g
 *
a
, 
¡bi_uc
 *
¿w
, 
¡bi__ušt32
 
¿w_Ën
, 
out_n
, stbi__ušt32 
x
, stbi__ušt32 
y
, 
d•th
, 
cŞÜ
)

4332 
by‹s
 = (
d•th
 == 16? 2 : 1);

4333 
¡bi__cÚ‹xt
 *
s
 = 
a
->s;

4334 
¡bi__ušt32
 
i
,
j
,
¡ride
 = 
x
*
out_n
*
by‹s
;

4335 
¡bi__ušt32
 
img_Ën
, 
img_width_by‹s
;

4336 
k
;

4337 
img_n
 = 
s
->img_n;

4339 
ouut_by‹s
 = 
out_n
*
by‹s
;

4340 
f‹r_by‹s
 = 
img_n
*
by‹s
;

4341 
width
 = 
x
;

4343 
	`STBI_ASSERT
(
out_n
 =ğ
s
->
img_n
 || out_n == s->img_n+1);

4344 
a
->
out
 = (
¡bi_uc
 *è
	`¡bi__m®loc_mad3
(
x
, 
y
, 
ouut_by‹s
, 0);

4345 ià(!
a
->
out
è 
	`¡bi__”r
("outofmem", "Out of memory");

4347 ià(!
	`¡bi__mad3sizes_v®id
(
img_n
, 
x
, 
d•th
, 7)è 
	`¡bi__”r
("too†arge", "Corrupt PNG");

4348 
img_width_by‹s
 = (((
img_n
 * 
x
 * 
d•th
) + 7) >> 3);

4349 
img_Ën
 = (
img_width_by‹s
 + 1è* 
y
;

4354 ià(
¿w_Ën
 < 
img_Ën
è 
	`¡bi__”r
("notƒnough…ixels","Corrupt PNG");

4356 
j
=0; j < 
y
; ++j) {

4357 
¡bi_uc
 *
cur
 = 
a
->
out
 + 
¡ride
*
j
;

4358 
¡bi_uc
 *
´iÜ
;

4359 
f‹r
 = *
¿w
++;

4361 ià(
f‹r
 > 4)

4362  
	`¡bi__”r
("invalid filter","Corrupt PNG");

4364 ià(
d•th
 < 8) {

4365 
	`STBI_ASSERT
(
img_width_by‹s
 <ğ
x
);

4366 
cur
 +ğ
x
*
out_n
 - 
img_width_by‹s
;

4367 
f‹r_by‹s
 = 1;

4368 
width
 = 
img_width_by‹s
;

4370 
´iÜ
 = 
cur
 - 
¡ride
;

4373 ià(
j
 =ğ0è
f‹r
 = 
fœ¡_row_f‹r
[filter];

4376 
k
=0; k < 
f‹r_by‹s
; ++k) {

4377 
f‹r
) {

4378 
STBI__F_nÚe
 : 
cur
[
k
] = 
¿w
[k]; ;

4379 
STBI__F_sub
 : 
cur
[
k
] = 
¿w
[k]; ;

4380 
STBI__F_up
 : 
cur
[
k
] = 
	`STBI__BYTECAST
(
¿w
[k] + 
´iÜ
[k]); ;

4381 
STBI__F_avg
 : 
cur
[
k
] = 
	`STBI__BYTECAST
(
¿w
[k] + (
´iÜ
[k]>>1)); ;

4382 
STBI__F_·‘h
 : 
cur
[
k
] = 
	`STBI__BYTECAST
(
¿w
[k] + 
	`¡bi__·‘h
(0,
´iÜ
[k],0)); ;

4383 
STBI__F_avg_fœ¡
 : 
cur
[
k
] = 
¿w
[k]; ;

4384 
STBI__F_·‘h_fœ¡
: 
cur
[
k
] = 
¿w
[k]; ;

4388 ià(
d•th
 == 8) {

4389 ià(
img_n
 !ğ
out_n
)

4390 
cur
[
img_n
] = 255;

4391 
¿w
 +ğ
img_n
;

4392 
cur
 +ğ
out_n
;

4393 
´iÜ
 +ğ
out_n
;

4394 } ià(
d•th
 == 16) {

4395 ià(
img_n
 !ğ
out_n
) {

4396 
cur
[
f‹r_by‹s
] = 255;

4397 
cur
[
f‹r_by‹s
+1] = 255;

4399 
¿w
 +ğ
f‹r_by‹s
;

4400 
cur
 +ğ
ouut_by‹s
;

4401 
´iÜ
 +ğ
ouut_by‹s
;

4403 
¿w
 += 1;

4404 
cur
 += 1;

4405 
´iÜ
 += 1;

4409 ià(
d•th
 < 8 || 
img_n
 =ğ
out_n
) {

4410 
nk
 = (
width
 - 1)*
f‹r_by‹s
;

4411 
	#STBI__CASE
(
f
) \

4412 
f
: \

4413 
k
=0; k < 
nk
; ++k)

	)

4414 
f‹r
) {

4416 
STBI__F_nÚe
: 
	`memıy
(
cur
, 
¿w
, 
nk
); ;

4417 
	`STBI__CASE
(
STBI__F_sub
è{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
¿w
[k] + cur[k-
f‹r_by‹s
]); } ;

4418 
	`STBI__CASE
(
STBI__F_up
è{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
¿w
[k] + 
´iÜ
[k]); } ;

4419 
	`STBI__CASE
(
STBI__F_avg
è{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
¿w
[k] + ((
´iÜ
[k] + cur[k-
f‹r_by‹s
])>>1)); } ;

4420 
	`STBI__CASE
(
STBI__F_·‘h
è{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
¿w
[k] + 
	`¡bi__·‘h
(cur[k-
f‹r_by‹s
],
´iÜ
[k],prior[k-filter_bytes])); } ;

4421 
	`STBI__CASE
(
STBI__F_avg_fœ¡
è{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
¿w
[k] + (cur[k-
f‹r_by‹s
] >> 1)); } ;

4422 
	`STBI__CASE
(
STBI__F_·‘h_fœ¡
è{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
¿w
[k] + 
	`¡bi__·‘h
(cur[k-
f‹r_by‹s
],0,0)); } ;

4424 #undeà
STBI__CASE


4425 
¿w
 +ğ
nk
;

4427 
	`STBI_ASSERT
(
img_n
+1 =ğ
out_n
);

4428 
	#STBI__CASE
(
f
) \

4429 
f
: \

4430 
i
=
x
-1; i >ğ1; --i, 
cur
[
f‹r_by‹s
]=255,
¿w
+=f‹r_by‹s,cur+=
ouut_by‹s
,
´iÜ
+=output_bytes) \

4431 
k
=0; k < 
f‹r_by‹s
; ++k)

	)

4432 
f‹r
) {

4433 
	`STBI__CASE
(
STBI__F_nÚe
è{ 
cur
[
k
] = 
¿w
[k]; } ;

4434 
	`STBI__CASE
(
STBI__F_sub
è{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
¿w
[k] + cur[k- 
ouut_by‹s
]); } ;

4435 
	`STBI__CASE
(
STBI__F_up
è{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
¿w
[k] + 
´iÜ
[k]); } ;

4436 
	`STBI__CASE
(
STBI__F_avg
è{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
¿w
[k] + ((
´iÜ
[k] + cur[k- 
ouut_by‹s
])>>1)); } ;

4437 
	`STBI__CASE
(
STBI__F_·‘h
è{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
¿w
[k] + 
	`¡bi__·‘h
(cur[k- 
ouut_by‹s
],
´iÜ
[k],prior[k- output_bytes])); } ;

4438 
	`STBI__CASE
(
STBI__F_avg_fœ¡
è{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
¿w
[k] + (cur[k- 
ouut_by‹s
] >> 1)); } ;

4439 
	`STBI__CASE
(
STBI__F_·‘h_fœ¡
è{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
¿w
[k] + 
	`¡bi__·‘h
(cur[k- 
ouut_by‹s
],0,0)); } ;

4441 #undeà
STBI__CASE


4445 ià(
d•th
 == 16) {

4446 
cur
 = 
a
->
out
 + 
¡ride
*
j
;

4447 
i
=0; i < 
x
; ++i,
cur
+=
ouut_by‹s
) {

4448 
cur
[
f‹r_by‹s
+1] = 255;

4457 ià(
d•th
 < 8) {

4458 
j
=0; j < 
y
; ++j) {

4459 
¡bi_uc
 *
cur
 = 
a
->
out
 + 
¡ride
*
j
;

4460 
¡bi_uc
 *
š
 = 
a
->
out
 + 
¡ride
*
j
 + 
x
*
out_n
 - 
img_width_by‹s
;

4463 
¡bi_uc
 
sÿË
 = (
cŞÜ
 =ğ0è? 
¡bi__d•th_sÿË_bË
[
d•th
] : 1;

4471 ià(
d•th
 == 4) {

4472 
k
=
x
*
img_n
; k >ğ2; k-=2, ++
š
) {

4473 *
cur
++ = 
sÿË
 * ((*
š
 >> 4) );

4474 *
cur
++ = 
sÿË
 * ((*
š
 ) & 0x0f);

4476 ià(
k
 > 0è*
cur
++ = 
sÿË
 * ((*
š
 >> 4) );

4477 } ià(
d•th
 == 2) {

4478 
k
=
x
*
img_n
; k >ğ4; k-=4, ++
š
) {

4479 *
cur
++ = 
sÿË
 * ((*
š
 >> 6) );

4480 *
cur
++ = 
sÿË
 * ((*
š
 >> 4) & 0x03);

4481 *
cur
++ = 
sÿË
 * ((*
š
 >> 2) & 0x03);

4482 *
cur
++ = 
sÿË
 * ((*
š
 ) & 0x03);

4484 ià(
k
 > 0è*
cur
++ = 
sÿË
 * ((*
š
 >> 6) );

4485 ià(
k
 > 1è*
cur
++ = 
sÿË
 * ((*
š
 >> 4) & 0x03);

4486 ià(
k
 > 2è*
cur
++ = 
sÿË
 * ((*
š
 >> 2) & 0x03);

4487 } ià(
d•th
 == 1) {

4488 
k
=
x
*
img_n
; k >ğ8; k-=8, ++
š
) {

4489 *
cur
++ = 
sÿË
 * ((*
š
 >> 7) );

4490 *
cur
++ = 
sÿË
 * ((*
š
 >> 6) & 0x01);

4491 *
cur
++ = 
sÿË
 * ((*
š
 >> 5) & 0x01);

4492 *
cur
++ = 
sÿË
 * ((*
š
 >> 4) & 0x01);

4493 *
cur
++ = 
sÿË
 * ((*
š
 >> 3) & 0x01);

4494 *
cur
++ = 
sÿË
 * ((*
š
 >> 2) & 0x01);

4495 *
cur
++ = 
sÿË
 * ((*
š
 >> 1) & 0x01);

4496 *
cur
++ = 
sÿË
 * ((*
š
 ) & 0x01);

4498 ià(
k
 > 0è*
cur
++ = 
sÿË
 * ((*
š
 >> 7) );

4499 ià(
k
 > 1è*
cur
++ = 
sÿË
 * ((*
š
 >> 6) & 0x01);

4500 ià(
k
 > 2è*
cur
++ = 
sÿË
 * ((*
š
 >> 5) & 0x01);

4501 ià(
k
 > 3è*
cur
++ = 
sÿË
 * ((*
š
 >> 4) & 0x01);

4502 ià(
k
 > 4è*
cur
++ = 
sÿË
 * ((*
š
 >> 3) & 0x01);

4503 ià(
k
 > 5è*
cur
++ = 
sÿË
 * ((*
š
 >> 2) & 0x01);

4504 ià(
k
 > 6è*
cur
++ = 
sÿË
 * ((*
š
 >> 1) & 0x01);

4506 ià(
img_n
 !ğ
out_n
) {

4507 
q
;

4509 
cur
 = 
a
->
out
 + 
¡ride
*
j
;

4510 ià(
img_n
 == 1) {

4511 
q
=
x
-1; q >= 0; --q) {

4512 
cur
[
q
*2+1] = 255;

4513 
cur
[
q
*2+0] = cur[q];

4516 
	`STBI_ASSERT
(
img_n
 == 3);

4517 
q
=
x
-1; q >= 0; --q) {

4518 
cur
[
q
*4+3] = 255;

4519 
cur
[
q
*4+2] = cur[q*3+2];

4520 
cur
[
q
*4+1] = cur[q*3+1];

4521 
cur
[
q
*4+0] = cur[q*3+0];

4526 } ià(
d•th
 == 16) {

4531 
¡bi_uc
 *
cur
 = 
a
->
out
;

4532 
¡bi__ušt16
 *
cur16
 = (¡bi__ušt16*)
cur
;

4534 
i
=0; i < 
x
*
y
*
out_n
; ++i,
cur16
++,
cur
+=2) {

4535 *
cur16
 = (
cur
[0] << 8) | cur[1];

4540 
	}
}

4542 
	$¡bi__ü—‹_²g_image
(
¡bi__²g
 *
a
, 
¡bi_uc
 *
image_d©a
, 
¡bi__ušt32
 
image_d©a_Ën
, 
out_n
, 
d•th
, 
cŞÜ
, 
š‹¾aûd
)

4544 
by‹s
 = (
d•th
 == 16 ? 2 : 1);

4545 
out_by‹s
 = 
out_n
 * 
by‹s
;

4546 
¡bi_uc
 *
fš®
;

4547 
p
;

4548 ià(!
š‹¾aûd
)

4549  
	`¡bi__ü—‹_²g_image_¿w
(
a
, 
image_d©a
, 
image_d©a_Ën
, 
out_n
,‡->
s
->
img_x
,‡->s->
img_y
, 
d•th
, 
cŞÜ
);

4552 
fš®
 = (
¡bi_uc
 *è
	`¡bi__m®loc_mad3
(
a
->
s
->
img_x
,‡->s->
img_y
, 
out_by‹s
, 0);

4553 
p
=0;… < 7; ++p) {

4554 
xÜig
[] = { 0,4,0,2,0,1,0 };

4555 
yÜig
[] = { 0,0,4,0,2,0,1 };

4556 
x¥c
[] = { 8,8,4,4,2,2,1 };

4557 
y¥c
[] = { 8,8,8,4,4,2,2 };

4558 
i
,
j
,
x
,
y
;

4560 
x
 = (
a
->
s
->
img_x
 - 
xÜig
[
p
] + 
x¥c
[p]-1) / xspc[p];

4561 
y
 = (
a
->
s
->
img_y
 - 
yÜig
[
p
] + 
y¥c
[p]-1) / yspc[p];

4562 ià(
x
 && 
y
) {

4563 
¡bi__ušt32
 
img_Ën
 = ((((
a
->
s
->
img_n
 * 
x
 * 
d•th
è+ 7è>> 3è+ 1è* 
y
;

4564 ià(!
	`¡bi__ü—‹_²g_image_¿w
(
a
, 
image_d©a
, 
image_d©a_Ën
, 
out_n
, 
x
, 
y
, 
d•th
, 
cŞÜ
)) {

4565 
	`STBI_FREE
(
fš®
);

4568 
j
=0; j < 
y
; ++j) {

4569 
i
=0; i < 
x
; ++i) {

4570 
out_y
 = 
j
*
y¥c
[
p
]+
yÜig
[p];

4571 
out_x
 = 
i
*
x¥c
[
p
]+
xÜig
[p];

4572 
	`memıy
(
fš®
 + 
out_y
*
a
->
s
->
img_x
*
out_by‹s
 + 
out_x
*out_bytes,

4573 
a
->
out
 + (
j
*
x
+
i
)*
out_by‹s
, out_bytes);

4576 
	`STBI_FREE
(
a
->
out
);

4577 
image_d©a
 +ğ
img_Ën
;

4578 
image_d©a_Ën
 -ğ
img_Ën
;

4581 
a
->
out
 = 
fš®
;

4584 
	}
}

4586 
	$¡bi__compu‹_Œª¥¬’cy
(
¡bi__²g
 *
z
, 
¡bi_uc
 
tc
[3], 
out_n
)

4588 
¡bi__cÚ‹xt
 *
s
 = 
z
->s;

4589 
¡bi__ušt32
 
i
, 
pix–_couÁ
 = 
s
->
img_x
 * s->
img_y
;

4590 
¡bi_uc
 *
p
 = 
z
->
out
;

4594 
	`STBI_ASSERT
(
out_n
 == 2 || out_n == 4);

4596 ià(
out_n
 == 2) {

4597 
i
=0; i < 
pix–_couÁ
; ++i) {

4598 
p
[1] = (p[0] =ğ
tc
[0] ? 0 : 255);

4599 
p
 += 2;

4602 
i
=0; i < 
pix–_couÁ
; ++i) {

4603 ià(
p
[0] =ğ
tc
[0] &&…[1] ==c[1] &&…[2] ==c[2])

4604 
p
[3] = 0;

4605 
p
 += 4;

4609 
	}
}

4611 
	$¡bi__compu‹_Œª¥¬’cy16
(
¡bi__²g
 *
z
, 
¡bi__ušt16
 
tc
[3], 
out_n
)

4613 
¡bi__cÚ‹xt
 *
s
 = 
z
->s;

4614 
¡bi__ušt32
 
i
, 
pix–_couÁ
 = 
s
->
img_x
 * s->
img_y
;

4615 
¡bi__ušt16
 *
p
 = (¡bi__ušt16*è
z
->
out
;

4619 
	`STBI_ASSERT
(
out_n
 == 2 || out_n == 4);

4621 ià(
out_n
 == 2) {

4622 
i
 = 0; i < 
pix–_couÁ
; ++i) {

4623 
p
[1] = (p[0] =ğ
tc
[0] ? 0 : 65535);

4624 
p
 += 2;

4627 
i
 = 0; i < 
pix–_couÁ
; ++i) {

4628 ià(
p
[0] =ğ
tc
[0] &&…[1] ==c[1] &&…[2] ==c[2])

4629 
p
[3] = 0;

4630 
p
 += 4;

4634 
	}
}

4636 
	$¡bi__ex·nd_²g_·Ë‰e
(
¡bi__²g
 *
a
, 
¡bi_uc
 *
·Ë‰e
, 
Ën
, 
·l_img_n
)

4638 
¡bi__ušt32
 
i
, 
pix–_couÁ
 = 
a
->
s
->
img_x
 *‡->s->
img_y
;

4639 
¡bi_uc
 *
p
, *
‹mp_out
, *
Üig
 = 
a
->
out
;

4641 
p
 = (
¡bi_uc
 *è
	`¡bi__m®loc_mad2
(
pix–_couÁ
, 
·l_img_n
, 0);

4642 ià(
p
 =ğ
NULL
è 
	`¡bi__”r
("outofmem", "Out of memory");

4645 
‹mp_out
 = 
p
;

4647 ià(
·l_img_n
 == 3) {

4648 
i
=0; i < 
pix–_couÁ
; ++i) {

4649 
n
 = 
Üig
[
i
]*4;

4650 
p
[0] = 
·Ë‰e
[
n
 ];

4651 
p
[1] = 
·Ë‰e
[
n
+1];

4652 
p
[2] = 
·Ë‰e
[
n
+2];

4653 
p
 += 3;

4656 
i
=0; i < 
pix–_couÁ
; ++i) {

4657 
n
 = 
Üig
[
i
]*4;

4658 
p
[0] = 
·Ë‰e
[
n
 ];

4659 
p
[1] = 
·Ë‰e
[
n
+1];

4660 
p
[2] = 
·Ë‰e
[
n
+2];

4661 
p
[3] = 
·Ë‰e
[
n
+3];

4662 
p
 += 4;

4665 
	`STBI_FREE
(
a
->
out
);

4666 
a
->
out
 = 
‹mp_out
;

4668 
	`STBI_NOTUSED
(
Ën
);

4671 
	}
}

4673 
	g¡bi__uÅ»muÉly_Ú_lßd
 = 0;

4674 
	g¡bi__de_hÚe_æag
 = 0;

4676 
STBIDEF
 
	$¡bi_£t_uÅ»muÉly_Ú_lßd
(
æag_Œue_if_should_uÅ»muÉly
)

4678 
¡bi__uÅ»muÉly_Ú_lßd
 = 
æag_Œue_if_should_uÅ»muÉly
;

4679 
	}
}

4681 
STBIDEF
 
	$¡bi_cÚv”t_hÚe_²g_to_rgb
(
æag_Œue_if_should_cÚv”t
)

4683 
¡bi__de_hÚe_æag
 = 
æag_Œue_if_should_cÚv”t
;

4684 
	}
}

4686 
	$¡bi__de_hÚe
(
¡bi__²g
 *
z
)

4688 
¡bi__cÚ‹xt
 *
s
 = 
z
->s;

4689 
¡bi__ušt32
 
i
, 
pix–_couÁ
 = 
s
->
img_x
 * s->
img_y
;

4690 
¡bi_uc
 *
p
 = 
z
->
out
;

4692 ià(
s
->
img_out_n
 == 3) {

4693 
i
=0; i < 
pix–_couÁ
; ++i) {

4694 
¡bi_uc
 
t
 = 
p
[0];

4695 
p
[0] =…[2];

4696 
p
[2] = 
t
;

4697 
p
 += 3;

4700 
	`STBI_ASSERT
(
s
->
img_out_n
 == 4);

4701 ià(
¡bi__uÅ»muÉly_Ú_lßd
) {

4703 
i
=0; i < 
pix–_couÁ
; ++i) {

4704 
¡bi_uc
 
a
 = 
p
[3];

4705 
¡bi_uc
 
t
 = 
p
[0];

4706 ià(
a
) {

4707 
¡bi_uc
 
h®f
 = 
a
 / 2;

4708 
p
[0] = (p[2] * 255 + 
h®f
è/ 
a
;

4709 
p
[1] = (p[1] * 255 + 
h®f
è/ 
a
;

4710 
p
[2] = ( 
t
 * 255 + 
h®f
è/ 
a
;

4712 
p
[0] =…[2];

4713 
p
[2] = 
t
;

4715 
p
 += 4;

4719 
i
=0; i < 
pix–_couÁ
; ++i) {

4720 
¡bi_uc
 
t
 = 
p
[0];

4721 
p
[0] =…[2];

4722 
p
[2] = 
t
;

4723 
p
 += 4;

4727 
	}
}

4729 
	#STBI__PNG_TYPE
(
a
,
b
,
c
,
d
è(((è×è<< 24è+ ((è(bè<< 16è+ ((è(cè<< 8è+ (è(d))

	)

4731 
	$¡bi__·r£_²g_fe
(
¡bi__²g
 *
z
, 
sÿn
, 
»q_comp
)

4733 
¡bi_uc
 
·Ë‰e
[1024], 
·l_img_n
=0;

4734 
¡bi_uc
 
has_Œªs
=0, 
tc
[3];

4735 
¡bi__ušt16
 
tc16
[3];

4736 
¡bi__ušt32
 
ioff
=0, 
id©a_lim™
=0, 
i
, 
·l_Ën
=0;

4737 
fœ¡
=1,
k
,
š‹¾aû
=0, 
cŞÜ
=0, 
is_hÚe
=0;

4738 
¡bi__cÚ‹xt
 *
s
 = 
z
->s;

4740 
z
->
ex·nded
 = 
NULL
;

4741 
z
->
id©a
 = 
NULL
;

4742 
z
->
out
 = 
NULL
;

4744 ià(!
	`¡bi__check_²g_h—d”
(
s
))  0;

4746 ià(
sÿn
 =ğ
STBI__SCAN_ty³
)  1;

4749 
¡bi__²gchunk
 
c
 = 
	`¡bi__g‘_chunk_h—d”
(
s
);

4750 
c
.
ty³
) {

4751 
	`STBI__PNG_TYPE
('C','g','B','I'):

4752 
is_hÚe
 = 1;

4753 
	`¡bi__sk
(
s
, 
c
.
Ëngth
);

4755 
	`STBI__PNG_TYPE
('I','H','D','R'): {

4756 
comp
,
f‹r
;

4757 ià(!
fœ¡
è 
	`¡bi__”r
("multiple IHDR","Corrupt PNG");

4758 
fœ¡
 = 0;

4759 ià(
c
.
Ëngth
 !ğ13è 
	`¡bi__”r
("bad IHDR†en","Corrupt PNG");

4760 
s
->
img_x
 = 
	`¡bi__g‘32be
(s); ià(s->img_x > (1 << 24)è 
	`¡bi__”r
("too†arge","Very†arge image (corrupt?)");

4761 
s
->
img_y
 = 
	`¡bi__g‘32be
(s); ià(s->img_y > (1 << 24)è 
	`¡bi__”r
("too†arge","Very†arge image (corrupt?)");

4762 
z
->
d•th
 = 
	`¡bi__g‘8
(
s
); ià(z->d•th !ğ1 && z->d•th !ğ2 && z->d•th !ğ4 && z->d•th !ğ8 && z->d•th !ğ16è 
	`¡bi__”r
("1/2/4/8/16-bit only","PNG‚ot supported: 1/2/4/8/16-bit only");

4763 
cŞÜ
 = 
	`¡bi__g‘8
(
s
); ià(cŞÜ > 6è 
	`¡bi__”r
("bad ctype","Corrupt PNG");

4764 ià(
cŞÜ
 =ğ3 && 
z
->
d•th
 =ğ16è 
	`¡bi__”r
("bad ctype","Corrupt PNG");

4765 ià(
cŞÜ
 =ğ3è
·l_img_n
 = 3; ià(cŞÜ & 1è 
	`¡bi__”r
("bad ctype","Corrupt PNG");

4766 
comp
 = 
	`¡bi__g‘8
(
s
); ià(compè 
	`¡bi__”r
("bad comp method","Corrupt PNG");

4767 
f‹r
ğ
	`¡bi__g‘8
(
s
); ià(f‹rè 
	`¡bi__”r
("bad filter method","Corrupt PNG");

4768 
š‹¾aû
 = 
	`¡bi__g‘8
(
s
); ià(š‹¾aû>1è 
	`¡bi__”r
("bad interlace method","Corrupt PNG");

4769 ià(!
s
->
img_x
 || !s->
img_y
è 
	`¡bi__”r
("0-pixel image","Corrupt PNG");

4770 ià(!
·l_img_n
) {

4771 
s
->
img_n
 = (
cŞÜ
 & 2 ? 3 : 1) + (color & 4 ? 1 : 0);

4772 ià((1 << 30è/ 
s
->
img_x
 / s->
img_n
 < s->
img_y
è 
	`¡bi__”r
("too†arge", "Imageoo†argeo decode");

4773 ià(
sÿn
 =ğ
STBI__SCAN_h—d”
)  1;

4777 
s
->
img_n
 = 1;

4778 ià((1 << 30è/ 
s
->
img_x
 / 4 < s->
img_y
è 
	`¡bi__”r
("too†arge","Corrupt PNG");

4784 
	`STBI__PNG_TYPE
('P','L','T','E'): {

4785 ià(
fœ¡
è 
	`¡bi__”r
("first‚ot IHDR", "Corrupt PNG");

4786 ià(
c
.
Ëngth
 > 256*3è 
	`¡bi__”r
("invalid PLTE","Corrupt PNG");

4787 
·l_Ën
 = 
c
.
Ëngth
 / 3;

4788 ià(
·l_Ën
 * 3 !ğ
c
.
Ëngth
è 
	`¡bi__”r
("invalid PLTE","Corrupt PNG");

4789 
i
=0; i < 
·l_Ën
; ++i) {

4790 
·Ë‰e
[
i
*4+0] = 
	`¡bi__g‘8
(
s
);

4791 
·Ë‰e
[
i
*4+1] = 
	`¡bi__g‘8
(
s
);

4792 
·Ë‰e
[
i
*4+2] = 
	`¡bi__g‘8
(
s
);

4793 
·Ë‰e
[
i
*4+3] = 255;

4798 
	`STBI__PNG_TYPE
('t','R','N','S'): {

4799 ià(
fœ¡
è 
	`¡bi__”r
("first‚ot IHDR", "Corrupt PNG");

4800 ià(
z
->
id©a
è 
	`¡bi__”r
("tRNS‡fter IDAT","Corrupt PNG");

4801 ià(
·l_img_n
) {

4802 ià(
sÿn
 =ğ
STBI__SCAN_h—d”
è{ 
s
->
img_n
 = 4;  1; }

4803 ià(
·l_Ën
 =ğ0è 
	`¡bi__”r
("tRNS before PLTE","Corrupt PNG");

4804 ià(
c
.
Ëngth
 > 
·l_Ën
è 
	`¡bi__”r
("badRNS†en","Corrupt PNG");

4805 
·l_img_n
 = 4;

4806 
i
=0; i < 
c
.
Ëngth
; ++i)

4807 
·Ë‰e
[
i
*4+3] = 
	`¡bi__g‘8
(
s
);

4809 ià(!(
s
->
img_n
 & 1)è 
	`¡bi__”r
("tRNS with‡lpha","Corrupt PNG");

4810 ià(
c
.
Ëngth
 !ğ(
¡bi__ušt32
è
s
->
img_n
*2è 
	`¡bi__”r
("badRNS†en","Corrupt PNG");

4811 
has_Œªs
 = 1;

4812 ià(
z
->
d•th
 == 16) {

4813 
k
 = 0; k < 
s
->
img_n
; ++kè
tc16
[k] = (
¡bi__ušt16
)
	`¡bi__g‘16be
(s);

4815 
k
 = 0; k < 
s
->
img_n
; ++kè
tc
[k] = (
¡bi_uc
)(
	`¡bi__g‘16be
(sè& 255è* 
¡bi__d•th_sÿË_bË
[
z
->
d•th
];

4821 
	`STBI__PNG_TYPE
('I','D','A','T'): {

4822 ià(
fœ¡
è 
	`¡bi__”r
("first‚ot IHDR", "Corrupt PNG");

4823 ià(
·l_img_n
 && !
·l_Ën
è 
	`¡bi__”r
("no PLTE","Corrupt PNG");

4824 ià(
sÿn
 =ğ
STBI__SCAN_h—d”
è{ 
s
->
img_n
 = 
·l_img_n
;  1; }

4825 ià(()(
ioff
 + 
c
.
Ëngth
) < ()ioff)  0;

4826 ià(
ioff
 + 
c
.
Ëngth
 > 
id©a_lim™
) {

4827 
¡bi__ušt32
 
id©a_lim™_Şd
 = 
id©a_lim™
;

4828 
¡bi_uc
 *
p
;

4829 ià(
id©a_lim™
 =ğ0èid©a_lim™ = 
c
.
Ëngth
 > 4096 ? c.length : 4096;

4830 
ioff
 + 
c
.
Ëngth
 > 
id©a_lim™
)

4831 
id©a_lim™
 *= 2;

4832 
	`STBI_NOTUSED
(
id©a_lim™_Şd
);

4833 
p
 = (
¡bi_uc
 *è
	`STBI_REALLOC_SIZED
(
z
->
id©a
, 
id©a_lim™_Şd
, 
id©a_lim™
); iàÕ =ğ
NULL
è 
	`¡bi__”r
("outofmem", "Out of memory");

4834 
z
->
id©a
 = 
p
;

4836 ià(!
	`¡bi__g‘n
(
s
, 
z
->
id©a
+
ioff
,
c
.
Ëngth
)è 
	`¡bi__”r
("outofdata","Corrupt PNG");

4837 
ioff
 +ğ
c
.
Ëngth
;

4841 
	`STBI__PNG_TYPE
('I','E','N','D'): {

4842 
¡bi__ušt32
 
¿w_Ën
, 
b¶
;

4843 ià(
fœ¡
è 
	`¡bi__”r
("first‚ot IHDR", "Corrupt PNG");

4844 ià(
sÿn
 !ğ
STBI__SCAN_lßd
)  1;

4845 ià(
z
->
id©a
 =ğ
NULL
è 
	`¡bi__”r
("no IDAT","Corrupt PNG");

4847 
b¶
 = (
s
->
img_x
 * 
z
->
d•th
 + 7) / 8;

4848 
¿w_Ën
 = 
b¶
 * 
s
->
img_y
 * s->
img_n
 + s->img_y ;

4849 
z
->
ex·nded
 = (
¡bi_uc
 *è
	`¡bi_zlib_decode_m®loc_guesssize_h—d”æag
((*èz->
id©a
, 
ioff
, 
¿w_Ën
, (*è&¿w_Ën, !
is_hÚe
);

4850 ià(
z
->
ex·nded
 =ğ
NULL
)  0;

4851 
	`STBI_FREE
(
z
->
id©a
); z->id©¨ğ
NULL
;

4852 ià((
»q_comp
 =ğ
s
->
img_n
+1 &&„eq_com°!ğ3 && !
·l_img_n
è|| 
has_Œªs
)

4853 
s
->
img_out_n
 = s->
img_n
+1;

4855 
s
->
img_out_n
 = s->
img_n
;

4856 ià(!
	`¡bi__ü—‹_²g_image
(
z
, z->
ex·nded
, 
¿w_Ën
, 
s
->
img_out_n
, z->
d•th
, 
cŞÜ
, 
š‹¾aû
))  0;

4857 ià(
has_Œªs
) {

4858 ià(
z
->
d•th
 == 16) {

4859 ià(!
	`¡bi__compu‹_Œª¥¬’cy16
(
z
, 
tc16
, 
s
->
img_out_n
))  0;

4861 ià(!
	`¡bi__compu‹_Œª¥¬’cy
(
z
, 
tc
, 
s
->
img_out_n
))  0;

4864 ià(
is_hÚe
 && 
¡bi__de_hÚe_æag
 && 
s
->
img_out_n
 > 2)

4865 
	`¡bi__de_hÚe
(
z
);

4866 ià(
·l_img_n
) {

4868 
s
->
img_n
 = 
·l_img_n
;

4869 
s
->
img_out_n
 = 
·l_img_n
;

4870 ià(
»q_comp
 >ğ3è
s
->
img_out_n
 =„eq_comp;

4871 ià(!
	`¡bi__ex·nd_²g_·Ë‰e
(
z
, 
·Ë‰e
, 
·l_Ën
, 
s
->
img_out_n
))

4873 } ià(
has_Œªs
) {

4875 ++
s
->
img_n
;

4877 
	`STBI_FREE
(
z
->
ex·nded
); z->ex·nded = 
NULL
;

4883 ià(
fœ¡
è 
	`¡bi__”r
("first‚ot IHDR", "Corrupt PNG");

4884 ià((
c
.
ty³
 & (1 << 29)) == 0) {

4885 #iâdeà
STBI_NO_FAILURE_STRINGS


4887 
šv®id_chunk
[] = "XXXX PNG chunk‚ot known";

4888 
šv®id_chunk
[0] = 
	`STBI__BYTECAST
(
c
.
ty³
 >> 24);

4889 
šv®id_chunk
[1] = 
	`STBI__BYTECAST
(
c
.
ty³
 >> 16);

4890 
šv®id_chunk
[2] = 
	`STBI__BYTECAST
(
c
.
ty³
 >> 8);

4891 
šv®id_chunk
[3] = 
	`STBI__BYTECAST
(
c
.
ty³
 >> 0);

4893  
	`¡bi__”r
(
šv®id_chunk
, "PNG‚ot supported: unknown PNG chunkype");

4895 
	`¡bi__sk
(
s
, 
c
.
Ëngth
);

4899 
	`¡bi__g‘32be
(
s
);

4901 
	}
}

4903 *
	$¡bi__do_²g
(
¡bi__²g
 *
p
, *
x
, *
y
, *
n
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
)

4905 *
»suÉ
=
NULL
;

4906 ià(
»q_comp
 < 0 ||„eq_com°> 4è 
	`¡bi__”½uc
("bad„eq_comp", "Internalƒrror");

4907 ià(
	`¡bi__·r£_²g_fe
(
p
, 
STBI__SCAN_lßd
, 
»q_comp
)) {

4908 ià(
p
->
d•th
 < 8)

4909 
ri
->
b™s_³r_chªÃl
 = 8;

4911 
ri
->
b™s_³r_chªÃl
 = 
p
->
d•th
;

4912 
»suÉ
 = 
p
->
out
;

4913 
p
->
out
 = 
NULL
;

4914 ià(
»q_comp
 &&„eq_com°!ğ
p
->
s
->
img_out_n
) {

4915 ià(
ri
->
b™s_³r_chªÃl
 == 8)

4916 
»suÉ
 = 
	`¡bi__cÚv”t_fÜm©
((*è»suÉ, 
p
->
s
->
img_out_n
, 
»q_comp
,…->s->
img_x
,…->s->
img_y
);

4918 
»suÉ
 = 
	`¡bi__cÚv”t_fÜm©16
((
¡bi__ušt16
 *è»suÉ, 
p
->
s
->
img_out_n
, 
»q_comp
,…->s->
img_x
,…->s->
img_y
);

4919 
p
->
s
->
img_out_n
 = 
»q_comp
;

4920 ià(
»suÉ
 =ğ
NULL
) „esult;

4922 *
x
 = 
p
->
s
->
img_x
;

4923 *
y
 = 
p
->
s
->
img_y
;

4924 ià(
n
è*Àğ
p
->
s
->
img_n
;

4926 
	`STBI_FREE
(
p
->
out
);…->ouˆğ
NULL
;

4927 
	`STBI_FREE
(
p
->
ex·nded
);…->ex·nded = 
NULL
;

4928 
	`STBI_FREE
(
p
->
id©a
);…->id©¨ğ
NULL
;

4930  
»suÉ
;

4931 
	}
}

4933 *
	$¡bi__²g_lßd
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
)

4935 
¡bi__²g
 
p
;

4936 
p
.
s
 = s;

4937  
	`¡bi__do_²g
(&
p
, 
x
,
y
,
comp
,
»q_comp
, 
ri
);

4938 
	}
}

4940 
	$¡bi__²g_‹¡
(
¡bi__cÚ‹xt
 *
s
)

4942 
r
;

4943 
r
 = 
	`¡bi__check_²g_h—d”
(
s
);

4944 
	`¡bi__»wšd
(
s
);

4945  
r
;

4946 
	}
}

4948 
	$¡bi__²g_šfo_¿w
(
¡bi__²g
 *
p
, *
x
, *
y
, *
comp
)

4950 ià(!
	`¡bi__·r£_²g_fe
(
p
, 
STBI__SCAN_h—d”
, 0)) {

4951 
	`¡bi__»wšd
Ğ
p
->
s
 );

4954 ià(
x
è*x = 
p
->
s
->
img_x
;

4955 ià(
y
è*y = 
p
->
s
->
img_y
;

4956 ià(
comp
è*com°ğ
p
->
s
->
img_n
;

4958 
	}
}

4960 
	$¡bi__²g_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
)

4962 
¡bi__²g
 
p
;

4963 
p
.
s
 = s;

4964  
	`¡bi__²g_šfo_¿w
(&
p
, 
x
, 
y
, 
comp
);

4965 
	}
}

4967 
	$¡bi__²g_is16
(
¡bi__cÚ‹xt
 *
s
)

4969 
¡bi__²g
 
p
;

4970 
p
.
s
 = s;

4971 ià(!
	`¡bi__²g_šfo_¿w
(&
p
, 
NULL
, NULL, NULL))

4973 ià(
p
.
d•th
 != 16) {

4974 
	`¡bi__»wšd
(
p
.
s
);

4978 
	}
}

4983 #iâdeà
STBI_NO_BMP


4984 
	$¡bi__bmp_‹¡_¿w
(
¡bi__cÚ‹xt
 *
s
)

4986 
r
;

4987 
sz
;

4988 ià(
	`¡bi__g‘8
(
s
) != 'B')  0;

4989 ià(
	`¡bi__g‘8
(
s
) != 'M')  0;

4990 
	`¡bi__g‘32Ë
(
s
);

4991 
	`¡bi__g‘16Ë
(
s
);

4992 
	`¡bi__g‘16Ë
(
s
);

4993 
	`¡bi__g‘32Ë
(
s
);

4994 
sz
 = 
	`¡bi__g‘32Ë
(
s
);

4995 
r
 = (
sz
 == 12 || sz == 40 || sz == 56 || sz == 108 || sz == 124);

4996  
r
;

4997 
	}
}

4999 
	$¡bi__bmp_‹¡
(
¡bi__cÚ‹xt
 *
s
)

5001 
r
 = 
	`¡bi__bmp_‹¡_¿w
(
s
);

5002 
	`¡bi__»wšd
(
s
);

5003  
r
;

5004 
	}
}

5008 
	$¡bi__high_b™
(
z
)

5010 
n
=0;

5011 ià(
z
 == 0)  -1;

5012 ià(
z
 >ğ0x10000è
n
 += 16, z >>= 16;

5013 ià(
z
 >ğ0x00100è
n
 += 8, z >>= 8;

5014 ià(
z
 >ğ0x00010è
n
 += 4, z >>= 4;

5015 ià(
z
 >ğ0x00004è
n
 += 2, z >>= 2;

5016 ià(
z
 >ğ0x00002è
n
 += 1, z >>= 1;

5017  
n
;

5018 
	}
}

5020 
	$¡bi__b™couÁ
(
a
)

5022 
a
 = (a & 0x55555555) + ((a >> 1) & 0x55555555);

5023 
a
 = (a & 0x33333333) + ((a >> 2) & 0x33333333);

5024 
a
 = (a + (a >> 4)) & 0x0f0f0f0f;

5025 
a
 = (a + (a >> 8));

5026 
a
 = (a + (a >> 16));

5027  
a
 & 0xff;

5028 
	}
}

5033 
	$¡bi__shiásigÃd
(
v
, 
shiá
, 
b™s
)

5035 
mul_bË
[9] = {

5040 
shiá_bË
[9] = {

5043 ià(
shiá
 < 0)

5044 
v
 <<ğ-
shiá
;

5046 
v
 >>ğ
shiá
;

5047 
	`STBI_ASSERT
(
v
 >= 0 && v < 256);

5048 
v
 >>ğ(8-
b™s
);

5049 
	`STBI_ASSERT
(
b™s
 >= 0 && bits <= 8);

5050  (è((è
v
 * 
mul_bË
[
b™s
]è>> 
shiá_bË
[bits];

5051 
	}
}

5055 
	mbµ
, 
	moff£t
, 
	mhsz
;

5056 
	mmr
,
	mmg
,
	mmb
,
	mma
, 
	m®l_a
;

5057 } 
	t¡bi__bmp_d©a
;

5059 *
	$¡bi__bmp_·r£_h—d”
(
¡bi__cÚ‹xt
 *
s
, 
¡bi__bmp_d©a
 *
šfo
)

5061 
hsz
;

5062 ià(
	`¡bi__g‘8
(
s
è!ğ'B' || stbi__g‘8(sè!ğ'M'è 
	`¡bi__”½uc
("not BMP", "Corrupt BMP");

5063 
	`¡bi__g‘32Ë
(
s
);

5064 
	`¡bi__g‘16Ë
(
s
);

5065 
	`¡bi__g‘16Ë
(
s
);

5066 
šfo
->
off£t
 = 
	`¡bi__g‘32Ë
(
s
);

5067 
šfo
->
hsz
 = hsz = 
	`¡bi__g‘32Ë
(
s
);

5068 
šfo
->
mr
 = info->
mg
 = info->
mb
 = info->
ma
 = 0;

5070 ià(
hsz
 !ğ12 && hsz !ğ40 && hsz !ğ56 && hsz !ğ108 && hsz !ğ124è 
	`¡bi__”½uc
("unknown BMP", "BMPype‚ot supported: unknown");

5071 ià(
hsz
 == 12) {

5072 
s
->
img_x
 = 
	`¡bi__g‘16Ë
(s);

5073 
s
->
img_y
 = 
	`¡bi__g‘16Ë
(s);

5075 
s
->
img_x
 = 
	`¡bi__g‘32Ë
(s);

5076 
s
->
img_y
 = 
	`¡bi__g‘32Ë
(s);

5078 ià(
	`¡bi__g‘16Ë
(
s
è!ğ1è 
	`¡bi__”½uc
("bad BMP", "bad BMP");

5079 
šfo
->
bµ
 = 
	`¡bi__g‘16Ë
(
s
);

5080 ià(
hsz
 != 12) {

5081 
com´ess
 = 
	`¡bi__g‘32Ë
(
s
);

5082 ià(
com´ess
 =ğ1 || com´es =ğ2è 
	`¡bi__”½uc
("BMP RLE", "BMPype‚ot supported: RLE");

5083 
	`¡bi__g‘32Ë
(
s
);

5084 
	`¡bi__g‘32Ë
(
s
);

5085 
	`¡bi__g‘32Ë
(
s
);

5086 
	`¡bi__g‘32Ë
(
s
);

5087 
	`¡bi__g‘32Ë
(
s
);

5088 ià(
hsz
 == 40 || hsz == 56) {

5089 ià(
hsz
 == 56) {

5090 
	`¡bi__g‘32Ë
(
s
);

5091 
	`¡bi__g‘32Ë
(
s
);

5092 
	`¡bi__g‘32Ë
(
s
);

5093 
	`¡bi__g‘32Ë
(
s
);

5095 ià(
šfo
->
bµ
 == 16 || info->bpp == 32) {

5096 ià(
com´ess
 == 0) {

5097 ià(
šfo
->
bµ
 == 32) {

5098 
šfo
->
mr
 = 0xffu << 16;

5099 
šfo
->
mg
 = 0xffu << 8;

5100 
šfo
->
mb
 = 0xffu << 0;

5101 
šfo
->
ma
 = 0xffu << 24;

5102 
šfo
->
®l_a
 = 0;

5104 
šfo
->
mr
 = 31u << 10;

5105 
šfo
->
mg
 = 31u << 5;

5106 
šfo
->
mb
 = 31u << 0;

5108 } ià(
com´ess
 == 3) {

5109 
šfo
->
mr
 = 
	`¡bi__g‘32Ë
(
s
);

5110 
šfo
->
mg
 = 
	`¡bi__g‘32Ë
(
s
);

5111 
šfo
->
mb
 = 
	`¡bi__g‘32Ë
(
s
);

5113 ià(
šfo
->
mr
 =ğšfo->
mg
 && info->mg =ğšfo->
mb
) {

5115  
	`¡bi__”½uc
("bad BMP", "bad BMP");

5118  
	`¡bi__”½uc
("bad BMP", "bad BMP");

5121 
i
;

5122 ià(
hsz
 != 108 && hsz != 124)

5123  
	`¡bi__”½uc
("bad BMP", "bad BMP");

5124 
šfo
->
mr
 = 
	`¡bi__g‘32Ë
(
s
);

5125 
šfo
->
mg
 = 
	`¡bi__g‘32Ë
(
s
);

5126 
šfo
->
mb
 = 
	`¡bi__g‘32Ë
(
s
);

5127 
šfo
->
ma
 = 
	`¡bi__g‘32Ë
(
s
);

5128 
	`¡bi__g‘32Ë
(
s
);

5129 
i
=0; i < 12; ++i)

5130 
	`¡bi__g‘32Ë
(
s
);

5131 ià(
hsz
 == 124) {

5132 
	`¡bi__g‘32Ë
(
s
);

5133 
	`¡bi__g‘32Ë
(
s
);

5134 
	`¡bi__g‘32Ë
(
s
);

5135 
	`¡bi__g‘32Ë
(
s
);

5140 
	}
}

5143 *
	$¡bi__bmp_lßd
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
)

5145 
¡bi_uc
 *
out
;

5146 
mr
=0,
mg
=0,
mb
=0,
ma
=0, 
®l_a
;

5147 
¡bi_uc
 
·l
[256][4];

5148 
psize
=0,
i
,
j
,
width
;

5149 
æ_v”tiÿÎy
, 
·d
, 
rg‘
;

5150 
¡bi__bmp_d©a
 
šfo
;

5151 
	`STBI_NOTUSED
(
ri
);

5153 
šfo
.
®l_a
 = 255;

5154 ià(
	`¡bi__bmp_·r£_h—d”
(
s
, &
šfo
è=ğ
NULL
)

5155  
NULL
;

5157 
æ_v”tiÿÎy
 = ((è
s
->
img_y
) > 0;

5158 
s
->
img_y
 = 
	`abs
(() s->img_y);

5160 
mr
 = 
šfo
.mr;

5161 
mg
 = 
šfo
.mg;

5162 
mb
 = 
šfo
.mb;

5163 
ma
 = 
šfo
.ma;

5164 
®l_a
 = 
šfo
.all_a;

5166 ià(
šfo
.
hsz
 == 12) {

5167 ià(
šfo
.
bµ
 < 24)

5168 
psize
 = (
šfo
.
off£t
 - 14 - 24) / 3;

5170 ià(
šfo
.
bµ
 < 16)

5171 
psize
 = (
šfo
.
off£t
 - 14 - info.
hsz
) >> 2;

5174 
s
->
img_n
 = 
ma
 ? 4 : 3;

5175 ià(
»q_comp
 &&„eq_comp >= 3)

5176 
rg‘
 = 
»q_comp
;

5178 
rg‘
 = 
s
->
img_n
;

5181 ià(!
	`¡bi__mad3sizes_v®id
(
rg‘
, 
s
->
img_x
, s->
img_y
, 0))

5182  
	`¡bi__”½uc
("too†arge", "Corrupt BMP");

5184 
out
 = (
¡bi_uc
 *è
	`¡bi__m®loc_mad3
(
rg‘
, 
s
->
img_x
, s->
img_y
, 0);

5185 ià(!
out
è 
	`¡bi__”½uc
("outofmem", "Out of memory");

5186 ià(
šfo
.
bµ
 < 16) {

5187 
z
=0;

5188 ià(
psize
 =ğ0 ||…siz> 256è{ 
	`STBI_FREE
(
out
);  
	`¡bi__”½uc
("invalid", "Corrupt BMP"); }

5189 
i
=0; i < 
psize
; ++i) {

5190 
·l
[
i
][2] = 
	`¡bi__g‘8
(
s
);

5191 
·l
[
i
][1] = 
	`¡bi__g‘8
(
s
);

5192 
·l
[
i
][0] = 
	`¡bi__g‘8
(
s
);

5193 ià(
šfo
.
hsz
 !ğ12è
	`¡bi__g‘8
(
s
);

5194 
·l
[
i
][3] = 255;

5196 
	`¡bi__sk
(
s
, 
šfo
.
off£t
 - 14 - info.
hsz
 - 
psize
 * (info.hsz == 12 ? 3 : 4));

5197 ià(
šfo
.
bµ
 =ğ1è
width
 = (
s
->
img_x
 + 7) >> 3;

5198 ià(
šfo
.
bµ
 =ğ4è
width
 = (
s
->
img_x
 + 1) >> 1;

5199 ià(
šfo
.
bµ
 =ğ8è
width
 = 
s
->
img_x
;

5200 { 
	`STBI_FREE
(
out
);  
	`¡bi__”½uc
("bad bpp", "Corrupt BMP"); }

5201 
·d
 = (-
width
)&3;

5202 ià(
šfo
.
bµ
 == 1) {

5203 
j
=0; j < (è
s
->
img_y
; ++j) {

5204 
b™_off£t
 = 7, 
v
 = 
	`¡bi__g‘8
(
s
);

5205 
i
=0; i < (è
s
->
img_x
; ++i) {

5206 
cŞÜ
 = (
v
>>
b™_off£t
)&0x1;

5207 
out
[
z
++] = 
·l
[
cŞÜ
][0];

5208 
out
[
z
++] = 
·l
[
cŞÜ
][1];

5209 
out
[
z
++] = 
·l
[
cŞÜ
][2];

5210 if((--
b™_off£t
) < 0) {

5211 
b™_off£t
 = 7;

5212 
v
 = 
	`¡bi__g‘8
(
s
);

5215 
	`¡bi__sk
(
s
, 
·d
);

5218 
j
=0; j < (è
s
->
img_y
; ++j) {

5219 
i
=0; i < (è
s
->
img_x
; i += 2) {

5220 
v
=
	`¡bi__g‘8
(
s
),
v2
=0;

5221 ià(
šfo
.
bµ
 == 4) {

5222 
v2
 = 
v
 & 15;

5223 
v
 >>= 4;

5225 
out
[
z
++] = 
·l
[
v
][0];

5226 
out
[
z
++] = 
·l
[
v
][1];

5227 
out
[
z
++] = 
·l
[
v
][2];

5228 ià(
rg‘
 =ğ4è
out
[
z
++] = 255;

5229 ià(
i
+1 =ğ(è
s
->
img_x
) ;

5230 
v
 = (
šfo
.
bµ
 =ğ8è? 
	`¡bi__g‘8
(
s
è: 
v2
;

5231 
out
[
z
++] = 
·l
[
v
][0];

5232 
out
[
z
++] = 
·l
[
v
][1];

5233 
out
[
z
++] = 
·l
[
v
][2];

5234 ià(
rg‘
 =ğ4è
out
[
z
++] = 255;

5236 
	`¡bi__sk
(
s
, 
·d
);

5240 
rshiá
=0,
gshiá
=0,
bshiá
=0,
ashiá
=0,
rcouÁ
=0,
gcouÁ
=0,
bcouÁ
=0,
acouÁ
=0;

5241 
z
 = 0;

5242 
—sy
=0;

5243 
	`¡bi__sk
(
s
, 
šfo
.
off£t
 - 14 - info.
hsz
);

5244 ià(
šfo
.
bµ
 =ğ24è
width
 = 3 * 
s
->
img_x
;

5245 ià(
šfo
.
bµ
 =ğ16è
width
 = 2*
s
->
img_x
;

5246 
width
=0;

5247 
·d
 = (-
width
) & 3;

5248 ià(
šfo
.
bµ
 == 24) {

5249 
—sy
 = 1;

5250 } ià(
šfo
.
bµ
 == 32) {

5251 ià(
mb
 =ğ0xfà&& 
mg
 =ğ0xff00 && 
mr
 =ğ0x00ff0000 && 
ma
 == 0xff000000)

5252 
—sy
 = 2;

5254 ià(!
—sy
) {

5255 ià(!
mr
 || !
mg
 || !
mb
è{ 
	`STBI_FREE
(
out
);  
	`¡bi__”½uc
("bad masks", "Corrupt BMP"); }

5257 
rshiá
 = 
	`¡bi__high_b™
(
mr
)-7; 
rcouÁ
 = 
	`¡bi__b™couÁ
(mr);

5258 
gshiá
 = 
	`¡bi__high_b™
(
mg
)-7; 
gcouÁ
 = 
	`¡bi__b™couÁ
(mg);

5259 
bshiá
 = 
	`¡bi__high_b™
(
mb
)-7; 
bcouÁ
 = 
	`¡bi__b™couÁ
(mb);

5260 
ashiá
 = 
	`¡bi__high_b™
(
ma
)-7; 
acouÁ
 = 
	`¡bi__b™couÁ
(ma);

5262 
j
=0; j < (è
s
->
img_y
; ++j) {

5263 ià(
—sy
) {

5264 
i
=0; i < (è
s
->
img_x
; ++i) {

5265 
a
;

5266 
out
[
z
+2] = 
	`¡bi__g‘8
(
s
);

5267 
out
[
z
+1] = 
	`¡bi__g‘8
(
s
);

5268 
out
[
z
+0] = 
	`¡bi__g‘8
(
s
);

5269 
z
 += 3;

5270 
a
 = (
—sy
 =ğ2 ? 
	`¡bi__g‘8
(
s
) : 255);

5271 
®l_a
 |ğ
a
;

5272 ià(
rg‘
 =ğ4è
out
[
z
++] = 
a
;

5275 
bµ
 = 
šfo
.bpp;

5276 
i
=0; i < (è
s
->
img_x
; ++i) {

5277 
¡bi__ušt32
 
v
 = (
bµ
 =ğ16 ? (¡bi__ušt32è
	`¡bi__g‘16Ë
(
s
è: 
	`¡bi__g‘32Ë
(s));

5278 
a
;

5279 
out
[
z
++] = 
	`STBI__BYTECAST
(
	`¡bi__shiásigÃd
(
v
 & 
mr
, 
rshiá
, 
rcouÁ
));

5280 
out
[
z
++] = 
	`STBI__BYTECAST
(
	`¡bi__shiásigÃd
(
v
 & 
mg
, 
gshiá
, 
gcouÁ
));

5281 
out
[
z
++] = 
	`STBI__BYTECAST
(
	`¡bi__shiásigÃd
(
v
 & 
mb
, 
bshiá
, 
bcouÁ
));

5282 
a
 = (
ma
 ? 
	`¡bi__shiásigÃd
(
v
 & ma, 
ashiá
, 
acouÁ
) : 255);

5283 
®l_a
 |ğ
a
;

5284 ià(
rg‘
 =ğ4è
out
[
z
++] = 
	`STBI__BYTECAST
(
a
);

5287 
	`¡bi__sk
(
s
, 
·d
);

5292 ià(
rg‘
 =ğ4 && 
®l_a
 == 0)

5293 
i
=4*
s
->
img_x
*s->
img_y
-1; i >= 0; i -= 4)

5294 
out
[
i
] = 255;

5296 ià(
æ_v”tiÿÎy
) {

5297 
¡bi_uc
 
t
;

5298 
j
=0; j < (è
s
->
img_y
>>1; ++j) {

5299 
¡bi_uc
 *
p1
 = 
out
 + 
j
 *
s
->
img_x
*
rg‘
;

5300 
¡bi_uc
 *
p2
 = 
out
 + (
s
->
img_y
-1-
j
)*s->
img_x
*
rg‘
;

5301 
i
=0; i < (è
s
->
img_x
*
rg‘
; ++i) {

5302 
t
 = 
p1
[
i
],…1[i] = 
p2
[i],…2[i] =;

5307 ià(
»q_comp
 &&„eq_com°!ğ
rg‘
) {

5308 
out
 = 
	`¡bi__cÚv”t_fÜm©
(out, 
rg‘
, 
»q_comp
, 
s
->
img_x
, s->
img_y
);

5309 ià(
out
 =ğ
NULL
)  out;

5312 *
x
 = 
s
->
img_x
;

5313 *
y
 = 
s
->
img_y
;

5314 ià(
comp
è*com°ğ
s
->
img_n
;

5315  
out
;

5316 
	}
}

5321 #iâdeà
STBI_NO_TGA


5323 
	$¡bi__tga_g‘_comp
(
b™s_³r_pix–
, 
is_g»y
, * 
is_rgb16
)

5326 ià(
is_rgb16
) *is_rgb16 = 0;

5327 
b™s_³r_pix–
) {

5328 8:  
STBI_g»y
;

5329 16: if(
is_g»y
è 
STBI_g»y_®pha
;

5331 15: if(
is_rgb16
) *is_rgb16 = 1;

5332  
STBI_rgb
;

5334 32:  
b™s_³r_pix–
/8;

5337 
	}
}

5339 
	$¡bi__tga_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
)

5341 
tga_w
, 
tga_h
, 
tga_comp
, 
tga_image_ty³
, 
tga_b™s_³r_pix–
, 
tga_cŞÜm­_bµ
;

5342 
sz
, 
tga_cŞÜm­_ty³
;

5343 
	`¡bi__g‘8
(
s
);

5344 
tga_cŞÜm­_ty³
 = 
	`¡bi__g‘8
(
s
);

5345 ifĞ
tga_cŞÜm­_ty³
 > 1 ) {

5346 
	`¡bi__»wšd
(
s
);

5349 
tga_image_ty³
 = 
	`¡bi__g‘8
(
s
);

5350 iàĞ
tga_cŞÜm­_ty³
 == 1 ) {

5351 ià(
tga_image_ty³
 != 1 &&ga_image_type != 9) {

5352 
	`¡bi__»wšd
(
s
);

5355 
	`¡bi__sk
(
s
,4);

5356 
sz
 = 
	`¡bi__g‘8
(
s
);

5357 iàĞ(
sz
 != 8) && (sz != 15) && (sz != 16) && (sz != 24) && (sz != 32) ) {

5358 
	`¡bi__»wšd
(
s
);

5361 
	`¡bi__sk
(
s
,4);

5362 
tga_cŞÜm­_bµ
 = 
sz
;

5364 iàĞ(
tga_image_ty³
 != 2) && (tga_image_type != 3) && (tga_image_type != 10) && (tga_image_type != 11) ) {

5365 
	`¡bi__»wšd
(
s
);

5368 
	`¡bi__sk
(
s
,9);

5369 
tga_cŞÜm­_bµ
 = 0;

5371 
tga_w
 = 
	`¡bi__g‘16Ë
(
s
);

5372 ifĞ
tga_w
 < 1 ) {

5373 
	`¡bi__»wšd
(
s
);

5376 
tga_h
 = 
	`¡bi__g‘16Ë
(
s
);

5377 ifĞ
tga_h
 < 1 ) {

5378 
	`¡bi__»wšd
(
s
);

5381 
tga_b™s_³r_pix–
 = 
	`¡bi__g‘8
(
s
);

5382 
	`¡bi__g‘8
(
s
);

5383 ià(
tga_cŞÜm­_bµ
 != 0) {

5384 if((
tga_b™s_³r_pix–
 != 8) && (tga_bits_per_pixel != 16)) {

5387 
	`¡bi__»wšd
(
s
);

5390 
tga_comp
 = 
	`¡bi__tga_g‘_comp
(
tga_cŞÜm­_bµ
, 0, 
NULL
);

5392 
tga_comp
 = 
	`¡bi__tga_g‘_comp
(
tga_b™s_³r_pix–
, (
tga_image_ty³
 =ğ3è|| (tga_image_ty³ =ğ11), 
NULL
);

5394 if(!
tga_comp
) {

5395 
	`¡bi__»wšd
(
s
);

5398 ià(
x
è*x = 
tga_w
;

5399 ià(
y
è*y = 
tga_h
;

5400 ià(
comp
è*com°ğ
tga_comp
;

5402 
	}
}

5404 
	$¡bi__tga_‹¡
(
¡bi__cÚ‹xt
 *
s
)

5406 
»s
 = 0;

5407 
sz
, 
tga_cŞÜ_ty³
;

5408 
	`¡bi__g‘8
(
s
);

5409 
tga_cŞÜ_ty³
 = 
	`¡bi__g‘8
(
s
);

5410 iàĞ
tga_cŞÜ_ty³
 > 1 ) 
”rÜEnd
;

5411 
sz
 = 
	`¡bi__g‘8
(
s
);

5412 iàĞ
tga_cŞÜ_ty³
 == 1 ) {

5413 ià(
sz
 !ğ1 && sz !ğ9è
”rÜEnd
;

5414 
	`¡bi__sk
(
s
,4);

5415 
sz
 = 
	`¡bi__g‘8
(
s
);

5416 iàĞ(
sz
 !ğ8è&& (sz !ğ15è&& (sz !ğ16è&& (sz !ğ24è&& (sz !ğ32èè
”rÜEnd
;

5417 
	`¡bi__sk
(
s
,4);

5419 iàĞ(
sz
 !ğ2è&& (sz !ğ3è&& (sz !ğ10è&& (sz !ğ11èè
”rÜEnd
;

5420 
	`¡bi__sk
(
s
,9);

5422 iàĞ
	`¡bi__g‘16Ë
(
s
è< 1 ) 
”rÜEnd
;

5423 iàĞ
	`¡bi__g‘16Ë
(
s
è< 1 ) 
”rÜEnd
;

5424 
sz
 = 
	`¡bi__g‘8
(
s
);

5425 iàĞ(
tga_cŞÜ_ty³
 =ğ1è&& (
sz
 !ğ8è&& (sz !ğ16èè
”rÜEnd
;

5426 iàĞ(
sz
 !ğ8è&& (sz !ğ15è&& (sz !ğ16è&& (sz !ğ24è&& (sz !ğ32èè
”rÜEnd
;

5428 
»s
 = 1;

5430 
”rÜEnd
:

5431 
	`¡bi__»wšd
(
s
);

5432  
»s
;

5433 
	}
}

5436 
	$¡bi__tga_»ad_rgb16
(
¡bi__cÚ‹xt
 *
s
, 
¡bi_uc
* 
out
)

5438 
¡bi__ušt16
 
px
 = (¡bi__ušt16)
	`¡bi__g‘16Ë
(
s
);

5439 
¡bi__ušt16
 
fiveB™Mask
 = 31;

5441 
r
 = (
px
 >> 10è& 
fiveB™Mask
;

5442 
g
 = (
px
 >> 5è& 
fiveB™Mask
;

5443 
b
 = 
px
 & 
fiveB™Mask
;

5445 
out
[0] = (
¡bi_uc
)((
r
 * 255)/31);

5446 
out
[1] = (
¡bi_uc
)((
g
 * 255)/31);

5447 
out
[2] = (
¡bi_uc
)((
b
 * 255)/31);

5453 
	}
}

5455 *
	$¡bi__tga_lßd
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
)

5458 
tga_off£t
 = 
	`¡bi__g‘8
(
s
);

5459 
tga_šdexed
 = 
	`¡bi__g‘8
(
s
);

5460 
tga_image_ty³
 = 
	`¡bi__g‘8
(
s
);

5461 
tga_is_RLE
 = 0;

5462 
tga_·Ë‰e_¡¬t
 = 
	`¡bi__g‘16Ë
(
s
);

5463 
tga_·Ë‰e_Ën
 = 
	`¡bi__g‘16Ë
(
s
);

5464 
tga_·Ë‰e_b™s
 = 
	`¡bi__g‘8
(
s
);

5465 
tga_x_Üigš
 = 
	`¡bi__g‘16Ë
(
s
);

5466 
tga_y_Üigš
 = 
	`¡bi__g‘16Ë
(
s
);

5467 
tga_width
 = 
	`¡bi__g‘16Ë
(
s
);

5468 
tga_height
 = 
	`¡bi__g‘16Ë
(
s
);

5469 
tga_b™s_³r_pix–
 = 
	`¡bi__g‘8
(
s
);

5470 
tga_comp
, 
tga_rgb16
=0;

5471 
tga_šv”‹d
 = 
	`¡bi__g‘8
(
s
);

5474 *
tga_d©a
;

5475 *
tga_·Ë‰e
 = 
NULL
;

5476 
i
, 
j
;

5477 
¿w_d©a
[4] = {0};

5478 
RLE_couÁ
 = 0;

5479 
RLE_»³©šg
 = 0;

5480 
»ad_Ãxt_pix–
 = 1;

5481 
	`STBI_NOTUSED
(
ri
);

5484 iàĞ
tga_image_ty³
 >= 8 )

5486 
tga_image_ty³
 -= 8;

5487 
tga_is_RLE
 = 1;

5489 
tga_šv”‹d
 = 1 - ((tga_inverted >> 5) & 1);

5492 iàĞ
tga_šdexed
 ) 
tga_comp
 = 
	`¡bi__tga_g‘_comp
(
tga_·Ë‰e_b™s
, 0, &
tga_rgb16
);

5493 
tga_comp
 = 
	`¡bi__tga_g‘_comp
(
tga_b™s_³r_pix–
, (
tga_image_ty³
 =ğ3), &
tga_rgb16
);

5495 if(!
tga_comp
)

5496  
	`¡bi__”½uc
("bad format", "Can't find out TGA…ixelformat");

5499 *
x
 = 
tga_width
;

5500 *
y
 = 
tga_height
;

5501 ià(
comp
è*com°ğ
tga_comp
;

5503 ià(!
	`¡bi__mad3sizes_v®id
(
tga_width
, 
tga_height
, 
tga_comp
, 0))

5504  
	`¡bi__”½uc
("too†arge", "Corrupt TGA");

5506 
tga_d©a
 = (*)
	`¡bi__m®loc_mad3
(
tga_width
, 
tga_height
, 
tga_comp
, 0);

5507 ià(!
tga_d©a
è 
	`¡bi__”½uc
("outofmem", "Out of memory");

5510 
	`¡bi__sk
(
s
, 
tga_off£t
 );

5512 iàĞ!
tga_šdexed
 && !
tga_is_RLE
 && !
tga_rgb16
 ) {

5513 
i
=0; i < 
tga_height
; ++i) {

5514 
row
 = 
tga_šv”‹d
 ? 
tga_height
 -
i
 - 1 : i;

5515 
¡bi_uc
 *
tga_row
 = 
tga_d©a
 + 
row
*
tga_width
*
tga_comp
;

5516 
	`¡bi__g‘n
(
s
, 
tga_row
, 
tga_width
 * 
tga_comp
);

5520 iàĞ
tga_šdexed
)

5523 
	`¡bi__sk
(
s
, 
tga_·Ë‰e_¡¬t
 );

5525 
tga_·Ë‰e
 = (*)
	`¡bi__m®loc_mad2
(
tga_·Ë‰e_Ën
, 
tga_comp
, 0);

5526 ià(!
tga_·Ë‰e
) {

5527 
	`STBI_FREE
(
tga_d©a
);

5528  
	`¡bi__”½uc
("outofmem", "Out of memory");

5530 ià(
tga_rgb16
) {

5531 
¡bi_uc
 *
·l_’Œy
 = 
tga_·Ë‰e
;

5532 
	`STBI_ASSERT
(
tga_comp
 =ğ
STBI_rgb
);

5533 
i
=0; i < 
tga_·Ë‰e_Ën
; ++i) {

5534 
	`¡bi__tga_»ad_rgb16
(
s
, 
·l_’Œy
);

5535 
·l_’Œy
 +ğ
tga_comp
;

5537 } ià(!
	`¡bi__g‘n
(
s
, 
tga_·Ë‰e
, 
tga_·Ë‰e_Ën
 * 
tga_comp
)) {

5538 
	`STBI_FREE
(
tga_d©a
);

5539 
	`STBI_FREE
(
tga_·Ë‰e
);

5540  
	`¡bi__”½uc
("bad…alette", "Corrupt TGA");

5544 
i
=0; i < 
tga_width
 * 
tga_height
; ++i)

5547 iàĞ
tga_is_RLE
 )

5549 iàĞ
RLE_couÁ
 == 0 )

5552 
RLE_cmd
 = 
	`¡bi__g‘8
(
s
);

5553 
RLE_couÁ
 = 1 + (
RLE_cmd
 & 127);

5554 
RLE_»³©šg
 = 
RLE_cmd
 >> 7;

5555 
»ad_Ãxt_pix–
 = 1;

5556 } iàĞ!
RLE_»³©šg
 )

5558 
»ad_Ãxt_pix–
 = 1;

5562 
»ad_Ãxt_pix–
 = 1;

5565 iàĞ
»ad_Ãxt_pix–
 )

5568 iàĞ
tga_šdexed
 )

5571 
·l_idx
 = (
tga_b™s_³r_pix–
 =ğ8è? 
	`¡bi__g‘8
(
s
è: 
	`¡bi__g‘16Ë
(s);

5572 iàĞ
·l_idx
 >ğ
tga_·Ë‰e_Ën
 ) {

5574 
·l_idx
 = 0;

5576 
·l_idx
 *ğ
tga_comp
;

5577 
j
 = 0; j < 
tga_comp
; ++j) {

5578 
¿w_d©a
[
j
] = 
tga_·Ë‰e
[
·l_idx
+j];

5580 } if(
tga_rgb16
) {

5581 
	`STBI_ASSERT
(
tga_comp
 =ğ
STBI_rgb
);

5582 
	`¡bi__tga_»ad_rgb16
(
s
, 
¿w_d©a
);

5585 
j
 = 0; j < 
tga_comp
; ++j) {

5586 
¿w_d©a
[
j
] = 
	`¡bi__g‘8
(
s
);

5590 
»ad_Ãxt_pix–
 = 0;

5594 
j
 = 0; j < 
tga_comp
; ++j)

5595 
tga_d©a
[
i
*
tga_comp
+
j
] = 
¿w_d©a
[j];

5598 --
RLE_couÁ
;

5601 iàĞ
tga_šv”‹d
 )

5603 
j
 = 0; j*2 < 
tga_height
; ++j)

5605 
šdex1
 = 
j
 * 
tga_width
 * 
tga_comp
;

5606 
šdex2
 = (
tga_height
 - 1 - 
j
è* 
tga_width
 * 
tga_comp
;

5607 
i
 = 
tga_width
 * 
tga_comp
; i > 0; --i)

5609 
‹mp
 = 
tga_d©a
[
šdex1
];

5610 
tga_d©a
[
šdex1
] =ga_d©a[
šdex2
];

5611 
tga_d©a
[
šdex2
] = 
‹mp
;

5612 ++
šdex1
;

5613 ++
šdex2
;

5618 iàĞ
tga_·Ë‰e
 !ğ
NULL
 )

5620 
	`STBI_FREE
Ğ
tga_·Ë‰e
 );

5625 ià(
tga_comp
 >ğ3 && !
tga_rgb16
)

5627 * 
tga_pix–
 = 
tga_d©a
;

5628 
i
=0; i < 
tga_width
 * 
tga_height
; ++i)

5630 
‹mp
 = 
tga_pix–
[0];

5631 
tga_pix–
[0] =ga_pixel[2];

5632 
tga_pix–
[2] = 
‹mp
;

5633 
tga_pix–
 +ğ
tga_comp
;

5638 ià(
»q_comp
 &&„eq_com°!ğ
tga_comp
)

5639 
tga_d©a
 = 
	`¡bi__cÚv”t_fÜm©
Ñga_d©a, 
tga_comp
, 
»q_comp
, 
tga_width
, 
tga_height
);

5643 
tga_·Ë‰e_¡¬t
 = 
tga_·Ë‰e_Ën
 = 
tga_·Ë‰e_b™s
 =

5644 
tga_x_Üigš
 = 
tga_y_Üigš
 = 0;

5646  
tga_d©a
;

5647 
	}
}

5653 #iâdeà
STBI_NO_PSD


5654 
	$¡bi__psd_‹¡
(
¡bi__cÚ‹xt
 *
s
)

5656 
r
 = (
	`¡bi__g‘32be
(
s
) == 0x38425053);

5657 
	`¡bi__»wšd
(
s
);

5658  
r
;

5659 
	}
}

5661 
	$¡bi__psd_decode_¾e
(
¡bi__cÚ‹xt
 *
s
, 
¡bi_uc
 *
p
, 
pix–CouÁ
)

5663 
couÁ
, 
Æeá
, 
Ën
;

5665 
couÁ
 = 0;

5666 (
Æeá
 = 
pix–CouÁ
 - 
couÁ
) > 0) {

5667 
Ën
 = 
	`¡bi__g‘8
(
s
);

5668 ià(
Ën
 == 128) {

5670 } ià(
Ën
 < 128) {

5672 
Ën
++;

5673 ià(
Ën
 > 
Æeá
)  0;

5674 
couÁ
 +ğ
Ën
;

5675 
Ën
) {

5676 *
p
 = 
	`¡bi__g‘8
(
s
);

5677 
p
 += 4;

5678 
Ën
--;

5680 } ià(
Ën
 > 128) {

5681 
¡bi_uc
 
v®
;

5684 
Ën
 = 257 -†en;

5685 ià(
Ën
 > 
Æeá
)  0;

5686 
v®
 = 
	`¡bi__g‘8
(
s
);

5687 
couÁ
 +ğ
Ën
;

5688 
Ën
) {

5689 *
p
 = 
v®
;

5690 
p
 += 4;

5691 
Ën
--;

5697 
	}
}

5699 *
	$¡bi__psd_lßd
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
, 
bpc
)

5701 
pix–CouÁ
;

5702 
chªÃlCouÁ
, 
com´essiÚ
;

5703 
chªÃl
, 
i
;

5704 
b™d•th
;

5705 
w
,
h
;

5706 
¡bi_uc
 *
out
;

5707 
	`STBI_NOTUSED
(
ri
);

5710 ià(
	`¡bi__g‘32be
(
s
) != 0x38425053)

5711  
	`¡bi__”½uc
("not PSD", "Corrupt PSD image");

5714 ià(
	`¡bi__g‘16be
(
s
) != 1)

5715  
	`¡bi__”½uc
("wrong version", "Unsupported version of PSD image");

5718 
	`¡bi__sk
(
s
, 6 );

5721 
chªÃlCouÁ
 = 
	`¡bi__g‘16be
(
s
);

5722 ià(
chªÃlCouÁ
 < 0 || channelCount > 16)

5723  
	`¡bi__”½uc
("wrong channel count", "Unsupported‚umber of channels in PSD image");

5726 
h
 = 
	`¡bi__g‘32be
(
s
);

5727 
w
 = 
	`¡bi__g‘32be
(
s
);

5730 
b™d•th
 = 
	`¡bi__g‘16be
(
s
);

5731 ià(
b™d•th
 != 8 && bitdepth != 16)

5732  
	`¡bi__”½uc
("unsupported bit depth", "PSD bit depth is‚ot 8 or 16 bit");

5744 ià(
	`¡bi__g‘16be
(
s
) != 3)

5745  
	`¡bi__”½uc
("wrong color format", "PSD is‚ot in RGB color format");

5748 
	`¡bi__sk
(
s
,
	`¡bi__g‘32be
(s) );

5751 
	`¡bi__sk
(
s
, 
	`¡bi__g‘32be
(s) );

5754 
	`¡bi__sk
(
s
, 
	`¡bi__g‘32be
(s) );

5760 
com´essiÚ
 = 
	`¡bi__g‘16be
(
s
);

5761 ià(
com´essiÚ
 > 1)

5762  
	`¡bi__”½uc
("bad compression", "PSD has‡n unknown compression format");

5765 ià(!
	`¡bi__mad3sizes_v®id
(4, 
w
, 
h
, 0))

5766  
	`¡bi__”½uc
("too†arge", "Corrupt PSD");

5770 ià(!
com´essiÚ
 && 
b™d•th
 =ğ16 && 
bpc
 == 16) {

5771 
out
 = (
¡bi_uc
 *è
	`¡bi__m®loc_mad3
(8, 
w
, 
h
, 0);

5772 
ri
->
b™s_³r_chªÃl
 = 16;

5774 
out
 = (
¡bi_uc
 *è
	`¡bi__m®loc
(4 * 
w
*
h
);

5776 ià(!
out
è 
	`¡bi__”½uc
("outofmem", "Out of memory");

5777 
pix–CouÁ
 = 
w
*
h
;

5783 ià(
com´essiÚ
) {

5794 
	`¡bi__sk
(
s
, 
h
 * 
chªÃlCouÁ
 * 2 );

5797 
chªÃl
 = 0; channel < 4; channel++) {

5798 
¡bi_uc
 *
p
;

5800 
p
 = 
out
+
chªÃl
;

5801 ià(
chªÃl
 >ğ
chªÃlCouÁ
) {

5803 
i
 = 0; i < 
pix–CouÁ
; i++, 
p
 += 4)

5804 *
p
 = (
chªÃl
 == 3 ? 255 : 0);

5807 ià(!
	`¡bi__psd_decode_¾e
(
s
, 
p
, 
pix–CouÁ
)) {

5808 
	`STBI_FREE
(
out
);

5809  
	`¡bi__”½uc
("corrupt", "bad RLE data");

5819 
chªÃl
 = 0; channel < 4; channel++) {

5820 ià(
chªÃl
 >ğ
chªÃlCouÁ
) {

5822 ià(
b™d•th
 =ğ16 && 
bpc
 == 16) {

5823 
¡bi__ušt16
 *
q
 = ((¡bi__ušt16 *è
out
è+ 
chªÃl
;

5824 
¡bi__ušt16
 
v®
 = 
chªÃl
 == 3 ? 65535 : 0;

5825 
i
 = 0; i < 
pix–CouÁ
; i++, 
q
 += 4)

5826 *
q
 = 
v®
;

5828 
¡bi_uc
 *
p
 = 
out
+
chªÃl
;

5829 
¡bi_uc
 
v®
 = 
chªÃl
 == 3 ? 255 : 0;

5830 
i
 = 0; i < 
pix–CouÁ
; i++, 
p
 += 4)

5831 *
p
 = 
v®
;

5834 ià(
ri
->
b™s_³r_chªÃl
 == 16) {

5835 
¡bi__ušt16
 *
q
 = ((¡bi__ušt16 *è
out
è+ 
chªÃl
;

5836 
i
 = 0; i < 
pix–CouÁ
; i++, 
q
 += 4)

5837 *
q
 = (
¡bi__ušt16
è
	`¡bi__g‘16be
(
s
);

5839 
¡bi_uc
 *
p
 = 
out
+
chªÃl
;

5840 ià(
b™d•th
 == 16) {

5841 
i
 = 0; i < 
pix–CouÁ
; i++, 
p
 += 4)

5842 *
p
 = (
¡bi_uc
è(
	`¡bi__g‘16be
(
s
) >> 8);

5844 
i
 = 0; i < 
pix–CouÁ
; i++, 
p
 += 4)

5845 *
p
 = 
	`¡bi__g‘8
(
s
);

5853 ià(
chªÃlCouÁ
 >= 4) {

5854 ià(
ri
->
b™s_³r_chªÃl
 == 16) {

5855 
i
=0; i < 
w
*
h
; ++i) {

5856 
¡bi__ušt16
 *
pix–
 = (¡bi__ušt16 *è
out
 + 4*
i
;

5857 ià(
pix–
[3] != 0 &&…ixel[3] != 65535) {

5858 
a
 = 
pix–
[3] / 65535.0f;

5859 
¿
 = 1.0à/ 
a
;

5860 
šv_a
 = 65535.0à* (1 - 
¿
);

5861 
pix–
[0] = (
¡bi__ušt16
èÕix–[0]*
¿
 + 
šv_a
);

5862 
pix–
[1] = (
¡bi__ušt16
èÕix–[1]*
¿
 + 
šv_a
);

5863 
pix–
[2] = (
¡bi__ušt16
èÕix–[2]*
¿
 + 
šv_a
);

5867 
i
=0; i < 
w
*
h
; ++i) {

5868 *
pix–
 = 
out
 + 4*
i
;

5869 ià(
pix–
[3] != 0 &&…ixel[3] != 255) {

5870 
a
 = 
pix–
[3] / 255.0f;

5871 
¿
 = 1.0à/ 
a
;

5872 
šv_a
 = 255.0à* (1 - 
¿
);

5873 
pix–
[0] = (èÕix–[0]*
¿
 + 
šv_a
);

5874 
pix–
[1] = (èÕix–[1]*
¿
 + 
šv_a
);

5875 
pix–
[2] = (èÕix–[2]*
¿
 + 
šv_a
);

5882 ià(
»q_comp
 &&„eq_comp != 4) {

5883 ià(
ri
->
b™s_³r_chªÃl
 == 16)

5884 
out
 = (
¡bi_uc
 *è
	`¡bi__cÚv”t_fÜm©16
((
¡bi__ušt16
 *èout, 4, 
»q_comp
, 
w
, 
h
);

5886 
out
 = 
	`¡bi__cÚv”t_fÜm©
(out, 4, 
»q_comp
, 
w
, 
h
);

5887 ià(
out
 =ğ
NULL
)  out;

5890 ià(
comp
) *comp = 4;

5891 *
y
 = 
h
;

5892 *
x
 = 
w
;

5894  
out
;

5895 
	}
}

5905 #iâdeà
STBI_NO_PIC


5906 
	$¡bi__pic_is4
(
¡bi__cÚ‹xt
 *
s
,cÚ¡ *
¡r
)

5908 
i
;

5909 
i
=0; i<4; ++i)

5910 ià(
	`¡bi__g‘8
(
s
è!ğ(
¡bi_uc
)
¡r
[
i
])

5914 
	}
}

5916 
	$¡bi__pic_‹¡_cÜe
(
¡bi__cÚ‹xt
 *
s
)

5918 
i
;

5920 ià(!
	`¡bi__pic_is4
(
s
,"\x53\x80\xF6\x34"))

5923 
i
=0;i<84;++i)

5924 
	`¡bi__g‘8
(
s
);

5926 ià(!
	`¡bi__pic_is4
(
s
,"PICT"))

5930 
	}
}

5934 
¡bi_uc
 
	msize
,
	mty³
,
	mchªÃl
;

5935 } 
	t¡bi__pic_·ck‘
;

5937 
¡bi_uc
 *
	$¡bi__»adv®
(
¡bi__cÚ‹xt
 *
s
, 
chªÃl
, 
¡bi_uc
 *
de¡
)

5939 
mask
=0x80, 
i
;

5941 
i
=0; i<4; ++i, 
mask
>>=1) {

5942 ià(
chªÃl
 & 
mask
) {

5943 ià(
	`¡bi__©_eof
(
s
)è 
	`¡bi__”½uc
("bad file","PIC fileoo short");

5944 
de¡
[
i
]=
	`¡bi__g‘8
(
s
);

5948  
de¡
;

5949 
	}
}

5951 
	$¡bi__cİyv®
(
chªÃl
,
¡bi_uc
 *
de¡
,cÚ¡ stbi_uø*
¤c
)

5953 
mask
=0x80,
i
;

5955 
i
=0;i<4; ++i, 
mask
>>=1)

5956 ià(
chªÃl
&
mask
)

5957 
de¡
[
i
]=
¤c
[i];

5958 
	}
}

5960 
¡bi_uc
 *
	$¡bi__pic_lßd_cÜe
(
¡bi__cÚ‹xt
 *
s
,
width
,
height
,*
comp
, 
¡bi_uc
 *
»suÉ
)

5962 
aù_comp
=0,
num_·ck‘s
=0,
y
,
chašed
;

5963 
¡bi__pic_·ck‘
 
·ck‘s
[10];

5968 
¡bi__pic_·ck‘
 *
·ck‘
;

5970 ià(
num_·ck‘s
==(
·ck‘s
)/(packets[0]))

5971  
	`¡bi__”½uc
("bad format","too many…ackets");

5973 
·ck‘
 = &
·ck‘s
[
num_·ck‘s
++];

5975 
chašed
 = 
	`¡bi__g‘8
(
s
);

5976 
·ck‘
->
size
 = 
	`¡bi__g‘8
(
s
);

5977 
·ck‘
->
ty³
 = 
	`¡bi__g‘8
(
s
);

5978 
·ck‘
->
chªÃl
 = 
	`¡bi__g‘8
(
s
);

5980 
aù_comp
 |ğ
·ck‘
->
chªÃl
;

5982 ià(
	`¡bi__©_eof
(
s
)è 
	`¡bi__”½uc
("bad file","fileoo short (reading…ackets)");

5983 ià(
·ck‘
->
size
 !ğ8è 
	`¡bi__”½uc
("bad format","packet isn't 8bpp");

5984 } 
chašed
);

5986 *
comp
 = (
aù_comp
 & 0x10 ? 4 : 3);

5988 
y
=0; y<
height
; ++y) {

5989 
·ck‘_idx
;

5991 
·ck‘_idx
=0;…ack‘_idx < 
num_·ck‘s
; ++packet_idx) {

5992 
¡bi__pic_·ck‘
 *
·ck‘
 = &
·ck‘s
[
·ck‘_idx
];

5993 
¡bi_uc
 *
de¡
 = 
»suÉ
+
y
*
width
*4;

5995 
·ck‘
->
ty³
) {

5997  
	`¡bi__”½uc
("bad format","packet has bad compressionype");

6000 
x
;

6002 
x
=0;x<
width
;++x, 
de¡
+=4)

6003 ià(!
	`¡bi__»adv®
(
s
,
·ck‘
->
chªÃl
,
de¡
))

6010 
Ëá
=
width
, 
i
;

6012 
Ëá
>0) {

6013 
¡bi_uc
 
couÁ
,
v®ue
[4];

6015 
couÁ
=
	`¡bi__g‘8
(
s
);

6016 ià(
	`¡bi__©_eof
(
s
)è 
	`¡bi__”½uc
("bad file","fileoo short (pure„ead count)");

6018 ià(
couÁ
 > 
Ëá
)

6019 
couÁ
 = (
¡bi_uc
è
Ëá
;

6021 ià(!
	`¡bi__»adv®
(
s
,
·ck‘
->
chªÃl
,
v®ue
))  0;

6023 
i
=0; i<
couÁ
; ++i,
de¡
+=4)

6024 
	`¡bi__cİyv®
(
·ck‘
->
chªÃl
,
de¡
,
v®ue
);

6025 
Ëá
 -ğ
couÁ
;

6031 
Ëá
=
width
;

6032 
Ëá
>0) {

6033 
couÁ
 = 
	`¡bi__g‘8
(
s
), 
i
;

6034 ià(
	`¡bi__©_eof
(
s
)è 
	`¡bi__”½uc
("bad file","fileoo short (mixed„ead count)");

6036 ià(
couÁ
 >= 128) {

6037 
¡bi_uc
 
v®ue
[4];

6039 ià(
couÁ
==128)

6040 
couÁ
 = 
	`¡bi__g‘16be
(
s
);

6042 
couÁ
 -= 127;

6043 ià(
couÁ
 > 
Ëá
)

6044  
	`¡bi__”½uc
("bad file","scanline overrun");

6046 ià(!
	`¡bi__»adv®
(
s
,
·ck‘
->
chªÃl
,
v®ue
))

6049 
i
=0;i<
couÁ
;++i, 
de¡
 += 4)

6050 
	`¡bi__cİyv®
(
·ck‘
->
chªÃl
,
de¡
,
v®ue
);

6052 ++
couÁ
;

6053 ià(
couÁ
>
Ëá
è 
	`¡bi__”½uc
("bad file","scanline overrun");

6055 
i
=0;i<
couÁ
;++i, 
de¡
+=4)

6056 ià(!
	`¡bi__»adv®
(
s
,
·ck‘
->
chªÃl
,
de¡
))

6059 
Ëá
-=
couÁ
;

6067  
»suÉ
;

6068 
	}
}

6070 *
	$¡bi__pic_lßd
(
¡bi__cÚ‹xt
 *
s
,*
px
,*
py
,*
comp
,
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
)

6072 
¡bi_uc
 *
»suÉ
;

6073 
i
, 
x
,
y
, 
š‹º®_comp
;

6074 
	`STBI_NOTUSED
(
ri
);

6076 ià(!
comp
ècom°ğ&
š‹º®_comp
;

6078 
i
=0; i<92; ++i)

6079 
	`¡bi__g‘8
(
s
);

6081 
x
 = 
	`¡bi__g‘16be
(
s
);

6082 
y
 = 
	`¡bi__g‘16be
(
s
);

6083 ià(
	`¡bi__©_eof
(
s
)è 
	`¡bi__”½uc
("bad file","fileoo short (pic header)");

6084 ià(!
	`¡bi__mad3sizes_v®id
(
x
, 
y
, 4, 0)è 
	`¡bi__”½uc
("too†arge", "PIC imageoo†argeo decode");

6086 
	`¡bi__g‘32be
(
s
);

6087 
	`¡bi__g‘16be
(
s
);

6088 
	`¡bi__g‘16be
(
s
);

6091 
»suÉ
 = (
¡bi_uc
 *è
	`¡bi__m®loc_mad3
(
x
, 
y
, 4, 0);

6092 
	`mem£t
(
»suÉ
, 0xff, 
x
*
y
*4);

6094 ià(!
	`¡bi__pic_lßd_cÜe
(
s
,
x
,
y
,
comp
, 
»suÉ
)) {

6095 
	`STBI_FREE
(
»suÉ
);

6096 
»suÉ
=0;

6098 *
px
 = 
x
;

6099 *
py
 = 
y
;

6100 ià(
»q_comp
 =ğ0è»q_com°ğ*
comp
;

6101 
»suÉ
=
	`¡bi__cÚv”t_fÜm©
ÔesuÉ,4,
»q_comp
,
x
,
y
);

6103  
»suÉ
;

6104 
	}
}

6106 
	$¡bi__pic_‹¡
(
¡bi__cÚ‹xt
 *
s
)

6108 
r
 = 
	`¡bi__pic_‹¡_cÜe
(
s
);

6109 
	`¡bi__»wšd
(
s
);

6110  
r
;

6111 
	}
}

6117 #iâdeà
STBI_NO_GIF


6120 
¡bi__št16
 
	m´efix
;

6121 
¡bi_uc
 
	mfœ¡
;

6122 
¡bi_uc
 
	msuffix
;

6123 } 
	t¡bi__gif_lzw
;

6127 
	mw
,
	mh
;

6128 
¡bi_uc
 *
	mout
;

6129 
¡bi_uc
 *
	mbackground
;

6130 
¡bi_uc
 *
	mhi¡Üy
;

6131 
	mæags
, 
	mbgšdex
, 
	m¿tio
, 
	mŒª¥¬’t
, 
	meæags
;

6132 
¡bi_uc
 
	m·l
[256][4];

6133 
¡bi_uc
 
	mÍ®
[256][4];

6134 
¡bi__gif_lzw
 
	mcodes
[8192];

6135 
¡bi_uc
 *
	mcŞÜ_bË
;

6136 
	m·r£
, 
	m¡•
;

6137 
	mlæags
;

6138 
	m¡¬t_x
, 
	m¡¬t_y
;

6139 
	mmax_x
, 
	mmax_y
;

6140 
	mcur_x
, 
	mcur_y
;

6141 
	mlše_size
;

6142 
	md–ay
;

6143 } 
	t¡bi__gif
;

6145 
	$¡bi__gif_‹¡_¿w
(
¡bi__cÚ‹xt
 *
s
)

6147 
sz
;

6148 ià(
	`¡bi__g‘8
(
s
) != 'G' || stbi__get8(s) != 'I' || stbi__get8(s) != 'F' || stbi__get8(s) != '8')  0;

6149 
sz
 = 
	`¡bi__g‘8
(
s
);

6150 ià(
sz
 != '9' && sz != '7')  0;

6151 ià(
	`¡bi__g‘8
(
s
) != 'a')  0;

6153 
	}
}

6155 
	$¡bi__gif_‹¡
(
¡bi__cÚ‹xt
 *
s
)

6157 
r
 = 
	`¡bi__gif_‹¡_¿w
(
s
);

6158 
	`¡bi__»wšd
(
s
);

6159  
r
;

6160 
	}
}

6162 
	$¡bi__gif_·r£_cŞÜbË
(
¡bi__cÚ‹xt
 *
s
, 
¡bi_uc
 
·l
[256][4], 
num_’Œ›s
, 
Œª¥
)

6164 
i
;

6165 
i
=0; i < 
num_’Œ›s
; ++i) {

6166 
·l
[
i
][2] = 
	`¡bi__g‘8
(
s
);

6167 
·l
[
i
][1] = 
	`¡bi__g‘8
(
s
);

6168 
·l
[
i
][0] = 
	`¡bi__g‘8
(
s
);

6169 
·l
[
i
][3] = 
Œª¥
 == i ? 0 : 255;

6171 
	}
}

6173 
	$¡bi__gif_h—d”
(
¡bi__cÚ‹xt
 *
s
, 
¡bi__gif
 *
g
, *
comp
, 
is_šfo
)

6175 
¡bi_uc
 
v”siÚ
;

6176 ià(
	`¡bi__g‘8
(
s
) != 'G' || stbi__get8(s) != 'I' || stbi__get8(s) != 'F' || stbi__get8(s) != '8')

6177  
	`¡bi__”r
("not GIF", "Corrupt GIF");

6179 
v”siÚ
 = 
	`¡bi__g‘8
(
s
);

6180 ià(
v”siÚ
 !ğ'7' && v”siÚ !ğ'9'è 
	`¡bi__”r
("not GIF", "Corrupt GIF");

6181 ià(
	`¡bi__g‘8
(
s
è!ğ'a'è 
	`¡bi__”r
("not GIF", "Corrupt GIF");

6183 
¡bi__g_çu»_»asÚ
 = "";

6184 
g
->
w
 = 
	`¡bi__g‘16Ë
(
s
);

6185 
g
->
h
 = 
	`¡bi__g‘16Ë
(
s
);

6186 
g
->
æags
 = 
	`¡bi__g‘8
(
s
);

6187 
g
->
bgšdex
 = 
	`¡bi__g‘8
(
s
);

6188 
g
->
¿tio
 = 
	`¡bi__g‘8
(
s
);

6189 
g
->
Œª¥¬’t
 = -1;

6191 ià(
comp
 != 0) *comp = 4;

6193 ià(
is_šfo
)  1;

6195 ià(
g
->
æags
 & 0x80)

6196 
	`¡bi__gif_·r£_cŞÜbË
(
s
,
g
->
·l
, 2 << (g->
æags
 & 7), -1);

6199 
	}
}

6201 
	$¡bi__gif_šfo_¿w
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
)

6203 
¡bi__gif
* 
g
 = (¡bi__gif*è
	`¡bi__m®loc
((stbi__gif));

6204 ià(!
	`¡bi__gif_h—d”
(
s
, 
g
, 
comp
, 1)) {

6205 
	`STBI_FREE
(
g
);

6206 
	`¡bi__»wšd
Ğ
s
 );

6209 ià(
x
è*x = 
g
->
w
;

6210 ià(
y
è*y = 
g
->
h
;

6211 
	`STBI_FREE
(
g
);

6213 
	}
}

6215 
	$¡bi__out_gif_code
(
¡bi__gif
 *
g
, 
¡bi__ušt16
 
code
)

6217 
¡bi_uc
 *
p
, *
c
;

6218 
idx
;

6222 ià(
g
->
codes
[
code
].
´efix
 >= 0)

6223 
	`¡bi__out_gif_code
(
g
, g->
codes
[
code
].
´efix
);

6225 ià(
g
->
cur_y
 >ğg->
max_y
) ;

6227 
idx
 = 
g
->
cur_x
 + g->
cur_y
;

6228 
p
 = &
g
->
out
[
idx
];

6229 
g
->
hi¡Üy
[
idx
 / 4] = 1;

6231 
c
 = &
g
->
cŞÜ_bË
[g->
codes
[
code
].
suffix
 * 4];

6232 ià(
c
[3] > 128) {

6233 
p
[0] = 
c
[2];

6234 
p
[1] = 
c
[1];

6235 
p
[2] = 
c
[0];

6236 
p
[3] = 
c
[3];

6238 
g
->
cur_x
 += 4;

6240 ià(
g
->
cur_x
 >ğg->
max_x
) {

6241 
g
->
cur_x
 = g->
¡¬t_x
;

6242 
g
->
cur_y
 +ğg->
¡•
;

6244 
g
->
cur_y
 >ğg->
max_y
 && g->
·r£
 > 0) {

6245 
g
->
¡•
 = (1 << g->
·r£
è* g->
lše_size
;

6246 
g
->
cur_y
 = g->
¡¬t_y
 + (g->
¡•
 >> 1);

6247 --
g
->
·r£
;

6250 
	}
}

6252 
¡bi_uc
 *
	$¡bi__´oûss_gif_¿¡”
(
¡bi__cÚ‹xt
 *
s
, 
¡bi__gif
 *
g
)

6254 
¡bi_uc
 
lzw_cs
;

6255 
¡bi__št32
 
Ën
, 
š™_code
;

6256 
¡bi__ušt32
 
fœ¡
;

6257 
¡bi__št32
 
codesize
, 
codemask
, 
ava
, 
Şdcode
, 
b™s
, 
v®id_b™s
, 
ş—r
;

6258 
¡bi__gif_lzw
 *
p
;

6260 
lzw_cs
 = 
	`¡bi__g‘8
(
s
);

6261 ià(
lzw_cs
 > 12è 
NULL
;

6262 
ş—r
 = 1 << 
lzw_cs
;

6263 
fœ¡
 = 1;

6264 
codesize
 = 
lzw_cs
 + 1;

6265 
codemask
 = (1 << 
codesize
) - 1;

6266 
b™s
 = 0;

6267 
v®id_b™s
 = 0;

6268 
š™_code
 = 0; in™_cod< 
ş—r
; init_code++) {

6269 
g
->
codes
[
š™_code
].
´efix
 = -1;

6270 
g
->
codes
[
š™_code
].
fœ¡
 = (
¡bi_uc
) init_code;

6271 
g
->
codes
[
š™_code
].
suffix
 = (
¡bi_uc
) init_code;

6275 
ava
 = 
ş—r
+2;

6276 
Şdcode
 = -1;

6278 
Ën
 = 0;

6280 ià(
v®id_b™s
 < 
codesize
) {

6281 ià(
Ën
 == 0) {

6282 
Ën
 = 
	`¡bi__g‘8
(
s
);

6283 ià(
Ën
 == 0)

6284  
g
->
out
;

6286 --
Ën
;

6287 
b™s
 |ğ(
¡bi__št32
è
	`¡bi__g‘8
(
s
è<< 
v®id_b™s
;

6288 
v®id_b™s
 += 8;

6290 
¡bi__št32
 
code
 = 
b™s
 & 
codemask
;

6291 
b™s
 >>ğ
codesize
;

6292 
v®id_b™s
 -ğ
codesize
;

6294 ià(
code
 =ğ
ş—r
) {

6295 
codesize
 = 
lzw_cs
 + 1;

6296 
codemask
 = (1 << 
codesize
) - 1;

6297 
ava
 = 
ş—r
 + 2;

6298 
Şdcode
 = -1;

6299 
fœ¡
 = 0;

6300 } ià(
code
 =ğ
ş—r
 + 1) {

6301 
	`¡bi__sk
(
s
, 
Ën
);

6302 (
Ën
 = 
	`¡bi__g‘8
(
s
)) > 0)

6303 
	`¡bi__sk
(
s
,
Ën
);

6304  
g
->
out
;

6305 } ià(
code
 <ğ
ava
) {

6306 ià(
fœ¡
) {

6307  
	`¡bi__”½uc
("no clear code", "Corrupt GIF");

6310 ià(
Şdcode
 >= 0) {

6311 
p
 = &
g
->
codes
[
ava
++];

6312 ià(
ava
 > 8192) {

6313  
	`¡bi__”½uc
("too many codes", "Corrupt GIF");

6316 
p
->
´efix
 = (
¡bi__št16
è
Şdcode
;

6317 
p
->
fœ¡
 = 
g
->
codes
[
Şdcode
].first;

6318 
p
->
suffix
 = (
code
 =ğ
ava
è?…->
fœ¡
 : 
g
->
codes
[code].first;

6319 } ià(
code
 =ğ
ava
)

6320  
	`¡bi__”½uc
("illegal code in„aster", "Corrupt GIF");

6322 
	`¡bi__out_gif_code
(
g
, (
¡bi__ušt16
è
code
);

6324 ià((
ava
 & 
codemask
) == 0 &&‡vail <= 0x0FFF) {

6325 
codesize
++;

6326 
codemask
 = (1 << 
codesize
) - 1;

6329 
Şdcode
 = 
code
;

6331  
	`¡bi__”½uc
("illegal code in„aster", "Corrupt GIF");

6335 
	}
}

6339 
¡bi_uc
 *
	$¡bi__gif_lßd_Ãxt
(
¡bi__cÚ‹xt
 *
s
, 
¡bi__gif
 *
g
, *
comp
, 
»q_comp
, 
¡bi_uc
 *
two_back
)

6341 
di¥o£
;

6342 
fœ¡_äame
;

6343 
pi
;

6344 
pcouÁ
;

6347 
fœ¡_äame
 = 0;

6348 ià(
g
->
out
 == 0) {

6349 ià(!
	`¡bi__gif_h—d”
(
s
, 
g
, 
comp
,0))  0;

6350 
g
->
out
 = (
¡bi_uc
 *è
	`¡bi__m®loc
(4 * g->
w
 * g->
h
);

6351 
g
->
background
 = (
¡bi_uc
 *è
	`¡bi__m®loc
(4 * g->
w
 * g->
h
);

6352 
g
->
hi¡Üy
 = (
¡bi_uc
 *è
	`¡bi__m®loc
(g->
w
 * g->
h
);

6353 ià(
g
->
out
 =ğ0è 
	`¡bi__”½uc
("outofmem", "Out of memory");

6358 
	`mem£t
Ğ
g
->
out
, 0x00, 4 * g->
w
 * g->
h
 );

6359 
	`mem£t
Ğ
g
->
background
, 0x00, 4 * g->
w
 * g->
h
 );

6360 
	`mem£t
Ğ
g
->
hi¡Üy
, 0x00, g->
w
 * g->
h
 );

6361 
fœ¡_äame
 = 1;

6364 
di¥o£
 = (
g
->
eæags
 & 0x1C) >> 2;

6365 
pcouÁ
 = 
g
->
w
 * g->
h
;

6367 ià((
di¥o£
 =ğ3è&& (
two_back
 == 0)) {

6368 
di¥o£
 = 2;

6371 ià(
di¥o£
 == 3) {

6372 
pi
 = 0;…˜< 
pcouÁ
; ++pi) {

6373 ià(
g
->
hi¡Üy
[
pi
]) {

6374 
	`memıy
Ğ&
g
->
out
[
pi
 * 4], &
two_back
[pi * 4], 4 );

6377 } ià(
di¥o£
 == 2) {

6379 
pi
 = 0;…˜< 
pcouÁ
; ++pi) {

6380 ià(
g
->
hi¡Üy
[
pi
]) {

6381 
	`memıy
Ğ&
g
->
out
[
pi
 * 4], &g->
background
[pi * 4], 4 );

6392 
	`memıy
Ğ
g
->
background
, g->
out
, 4 * g->
w
 * g->
h
 );

6396 
	`mem£t
Ğ
g
->
hi¡Üy
, 0x00, g->
w
 * g->
h
 );

6399 
g
 = 
	`¡bi__g‘8
(
s
);

6400 
g
) {

6403 
¡bi__št32
 
x
, 
y
, 
w
, 
h
;

6404 
¡bi_uc
 *
o
;

6406 
x
 = 
	`¡bi__g‘16Ë
(
s
);

6407 
y
 = 
	`¡bi__g‘16Ë
(
s
);

6408 
w
 = 
	`¡bi__g‘16Ë
(
s
);

6409 
h
 = 
	`¡bi__g‘16Ë
(
s
);

6410 ià(((
x
 + 
w
è> (
g
->w)è|| ((
y
 + 
h
) > (g->h)))

6411  
	`¡bi__”½uc
("bad Image Descriptor", "Corrupt GIF");

6413 
g
->
lše_size
 = g->
w
 * 4;

6414 
g
->
¡¬t_x
 = 
x
 * 4;

6415 
g
->
¡¬t_y
 = 
y
 * g->
lše_size
;

6416 
g
->
max_x
 = g->
¡¬t_x
 + 
w
 * 4;

6417 
g
->
max_y
 = g->
¡¬t_y
 + 
h
 * g->
lše_size
;

6418 
g
->
cur_x
 = g->
¡¬t_x
;

6419 
g
->
cur_y
 = g->
¡¬t_y
;

6421 
g
->
læags
 = 
	`¡bi__g‘8
(
s
);

6423 ià(
g
->
læags
 & 0x40) {

6424 
g
->
¡•
 = 8 * g->
lše_size
;

6425 
g
->
·r£
 = 3;

6427 
g
->
¡•
 = g->
lše_size
;

6428 
g
->
·r£
 = 0;

6431 ià(
g
->
læags
 & 0x80) {

6432 
	`¡bi__gif_·r£_cŞÜbË
(
s
,
g
->
Í®
, 2 << (g->
læags
 & 7), g->
eæags
 & 0x01 ? g->
Œª¥¬’t
 : -1);

6433 
g
->
cŞÜ_bË
 = (
¡bi_uc
 *èg->
Í®
;

6434 } ià(
g
->
æags
 & 0x80) {

6435 
g
->
cŞÜ_bË
 = (
¡bi_uc
 *èg->
·l
;

6437  
	`¡bi__”½uc
("missing colorable", "Corrupt GIF");

6439 
o
 = 
	`¡bi__´oûss_gif_¿¡”
(
s
, 
g
);

6440 ià(
o
 =ğ
NULL
)  NULL;

6443 
pcouÁ
 = 
g
->
w
 * g->
h
;

6444 ià(
fœ¡_äame
 && (
g
->
bgšdex
 > 0)) {

6446 
pi
 = 0;…˜< 
pcouÁ
; ++pi) {

6447 ià(
g
->
hi¡Üy
[
pi
] == 0) {

6448 
g
->
·l
[g->
bgšdex
][3] = 255;

6449 
	`memıy
Ğ&
g
->
out
[
pi
 * 4], &g->
·l
[g->
bgšdex
], 4 );

6454  
o
;

6459 
Ën
;

6460 
ext
 = 
	`¡bi__g‘8
(
s
);

6461 ià(
ext
 == 0xF9) {

6462 
Ën
 = 
	`¡bi__g‘8
(
s
);

6463 ià(
Ën
 == 4) {

6464 
g
->
eæags
 = 
	`¡bi__g‘8
(
s
);

6465 
g
->
d–ay
 = 10 * 
	`¡bi__g‘16Ë
(
s
);

6468 ià(
g
->
Œª¥¬’t
 >= 0) {

6469 
g
->
·l
[g->
Œª¥¬’t
][3] = 255;

6471 ià(
g
->
eæags
 & 0x01) {

6472 
g
->
Œª¥¬’t
 = 
	`¡bi__g‘8
(
s
);

6473 ià(
g
->
Œª¥¬’t
 >= 0) {

6474 
g
->
·l
[g->
Œª¥¬’t
][3] = 0;

6478 
	`¡bi__sk
(
s
, 1);

6479 
g
->
Œª¥¬’t
 = -1;

6482 
	`¡bi__sk
(
s
, 
Ën
);

6486 (
Ën
 = 
	`¡bi__g‘8
(
s
)) != 0) {

6487 
	`¡bi__sk
(
s
, 
Ën
);

6493  (
¡bi_uc
 *è
s
;

6496  
	`¡bi__”½uc
("unknown code", "Corrupt GIF");

6499 
	}
}

6501 *
	$¡bi__lßd_gif_maš
(
¡bi__cÚ‹xt
 *
s
, **
d–ays
, *
x
, *
y
, *
z
, *
comp
, 
»q_comp
)

6503 ià(
	`¡bi__gif_‹¡
(
s
)) {

6504 
Ïy”s
 = 0;

6505 
¡bi_uc
 *
u
 = 0;

6506 
¡bi_uc
 *
out
 = 0;

6507 
¡bi_uc
 *
two_back
 = 0;

6508 
¡bi__gif
 
g
;

6509 
¡ride
;

6510 
	`mem£t
(&
g
, 0, (g));

6511 ià(
d–ays
) {

6512 *
d–ays
 = 0;

6516 
u
 = 
	`¡bi__gif_lßd_Ãxt
(
s
, &
g
, 
comp
, 
»q_comp
, 
two_back
);

6517 ià(
u
 =ğ(
¡bi_uc
 *è
s
) u = 0;

6519 ià(
u
) {

6520 *
x
 = 
g
.
w
;

6521 *
y
 = 
g
.
h
;

6522 ++
Ïy”s
;

6523 
¡ride
 = 
g
.
w
 * g.
h
 * 4;

6525 ià(
out
) {

6526 
out
 = (
¡bi_uc
*è
	`STBI_REALLOC
Ğout, 
Ïy”s
 * 
¡ride
 );

6527 ià(
d–ays
) {

6528 *
d–ays
 = (*è
	`STBI_REALLOC
Ğ*d–ays, (è* 
Ïy”s
 );

6531 
out
 = (
¡bi_uc
*)
	`¡bi__m®loc
Ğ
Ïy”s
 * 
¡ride
 );

6532 ià(
d–ays
) {

6533 *
d–ays
 = (*è
	`¡bi__m®loc
Ğ
Ïy”s
 * () );

6536 
	`memıy
Ğ
out
 + ((
Ïy”s
 - 1è* 
¡ride
), 
u
, stride );

6537 ià(
Ïy”s
 >= 2) {

6538 
two_back
 = 
out
 - 2 * 
¡ride
;

6541 ià(
d–ays
) {

6542 (*
d–ays
)[
Ïy”s
 - 1U] = 
g
.
d–ay
;

6545 } 
u
 != 0);

6548 
	`STBI_FREE
(
g
.
out
);

6549 
	`STBI_FREE
(
g
.
hi¡Üy
);

6550 
	`STBI_FREE
(
g
.
background
);

6553 ià(
»q_comp
 &&„eq_comp != 4)

6554 
out
 = 
	`¡bi__cÚv”t_fÜm©
(out, 4, 
»q_comp
, 
Ïy”s
 * 
g
.
w
, g.
h
);

6556 *
z
 = 
Ïy”s
;

6557  
out
;

6559  
	`¡bi__”½uc
("not GIF", "Image was‚ot‡s‡ gifype.");

6561 
	}
}

6563 *
	$¡bi__gif_lßd
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
)

6565 
¡bi_uc
 *
u
 = 0;

6566 
¡bi__gif
 
g
;

6567 
	`mem£t
(&
g
, 0, (g));

6569 
u
 = 
	`¡bi__gif_lßd_Ãxt
(
s
, &
g
, 
comp
, 
»q_comp
, 0);

6570 ià(
u
 =ğ(
¡bi_uc
 *è
s
) u = 0;

6571 ià(
u
) {

6572 *
x
 = 
g
.
w
;

6573 *
y
 = 
g
.
h
;

6577 ià(
»q_comp
 &&„eq_comp != 4)

6578 
u
 = 
	`¡bi__cÚv”t_fÜm©
(u, 4, 
»q_comp
, 
g
.
w
, g.
h
);

6582 
	`STBI_FREE
(
g
.
hi¡Üy
);

6583 
	`STBI_FREE
(
g
.
background
);

6585  
u
;

6586 
	}
}

6588 
	$¡bi__gif_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
)

6590  
	`¡bi__gif_šfo_¿w
(
s
,
x
,
y
,
comp
);

6591 
	}
}

6597 #iâdeà
STBI_NO_HDR


6598 
	$¡bi__hdr_‹¡_cÜe
(
¡bi__cÚ‹xt
 *
s
, cÚ¡ *
sigÇtu»
)

6600 
i
;

6601 
i
=0; 
sigÇtu»
[i]; ++i)

6602 ià(
	`¡bi__g‘8
(
s
è!ğ
sigÇtu»
[
i
])

6604 
	`¡bi__»wšd
(
s
);

6606 
	}
}

6608 
	$¡bi__hdr_‹¡
(
¡bi__cÚ‹xt
* 
s
)

6610 
r
 = 
	`¡bi__hdr_‹¡_cÜe
(
s
, "#?RADIANCE\n");

6611 
	`¡bi__»wšd
(
s
);

6612 if(!
r
) {

6613 
r
 = 
	`¡bi__hdr_‹¡_cÜe
(
s
, "#?RGBE\n");

6614 
	`¡bi__»wšd
(
s
);

6616  
r
;

6617 
	}
}

6619 
	#STBI__HDR_BUFLEN
 1024

	)

6620 *
	$¡bi__hdr_g‘tok’
(
¡bi__cÚ‹xt
 *
z
, *
bufãr
)

6622 
Ën
=0;

6623 
c
 = '\0';

6625 
c
 = (è
	`¡bi__g‘8
(
z
);

6627 !
	`¡bi__©_eof
(
z
è&& 
c
 != '\n') {

6628 
bufãr
[
Ën
++] = 
c
;

6629 ià(
Ën
 =ğ
STBI__HDR_BUFLEN
-1) {

6631 !
	`¡bi__©_eof
(
z
è&& 
	`¡bi__g‘8
(z) != '\n')

6635 
c
 = (è
	`¡bi__g‘8
(
z
);

6638 
bufãr
[
Ën
] = 0;

6639  
bufãr
;

6640 
	}
}

6642 
	$¡bi__hdr_cÚv”t
(*
ouut
, 
¡bi_uc
 *
šput
, 
»q_comp
)

6644 iàĞ
šput
[3] != 0 ) {

6645 
f1
;

6647 
f1
 = (è
	`ldexp
(1.0f, 
šput
[3] - ()(128 + 8));

6648 ià(
»q_comp
 <= 2)

6649 
ouut
[0] = (
šput
[0] + iÅut[1] + iÅut[2]è* 
f1
 / 3;

6651 
ouut
[0] = 
šput
[0] * 
f1
;

6652 
ouut
[1] = 
šput
[1] * 
f1
;

6653 
ouut
[2] = 
šput
[2] * 
f1
;

6655 ià(
»q_comp
 =ğ2è
ouut
[1] = 1;

6656 ià(
»q_comp
 =ğ4è
ouut
[3] = 1;

6658 
»q_comp
) {

6659 4: 
ouut
[3] = 1;

6660 3: 
ouut
[0] = output[1] = output[2] = 0;

6662 2: 
ouut
[1] = 1;

6663 1: 
ouut
[0] = 0;

6667 
	}
}

6669 *
	$¡bi__hdr_lßd
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
)

6671 
bufãr
[
STBI__HDR_BUFLEN
];

6672 *
tok’
;

6673 
v®id
 = 0;

6674 
width
, 
height
;

6675 
¡bi_uc
 *
sÿÆše
;

6676 *
hdr_d©a
;

6677 
Ën
;

6678 
couÁ
, 
v®ue
;

6679 
i
, 
j
, 
k
, 
c1
,
c2
, 
z
;

6680 cÚ¡ *
h—d”Tok’
;

6681 
	`STBI_NOTUSED
(
ri
);

6684 
h—d”Tok’
 = 
	`¡bi__hdr_g‘tok’
(
s
,
bufãr
);

6685 ià(
	`¡rcmp
(
h—d”Tok’
, "#?RADIANCE") != 0 && strcmp(headerToken, "#?RGBE") != 0)

6686  
	`¡bi__”½f
("not HDR", "Corrupt HDR image");

6690 
tok’
 = 
	`¡bi__hdr_g‘tok’
(
s
,
bufãr
);

6691 ià(
tok’
[0] == 0) ;

6692 ià(
	`¡rcmp
(
tok’
, "FORMAT=32-b™_¾e_rgbe"è=ğ0è
v®id
 = 1;

6695 ià(!
v®id
è 
	`¡bi__”½f
("unsupported format", "Unsupported HDR format");

6699 
tok’
 = 
	`¡bi__hdr_g‘tok’
(
s
,
bufãr
);

6700 ià(
	`¡ºcmp
(
tok’
, "-Y ", 3)è 
	`¡bi__”½f
("unsupported data†ayout", "Unsupported HDR format");

6701 
tok’
 += 3;

6702 
height
 = (è
	`¡¹Ş
(
tok’
, &token, 10);

6703 *
tok’
 == ' ') ++token;

6704 ià(
	`¡ºcmp
(
tok’
, "+X ", 3)è 
	`¡bi__”½f
("unsupported data†ayout", "Unsupported HDR format");

6705 
tok’
 += 3;

6706 
width
 = (è
	`¡¹Ş
(
tok’
, 
NULL
, 10);

6708 *
x
 = 
width
;

6709 *
y
 = 
height
;

6711 ià(
comp
) *comp = 3;

6712 ià(
»q_comp
 == 0)„eq_comp = 3;

6714 ià(!
	`¡bi__mad4sizes_v®id
(
width
, 
height
, 
»q_comp
, (), 0))

6715  
	`¡bi__”½f
("too†arge", "HDR image isoo†arge");

6718 
hdr_d©a
 = (*è
	`¡bi__m®loc_mad4
(
width
, 
height
, 
»q_comp
, (), 0);

6719 ià(!
hdr_d©a
)

6720  
	`¡bi__”½f
("outofmem", "Out of memory");

6724 iàĞ
width
 < 8 || width >= 32768) {

6726 
j
=0; j < 
height
; ++j) {

6727 
i
=0; i < 
width
; ++i) {

6728 
¡bi_uc
 
rgbe
[4];

6729 
maš_decode_loİ
:

6730 
	`¡bi__g‘n
(
s
, 
rgbe
, 4);

6731 
	`¡bi__hdr_cÚv”t
(
hdr_d©a
 + 
j
 * 
width
 * 
»q_comp
 + 
i
 *„eq_comp, 
rgbe
,„eq_comp);

6736 
sÿÆše
 = 
NULL
;

6738 
j
 = 0; j < 
height
; ++j) {

6739 
c1
 = 
	`¡bi__g‘8
(
s
);

6740 
c2
 = 
	`¡bi__g‘8
(
s
);

6741 
Ën
 = 
	`¡bi__g‘8
(
s
);

6742 ià(
c1
 !ğ2 || 
c2
 !ğ2 || (
Ën
 & 0x80)) {

6745 
¡bi_uc
 
rgbe
[4];

6746 
rgbe
[0] = (
¡bi_uc
è
c1
;

6747 
rgbe
[1] = (
¡bi_uc
è
c2
;

6748 
rgbe
[2] = (
¡bi_uc
è
Ën
;

6749 
rgbe
[3] = (
¡bi_uc
è
	`¡bi__g‘8
(
s
);

6750 
	`¡bi__hdr_cÚv”t
(
hdr_d©a
, 
rgbe
, 
»q_comp
);

6751 
i
 = 1;

6752 
j
 = 0;

6753 
	`STBI_FREE
(
sÿÆše
);

6754 
maš_decode_loİ
;

6756 
Ën
 <<= 8;

6757 
Ën
 |ğ
	`¡bi__g‘8
(
s
);

6758 ià(
Ën
 !ğ
width
è{ 
	`STBI_FREE
(
hdr_d©a
); STBI_FREE(
sÿÆše
);  
	`¡bi__”½f
("invalid decoded scanline†ength", "corrupt HDR"); }

6759 ià(
sÿÆše
 =ğ
NULL
) {

6760 
sÿÆše
 = (
¡bi_uc
 *è
	`¡bi__m®loc_mad2
(
width
, 4, 0);

6761 ià(!
sÿÆše
) {

6762 
	`STBI_FREE
(
hdr_d©a
);

6763  
	`¡bi__”½f
("outofmem", "Out of memory");

6767 
k
 = 0; k < 4; ++k) {

6768 
Æeá
;

6769 
i
 = 0;

6770 (
Æeá
 = 
width
 - 
i
) > 0) {

6771 
couÁ
 = 
	`¡bi__g‘8
(
s
);

6772 ià(
couÁ
 > 128) {

6774 
v®ue
 = 
	`¡bi__g‘8
(
s
);

6775 
couÁ
 -= 128;

6776 ià(
couÁ
 > 
Æeá
è{ 
	`STBI_FREE
(
hdr_d©a
); STBI_FREE(
sÿÆše
);  
	`¡bi__”½f
("corrupt", "bad RLE data in HDR"); }

6777 
z
 = 0; z < 
couÁ
; ++z)

6778 
sÿÆše
[
i
++ * 4 + 
k
] = 
v®ue
;

6781 ià(
couÁ
 > 
Æeá
è{ 
	`STBI_FREE
(
hdr_d©a
); STBI_FREE(
sÿÆše
);  
	`¡bi__”½f
("corrupt", "bad RLE data in HDR"); }

6782 
z
 = 0; z < 
couÁ
; ++z)

6783 
sÿÆše
[
i
++ * 4 + 
k
] = 
	`¡bi__g‘8
(
s
);

6787 
i
=0; i < 
width
; ++i)

6788 
	`¡bi__hdr_cÚv”t
(
hdr_d©a
+(
j
*
width
 + 
i
)*
»q_comp
, 
sÿÆše
 + i*4,„eq_comp);

6790 ià(
sÿÆše
)

6791 
	`STBI_FREE
(
sÿÆše
);

6794  
hdr_d©a
;

6795 
	}
}

6797 
	$¡bi__hdr_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
)

6799 
bufãr
[
STBI__HDR_BUFLEN
];

6800 *
tok’
;

6801 
v®id
 = 0;

6802 
dummy
;

6804 ià(!
x
èx = &
dummy
;

6805 ià(!
y
èy = &
dummy
;

6806 ià(!
comp
ècom°ğ&
dummy
;

6808 ià(
	`¡bi__hdr_‹¡
(
s
) == 0) {

6809 
	`¡bi__»wšd
Ğ
s
 );

6814 
tok’
 = 
	`¡bi__hdr_g‘tok’
(
s
,
bufãr
);

6815 ià(
tok’
[0] == 0) ;

6816 ià(
	`¡rcmp
(
tok’
, "FORMAT=32-b™_¾e_rgbe"è=ğ0è
v®id
 = 1;

6819 ià(!
v®id
) {

6820 
	`¡bi__»wšd
Ğ
s
 );

6823 
tok’
 = 
	`¡bi__hdr_g‘tok’
(
s
,
bufãr
);

6824 ià(
	`¡ºcmp
(
tok’
, "-Y ", 3)) {

6825 
	`¡bi__»wšd
Ğ
s
 );

6828 
tok’
 += 3;

6829 *
y
 = (è
	`¡¹Ş
(
tok’
, &token, 10);

6830 *
tok’
 == ' ') ++token;

6831 ià(
	`¡ºcmp
(
tok’
, "+X ", 3)) {

6832 
	`¡bi__»wšd
Ğ
s
 );

6835 
tok’
 += 3;

6836 *
x
 = (è
	`¡¹Ş
(
tok’
, 
NULL
, 10);

6837 *
comp
 = 3;

6839 
	}
}

6842 #iâdeà
STBI_NO_BMP


6843 
	$¡bi__bmp_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
)

6845 *
p
;

6846 
¡bi__bmp_d©a
 
šfo
;

6848 
šfo
.
®l_a
 = 255;

6849 
p
 = 
	`¡bi__bmp_·r£_h—d”
(
s
, &
šfo
);

6850 
	`¡bi__»wšd
Ğ
s
 );

6851 ià(
p
 =ğ
NULL
)

6853 ià(
x
è*x = 
s
->
img_x
;

6854 ià(
y
è*y = 
s
->
img_y
;

6855 ià(
comp
è*com°ğ
šfo
.
ma
 ? 4 : 3;

6857 
	}
}

6860 #iâdeà
STBI_NO_PSD


6861 
	$¡bi__psd_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
)

6863 
chªÃlCouÁ
, 
dummy
, 
d•th
;

6864 ià(!
x
èx = &
dummy
;

6865 ià(!
y
èy = &
dummy
;

6866 ià(!
comp
ècom°ğ&
dummy
;

6867 ià(
	`¡bi__g‘32be
(
s
) != 0x38425053) {

6868 
	`¡bi__»wšd
Ğ
s
 );

6871 ià(
	`¡bi__g‘16be
(
s
) != 1) {

6872 
	`¡bi__»wšd
Ğ
s
 );

6875 
	`¡bi__sk
(
s
, 6);

6876 
chªÃlCouÁ
 = 
	`¡bi__g‘16be
(
s
);

6877 ià(
chªÃlCouÁ
 < 0 || channelCount > 16) {

6878 
	`¡bi__»wšd
Ğ
s
 );

6881 *
y
 = 
	`¡bi__g‘32be
(
s
);

6882 *
x
 = 
	`¡bi__g‘32be
(
s
);

6883 
d•th
 = 
	`¡bi__g‘16be
(
s
);

6884 ià(
d•th
 != 8 && depth != 16) {

6885 
	`¡bi__»wšd
Ğ
s
 );

6888 ià(
	`¡bi__g‘16be
(
s
) != 3) {

6889 
	`¡bi__»wšd
Ğ
s
 );

6892 *
comp
 = 4;

6894 
	}
}

6896 
	$¡bi__psd_is16
(
¡bi__cÚ‹xt
 *
s
)

6898 
chªÃlCouÁ
, 
d•th
;

6899 ià(
	`¡bi__g‘32be
(
s
) != 0x38425053) {

6900 
	`¡bi__»wšd
Ğ
s
 );

6903 ià(
	`¡bi__g‘16be
(
s
) != 1) {

6904 
	`¡bi__»wšd
Ğ
s
 );

6907 
	`¡bi__sk
(
s
, 6);

6908 
chªÃlCouÁ
 = 
	`¡bi__g‘16be
(
s
);

6909 ià(
chªÃlCouÁ
 < 0 || channelCount > 16) {

6910 
	`¡bi__»wšd
Ğ
s
 );

6913 (è
	`¡bi__g‘32be
(
s
);

6914 (è
	`¡bi__g‘32be
(
s
);

6915 
d•th
 = 
	`¡bi__g‘16be
(
s
);

6916 ià(
d•th
 != 16) {

6917 
	`¡bi__»wšd
Ğ
s
 );

6921 
	}
}

6924 #iâdeà
STBI_NO_PIC


6925 
	$¡bi__pic_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
)

6927 
aù_comp
=0,
num_·ck‘s
=0,
chašed
,
dummy
;

6928 
¡bi__pic_·ck‘
 
·ck‘s
[10];

6930 ià(!
x
èx = &
dummy
;

6931 ià(!
y
èy = &
dummy
;

6932 ià(!
comp
ècom°ğ&
dummy
;

6934 ià(!
	`¡bi__pic_is4
(
s
,"\x53\x80\xF6\x34")) {

6935 
	`¡bi__»wšd
(
s
);

6939 
	`¡bi__sk
(
s
, 88);

6941 *
x
 = 
	`¡bi__g‘16be
(
s
);

6942 *
y
 = 
	`¡bi__g‘16be
(
s
);

6943 ià(
	`¡bi__©_eof
(
s
)) {

6944 
	`¡bi__»wšd
Ğ
s
);

6947 iàĞ(*
x
è!ğ0 && (1 << 28è/ (*xè< (*
y
)) {

6948 
	`¡bi__»wšd
Ğ
s
 );

6952 
	`¡bi__sk
(
s
, 8);

6955 
¡bi__pic_·ck‘
 *
·ck‘
;

6957 ià(
num_·ck‘s
==(
·ck‘s
)/(packets[0]))

6960 
·ck‘
 = &
·ck‘s
[
num_·ck‘s
++];

6961 
chašed
 = 
	`¡bi__g‘8
(
s
);

6962 
·ck‘
->
size
 = 
	`¡bi__g‘8
(
s
);

6963 
·ck‘
->
ty³
 = 
	`¡bi__g‘8
(
s
);

6964 
·ck‘
->
chªÃl
 = 
	`¡bi__g‘8
(
s
);

6965 
aù_comp
 |ğ
·ck‘
->
chªÃl
;

6967 ià(
	`¡bi__©_eof
(
s
)) {

6968 
	`¡bi__»wšd
Ğ
s
 );

6971 ià(
·ck‘
->
size
 != 8) {

6972 
	`¡bi__»wšd
Ğ
s
 );

6975 } 
chašed
);

6977 *
comp
 = (
aù_comp
 & 0x10 ? 4 : 3);

6980 
	}
}

6995 #iâdeà
STBI_NO_PNM


6997 
	$¡bi__²m_‹¡
(
¡bi__cÚ‹xt
 *
s
)

6999 
p
, 
t
;

7000 
p
 = (è
	`¡bi__g‘8
(
s
);

7001 
t
 = (è
	`¡bi__g‘8
(
s
);

7002 ià(
p
 !ğ'P' || (
t
 != '5' && != '6')) {

7003 
	`¡bi__»wšd
Ğ
s
 );

7007 
	}
}

7009 *
	$¡bi__²m_lßd
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
, 
»q_comp
, 
¡bi__»suÉ_šfo
 *
ri
)

7011 
¡bi_uc
 *
out
;

7012 
	`STBI_NOTUSED
(
ri
);

7014 ià(!
	`¡bi__²m_šfo
(
s
, (*)&s->
img_x
, (*)&s->
img_y
, (*)&s->
img_n
))

7017 *
x
 = 
s
->
img_x
;

7018 *
y
 = 
s
->
img_y
;

7019 ià(
comp
è*com°ğ
s
->
img_n
;

7021 ià(!
	`¡bi__mad3sizes_v®id
(
s
->
img_n
, s->
img_x
, s->
img_y
, 0))

7022  
	`¡bi__”½uc
("too†arge", "PNMoo†arge");

7024 
out
 = (
¡bi_uc
 *è
	`¡bi__m®loc_mad3
(
s
->
img_n
, s->
img_x
, s->
img_y
, 0);

7025 ià(!
out
è 
	`¡bi__”½uc
("outofmem", "Out of memory");

7026 
	`¡bi__g‘n
(
s
, 
out
, s->
img_n
 * s->
img_x
 * s->
img_y
);

7028 ià(
»q_comp
 &&„eq_com°!ğ
s
->
img_n
) {

7029 
out
 = 
	`¡bi__cÚv”t_fÜm©
(out, 
s
->
img_n
, 
»q_comp
, s->
img_x
, s->
img_y
);

7030 ià(
out
 =ğ
NULL
)  out;

7032  
out
;

7033 
	}
}

7035 
	$¡bi__²m_is¥aû
(
c
)

7037  
c
 == ' ' || c == '\t' || c == '\n' || c == '\v' || c == '\f' || c == '\r';

7038 
	}
}

7040 
	$¡bi__²m_sk_wh™e¥aû
(
¡bi__cÚ‹xt
 *
s
, *
c
)

7043 !
	`¡bi__©_eof
(
s
è&& 
	`¡bi__²m_is¥aû
(*
c
))

7044 *
c
 = (è
	`¡bi__g‘8
(
s
);

7046 ià(
	`¡bi__©_eof
(
s
è|| *
c
 != '#')

7049 !
	`¡bi__©_eof
(
s
è&& *
c
 != '\n' && *c != '\r' )

7050 *
c
 = (è
	`¡bi__g‘8
(
s
);

7052 
	}
}

7054 
	$¡bi__²m_isdig™
(
c
)

7056  
c
 >= '0' && c <= '9';

7057 
	}
}

7059 
	$¡bi__²m_g‘š‹g”
(
¡bi__cÚ‹xt
 *
s
, *
c
)

7061 
v®ue
 = 0;

7063 !
	`¡bi__©_eof
(
s
è&& 
	`¡bi__²m_isdig™
(*
c
)) {

7064 
v®ue
 = v®ue*10 + (*
c
 - '0');

7065 *
c
 = (è
	`¡bi__g‘8
(
s
);

7068  
v®ue
;

7069 
	}
}

7071 
	$¡bi__²m_šfo
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
)

7073 
maxv
, 
dummy
;

7074 
c
, 
p
, 
t
;

7076 ià(!
x
èx = &
dummy
;

7077 ià(!
y
èy = &
dummy
;

7078 ià(!
comp
ècom°ğ&
dummy
;

7080 
	`¡bi__»wšd
(
s
);

7083 
p
 = (è
	`¡bi__g‘8
(
s
);

7084 
t
 = (è
	`¡bi__g‘8
(
s
);

7085 ià(
p
 !ğ'P' || (
t
 != '5' && != '6')) {

7086 
	`¡bi__»wšd
(
s
);

7090 *
comp
 = (
t
 == '6') ? 3 : 1;

7092 
c
 = (è
	`¡bi__g‘8
(
s
);

7093 
	`¡bi__²m_sk_wh™e¥aû
(
s
, &
c
);

7095 *
x
 = 
	`¡bi__²m_g‘š‹g”
(
s
, &
c
);

7096 
	`¡bi__²m_sk_wh™e¥aû
(
s
, &
c
);

7098 *
y
 = 
	`¡bi__²m_g‘š‹g”
(
s
, &
c
);

7099 
	`¡bi__²m_sk_wh™e¥aû
(
s
, &
c
);

7101 
maxv
 = 
	`¡bi__²m_g‘š‹g”
(
s
, &
c
);

7103 ià(
maxv
 > 255)

7104  
	`¡bi__”r
("max value > 255", "PPM image‚ot 8-bit");

7107 
	}
}

7110 
	$¡bi__šfo_maš
(
¡bi__cÚ‹xt
 *
s
, *
x
, *
y
, *
comp
)

7112 #iâdeà
STBI_NO_JPEG


7113 ià(
	`¡bi__j³g_šfo
(
s
, 
x
, 
y
, 
comp
))  1;

7116 #iâdeà
STBI_NO_PNG


7117 ià(
	`¡bi__²g_šfo
(
s
, 
x
, 
y
, 
comp
))  1;

7120 #iâdeà
STBI_NO_GIF


7121 ià(
	`¡bi__gif_šfo
(
s
, 
x
, 
y
, 
comp
))  1;

7124 #iâdeà
STBI_NO_BMP


7125 ià(
	`¡bi__bmp_šfo
(
s
, 
x
, 
y
, 
comp
))  1;

7128 #iâdeà
STBI_NO_PSD


7129 ià(
	`¡bi__psd_šfo
(
s
, 
x
, 
y
, 
comp
))  1;

7132 #iâdeà
STBI_NO_PIC


7133 ià(
	`¡bi__pic_šfo
(
s
, 
x
, 
y
, 
comp
))  1;

7136 #iâdeà
STBI_NO_PNM


7137 ià(
	`¡bi__²m_šfo
(
s
, 
x
, 
y
, 
comp
))  1;

7140 #iâdeà
STBI_NO_HDR


7141 ià(
	`¡bi__hdr_šfo
(
s
, 
x
, 
y
, 
comp
))  1;

7145 #iâdeà
STBI_NO_TGA


7146 ià(
	`¡bi__tga_šfo
(
s
, 
x
, 
y
, 
comp
))

7149  
	`¡bi__”r
("unknown imageype", "Image‚ot of‡ny knownype, or corrupt");

7150 
	}
}

7152 
	$¡bi__is_16_maš
(
¡bi__cÚ‹xt
 *
s
)

7154 #iâdeà
STBI_NO_PNG


7155 ià(
	`¡bi__²g_is16
(
s
))  1;

7158 #iâdeà
STBI_NO_PSD


7159 ià(
	`¡bi__psd_is16
(
s
))  1;

7163 
	}
}

7165 #iâdeà
STBI_NO_STDIO


7166 
STBIDEF
 
	$¡bi_šfo
(cÚ¡ *
f’ame
, *
x
, *
y
, *
comp
)

7168 
FILE
 *
f
 = 
	`¡bi__fİ’
(
f’ame
, "rb");

7169 
»suÉ
;

7170 ià(!
f
è 
	`¡bi__”r
("can't fopen", "Unableo open file");

7171 
»suÉ
 = 
	`¡bi_šfo_äom_fe
(
f
, 
x
, 
y
, 
comp
);

7172 
	`fşo£
(
f
);

7173  
»suÉ
;

7174 
	}
}

7176 
STBIDEF
 
	$¡bi_šfo_äom_fe
(
FILE
 *
f
, *
x
, *
y
, *
comp
)

7178 
r
;

7179 
¡bi__cÚ‹xt
 
s
;

7180 
pos
 = 
	`á–l
(
f
);

7181 
	`¡bi__¡¬t_fe
(&
s
, 
f
);

7182 
r
 = 
	`¡bi__šfo_maš
(&
s
,
x
,
y
,
comp
);

7183 
	`f£ek
(
f
,
pos
,
SEEK_SET
);

7184  
r
;

7185 
	}
}

7187 
STBIDEF
 
	$¡bi_is_16_b™
(cÚ¡ *
f’ame
)

7189 
FILE
 *
f
 = 
	`¡bi__fİ’
(
f’ame
, "rb");

7190 
»suÉ
;

7191 ià(!
f
è 
	`¡bi__”r
("can't fopen", "Unableo open file");

7192 
»suÉ
 = 
	`¡bi_is_16_b™_äom_fe
(
f
);

7193 
	`fşo£
(
f
);

7194  
»suÉ
;

7195 
	}
}

7197 
STBIDEF
 
	$¡bi_is_16_b™_äom_fe
(
FILE
 *
f
)

7199 
r
;

7200 
¡bi__cÚ‹xt
 
s
;

7201 
pos
 = 
	`á–l
(
f
);

7202 
	`¡bi__¡¬t_fe
(&
s
, 
f
);

7203 
r
 = 
	`¡bi__is_16_maš
(&
s
);

7204 
	`f£ek
(
f
,
pos
,
SEEK_SET
);

7205  
r
;

7206 
	}
}

7209 
STBIDEF
 
	$¡bi_šfo_äom_memÜy
(
¡bi_uc
 cÚ¡ *
bufãr
, 
Ën
, *
x
, *
y
, *
comp
)

7211 
¡bi__cÚ‹xt
 
s
;

7212 
	`¡bi__¡¬t_mem
(&
s
,
bufãr
,
Ën
);

7213  
	`¡bi__šfo_maš
(&
s
,
x
,
y
,
comp
);

7214 
	}
}

7216 
STBIDEF
 
	$¡bi_šfo_äom_ÿÎbacks
(
¡bi_io_ÿÎbacks
 cÚ¡ *
c
, *
u£r
, *
x
, *
y
, *
comp
)

7218 
¡bi__cÚ‹xt
 
s
;

7219 
	`¡bi__¡¬t_ÿÎbacks
(&
s
, (
¡bi_io_ÿÎbacks
 *è
c
, 
u£r
);

7220  
	`¡bi__šfo_maš
(&
s
,
x
,
y
,
comp
);

7221 
	}
}

7223 
STBIDEF
 
	$¡bi_is_16_b™_äom_memÜy
(
¡bi_uc
 cÚ¡ *
bufãr
, 
Ën
)

7225 
¡bi__cÚ‹xt
 
s
;

7226 
	`¡bi__¡¬t_mem
(&
s
,
bufãr
,
Ën
);

7227  
	`¡bi__is_16_maš
(&
s
);

7228 
	}
}

7230 
STBIDEF
 
	$¡bi_is_16_b™_äom_ÿÎbacks
(
¡bi_io_ÿÎbacks
 cÚ¡ *
c
, *
u£r
)

7232 
¡bi__cÚ‹xt
 
s
;

7233 
	`¡bi__¡¬t_ÿÎbacks
(&
s
, (
¡bi_io_ÿÎbacks
 *è
c
, 
u£r
);

7234  
	`¡bi__is_16_maš
(&
s
);

7235 
	}
}

	@stb_image_write.h

148 #iâdeà
INCLUDE_STB_IMAGE_WRITE_H


149 
	#INCLUDE_STB_IMAGE_WRITE_H


	)

152 #iâdeà
STBIWDEF


153 #ifdeà
STB_IMAGE_WRITE_STATIC


154 
	#STBIWDEF
 

	)

156 #ifdeà
__ılu¥lus


157 
	#STBIWDEF
 "C"

	)

159 
	#STBIWDEF
 

	)

164 #iâdeà
STB_IMAGE_WRITE_STATIC


165 
¡bi_wr™e_tga_w™h_¾e
;

166 
¡bi_wr™e_²g_com´essiÚ_Ëv–
;

167 
¡bi_wr™e_fÜû_²g_f‹r
;

170 #iâdeà
STBI_WRITE_NO_STDIO


171 
STBIWDEF
 
¡bi_wr™e_²g
(cÚ¡ *
f’ame
, 
w
, 
h
, 
comp
, cÚ¡ *
d©a
, 
¡ride_š_by‹s
);

172 
STBIWDEF
 
¡bi_wr™e_bmp
(cÚ¡ *
f’ame
, 
w
, 
h
, 
comp
, cÚ¡ *
d©a
);

173 
STBIWDEF
 
¡bi_wr™e_tga
(cÚ¡ *
f’ame
, 
w
, 
h
, 
comp
, cÚ¡ *
d©a
);

174 
STBIWDEF
 
¡bi_wr™e_hdr
(cÚ¡ *
f’ame
, 
w
, 
h
, 
comp
, cÚ¡ *
d©a
);

175 
STBIWDEF
 
¡bi_wr™e_jpg
(cÚ¡ *
f’ame
, 
x
, 
y
, 
comp
, cÚ¡ *
d©a
, 
qu®™y
);

178 
	t¡bi_wr™e_func
(*
	tcÚ‹xt
, *
	td©a
, 
	tsize
);

180 
STBIWDEF
 
¡bi_wr™e_²g_to_func
(
¡bi_wr™e_func
 *
func
, *
cÚ‹xt
, 
w
, 
h
, 
comp
, cÚ¡ *
d©a
, 
¡ride_š_by‹s
);

181 
STBIWDEF
 
¡bi_wr™e_bmp_to_func
(
¡bi_wr™e_func
 *
func
, *
cÚ‹xt
, 
w
, 
h
, 
comp
, cÚ¡ *
d©a
);

182 
STBIWDEF
 
¡bi_wr™e_tga_to_func
(
¡bi_wr™e_func
 *
func
, *
cÚ‹xt
, 
w
, 
h
, 
comp
, cÚ¡ *
d©a
);

183 
STBIWDEF
 
¡bi_wr™e_hdr_to_func
(
¡bi_wr™e_func
 *
func
, *
cÚ‹xt
, 
w
, 
h
, 
comp
, cÚ¡ *
d©a
);

184 
STBIWDEF
 
¡bi_wr™e_jpg_to_func
(
¡bi_wr™e_func
 *
func
, *
cÚ‹xt
, 
x
, 
y
, 
comp
, cÚ¡ *
d©a
, 
qu®™y
);

186 
STBIWDEF
 
¡bi_æ_v”tiÿÎy_Ú_wr™e
(
æ_boŞ—n
);

190 #ifdeà
STB_IMAGE_WRITE_IMPLEMENTATION


192 #ifdeà
_WIN32


193 #iâdeà
_CRT_SECURE_NO_WARNINGS


194 
	#_CRT_SECURE_NO_WARNINGS


	)

196 #iâdeà
_CRT_NONSTDC_NO_DEPRECATE


197 
	#_CRT_NONSTDC_NO_DEPRECATE


	)

201 #iâdeà
STBI_WRITE_NO_STDIO


202 
	~<¡dio.h
>

205 
	~<¡d¬g.h
>

206 
	~<¡dlib.h
>

207 
	~<¡ršg.h
>

208 
	~<m©h.h
>

210 #ià
defšed
(
STBIW_MALLOC
è&& defšed(
STBIW_FREE
è&& (defšed(
STBIW_REALLOC
è|| defšed(
STBIW_REALLOC_SIZED
))

212 #–ià!
defšed
(
STBIW_MALLOC
è&& !defšed(
STBIW_FREE
è&& !defšed(
STBIW_REALLOC
è&& !defšed(
STBIW_REALLOC_SIZED
)

218 #iâdeà
STBIW_MALLOC


219 
	#STBIW_MALLOC
(
sz
è
	`m®loc
(sz)

	)

220 
	#STBIW_REALLOC
(
p
,
Ãwsz
è
	`»®loc
Õ,Ãwsz)

	)

221 
	#STBIW_FREE
(
p
è
	`ä“
Õ)

	)

224 #iâdeà
STBIW_REALLOC_SIZED


225 
	#STBIW_REALLOC_SIZED
(
p
,
Şdsz
,
Ãwsz
è
	`STBIW_REALLOC
Õ,Ãwsz)

	)

229 #iâdeà
STBIW_MEMMOVE


230 
	#STBIW_MEMMOVE
(
a
,
b
,
sz
è
	`memmove
×,b,sz)

	)

234 #iâdeà
STBIW_ASSERT


235 
	~<as£¹.h
>

236 
	#STBIW_ASSERT
(
x
è
	`as£¹
(x)

	)

239 
	#STBIW_UCHAR
(
x
è(è((xè& 0xff)

	)

241 #ifdeà
STB_IMAGE_WRITE_STATIC


242 
	g¡bi__æ_v”tiÿÎy_Ú_wr™e
=0;

243 
	g¡bi_wr™e_²g_com´essiÚ_Ëv–
 = 8;

244 
	g¡bi_wr™e_tga_w™h_¾e
 = 1;

245 
	g¡bi_wr™e_fÜû_²g_f‹r
 = -1;

247 
	g¡bi_wr™e_²g_com´essiÚ_Ëv–
 = 8;

248 
	g¡bi__æ_v”tiÿÎy_Ú_wr™e
=0;

249 
	g¡bi_wr™e_tga_w™h_¾e
 = 1;

250 
	g¡bi_wr™e_fÜû_²g_f‹r
 = -1;

253 
STBIWDEF
 
	$¡bi_æ_v”tiÿÎy_Ú_wr™e
(
æag
)

255 
¡bi__æ_v”tiÿÎy_Ú_wr™e
 = 
æag
;

256 
	}
}

260 
¡bi_wr™e_func
 *
	mfunc
;

261 *
	mcÚ‹xt
;

262 } 
	t¡bi__wr™e_cÚ‹xt
;

265 
	$¡bi__¡¬t_wr™e_ÿÎbacks
(
¡bi__wr™e_cÚ‹xt
 *
s
, 
¡bi_wr™e_func
 *
c
, *
cÚ‹xt
)

267 
s
->
func
 = 
c
;

268 
s
->
cÚ‹xt
 = context;

269 
	}
}

271 #iâdeà
STBI_WRITE_NO_STDIO


273 
	$¡bi__¡dio_wr™e
(*
cÚ‹xt
, *
d©a
, 
size
)

275 
	`fwr™e
(
d©a
,1,
size
,(
FILE
*è
cÚ‹xt
);

276 
	}
}

278 
	$¡bi__¡¬t_wr™e_fe
(
¡bi__wr™e_cÚ‹xt
 *
s
, cÚ¡ *
f’ame
)

280 
FILE
 *
f
;

281 #ifdeà
STBI_MSC_SECURE_CRT


282 ià(
	`fİ’_s
(&
f
, 
f’ame
, "wb"))

283 
f
 = 
NULL
;

285 
f
 = 
	`fİ’
(
f’ame
, "wb");

287 
	`¡bi__¡¬t_wr™e_ÿÎbacks
(
s
, 
¡bi__¡dio_wr™e
, (*è
f
);

288  
f
 !ğ
NULL
;

289 
	}
}

291 
	$¡bi__’d_wr™e_fe
(
¡bi__wr™e_cÚ‹xt
 *
s
)

293 
	`fşo£
((
FILE
 *)
s
->
cÚ‹xt
);

294 
	}
}

298 
	t¡biw_ušt32
;

299 
	t¡b_image_wr™e_‹¡
[(
¡biw_ušt32
)==4 ? 1 : -1];

301 
	$¡biw__wr™efv
(
¡bi__wr™e_cÚ‹xt
 *
s
, cÚ¡ *
fmt
, 
va_li¡
 
v
)

303 *
fmt
) {

304 *
fmt
++) {

306 '1': { 
x
 = 
	`STBIW_UCHAR
(
	`va_¬g
(
v
, ));

307 
s
->
	`func
(s->
cÚ‹xt
,&
x
,1);

309 '2': { 
x
 = 
	`va_¬g
(
v
,);

310 
b
[2];

311 
b
[0] = 
	`STBIW_UCHAR
(
x
);

312 
b
[1] = 
	`STBIW_UCHAR
(
x
>>8);

313 
s
->
	`func
(s->
cÚ‹xt
,
b
,2);

315 '4': { 
¡biw_ušt32
 
x
 = 
	`va_¬g
(
v
,);

316 
b
[4];

317 
b
[0]=
	`STBIW_UCHAR
(
x
);

318 
b
[1]=
	`STBIW_UCHAR
(
x
>>8);

319 
b
[2]=
	`STBIW_UCHAR
(
x
>>16);

320 
b
[3]=
	`STBIW_UCHAR
(
x
>>24);

321 
s
->
	`func
(s->
cÚ‹xt
,
b
,4);

324 
	`STBIW_ASSERT
(0);

328 
	}
}

330 
	$¡biw__wr™ef
(
¡bi__wr™e_cÚ‹xt
 *
s
, cÚ¡ *
fmt
, ...)

332 
va_li¡
 
v
;

333 
	`va_¡¬t
(
v
, 
fmt
);

334 
	`¡biw__wr™efv
(
s
, 
fmt
, 
v
);

335 
	`va_’d
(
v
);

336 
	}
}

338 
	$¡biw__putc
(
¡bi__wr™e_cÚ‹xt
 *
s
, 
c
)

340 
s
->
	`func
(s->
cÚ‹xt
, &
c
, 1);

341 
	}
}

343 
	$¡biw__wr™e3
(
¡bi__wr™e_cÚ‹xt
 *
s
, 
a
, 
b
, 
c
)

345 
¬r
[3];

346 
¬r
[0] = 
a
,‡¼[1] = 
b
,‡¼[2] = 
c
;

347 
s
->
	`func
(s->
cÚ‹xt
, 
¬r
, 3);

348 
	}
}

350 
	$¡biw__wr™e_pix–
(
¡bi__wr™e_cÚ‹xt
 *
s
, 
rgb_dœ
, 
comp
, 
wr™e_®pha
, 
ex·nd_mÚo
, *
d
)

352 
bg
[3] = { 255, 0, 255}, 
px
[3];

353 
k
;

355 ià(
wr™e_®pha
 < 0)

356 
s
->
	`func
(s->
cÚ‹xt
, &
d
[
comp
 - 1], 1);

358 
comp
) {

361 ià(
ex·nd_mÚo
)

362 
	`¡biw__wr™e3
(
s
, 
d
[0], d[0], d[0]);

364 
s
->
	`func
(s->
cÚ‹xt
, 
d
, 1);

367 ià(!
wr™e_®pha
) {

369 
k
 = 0; k < 3; ++k)

370 
px
[
k
] = 
bg
[k] + ((
d
[k] - bg[k]) * d[3]) / 255;

371 
	`¡biw__wr™e3
(
s
, 
px
[1 - 
rgb_dœ
],…x[1],…x[1 +„gb_dir]);

376 
	`¡biw__wr™e3
(
s
, 
d
[1 - 
rgb_dœ
], d[1], d[1 +„gb_dir]);

379 ià(
wr™e_®pha
 > 0)

380 
s
->
	`func
(s->
cÚ‹xt
, &
d
[
comp
 - 1], 1);

381 
	}
}

383 
	$¡biw__wr™e_pix–s
(
¡bi__wr™e_cÚ‹xt
 *
s
, 
rgb_dœ
, 
vdœ
, 
x
, 
y
, 
comp
, *
d©a
, 
wr™e_®pha
, 
sÿÆše_·d
, 
ex·nd_mÚo
)

385 
¡biw_ušt32
 
z”o
 = 0;

386 
i
,
j
, 
j_’d
;

388 ià(
y
 <= 0)

391 ià(
¡bi__æ_v”tiÿÎy_Ú_wr™e
)

392 
vdœ
 *= -1;

394 ià(
vdœ
 < 0)

395 
j_’d
 = -1, 
j
 = 
y
-1;

397 
j_’d
 = 
y
, 
j
 = 0;

399 ; 
j
 !ğ
j_’d
; j +ğ
vdœ
) {

400 
i
=0; i < 
x
; ++i) {

401 *
d
 = (*è
d©a
 + (
j
*
x
+
i
)*
comp
;

402 
	`¡biw__wr™e_pix–
(
s
, 
rgb_dœ
, 
comp
, 
wr™e_®pha
, 
ex·nd_mÚo
, 
d
);

404 
s
->
	`func
(s->
cÚ‹xt
, &
z”o
, 
sÿÆše_·d
);

406 
	}
}

408 
	$¡biw__outfe
(
¡bi__wr™e_cÚ‹xt
 *
s
, 
rgb_dœ
, 
vdœ
, 
x
, 
y
, 
comp
, 
ex·nd_mÚo
, *
d©a
, 
®pha
, 
·d
, cÚ¡ *
fmt
, ...)

410 ià(
y
 < 0 || 
x
 < 0) {

413 
va_li¡
 
v
;

414 
	`va_¡¬t
(
v
, 
fmt
);

415 
	`¡biw__wr™efv
(
s
, 
fmt
, 
v
);

416 
	`va_’d
(
v
);

417 
	`¡biw__wr™e_pix–s
(
s
,
rgb_dœ
,
vdœ
,
x
,
y
,
comp
,
d©a
,
®pha
,
·d
, 
ex·nd_mÚo
);

420 
	}
}

422 
	$¡bi_wr™e_bmp_cÜe
(
¡bi__wr™e_cÚ‹xt
 *
s
, 
x
, 
y
, 
comp
, cÚ¡ *
d©a
)

424 
·d
 = (-
x
*3) & 3;

425  
	`¡biw__outfe
(
s
,-1,-1,
x
,
y
,
comp
,1,(*è
d©a
,0,
·d
,

427 'B', 'M', 14+40+(
x
*3+
·d
)*
y
, 0,0, 14+40,

428 40, 
x
,
y
, 1,24, 0,0,0,0,0,0);

429 
	}
}

431 
STBIWDEF
 
	$¡bi_wr™e_bmp_to_func
(
¡bi_wr™e_func
 *
func
, *
cÚ‹xt
, 
x
, 
y
, 
comp
, cÚ¡ *
d©a
)

433 
¡bi__wr™e_cÚ‹xt
 
s
;

434 
	`¡bi__¡¬t_wr™e_ÿÎbacks
(&
s
, 
func
, 
cÚ‹xt
);

435  
	`¡bi_wr™e_bmp_cÜe
(&
s
, 
x
, 
y
, 
comp
, 
d©a
);

436 
	}
}

438 #iâdeà
STBI_WRITE_NO_STDIO


439 
STBIWDEF
 
	$¡bi_wr™e_bmp
(cÚ¡ *
f’ame
, 
x
, 
y
, 
comp
, cÚ¡ *
d©a
)

441 
¡bi__wr™e_cÚ‹xt
 
s
;

442 ià(
	`¡bi__¡¬t_wr™e_fe
(&
s
,
f’ame
)) {

443 
r
 = 
	`¡bi_wr™e_bmp_cÜe
(&
s
, 
x
, 
y
, 
comp
, 
d©a
);

444 
	`¡bi__’d_wr™e_fe
(&
s
);

445  
r
;

448 
	}
}

451 
	$¡bi_wr™e_tga_cÜe
(
¡bi__wr™e_cÚ‹xt
 *
s
, 
x
, 
y
, 
comp
, *
d©a
)

453 
has_®pha
 = (
comp
 == 2 || comp == 4);

454 
cŞÜby‹s
 = 
has_®pha
 ? 
comp
-1 : comp;

455 
fÜm©
 = 
cŞÜby‹s
 < 2 ? 3 : 2;

457 ià(
y
 < 0 || 
x
 < 0)

460 ià(!
¡bi_wr™e_tga_w™h_¾e
) {

461  
	`¡biw__outfe
(
s
, -1, -1, 
x
, 
y
, 
comp
, 0, (*è
d©a
, 
has_®pha
, 0,

462 "111 221 2222 11", 0, 0, 
fÜm©
, 0, 0, 0, 0, 0, 
x
, 
y
, (
cŞÜby‹s
 + 
has_®pha
) * 8, has_alpha * 8);

464 
i
,
j
,
k
;

465 
j’d
, 
jdœ
;

467 
	`¡biw__wr™ef
(
s
, "111 221 2222 11", 0,0,
fÜm©
+8, 0,0,0, 0,0,
x
,
y
, (
cŞÜby‹s
 + 
has_®pha
) * 8, has_alpha * 8);

469 ià(
¡bi__æ_v”tiÿÎy_Ú_wr™e
) {

470 
j
 = 0;

471 
j’d
 = 
y
;

472 
jdœ
 = 1;

474 
j
 = 
y
-1;

475 
j’d
 = -1;

476 
jdœ
 = -1;

478 ; 
j
 !ğ
j’d
; j +ğ
jdœ
) {

479 *
row
 = (*è
d©a
 + 
j
 * 
x
 * 
comp
;

480 
Ën
;

482 
i
 = 0; i < 
x
; i +ğ
Ën
) {

483 *
begš
 = 
row
 + 
i
 * 
comp
;

484 
diff
 = 1;

485 
Ën
 = 1;

487 ià(
i
 < 
x
 - 1) {

488 ++
Ën
;

489 
diff
 = 
	`memcmp
(
begš
, 
row
 + (
i
 + 1è* 
comp
, comp);

490 ià(
diff
) {

491 cÚ¡ *
´ev
 = 
begš
;

492 
k
 = 
i
 + 2; k < 
x
 && 
Ën
 < 128; ++k) {

493 ià(
	`memcmp
(
´ev
, 
row
 + 
k
 * 
comp
, comp)) {

494 
´ev
 +ğ
comp
;

495 ++
Ën
;

497 --
Ën
;

502 
k
 = 
i
 + 2; k < 
x
 && 
Ën
 < 128; ++k) {

503 ià(!
	`memcmp
(
begš
, 
row
 + 
k
 * 
comp
, comp)) {

504 ++
Ën
;

512 ià(
diff
) {

513 
h—d”
 = 
	`STBIW_UCHAR
(
Ën
 - 1);

514 
s
->
	`func
(s->
cÚ‹xt
, &
h—d”
, 1);

515 
k
 = 0; k < 
Ën
; ++k) {

516 
	`¡biw__wr™e_pix–
(
s
, -1, 
comp
, 
has_®pha
, 0, 
begš
 + 
k
 * comp);

519 
h—d”
 = 
	`STBIW_UCHAR
(
Ën
 - 129);

520 
s
->
	`func
(s->
cÚ‹xt
, &
h—d”
, 1);

521 
	`¡biw__wr™e_pix–
(
s
, -1, 
comp
, 
has_®pha
, 0, 
begš
);

527 
	}
}

529 
STBIWDEF
 
	$¡bi_wr™e_tga_to_func
(
¡bi_wr™e_func
 *
func
, *
cÚ‹xt
, 
x
, 
y
, 
comp
, cÚ¡ *
d©a
)

531 
¡bi__wr™e_cÚ‹xt
 
s
;

532 
	`¡bi__¡¬t_wr™e_ÿÎbacks
(&
s
, 
func
, 
cÚ‹xt
);

533  
	`¡bi_wr™e_tga_cÜe
(&
s
, 
x
, 
y
, 
comp
, (*è
d©a
);

534 
	}
}

536 #iâdeà
STBI_WRITE_NO_STDIO


537 
STBIWDEF
 
	$¡bi_wr™e_tga
(cÚ¡ *
f’ame
, 
x
, 
y
, 
comp
, cÚ¡ *
d©a
)

539 
¡bi__wr™e_cÚ‹xt
 
s
;

540 ià(
	`¡bi__¡¬t_wr™e_fe
(&
s
,
f’ame
)) {

541 
r
 = 
	`¡bi_wr™e_tga_cÜe
(&
s
, 
x
, 
y
, 
comp
, (*è
d©a
);

542 
	`¡bi__’d_wr™e_fe
(&
s
);

543  
r
;

546 
	}
}

553 
	#¡biw__max
(
a
, 
b
è(×è> (bè? (aè: (b))

	)

555 
	$¡biw__lš—r_to_rgbe
(*
rgbe
, *
lš—r
)

557 
expÚ’t
;

558 
maxcomp
 = 
	`¡biw__max
(
lš—r
[0], stbiw__max(linear[1],†inear[2]));

560 ià(
maxcomp
 < 1e-32f) {

561 
rgbe
[0] =„gbe[1] =„gbe[2] =„gbe[3] = 0;

563 
nÜm®ize
 = (è
	`äexp
(
maxcomp
, &
expÚ’t
) * 256.0f/maxcomp;

565 
rgbe
[0] = ()(
lš—r
[0] * 
nÜm®ize
);

566 
rgbe
[1] = ()(
lš—r
[1] * 
nÜm®ize
);

567 
rgbe
[2] = ()(
lš—r
[2] * 
nÜm®ize
);

568 
rgbe
[3] = ()(
expÚ’t
 + 128);

570 
	}
}

572 
	$¡biw__wr™e_run_d©a
(
¡bi__wr™e_cÚ‹xt
 *
s
, 
Ëngth
, 
d©aby‹
)

574 
Ëngthby‹
 = 
	`STBIW_UCHAR
(
Ëngth
+128);

575 
	`STBIW_ASSERT
(
Ëngth
+128 <= 255);

576 
s
->
	`func
(s->
cÚ‹xt
, &
Ëngthby‹
, 1);

577 
s
->
	`func
(s->
cÚ‹xt
, &
d©aby‹
, 1);

578 
	}
}

580 
	$¡biw__wr™e_dump_d©a
(
¡bi__wr™e_cÚ‹xt
 *
s
, 
Ëngth
, *
d©a
)

582 
Ëngthby‹
 = 
	`STBIW_UCHAR
(
Ëngth
);

583 
	`STBIW_ASSERT
(
Ëngth
 <= 128);

584 
s
->
	`func
(s->
cÚ‹xt
, &
Ëngthby‹
, 1);

585 
s
->
	`func
(s->
cÚ‹xt
, 
d©a
, 
Ëngth
);

586 
	}
}

588 
	$¡biw__wr™e_hdr_sÿÆše
(
¡bi__wr™e_cÚ‹xt
 *
s
, 
width
, 
ncomp
, *
sü©ch
, *
sÿÆše
)

590 
sÿÆšeh—d”
[4] = { 2, 2, 0, 0 };

591 
rgbe
[4];

592 
lš—r
[3];

593 
x
;

595 
sÿÆšeh—d”
[2] = (
width
&0xff00)>>8;

596 
sÿÆšeh—d”
[3] = (
width
&0x00ff);

599 ià(
width
 < 8 || width >= 32768) {

600 
x
=0; x < 
width
; x++) {

601 
ncomp
) {

603 3: 
lš—r
[2] = 
sÿÆše
[
x
*
ncomp
 + 2];

604 
lš—r
[1] = 
sÿÆše
[
x
*
ncomp
 + 1];

605 
lš—r
[0] = 
sÿÆše
[
x
*
ncomp
 + 0];

608 
lš—r
[0] =†š—r[1] =†š—r[2] = 
sÿÆše
[
x
*
ncomp
 + 0];

611 
	`¡biw__lš—r_to_rgbe
(
rgbe
, 
lš—r
);

612 
s
->
	`func
(s->
cÚ‹xt
, 
rgbe
, 4);

615 
c
,
r
;

617 
x
=0; x < 
width
; x++) {

618 
ncomp
) {

620 3: 
lš—r
[2] = 
sÿÆše
[
x
*
ncomp
 + 2];

621 
lš—r
[1] = 
sÿÆše
[
x
*
ncomp
 + 1];

622 
lš—r
[0] = 
sÿÆše
[
x
*
ncomp
 + 0];

625 
lš—r
[0] =†š—r[1] =†š—r[2] = 
sÿÆše
[
x
*
ncomp
 + 0];

628 
	`¡biw__lš—r_to_rgbe
(
rgbe
, 
lš—r
);

629 
sü©ch
[
x
 + 
width
*0] = 
rgbe
[0];

630 
sü©ch
[
x
 + 
width
*1] = 
rgbe
[1];

631 
sü©ch
[
x
 + 
width
*2] = 
rgbe
[2];

632 
sü©ch
[
x
 + 
width
*3] = 
rgbe
[3];

635 
s
->
	`func
(s->
cÚ‹xt
, 
sÿÆšeh—d”
, 4);

638 
c
=0; c < 4; c++) {

639 *
comp
 = &
sü©ch
[
width
*
c
];

641 
x
 = 0;

642 
x
 < 
width
) {

644 
r
 = 
x
;

645 
r
+2 < 
width
) {

646 ià(
comp
[
r
] == comp[r+1] && comp[r] == comp[r+2])

648 ++
r
;

650 ià(
r
+2 >ğ
width
)

651 
r
 = 
width
;

653 
x
 < 
r
) {

654 
Ën
 = 
r
-
x
;

655 ià(
Ën
 > 128)†en = 128;

656 
	`¡biw__wr™e_dump_d©a
(
s
, 
Ën
, &
comp
[
x
]);

657 
x
 +ğ
Ën
;

660 ià(
r
+2 < 
width
) {

662 
r
 < 
width
 && 
comp
[r] =ğcomp[
x
])

663 ++
r
;

665 
x
 < 
r
) {

666 
Ën
 = 
r
-
x
;

667 ià(
Ën
 > 127)†en = 127;

668 
	`¡biw__wr™e_run_d©a
(
s
, 
Ën
, 
comp
[
x
]);

669 
x
 +ğ
Ën
;

675 
	}
}

677 
	$¡bi_wr™e_hdr_cÜe
(
¡bi__wr™e_cÚ‹xt
 *
s
, 
x
, 
y
, 
comp
, *
d©a
)

679 ià(
y
 <ğ0 || 
x
 <ğ0 || 
d©a
 =ğ
NULL
)

683 *
sü©ch
 = (*è
	`STBIW_MALLOC
(
x
*4);

684 
i
, 
Ën
;

685 
bufãr
[128];

686 
h—d”
[] = "#?RADIANCE\n# Written by stb_image_write.h\nFORMAT=32-bit_rle_rgbe\n";

687 
s
->
	`func
(s->
cÚ‹xt
, 
h—d”
, (header)-1);

689 #ifdeà
STBI_MSC_SECURE_CRT


690 
Ën
 = 
	`¥rštf_s
(
bufãr
, "EXPOSUREğ 1.0000000000000\n\n-Y %d +X %d\n", 
y
, 
x
);

692 
Ën
 = 
	`¥rštf
(
bufãr
, "EXPOSUREğ 1.0000000000000\n\n-Y %d +X %d\n", 
y
, 
x
);

694 
s
->
	`func
(s->
cÚ‹xt
, 
bufãr
, 
Ën
);

696 
i
=0; i < 
y
; i++)

697 
	`¡biw__wr™e_hdr_sÿÆše
(
s
, 
x
, 
comp
, 
sü©ch
, 
d©a
 + comp*x*(
¡bi__æ_v”tiÿÎy_Ú_wr™e
 ? 
y
-1-
i
 : i)*x);

698 
	`STBIW_FREE
(
sü©ch
);

701 
	}
}

703 
STBIWDEF
 
	$¡bi_wr™e_hdr_to_func
(
¡bi_wr™e_func
 *
func
, *
cÚ‹xt
, 
x
, 
y
, 
comp
, cÚ¡ *
d©a
)

705 
¡bi__wr™e_cÚ‹xt
 
s
;

706 
	`¡bi__¡¬t_wr™e_ÿÎbacks
(&
s
, 
func
, 
cÚ‹xt
);

707  
	`¡bi_wr™e_hdr_cÜe
(&
s
, 
x
, 
y
, 
comp
, (*è
d©a
);

708 
	}
}

710 #iâdeà
STBI_WRITE_NO_STDIO


711 
STBIWDEF
 
	$¡bi_wr™e_hdr
(cÚ¡ *
f’ame
, 
x
, 
y
, 
comp
, cÚ¡ *
d©a
)

713 
¡bi__wr™e_cÚ‹xt
 
s
;

714 ià(
	`¡bi__¡¬t_wr™e_fe
(&
s
,
f’ame
)) {

715 
r
 = 
	`¡bi_wr™e_hdr_cÜe
(&
s
, 
x
, 
y
, 
comp
, (*è
d©a
);

716 
	`¡bi__’d_wr™e_fe
(&
s
);

717  
r
;

720 
	}
}

729 #iâdeà
STBIW_ZLIB_COMPRESS


731 
	#¡biw__sb¿w
(
a
è((*è×è- 2)

	)

732 
	#¡biw__sbm
(
a
è
	`¡biw__sb¿w
×)[0]

	)

733 
	#¡biw__sbn
(
a
è
	`¡biw__sb¿w
×)[1]

	)

735 
	#¡biw__sbÃedgrow
(
a
,
n
è(×)==0 || 
	`¡biw__sbn
×)+À>ğ
	`¡biw__sbm
×))

	)

736 
	#¡biw__sbmaybegrow
(
a
,
n
è(
	`¡biw__sbÃedgrow
×,Ò)è? 
	`¡biw__sbgrow
×,nè: 0)

	)

737 
	#¡biw__sbgrow
(
a
,
n
è
	`¡biw__sbgrowf
((**è&×), (n), (*×)))

	)

739 
	#¡biw__sbpush
(
a
, 
v
è(
	`¡biw__sbmaybegrow
×,1), (a)[
	`¡biw__sbn
×)++] = (v))

	)

740 
	#¡biw__sbcouÁ
(
a
è(×è? 
	`¡biw__sbn
×è: 0)

	)

741 
	#¡biw__sbä“
(
a
è(×è? 
	`STBIW_FREE
(
	`¡biw__sb¿w
×)),0 : 0)

	)

743 *
	$¡biw__sbgrowf
(**
¬r
, 
šüem’t
, 
™emsize
)

745 
m
 = *
¬r
 ? 2*
	`¡biw__sbm
(*¬r)+
šüem’t
 : increment+1;

746 *
p
 = 
	`STBIW_REALLOC_SIZED
(*
¬r
 ? 
	`¡biw__sb¿w
(*¬rè: 0, *¬¸? (
	`¡biw__sbm
(*¬r)*
™emsize
 + ()*2è: 0, i‹msiz* 
m
 + ()*2);

747 
	`STBIW_ASSERT
(
p
);

748 ià(
p
) {

749 ià(!*
¬r
è((*è
p
)[1] = 0;

750 *
¬r
 = (*è((*è
p
 + 2);

751 
	`¡biw__sbm
(*
¬r
èğ
m
;

753  *
¬r
;

754 
	}
}

756 *
	$¡biw__zlib_æushf
(*
d©a
, *
b™bufãr
, *
b™couÁ
)

758 *
b™couÁ
 >= 8) {

759 
	`¡biw__sbpush
(
d©a
, 
	`STBIW_UCHAR
(*
b™bufãr
));

760 *
b™bufãr
 >>= 8;

761 *
b™couÁ
 -= 8;

763  
d©a
;

764 
	}
}

766 
	$¡biw__zlib_b™»v
(
code
, 
codeb™s
)

768 
»s
=0;

769 
codeb™s
--) {

770 
»s
 = (» << 1è| (
code
 & 1);

771 
code
 >>= 1;

773  
»s
;

774 
	}
}

776 
	$¡biw__zlib_couÁm
(*
a
, *
b
, 
lim™
)

778 
i
;

779 
i
=0; i < 
lim™
 && i < 258; ++i)

780 ià(
a
[
i
] !ğ
b
[i]) ;

781  
i
;

782 
	}
}

784 
	$¡biw__zhash
(*
d©a
)

786 
¡biw_ušt32
 
hash
 = 
d©a
[0] + (data[1] << 8) + (data[2] << 16);

787 
hash
 ^= hash << 3;

788 
hash
 += hash >> 5;

789 
hash
 ^= hash << 4;

790 
hash
 += hash >> 17;

791 
hash
 ^= hash << 25;

792 
hash
 += hash >> 6;

793  
hash
;

794 
	}
}

796 
	#¡biw__zlib_æush
(è(
out
 = 
	`¡biw__zlib_æushf
(out, &
b™buf
, &
b™couÁ
))

	)

797 
	#¡biw__zlib_add
(
code
,
codeb™s
) \

798 (
b™buf
 |ğ(
code
è<< 
b™couÁ
, b™couÁ +ğ(
codeb™s
), 
	`¡biw__zlib_æush
())

	)

799 
	#¡biw__zlib_hufç
(
b
,
c
è
	`¡biw__zlib_add
(
	`¡biw__zlib_b™»v
(b,c),c)

	)

801 
	#¡biw__zlib_huff1
(
n
è
	`¡biw__zlib_hufç
(0x30 + (n), 8)

	)

802 
	#¡biw__zlib_huff2
(
n
è
	`¡biw__zlib_hufç
(0x190 + (n)-144, 9)

	)

803 
	#¡biw__zlib_huff3
(
n
è
	`¡biw__zlib_hufç
(0 + (n)-256,7)

	)

804 
	#¡biw__zlib_huff4
(
n
è
	`¡biw__zlib_hufç
(0xc0 + (n)-280,8)

	)

805 
	#¡biw__zlib_huff
(
n
è(Òè<ğ143 ? 
	`¡biw__zlib_huff1
Òè: (nè<ğ255 ? 
	`¡biw__zlib_huff2
Òè: (nè<ğ279 ? 
	`¡biw__zlib_huff3
Òè: 
	`¡biw__zlib_huff4
Ò))

	)

806 
	#¡biw__zlib_huffb
(
n
è(Òè<ğ143 ? 
	`¡biw__zlib_huff1
Òè: 
	`¡biw__zlib_huff2
Ò))

	)

808 
	#¡biw__ZHASH
 16384

	)

812 * 
	$¡bi_zlib_com´ess
(*
d©a
, 
d©a_Ën
, *
out_Ën
, 
qu®™y
)

814 #ifdeà
STBIW_ZLIB_COMPRESS


816  
	`STBIW_ZLIB_COMPRESS
(
d©a
, 
d©a_Ën
, 
out_Ën
, 
qu®™y
);

818 
Ëngthc
[] = { 3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258, 259 };

819 
Ëngtheb
[]= { 0,0,0,0,0,0,0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 0 };

820 
di¡c
[] = { 1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577, 32768 };

821 
di¡eb
[] = { 0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13 };

822 
b™buf
=0;

823 
i
,
j
, 
b™couÁ
=0;

824 *
out
 = 
NULL
;

825 ***
hash_bË
 = (***è
	`STBIW_MALLOC
(
¡biw__ZHASH
 * (**));

826 ià(
hash_bË
 =ğ
NULL
)

827  
NULL
;

828 ià(
qu®™y
 < 5) quality = 5;

830 
	`¡biw__sbpush
(
out
, 0x78);

831 
	`¡biw__sbpush
(
out
, 0x5e);

832 
	`¡biw__zlib_add
(1,1);

833 
	`¡biw__zlib_add
(1,2);

835 
i
=0; i < 
¡biw__ZHASH
; ++i)

836 
hash_bË
[
i
] = 
NULL
;

838 
i
=0;

839 
i
 < 
d©a_Ën
-3) {

841 
h
 = 
	`¡biw__zhash
(
d©a
+
i
)&(
¡biw__ZHASH
-1), 
be¡
=3;

842 *
be¡loc
 = 0;

843 **
hli¡
 = 
hash_bË
[
h
];

844 
n
 = 
	`¡biw__sbcouÁ
(
hli¡
);

845 
j
=0; j < 
n
; ++j) {

846 ià(
hli¡
[
j
]-
d©a
 > 
i
-32768) {

847 
d
 = 
	`¡biw__zlib_couÁm
(
hli¡
[
j
], 
d©a
+
i
, 
d©a_Ën
-i);

848 ià(
d
 >ğ
be¡
èbe¡=d,
be¡loc
=
hli¡
[
j
];

852 ià(
hash_bË
[
h
] && 
	`¡biw__sbn
(hash_bË[h]è=ğ2*
qu®™y
) {

853 
	`STBIW_MEMMOVE
(
hash_bË
[
h
], hash_bË[h]+
qu®™y
, (hash_table[h][0])*quality);

854 
	`¡biw__sbn
(
hash_bË
[
h
]èğ
qu®™y
;

856 
	`¡biw__sbpush
(
hash_bË
[
h
],
d©a
+
i
);

858 ià(
be¡loc
) {

860 
h
 = 
	`¡biw__zhash
(
d©a
+
i
+1)&(
¡biw__ZHASH
-1);

861 
hli¡
 = 
hash_bË
[
h
];

862 
n
 = 
	`¡biw__sbcouÁ
(
hli¡
);

863 
j
=0; j < 
n
; ++j) {

864 ià(
hli¡
[
j
]-
d©a
 > 
i
-32767) {

865 
e
 = 
	`¡biw__zlib_couÁm
(
hli¡
[
j
], 
d©a
+
i
+1, 
d©a_Ën
-i-1);

866 ià(
e
 > 
be¡
) {

867 
be¡loc
 = 
NULL
;

874 ià(
be¡loc
) {

875 
d
 = (è(
d©a
+
i
 - 
be¡loc
);

876 
	`STBIW_ASSERT
(
d
 <ğ32767 && 
be¡
 <= 258);

877 
j
=0; 
be¡
 > 
Ëngthc
[j+1]-1; ++j);

878 
	`¡biw__zlib_huff
(
j
+257);

879 ià(
Ëngtheb
[
j
]è
	`¡biw__zlib_add
(
be¡
 - 
Ëngthc
[j],†engtheb[j]);

880 
j
=0; 
d
 > 
di¡c
[j+1]-1; ++j);

881 
	`¡biw__zlib_add
(
	`¡biw__zlib_b™»v
(
j
,5),5);

882 ià(
di¡eb
[
j
]è
	`¡biw__zlib_add
(
d
 - 
di¡c
[j], disteb[j]);

883 
i
 +ğ
be¡
;

885 
	`¡biw__zlib_huffb
(
d©a
[
i
]);

886 ++
i
;

890 ;
i
 < 
d©a_Ën
; ++i)

891 
	`¡biw__zlib_huffb
(
d©a
[
i
]);

892 
	`¡biw__zlib_huff
(256);

894 
b™couÁ
)

895 
	`¡biw__zlib_add
(0,1);

897 
i
=0; i < 
¡biw__ZHASH
; ++i)

898 (è
	`¡biw__sbä“
(
hash_bË
[
i
]);

899 
	`STBIW_FREE
(
hash_bË
);

903 
s1
=1, 
s2
=0;

904 
blockËn
 = (è(
d©a_Ën
 % 5552);

905 
j
=0;

906 
j
 < 
d©a_Ën
) {

907 
i
=0; i < 
blockËn
; ++iè
s1
 +ğ
d©a
[
j
+i], 
s2
 += s1;

908 
s1
 %ğ65521, 
s2
 %= 65521;

909 
j
 +ğ
blockËn
;

910 
blockËn
 = 5552;

912 
	`¡biw__sbpush
(
out
, 
	`STBIW_UCHAR
(
s2
 >> 8));

913 
	`¡biw__sbpush
(
out
, 
	`STBIW_UCHAR
(
s2
));

914 
	`¡biw__sbpush
(
out
, 
	`STBIW_UCHAR
(
s1
 >> 8));

915 
	`¡biw__sbpush
(
out
, 
	`STBIW_UCHAR
(
s1
));

917 *
out_Ën
 = 
	`¡biw__sbn
(
out
);

919 
	`STBIW_MEMMOVE
(
	`¡biw__sb¿w
(
out
), out, *
out_Ën
);

920  (*è
	`¡biw__sb¿w
(
out
);

922 
	}
}

924 
	$¡biw__üc32
(*
bufãr
, 
Ën
)

926 
üc_bË
[256] =

962 
üc
 = ~0u;

963 
i
;

964 
i
=0; i < 
Ën
; ++i)

965 
üc
 = (üø>> 8è^ 
üc_bË
[
bufãr
[
i
] ^ (crc & 0xff)];

966  ~
üc
;

967 
	}
}

969 
	#¡biw__w²g4
(
o
,
a
,
b
,
c
,
d
è((o)[0]=
	`STBIW_UCHAR
×),(o)[1]=STBIW_UCHAR(b),(o)[2]=STBIW_UCHAR(c),(o)[3]=STBIW_UCHAR(d),(o)+=4)

	)

970 
	#¡biw__wp32
(
d©a
,
v
è
	`¡biw__w²g4
(d©a, (v)>>24,(v)>>16,(v)>>8,(v));

	)

971 
	#¡biw__w±ag
(
d©a
,
s
è
	`¡biw__w²g4
(d©a, s[0],s[1],s[2],s[3])

	)

973 
	$¡biw__wpüc
(**
d©a
, 
Ën
)

975 
üc
 = 
	`¡biw__üc32
(*
d©a
 - 
Ën
 - 4,†en+4);

976 
	`¡biw__wp32
(*
d©a
, 
üc
);

977 
	}
}

979 
	$¡biw__·‘h
(
a
, 
b
, 
c
)

981 
p
 = 
a
 + 
b
 - 
c
, 
·
 = 
	`abs
Õ-a), 
pb
 =‡bsÕ-b), 
pc
 =‡bs(p-c);

982 ià(
·
 <ğ
pb
 &&…¨<ğ
pc
è 
	`STBIW_UCHAR
(
a
);

983 ià(
pb
 <ğ
pc
è 
	`STBIW_UCHAR
(
b
);

984  
	`STBIW_UCHAR
(
c
);

985 
	}
}

988 
	$¡biw__’code_²g_lše
(*
pix–s
, 
¡ride_by‹s
, 
width
, 
height
, 
y
, 
n
, 
f‹r_ty³
, sigÃd *
lše_bufãr
)

990 
m­pšg
[] = { 0,1,2,3,4 };

991 
fœ¡m­
[] = { 0,1,0,5,6 };

992 *
mym­
 = (
y
 !ğ0è? 
m­pšg
 : 
fœ¡m­
;

993 
i
;

994 
ty³
 = 
mym­
[
f‹r_ty³
];

995 *
z
 = 
pix–s
 + 
¡ride_by‹s
 * (
¡bi__æ_v”tiÿÎy_Ú_wr™e
 ? 
height
-1-
y
 : y);

996 
sigÃd_¡ride
 = 
¡bi__æ_v”tiÿÎy_Ú_wr™e
 ? -
¡ride_by‹s
 : stride_bytes;

997 
i
 = 0; i < 
n
; ++i) {

998 
ty³
) {

999 0: 
lše_bufãr
[
i
] = 
z
[i]; ;

1000 1: 
lše_bufãr
[
i
] = 
z
[i]; ;

1001 2: 
lše_bufãr
[
i
] = 
z
[i] - z[i-
sigÃd_¡ride
]; ;

1002 3: 
lše_bufãr
[
i
] = 
z
[i] - (z[i-
sigÃd_¡ride
]>>1); ;

1003 4: 
lše_bufãr
[
i
] = (sigÃd è(
z
[i] - 
	`¡biw__·‘h
(0,z[i-
sigÃd_¡ride
],0)); ;

1004 5: 
lše_bufãr
[
i
] = 
z
[i]; ;

1005 6: 
lše_bufãr
[
i
] = 
z
[i]; ;

1008 
i
=
n
; i < 
width
*n; ++i) {

1009 
ty³
) {

1010 0: 
lše_bufãr
[
i
] = 
z
[i]; ;

1011 1: 
lše_bufãr
[
i
] = 
z
[i] - z[i-
n
]; ;

1012 2: 
lše_bufãr
[
i
] = 
z
[i] - z[i-
sigÃd_¡ride
]; ;

1013 3: 
lše_bufãr
[
i
] = 
z
[i] - ((z[i-
n
] + z[i-
sigÃd_¡ride
])>>1); ;

1014 4: 
lše_bufãr
[
i
] = 
z
[i] - 
	`¡biw__·‘h
(z[i-
n
], z[i-
sigÃd_¡ride
], z[i-signed_stride-n]); ;

1015 5: 
lše_bufãr
[
i
] = 
z
[i] - (z[i-
n
]>>1); ;

1016 6: 
lše_bufãr
[
i
] = 
z
[i] - 
	`¡biw__·‘h
(z[i-
n
], 0,0); ;

1019 
	}
}

1021 *
	$¡bi_wr™e_²g_to_mem
(*
pix–s
, 
¡ride_by‹s
, 
x
, 
y
, 
n
, *
out_Ën
)

1023 
fÜû_f‹r
 = 
¡bi_wr™e_fÜû_²g_f‹r
;

1024 
ùy³
[5] = { -1, 0, 4, 2, 6 };

1025 
sig
[8] = { 137,80,78,71,13,10,26,10 };

1026 *
out
,*
o
, *
ft
, *
zlib
;

1027 sigÃd *
lše_bufãr
;

1028 
j
,
zËn
;

1030 ià(
¡ride_by‹s
 == 0)

1031 
¡ride_by‹s
 = 
x
 * 
n
;

1033 ià(
fÜû_f‹r
 >= 5) {

1034 
fÜû_f‹r
 = -1;

1037 
ft
 = (*è
	`STBIW_MALLOC
((
x
*
n
+1è* 
y
); if (!filt)  0;

1038 
lše_bufãr
 = (sigÃd *è
	`STBIW_MALLOC
(
x
 * 
n
); ià(!lše_bufãrè{ 
	`STBIW_FREE
(
ft
);  0; }

1039 
j
=0; j < 
y
; ++j) {

1040 
f‹r_ty³
;

1041 ià(
fÜû_f‹r
 > -1) {

1042 
f‹r_ty³
 = 
fÜû_f‹r
;

1043 
	`¡biw__’code_²g_lše
(
pix–s
, 
¡ride_by‹s
, 
x
, 
y
, 
j
, 
n
, 
fÜû_f‹r
, 
lše_bufãr
);

1045 
be¡_f‹r
 = 0, 
be¡_f‹r_v®
 = 0x7fffffff, 
e¡
, 
i
;

1046 
f‹r_ty³
 = 0; filter_type < 5; filter_type++) {

1047 
	`¡biw__’code_²g_lše
(
pix–s
, 
¡ride_by‹s
, 
x
, 
y
, 
j
, 
n
, 
f‹r_ty³
, 
lše_bufãr
);

1050 
e¡
 = 0;

1051 
i
 = 0; i < 
x
*
n
; ++i) {

1052 
e¡
 +ğ
	`abs
((sigÃd è
lše_bufãr
[
i
]);

1054 ià(
e¡
 < 
be¡_f‹r_v®
) {

1055 
be¡_f‹r_v®
 = 
e¡
;

1056 
be¡_f‹r
 = 
f‹r_ty³
;

1059 ià(
f‹r_ty³
 !ğ
be¡_f‹r
) {

1060 
	`¡biw__’code_²g_lše
(
pix–s
, 
¡ride_by‹s
, 
x
, 
y
, 
j
, 
n
, 
be¡_f‹r
, 
lše_bufãr
);

1061 
f‹r_ty³
 = 
be¡_f‹r
;

1065 
ft
[
j
*(
x
*
n
+1)] = (è
f‹r_ty³
;

1066 
	`STBIW_MEMMOVE
(
ft
+
j
*(
x
*
n
+1)+1, 
lše_bufãr
, x*n);

1068 
	`STBIW_FREE
(
lše_bufãr
);

1069 
zlib
 = 
	`¡bi_zlib_com´ess
(
ft
, 
y
*Ğ
x
*
n
+1), &
zËn
, 
¡bi_wr™e_²g_com´essiÚ_Ëv–
);

1070 
	`STBIW_FREE
(
ft
);

1071 ià(!
zlib
)  0;

1074 
out
 = (*è
	`STBIW_MALLOC
(8 + 12+13 + 12+
zËn
 + 12);

1075 ià(!
out
)  0;

1076 *
out_Ën
 = 8 + 12+13 + 12+
zËn
 + 12;

1078 
o
=
out
;

1079 
	`STBIW_MEMMOVE
(
o
,
sig
,8); o+= 8;

1080 
	`¡biw__wp32
(
o
, 13);

1081 
	`¡biw__w±ag
(
o
, "IHDR");

1082 
	`¡biw__wp32
(
o
, 
x
);

1083 
	`¡biw__wp32
(
o
, 
y
);

1084 *
o
++ = 8;

1085 *
o
++ = 
	`STBIW_UCHAR
(
ùy³
[
n
]);

1086 *
o
++ = 0;

1087 *
o
++ = 0;

1088 *
o
++ = 0;

1089 
	`¡biw__wpüc
(&
o
,13);

1091 
	`¡biw__wp32
(
o
, 
zËn
);

1092 
	`¡biw__w±ag
(
o
, "IDAT");

1093 
	`STBIW_MEMMOVE
(
o
, 
zlib
, 
zËn
);

1094 
o
 +ğ
zËn
;

1095 
	`STBIW_FREE
(
zlib
);

1096 
	`¡biw__wpüc
(&
o
, 
zËn
);

1098 
	`¡biw__wp32
(
o
,0);

1099 
	`¡biw__w±ag
(
o
, "IEND");

1100 
	`¡biw__wpüc
(&
o
,0);

1102 
	`STBIW_ASSERT
(
o
 =ğ
out
 + *
out_Ën
);

1104  
out
;

1105 
	}
}

1107 #iâdeà
STBI_WRITE_NO_STDIO


1108 
STBIWDEF
 
	$¡bi_wr™e_²g
(cÚ¡ *
f’ame
, 
x
, 
y
, 
comp
, cÚ¡ *
d©a
, 
¡ride_by‹s
)

1110 
FILE
 *
f
;

1111 
Ën
;

1112 *
²g
 = 
	`¡bi_wr™e_²g_to_mem
((*è
d©a
, 
¡ride_by‹s
, 
x
, 
y
, 
comp
, &
Ën
);

1113 ià(
²g
 =ğ
NULL
)  0;

1114 #ifdeà
STBI_MSC_SECURE_CRT


1115 ià(
	`fİ’_s
(&
f
, 
f’ame
, "wb"))

1116 
f
 = 
NULL
;

1118 
f
 = 
	`fİ’
(
f’ame
, "wb");

1120 ià(!
f
è{ 
	`STBIW_FREE
(
²g
);  0; }

1121 
	`fwr™e
(
²g
, 1, 
Ën
, 
f
);

1122 
	`fşo£
(
f
);

1123 
	`STBIW_FREE
(
²g
);

1125 
	}
}

1128 
STBIWDEF
 
	$¡bi_wr™e_²g_to_func
(
¡bi_wr™e_func
 *
func
, *
cÚ‹xt
, 
x
, 
y
, 
comp
, cÚ¡ *
d©a
, 
¡ride_by‹s
)

1130 
Ën
;

1131 *
²g
 = 
	`¡bi_wr™e_²g_to_mem
((*è
d©a
, 
¡ride_by‹s
, 
x
, 
y
, 
comp
, &
Ën
);

1132 ià(
²g
 =ğ
NULL
)  0;

1133 
	`func
(
cÚ‹xt
, 
²g
, 
Ën
);

1134 
	`STBIW_FREE
(
²g
);

1136 
	}
}

1147 cÚ¡ 
	g¡biw__jpg_ZigZag
[] = { 0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,

1150 
	$¡biw__jpg_wr™eB™s
(
¡bi__wr™e_cÚ‹xt
 *
s
, *
b™BufP
, *
b™CÁP
, cÚ¡ *
bs
) {

1151 
b™Buf
 = *
b™BufP
, 
b™CÁ
 = *
b™CÁP
;

1152 
b™CÁ
 +ğ
bs
[1];

1153 
b™Buf
 |ğ
bs
[0] << (24 - 
b™CÁ
);

1154 
b™CÁ
 >= 8) {

1155 
c
 = (
b™Buf
 >> 16) & 255;

1156 
	`¡biw__putc
(
s
, 
c
);

1157 if(
c
 == 255) {

1158 
	`¡biw__putc
(
s
, 0);

1160 
b™Buf
 <<= 8;

1161 
b™CÁ
 -= 8;

1163 *
b™BufP
 = 
b™Buf
;

1164 *
b™CÁP
 = 
b™CÁ
;

1165 
	}
}

1167 
	$¡biw__jpg_DCT
(*
d0p
, *
d1p
, *
d2p
, *
d3p
, *
d4p
, *
d5p
, *
d6p
, *
d7p
) {

1168 
d0
 = *
d0p
, 
d1
 = *
d1p
, 
d2
 = *
d2p
, 
d3
 = *
d3p
, 
d4
 = *
d4p
, 
d5
 = *
d5p
, 
d6
 = *
d6p
, 
d7
 = *
d7p
;

1169 
z1
, 
z2
, 
z3
, 
z4
, 
z5
, 
z11
, 
z13
;

1171 
tmp0
 = 
d0
 + 
d7
;

1172 
tmp7
 = 
d0
 - 
d7
;

1173 
tmp1
 = 
d1
 + 
d6
;

1174 
tmp6
 = 
d1
 - 
d6
;

1175 
tmp2
 = 
d2
 + 
d5
;

1176 
tmp5
 = 
d2
 - 
d5
;

1177 
tmp3
 = 
d3
 + 
d4
;

1178 
tmp4
 = 
d3
 - 
d4
;

1181 
tmp10
 = 
tmp0
 + 
tmp3
;

1182 
tmp13
 = 
tmp0
 - 
tmp3
;

1183 
tmp11
 = 
tmp1
 + 
tmp2
;

1184 
tmp12
 = 
tmp1
 - 
tmp2
;

1186 
d0
 = 
tmp10
 + 
tmp11
;

1187 
d4
 = 
tmp10
 - 
tmp11
;

1189 
z1
 = (
tmp12
 + 
tmp13
) * 0.707106781f;

1190 
d2
 = 
tmp13
 + 
z1
;

1191 
d6
 = 
tmp13
 - 
z1
;

1194 
tmp10
 = 
tmp4
 + 
tmp5
;

1195 
tmp11
 = 
tmp5
 + 
tmp6
;

1196 
tmp12
 = 
tmp6
 + 
tmp7
;

1199 
z5
 = (
tmp10
 - 
tmp12
) * 0.382683433f;

1200 
z2
 = 
tmp10
 * 0.541196100à+ 
z5
;

1201 
z4
 = 
tmp12
 * 1.306562965à+ 
z5
;

1202 
z3
 = 
tmp11
 * 0.707106781f;

1204 
z11
 = 
tmp7
 + 
z3
;

1205 
z13
 = 
tmp7
 - 
z3
;

1207 *
d5p
 = 
z13
 + 
z2
;

1208 *
d3p
 = 
z13
 - 
z2
;

1209 *
d1p
 = 
z11
 + 
z4
;

1210 *
d7p
 = 
z11
 - 
z4
;

1212 *
d0p
 = 
d0
; *
d2p
 = 
d2
; *
d4p
 = 
d4
; *
d6p
 = 
d6
;

1213 
	}
}

1215 
	$¡biw__jpg_ÿlcB™s
(
v®
, 
b™s
[2]) {

1216 
tmp1
 = 
v®
 < 0 ? -val : val;

1217 
v®
 = val < 0 ? val-1 : val;

1218 
b™s
[1] = 1;

1219 
tmp1
 >>= 1) {

1220 ++
b™s
[1];

1222 
b™s
[0] = 
v®
 & ((1<<bits[1])-1);

1223 
	}
}

1225 
	$¡biw__jpg_´oûssDU
(
¡bi__wr™e_cÚ‹xt
 *
s
, *
b™Buf
, *
b™CÁ
, *
CDU
, *
fdtbl
, 
DC
, cÚ¡ 
HTDC
[256][2], cÚ¡ 
HTAC
[256][2]) {

1226 cÚ¡ 
EOB
[2] = { 
HTAC
[0x00][0], HTAC[0x00][1] };

1227 cÚ¡ 
M16z”Ûs
[2] = { 
HTAC
[0xF0][0], HTAC[0xF0][1] };

1228 
d©aOff
, 
i
, 
diff
, 
’d0pos
;

1229 
DU
[64];

1232 
d©aOff
=0; dataOff<64; dataOff+=8) {

1233 
	`¡biw__jpg_DCT
(&
CDU
[
d©aOff
], &CDU[dataOff+1], &CDU[dataOff+2], &CDU[dataOff+3], &CDU[dataOff+4], &CDU[dataOff+5], &CDU[dataOff+6], &CDU[dataOff+7]);

1236 
d©aOff
=0; dataOff<8; ++dataOff) {

1237 
	`¡biw__jpg_DCT
(&
CDU
[
d©aOff
], &CDU[dataOff+8], &CDU[dataOff+16], &CDU[dataOff+24], &CDU[dataOff+32], &CDU[dataOff+40], &CDU[dataOff+48], &CDU[dataOff+56]);

1240 
i
=0; i<64; ++i) {

1241 
v
 = 
CDU
[
i
]*
fdtbl
[i];

1244 
DU
[
¡biw__jpg_ZigZag
[
i
]] = ()(
v
 < 0 ? v - 0.5f : v + 0.5f);

1248 
diff
 = 
DU
[0] - 
DC
;

1249 ià(
diff
 == 0) {

1250 
	`¡biw__jpg_wr™eB™s
(
s
, 
b™Buf
, 
b™CÁ
, 
HTDC
[0]);

1252 
b™s
[2];

1253 
	`¡biw__jpg_ÿlcB™s
(
diff
, 
b™s
);

1254 
	`¡biw__jpg_wr™eB™s
(
s
, 
b™Buf
, 
b™CÁ
, 
HTDC
[
b™s
[1]]);

1255 
	`¡biw__jpg_wr™eB™s
(
s
, 
b™Buf
, 
b™CÁ
, 
b™s
);

1258 
’d0pos
 = 63;

1259 ; (
’d0pos
>0)&&(
DU
[end0pos]==0); --end0pos) {

1262 if(
’d0pos
 == 0) {

1263 
	`¡biw__jpg_wr™eB™s
(
s
, 
b™Buf
, 
b™CÁ
, 
EOB
);

1264  
DU
[0];

1266 
i
 = 1; i <ğ
’d0pos
; ++i) {

1267 
¡¬os
 = 
i
;

1268 
Äz”Ûs
;

1269 
b™s
[2];

1270 ; 
DU
[
i
]==0 && i<=
’d0pos
; ++i) {

1272 
Äz”Ûs
 = 
i
-
¡¬os
;

1273 iàĞ
Äz”Ûs
 >= 16 ) {

1274 
Êg
 = 
Äz”Ûs
>>4;

1275 
Äm¬k”
;

1276 
Äm¬k”
=1;‚rm¬k” <ğ
Êg
; ++nrmarker)

1277 
	`¡biw__jpg_wr™eB™s
(
s
, 
b™Buf
, 
b™CÁ
, 
M16z”Ûs
);

1278 
Äz”Ûs
 &= 15;

1280 
	`¡biw__jpg_ÿlcB™s
(
DU
[
i
], 
b™s
);

1281 
	`¡biw__jpg_wr™eB™s
(
s
, 
b™Buf
, 
b™CÁ
, 
HTAC
[(
Äz”Ûs
<<4)+
b™s
[1]]);

1282 
	`¡biw__jpg_wr™eB™s
(
s
, 
b™Buf
, 
b™CÁ
, 
b™s
);

1284 if(
’d0pos
 != 63) {

1285 
	`¡biw__jpg_wr™eB™s
(
s
, 
b™Buf
, 
b™CÁ
, 
EOB
);

1287  
DU
[0];

1288 
	}
}

1290 
	$¡bi_wr™e_jpg_cÜe
(
¡bi__wr™e_cÚ‹xt
 *
s
, 
width
, 
height
, 
comp
, cÚ¡ * 
d©a
, 
qu®™y
) {

1292 cÚ¡ 
¡d_dc_lumšªû_Äcodes
[] = {0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0};

1293 cÚ¡ 
¡d_dc_lumšªû_v®ues
[] = {0,1,2,3,4,5,6,7,8,9,10,11};

1294 cÚ¡ 
¡d_ac_lumšªû_Äcodes
[] = {0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,0x7d};

1295 cÚ¡ 
¡d_ac_lumšªû_v®ues
[] = {

1304 cÚ¡ 
¡d_dc_chromšªû_Äcodes
[] = {0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0};

1305 cÚ¡ 
¡d_dc_chromšªû_v®ues
[] = {0,1,2,3,4,5,6,7,8,9,10,11};

1306 cÚ¡ 
¡d_ac_chromšªû_Äcodes
[] = {0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,0x77};

1307 cÚ¡ 
¡d_ac_chromšªû_v®ues
[] = {

1317 cÚ¡ 
YDC_HT
[256][2] = { {0,2},{2,3},{3,3},{4,3},{5,3},{6,3},{14,4},{30,5},{62,6},{126,7},{254,8},{510,9}};

1318 cÚ¡ 
UVDC_HT
[256][2] = { {0,2},{1,2},{2,2},{6,3},{14,4},{30,5},{62,6},{126,7},{254,8},{510,9},{1022,10},{2046,11}};

1319 cÚ¡ 
YAC_HT
[256][2] = {

1337 cÚ¡ 
UVAC_HT
[256][2] = {

1355 cÚ¡ 
YQT
[] = {16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,

1357 cÚ¡ 
UVQT
[] = {17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,

1359 cÚ¡ 
¯sf
[] = { 1.0f * 2.828427125f, 1.387039845f * 2.828427125f, 1.306562965f * 2.828427125f, 1.175875602f * 2.828427125f,

1362 
row
, 
cŞ
, 
i
, 
k
;

1363 
fdtbl_Y
[64], 
fdtbl_UV
[64];

1364 
YTabË
[64], 
UVTabË
[64];

1366 if(!
d©a
 || !
width
 || !
height
 || 
comp
 > 4 || comp < 1) {

1370 
qu®™y
 = quality ? quality : 90;

1371 
qu®™y
 = quality < 1 ? 1 : quality > 100 ? 100 : quality;

1372 
qu®™y
 = quality < 50 ? 5000 / quality : 200 - quality * 2;

1374 
i
 = 0; i < 64; ++i) {

1375 
uvti
, 
yti
 = (
YQT
[
i
]*
qu®™y
+50)/100;

1376 
YTabË
[
¡biw__jpg_ZigZag
[
i
]] = (è(
yti
 < 1 ? 1 : yti > 255 ? 255 : yti);

1377 
uvti
 = (
UVQT
[
i
]*
qu®™y
+50)/100;

1378 
UVTabË
[
¡biw__jpg_ZigZag
[
i
]] = (è(
uvti
 < 1 ? 1 : uvti > 255 ? 255 : uvti);

1381 
row
 = 0, 
k
 = 0;„ow < 8; ++row) {

1382 
cŞ
 = 0; cŞ < 8; ++cŞ, ++
k
) {

1383 
fdtbl_Y
[
k
] = 1 / (
YTabË
 [
¡biw__jpg_ZigZag
[k]] * 
¯sf
[
row
] *‡asf[
cŞ
]);

1384 
fdtbl_UV
[
k
] = 1 / (
UVTabË
[
¡biw__jpg_ZigZag
[k]] * 
¯sf
[
row
] *‡asf[
cŞ
]);

1390 cÚ¡ 
h—d0
[] = { 0xFF,0xD8,0xFF,0xE0,0,0x10,'J','F','I','F',0,1,1,0,0,1,0,1,0,0,0xFF,0xDB,0,0x84,0 };

1391 cÚ¡ 
h—d2
[] = { 0xFF,0xDA,0,0xC,3,1,0,2,0x11,3,0x11,0,0x3F,0 };

1392 cÚ¡ 
h—d1
[] = { 0xFF,0xC0,0,0x11,8,()(
height
>>8),
	`STBIW_UCHAR
(height),()(
width
>>8),STBIW_UCHAR(width),

1394 
s
->
	`func
(s->
cÚ‹xt
, (*)
h—d0
, (head0));

1395 
s
->
	`func
(s->
cÚ‹xt
, (*)
YTabË
, (YTable));

1396 
	`¡biw__putc
(
s
, 1);

1397 
s
->
	`func
(s->
cÚ‹xt
, 
UVTabË
, (UVTable));

1398 
s
->
	`func
(s->
cÚ‹xt
, (*)
h—d1
, (head1));

1399 
s
->
	`func
(s->
cÚ‹xt
, (*)(
¡d_dc_lumšªû_Äcodes
+1), (std_dc_luminance_nrcodes)-1);

1400 
s
->
	`func
(s->
cÚ‹xt
, (*)
¡d_dc_lumšªû_v®ues
, (std_dc_luminance_values));

1401 
	`¡biw__putc
(
s
, 0x10);

1402 
s
->
	`func
(s->
cÚ‹xt
, (*)(
¡d_ac_lumšªû_Äcodes
+1), (std_ac_luminance_nrcodes)-1);

1403 
s
->
	`func
(s->
cÚ‹xt
, (*)
¡d_ac_lumšªû_v®ues
, (std_ac_luminance_values));

1404 
	`¡biw__putc
(
s
, 1);

1405 
s
->
	`func
(s->
cÚ‹xt
, (*)(
¡d_dc_chromšªû_Äcodes
+1), (std_dc_chrominance_nrcodes)-1);

1406 
s
->
	`func
(s->
cÚ‹xt
, (*)
¡d_dc_chromšªû_v®ues
, (std_dc_chrominance_values));

1407 
	`¡biw__putc
(
s
, 0x11);

1408 
s
->
	`func
(s->
cÚ‹xt
, (*)(
¡d_ac_chromšªû_Äcodes
+1), (std_ac_chrominance_nrcodes)-1);

1409 
s
->
	`func
(s->
cÚ‹xt
, (*)
¡d_ac_chromšªû_v®ues
, (std_ac_chrominance_values));

1410 
s
->
	`func
(s->
cÚ‹xt
, (*)
h—d2
, (head2));

1415 cÚ¡ 
flB™s
[] = {0x7F, 7};

1416 cÚ¡ *
imageD©a
 = (cÚ¡ *)
d©a
;

1417 
DCY
=0, 
DCU
=0, 
DCV
=0;

1418 
b™Buf
=0, 
b™CÁ
=0;

1420 
ofsG
 = 
comp
 > 2 ? 1 : 0, 
ofsB
 = comp > 2 ? 2 : 0;

1421 
x
, 
y
, 
pos
;

1422 
y
 = 0; y < 
height
; y += 8) {

1423 
x
 = 0; x < 
width
; x += 8) {

1424 
YDU
[64], 
UDU
[64], 
VDU
[64];

1425 
row
 = 
y
, 
pos
 = 0;„ow < y+8; ++row) {

1426 
cŞ
 = 
x
; cŞ < x+8; ++cŞ, ++
pos
) {

1427 
p
 = (
¡bi__æ_v”tiÿÎy_Ú_wr™e
 ? 
height
-1-
row
 :„ow)*
width
*
comp
 + 
cŞ
*comp;

1428 
r
, 
g
, 
b
;

1429 if(
row
 >ğ
height
) {

1430 
p
 -ğ
width
*
comp
*(
row
+1 - 
height
);

1432 if(
cŞ
 >ğ
width
) {

1433 
p
 -ğ
comp
*(
cŞ
+1 - 
width
);

1436 
r
 = 
imageD©a
[
p
+0];

1437 
g
 = 
imageD©a
[
p
+
ofsG
];

1438 
b
 = 
imageD©a
[
p
+
ofsB
];

1439 
YDU
[
pos
]=+0.29900f*
r
+0.58700f*
g
+0.11400f*
b
-128;

1440 
UDU
[
pos
]=-0.16874f*
r
-0.33126f*
g
+0.50000f*
b
;

1441 
VDU
[
pos
]=+0.50000f*
r
-0.41869f*
g
-0.08131f*
b
;

1445 
DCY
 = 
	`¡biw__jpg_´oûssDU
(
s
, &
b™Buf
, &
b™CÁ
, 
YDU
, 
fdtbl_Y
, DCY, 
YDC_HT
, 
YAC_HT
);

1446 
DCU
 = 
	`¡biw__jpg_´oûssDU
(
s
, &
b™Buf
, &
b™CÁ
, 
UDU
, 
fdtbl_UV
, DCU, 
UVDC_HT
, 
UVAC_HT
);

1447 
DCV
 = 
	`¡biw__jpg_´oûssDU
(
s
, &
b™Buf
, &
b™CÁ
, 
VDU
, 
fdtbl_UV
, DCV, 
UVDC_HT
, 
UVAC_HT
);

1452 
	`¡biw__jpg_wr™eB™s
(
s
, &
b™Buf
, &
b™CÁ
, 
flB™s
);

1456 
	`¡biw__putc
(
s
, 0xFF);

1457 
	`¡biw__putc
(
s
, 0xD9);

1460 
	}
}

1462 
STBIWDEF
 
	$¡bi_wr™e_jpg_to_func
(
¡bi_wr™e_func
 *
func
, *
cÚ‹xt
, 
x
, 
y
, 
comp
, cÚ¡ *
d©a
, 
qu®™y
)

1464 
¡bi__wr™e_cÚ‹xt
 
s
;

1465 
	`¡bi__¡¬t_wr™e_ÿÎbacks
(&
s
, 
func
, 
cÚ‹xt
);

1466  
	`¡bi_wr™e_jpg_cÜe
(&
s
, 
x
, 
y
, 
comp
, (*è
d©a
, 
qu®™y
);

1467 
	}
}

1470 #iâdeà
STBI_WRITE_NO_STDIO


1471 
STBIWDEF
 
	$¡bi_wr™e_jpg
(cÚ¡ *
f’ame
, 
x
, 
y
, 
comp
, cÚ¡ *
d©a
, 
qu®™y
)

1473 
¡bi__wr™e_cÚ‹xt
 
s
;

1474 ià(
	`¡bi__¡¬t_wr™e_fe
(&
s
,
f’ame
)) {

1475 
r
 = 
	`¡bi_wr™e_jpg_cÜe
(&
s
, 
x
, 
y
, 
comp
, 
d©a
, 
qu®™y
);

1476 
	`¡bi__’d_wr™e_fe
(&
s
);

1477  
r
;

1480 
	}
}

	@tree.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~"Œ“.h
"

4 
	~"uts.h
"

5 
	~"d©a.h
"

7 
	$chªge_Ëaves
(
Œ“
 *
t
, *
Ëaf_li¡
)

9 
li¡
 *
Îi¡
 = 
	`g‘_·ths
(
Ëaf_li¡
);

10 **
Ëaves
 = (**)
	`li¡_to_¬¿y
(
Îi¡
);

11 
n
 = 
Îi¡
->
size
;

12 
i
,
j
;

13 
found
 = 0;

14 
i
 = 0; i < 
t
->
n
; ++i){

15 
t
->
Ëaf
[
i
] = 0;

16 
j
 = 0; j < 
n
; ++j){

17 ià(0==
	`¡rcmp
(
t
->
Çme
[
i
], 
Ëaves
[
j
])){

18 
t
->
Ëaf
[
i
] = 1;

19 ++
found
;

24 
	`årštf
(
¡d”r
, "Found %d†—ves.\n", 
found
);

25 
	}
}

27 
	$g‘_h›¿rchy_´obab™y
(*
x
, 
Œ“
 *
h›r
, 
c
, 
¡ride
)

29 
p
 = 1;

30 
c
 >= 0){

31 
p
 =… * 
x
[
c
*
¡ride
];

32 
c
 = 
h›r
->
·»Á
[c];

34  
p
;

35 
	}
}

37 
	$h›¿rchy_´ediùiÚs
(*
´ediùiÚs
, 
n
, 
Œ“
 *
h›r
, 
Úly_Ëaves
, 
¡ride
)

39 
j
;

40 
j
 = 0; j < 
n
; ++j){

41 
·»Á
 = 
h›r
->·»Á[
j
];

42 if(
·»Á
 >= 0){

43 
´ediùiÚs
[
j
*
¡ride
] *ğ´ediùiÚs[
·»Á
*stride];

46 if(
Úly_Ëaves
){

47 
j
 = 0; j < 
n
; ++j){

48 if(!
h›r
->
Ëaf
[
j
]è
´ediùiÚs
[j*
¡ride
] = 0;

51 
	}
}

53 
	$h›¿rchy_tİ_´ediùiÚ
(*
´ediùiÚs
, 
Œ“
 *
h›r
, 
th»sh
, 
¡ride
)

55 
p
 = 1;

56 
group
 = 0;

57 
i
;

59 
max
 = 0;

60 
max_i
 = 0;

62 
i
 = 0; i < 
h›r
->
group_size
[
group
]; ++i){

63 
šdex
 = 
i
 + 
h›r
->
group_off£t
[
group
];

64 
v®
 = 
´ediùiÚs
[(
i
 + 
h›r
->
group_off£t
[
group
])*
¡ride
];

65 if(
v®
 > 
max
){

66 
max_i
 = 
šdex
;

67 
max
 = 
v®
;

70 if(
p
*
max
 > 
th»sh
){

71 
p
 =…*
max
;

72 
group
 = 
h›r
->
chd
[
max_i
];

73 if(
h›r
->
chd
[
max_i
] < 0)  max_i;

74 } ià(
group
 == 0){

75  
max_i
;

77  
h›r
->
·»Á
[h›r->
group_off£t
[
group
]];

81 
	}
}

83 
Œ“
 *
	$»ad_Œ“
(*
f’ame
)

85 
Œ“
 
t
 = {0};

86 
FILE
 *
å
 = 
	`fİ’
(
f’ame
, "r");

88 *
lše
;

89 
Ï¡_·»Á
 = -1;

90 
group_size
 = 0;

91 
groups
 = 0;

92 
n
 = 0;

93 (
lše
=
	`fg‘l
(
å
)) != 0){

94 *
id
 = 
	`ÿÎoc
(256, ());

95 
·»Á
 = -1;

96 
	`ssÿnf
(
lše
, "% %d", 
id
, &
·»Á
);

97 
t
.
·»Á
 = 
	`»®loc
Ñ.·»Á, (
n
+1)*());

98 
t
.
·»Á
[
n
] =…arent;

100 
t
.
chd
 = 
	`»®loc
Ñ.chd, (
n
+1)*());

101 
t
.
chd
[
n
] = -1;

103 
t
.
Çme
 = 
	`»®loc
Ñ.Çme, (
n
+1)*(*));

104 
t
.
Çme
[
n
] = 
id
;

105 if(
·»Á
 !ğ
Ï¡_·»Á
){

106 ++
groups
;

107 
t
.
group_off£t
 = 
	`»®loc
Ñ.group_off£t, 
groups
 * ());

108 
t
.
group_off£t
[
groups
 - 1] = 
n
 - 
group_size
;

109 
t
.
group_size
 = 
	`»®loc
Ñ.group_size, 
groups
 * ());

110 
t
.
group_size
[
groups
 - 1] = group_size;

111 
group_size
 = 0;

112 
Ï¡_·»Á
 = 
·»Á
;

114 
t
.
group
 = 
	`»®loc
Ñ.group, (
n
+1)*());

115 
t
.
group
[
n
] = 
groups
;

116 ià(
·»Á
 >= 0) {

117 
t
.
chd
[
·»Á
] = 
groups
;

119 ++
n
;

120 ++
group_size
;

122 ++
groups
;

123 
t
.
group_off£t
 = 
	`»®loc
Ñ.group_off£t, 
groups
 * ());

124 
t
.
group_off£t
[
groups
 - 1] = 
n
 - 
group_size
;

125 
t
.
group_size
 = 
	`»®loc
Ñ.group_size, 
groups
 * ());

126 
t
.
group_size
[
groups
 - 1] = group_size;

127 
t
.
n
 =‚;

128 
t
.
groups
 = groups;

129 
t
.
Ëaf
 = 
	`ÿÎoc
(
n
, ());

130 
i
;

131 
i
 = 0; i < 
n
; ++iè
t
.
Ëaf
[i] = 1;

132 
i
 = 0; i < 
n
; ++ièif(
t
.
·»Á
[i] >ğ0èt.
Ëaf
[t.parent[i]] = 0;

134 
	`fşo£
(
å
);

135 
Œ“
 *
Œ“_±r
 = 
	`ÿÎoc
(1, (tree));

136 *
Œ“_±r
 = 
t
;

138  
Œ“_±r
;

139 
	}
}

	@tree.h

1 #iâdeà
TREE_H


2 
	#TREE_H


	)

3 
	~"d¬kÃt.h
"

5 
h›¿rchy_tİ_´ediùiÚ
(*
´ediùiÚs
, 
Œ“
 *
h›r
, 
th»sh
, 
¡ride
);

6 
g‘_h›¿rchy_´obab™y
(*
x
, 
Œ“
 *
h›r
, 
c
, 
¡ride
);

	@upsample_layer.c

1 
	~"up§m¶e_Ïy”.h
"

2 
	~"cuda.h
"

3 
	~"bÏs.h
"

5 
	~<¡dio.h
>

7 
Ïy”
 
	$make_up§m¶e_Ïy”
(
b©ch
, 
w
, 
h
, 
c
, 
¡ride
)

9 
Ïy”
 
l
 = {0};

10 
l
.
ty³
 = 
UPSAMPLE
;

11 
l
.
b©ch
 = batch;

12 
l
.
w
 = w;

13 
l
.
h
 = h;

14 
l
.
c
 = c;

15 
l
.
out_w
 = 
w
*
¡ride
;

16 
l
.
out_h
 = 
h
*
¡ride
;

17 
l
.
out_c
 = 
c
;

18 if(
¡ride
 < 0){

19 
¡ride
 = -stride;

20 
l
.
»v”£
=1;

21 
l
.
out_w
 = 
w
/
¡ride
;

22 
l
.
out_h
 = 
h
/
¡ride
;

24 
l
.
¡ride
 = stride;

25 
l
.
ouuts
 =†.
out_w
*l.
out_h
*l.
out_c
;

26 
l
.
šputs
 =†.
w
*l.
h
*l.
c
;

27 
l
.
d–
 = 
	`ÿÎoc
Ö.
ouuts
*
b©ch
, ());

28 
l
.
ouut
 = 
	`ÿÎoc
Ö.
ouuts
*
b©ch
, ());;

30 
l
.
fÜw¬d
 = 
fÜw¬d_up§m¶e_Ïy”
;

31 
l
.
backw¬d
 = 
backw¬d_up§m¶e_Ïy”
;

32 #ifdeà
GPU


33 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_up§m¶e_Ïy”_gpu
;

34 
l
.
backw¬d_gpu
 = 
backw¬d_up§m¶e_Ïy”_gpu
;

36 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
,†.
ouuts
*
b©ch
);

37 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
,†.
ouuts
*
b©ch
);

39 if(
l
.
»v”£
è
	`årštf
(
¡d”r
, "down§m¶ %2dx %4d x%4d x%4d -> %4d x%4d x%4d\n", 
¡ride
, 
w
, 
h
, 
c
,†.
out_w
,†.
out_h
,†.
out_c
);

40 
	`årštf
(
¡d”r
, "up§m¶ %2dx %4d x%4d x%4d -> %4d x%4d x%4d\n", 
¡ride
, 
w
, 
h
, 
c
, 
l
.
out_w
,†.
out_h
,†.
out_c
);

41  
l
;

42 
	}
}

44 
	$»size_up§m¶e_Ïy”
(
Ïy”
 *
l
, 
w
, 
h
)

46 
l
->
w
 = w;

47 
l
->
h
 = h;

48 
l
->
out_w
 = 
w
*l->
¡ride
;

49 
l
->
out_h
 = 
h
*l->
¡ride
;

50 if(
l
->
»v”£
){

51 
l
->
out_w
 = 
w
/l->
¡ride
;

52 
l
->
out_h
 = 
h
/l->
¡ride
;

54 
l
->
ouuts
 =†->
out_w
*l->
out_h
*l->
out_c
;

55 
l
->
šputs
 =†->
h
*l->
w
*l->
c
;

56 
l
->
d–
 = 
	`»®loc
Ö->d–,†->
ouuts
*l->
b©ch
*());

57 
l
->
ouut
 = 
	`»®loc
Ö->ouut,†->
ouuts
*l->
b©ch
*());

59 #ifdeà
GPU


60 
	`cuda_ä“
(
l
->
ouut_gpu
);

61 
	`cuda_ä“
(
l
->
d–_gpu
);

62 
l
->
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö->
ouut
,†->
ouuts
*l->
b©ch
);

63 
l
->
d–_gpu
 = 
	`cuda_make_¬¿y
Ö->
d–
,†->
ouuts
*l->
b©ch
);

66 
	}
}

68 
	$fÜw¬d_up§m¶e_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

70 
	`fl_ıu
(
l
.
ouuts
*l.
b©ch
, 0,†.
ouut
, 1);

71 if(
l
.
»v”£
){

72 
	`up§m¶e_ıu
(
l
.
ouut
,†.
out_w
,†.
out_h
,†.
c
,†.
b©ch
,†.
¡ride
, 0,†.
sÿË
, 
Ãt
.
šput
);

74 
	`up§m¶e_ıu
(
Ãt
.
šput
, 
l
.
w
,†.
h
,†.
c
,†.
b©ch
,†.
¡ride
, 1,†.
sÿË
,†.
ouut
);

76 
	}
}

78 
	$backw¬d_up§m¶e_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

80 if(
l
.
»v”£
){

81 
	`up§m¶e_ıu
(
l
.
d–
,†.
out_w
,†.
out_h
,†.
c
,†.
b©ch
,†.
¡ride
, 1,†.
sÿË
, 
Ãt
.delta);

83 
	`up§m¶e_ıu
(
Ãt
.
d–
, 
l
.
w
,†.
h
,†.
c
,†.
b©ch
,†.
¡ride
, 0,†.
sÿË
,†.delta);

85 
	}
}

87 #ifdeà
GPU


88 
	$fÜw¬d_up§m¶e_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

90 
	`fl_gpu
(
l
.
ouuts
*l.
b©ch
, 0,†.
ouut_gpu
, 1);

91 if(
l
.
»v”£
){

92 
	`up§m¶e_gpu
(
l
.
ouut_gpu
,†.
out_w
,†.
out_h
,†.
c
,†.
b©ch
,†.
¡ride
, 0,†.
sÿË
, 
Ãt
.
šput_gpu
);

94 
	`up§m¶e_gpu
(
Ãt
.
šput_gpu
, 
l
.
w
,†.
h
,†.
c
,†.
b©ch
,†.
¡ride
, 1,†.
sÿË
,†.
ouut_gpu
);

96 
	}
}

98 
	$backw¬d_up§m¶e_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

100 if(
l
.
»v”£
){

101 
	`up§m¶e_gpu
(
l
.
d–_gpu
,†.
out_w
,†.
out_h
,†.
c
,†.
b©ch
,†.
¡ride
, 1,†.
sÿË
, 
Ãt
.delta_gpu);

103 
	`up§m¶e_gpu
(
Ãt
.
d–_gpu
, 
l
.
w
,†.
h
,†.
c
,†.
b©ch
,†.
¡ride
, 0,†.
sÿË
,†.delta_gpu);

105 
	}
}

	@upsample_layer.h

1 #iâdeà
UPSAMPLE_LAYER_H


2 
	#UPSAMPLE_LAYER_H


	)

3 
	~"d¬kÃt.h
"

5 
Ïy”
 
make_up§m¶e_Ïy”
(
b©ch
, 
w
, 
h
, 
c
, 
¡ride
);

6 
fÜw¬d_up§m¶e_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

7 
backw¬d_up§m¶e_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

8 
»size_up§m¶e_Ïy”
(
Ïy”
 *
l
, 
w
, 
h
);

10 #ifdeà
GPU


11 
fÜw¬d_up§m¶e_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

12 
backw¬d_up§m¶e_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

	@utils.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<m©h.h
>

5 
	~<as£¹.h
>

6 
	~<uni¡d.h
>

7 
	~<æßt.h
>

8 
	~<lim™s.h
>

9 
	~<time.h
>

10 
	~<sys/time.h
>

12 
	~"uts.h
"

27 
	$wh©_time_is_™_now
()

29 
timev®
 
time
;

30 ià(
	`g‘timeofday
(&
time
,
NULL
)){

33  ()
time
.
tv_£c
 + (éime.
tv_u£c
 * .000001;

34 
	}
}

36 *
	$»ad_ši¡
(*
gpu_li¡
, *
ngpus
, 
d
)

38 *
gpus
 = 0;

39 if(
gpu_li¡
){

40 
Ën
 = 
	`¡¾’
(
gpu_li¡
);

41 *
ngpus
 = 1;

42 
i
;

43 
i
 = 0; i < 
Ën
; ++i){

44 ià(
gpu_li¡
[
i
] =ğ','è++*
ngpus
;

46 
gpus
 = 
	`ÿÎoc
(*
ngpus
, ());

47 
i
 = 0; i < *
ngpus
; ++i){

48 
gpus
[
i
] = 
	`©oi
(
gpu_li¡
);

49 
gpu_li¡
 = 
	`¡rchr
(gpu_list, ',')+1;

52 
gpus
 = 
	`ÿÎoc
(1, ());

53 *
gpus
 = 
d
;

54 *
ngpus
 = 1;

56  
gpus
;

57 
	}
}

59 *
	$»ad_m­
(*
f’ame
)

61 
n
 = 0;

62 *
m­
 = 0;

63 *
¡r
;

64 
FILE
 *
fe
 = 
	`fİ’
(
f’ame
, "r");

65 if(!
fe
è
	`fe_”rÜ
(
f’ame
);

66 (
¡r
=
	`fg‘l
(
fe
))){

67 ++
n
;

68 
m­
 = 
	`»®loc
(m­, 
n
*());

69 
m­
[
n
-1] = 
	`©oi
(
¡r
);

71  
m­
;

72 
	}
}

74 
	$sÜ_shufæe
(*
¬r
, 
size_t
 
n
, size_ˆ
size
, size_ˆ
£ùiÚs
)

76 
size_t
 
i
;

77 
i
 = 0; i < 
£ùiÚs
; ++i){

78 
size_t
 
¡¬t
 = 
n
*
i
/
£ùiÚs
;

79 
size_t
 
’d
 = 
n
*(
i
+1)/
£ùiÚs
;

80 
size_t
 
num
 = 
’d
-
¡¬t
;

81 
	`shufæe
(
¬r
+(
¡¬t
*
size
), 
num
, size);

83 
	}
}

85 
	$shufæe
(*
¬r
, 
size_t
 
n
, size_ˆ
size
)

87 
size_t
 
i
;

88 *
swp
 = 
	`ÿÎoc
(1, 
size
);

89 
i
 = 0; i < 
n
-1; ++i){

90 
size_t
 
j
 = 
i
 + 
	`¿nd
()/(
RAND_MAX
 / (
n
-i)+1);

91 
	`memıy
(
swp
, 
¬r
+(
j
*
size
), size);

92 
	`memıy
(
¬r
+(
j
*
size
),‡¼+(
i
*size), size);

93 
	`memıy
(
¬r
+(
i
*
size
), 
swp
, size);

95 
	}
}

97 *
	$¿ndom_šdex_Üd”
(
mš
, 
max
)

99 *
šds
 = 
	`ÿÎoc
(
max
-
mš
, ());

100 
i
;

101 
i
 = 
mš
; i < 
max
; ++i){

102 
šds
[
i
] = i;

104 
i
 = 
mš
; i < 
max
-1; ++i){

105 
sw­
 = 
šds
[
i
];

106 
šdex
 = 
i
 + 
	`¿nd
()%(
max
-i);

107 
šds
[
i
] = inds[
šdex
];

108 
šds
[
šdex
] = 
sw­
;

110  
šds
;

111 
	}
}

113 
	$d–_¬g
(
¬gc
, **
¬gv
, 
šdex
)

115 
i
;

116 
i
 = 
šdex
; i < 
¬gc
-1; ++iè
¬gv
[i] =‡rgv[i+1];

117 
¬gv
[
i
] = 0;

118 
	}
}

120 
	$fšd_¬g
(
¬gc
, * 
¬gv
[], *
¬g
)

122 
i
;

123 
i
 = 0; i < 
¬gc
; ++i) {

124 if(!
¬gv
[
i
]) ;

125 if(0==
	`¡rcmp
(
¬gv
[
i
], 
¬g
)) {

126 
	`d–_¬g
(
¬gc
, 
¬gv
, 
i
);

131 
	}
}

133 
	$fšd_št_¬g
(
¬gc
, **
¬gv
, *
¬g
, 
def
)

135 
i
;

136 
i
 = 0; i < 
¬gc
-1; ++i){

137 if(!
¬gv
[
i
]) ;

138 if(0==
	`¡rcmp
(
¬gv
[
i
], 
¬g
)){

139 
def
 = 
	`©oi
(
¬gv
[
i
+1]);

140 
	`d–_¬g
(
¬gc
, 
¬gv
, 
i
);

141 
	`d–_¬g
(
¬gc
, 
¬gv
, 
i
);

145  
def
;

146 
	}
}

148 
	$fšd_æßt_¬g
(
¬gc
, **
¬gv
, *
¬g
, 
def
)

150 
i
;

151 
i
 = 0; i < 
¬gc
-1; ++i){

152 if(!
¬gv
[
i
]) ;

153 if(0==
	`¡rcmp
(
¬gv
[
i
], 
¬g
)){

154 
def
 = 
	`©of
(
¬gv
[
i
+1]);

155 
	`d–_¬g
(
¬gc
, 
¬gv
, 
i
);

156 
	`d–_¬g
(
¬gc
, 
¬gv
, 
i
);

160  
def
;

161 
	}
}

163 *
	$fšd_ch¬_¬g
(
¬gc
, **
¬gv
, *
¬g
, *
def
)

165 
i
;

166 
i
 = 0; i < 
¬gc
-1; ++i){

167 if(!
¬gv
[
i
]) ;

168 if(0==
	`¡rcmp
(
¬gv
[
i
], 
¬g
)){

169 
def
 = 
¬gv
[
i
+1];

170 
	`d–_¬g
(
¬gc
, 
¬gv
, 
i
);

171 
	`d–_¬g
(
¬gc
, 
¬gv
, 
i
);

175  
def
;

176 
	}
}

179 *
	$ba£cfg
(*
cfgfe
)

181 *
c
 = 
cfgfe
;

182 *
Ãxt
;

183 (
Ãxt
 = 
	`¡rchr
(
c
, '/')))

185 
c
 = 
Ãxt
+1;

187 
c
 = 
	`cİy_¡ršg
(c);

188 
Ãxt
 = 
	`¡rchr
(
c
, '.');

189 ià(
Ãxt
) *next = 0;

190  
c
;

191 
	}
}

193 
	$®phªum_to_št
(
c
)

195  (
c
 < 58) ? c - 48 : c-87;

196 
	}
}

197 
	$št_to_®phªum
(
i
)

199 ià(
i
 == 36)  '.';

200  (
i
 < 10) ? i + 48 : i + 87;

201 
	}
}

203 
	$pm
(
M
, 
N
, *
A
)

205 
i
,
j
;

206 
i
 =0 ; i < 
M
; ++i){

207 
	`´štf
("%d ", 
i
+1);

208 
j
 = 0; j < 
N
; ++j){

209 
	`´štf
("%2.4f, ", 
A
[
i
*
N
+
j
]);

211 
	`´štf
("\n");

213 
	`´štf
("\n");

214 
	}
}

216 
	$fšd_»¶aû
(*
¡r
, *
Üig
, *
»p
, *
ouut
)

218 
bufãr
[4096] = {0};

219 *
p
;

221 
	`¥rštf
(
bufãr
, "%s", 
¡r
);

222 if(!(
p
 = 
	`¡r¡r
(
bufãr
, 
Üig
))){

223 
	`¥rštf
(
ouut
, "%s", 
¡r
);

227 *
p
 = '\0';

229 
	`¥rštf
(
ouut
, "%s%s%s", 
bufãr
, 
»p
, 
p
+
	`¡¾’
(
Üig
));

230 
	}
}

232 
	$£c
(
şock_t
 
şocks
)

234  ()
şocks
/
CLOCKS_PER_SEC
;

235 
	}
}

237 
	$tİ_k
(*
a
, 
n
, 
k
, *
šdex
)

239 
i
,
j
;

240 
j
 = 0; j < 
k
; ++jè
šdex
[j] = -1;

241 
i
 = 0; i < 
n
; ++i){

242 
cu¼
 = 
i
;

243 
j
 = 0; j < 
k
; ++j){

244 if((
šdex
[
j
] < 0è|| 
a
[
cu¼
] >‡[index[j]]){

245 
sw­
 = 
cu¼
;

246 
cu¼
 = 
šdex
[
j
];

247 
šdex
[
j
] = 
sw­
;

251 
	}
}

253 
	$”rÜ
(cÚ¡ *
s
)

255 
	`³¼Ü
(
s
);

256 
	`as£¹
(0);

257 
	`ex™
(-1);

258 
	}
}

260 *
	$»ad_fe
(*
f’ame
)

262 
FILE
 *
å
 = 
	`fİ’
(
f’ame
, "rb");

263 
size_t
 
size
;

265 
	`f£ek
(
å
, 0, 
SEEK_END
);

266 
size
 = 
	`á–l
(
å
);

267 
	`f£ek
(
å
, 0, 
SEEK_SET
);

269 *
‹xt
 = 
	`ÿÎoc
(
size
+1, ());

270 
	`ä—d
(
‹xt
, 1, 
size
, 
å
);

271 
	`fşo£
(
å
);

272  
‹xt
;

273 
	}
}

275 
	$m®loc_”rÜ
()

277 
	`årštf
(
¡d”r
, "Mallocƒrror\n");

278 
	`ex™
(-1);

279 
	}
}

281 
	$fe_”rÜ
(*
s
)

283 
	`årštf
(
¡d”r
, "Couldn'ˆİ’ fe: %s\n", 
s
);

284 
	`ex™
(0);

285 
	}
}

287 
li¡
 *
	$¥l™_¡r
(*
s
, 
d–im
)

289 
size_t
 
i
;

290 
size_t
 
Ën
 = 
	`¡¾’
(
s
);

291 
li¡
 *
l
 = 
	`make_li¡
();

292 
	`li¡_š£¹
(
l
, 
s
);

293 
i
 = 0; i < 
Ën
; ++i){

294 if(
s
[
i
] =ğ
d–im
){

295 
s
[
i
] = '\0';

296 
	`li¡_š£¹
(
l
, &(
s
[
i
+1]));

299  
l
;

300 
	}
}

302 
	$¡r
(*
s
)

304 
size_t
 
i
;

305 
size_t
 
Ën
 = 
	`¡¾’
(
s
);

306 
size_t
 
off£t
 = 0;

307 
i
 = 0; i < 
Ën
; ++i){

308 
c
 = 
s
[
i
];

309 if(
c
==' '||c=='\t'||c=='\n'è++
off£t
;

310 
s
[
i
-
off£t
] = 
c
;

312 
s
[
Ën
-
off£t
] = '\0';

313 
	}
}

315 
	$¡r_ch¬
(*
s
, 
bad
)

317 
size_t
 
i
;

318 
size_t
 
Ën
 = 
	`¡¾’
(
s
);

319 
size_t
 
off£t
 = 0;

320 
i
 = 0; i < 
Ën
; ++i){

321 
c
 = 
s
[
i
];

322 if(
c
==
bad
è++
off£t
;

323 
s
[
i
-
off£t
] = 
c
;

325 
s
[
Ën
-
off£t
] = '\0';

326 
	}
}

328 
	$ä“_±rs
(**
±rs
, 
n
)

330 
i
;

331 
i
 = 0; i < 
n
; ++iè
	`ä“
(
±rs
[i]);

332 
	`ä“
(
±rs
);

333 
	}
}

335 *
	$fg‘l
(
FILE
 *
å
)

337 if(
	`ãof
(
å
))  0;

338 
size_t
 
size
 = 512;

339 *
lše
 = 
	`m®loc
(
size
*());

340 if(!
	`fg‘s
(
lše
, 
size
, 
å
)){

341 
	`ä“
(
lše
);

345 
size_t
 
cu¼
 = 
	`¡¾’
(
lše
);

347 (
lše
[
cu¼
-1] !ğ'\n'è&& !
	`ãof
(
å
)){

348 if(
cu¼
 =ğ
size
-1){

349 
size
 *= 2;

350 
lše
 = 
	`»®loc
Öše, 
size
*());

351 if(!
lše
) {

352 
	`´štf
("%ld\n", 
size
);

353 
	`m®loc_”rÜ
();

356 
size_t
 
»adsize
 = 
size
-
cu¼
;

357 if(
»adsize
 > 
INT_MAX
)„eadsize = INT_MAX-1;

358 
	`fg‘s
(&
lše
[
cu¼
], 
»adsize
, 
å
);

359 
cu¼
 = 
	`¡¾’
(
lše
);

361 if(
lše
[
cu¼
-1] == '\n')†ine[curr-1] = '\0';

363  
lše
;

364 
	}
}

366 
	$»ad_št
(
fd
)

368 
n
 = 0;

369 
Ãxt
 = 
	`»ad
(
fd
, &
n
, ());

370 if(
Ãxt
 <= 0)  -1;

371  
n
;

372 
	}
}

374 
	$wr™e_št
(
fd
, 
n
)

376 
Ãxt
 = 
	`wr™e
(
fd
, &
n
, ());

377 if(
Ãxt
 <ğ0è
	`”rÜ
("read failed");

378 
	}
}

380 
	$»ad_®l_ç
(
fd
, *
bufãr
, 
size_t
 
by‹s
)

382 
size_t
 
n
 = 0;

383 
n
 < 
by‹s
){

384 
Ãxt
 = 
	`»ad
(
fd
, 
bufãr
 + 
n
, 
by‹s
-n);

385 if(
Ãxt
 <= 0)  1;

386 
n
 +ğ
Ãxt
;

389 
	}
}

391 
	$wr™e_®l_ç
(
fd
, *
bufãr
, 
size_t
 
by‹s
)

393 
size_t
 
n
 = 0;

394 
n
 < 
by‹s
){

395 
size_t
 
Ãxt
 = 
	`wr™e
(
fd
, 
bufãr
 + 
n
, 
by‹s
-n);

396 if(
Ãxt
 <= 0)  1;

397 
n
 +ğ
Ãxt
;

400 
	}
}

402 
	$»ad_®l
(
fd
, *
bufãr
, 
size_t
 
by‹s
)

404 
size_t
 
n
 = 0;

405 
n
 < 
by‹s
){

406 
Ãxt
 = 
	`»ad
(
fd
, 
bufãr
 + 
n
, 
by‹s
-n);

407 if(
Ãxt
 <ğ0è
	`”rÜ
("read failed");

408 
n
 +ğ
Ãxt
;

410 
	}
}

412 
	$wr™e_®l
(
fd
, *
bufãr
, 
size_t
 
by‹s
)

414 
size_t
 
n
 = 0;

415 
n
 < 
by‹s
){

416 
size_t
 
Ãxt
 = 
	`wr™e
(
fd
, 
bufãr
 + 
n
, 
by‹s
-n);

417 if(
Ãxt
 <ğ0è
	`”rÜ
("write failed");

418 
n
 +ğ
Ãxt
;

420 
	}
}

423 *
	$cİy_¡ršg
(*
s
)

425 *
cİy
 = 
	`m®loc
(
	`¡¾’
(
s
)+1);

426 
	`¡ºıy
(
cİy
, 
s
, 
	`¡¾’
(s)+1);

427  
cİy
;

428 
	}
}

430 
li¡
 *
	$·r£_csv_lše
(*
lše
)

432 
li¡
 *
l
 = 
	`make_li¡
();

433 *
c
, *
p
;

434 
š
 = 0;

435 
c
 = 
lše
, 
p
 =†ine; *c != '\0'; ++c){

436 if(*
c
 =ğ'"'è
š
 = !in;

437 if(*
c
 =ğ',' && !
š
){

438 *
c
 = '\0';

439 
	`li¡_š£¹
(
l
, 
	`cİy_¡ršg
(
p
));

440 
p
 = 
c
+1;

443 
	`li¡_š£¹
(
l
, 
	`cİy_¡ršg
(
p
));

444  
l
;

445 
	}
}

447 
	$couÁ_f›lds
(*
lše
)

449 
couÁ
 = 0;

450 
dÚe
 = 0;

451 *
c
;

452 
c
 = 
lše
; !
dÚe
; ++c){

453 
dÚe
 = (*
c
 == '\0');

454 if(*
c
 =ğ',' || 
dÚe
è++
couÁ
;

456  
couÁ
;

457 
	}
}

459 *
	$·r£_f›lds
(*
lše
, 
n
)

461 *
f›ld
 = 
	`ÿÎoc
(
n
, ());

462 *
c
, *
p
, *
’d
;

463 
couÁ
 = 0;

464 
dÚe
 = 0;

465 
c
 = 
lše
, 
p
 =†še; !
dÚe
; ++c){

466 
dÚe
 = (*
c
 == '\0');

467 if(*
c
 =ğ',' || 
dÚe
){

468 *
c
 = '\0';

469 
f›ld
[
couÁ
] = 
	`¡¹od
(
p
, &
’d
);

470 if(
p
 =ğ
c
è
f›ld
[
couÁ
] = 
	`Çn
("");

471 if(
’d
 !ğ
c
 && (’d !ğc-1 || *’d !ğ'\r')è
f›ld
[
couÁ
] = 
	`Çn
("");

472 
p
 = 
c
+1;

473 ++
couÁ
;

476  
f›ld
;

477 
	}
}

479 
	$sum_¬¿y
(*
a
, 
n
)

481 
i
;

482 
sum
 = 0;

483 
i
 = 0; i < 
n
; ++iè
sum
 +ğ
a
[i];

484  
sum
;

485 
	}
}

488 
	$sum_¬¿y_diû
(*
a
, *
b
, 
n
)

490 
i
;

491 
sum
 = 0;

492 
i
 = 0; i < 
n
; ++iè
sum
 +ğ
a
[i] / 
b
[i];

493  
sum
;

494 
	}
}

496 
	$m—n_¬¿y
(*
a
, 
n
)

498  
	`sum_¬¿y
(
a
,
n
)/n;

499 
	}
}

501 
	$m—n_¬¿ys
(**
a
, 
n
, 
–s
, *
avg
)

503 
i
;

504 
j
;

505 
	`mem£t
(
avg
, 0, 
–s
*());

506 
j
 = 0; j < 
n
; ++j){

507 
i
 = 0; i < 
–s
; ++i){

508 
avg
[
i
] +ğ
a
[
j
][i];

511 
i
 = 0; i < 
–s
; ++i){

512 
avg
[
i
] /ğ
n
;

514 
	}
}

516 
	$´št_¡©i¡ics
(*
a
, 
n
)

518 
m
 = 
	`m—n_¬¿y
(
a
, 
n
);

519 
v
 = 
	`v¬Ÿnû_¬¿y
(
a
, 
n
);

520 
	`´štf
("MSE: %.6f, M—n: %.6f, V¬Ÿnû: %.6f\n", 
	`m£_¬¿y
(
a
, 
n
), 
m
, 
v
);

521 
	}
}

523 
	$v¬Ÿnû_¬¿y
(*
a
, 
n
)

525 
i
;

526 
sum
 = 0;

527 
m—n
 = 
	`m—n_¬¿y
(
a
, 
n
);

528 
i
 = 0; i < 
n
; ++iè
sum
 +ğ(
a
[i] - 
m—n
)*(a[i]-mean);

529 
v¬Ÿnû
 = 
sum
/
n
;

530  
v¬Ÿnû
;

531 
	}
}

533 
	$cÚ¡¿š_št
(
a
, 
mš
, 
max
)

535 ià(
a
 < 
mš
)  min;

536 ià(
a
 > 
max
)  max;

537  
a
;

538 
	}
}

540 
	$cÚ¡¿š
(
mš
, 
max
, 
a
)

542 ià(
a
 < 
mš
)  min;

543 ià(
a
 > 
max
)  max;

544  
a
;

545 
	}
}

547 
	$di¡_¬¿y
(*
a
, *
b
, 
n
, 
sub
)

549 
i
;

550 
sum
 = 0;

551 
i
 = 0; i < 
n
; i +ğ
sub
è
sum
 +ğ
	`pow
(
a
[i]-
b
[i], 2);

552  
	`sq¹
(
sum
);

553 
	}
}

555 
	$m£_¬¿y
(*
a
, 
n
)

557 
i
;

558 
sum
 = 0;

559 
i
 = 0; i < 
n
; ++iè
sum
 +ğ
a
[i]*a[i];

560  
	`sq¹
(
sum
/
n
);

561 
	}
}

563 
	$nÜm®ize_¬¿y
(*
a
, 
n
)

565 
i
;

566 
mu
 = 
	`m—n_¬¿y
(
a
,
n
);

567 
sigma
 = 
	`sq¹
(
	`v¬Ÿnû_¬¿y
(
a
,
n
));

568 
i
 = 0; i < 
n
; ++i){

569 
a
[
i
] = (a[i] - 
mu
)/
sigma
;

571 
mu
 = 
	`m—n_¬¿y
(
a
,
n
);

572 
sigma
 = 
	`sq¹
(
	`v¬Ÿnû_¬¿y
(
a
,
n
));

573 
	}
}

575 
	$Œª¦©e_¬¿y
(*
a
, 
n
, 
s
)

577 
i
;

578 
i
 = 0; i < 
n
; ++i){

579 
a
[
i
] +ğ
s
;

581 
	}
}

583 
	$mag_¬¿y
(*
a
, 
n
)

585 
i
;

586 
sum
 = 0;

587 
i
 = 0; i < 
n
; ++i){

588 
sum
 +ğ
a
[
i
]*a[i];

590  
	`sq¹
(
sum
);

591 
	}
}

593 
	$sÿË_¬¿y
(*
a
, 
n
, 
s
)

595 
i
;

596 
i
 = 0; i < 
n
; ++i){

597 
a
[
i
] *ğ
s
;

599 
	}
}

601 
	$§m¶e_¬¿y
(*
a
, 
n
)

603 
sum
 = 
	`sum_¬¿y
(
a
, 
n
);

604 
	`sÿË_¬¿y
(
a
, 
n
, 1./
sum
);

605 
r
 = 
	`¿nd_unifÜm
(0, 1);

606 
i
;

607 
i
 = 0; i < 
n
; ++i){

608 
r
 =„ - 
a
[
i
];

609 ià(
r
 <ğ0è 
i
;

611  
n
-1;

612 
	}
}

614 
	$max_št_šdex
(*
a
, 
n
)

616 if(
n
 <= 0)  -1;

617 
i
, 
max_i
 = 0;

618 
max
 = 
a
[0];

619 
i
 = 1; i < 
n
; ++i){

620 if(
a
[
i
] > 
max
){

621 
max
 = 
a
[
i
];

622 
max_i
 = 
i
;

625  
max_i
;

626 
	}
}

628 
	$max_šdex
(*
a
, 
n
)

630 if(
n
 <= 0)  -1;

631 
i
, 
max_i
 = 0;

632 
max
 = 
a
[0];

633 
i
 = 1; i < 
n
; ++i){

634 if(
a
[
i
] > 
max
){

635 
max
 = 
a
[
i
];

636 
max_i
 = 
i
;

639  
max_i
;

640 
	}
}

642 
	$št_šdex
(*
a
, 
v®
, 
n
)

644 
i
;

645 
i
 = 0; i < 
n
; ++i){

646 if(
a
[
i
] =ğ
v®
)  i;

649 
	}
}

651 
	$¿nd_št
(
mš
, 
max
)

653 ià(
max
 < 
mš
){

654 
s
 = 
mš
;

655 
mš
 = 
max
;

656 
max
 = 
s
;

658 
r
 = (
	`¿nd
()%(
max
 - 
mš
 + 1)) + min;

659  
r
;

660 
	}
}

663 
	$¿nd_nÜm®
()

665 
haveS·»
 = 0;

666 
¿nd1
, 
¿nd2
;

668 if(
haveS·»
)

670 
haveS·»
 = 0;

671  
	`sq¹
(
¿nd1
è* 
	`sš
(
¿nd2
);

674 
haveS·»
 = 1;

676 
¿nd1
 = 
	`¿nd
(è/ ((è
RAND_MAX
);

677 if(
¿nd1
 < 1e-100)„and1 = 1e-100;

678 
¿nd1
 = -2 * 
	`log
(rand1);

679 
¿nd2
 = (
	`¿nd
(è/ ((è
RAND_MAX
)è* 
TWO_PI
;

681  
	`sq¹
(
¿nd1
è* 
	`cos
(
¿nd2
);

682 
	}
}

695 
size_t
 
	$¿nd_size_t
()

697  ((
size_t
)(
	`¿nd
()&0xff) << 56) |

698 ((
size_t
)(
	`¿nd
()&0xff) << 48) |

699 ((
size_t
)(
	`¿nd
()&0xff) << 40) |

700 ((
size_t
)(
	`¿nd
()&0xff) << 32) |

701 ((
size_t
)(
	`¿nd
()&0xff) << 24) |

702 ((
size_t
)(
	`¿nd
()&0xff) << 16) |

703 ((
size_t
)(
	`¿nd
()&0xff) << 8) |

704 ((
size_t
)(
	`¿nd
()&0xff) << 0);

705 
	}
}

707 
	$¿nd_unifÜm
(
mš
, 
max
)

709 if(
max
 < 
mš
){

710 
sw­
 = 
mš
;

711 
mš
 = 
max
;

712 
max
 = 
sw­
;

714  (()
	`¿nd
()/
RAND_MAX
 * (
max
 - 
mš
)) + min;

715 
	}
}

717 
	$¿nd_sÿË
(
s
)

719 
sÿË
 = 
	`¿nd_unifÜm
(1, 
s
);

720 if(
	`¿nd
()%2è 
sÿË
;

721  1./
sÿË
;

722 
	}
}

724 **
	$Úe_hÙ_’code
(*
a
, 
n
, 
k
)

726 
i
;

727 **
t
 = 
	`ÿÎoc
(
n
, (*));

728 
i
 = 0; i < 
n
; ++i){

729 
t
[
i
] = 
	`ÿÎoc
(
k
, ());

730 
šdex
 = ()
a
[
i
];

731 
t
[
i
][
šdex
] = 1;

733  
t
;

734 
	}
}

	@utils.h

1 #iâdeà
UTILS_H


2 
	#UTILS_H


	)

3 
	~<¡dio.h
>

4 
	~<time.h
>

5 
	~"d¬kÃt.h
"

6 
	~"li¡.h
"

8 
	#TIME
(
a
) \

10 
¡¬t
 = 
	`wh©_time_is_™_now
(); \

11 
a
; \

12 
	`´štf
("% took: %à£cÚds\n", #a, 
	`wh©_time_is_™_now
(è- 
¡¬t
); \

13 } 0)

	)

15 
	#TWO_PI
 6.2831853071795864769252866f

	)

17 
wh©_time_is_™_now
();

18 
shufæe
(*
¬r
, 
size_t
 
n
, size_ˆ
size
);

19 
sÜ_shufæe
(*
¬r
, 
size_t
 
n
, size_ˆ
size
, size_ˆ
£ùiÚs
);

20 
ä“_±rs
(**
±rs
, 
n
);

21 
®phªum_to_št
(
c
);

22 
št_to_®phªum
(
i
);

23 
»ad_št
(
fd
);

24 
wr™e_št
(
fd
, 
n
);

25 
»ad_®l
(
fd
, *
bufãr
, 
size_t
 
by‹s
);

26 
wr™e_®l
(
fd
, *
bufãr
, 
size_t
 
by‹s
);

27 
»ad_®l_ç
(
fd
, *
bufãr
, 
size_t
 
by‹s
);

28 
wr™e_®l_ç
(
fd
, *
bufãr
, 
size_t
 
by‹s
);

29 
fšd_»¶aû
(*
¡r
, *
Üig
, *
»p
, *
ouut
);

30 
m®loc_”rÜ
();

31 
fe_”rÜ
(*
s
);

32 
¡r
(*
s
);

33 
¡r_ch¬
(*
s
, 
bad
);

34 
li¡
 *
¥l™_¡r
(*
s
, 
d–im
);

35 *
fg‘l
(
FILE
 *
å
);

36 
li¡
 *
·r£_csv_lše
(*
lše
);

37 *
cİy_¡ršg
(*
s
);

38 
couÁ_f›lds
(*
lše
);

39 *
·r£_f›lds
(*
lše
, 
n
);

40 
Œª¦©e_¬¿y
(*
a
, 
n
, 
s
);

41 
cÚ¡¿š
(
mš
, 
max
, 
a
);

42 
cÚ¡¿š_št
(
a
, 
mš
, 
max
);

43 
¿nd_sÿË
(
s
);

44 
¿nd_št
(
mš
, 
max
);

45 
m—n_¬¿ys
(**
a
, 
n
, 
–s
, *
avg
);

46 
di¡_¬¿y
(*
a
, *
b
, 
n
, 
sub
);

47 **
Úe_hÙ_’code
(*
a
, 
n
, 
k
);

48 
£c
(
şock_t
 
şocks
);

49 
´št_¡©i¡ics
(*
a
, 
n
);

50 
št_šdex
(*
a
, 
v®
, 
n
);

	@yolo_layer.c

1 
	~"yŞo_Ïy”.h
"

2 
	~"aùiv©iÚs.h
"

3 
	~"bÏs.h
"

4 
	~"box.h
"

5 
	~"cuda.h
"

6 
	~"uts.h
"

8 
	~<¡dio.h
>

9 
	~<as£¹.h
>

10 
	~<¡ršg.h
>

11 
	~<¡dlib.h
>

13 
Ïy”
 
	$make_yŞo_Ïy”
(
b©ch
, 
w
, 
h
, 
n
, 
tÙ®
, *
mask
, 
şas£s
)

15 
i
;

16 
Ïy”
 
l
 = {0};

17 
l
.
ty³
 = 
YOLO
;

19 
l
.
n
 =‚;

20 
l
.
tÙ®
 =otal;

21 
l
.
b©ch
 = batch;

22 
l
.
h
 = h;

23 
l
.
w
 = w;

24 
l
.
c
 = 
n
*(
şas£s
 + 4 + 1);

25 
l
.
out_w
 =†.
w
;

26 
l
.
out_h
 =†.
h
;

27 
l
.
out_c
 =†.
c
;

28 
l
.
şas£s
 = classes;

29 
l
.
co¡
 = 
	`ÿÎoc
(1, ());

30 
l
.
bŸ£s
 = 
	`ÿÎoc
(
tÙ®
*2, ());

31 if(
mask
è
l
.mask = mask;

33 
l
.
mask
 = 
	`ÿÎoc
(
n
, ());

34 
i
 = 0; i < 
n
; ++i){

35 
l
.
mask
[
i
] = i;

38 
l
.
bŸs_upd©es
 = 
	`ÿÎoc
(
n
*2, ());

39 
l
.
ouuts
 = 
h
*
w
*
n
*(
şas£s
 + 4 + 1);

40 
l
.
šputs
 =†.
ouuts
;

41 
l
.
Œuths
 = 90*(4 + 1);

42 
l
.
d–
 = 
	`ÿÎoc
(
b©ch
*l.
ouuts
, ());

43 
l
.
ouut
 = 
	`ÿÎoc
(
b©ch
*l.
ouuts
, ());

44 
i
 = 0; i < 
tÙ®
*2; ++i){

45 
l
.
bŸ£s
[
i
] = .5;

48 
l
.
fÜw¬d
 = 
fÜw¬d_yŞo_Ïy”
;

49 
l
.
backw¬d
 = 
backw¬d_yŞo_Ïy”
;

50 #ifdeà
GPU


51 
l
.
fÜw¬d_gpu
 = 
fÜw¬d_yŞo_Ïy”_gpu
;

52 
l
.
backw¬d_gpu
 = 
backw¬d_yŞo_Ïy”_gpu
;

53 
l
.
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö.
ouut
, 
b©ch
*l.
ouuts
);

54 
l
.
d–_gpu
 = 
	`cuda_make_¬¿y
Ö.
d–
, 
b©ch
*l.
ouuts
);

57 
	`årštf
(
¡d”r
, "yolo\n");

58 
	`¤ªd
(0);

60  
l
;

61 
	}
}

63 
	$»size_yŞo_Ïy”
(
Ïy”
 *
l
, 
w
, 
h
)

65 
l
->
w
 = w;

66 
l
->
h
 = h;

68 
l
->
ouuts
 = 
h
*
w
*l->
n
*Ö->
şas£s
 + 4 + 1);

69 
l
->
šputs
 =†->
ouuts
;

71 
l
->
ouut
 = 
	`»®loc
Ö->ouut,†->
b©ch
*l->
ouuts
*());

72 
l
->
d–
 = 
	`»®loc
Ö->d–,†->
b©ch
*l->
ouuts
*());

74 #ifdeà
GPU


75 
	`cuda_ä“
(
l
->
d–_gpu
);

76 
	`cuda_ä“
(
l
->
ouut_gpu
);

78 
l
->
d–_gpu
 = 
	`cuda_make_¬¿y
Ö->
d–
,†->
b©ch
*l->
ouuts
);

79 
l
->
ouut_gpu
 = 
	`cuda_make_¬¿y
Ö->
ouut
,†->
b©ch
*l->
ouuts
);

81 
	}
}

83 
box
 
	$g‘_yŞo_box
(*
x
, *
bŸ£s
, 
n
, 
šdex
, 
i
, 
j
, 
lw
, 
lh
, 
w
, 
h
, 
¡ride
)

85 
box
 
b
;

86 
b
.
x
 = (
i
 + x[
šdex
 + 0*
¡ride
]è/ 
lw
;

87 
b
.
y
 = (
j
 + 
x
[
šdex
 + 1*
¡ride
]è/ 
lh
;

88 
b
.
w
 = 
	`exp
(
x
[
šdex
 + 2*
¡ride
]è* 
bŸ£s
[2*
n
] / w;

89 
b
.
h
 = 
	`exp
(
x
[
šdex
 + 3*
¡ride
]è* 
bŸ£s
[2*
n
+1] / h;

90  
b
;

91 
	}
}

93 
	$d–_yŞo_box
(
box
 
Œuth
, *
x
, *
bŸ£s
, 
n
, 
šdex
, 
i
, 
j
, 
lw
, 
lh
, 
w
, 
h
, *
d–
, 
sÿË
, 
¡ride
)

95 
box
 
´ed
 = 
	`g‘_yŞo_box
(
x
, 
bŸ£s
, 
n
, 
šdex
, 
i
, 
j
, 
lw
, 
lh
, 
w
, 
h
, 
¡ride
);

96 
iou
 = 
	`box_iou
(
´ed
, 
Œuth
);

98 
tx
 = (
Œuth
.
x
*
lw
 - 
i
);

99 
ty
 = (
Œuth
.
y
*
lh
 - 
j
);

100 
tw
 = 
	`log
(
Œuth
.
w
*w / 
bŸ£s
[2*
n
]);

101 
th
 = 
	`log
(
Œuth
.
h
*h / 
bŸ£s
[2*
n
 + 1]);

103 
d–
[
šdex
 + 0*
¡ride
] = 
sÿË
 * (
tx
 - 
x
[index + 0*stride]);

104 
d–
[
šdex
 + 1*
¡ride
] = 
sÿË
 * (
ty
 - 
x
[index + 1*stride]);

105 
d–
[
šdex
 + 2*
¡ride
] = 
sÿË
 * (
tw
 - 
x
[index + 2*stride]);

106 
d–
[
šdex
 + 3*
¡ride
] = 
sÿË
 * (
th
 - 
x
[index + 3*stride]);

107  
iou
;

108 
	}
}

111 
	$d–_yŞo_şass
(*
ouut
, *
d–
, 
šdex
, 
şass
, 
şas£s
, 
¡ride
, *
avg_ÿt
)

113 
n
;

114 ià(
d–
[
šdex
]){

115 
d–
[
šdex
 + 
¡ride
*
şass
] = 1 - 
ouut
[index + stride*class];

116 if(
avg_ÿt
è*avg_ÿˆ+ğ
ouut
[
šdex
 + 
¡ride
*
şass
];

119 
n
 = 0;‚ < 
şas£s
; ++n){

120 
d–
[
šdex
 + 
¡ride
*
n
] = (Ò =ğ
şass
)?1 : 0è- 
ouut
[index + stride*n];

121 if(
n
 =ğ
şass
 && 
avg_ÿt
è*avg_ÿˆ+ğ
ouut
[
šdex
 + 
¡ride
*n];

123 
	}
}

125 
	$’Œy_šdex
(
Ïy”
 
l
, 
b©ch
, 
loÿtiÚ
, 
’Œy
)

127 
n
 = 
loÿtiÚ
 / (
l
.
w
*l.
h
);

128 
loc
 = 
loÿtiÚ
 % (
l
.
w
*l.
h
);

129  
b©ch
*
l
.
ouuts
 + 
n
*l.
w
*l.
h
*(4+l.
şas£s
+1è+ 
’Œy
*l.w*l.h + 
loc
;

130 
	}
}

132 
	$fÜw¬d_yŞo_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

134 
i
,
j
,
b
,
t
,
n
;

135 
	`memıy
(
l
.
ouut
, 
Ãt
.
šput
,†.
ouuts
*l.
b©ch
*());

137 #iâdeà
GPU


138 
b
 = 0; b < 
l
.
b©ch
; ++b){

139 
n
 = 0;‚ < 
l
.n; ++n){

140 
šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
, 0);

141 
	`aùiv©e_¬¿y
(
l
.
ouut
 + 
šdex
, 2*l.
w
*l.
h
, 
LOGISTIC
);

142 
šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
, 4);

143 
	`aùiv©e_¬¿y
(
l
.
ouut
 + 
šdex
, (1+l.
şas£s
)*l.
w
*l.
h
, 
LOGISTIC
);

148 
	`mem£t
(
l
.
d–
, 0,†.
ouuts
 *†.
b©ch
 * ());

149 if(!
Ãt
.
Œaš
) ;

150 
avg_iou
 = 0;

151 
»ÿÎ
 = 0;

152 
»ÿÎ75
 = 0;

153 
avg_ÿt
 = 0;

154 
avg_obj
 = 0;

155 
avg_ªyobj
 = 0;

156 
couÁ
 = 0;

157 
şass_couÁ
 = 0;

158 *(
l
.
co¡
) = 0;

159 
b
 = 0; b < 
l
.
b©ch
; ++b) {

160 
j
 = 0; j < 
l
.
h
; ++j) {

161 
i
 = 0; i < 
l
.
w
; ++i) {

162 
n
 = 0;‚ < 
l
.n; ++n) {

163 
box_šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
 + 
j
*l.w + 
i
, 0);

164 
box
 
´ed
 = 
	`g‘_yŞo_box
(
l
.
ouut
,†.
bŸ£s
,†.
mask
[
n
], 
box_šdex
, 
i
, 
j
,†.
w
,†.
h
, 
Ãt
.w,‚et.h,†.w*l.h);

165 
be¡_iou
 = 0;

166 
be¡_t
 = 0;

167 
t
 = 0; < 
l
.
max_boxes
; ++t){

168 
box
 
Œuth
 = 
	`æßt_to_box
(
Ãt
.Œuth + 
t
*(4 + 1è+ 
b
*
l
.
Œuths
, 1);

169 if(!
Œuth
.
x
) ;

170 
iou
 = 
	`box_iou
(
´ed
, 
Œuth
);

171 ià(
iou
 > 
be¡_iou
) {

172 
be¡_iou
 = 
iou
;

173 
be¡_t
 = 
t
;

176 
obj_šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
 + 
j
*l.w + 
i
, 4);

177 
avg_ªyobj
 +ğ
l
.
ouut
[
obj_šdex
];

178 
l
.
d–
[
obj_šdex
] = 0 -†.
ouut
[obj_index];

179 ià(
be¡_iou
 > 
l
.
ignÜe_th»sh
) {

180 
l
.
d–
[
obj_šdex
] = 0;

182 ià(
be¡_iou
 > 
l
.
Œuth_th»sh
) {

183 
l
.
d–
[
obj_šdex
] = 1 -†.
ouut
[obj_index];

185 
şass
 = 
Ãt
.
Œuth
[
be¡_t
*(4 + 1è+ 
b
*
l
.
Œuths
 + 4];

186 ià(
l
.
m­
è
şass
 =†.map[class];

187 
şass_šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
 + 
j
*l.w + 
i
, 4 + 1);

188 
	`d–_yŞo_şass
(
l
.
ouut
,†.
d–
, 
şass_šdex
, 
şass
,†.
şas£s
,†.
w
*l.
h
, 0);

189 
box
 
Œuth
 = 
	`æßt_to_box
(
Ãt
.Œuth + 
be¡_t
*(4 + 1è+ 
b
*
l
.
Œuths
, 1);

190 
	`d–_yŞo_box
(
Œuth
, 
l
.
ouut
,†.
bŸ£s
,†.
mask
[
n
], 
box_šdex
, 
i
, 
j
,†.
w
,†.
h
, 
Ãt
.w,‚‘.h,†.
d–
, (2-truth.w*truth.h),†.w*l.h);

195 
t
 = 0; < 
l
.
max_boxes
; ++t){

196 
box
 
Œuth
 = 
	`æßt_to_box
(
Ãt
.Œuth + 
t
*(4 + 1è+ 
b
*
l
.
Œuths
, 1);

198 if(!
Œuth
.
x
) ;

199 
be¡_iou
 = 0;

200 
be¡_n
 = 0;

201 
i
 = (
Œuth
.
x
 * 
l
.
w
);

202 
j
 = (
Œuth
.
y
 * 
l
.
h
);

203 
box
 
Œuth_shiá
 = 
Œuth
;

204 
Œuth_shiá
.
x
 =ruth_shiá.
y
 = 0;

205 
n
 = 0;‚ < 
l
.
tÙ®
; ++n){

206 
box
 
´ed
 = {0};

207 
´ed
.
w
 = 
l
.
bŸ£s
[2*
n
]/
Ãt
.w;

208 
´ed
.
h
 = 
l
.
bŸ£s
[2*
n
+1]/
Ãt
.h;

209 
iou
 = 
	`box_iou
(
´ed
, 
Œuth_shiá
);

210 ià(
iou
 > 
be¡_iou
){

211 
be¡_iou
 = 
iou
;

212 
be¡_n
 = 
n
;

216 
mask_n
 = 
	`št_šdex
(
l
.
mask
, 
be¡_n
,†.
n
);

217 if(
mask_n
 >= 0){

218 
box_šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
mask_n
*l.
w
*l.
h
 + 
j
*l.w + 
i
, 0);

219 
iou
 = 
	`d–_yŞo_box
(
Œuth
, 
l
.
ouut
,†.
bŸ£s
, 
be¡_n
, 
box_šdex
, 
i
, 
j
,†.
w
,†.
h
, 
Ãt
.w,‚‘.h,†.
d–
, (2-truth.w*truth.h),†.w*l.h);

221 
obj_šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
mask_n
*l.
w
*l.
h
 + 
j
*l.w + 
i
, 4);

222 
avg_obj
 +ğ
l
.
ouut
[
obj_šdex
];

223 
l
.
d–
[
obj_šdex
] = 1 -†.
ouut
[obj_index];

225 
şass
 = 
Ãt
.
Œuth
[
t
*(4 + 1è+ 
b
*
l
.
Œuths
 + 4];

226 ià(
l
.
m­
è
şass
 =†.map[class];

227 
şass_šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
mask_n
*l.
w
*l.
h
 + 
j
*l.w + 
i
, 4 + 1);

228 
	`d–_yŞo_şass
(
l
.
ouut
,†.
d–
, 
şass_šdex
, 
şass
,†.
şas£s
,†.
w
*l.
h
, &
avg_ÿt
);

230 ++
couÁ
;

231 ++
şass_couÁ
;

232 if(
iou
 > .5è
»ÿÎ
 += 1;

233 if(
iou
 > .75è
»ÿÎ75
 += 1;

234 
avg_iou
 +ğ
iou
;

238 *(
l
.
co¡
èğ
	`pow
(
	`mag_¬¿y
Ö.
d–
,†.
ouuts
 *†.
b©ch
), 2);

239 
	`´štf
("RegiÚ %d Avg IOU: %f, CÏss: %f, Obj: %f, NØObj: %f, .5R: %f, .75R: %f, couÁ: %d\n", 
Ãt
.
šdex
, 
avg_iou
/
couÁ
, 
avg_ÿt
/
şass_couÁ
, 
avg_obj
/couÁ, 
avg_ªyobj
/(
l
.
w
*l.
h
*l.
n
*l.
b©ch
), 
»ÿÎ
/couÁ, 
»ÿÎ75
/count, count);

240 
	}
}

242 
	$backw¬d_yŞo_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

244 
	`axpy_ıu
(
l
.
b©ch
*l.
šputs
, 1,†.
d–
, 1, 
Ãt
.delta, 1);

245 
	}
}

247 
	$cÜ»ù_yŞo_boxes
(
d‘eùiÚ
 *
d‘s
, 
n
, 
w
, 
h
, 
Ãtw
, 
Ãth
, 
»Ïtive
)

249 
i
;

250 
Ãw_w
=0;

251 
Ãw_h
=0;

252 ià((()
Ãtw
/
w
è< (()
Ãth
/
h
)) {

253 
Ãw_w
 = 
Ãtw
;

254 
Ãw_h
 = (
h
 * 
Ãtw
)/
w
;

256 
Ãw_h
 = 
Ãth
;

257 
Ãw_w
 = (
w
 * 
Ãth
)/
h
;

259 
i
 = 0; i < 
n
; ++i){

260 
box
 
b
 = 
d‘s
[
i
].
bbox
;

261 
b
.
x
 = (b.x - (
Ãtw
 - 
Ãw_w
)/2./netw) / (()new_w/netw);

262 
b
.
y
 = (b.y - (
Ãth
 - 
Ãw_h
)/2./neth) / (()new_h/neth);

263 
b
.
w
 *ğ()
Ãtw
/
Ãw_w
;

264 
b
.
h
 *ğ()
Ãth
/
Ãw_h
;

265 if(!
»Ïtive
){

266 
b
.
x
 *ğ
w
;

267 
b
.
w
 *= w;

268 
b
.
y
 *ğ
h
;

269 
b
.
h
 *= h;

271 
d‘s
[
i
].
bbox
 = 
b
;

273 
	}
}

275 
	$yŞo_num_d‘eùiÚs
(
Ïy”
 
l
, 
th»sh
)

277 
i
, 
n
;

278 
couÁ
 = 0;

279 
i
 = 0; i < 
l
.
w
*l.
h
; ++i){

280 
n
 = 0;‚ < 
l
.n; ++n){

281 
obj_šdex
 = 
	`’Œy_šdex
(
l
, 0, 
n
*l.
w
*l.
h
 + 
i
, 4);

282 if(
l
.
ouut
[
obj_šdex
] > 
th»sh
){

283 ++
couÁ
;

287  
couÁ
;

288 
	}
}

290 
	$avg_æ³d_yŞo
(
Ïy”
 
l
)

292 
i
,
j
,
n
,
z
;

293 *
æ
 = 
l
.
ouut
 +†.
ouuts
;

294 
j
 = 0; j < 
l
.
h
; ++j) {

295 
i
 = 0; i < 
l
.
w
/2; ++i) {

296 
n
 = 0;‚ < 
l
.n; ++n) {

297 
z
 = 0; z < 
l
.
şas£s
 + 4 + 1; ++z){

298 
i1
 = 
z
*
l
.
w
*l.
h
*l.
n
 +‚*l.w*l.h + 
j
*l.w + 
i
;

299 
i2
 = 
z
*
l
.
w
*l.
h
*l.
n
 +‚*l.w*l.h + 
j
*l.w + (l.w - 
i
 - 1);

300 
sw­
 = 
æ
[
i1
];

301 
æ
[
i1
] = fl[
i2
];

302 
æ
[
i2
] = 
sw­
;

303 if(
z
 == 0){

304 
æ
[
i1
] = -flip[i1];

305 
æ
[
i2
] = -flip[i2];

311 
i
 = 0; i < 
l
.
ouuts
; ++i){

312 
l
.
ouut
[
i
] = (l.ouut[i] + 
æ
[i])/2.;

314 
	}
}

316 
	$g‘_yŞo_d‘eùiÚs
(
Ïy”
 
l
, 
w
, 
h
, 
Ãtw
, 
Ãth
, 
th»sh
, *
m­
, 
»Ïtive
, 
d‘eùiÚ
 *
d‘s
)

318 
i
,
j
,
n
;

319 *
´ediùiÚs
 = 
l
.
ouut
;

320 ià(
l
.
b©ch
 =ğ2è
	`avg_æ³d_yŞo
(l);

321 
couÁ
 = 0;

322 
i
 = 0; i < 
l
.
w
*l.
h
; ++i){

323 
row
 = 
i
 / 
l
.
w
;

324 
cŞ
 = 
i
 % 
l
.
w
;

325 
n
 = 0;‚ < 
l
.n; ++n){

326 
obj_šdex
 = 
	`’Œy_šdex
(
l
, 0, 
n
*l.
w
*l.
h
 + 
i
, 4);

327 
objeùÃss
 = 
´ediùiÚs
[
obj_šdex
];

328 if(
objeùÃss
 <ğ
th»sh
) ;

329 
box_šdex
 = 
	`’Œy_šdex
(
l
, 0, 
n
*l.
w
*l.
h
 + 
i
, 0);

330 
d‘s
[
couÁ
].
bbox
 = 
	`g‘_yŞo_box
(
´ediùiÚs
, 
l
.
bŸ£s
,†.
mask
[
n
], 
box_šdex
, 
cŞ
, 
row
,†.
w
,†.
h
, 
Ãtw
, 
Ãth
,†.w*l.h);

331 
d‘s
[
couÁ
].
objeùÃss
 = objectness;

332 
d‘s
[
couÁ
].
şas£s
 = 
l
.classes;

333 
j
 = 0; j < 
l
.
şas£s
; ++j){

334 
şass_šdex
 = 
	`’Œy_šdex
(
l
, 0, 
n
*l.
w
*l.
h
 + 
i
, 4 + 1 + 
j
);

335 
´ob
 = 
objeùÃss
*
´ediùiÚs
[
şass_šdex
];

336 
d‘s
[
couÁ
].
´ob
[
j
] = (´ob > 
th»sh
) ?…rob : 0;

338 ++
couÁ
;

341 
	`cÜ»ù_yŞo_boxes
(
d‘s
, 
couÁ
, 
w
, 
h
, 
Ãtw
, 
Ãth
, 
»Ïtive
);

342  
couÁ
;

343 
	}
}

345 #ifdeà
GPU


347 
	$fÜw¬d_yŞo_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

349 
	`cİy_gpu
(
l
.
b©ch
*l.
šputs
, 
Ãt
.
šput_gpu
, 1,†.
ouut_gpu
, 1);

350 
b
, 
n
;

351 
b
 = 0; b < 
l
.
b©ch
; ++b){

352 
n
 = 0;‚ < 
l
.n; ++n){

353 
šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
, 0);

354 
	`aùiv©e_¬¿y_gpu
(
l
.
ouut_gpu
 + 
šdex
, 2*l.
w
*l.
h
, 
LOGISTIC
);

355 
šdex
 = 
	`’Œy_šdex
(
l
, 
b
, 
n
*l.
w
*l.
h
, 4);

356 
	`aùiv©e_¬¿y_gpu
(
l
.
ouut_gpu
 + 
šdex
, (1+l.
şas£s
)*l.
w
*l.
h
, 
LOGISTIC
);

359 if(!
Ãt
.
Œaš
 || 
l
.
ÚlyfÜw¬d
){

360 
	`cuda_puÎ_¬¿y
(
l
.
ouut_gpu
,†.
ouut
,†.
b©ch
*l.
ouuts
);

364 
	`cuda_puÎ_¬¿y
(
l
.
ouut_gpu
, 
Ãt
.
šput
,†.
b©ch
*l.
šputs
);

365 
	`fÜw¬d_yŞo_Ïy”
(
l
, 
Ãt
);

366 
	`cuda_push_¬¿y
(
l
.
d–_gpu
,†.
d–
,†.
b©ch
*l.
ouuts
);

367 
	}
}

369 
	$backw¬d_yŞo_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
)

371 
	`axpy_gpu
(
l
.
b©ch
*l.
šputs
, 1,†.
d–_gpu
, 1, 
Ãt
.delta_gpu, 1);

372 
	}
}

	@yolo_layer.h

1 #iâdeà
YOLO_LAYER_H


2 
	#YOLO_LAYER_H


	)

4 
	~"d¬kÃt.h
"

5 
	~"Ïy”.h
"

6 
	~"ÃtwÜk.h
"

8 
Ïy”
 
make_yŞo_Ïy”
(
b©ch
, 
w
, 
h
, 
n
, 
tÙ®
, *
mask
, 
şas£s
);

9 
fÜw¬d_yŞo_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

10 
backw¬d_yŞo_Ïy”
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

11 
»size_yŞo_Ïy”
(
Ïy”
 *
l
, 
w
, 
h
);

12 
yŞo_num_d‘eùiÚs
(
Ïy”
 
l
, 
th»sh
);

14 #ifdeà
GPU


15 
fÜw¬d_yŞo_Ïy”_gpu
(cÚ¡ 
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

16 
backw¬d_yŞo_Ïy”_gpu
(
Ïy”
 
l
, 
ÃtwÜk
 
Ãt
);

	@/usr/include/assert.h

22 #ifdef 
_ASSERT_H


24 #undeà
_ASSERT_H


25 #undeà
as£¹


26 #undeà
__ASSERT_VOID_CAST


28 #ifdef 
__USE_GNU


29 #undeà
as£¹_³¼Ü


34 
	#_ASSERT_H
 1

	)

35 
	~<ã©u»s.h
>

37 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,95)

38 
	#__ASSERT_VOID_CAST
 
¡©ic_ÿ¡
<>

	)

40 
	#__ASSERT_VOID_CAST
 ()

	)

48 #ifdef 
NDEBUG


50 
	#as£¹
(
ex´
è(
	`__ASSERT_VOID_CAST
 (0))

	)

58 #ifdef 
__USE_GNU


59 
	#as£¹_³¼Ü
(
”ºum
è(
	`__ASSERT_VOID_CAST
 (0))

	)

64 #iâdeà
_ASSERT_H_DECLS


65 
	#_ASSERT_H_DECLS


	)

66 
__BEGIN_DECLS


69 
	$__as£¹_ç
 (cÚ¡ *
__as£¹iÚ
, cÚ¡ *
__fe
,

70 
__lše
, cÚ¡ *
__funùiÚ
)

71 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

74 
	$__as£¹_³¼Ü_ç
 (
__”ºum
, cÚ¡ *
__fe
,

75 
__lše
, cÚ¡ *
__funùiÚ
)

76 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

81 
	$__as£¹
 (cÚ¡ *
__as£¹iÚ
, cÚ¡ *
__fe
, 
__lše
)

82 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

85 
__END_DECLS


88 
	#as£¹
(
ex´
) \

89 ((
ex´
) \

90 ? 
	`__ASSERT_VOID_CAST
 (0) \

91 : 
	`__as£¹_ç
 (#ex´, 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

93 #ifdef 
__USE_GNU


94 
	#as£¹_³¼Ü
(
”ºum
) \

95 (!(
”ºum
) \

96 ? 
	`__ASSERT_VOID_CAST
 (0) \

97 : 
	`__as£¹_³¼Ü_ç
 ((
”ºum
), 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

105 #ià
defšed
 
__ılu¥lus
 ? 
	`__GNUC_PREREQ
 (2, 6) : __GNUC_PREREQ (2, 4)

106 
	#__ASSERT_FUNCTION
 
__PRETTY_FUNCTION__


	)

108 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

109 
	#__ASSERT_FUNCTION
 
__func__


	)

111 
	#__ASSERT_FUNCTION
 ((cÚ¡ *è0)

	)

118 #ià
defšed
 
__USE_ISOC11
 && !defšed 
__ılu¥lus


119 #undeà
¡©ic_as£¹


120 
	#¡©ic_as£¹
 
_Stic_as£¹


	)

	@/usr/include/limits.h

22 #iâdeà
_LIBC_LIMITS_H_


23 
	#_LIBC_LIMITS_H_
 1

	)

25 
	~<ã©u»s.h
>

31 
	#MB_LEN_MAX
 16

	)

36 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2

41 #iâdeà
_LIMITS_H


42 
	#_LIMITS_H
 1

	)

44 
	~<b™s/wÜdsize.h
>

53 
	#CHAR_BIT
 8

	)

56 
	#SCHAR_MIN
 (-128)

	)

57 
	#SCHAR_MAX
 127

	)

60 
	#UCHAR_MAX
 255

	)

63 #ifdeà
__CHAR_UNSIGNED__


64 
	#CHAR_MIN
 0

	)

65 
	#CHAR_MAX
 
UCHAR_MAX


	)

67 
	#CHAR_MIN
 
SCHAR_MIN


	)

68 
	#CHAR_MAX
 
SCHAR_MAX


	)

72 
	#SHRT_MIN
 (-32768)

	)

73 
	#SHRT_MAX
 32767

	)

76 
	#USHRT_MAX
 65535

	)

79 
	#INT_MIN
 (-
INT_MAX
 - 1)

	)

80 
	#INT_MAX
 2147483647

	)

83 
	#UINT_MAX
 4294967295U

	)

86 #ià
__WORDSIZE
 == 64

87 
	#LONG_MAX
 9223372036854775807L

	)

89 
	#LONG_MAX
 2147483647L

	)

91 
	#LONG_MIN
 (-
LONG_MAX
 - 1L)

	)

94 #ià
__WORDSIZE
 == 64

95 
	#ULONG_MAX
 18446744073709551615UL

	)

97 
	#ULONG_MAX
 4294967295UL

	)

100 #ifdeà
__USE_ISOC99


103 
	#LLONG_MAX
 9223372036854775807LL

	)

104 
	#LLONG_MIN
 (-
LLONG_MAX
 - 1LL)

	)

107 
	#ULLONG_MAX
 18446744073709551615ULL

	)

121 #ià
defšed
 
__GNUC__
 && !defšed 
_GCC_LIMITS_H_


123 #šşude_Ãxˆ<
lim™s
.
h
>

129 #ià
defšed
 
__USE_ISOC99
 && defšed 
__GNUC__


130 #iâdeà
LLONG_MIN


131 
	#LLONG_MIN
 (-
LLONG_MAX
-1)

	)

133 #iâdeà
LLONG_MAX


134 
	#LLONG_MAX
 
__LONG_LONG_MAX__


	)

136 #iâdeà
ULLONG_MAX


137 
	#ULLONG_MAX
 (
LLONG_MAX
 * 2ULL + 1)

	)

141 #ifdef 
__USE_POSIX


143 
	~<b™s/posix1_lim.h
>

146 #ifdef 
__USE_POSIX2


147 
	~<b™s/posix2_lim.h
>

150 #ifdef 
__USE_XOPEN


151 
	~<b™s/xİ’_lim.h
>

	@/usr/include/math.h

23 #iâdef 
_MATH_H


24 
	#_MATH_H
 1

	)

26 
	~<ã©u»s.h
>

28 
	g__BEGIN_DECLS


31 
	~<b™s/m©h-veùÜ.h
>

35 
	~<b™s/huge_v®.h
>

36 #ifdeà
__USE_ISOC99


37 
	~<b™s/huge_v®f.h
>

38 
	~<b™s/huge_v®l.h
>

41 
	~<b™s/šf.h
>

44 
	~<b™s/Çn.h
>

48 
	~<b™s/m©hdef.h
>

55 
	#__SIMD_DECL
(
funùiÚ
è
	`__CONCAT
 (
__DECL_SIMD_
, funùiÚ)

	)

57 
	#__MATHCALL_VEC
(
funùiÚ
, 
suffix
, 
¬gs
) \

58 
	`__SIMD_DECL
 (
	`__MATH_PRECNAME
 (
funùiÚ
, 
suffix
)) \

59 
	`__MATHCALL
 (
funùiÚ
, 
suffix
, 
¬gs
)

	)

61 
	#__MATHDECL_VEC
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

62 
	`__SIMD_DECL
 (
	`__MATH_PRECNAME
 (
funùiÚ
, 
suffix
)) \

63 
	`__MATHDECL
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
)

	)

65 
	#__MATHCALL
(
funùiÚ
,
suffix
, 
¬gs
) \

66 
	`__MATHDECL
 (
_MdoubË_
,
funùiÚ
,
suffix
, 
¬gs
)

	)

67 
	#__MATHDECL
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

68 
	`__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
); \

69 
	`__MATHDECL_1
(
ty³
, 
	`__CONCAT
(
__
,
funùiÚ
),
suffix
, 
¬gs
)

	)

70 
	#__MATHCALLX
(
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
) \

71 
	`__MATHDECLX
 (
_MdoubË_
,
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
)

	)

72 
	#__MATHDECLX
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
) \

73 
	`__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
è
	`__©Œibu‹__
 (
©Œib
); \

74 
	`__MATHDECL_1
(
ty³
, 
	`__CONCAT
(
__
,
funùiÚ
),
suffix
, 
¬gs
è
	`__©Œibu‹__
 (
©Œib
)

	)

75 
	#__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

76 
ty³
 
	`__MATH_PRECNAME
(
funùiÚ
,
suffix
è
¬gs
 
__THROW


	)

78 
	#_MdoubË_
 

	)

79 
	#__MATH_PRECNAME
(
Çme
,
r
è
	`__CONCAT
Òame,r)

	)

80 
	#__MATH_DECLARING_DOUBLE
 1

	)

81 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_STD


	)

82 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_STD


	)

83 
	~<b™s/m©hÿÎs.h
>

84 #undeà
_MdoubË_


85 #undeà
_MdoubË_BEGIN_NAMESPACE


86 #undeà
_MdoubË_END_NAMESPACE


87 #undeà
__MATH_PRECNAME


88 #undeà
__MATH_DECLARING_DOUBLE


90 #ifdeà
__USE_ISOC99


96 #iâdeà
_Mæßt_


97 
	#_Mæßt_
 

	)

99 
	#_MdoubË_
 
_Mæßt_


	)

100 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
f
##
	)
r

101 
	#__MATH_DECLARING_DOUBLE
 0

	)

102 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_C99


	)

103 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_C99


	)

104 
	~<b™s/m©hÿÎs.h
>

105 #undeà
_MdoubË_


106 #undeà
_MdoubË_BEGIN_NAMESPACE


107 #undeà
_MdoubË_END_NAMESPACE


108 #undeà
__MATH_PRECNAME


109 #undeà
__MATH_DECLARING_DOUBLE


111 #ià!(
defšed
 
__NO_LONG_DOUBLE_MATH
 && defšed 
_LIBC
) \

112 || 
defšed
 
__LDBL_COMPAT
 \

113 || 
defšed
 
_LIBC_TEST


114 #ifdeà
__LDBL_COMPAT


116 #ifdeà
__USE_ISOC99


117 
	$__Ædbl_Ãx‰ow¬df
 (
__x
, 
__y
)

118 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

119 #ifdeà
__REDIRECT_NTH


120 
	`__REDIRECT_NTH
 (
Ãx‰ow¬df
, (
__x
, 
__y
),

121 
__Ædbl_Ãx‰ow¬df
)

122 
	`__©Œibu‹__
 ((
__cÚ¡__
));

123 
	`__REDIRECT_NTH
 (
Ãx‰ow¬d
, (
__x
, 
__y
),

124 
Ãxá”
è
	`__©Œibu‹__
 ((
__cÚ¡__
));

125 
	`__REDIRECT_NTH
 (
Ãx‰ow¬dl
,

126 (
__x
, 
__y
),

127 
Ãxá”
è
	`__©Œibu‹__
 ((
__cÚ¡__
));

131 #undeà
__MATHDECL_1


132 
	#__MATHDECL_2
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
®Ÿs
) \

133 
ty³
 
	`__REDIRECT_NTH
(
	`__MATH_PRECNAME
(
funùiÚ
,
suffix
), \

134 
¬gs
, 
®Ÿs
)

	)

135 
	#__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

136 
	`__MATHDECL_2
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
	`__CONCAT
(funùiÚ,suffix))

	)

142 #iâdeà
_MlÚg_doubË_


143 
	#_MlÚg_doubË_
 

	)

145 
	#_MdoubË_
 
_MlÚg_doubË_


	)

146 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
l
##
	)
r

147 
	#__MATH_DECLARING_DOUBLE
 0

	)

148 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_C99


	)

149 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_C99


	)

150 
	#__MATH_DECLARE_LDOUBLE
 1

	)

151 
	~<b™s/m©hÿÎs.h
>

152 #undeà
_MdoubË_


153 #undeà
_MdoubË_BEGIN_NAMESPACE


154 #undeà
_MdoubË_END_NAMESPACE


155 #undeà
__MATH_PRECNAME


156 #undeà
__MATH_DECLARING_DOUBLE


161 #undeà
__MATHDECL_1


162 #undeà
__MATHDECL


163 #undeà
__MATHCALL


166 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


168 
signgam
;

173 #ifdeà
__USE_ISOC99


211 
FP_NAN
 =

212 
	#FP_NAN
 0

	)

213 
FP_NAN
,

214 
FP_INFINITE
 =

215 
	#FP_INFINITE
 1

	)

216 
FP_INFINITE
,

217 
FP_ZERO
 =

218 
	#FP_ZERO
 2

	)

219 
FP_ZERO
,

220 
FP_SUBNORMAL
 =

221 
	#FP_SUBNORMAL
 3

	)

222 
FP_SUBNORMAL
,

223 
FP_NORMAL
 =

224 
	#FP_NORMAL
 4

	)

225 
FP_NORMAL


233 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__
 \

234 && !
defšed
 
__OPTIMIZE_SIZE__


235 
	#åşassify
(
x
è
	`__butš_åşassify
 (
FP_NAN
, 
FP_INFINITE
, \

236 
FP_NORMAL
, 
FP_SUBNORMAL
, 
FP_ZERO
, 
x
)

	)

237 #–ià
defšed
 
__NO_LONG_DOUBLE_MATH


238 
	#åşassify
(
x
) \

239 ( (
x
è=ğ (è? 
	`__åşassifyf
 (xè: 
	`__åşassify
 (x))

	)

241 
	#åşassify
(
x
) \

242 ( (
x
) ==  () \

243 ? 
	`__åşassifyf
 (
x
) \

244 :  (
x
) ==  () \

245 ? 
	`__åşassify
 (
x
è: 
	`__åşassifyl
 (x))

	)

249 #ià
	`__GNUC_PREREQ
 (4,0)

250 
	#signb™
(
x
) \

251 ( (
x
) ==  () \

252 ? 
	`__butš_signb™f
 (
x
) \

253 :  (
x
) ==  () \

254 ? 
	`__butš_signb™
 (
x
è: 
	`__butš_signb™l
 (x))

	)

256 #ifdeà
__NO_LONG_DOUBLE_MATH


257 
	#signb™
(
x
) \

258 ( (
x
è=ğ (è? 
	`__signb™f
 (xè: 
	`__signb™
 (x))

	)

260 
	#signb™
(
x
) \

261 ( (
x
) ==  () \

262 ? 
	`__signb™f
 (
x
) \

263 :  (
x
) ==  () \

264 ? 
	`__signb™
 (
x
è: 
	`__signb™l
 (x))

	)

269 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


270 
	#isfš™e
(
x
è
	`__butš_isfš™e
 (x)

	)

271 #–ià
defšed
 
__NO_LONG_DOUBLE_MATH


272 
	#isfš™e
(
x
) \

273 ( (
x
è=ğ (è? 
	`__fš™ef
 (xè: 
	`__fš™e
 (x))

	)

275 
	#isfš™e
(
x
) \

276 ( (
x
) ==  () \

277 ? 
	`__fš™ef
 (
x
) \

278 :  (
x
) ==  () \

279 ? 
	`__fš™e
 (
x
è: 
	`__fš™–
 (x))

	)

283 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


284 
	#i¢Üm®
(
x
è
	`__butš_i¢Üm®
 (x)

	)

286 
	#i¢Üm®
(
x
è(
	`åşassify
 (xè=ğ
FP_NORMAL
)

	)

291 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


292 
	#i¢ª
(
x
è
	`__butš_i¢ª
 (x)

	)

293 #–ià
defšed
 
__NO_LONG_DOUBLE_MATH


294 
	#i¢ª
(
x
) \

295 ( (
x
è=ğ (è? 
	`__i¢ªf
 (xè: 
	`__i¢ª
 (x))

	)

297 
	#i¢ª
(
x
) \

298 ( (
x
) ==  () \

299 ? 
	`__i¢ªf
 (
x
) \

300 :  (
x
) ==  () \

301 ? 
	`__i¢ª
 (
x
è: 
	`__i¢ªl
 (x))

	)

305 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


306 
	#isšf
(
x
è
	`__butš_isšf_sign
 (x)

	)

307 #–ià
defšed
 
__NO_LONG_DOUBLE_MATH


308 
	#isšf
(
x
) \

309 ( (
x
è=ğ (è? 
	`__isšff
 (xè: 
	`__isšf
 (x))

	)

311 
	#isšf
(
x
) \

312 ( (
x
) ==  () \

313 ? 
	`__isšff
 (
x
) \

314 :  (
x
) ==  () \

315 ? 
	`__isšf
 (
x
è: 
	`__isšæ
 (x))

	)

319 
	#MATH_ERRNO
 1

	)

320 
	#MATH_ERREXCEPT
 2

	)

325 #iâdeà
__FAST_MATH__


326 
	#m©h_”rhªdlšg
 (
MATH_ERRNO
 | 
MATH_ERREXCEPT
)

	)

331 #ifdeà
__USE_GNU


333 #ifdeà
__NO_LONG_DOUBLE_MATH


334 
	#issigÇlšg
(
x
) \

335 ( (
x
è=ğ (è? 
	`__issigÇlšgf
 (xè: 
	`__issigÇlšg
 (x))

	)

337 
	#issigÇlšg
(
x
) \

338 ( (
x
) ==  () \

339 ? 
	`__issigÇlšgf
 (
x
) \

340 :  (
x
) ==  () \

341 ? 
	`__issigÇlšg
 (
x
è: 
	`__issigÇlšgl
 (x))

	)

345 #ifdef 
__USE_MISC


349 
_IEEE_
 = -1,

350 
_SVID_
,

351 
_XOPEN_
,

352 
_POSIX_
,

353 
_ISOC_


354 } 
	t_LIB_VERSION_TYPE
;

359 
_LIB_VERSION_TYPE
 
_LIB_VERSION
;

363 #ifdeà
__USE_MISC


369 #ifdeà
__ılu¥lus


370 
__exû±iÚ


372 
exû±iÚ


375 
ty³
;

376 *
Çme
;

377 
¬g1
;

378 
¬g2
;

379 
»tv®
;

380 
	}
};

382 #ifdeà
__ılu¥lus


383 
	$m©h”r
 (
__exû±iÚ
 *
__exc
è
	`throw
 ();

385 
	`m©h”r
 (
exû±iÚ
 *
__exc
);

388 
	#X_TLOSS
 1.41484755040568800000e+16

	)

391 
	#DOMAIN
 1

	)

392 
	#SING
 2

	)

393 
	#OVERFLOW
 3

	)

394 
	#UNDERFLOW
 4

	)

395 
	#TLOSS
 5

	)

396 
	#PLOSS
 6

	)

399 
	#HUGE
 3.40282347e+38F

	)

403 #ifdeà
__USE_XOPEN


405 
	#MAXFLOAT
 3.40282347e+38F

	)

412 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


413 
	#M_E
 2.7182818284590452354

	)

414 
	#M_LOG2E
 1.4426950408889634074

	)

415 
	#M_LOG10E
 0.43429448190325182765

	)

416 
	#M_LN2
 0.69314718055994530942

	)

417 
	#M_LN10
 2.30258509299404568402

	)

418 
	#M_PI
 3.14159265358979323846

	)

419 
	#M_PI_2
 1.57079632679489661923

	)

420 
	#M_PI_4
 0.78539816339744830962

	)

421 
	#M_1_PI
 0.31830988618379067154

	)

422 
	#M_2_PI
 0.63661977236758134308

	)

423 
	#M_2_SQRTPI
 1.12837916709551257390

	)

424 
	#M_SQRT2
 1.41421356237309504880

	)

425 
	#M_SQRT1_2
 0.70710678118654752440

	)

431 #ifdeà
__USE_GNU


432 
	#M_El
 2.718281828459045235360287471352662498L

	)

433 
	#M_LOG2El
 1.442695040888963407359924681001892137L

	)

434 
	#M_LOG10El
 0.434294481903251827651128918916605082L

	)

435 
	#M_LN2l
 0.693147180559945309417232121458176568L

	)

436 
	#M_LN10l
 2.302585092994045684017991454684364208L

	)

437 
	#M_PIl
 3.141592653589793238462643383279502884L

	)

438 
	#M_PI_2l
 1.570796326794896619231321691639751442L

	)

439 
	#M_PI_4l
 0.785398163397448309615660845819875721L

	)

440 
	#M_1_PIl
 0.318309886183790671537767526745028724L

	)

441 
	#M_2_PIl
 0.636619772367581343075535053490057448L

	)

442 
	#M_2_SQRTPIl
 1.128379167095512573896158903121545172L

	)

443 
	#M_SQRT2l
 1.414213562373095048801688724209698079L

	)

444 
	#M_SQRT1_2l
 0.707106781186547524400844362104849039L

	)

451 #ià
defšed
 
__STRICT_ANSI__
 && !defšed 
__NO_MATH_INLINES


452 
	#__NO_MATH_INLINES
 1

	)

455 #ià
defšed
 
__USE_ISOC99
 && 
	`__GNUC_PREREQ
(2,97)

462 
	#isg»©”
(
x
, 
y
è
	`__butš_isg»©”
(x, y)

	)

463 
	#isg»©”equ®
(
x
, 
y
è
	`__butš_isg»©”equ®
(x, y)

	)

464 
	#i¦ess
(
x
, 
y
è
	`__butš_i¦ess
(x, y)

	)

465 
	#i¦es£qu®
(
x
, 
y
è
	`__butš_i¦es£qu®
(x, y)

	)

466 
	#i¦essg»©”
(
x
, 
y
è
	`__butš_i¦essg»©”
(x, y)

	)

467 
	#isunÜd”ed
(
u
, 
v
è
	`__butš_isunÜd”ed
(u, v)

	)

471 #ifdeà
__USE_EXTERN_INLINES


472 
	~<b™s/m©hšlše.h
>

477 #ià
defšed
 
__FINITE_MATH_ONLY__
 && __FINITE_MATH_ONLY__ > 0

478 
	~<b™s/m©h-fš™e.h
>

481 #ifdeà
__USE_ISOC99


485 #iâdeà
isg»©”


486 
	#isg»©”
(
x
, 
y
) \

487 (
__ex‹nsiÚ__
 \

488 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

489 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x > __y; 
	}
}))

	)

493 #iâdeà
isg»©”equ®


494 
	#isg»©”equ®
(
x
, 
y
) \

495 (
__ex‹nsiÚ__
 \

496 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

497 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x >ğ__y; }))

	)

501 #iâdeà
i¦ess


502 
	#i¦ess
(
x
, 
y
) \

503 (
__ex‹nsiÚ__
 \

504 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

505 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x < __y; }))

	)

509 #iâdeà
i¦es£qu®


510 
	#i¦es£qu®
(
x
, 
y
) \

511 (
__ex‹nsiÚ__
 \

512 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

513 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x <ğ__y; }))

	)

517 #iâdeà
i¦essg»©”


518 
	#i¦essg»©”
(
x
, 
y
) \

519 (
__ex‹nsiÚ__
 \

520 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

521 !
	`isunÜd”ed
 (
__x
, 
__y
è&& (__x < __y || __y < __x); }))

	)

525 #iâdeà
isunÜd”ed


526 
	#isunÜd”ed
(
u
, 
v
) \

527 (
__ex‹nsiÚ__
 \

528 ({ 
	`__ty³of__
(
u
è
__u
 = (u); __ty³of__(
v
è
__v
 = (v); \

529 
	`åşassify
 (
__u
è=ğ
FP_NAN
 || fpşassify (
__v
è=ğFP_NAN; }))

	)

534 
	g__END_DECLS


	@/usr/include/pthread.h

18 #iâdeà
_PTHREAD_H


19 
	#_PTHREAD_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<’dŸn.h
>

23 
	~<sched.h
>

24 
	~<time.h
>

26 
	~<b™s/±h»adty³s.h
>

27 
	~<b™s/£tjmp.h
>

28 
	~<b™s/wÜdsize.h
>

34 
	mPTHREAD_CREATE_JOINABLE
,

35 
	#PTHREAD_CREATE_JOINABLE
 
PTHREAD_CREATE_JOINABLE


	)

36 
	mPTHREAD_CREATE_DETACHED


37 
	#PTHREAD_CREATE_DETACHED
 
PTHREAD_CREATE_DETACHED


	)

44 
	mPTHREAD_MUTEX_TIMED_NP
,

45 
	mPTHREAD_MUTEX_RECURSIVE_NP
,

46 
	mPTHREAD_MUTEX_ERRORCHECK_NP
,

47 
	mPTHREAD_MUTEX_ADAPTIVE_NP


48 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


50 
	mPTHREAD_MUTEX_NORMAL
 = 
PTHREAD_MUTEX_TIMED_NP
,

51 
	mPTHREAD_MUTEX_RECURSIVE
 = 
PTHREAD_MUTEX_RECURSIVE_NP
,

52 
	mPTHREAD_MUTEX_ERRORCHECK
 = 
PTHREAD_MUTEX_ERRORCHECK_NP
,

53 
	mPTHREAD_MUTEX_DEFAULT
 = 
PTHREAD_MUTEX_NORMAL


55 #ifdeà
__USE_GNU


57 , 
	mPTHREAD_MUTEX_FAST_NP
 = 
PTHREAD_MUTEX_TIMED_NP


62 #ifdeà
__USE_XOPEN2K


66 
	mPTHREAD_MUTEX_STALLED
,

67 
	mPTHREAD_MUTEX_STALLED_NP
 = 
PTHREAD_MUTEX_STALLED
,

68 
	mPTHREAD_MUTEX_ROBUST
,

69 
	mPTHREAD_MUTEX_ROBUST_NP
 = 
PTHREAD_MUTEX_ROBUST


74 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


78 
	mPTHREAD_PRIO_NONE
,

79 
	mPTHREAD_PRIO_INHERIT
,

80 
	mPTHREAD_PRIO_PROTECT


85 #ifdeà
__PTHREAD_MUTEX_HAVE_PREV


86 
	#PTHREAD_MUTEX_INITIALIZER
 \

87 { { 0, 0, 0, 0, 0, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

88 #ifdeà
__USE_GNU


89 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

90 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

91 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

92 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

93 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

94 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

98 
	#PTHREAD_MUTEX_INITIALIZER
 \

99 { { 0, 0, 0, 0, 0, { 
__PTHREAD_SPINS
 } } }

	)

100 #ifdeà
__USE_GNU


101 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

102 { { 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

103 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

104 { { 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

105 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

106 { { 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

113 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


116 
	mPTHREAD_RWLOCK_PREFER_READER_NP
,

117 
	mPTHREAD_RWLOCK_PREFER_WRITER_NP
,

118 
	mPTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,

119 
	mPTHREAD_RWLOCK_DEFAULT_NP
 = 
PTHREAD_RWLOCK_PREFER_READER_NP


125 #iâdeà
__PTHREAD_RWLOCK_INT_FLAGS_SHARED


126 #ià
__WORDSIZE
 == 64

127 
	#__PTHREAD_RWLOCK_INT_FLAGS_SHARED
 1

	)

132 
	#PTHREAD_RWLOCK_INITIALIZER
 \

133 { { 0, 0, 0, 0, 0, 0, 0, 0, 
__PTHREAD_RWLOCK_ELISION_EXTRA
, 0, 0 } }

	)

134 #ifdeà
__USE_GNU


135 #ifdeà
__PTHREAD_RWLOCK_INT_FLAGS_SHARED


136 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

137 { { 0, 0, 0, 0, 0, 0, 0, 0, 
__PTHREAD_RWLOCK_ELISION_EXTRA
, 0, \

138 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
 } }

	)

140 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


141 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

142 { { 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
, \

143 0, 
__PTHREAD_RWLOCK_ELISION_EXTRA
, 0, 0 } }

	)

145 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

146 { { 0, 0, 0, 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,\

147 0 } }

	)

157 
	mPTHREAD_INHERIT_SCHED
,

158 
	#PTHREAD_INHERIT_SCHED
 
PTHREAD_INHERIT_SCHED


	)

159 
	mPTHREAD_EXPLICIT_SCHED


160 
	#PTHREAD_EXPLICIT_SCHED
 
PTHREAD_EXPLICIT_SCHED


	)

167 
	mPTHREAD_SCOPE_SYSTEM
,

168 
	#PTHREAD_SCOPE_SYSTEM
 
PTHREAD_SCOPE_SYSTEM


	)

169 
	mPTHREAD_SCOPE_PROCESS


170 
	#PTHREAD_SCOPE_PROCESS
 
PTHREAD_SCOPE_PROCESS


	)

177 
	mPTHREAD_PROCESS_PRIVATE
,

178 
	#PTHREAD_PROCESS_PRIVATE
 
PTHREAD_PROCESS_PRIVATE


	)

179 
	mPTHREAD_PROCESS_SHARED


180 
	#PTHREAD_PROCESS_SHARED
 
PTHREAD_PROCESS_SHARED


	)

186 
	#PTHREAD_COND_INITIALIZER
 { { 0, 0, 0, 0, 0, (*è0, 0, 0 } }

	)

190 
	s_±h»ad_ş—nup_bufãr


192 (*
	m__routše
) (*);

193 *
	m__¬g
;

194 
	m__ÿnûÉy³
;

195 
_±h»ad_ş—nup_bufãr
 *
	m__´ev
;

201 
	mPTHREAD_CANCEL_ENABLE
,

202 
	#PTHREAD_CANCEL_ENABLE
 
PTHREAD_CANCEL_ENABLE


	)

203 
	mPTHREAD_CANCEL_DISABLE


204 
	#PTHREAD_CANCEL_DISABLE
 
PTHREAD_CANCEL_DISABLE


	)

208 
	mPTHREAD_CANCEL_DEFERRED
,

209 
	#PTHREAD_CANCEL_DEFERRED
 
PTHREAD_CANCEL_DEFERRED


	)

210 
	mPTHREAD_CANCEL_ASYNCHRONOUS


211 
	#PTHREAD_CANCEL_ASYNCHRONOUS
 
PTHREAD_CANCEL_ASYNCHRONOUS


	)

213 
	#PTHREAD_CANCELED
 ((*è-1)

	)

217 
	#PTHREAD_ONCE_INIT
 0

	)

220 #ifdeà
__USE_XOPEN2K


224 
	#PTHREAD_BARRIER_SERIAL_THREAD
 -1

	)

228 
__BEGIN_DECLS


233 
	$±h»ad_ü—‹
 (
±h»ad_t
 *
__»¡riù
 
__Ãwth»ad
,

234 cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

235 *(*
__¡¬t_routše
) (*),

236 *
__»¡riù
 
__¬g
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 3));

242 
	$±h»ad_ex™
 (*
__»tv®
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

250 
	`±h»ad_još
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
);

252 #ifdeà
__USE_GNU


255 
	$±h»ad_Œyjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
è
__THROW
;

263 
	`±h»ad_timedjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
,

264 cÚ¡ 
time¥ec
 *
__ab¡ime
);

271 
	$±h»ad_d‘ach
 (
±h»ad_t
 
__th
è
__THROW
;

275 
±h»ad_t
 
	$±h»ad_£lf
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

278 
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
)

279 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

287 
	$±h»ad_©Œ_š™
 (
±h»ad_©Œ_t
 *
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

290 
	$±h»ad_©Œ_de¡roy
 (
±h»ad_©Œ_t
 *
__©Œ
)

291 
__THROW
 
	`__nÚnuÎ
 ((1));

294 
	$±h»ad_©Œ_g‘d‘ach¡©e
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

295 *
__d‘ach¡©e
)

296 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

299 
	$±h»ad_©Œ_£td‘ach¡©e
 (
±h»ad_©Œ_t
 *
__©Œ
,

300 
__d‘ach¡©e
)

301 
__THROW
 
	`__nÚnuÎ
 ((1));

305 
	$±h»ad_©Œ_g‘gu¬dsize
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

306 
size_t
 *
__gu¬dsize
)

307 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

310 
	$±h»ad_©Œ_£tgu¬dsize
 (
±h»ad_©Œ_t
 *
__©Œ
,

311 
size_t
 
__gu¬dsize
)

312 
__THROW
 
	`__nÚnuÎ
 ((1));

316 
	$±h»ad_©Œ_g‘sched·¿m
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

317 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

318 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

321 
	$±h»ad_©Œ_£tsched·¿m
 (
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

322 cÚ¡ 
sched_·¿m
 *
__»¡riù


323 
__·¿m
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

326 
	$±h»ad_©Œ_g‘schedpŞicy
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


327 
__©Œ
, *
__»¡riù
 
__pŞicy
)

328 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

331 
	$±h»ad_©Œ_£tschedpŞicy
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__pŞicy
)

332 
__THROW
 
	`__nÚnuÎ
 ((1));

335 
	$±h»ad_©Œ_g‘šh”™sched
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


336 
__©Œ
, *
__»¡riù
 
__šh”™
)

337 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

340 
	$±h»ad_©Œ_£tšh”™sched
 (
±h»ad_©Œ_t
 *
__©Œ
,

341 
__šh”™
)

342 
__THROW
 
	`__nÚnuÎ
 ((1));

346 
	$±h»ad_©Œ_g‘scİe
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

347 *
__»¡riù
 
__scİe
)

348 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

351 
	$±h»ad_©Œ_£tscİe
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__scİe
)

352 
__THROW
 
	`__nÚnuÎ
 ((1));

355 
	$±h»ad_©Œ_g‘¡ackaddr
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


356 
__©Œ
, **
__»¡riù
 
__¡ackaddr
)

357 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__©Œibu‹_d•»ÿ‹d__
;

363 
	$±h»ad_©Œ_£t¡ackaddr
 (
±h»ad_©Œ_t
 *
__©Œ
,

364 *
__¡ackaddr
)

365 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
;

368 
	$±h»ad_©Œ_g‘¡acksize
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


369 
__©Œ
, 
size_t
 *
__»¡riù
 
__¡acksize
)

370 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

375 
	$±h»ad_©Œ_£t¡acksize
 (
±h»ad_©Œ_t
 *
__©Œ
,

376 
size_t
 
__¡acksize
)

377 
__THROW
 
	`__nÚnuÎ
 ((1));

379 #ifdeà
__USE_XOPEN2K


381 
	$±h»ad_©Œ_g‘¡ack
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

382 **
__»¡riù
 
__¡ackaddr
,

383 
size_t
 *
__»¡riù
 
__¡acksize
)

384 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

389 
	$±h»ad_©Œ_£t¡ack
 (
±h»ad_©Œ_t
 *
__©Œ
, *
__¡ackaddr
,

390 
size_t
 
__¡acksize
è
__THROW
 
	`__nÚnuÎ
 ((1));

393 #ifdeà
__USE_GNU


396 
	$±h»ad_©Œ_£ffš™y_Å
 (
±h»ad_©Œ_t
 *
__©Œ
,

397 
size_t
 
__ıu£tsize
,

398 cÚ¡ 
ıu_£t_t
 *
__ıu£t
)

399 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

403 
	$±h»ad_©Œ_g‘affš™y_Å
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

404 
size_t
 
__ıu£tsize
,

405 
ıu_£t_t
 *
__ıu£t
)

406 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

409 
	$±h»ad_g‘©Œ_deçuÉ_Å
 (
±h»ad_©Œ_t
 *
__©Œ
)

410 
__THROW
 
	`__nÚnuÎ
 ((1));

414 
	$±h»ad_£‰r_deçuÉ_Å
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
)

415 
__THROW
 
	`__nÚnuÎ
 ((1));

420 
	$±h»ad_g‘©Œ_Å
 (
±h»ad_t
 
__th
, 
±h»ad_©Œ_t
 *
__©Œ
)

421 
__THROW
 
	`__nÚnuÎ
 ((2));

429 
	$±h»ad_£tsched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
, 
__pŞicy
,

430 cÚ¡ 
sched_·¿m
 *
__·¿m
)

431 
__THROW
 
	`__nÚnuÎ
 ((3));

434 
	$±h»ad_g‘sched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
,

435 *
__»¡riù
 
__pŞicy
,

436 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

437 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

440 
	$±h»ad_£tsched´io
 (
±h»ad_t
 
__rg‘_th»ad
, 
__´io
)

441 
__THROW
;

444 #ifdeà
__USE_GNU


446 
	$±h»ad_g‘Çme_Å
 (
±h»ad_t
 
__rg‘_th»ad
, *
__buf
,

447 
size_t
 
__buæ’
)

448 
__THROW
 
	`__nÚnuÎ
 ((2));

451 
	$±h»ad_£Šame_Å
 (
±h»ad_t
 
__rg‘_th»ad
, cÚ¡ *
__Çme
)

452 
__THROW
 
	`__nÚnuÎ
 ((2));

456 #ifdeà
__USE_UNIX98


458 
	$±h»ad_g‘cÚcu¼’cy
 (è
__THROW
;

461 
	$±h»ad_£tcÚcu¼’cy
 (
__Ëv–
è
__THROW
;

464 #ifdeà
__USE_GNU


469 
	$±h»ad_y›ld
 (è
__THROW
;

474 
	$±h»ad_£ffš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

475 cÚ¡ 
ıu_£t_t
 *
__ıu£t
)

476 
__THROW
 
	`__nÚnuÎ
 ((3));

479 
	$±h»ad_g‘affš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

480 
ıu_£t_t
 *
__ıu£t
)

481 
__THROW
 
	`__nÚnuÎ
 ((3));

494 
	$±h»ad_Úû
 (
±h»ad_Úû_t
 *
__Úû_cÚŒŞ
,

495 (*
__š™_routše
è()è
	`__nÚnuÎ
 ((1, 2));

506 
	`±h»ad_£tÿnûl¡©e
 (
__¡©e
, *
__Şd¡©e
);

510 
	`±h»ad_£tÿnûÉy³
 (
__ty³
, *
__Şdty³
);

513 
	`±h»ad_ÿnûl
 (
±h»ad_t
 
__th
);

518 
	`±h»ad_‹¡ÿnûl
 ();

527 
__jmp_buf
 
__ÿnûl_jmp_buf
;

528 
__mask_was_§ved
;

529 } 
__ÿnûl_jmp_buf
[1];

530 *
__·d
[4];

531 } 
	t__±h»ad_unwšd_buf_t
 
	t__©Œibu‹__
 ((
	t__®igÃd__
));

534 #iâdeà
__ş—nup_fù_©Œibu‹


535 
	#__ş—nup_fù_©Œibu‹


	)

540 
	s__±h»ad_ş—nup_äame


542 (*
__ÿnûl_routše
) (*);

543 *
__ÿnûl_¬g
;

544 
__do_™
;

545 
__ÿnûl_ty³
;

548 #ià
defšed
 
__GNUC__
 && defšed 
__EXCEPTIONS


549 #ifdeà
__ılu¥lus


551 şas 
	c__±h»ad_ş—nup_şass


553 (*
__ÿnûl_routše
) (*);

554 *
__ÿnûl_¬g
;

555 
__do_™
;

556 
__ÿnûl_ty³
;

558 
public
:

559 
	$__±h»ad_ş—nup_şass
 ((*
__fù
è(*), *
__¬g
)

560 : 
	`__ÿnûl_routše
 (
__fù
), 
	`__ÿnûl_¬g
 (
__¬g
), 
	$__do_™
 (1) { }

561 ~
	$__±h»ad_ş—nup_şass
 (è{ ià(
__do_™
è
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); 
	}
}

562 
	$__£tdo™
 (
__Ãwv®
è{ 
__do_™
 = __Ãwv®; 
	}
}

563 
	$__deãr
 (è{ 
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
,

564 &
__ÿnûl_ty³
); 
	}
}

565 
	$__»¡Üe
 (ècÚ¡ { 
	`±h»ad_£tÿnûÉy³
 (
__ÿnûl_ty³
, 0); 
	}
}

575 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

577 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
)

	)

581 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

582 
__şäame
.
	`__£tdo™
 (
execu‹
); \

583 } 0)

	)

585 #ifdeà
__USE_GNU


589 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

591 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
); \

592 
__şäame
.
	`__deãr
 ()

	)

597 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

598 
__şäame
.
	`__»¡Üe
 (); \

599 
__şäame
.
	`__£tdo™
 (
execu‹
); \

600 } 0)

	)

607 
__ex‹º_šlše
 

608 
	$__±h»ad_ş—nup_routše
 (
__±h»ad_ş—nup_äame
 *
__äame
)

610 ià(
__äame
->
__do_™
)

611 
__äame
->
	`__ÿnûl_routše
 (__äame->
__ÿnûl_¬g
);

612 
	}
}

621 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

623 
__±h»ad_ş—nup_äame
 
__şäame
 \

624 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

625 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

626 .
__do_™
 = 1 };

	)

630 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

631 
__şäame
.
__do_™
 = (
execu‹
); \

632 } 0)

	)

634 #ifdeà
__USE_GNU


638 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

640 
__±h»ad_ş—nup_äame
 
__şäame
 \

641 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

642 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

643 .
__do_™
 = 1 }; \

644 (è
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
, \

645 &
__şäame
.
__ÿnûl_ty³
)

	)

650 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

651 (è
	`±h»ad_£tÿnûÉy³
 (
__şäame
.
__ÿnûl_ty³
, 
NULL
); \

652 
__şäame
.
__do_™
 = (
execu‹
); \

653 } 0)

	)

664 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

666 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

667 (*
__ÿnûl_routše
è(*èğ(
routše
); \

668 *
__ÿnûl_¬g
 = (
¬g
); \

669 
__nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

670 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

671 ià(
	`__glibc_uÆik–y
 (
__nÙ_fœ¡_ÿÎ
)) \

673 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

674 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

678 
	`__±h»ad_»gi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

679 dØ{

	)

680 
__±h»ad_»gi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

681 
__ş—nup_fù_©Œibu‹
;

685 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

688 
	`__±h»ad_uÄegi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

689 ià(
execu‹
) \

690 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

691 } 0)

	)

692 
	$__±h»ad_uÄegi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

693 
__ş—nup_fù_©Œibu‹
;

695 #ifdeà
__USE_GNU


699 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

701 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

702 (*
__ÿnûl_routše
è(*èğ(
routše
); \

703 *
__ÿnûl_¬g
 = (
¬g
); \

704 
__nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

705 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

706 ià(
	`__glibc_uÆik–y
 (
__nÙ_fœ¡_ÿÎ
)) \

708 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

709 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

713 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (&
__ÿnûl_buf
); \

714 dØ{

	)

715 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

716 
__ş—nup_fù_©Œibu‹
;

721 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

724 
	`__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (&
__ÿnûl_buf
); \

725 ià(
execu‹
) \

726 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

727 
	}
} 0)

	)

728 
	$__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

729 
__ş—nup_fù_©Œibu‹
;

733 
	$__±h»ad_unwšd_Ãxt
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

734 
__ş—nup_fù_©Œibu‹
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
))

735 #iâdeà
SHARED


736 
	`__©Œibu‹__
 ((
__w—k__
))

742 
__jmp_buf_g
;

743 
	$__sig£tjmp
 (
__jmp_buf_g
 *
__’v
, 
__§vemask
è
__THROWNL
;

749 
	$±h»ad_mu‹x_š™
 (
±h»ad_mu‹x_t
 *
__mu‹x
,

750 cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__mu‹x©Œ
)

751 
__THROW
 
	`__nÚnuÎ
 ((1));

754 
	$±h»ad_mu‹x_de¡roy
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

755 
__THROW
 
	`__nÚnuÎ
 ((1));

758 
	$±h»ad_mu‹x_Œylock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

759 
__THROWNL
 
	`__nÚnuÎ
 ((1));

762 
	$±h»ad_mu‹x_lock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

763 
__THROWNL
 
	`__nÚnuÎ
 ((1));

765 #ifdeà
__USE_XOPEN2K


767 
	$±h»ad_mu‹x_timedlock
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

768 cÚ¡ 
time¥ec
 *
__»¡riù


769 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

773 
	$±h»ad_mu‹x_uÆock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

774 
__THROWNL
 
	`__nÚnuÎ
 ((1));

778 
	$±h»ad_mu‹x_g‘´ioûšg
 (cÚ¡ 
±h»ad_mu‹x_t
 *

779 
__»¡riù
 
__mu‹x
,

780 *
__»¡riù
 
__´ioûšg
)

781 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

785 
	$±h»ad_mu‹x_£rioûšg
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

786 
__´ioûšg
,

787 *
__»¡riù
 
__Şd_ûšg
)

788 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

791 #ifdeà
__USE_XOPEN2K8


793 
	$±h»ad_mu‹x_cÚsi¡’t
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

794 
__THROW
 
	`__nÚnuÎ
 ((1));

795 #ifdeà
__USE_GNU


796 
	$±h»ad_mu‹x_cÚsi¡’t_Å
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

797 
__THROW
 
	`__nÚnuÎ
 ((1));

806 
	$±h»ad_mu‹x©Œ_š™
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

807 
__THROW
 
	`__nÚnuÎ
 ((1));

810 
	$±h»ad_mu‹x©Œ_de¡roy
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

811 
__THROW
 
	`__nÚnuÎ
 ((1));

814 
	$±h»ad_mu‹x©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

815 
__»¡riù
 
__©Œ
,

816 *
__»¡riù
 
__psh¬ed
)

817 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

820 
	$±h»ad_mu‹x©Œ_£sh¬ed
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

821 
__psh¬ed
)

822 
__THROW
 
	`__nÚnuÎ
 ((1));

824 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


826 
	$±h»ad_mu‹x©Œ_g‘ty³
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__»¡riù


827 
__©Œ
, *
__»¡riù
 
__kšd
)

828 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

833 
	$±h»ad_mu‹x©Œ_£‰y³
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
, 
__kšd
)

834 
__THROW
 
	`__nÚnuÎ
 ((1));

838 
	$±h»ad_mu‹x©Œ_g‘´ÙocŞ
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

839 
__»¡riù
 
__©Œ
,

840 *
__»¡riù
 
__´ÙocŞ
)

841 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

845 
	$±h»ad_mu‹x©Œ_£rÙocŞ
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

846 
__´ÙocŞ
)

847 
__THROW
 
	`__nÚnuÎ
 ((1));

850 
	$±h»ad_mu‹x©Œ_g‘´ioûšg
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

851 
__»¡riù
 
__©Œ
,

852 *
__»¡riù
 
__´ioûšg
)

853 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

856 
	$±h»ad_mu‹x©Œ_£rioûšg
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

857 
__´ioûšg
)

858 
__THROW
 
	`__nÚnuÎ
 ((1));

860 #ifdeà
__USE_XOPEN2K


862 
	$±h»ad_mu‹x©Œ_g‘robu¡
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

863 *
__robu¡Ãss
)

864 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

865 #ifdeà
__USE_GNU


866 
	$±h»ad_mu‹x©Œ_g‘robu¡_Å
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

867 *
__robu¡Ãss
)

868 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

872 
	$±h»ad_mu‹x©Œ_£Œobu¡
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

873 
__robu¡Ãss
)

874 
__THROW
 
	`__nÚnuÎ
 ((1));

875 #ifdeà
__USE_GNU


876 
	$±h»ad_mu‹x©Œ_£Œobu¡_Å
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

877 
__robu¡Ãss
)

878 
__THROW
 
	`__nÚnuÎ
 ((1));

883 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


888 
	$±h»ad_rwlock_š™
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

889 cÚ¡ 
±h»ad_rwlock©Œ_t
 *
__»¡riù


890 
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

893 
	$±h»ad_rwlock_de¡roy
 (
±h»ad_rwlock_t
 *
__rwlock
)

894 
__THROW
 
	`__nÚnuÎ
 ((1));

897 
	$±h»ad_rwlock_rdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

898 
__THROWNL
 
	`__nÚnuÎ
 ((1));

901 
	$±h»ad_rwlock_Œyrdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

902 
__THROWNL
 
	`__nÚnuÎ
 ((1));

904 #ifdeà
__USE_XOPEN2K


906 
	$±h»ad_rwlock_timedrdlock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

907 cÚ¡ 
time¥ec
 *
__»¡riù


908 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

912 
	$±h»ad_rwlock_w¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

913 
__THROWNL
 
	`__nÚnuÎ
 ((1));

916 
	$±h»ad_rwlock_Œyw¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

917 
__THROWNL
 
	`__nÚnuÎ
 ((1));

919 #ifdeà
__USE_XOPEN2K


921 
	$±h»ad_rwlock_timedw¾ock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

922 cÚ¡ 
time¥ec
 *
__»¡riù


923 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

927 
	$±h»ad_rwlock_uÆock
 (
±h»ad_rwlock_t
 *
__rwlock
)

928 
__THROWNL
 
	`__nÚnuÎ
 ((1));

934 
	$±h»ad_rwlock©Œ_š™
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

935 
__THROW
 
	`__nÚnuÎ
 ((1));

938 
	$±h»ad_rwlock©Œ_de¡roy
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

939 
__THROW
 
	`__nÚnuÎ
 ((1));

942 
	$±h»ad_rwlock©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_rwlock©Œ_t
 *

943 
__»¡riù
 
__©Œ
,

944 *
__»¡riù
 
__psh¬ed
)

945 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

948 
	$±h»ad_rwlock©Œ_£sh¬ed
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

949 
__psh¬ed
)

950 
__THROW
 
	`__nÚnuÎ
 ((1));

953 
	$±h»ad_rwlock©Œ_g‘kšd_Å
 (cÚ¡ 
±h»ad_rwlock©Œ_t
 *

954 
__»¡riù
 
__©Œ
,

955 *
__»¡riù
 
__´ef
)

956 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

959 
	$±h»ad_rwlock©Œ_£tkšd_Å
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

960 
__´ef
è
__THROW
 
	`__nÚnuÎ
 ((1));

968 
	$±h»ad_cÚd_š™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

969 cÚ¡ 
±h»ad_cÚd©Œ_t
 *
__»¡riù
 
__cÚd_©Œ
)

970 
__THROW
 
	`__nÚnuÎ
 ((1));

973 
	$±h»ad_cÚd_de¡roy
 (
±h»ad_cÚd_t
 *
__cÚd
)

974 
__THROW
 
	`__nÚnuÎ
 ((1));

977 
	$±h»ad_cÚd_sigÇl
 (
±h»ad_cÚd_t
 *
__cÚd
)

978 
__THROWNL
 
	`__nÚnuÎ
 ((1));

981 
	$±h»ad_cÚd_brßdÿ¡
 (
±h»ad_cÚd_t
 *
__cÚd
)

982 
__THROWNL
 
	`__nÚnuÎ
 ((1));

989 
	$±h»ad_cÚd_wa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

990 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
)

991 
	`__nÚnuÎ
 ((1, 2));

1000 
	$±h»ad_cÚd_timedwa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

1001 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

1002 cÚ¡ 
time¥ec
 *
__»¡riù
 
__ab¡ime
)

1003 
	`__nÚnuÎ
 ((1, 2, 3));

1008 
	$±h»ad_cÚd©Œ_š™
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

1009 
__THROW
 
	`__nÚnuÎ
 ((1));

1012 
	$±h»ad_cÚd©Œ_de¡roy
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

1013 
__THROW
 
	`__nÚnuÎ
 ((1));

1016 
	$±h»ad_cÚd©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_cÚd©Œ_t
 *

1017 
__»¡riù
 
__©Œ
,

1018 *
__»¡riù
 
__psh¬ed
)

1019 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1022 
	$±h»ad_cÚd©Œ_£sh¬ed
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1023 
__psh¬ed
è
__THROW
 
	`__nÚnuÎ
 ((1));

1025 #ifdeà
__USE_XOPEN2K


1027 
	$±h»ad_cÚd©Œ_g‘şock
 (cÚ¡ 
±h»ad_cÚd©Œ_t
 *

1028 
__»¡riù
 
__©Œ
,

1029 
__şockid_t
 *
__»¡riù
 
__şock_id
)

1030 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1033 
	$±h»ad_cÚd©Œ_£tşock
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1034 
__şockid_t
 
__şock_id
)

1035 
__THROW
 
	`__nÚnuÎ
 ((1));

1039 #ifdeà
__USE_XOPEN2K


1044 
	$±h»ad_¥š_š™
 (
±h»ad_¥šlock_t
 *
__lock
, 
__psh¬ed
)

1045 
__THROW
 
	`__nÚnuÎ
 ((1));

1048 
	$±h»ad_¥š_de¡roy
 (
±h»ad_¥šlock_t
 *
__lock
)

1049 
__THROW
 
	`__nÚnuÎ
 ((1));

1052 
	$±h»ad_¥š_lock
 (
±h»ad_¥šlock_t
 *
__lock
)

1053 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1056 
	$±h»ad_¥š_Œylock
 (
±h»ad_¥šlock_t
 *
__lock
)

1057 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1060 
	$±h»ad_¥š_uÆock
 (
±h»ad_¥šlock_t
 *
__lock
)

1061 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1068 
	$±h»ad_b¬r›r_š™
 (
±h»ad_b¬r›r_t
 *
__»¡riù
 
__b¬r›r
,

1069 cÚ¡ 
±h»ad_b¬r›¿‰r_t
 *
__»¡riù


1070 
__©Œ
, 
__couÁ
)

1071 
__THROW
 
	`__nÚnuÎ
 ((1));

1074 
	$±h»ad_b¬r›r_de¡roy
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1075 
__THROW
 
	`__nÚnuÎ
 ((1));

1078 
	$±h»ad_b¬r›r_wa™
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1079 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1083 
	$±h»ad_b¬r›¿‰r_š™
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1084 
__THROW
 
	`__nÚnuÎ
 ((1));

1087 
	$±h»ad_b¬r›¿‰r_de¡roy
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1088 
__THROW
 
	`__nÚnuÎ
 ((1));

1091 
	$±h»ad_b¬r›¿‰r_g‘psh¬ed
 (cÚ¡ 
±h»ad_b¬r›¿‰r_t
 *

1092 
__»¡riù
 
__©Œ
,

1093 *
__»¡riù
 
__psh¬ed
)

1094 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1097 
	$±h»ad_b¬r›¿‰r_£sh¬ed
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
,

1098 
__psh¬ed
)

1099 
__THROW
 
	`__nÚnuÎ
 ((1));

1111 
	$±h»ad_key_ü—‹
 (
±h»ad_key_t
 *
__key
,

1112 (*
__de¡r_funùiÚ
) (*))

1113 
__THROW
 
	`__nÚnuÎ
 ((1));

1116 
	$±h»ad_key_d–‘e
 (
±h»ad_key_t
 
__key
è
__THROW
;

1119 *
	$±h»ad_g‘¥ecific
 (
±h»ad_key_t
 
__key
è
__THROW
;

1122 
	$±h»ad_£t¥ecific
 (
±h»ad_key_t
 
__key
,

1123 cÚ¡ *
__poš‹r
è
__THROW
 ;

1126 #ifdeà
__USE_XOPEN2K


1128 
	$±h»ad_g‘ıuşockid
 (
±h»ad_t
 
__th»ad_id
,

1129 
__şockid_t
 *
__şock_id
)

1130 
__THROW
 
	`__nÚnuÎ
 ((2));

1145 
	$±h»ad_©fÜk
 ((*
__´•¬e
) (),

1146 (*
__·»Á
) (),

1147 (*
__chd
è()è
__THROW
;

1150 #ifdeà
__USE_EXTERN_INLINES


1152 
__ex‹º_šlše
 

1153 
	`__NTH
 (
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
))

1155  
__th»ad1
 =ğ
__th»ad2
;

1156 
	}
}

1159 
	g__END_DECLS


	@/usr/include/stdint.h

22 #iâdeà
_STDINT_H


23 
	#_STDINT_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/wch¬.h
>

27 
	~<b™s/wÜdsize.h
>

34 #iâdeà
__št8_t_defšed


35 
	#__št8_t_defšed


	)

36 sigÃd 
	tšt8_t
;

37 
	tšt16_t
;

38 
	tšt32_t
;

39 #ià
__WORDSIZE
 == 64

40 
	tšt64_t
;

42 
__ex‹nsiÚ__


43 
	tšt64_t
;

48 
	tušt8_t
;

49 
	tušt16_t
;

50 #iâdeà
__ušt32_t_defšed


51 
	tušt32_t
;

52 
	#__ušt32_t_defšed


	)

54 #ià
__WORDSIZE
 == 64

55 
	tušt64_t
;

57 
__ex‹nsiÚ__


58 
	tušt64_t
;

65 sigÃd 
	tšt_Ëa¡8_t
;

66 
	tšt_Ëa¡16_t
;

67 
	tšt_Ëa¡32_t
;

68 #ià
__WORDSIZE
 == 64

69 
	tšt_Ëa¡64_t
;

71 
__ex‹nsiÚ__


72 
	tšt_Ëa¡64_t
;

76 
	tušt_Ëa¡8_t
;

77 
	tušt_Ëa¡16_t
;

78 
	tušt_Ëa¡32_t
;

79 #ià
__WORDSIZE
 == 64

80 
	tušt_Ëa¡64_t
;

82 
__ex‹nsiÚ__


83 
	tušt_Ëa¡64_t
;

90 sigÃd 
	tšt_ç¡8_t
;

91 #ià
__WORDSIZE
 == 64

92 
	tšt_ç¡16_t
;

93 
	tšt_ç¡32_t
;

94 
	tšt_ç¡64_t
;

96 
	tšt_ç¡16_t
;

97 
	tšt_ç¡32_t
;

98 
__ex‹nsiÚ__


99 
	tšt_ç¡64_t
;

103 
	tušt_ç¡8_t
;

104 #ià
__WORDSIZE
 == 64

105 
	tušt_ç¡16_t
;

106 
	tušt_ç¡32_t
;

107 
	tušt_ç¡64_t
;

109 
	tušt_ç¡16_t
;

110 
	tušt_ç¡32_t
;

111 
__ex‹nsiÚ__


112 
	tušt_ç¡64_t
;

117 #ià
__WORDSIZE
 == 64

118 #iâdeà
__šŒ_t_defšed


119 
	tšŒ_t
;

120 
	#__šŒ_t_defšed


	)

122 
	tušŒ_t
;

124 #iâdeà
__šŒ_t_defšed


125 
	tšŒ_t
;

126 
	#__šŒ_t_defšed


	)

128 
	tušŒ_t
;

133 #ià
__WORDSIZE
 == 64

134 
	tštmax_t
;

135 
	tuštmax_t
;

137 
__ex‹nsiÚ__


138 
	tštmax_t
;

139 
__ex‹nsiÚ__


140 
	tuštmax_t
;

144 #ià
__WORDSIZE
 == 64

145 
	#__INT64_C
(
c
èø## 
L


	)

146 
	#__UINT64_C
(
c
èø## 
UL


	)

148 
	#__INT64_C
(
c
èø## 
LL


	)

149 
	#__UINT64_C
(
c
èø## 
ULL


	)

155 
	#INT8_MIN
 (-128)

	)

156 
	#INT16_MIN
 (-32767-1)

	)

157 
	#INT32_MIN
 (-2147483647-1)

	)

158 
	#INT64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

160 
	#INT8_MAX
 (127)

	)

161 
	#INT16_MAX
 (32767)

	)

162 
	#INT32_MAX
 (2147483647)

	)

163 
	#INT64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

166 
	#UINT8_MAX
 (255)

	)

167 
	#UINT16_MAX
 (65535)

	)

168 
	#UINT32_MAX
 (4294967295U)

	)

169 
	#UINT64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

173 
	#INT_LEAST8_MIN
 (-128)

	)

174 
	#INT_LEAST16_MIN
 (-32767-1)

	)

175 
	#INT_LEAST32_MIN
 (-2147483647-1)

	)

176 
	#INT_LEAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

178 
	#INT_LEAST8_MAX
 (127)

	)

179 
	#INT_LEAST16_MAX
 (32767)

	)

180 
	#INT_LEAST32_MAX
 (2147483647)

	)

181 
	#INT_LEAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

184 
	#UINT_LEAST8_MAX
 (255)

	)

185 
	#UINT_LEAST16_MAX
 (65535)

	)

186 
	#UINT_LEAST32_MAX
 (4294967295U)

	)

187 
	#UINT_LEAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

191 
	#INT_FAST8_MIN
 (-128)

	)

192 #ià
__WORDSIZE
 == 64

193 
	#INT_FAST16_MIN
 (-9223372036854775807L-1)

	)

194 
	#INT_FAST32_MIN
 (-9223372036854775807L-1)

	)

196 
	#INT_FAST16_MIN
 (-2147483647-1)

	)

197 
	#INT_FAST32_MIN
 (-2147483647-1)

	)

199 
	#INT_FAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

201 
	#INT_FAST8_MAX
 (127)

	)

202 #ià
__WORDSIZE
 == 64

203 
	#INT_FAST16_MAX
 (9223372036854775807L)

	)

204 
	#INT_FAST32_MAX
 (9223372036854775807L)

	)

206 
	#INT_FAST16_MAX
 (2147483647)

	)

207 
	#INT_FAST32_MAX
 (2147483647)

	)

209 
	#INT_FAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

212 
	#UINT_FAST8_MAX
 (255)

	)

213 #ià
__WORDSIZE
 == 64

214 
	#UINT_FAST16_MAX
 (18446744073709551615UL)

	)

215 
	#UINT_FAST32_MAX
 (18446744073709551615UL)

	)

217 
	#UINT_FAST16_MAX
 (4294967295U)

	)

218 
	#UINT_FAST32_MAX
 (4294967295U)

	)

220 
	#UINT_FAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

224 #ià
__WORDSIZE
 == 64

225 
	#INTPTR_MIN
 (-9223372036854775807L-1)

	)

226 
	#INTPTR_MAX
 (9223372036854775807L)

	)

227 
	#UINTPTR_MAX
 (18446744073709551615UL)

	)

229 
	#INTPTR_MIN
 (-2147483647-1)

	)

230 
	#INTPTR_MAX
 (2147483647)

	)

231 
	#UINTPTR_MAX
 (4294967295U)

	)

236 
	#INTMAX_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

238 
	#INTMAX_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

241 
	#UINTMAX_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

247 #ià
__WORDSIZE
 == 64

248 
	#PTRDIFF_MIN
 (-9223372036854775807L-1)

	)

249 
	#PTRDIFF_MAX
 (9223372036854775807L)

	)

251 
	#PTRDIFF_MIN
 (-2147483647-1)

	)

252 
	#PTRDIFF_MAX
 (2147483647)

	)

256 
	#SIG_ATOMIC_MIN
 (-2147483647-1)

	)

257 
	#SIG_ATOMIC_MAX
 (2147483647)

	)

260 #ià
__WORDSIZE
 == 64

261 
	#SIZE_MAX
 (18446744073709551615UL)

	)

263 #ifdeà
__WORDSIZE32_SIZE_ULONG


264 
	#SIZE_MAX
 (4294967295UL)

	)

266 
	#SIZE_MAX
 (4294967295U)

	)

271 #iâdeà
WCHAR_MIN


273 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

274 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

278 
	#WINT_MIN
 (0u)

	)

279 
	#WINT_MAX
 (4294967295u)

	)

282 
	#INT8_C
(
c
è
	)
c

283 
	#INT16_C
(
c
è
	)
c

284 
	#INT32_C
(
c
è
	)
c

285 #ià
__WORDSIZE
 == 64

286 
	#INT64_C
(
c
èø## 
L


	)

288 
	#INT64_C
(
c
èø## 
LL


	)

292 
	#UINT8_C
(
c
è
	)
c

293 
	#UINT16_C
(
c
è
	)
c

294 
	#UINT32_C
(
c
èø## 
U


	)

295 #ià
__WORDSIZE
 == 64

296 
	#UINT64_C
(
c
èø## 
UL


	)

298 
	#UINT64_C
(
c
èø## 
ULL


	)

302 #ià
__WORDSIZE
 == 64

303 
	#INTMAX_C
(
c
èø## 
L


	)

304 
	#UINTMAX_C
(
c
èø## 
UL


	)

306 
	#INTMAX_C
(
c
èø## 
LL


	)

307 
	#UINTMAX_C
(
c
èø## 
ULL


	)

	@/usr/include/stdio.h

23 #iâdeà
_STDIO_H


25 #ià!
defšed
 
__Ãed_FILE
 && !defšed 
__Ãed___FILE


26 
	#_STDIO_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

35 
	~<b™s/ty³s.h
>

36 
	#__Ãed_FILE


	)

37 
	#__Ãed___FILE


	)

41 #ià!
defšed
 
__FILE_defšed
 && defšed 
__Ãed_FILE


44 
	g_IO_FILE
;

46 
__BEGIN_NAMESPACE_STD


48 
_IO_FILE
 
	tFILE
;

49 
	g__END_NAMESPACE_STD


50 #ià
defšed
 
__USE_LARGEFILE64
 || defšed 
__USE_POSIX
 \

51 || 
defšed
 
	g__USE_ISOC99
 || defšed 
	g__USE_XOPEN
 \

52 || 
defšed
 
__USE_POSIX2


53 
	$__USING_NAMESPACE_STD
(
FILE
)

56 
	#__FILE_defšed
 1

	)

58 #undeà
__Ãed_FILE


61 #ià!
defšed
 
____FILE_defšed
 && defšed 
__Ãed___FILE


64 
_IO_FILE
 
	t__FILE
;

66 
	#____FILE_defšed
 1

	)

68 #undeà
__Ãed___FILE


71 #ifdef 
_STDIO_H


72 
	#_STDIO_USES_IOSTREAM


	)

74 
	~<libio.h
>

76 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


77 #ifdeà
__GNUC__


78 #iâdeà
_VA_LIST_DEFINED


79 
_G_va_li¡
 
	tva_li¡
;

80 
	#_VA_LIST_DEFINED


	)

83 
	~<¡d¬g.h
>

87 #ifdeà
__USE_XOPEN2K8


88 #iâdeà
__off_t_defšed


89 #iâdeà
__USE_FILE_OFFSET64


90 
__off_t
 
	toff_t
;

92 
__off64_t
 
	toff_t
;

94 
	#__off_t_defšed


	)

96 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


97 
__off64_t
 
	toff64_t
;

98 
	#__off64_t_defšed


	)

101 #iâdeà
__ssize_t_defšed


102 
__ssize_t
 
	tssize_t
;

103 
	#__ssize_t_defšed


	)

108 
__BEGIN_NAMESPACE_STD


109 #iâdeà
__USE_FILE_OFFSET64


110 
_G_åos_t
 
	tåos_t
;

112 
_G_åos64_t
 
	tåos_t
;

114 
__END_NAMESPACE_STD


115 #ifdeà
__USE_LARGEFILE64


116 
_G_åos64_t
 
	tåos64_t
;

120 
	#_IOFBF
 0

	)

121 
	#_IOLBF
 1

	)

122 
	#_IONBF
 2

	)

126 #iâdeà
BUFSIZ


127 
	#BUFSIZ
 
_IO_BUFSIZ


	)

133 #iâdeà
EOF


134 
	#EOF
 (-1)

	)

140 
	#SEEK_SET
 0

	)

141 
	#SEEK_CUR
 1

	)

142 
	#SEEK_END
 2

	)

143 #ifdeà
__USE_GNU


144 
	#SEEK_DATA
 3

	)

145 
	#SEEK_HOLE
 4

	)

149 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


151 
	#P_tmpdœ
 "/tmp"

	)

164 
	~<b™s/¡dio_lim.h
>

168 
_IO_FILE
 *
¡dš
;

169 
_IO_FILE
 *
¡dout
;

170 
_IO_FILE
 *
¡d”r
;

172 
	#¡dš
 
¡dš


	)

173 
	#¡dout
 
¡dout


	)

174 
	#¡d”r
 
¡d”r


	)

176 
__BEGIN_NAMESPACE_STD


178 
	$»move
 (cÚ¡ *
__f’ame
è
__THROW
;

180 
	$»Çme
 (cÚ¡ *
__Şd
, cÚ¡ *
__Ãw
è
__THROW
;

181 
__END_NAMESPACE_STD


183 #ifdeà
__USE_ATFILE


185 
	$»Çm—t
 (
__Şdfd
, cÚ¡ *
__Şd
, 
__Ãwfd
,

186 cÚ¡ *
__Ãw
è
__THROW
;

189 
__BEGIN_NAMESPACE_STD


194 #iâdeà
__USE_FILE_OFFSET64


195 
FILE
 *
	$tmpfe
 (è
__wur
;

197 #ifdeà
__REDIRECT


198 
FILE
 *
	`__REDIRECT
 (
tmpfe
, (), 
tmpfe64
è
__wur
;

200 
	#tmpfe
 
tmpfe64


	)

204 #ifdeà
__USE_LARGEFILE64


205 
FILE
 *
	$tmpfe64
 (è
__wur
;

209 *
	$tm²am
 (*
__s
è
__THROW
 
__wur
;

210 
__END_NAMESPACE_STD


212 #ifdeà
__USE_MISC


215 *
	$tm²am_r
 (*
__s
è
__THROW
 
__wur
;

219 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


227 *
	$‹m²am
 (cÚ¡ *
__dœ
, cÚ¡ *
__pfx
)

228 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

232 
__BEGIN_NAMESPACE_STD


237 
	`fşo£
 (
FILE
 *
__¡»am
);

242 
	`fæush
 (
FILE
 *
__¡»am
);

243 
__END_NAMESPACE_STD


245 #ifdeà
__USE_MISC


252 
	`fæush_uÆocked
 (
FILE
 *
__¡»am
);

255 #ifdeà
__USE_GNU


262 
	`fşo£®l
 ();

266 
__BEGIN_NAMESPACE_STD


267 #iâdeà
__USE_FILE_OFFSET64


272 
FILE
 *
	$fİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

273 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

278 
FILE
 *
	$äeİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

279 cÚ¡ *
__»¡riù
 
__modes
,

280 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

282 #ifdeà
__REDIRECT


283 
FILE
 *
	`__REDIRECT
 (
fİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

284 cÚ¡ *
__»¡riù
 
__modes
), 
fİ’64
)

285 
__wur
;

286 
FILE
 *
	`__REDIRECT
 (
äeİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

287 cÚ¡ *
__»¡riù
 
__modes
,

288 
FILE
 *
__»¡riù
 
__¡»am
), 
äeİ’64
)

289 
__wur
;

291 
	#fİ’
 
fİ’64


	)

292 
	#äeİ’
 
äeİ’64


	)

295 
__END_NAMESPACE_STD


296 #ifdeà
__USE_LARGEFILE64


297 
FILE
 *
	$fİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

298 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

299 
FILE
 *
	$äeİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

300 cÚ¡ *
__»¡riù
 
__modes
,

301 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

304 #ifdef 
__USE_POSIX


306 
FILE
 *
	$fdİ’
 (
__fd
, cÚ¡ *
__modes
è
__THROW
 
__wur
;

309 #ifdef 
__USE_GNU


312 
FILE
 *
	$fİ’cook›
 (*
__»¡riù
 
__magic_cook›
,

313 cÚ¡ *
__»¡riù
 
__modes
,

314 
_IO_cook›_io_funùiÚs_t
 
__io_funcs
è
__THROW
 
__wur
;

317 #ifdeà
__USE_XOPEN2K8


319 
FILE
 *
	$fmemİ’
 (*
__s
, 
size_t
 
__Ën
, cÚ¡ *
__modes
)

320 
__THROW
 
__wur
;

325 
FILE
 *
	$İ’_mem¡»am
 (**
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
 
__wur
;

329 
__BEGIN_NAMESPACE_STD


332 
	$£tbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
è
__THROW
;

336 
	$£tvbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

337 
__modes
, 
size_t
 
__n
è
__THROW
;

338 
__END_NAMESPACE_STD


340 #ifdef 
__USE_MISC


343 
	$£tbufãr
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

344 
size_t
 
__size
è
__THROW
;

347 
	$£šebuf
 (
FILE
 *
__¡»am
è
__THROW
;

351 
__BEGIN_NAMESPACE_STD


356 
	`årštf
 (
FILE
 *
__»¡riù
 
__¡»am
,

357 cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

362 
	`´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

364 
	$¥rštf
 (*
__»¡riù
 
__s
,

365 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROWNL
;

371 
	`vårštf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

372 
_G_va_li¡
 
__¬g
);

377 
	`v´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
);

379 
	$v¥rštf
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

380 
_G_va_li¡
 
__¬g
è
__THROWNL
;

381 
__END_NAMESPACE_STD


383 #ià
defšed
 
__USE_ISOC99
 || defšed 
__USE_UNIX98


384 
__BEGIN_NAMESPACE_C99


386 
	$¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

387 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

388 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 4)));

390 
	$v¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

391 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

392 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 0)));

393 
__END_NAMESPACE_C99


396 #ifdeà
__USE_GNU


399 
	$va¥rštf
 (**
__»¡riù
 
__±r
, cÚ¡ *__»¡riù 
__f
,

400 
_G_va_li¡
 
__¬g
)

401 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 0))è
__wur
;

402 
	$__a¥rštf
 (**
__»¡riù
 
__±r
,

403 cÚ¡ *
__»¡riù
 
__fmt
, ...)

404 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

405 
	$a¥rštf
 (**
__»¡riù
 
__±r
,

406 cÚ¡ *
__»¡riù
 
__fmt
, ...)

407 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

410 #ifdeà
__USE_XOPEN2K8


412 
	$vd´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
,

413 
_G_va_li¡
 
__¬g
)

414 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

415 
	$d´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
, ...)

416 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

420 
__BEGIN_NAMESPACE_STD


425 
	$fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

426 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

431 
	$sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

433 
	$ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

434 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

436 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

437 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

438 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

439 #ifdeà
__REDIRECT


443 
	`__REDIRECT
 (
fsÿnf
, (
FILE
 *
__»¡riù
 
__¡»am
,

444 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

445 
__isoc99_fsÿnf
è
__wur
;

446 
	`__REDIRECT
 (
sÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

447 
__isoc99_sÿnf
è
__wur
;

448 
	`__REDIRECT_NTH
 (
ssÿnf
, (cÚ¡ *
__»¡riù
 
__s
,

449 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

450 
__isoc99_ssÿnf
);

452 
	$__isoc99_fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

453 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

454 
	$__isoc99_sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

455 
	$__isoc99_ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

456 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

457 
	#fsÿnf
 
__isoc99_fsÿnf


	)

458 
	#sÿnf
 
__isoc99_sÿnf


	)

459 
	#ssÿnf
 
__isoc99_ssÿnf


	)

463 
__END_NAMESPACE_STD


465 #ifdef 
__USE_ISOC99


466 
__BEGIN_NAMESPACE_C99


471 
	$vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

472 
_G_va_li¡
 
__¬g
)

473 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

479 
	$vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

480 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

483 
	$vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

484 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

485 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

487 #ià!
defšed
 
__USE_GNU
 \

488 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

489 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

490 #ifdeà
__REDIRECT


494 
	`__REDIRECT
 (
vfsÿnf
,

495 (
FILE
 *
__»¡riù
 
__s
,

496 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
),

497 
__isoc99_vfsÿnf
)

498 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

499 
	`__REDIRECT
 (
vsÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
,

500 
_G_va_li¡
 
__¬g
), 
__isoc99_vsÿnf
)

501 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

502 
	`__REDIRECT_NTH
 (
vssÿnf
,

503 (cÚ¡ *
__»¡riù
 
__s
,

504 cÚ¡ *
__»¡riù
 
__fÜm©
,

505 
_G_va_li¡
 
__¬g
), 
__isoc99_vssÿnf
)

506 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

508 
	$__isoc99_vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
,

509 cÚ¡ *
__»¡riù
 
__fÜm©
,

510 
_G_va_li¡
 
__¬g
è
__wur
;

511 
	$__isoc99_vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
,

512 
_G_va_li¡
 
__¬g
è
__wur
;

513 
	$__isoc99_vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

514 cÚ¡ *
__»¡riù
 
__fÜm©
,

515 
_G_va_li¡
 
__¬g
è
__THROW
;

516 
	#vfsÿnf
 
__isoc99_vfsÿnf


	)

517 
	#vsÿnf
 
__isoc99_vsÿnf


	)

518 
	#vssÿnf
 
__isoc99_vssÿnf


	)

522 
__END_NAMESPACE_C99


526 
__BEGIN_NAMESPACE_STD


531 
	`fg‘c
 (
FILE
 *
__¡»am
);

532 
	`g‘c
 (
FILE
 *
__¡»am
);

538 
	`g‘ch¬
 ();

539 
__END_NAMESPACE_STD


543 
	#g‘c
(
_å
è
	`_IO_g‘c
 (_å)

	)

545 #ifdeà
__USE_POSIX


550 
	`g‘c_uÆocked
 (
FILE
 *
__¡»am
);

551 
	`g‘ch¬_uÆocked
 ();

554 #ifdeà
__USE_MISC


561 
	`fg‘c_uÆocked
 (
FILE
 *
__¡»am
);

565 
__BEGIN_NAMESPACE_STD


573 
	`åutc
 (
__c
, 
FILE
 *
__¡»am
);

574 
	`putc
 (
__c
, 
FILE
 *
__¡»am
);

580 
	`putch¬
 (
__c
);

581 
__END_NAMESPACE_STD


585 
	#putc
(
_ch
, 
_å
è
	`_IO_putc
 (_ch, _å)

	)

587 #ifdeà
__USE_MISC


594 
	`åutc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

597 #ifdeà
__USE_POSIX


602 
	`putc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

603 
	`putch¬_uÆocked
 (
__c
);

607 #ià
defšed
 
__USE_MISC
 \

608 || (
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

610 
	`g‘w
 (
FILE
 *
__¡»am
);

613 
	`putw
 (
__w
, 
FILE
 *
__¡»am
);

617 
__BEGIN_NAMESPACE_STD


622 *
	$fg‘s
 (*
__»¡riù
 
__s
, 
__n
, 
FILE
 *__»¡riù 
__¡»am
)

623 
__wur
;

625 #ià!
defšed
 
__USE_ISOC11
 \

626 || (
defšed
 
__ılu¥lus
 && __cplusplus <= 201103L)

638 *
	$g‘s
 (*
__s
è
__wur
 
__©Œibu‹_d•»ÿ‹d__
;

640 
__END_NAMESPACE_STD


642 #ifdeà
__USE_GNU


649 *
	$fg‘s_uÆocked
 (*
__»¡riù
 
__s
, 
__n
,

650 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

654 #ifdef 
__USE_XOPEN2K8


665 
_IO_ssize_t
 
	$__g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

666 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

667 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

668 
_IO_ssize_t
 
	$g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

669 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

670 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

678 
_IO_ssize_t
 
	$g‘lše
 (**
__»¡riù
 
__lš•Œ
,

679 
size_t
 *
__»¡riù
 
__n
,

680 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

684 
__BEGIN_NAMESPACE_STD


689 
	`åuts
 (cÚ¡ *
__»¡riù
 
__s
, 
FILE
 *__»¡riù 
__¡»am
);

695 
	`puts
 (cÚ¡ *
__s
);

702 
	`ung‘c
 (
__c
, 
FILE
 *
__¡»am
);

709 
size_t
 
	$ä—d
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

710 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

715 
size_t
 
	`fwr™e
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

716 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__s
);

717 
__END_NAMESPACE_STD


719 #ifdeà
__USE_GNU


726 
	`åuts_uÆocked
 (cÚ¡ *
__»¡riù
 
__s
,

727 
FILE
 *
__»¡riù
 
__¡»am
);

730 #ifdeà
__USE_MISC


737 
size_t
 
	$ä—d_uÆocked
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

738 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

739 
size_t
 
	`fwr™e_uÆocked
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

740 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
);

744 
__BEGIN_NAMESPACE_STD


749 
	`f£ek
 (
FILE
 *
__¡»am
, 
__off
, 
__wh’û
);

754 
	$á–l
 (
FILE
 *
__¡»am
è
__wur
;

759 
	`»wšd
 (
FILE
 *
__¡»am
);

760 
__END_NAMESPACE_STD


767 #ià
defšed
 
__USE_LARGEFILE
 || defšed 
__USE_XOPEN2K


768 #iâdeà
__USE_FILE_OFFSET64


773 
	`f£eko
 (
FILE
 *
__¡»am
, 
__off_t
 
__off
, 
__wh’û
);

778 
__off_t
 
	$á–lo
 (
FILE
 *
__¡»am
è
__wur
;

780 #ifdeà
__REDIRECT


781 
	`__REDIRECT
 (
f£eko
,

782 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
),

783 
f£eko64
);

784 
__off64_t
 
	`__REDIRECT
 (
á–lo
, (
FILE
 *
__¡»am
), 
á–lo64
);

786 
	#f£eko
 
f£eko64


	)

787 
	#á–lo
 
á–lo64


	)

792 
__BEGIN_NAMESPACE_STD


793 #iâdeà
__USE_FILE_OFFSET64


798 
	`fg‘pos
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos_t
 *__»¡riù 
__pos
);

803 
	`f£os
 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
);

805 #ifdeà
__REDIRECT


806 
	`__REDIRECT
 (
fg‘pos
, (
FILE
 *
__»¡riù
 
__¡»am
,

807 
åos_t
 *
__»¡riù
 
__pos
), 
fg‘pos64
);

808 
	`__REDIRECT
 (
f£os
,

809 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
), 
f£os64
);

811 
	#fg‘pos
 
fg‘pos64


	)

812 
	#f£os
 
f£os64


	)

815 
__END_NAMESPACE_STD


817 #ifdeà
__USE_LARGEFILE64


818 
	`f£eko64
 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
);

819 
__off64_t
 
	$á–lo64
 (
FILE
 *
__¡»am
è
__wur
;

820 
	`fg‘pos64
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos64_t
 *__»¡riù 
__pos
);

821 
	`f£os64
 (
FILE
 *
__¡»am
, cÚ¡ 
åos64_t
 *
__pos
);

824 
__BEGIN_NAMESPACE_STD


826 
	$ş—»¼
 (
FILE
 *
__¡»am
è
__THROW
;

828 
	$ãof
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

830 
	$ã¼Ü
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

831 
__END_NAMESPACE_STD


833 #ifdeà
__USE_MISC


835 
	$ş—»¼_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
;

836 
	$ãof_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

837 
	$ã¼Ü_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

841 
__BEGIN_NAMESPACE_STD


846 
	`³¼Ü
 (cÚ¡ *
__s
);

847 
__END_NAMESPACE_STD


853 
	~<b™s/sys_”¾i¡.h
>

856 #ifdef 
__USE_POSIX


858 
	$f’o
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

861 #ifdeà
__USE_MISC


863 
	$f’o_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

867 #ifdeà
__USE_POSIX2


872 
FILE
 *
	$pİ’
 (cÚ¡ *
__commªd
, cÚ¡ *
__modes
è
__wur
;

878 
	`pşo£
 (
FILE
 *
__¡»am
);

882 #ifdef 
__USE_POSIX


884 *
	$ù”mid
 (*
__s
è
__THROW
;

888 #ifdeà
__USE_XOPEN


890 *
	`cu£rid
 (*
__s
);

894 #ifdef 
__USE_GNU


895 
ob¡ack
;

898 
	$ob¡ack_´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

899 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

900 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

901 
	$ob¡ack_v´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

902 cÚ¡ *
__»¡riù
 
__fÜm©
,

903 
_G_va_li¡
 
__¬gs
)

904 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

908 #ifdeà
__USE_POSIX


912 
	$æockfe
 (
FILE
 *
__¡»am
è
__THROW
;

916 
	$árylockfe
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

919 
	$fuÆockfe
 (
FILE
 *
__¡»am
è
__THROW
;

922 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


926 
	#__Ãed_g‘İt


	)

927 
	~<g‘İt.h
>

932 #ifdeà
__USE_EXTERN_INLINES


933 
	~<b™s/¡dio.h
>

935 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


936 
	~<b™s/¡dio2.h
>

938 #ifdeà
__LDBL_COMPAT


939 
	~<b™s/¡dio-ldbl.h
>

942 
__END_DECLS


	@/usr/include/stdlib.h

22 #iâdef 
_STDLIB_H


24 
	~<ã©u»s.h
>

27 
	#__Ãed_size_t


	)

28 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


29 
	#__Ãed_wch¬_t


	)

30 
	#__Ãed_NULL


	)

32 
	~<¡ddef.h
>

34 
	g__BEGIN_DECLS


36 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


37 
	#_STDLIB_H
 1

	)

39 #ià(
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8
è&& !defšed 
_SYS_WAIT_H


41 
	~<b™s/wa™æags.h
>

42 
	~<b™s/wa™¡©us.h
>

44 #ifdeà
__USE_MISC


49 #ià
defšed
 
__GNUC__
 && !defšed 
__ılu¥lus


50 
	#__WAIT_INT
(
¡©us
) \

51 (
	`__ex‹nsiÚ__
 (((uniÚ { 
	`__ty³of
(
¡©us
è
__š
; 
__i
; }) \

52 { .
__š
 = (
¡©us
è}).
__i
))

	)

54 
	#__WAIT_INT
(
¡©us
è(*(*è&(¡©us))

	)

62 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2 || defšed 
__ılu¥lus


63 
	#__WAIT_STATUS
 *

	)

64 
	#__WAIT_STATUS_DEFN
 *

	)

69 
wa™
 *
	m__u±r
;

70 *
	m__Œ
;

71 } 
	t__WAIT_STATUS
 
	t__©Œibu‹__
 ((
	t__Œª¥¬’t_uniÚ__
));

72 
	#__WAIT_STATUS_DEFN
 *

	)

77 
	#__WAIT_INT
(
¡©us
è(¡©us)

	)

78 
	#__WAIT_STATUS
 *

	)

79 
	#__WAIT_STATUS_DEFN
 *

	)

84 
	#WEXITSTATUS
(
¡©us
è
	`__WEXITSTATUS
 (
	`__WAIT_INT
 (¡©us))

	)

85 
	#WTERMSIG
(
¡©us
è
	`__WTERMSIG
 (
	`__WAIT_INT
 (¡©us))

	)

86 
	#WSTOPSIG
(
¡©us
è
	`__WSTOPSIG
 (
	`__WAIT_INT
 (¡©us))

	)

87 
	#WIFEXITED
(
¡©us
è
	`__WIFEXITED
 (
	`__WAIT_INT
 (¡©us))

	)

88 
	#WIFSIGNALED
(
¡©us
è
	`__WIFSIGNALED
 (
	`__WAIT_INT
 (¡©us))

	)

89 
	#WIFSTOPPED
(
¡©us
è
	`__WIFSTOPPED
 (
	`__WAIT_INT
 (¡©us))

	)

90 #ifdeà
__WIFCONTINUED


91 
	#WIFCONTINUED
(
¡©us
è
	`__WIFCONTINUED
 (
	`__WAIT_INT
 (¡©us))

	)

95 
__BEGIN_NAMESPACE_STD


99 
	mquÙ
;

100 
	m»m
;

101 } 
	tdiv_t
;

104 #iâdeà
__ldiv_t_defšed


107 
	mquÙ
;

108 
	m»m
;

109 } 
	tldiv_t
;

110 
	#__ldiv_t_defšed
 1

	)

112 
	g__END_NAMESPACE_STD


114 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__Îdiv_t_defšed


115 
__BEGIN_NAMESPACE_C99


117 
__ex‹nsiÚ__
 struct

119 
	mquÙ
;

120 
	m»m
;

121 } 
	tÎdiv_t
;

122 
	#__Îdiv_t_defšed
 1

	)

123 
	g__END_NAMESPACE_C99


128 
	#RAND_MAX
 2147483647

	)

133 
	#EXIT_FAILURE
 1

	)

134 
	#EXIT_SUCCESS
 0

	)

138 
	#MB_CUR_MAX
 (
	`__ùy³_g‘_mb_cur_max
 ())

	)

139 
size_t
 
	$__ùy³_g‘_mb_cur_max
 (è
__THROW
 
__wur
;

142 
__BEGIN_NAMESPACE_STD


144 
	$©of
 (cÚ¡ *
__ÅŒ
)

145 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

147 
	$©oi
 (cÚ¡ *
__ÅŒ
)

148 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

150 
	$©Ş
 (cÚ¡ *
__ÅŒ
)

151 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

152 
__END_NAMESPACE_STD


154 #ifdeà
__USE_ISOC99


155 
__BEGIN_NAMESPACE_C99


157 
__ex‹nsiÚ__
 
	$©Şl
 (cÚ¡ *
__ÅŒ
)

158 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

159 
__END_NAMESPACE_C99


162 
__BEGIN_NAMESPACE_STD


164 
	$¡¹od
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

165 **
__»¡riù
 
__’d±r
)

166 
__THROW
 
	`__nÚnuÎ
 ((1));

167 
__END_NAMESPACE_STD


169 #ifdef 
__USE_ISOC99


170 
__BEGIN_NAMESPACE_C99


172 
	$¡¹of
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

173 **
__»¡riù
 
__’d±r
è
__THROW
 
	`__nÚnuÎ
 ((1));

175 
	$¡¹Şd
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

176 **
__»¡riù
 
__’d±r
)

177 
__THROW
 
	`__nÚnuÎ
 ((1));

178 
__END_NAMESPACE_C99


181 
__BEGIN_NAMESPACE_STD


183 
	$¡¹Ş
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

184 **
__»¡riù
 
__’d±r
, 
__ba£
)

185 
__THROW
 
	`__nÚnuÎ
 ((1));

187 
	$¡¹oul
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

188 **
__»¡riù
 
__’d±r
, 
__ba£
)

189 
__THROW
 
	`__nÚnuÎ
 ((1));

190 
__END_NAMESPACE_STD


192 #ifdeà
__USE_MISC


194 
__ex‹nsiÚ__


195 
	$¡¹oq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

196 **
__»¡riù
 
__’d±r
, 
__ba£
)

197 
__THROW
 
	`__nÚnuÎ
 ((1));

199 
__ex‹nsiÚ__


200 
	$¡¹ouq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

201 **
__»¡riù
 
__’d±r
, 
__ba£
)

202 
__THROW
 
	`__nÚnuÎ
 ((1));

205 #ifdeà
__USE_ISOC99


206 
__BEGIN_NAMESPACE_C99


208 
__ex‹nsiÚ__


209 
	$¡¹Şl
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

210 **
__»¡riù
 
__’d±r
, 
__ba£
)

211 
__THROW
 
	`__nÚnuÎ
 ((1));

213 
__ex‹nsiÚ__


214 
	$¡¹ouÎ
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

215 **
__»¡riù
 
__’d±r
, 
__ba£
)

216 
__THROW
 
	`__nÚnuÎ
 ((1));

217 
__END_NAMESPACE_C99


221 #ifdeà
__USE_GNU


235 
	~<xloÿË.h
>

239 
	$¡¹Ş_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

240 **
__»¡riù
 
__’d±r
, 
__ba£
,

241 
__loÿË_t
 
__loc
è
__THROW
 
	`__nÚnuÎ
 ((1, 4));

243 
	$¡¹oul_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

244 **
__»¡riù
 
__’d±r
,

245 
__ba£
, 
__loÿË_t
 
__loc
)

246 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

248 
__ex‹nsiÚ__


249 
	$¡¹Şl_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

250 **
__»¡riù
 
__’d±r
, 
__ba£
,

251 
__loÿË_t
 
__loc
)

252 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

254 
__ex‹nsiÚ__


255 
	$¡¹ouÎ_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

256 **
__»¡riù
 
__’d±r
,

257 
__ba£
, 
__loÿË_t
 
__loc
)

258 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

260 
	$¡¹od_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

261 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

262 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

264 
	$¡¹of_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

265 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

266 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

268 
	$¡¹Şd_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

269 **
__»¡riù
 
__’d±r
,

270 
__loÿË_t
 
__loc
)

271 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

275 #ifdeà
__USE_EXTERN_INLINES


276 
__BEGIN_NAMESPACE_STD


277 
__ex‹º_šlše
 

278 
	`__NTH
 (
	$©oi
 (cÚ¡ *
__ÅŒ
))

280  (è
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

281 
	}
}

282 
__ex‹º_šlše
 

283 
__NTH
 (
	$©Ş
 (cÚ¡ *
__ÅŒ
))

285  
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

286 
	}
}

287 
	g__END_NAMESPACE_STD


289 #ifdeà
__USE_ISOC99


290 
__BEGIN_NAMESPACE_C99


291 
__ex‹nsiÚ__
 
__ex‹º_šlše
 

292 
__NTH
 (
	$©Şl
 (cÚ¡ *
__ÅŒ
))

294  
	`¡¹Şl
 (
__ÅŒ
, (**è
NULL
, 10);

295 
	}
}

296 
	g__END_NAMESPACE_C99


301 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


305 *
	$l64a
 (
__n
è
__THROW
 
__wur
;

308 
	$a64l
 (cÚ¡ *
__s
)

309 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

313 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


314 
	~<sys/ty³s.h
>

321 
	$¿ndom
 (è
__THROW
;

324 
	$¤ªdom
 (
__£ed
è
__THROW
;

330 *
	$š™¡©e
 (
__£ed
, *
__¡©ebuf
,

331 
size_t
 
__¡©–’
è
__THROW
 
	`__nÚnuÎ
 ((2));

335 *
	$£t¡©e
 (*
__¡©ebuf
è
__THROW
 
	`__nÚnuÎ
 ((1));

338 #ifdeà
__USE_MISC


343 
	s¿ndom_d©a


345 
št32_t
 *
åŒ
;

346 
št32_t
 *
½Œ
;

347 
št32_t
 *
¡©e
;

348 
¿nd_ty³
;

349 
¿nd_deg
;

350 
¿nd_£p
;

351 
št32_t
 *
’d_±r
;

354 
	$¿ndom_r
 (
¿ndom_d©a
 *
__»¡riù
 
__buf
,

355 
št32_t
 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

357 
	$¤ªdom_r
 (
__£ed
, 
¿ndom_d©a
 *
__buf
)

358 
__THROW
 
	`__nÚnuÎ
 ((2));

360 
	$š™¡©e_r
 (
__£ed
, *
__»¡riù
 
__¡©ebuf
,

361 
size_t
 
__¡©–’
,

362 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

363 
__THROW
 
	`__nÚnuÎ
 ((2, 4));

365 
	$£t¡©e_r
 (*
__»¡riù
 
__¡©ebuf
,

366 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

367 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

372 
__BEGIN_NAMESPACE_STD


374 
	$¿nd
 (è
__THROW
;

376 
	$¤ªd
 (
__£ed
è
__THROW
;

377 
__END_NAMESPACE_STD


379 #ifdeà
__USE_POSIX


381 
	$¿nd_r
 (*
__£ed
è
__THROW
;

385 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


389 
	$d¿nd48
 (è
__THROW
;

390 
	$”ªd48
 (
__xsubi
[3]è
__THROW
 
	`__nÚnuÎ
 ((1));

393 
	$Ìªd48
 (è
__THROW
;

394 
	$Äªd48
 (
__xsubi
[3])

395 
__THROW
 
	`__nÚnuÎ
 ((1));

398 
	$m¿nd48
 (è
__THROW
;

399 
	$j¿nd48
 (
__xsubi
[3])

400 
__THROW
 
	`__nÚnuÎ
 ((1));

403 
	$¤ªd48
 (
__£edv®
è
__THROW
;

404 *
	$£ed48
 (
__£ed16v
[3])

405 
__THROW
 
	`__nÚnuÎ
 ((1));

406 
	$lcÚg48
 (
__·¿m
[7]è
__THROW
 
	`__nÚnuÎ
 ((1));

408 #ifdeà
__USE_MISC


412 
	sd¿nd48_d©a


414 
__x
[3];

415 
__Şd_x
[3];

416 
__c
;

417 
__š™
;

418 
__ex‹nsiÚ__
 
__a
;

423 
	$d¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

424 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

425 
	$”ªd48_r
 (
__xsubi
[3],

426 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

427 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

430 
	$Ìªd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

431 *
__»¡riù
 
__»suÉ
)

432 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

433 
	$Äªd48_r
 (
__xsubi
[3],

434 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

435 *
__»¡riù
 
__»suÉ
)

436 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

439 
	$m¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

440 *
__»¡riù
 
__»suÉ
)

441 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

442 
	$j¿nd48_r
 (
__xsubi
[3],

443 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

444 *
__»¡riù
 
__»suÉ
)

445 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

448 
	$¤ªd48_r
 (
__£edv®
, 
d¿nd48_d©a
 *
__bufãr
)

449 
__THROW
 
	`__nÚnuÎ
 ((2));

451 
	$£ed48_r
 (
__£ed16v
[3],

452 
d¿nd48_d©a
 *
__bufãr
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

454 
	$lcÚg48_r
 (
__·¿m
[7],

455 
d¿nd48_d©a
 *
__bufãr
)

456 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

462 #iâdeà
__m®loc_ªd_ÿÎoc_defšed


463 
	#__m®loc_ªd_ÿÎoc_defšed


	)

464 
__BEGIN_NAMESPACE_STD


466 *
	$m®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

468 *
	$ÿÎoc
 (
size_t
 
__nmemb
, size_ˆ
__size
)

469 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

470 
__END_NAMESPACE_STD


473 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


474 
__BEGIN_NAMESPACE_STD


480 *
	$»®loc
 (*
__±r
, 
size_t
 
__size
)

481 
__THROW
 
__©Œibu‹_w¬n_unu£d_»suÉ__
;

483 
	$ä“
 (*
__±r
è
__THROW
;

484 
__END_NAMESPACE_STD


486 #ifdef 
__USE_MISC


488 
	$cä“
 (*
__±r
è
__THROW
;

491 #ifdeà
__USE_MISC


492 
	~<®loÿ.h
>

495 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

496 || 
defšed
 
__USE_MISC


498 *
	$v®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

501 #ifdeà
__USE_XOPEN2K


503 
	$posix_mem®ign
 (**
__mem±r
, 
size_t
 
__®ignm’t
, size_ˆ
__size
)

504 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

507 #ifdeà
__USE_ISOC11


509 *
	$®igÃd_®loc
 (
size_t
 
__®ignm’t
, size_ˆ
__size
)

510 
__THROW
 
__©Œibu‹_m®loc__
 
	`__©Œibu‹_®loc_size__
 ((2)è
__wur
;

513 
__BEGIN_NAMESPACE_STD


515 
	$abÜt
 (è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

519 
	$©ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

521 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


523 #ifdeà
__ılu¥lus


524 "C++" 
	$©_quick_ex™
 ((*
__func
) ())

525 
__THROW
 
	`__asm
 ("©_quick_ex™"è
	`__nÚnuÎ
 ((1));

527 
	$©_quick_ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

530 
__END_NAMESPACE_STD


532 #ifdef 
__USE_MISC


535 
	$Ú_ex™
 ((*
__func
è(
__¡©us
, *
__¬g
), *__arg)

536 
__THROW
 
	`__nÚnuÎ
 ((1));

539 
__BEGIN_NAMESPACE_STD


543 
	$ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

545 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


549 
	$quick_ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

551 
__END_NAMESPACE_STD


553 #ifdeà
__USE_ISOC99


554 
__BEGIN_NAMESPACE_C99


557 
	$_Ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

558 
__END_NAMESPACE_C99


562 
__BEGIN_NAMESPACE_STD


564 *
	$g‘’v
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

565 
__END_NAMESPACE_STD


567 #ifdeà
__USE_GNU


570 *
	$£cu»_g‘’v
 (cÚ¡ *
__Çme
)

571 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

574 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


578 
	$pu‹nv
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

581 #ifdeà
__USE_XOPEN2K


584 
	$£‹nv
 (cÚ¡ *
__Çme
, cÚ¡ *
__v®ue
, 
__»¶aû
)

585 
__THROW
 
	`__nÚnuÎ
 ((2));

588 
	$un£‹nv
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

591 #ifdef 
__USE_MISC


595 
	$ş—»nv
 (è
__THROW
;

599 #ià
defšed
 
__USE_MISC
 \

600 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
)

606 *
	$mk‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1));

609 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


618 #iâdeà
__USE_FILE_OFFSET64


619 
	$mk¡emp
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

621 #ifdeà
__REDIRECT


622 
	`__REDIRECT
 (
mk¡emp
, (*
__‹m¶©e
), 
mk¡emp64
)

623 
	`__nÚnuÎ
 ((1)è
__wur
;

625 
	#mk¡emp
 
mk¡emp64


	)

628 #ifdeà
__USE_LARGEFILE64


629 
	$mk¡emp64
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

633 #ifdeà
__USE_MISC


640 #iâdeà
__USE_FILE_OFFSET64


641 
	$mk¡emps
 (*
__‹m¶©e
, 
__suffixËn
è
	`__nÚnuÎ
 ((1)è
__wur
;

643 #ifdeà
__REDIRECT


644 
	`__REDIRECT
 (
mk¡emps
, (*
__‹m¶©e
, 
__suffixËn
),

645 
mk¡emps64
è
	`__nÚnuÎ
 ((1)è
__wur
;

647 
	#mk¡emps
 
mk¡emps64


	)

650 #ifdeà
__USE_LARGEFILE64


651 
	$mk¡emps64
 (*
__‹m¶©e
, 
__suffixËn
)

652 
	`__nÚnuÎ
 ((1)è
__wur
;

656 #ifdeà
__USE_XOPEN2K8


662 *
	$mkd‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

665 #ifdeà
__USE_GNU


672 #iâdeà
__USE_FILE_OFFSET64


673 
	$mko¡emp
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

675 #ifdeà
__REDIRECT


676 
	`__REDIRECT
 (
mko¡emp
, (*
__‹m¶©e
, 
__æags
), 
mko¡emp64
)

677 
	`__nÚnuÎ
 ((1)è
__wur
;

679 
	#mko¡emp
 
mko¡emp64


	)

682 #ifdeà
__USE_LARGEFILE64


683 
	$mko¡emp64
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

692 #iâdeà
__USE_FILE_OFFSET64


693 
	$mko¡emps
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

694 
	`__nÚnuÎ
 ((1)è
__wur
;

696 #ifdeà
__REDIRECT


697 
	`__REDIRECT
 (
mko¡emps
, (*
__‹m¶©e
, 
__suffixËn
,

698 
__æags
), 
mko¡emps64
)

699 
	`__nÚnuÎ
 ((1)è
__wur
;

701 
	#mko¡emps
 
mko¡emps64


	)

704 #ifdeà
__USE_LARGEFILE64


705 
	$mko¡emps64
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

706 
	`__nÚnuÎ
 ((1)è
__wur
;

711 
__BEGIN_NAMESPACE_STD


716 
	$sy¡em
 (cÚ¡ *
__commªd
è
__wur
;

717 
__END_NAMESPACE_STD


720 #ifdef 
__USE_GNU


723 *
	$ÿnÚiÿlize_fe_Çme
 (cÚ¡ *
__Çme
)

724 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

727 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


733 *
	$»®·th
 (cÚ¡ *
__»¡riù
 
__Çme
,

734 *
__»¡riù
 
__»sŞved
è
__THROW
 
__wur
;

739 #iâdeà
__COMPAR_FN_T


740 
	#__COMPAR_FN_T


	)

741 (*
	t__com·r_â_t
) (const *, const *);

743 #ifdef 
__USE_GNU


744 
__com·r_â_t
 
	tcom·risÚ_â_t
;

747 #ifdeà
__USE_GNU


748 (*
	t__com·r_d_â_t
) (const *, const *, *);

751 
__BEGIN_NAMESPACE_STD


754 *
	$b£¬ch
 (cÚ¡ *
__key
, cÚ¡ *
__ba£
,

755 
size_t
 
__nmemb
, size_ˆ
__size
, 
__com·r_â_t
 
__com·r
)

756 
	`__nÚnuÎ
 ((1, 2, 5)è
__wur
;

758 #ifdeà
__USE_EXTERN_INLINES


759 
	~<b™s/¡dlib-b£¬ch.h
>

764 
	$qsÜt
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

765 
__com·r_â_t
 
__com·r
è
	`__nÚnuÎ
 ((1, 4));

766 #ifdeà
__USE_GNU


767 
	$qsÜt_r
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

768 
__com·r_d_â_t
 
__com·r
, *
__¬g
)

769 
	`__nÚnuÎ
 ((1, 4));

774 
	$abs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

775 
	$Ïbs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

776 
__END_NAMESPACE_STD


778 #ifdeà
__USE_ISOC99


779 
__ex‹nsiÚ__
 
	$Îabs
 (
__x
)

780 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

784 
__BEGIN_NAMESPACE_STD


788 
div_t
 
	$div
 (
__num”
, 
__d’om
)

789 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

790 
ldiv_t
 
	$ldiv
 (
__num”
, 
__d’om
)

791 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

792 
__END_NAMESPACE_STD


794 #ifdeà
__USE_ISOC99


795 
__BEGIN_NAMESPACE_C99


796 
__ex‹nsiÚ__
 
Îdiv_t
 
	$Îdiv
 (
__num”
,

797 
__d’om
)

798 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

799 
__END_NAMESPACE_C99


803 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

804 || 
defšed
 
__USE_MISC


811 *
	$ecvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

812 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

817 *
	$fcvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

818 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

823 *
	$gcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

824 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

827 #ifdeà
__USE_MISC


829 *
	$qecvt
 (
__v®ue
, 
__ndig™
,

830 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

831 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

832 *
	$qfcvt
 (
__v®ue
, 
__ndig™
,

833 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

834 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

835 *
	$qgcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

836 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

841 
	$ecvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

842 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

843 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

844 
	$fcvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

845 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

846 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

848 
	$qecvt_r
 (
__v®ue
, 
__ndig™
,

849 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

850 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

851 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

852 
	$qfcvt_r
 (
__v®ue
, 
__ndig™
,

853 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

854 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

855 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

859 
__BEGIN_NAMESPACE_STD


862 
	$mbËn
 (cÚ¡ *
__s
, 
size_t
 
__n
è
__THROW
;

865 
	$mbtowc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

866 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

869 
	$wùomb
 (*
__s
, 
wch¬_t
 
__wch¬
è
__THROW
;

873 
size_t
 
	$mb¡owcs
 (
wch¬_t
 *
__»¡riù
 
__pwcs
,

874 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

876 
size_t
 
	$wc¡ombs
 (*
__»¡riù
 
__s
,

877 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__pwcs
, 
size_t
 
__n
)

878 
__THROW
;

879 
__END_NAMESPACE_STD


882 #ifdeà
__USE_MISC


887 
	$½m©ch
 (cÚ¡ *
__»¥Ú£
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

891 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


898 
	$g‘subİt
 (**
__»¡riù
 
__İtiÚp
,

899 *cÚ¡ *
__»¡riù
 
__tok’s
,

900 **
__»¡riù
 
__v®u•
)

901 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3)è
__wur
;

905 #ifdeà
__USE_XOPEN


907 
	$£tkey
 (cÚ¡ *
__key
è
__THROW
 
	`__nÚnuÎ
 ((1));

913 #ifdeà
__USE_XOPEN2KXSI


915 
	$posix_İ’±
 (
__oæag
è
__wur
;

918 #ifdeà
__USE_XOPEN


923 
	$g¿Á±
 (
__fd
è
__THROW
;

927 
	$uÆock±
 (
__fd
è
__THROW
;

932 *
	$±¢ame
 (
__fd
è
__THROW
 
__wur
;

935 #ifdeà
__USE_GNU


939 
	$±¢ame_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

940 
__THROW
 
	`__nÚnuÎ
 ((2));

943 
	`g‘±
 ();

946 #ifdeà
__USE_MISC


950 
	$g‘lßdavg
 (
__lßdavg
[], 
__ÃËm
)

951 
__THROW
 
	`__nÚnuÎ
 ((1));

954 
	~<b™s/¡dlib-æßt.h
>

957 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


958 
	~<b™s/¡dlib.h
>

960 #ifdeà
__LDBL_COMPAT


961 
	~<b™s/¡dlib-ldbl.h
>

965 #undeà
__Ãed_m®loc_ªd_ÿÎoc


967 
__END_DECLS


	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


30 
	#__Ãed_size_t


	)

31 
	#__Ãed_NULL


	)

32 
	~<¡ddef.h
>

35 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

36 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

40 
__BEGIN_NAMESPACE_STD


42 *
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

43 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

46 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

47 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

48 
__END_NAMESPACE_STD


53 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


54 *
	$memcıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

60 
__BEGIN_NAMESPACE_STD


62 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

65 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

66 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

69 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


72 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

73 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

74 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

75 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

77 #ifdeà
__OPTIMIZE__


78 
__ex‹º_®ways_šlše
 *

79 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


81  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

84 
__ex‹º_®ways_šlše
 const *

85 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


87  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

90 
	}
}

92 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

93 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

95 
__END_NAMESPACE_STD


97 #ifdeà
__USE_GNU


100 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


101 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

102 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

103 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

104 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

106 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

107 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

111 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


112 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

113 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

114 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

115 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

117 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

118 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

123 
__BEGIN_NAMESPACE_STD


125 *
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

126 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

128 *
	$¡ºıy
 (*
__»¡riù
 
__de¡
,

129 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

130 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

133 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

134 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

136 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

137 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

140 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

141 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

143 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

144 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

147 
	$¡rcŞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

148 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

150 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

151 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

152 
__THROW
 
	`__nÚnuÎ
 ((2));

153 
__END_NAMESPACE_STD


155 #ifdeà
__USE_XOPEN2K8


159 
	~<xloÿË.h
>

162 
	$¡rcŞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
__loÿË_t
 
__l
)

163 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

165 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

166 
__loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

169 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


171 *
	$¡rdup
 (cÚ¡ *
__s
)

172 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

178 #ià
defšed
 
__USE_XOPEN2K8


179 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

180 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

183 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


185 
	#¡rdu·
(
s
) \

186 (
__ex‹nsiÚ__
 \

188 cÚ¡ *
__Şd
 = (
s
); \

189 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Şd
) + 1; \

190 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
); \

191 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

192 
	}
}))

	)

195 
	#¡ºdu·
(
s
, 
n
) \

196 (
__ex‹nsiÚ__
 \

198 cÚ¡ *
__Şd
 = (
s
); \

199 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Şd
, (
n
)); \

200 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
 + 1); \

201 
__Ãw
[
__Ën
] = '\0'; \

202 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

203 }))

	)

206 
	g__BEGIN_NAMESPACE_STD


208 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


211 *
¡rchr
 (*
__s
, 
__c
)

212 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

213 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

214 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

216 #ifdeà
__OPTIMIZE__


217 
__ex‹º_®ways_šlše
 *

218 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


220  
__butš_¡rchr
 (
__s
, 
__c
);

223 
__ex‹º_®ways_šlše
 const *

224 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


226  
__butš_¡rchr
 (
__s
, 
__c
);

231 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

232 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

235 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


238 *
	`¡¼chr
 (*
__s
, 
__c
)

239 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

240 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

241 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

243 #ifdeà
__OPTIMIZE__


244 
__ex‹º_®ways_šlše
 *

245 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


247  
	`__butš_¡¼chr
 (
__s
, 
__c
);

250 
__ex‹º_®ways_šlše
 const *

251 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


253  
	`__butš_¡¼chr
 (
__s
, 
__c
);

256 
	}
}

258 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

259 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

261 
__END_NAMESPACE_STD


263 #ifdeà
__USE_GNU


266 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


267 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

268 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

269 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

270 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

272 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

273 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

277 
__BEGIN_NAMESPACE_STD


280 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

281 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

284 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

285 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

287 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


290 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

291 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

292 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

293 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

295 #ifdeà
__OPTIMIZE__


296 
__ex‹º_®ways_šlše
 *

297 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


299  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

302 
__ex‹º_®ways_šlše
 const *

303 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


305  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

308 
	}
}

310 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

311 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

314 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


317 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

318 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

319 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

320 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

322 #ifdeà
__OPTIMIZE__


323 
__ex‹º_®ways_šlše
 *

324 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


326  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

329 
__ex‹º_®ways_šlše
 const *

330 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


332  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

335 
	}
}

337 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

338 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

343 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

344 
__THROW
 
	`__nÚnuÎ
 ((2));

345 
__END_NAMESPACE_STD


349 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

350 cÚ¡ *
__»¡riù
 
__d–im
,

351 **
__»¡riù
 
__§ve_±r
)

352 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

353 #ifdeà
__USE_POSIX


354 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

355 **
__»¡riù
 
__§ve_±r
)

356 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

359 #ifdeà
__USE_GNU


361 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


362 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

363 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

364 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

365 cÚ¡ *
__ÃedË
)

366 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

368 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

369 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

373 #ifdeà
__USE_GNU


377 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

378 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

379 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

383 *
	$__mempıy
 (*
__»¡riù
 
__de¡
,

384 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

385 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

386 *
	$mempıy
 (*
__»¡riù
 
__de¡
,

387 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

388 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

392 
__BEGIN_NAMESPACE_STD


394 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

395 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

396 
__END_NAMESPACE_STD


398 #ifdef 
__USE_XOPEN2K8


401 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

402 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

406 
__BEGIN_NAMESPACE_STD


408 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

409 
__END_NAMESPACE_STD


410 #ifdeà
__USE_XOPEN2K


418 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


421 #ifdeà
__REDIRECT_NTH


422 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

423 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

424 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

426 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

427 
__THROW
 
	`__nÚnuÎ
 ((2));

428 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

433 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

434 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

438 #ifdeà
__USE_XOPEN2K8


440 *
	$¡»¼Ü_l
 (
__”ºum
, 
__loÿË_t
 
__l
è
__THROW
;

446 
	$__bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

448 #ifdeà
__USE_MISC


450 
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

451 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

454 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

457 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

458 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

461 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


464 *
	`šdex
 (*
__s
, 
__c
)

465 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

466 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

467 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

469 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


470 
__ex‹º_®ways_šlše
 *

471 
	`šdex
 (*
__s
, 
__c
è
__THROW


473  
	`__butš_šdex
 (
__s
, 
__c
);

476 
__ex‹º_®ways_šlše
 const *

477 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


479  
	`__butš_šdex
 (
__s
, 
__c
);

482 
	}
}

484 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

485 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

489 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


492 *
	`ršdex
 (*
__s
, 
__c
)

493 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

494 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

495 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

497 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


498 
__ex‹º_®ways_šlše
 *

499 
	`ršdex
 (*
__s
, 
__c
è
__THROW


501  
	`__butš_ršdex
 (
__s
, 
__c
);

504 
__ex‹º_®ways_šlše
 const *

505 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


507  
	`__butš_ršdex
 (
__s
, 
__c
);

510 
	}
}

512 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

513 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

518 
	$ffs
 (
__i
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

522 #ifdef 
__USE_GNU


523 
	$ff¦
 (
__l
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

524 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

525 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

529 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

530 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

533 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

534 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

537 #ifdef 
__USE_GNU


540 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

541 
__loÿË_t
 
__loc
)

542 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

544 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

545 
size_t
 
__n
, 
__loÿË_t
 
__loc
)

546 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

549 #ifdef 
__USE_MISC


552 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

553 cÚ¡ *
__»¡riù
 
__d–im
)

554 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

557 #ifdef 
__USE_XOPEN2K8


559 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

562 *
	$__¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

563 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

564 *
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

565 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

569 *
	$__¡²ıy
 (*
__»¡riù
 
__de¡
,

570 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

571 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

572 *
	$¡²ıy
 (*
__»¡riù
 
__de¡
,

573 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

574 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

577 #ifdef 
__USE_GNU


579 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

580 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

583 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

586 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

588 #iâdeà
ba£Çme


593 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


594 "C++" *
	$ba£Çme
 (*
__f’ame
)

595 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

596 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__f’ame
)

597 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

599 *
	$ba£Çme
 (cÚ¡ *
__f’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

605 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

606 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__OPTIMIZE_SIZE__
 \

607 && !
defšed
 
__NO_INLINE__
 && !defšed 
__ılu¥lus


627 
	~<b™s/¡ršg.h
>

630 
	~<b™s/¡ršg2.h
>

633 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


635 
	~<b™s/¡ršg3.h
>

639 #ià
defšed
 
__USE_GNU
 && defšed 
__OPTIMIZE__
 \

640 && 
defšed
 
__ex‹º_®ways_šlše
 && 
	$__GNUC_PREREQ
 (3,2)

641 #ià!
defšed
 
_FORCE_INLINES
 && !defšed 
_HAVE_STRING_ARCH_mempıy


643 #undeà
mempıy


644 #undeà
__mempıy


645 
	#mempıy
(
de¡
, 
¤c
, 
n
è
	`__mempıy_šlše
 (de¡, src,‚)

	)

646 
	#__mempıy
(
de¡
, 
¤c
, 
n
è
	`__mempıy_šlše
 (de¡, src,‚)

	)

648 
__ex‹º_®ways_šlše
 *

649 
	$__mempıy_šlše
 (*
__»¡riù
 
__de¡
,

650 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

652  (*è
	`memıy
 (
__de¡
, 
__¤c
, 
__n
) + __n;

653 
	}
}

658 
	g__END_DECLS


	@/usr/include/time.h

22 #iâdef 
_TIME_H


24 #ià(! 
defšed
 
__Ãed_time_t
 && !defšed 
__Ãed_şock_t
 && \

25 ! 
defšed
 
	g__Ãed_time¥ec
)

26 
	#_TIME_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	g__BEGIN_DECLS


33 #ifdef 
_TIME_H


35 
	#__Ãed_size_t


	)

36 
	#__Ãed_NULL


	)

37 
	~<¡ddef.h
>

41 
	~<b™s/time.h
>

44 #ià!
defšed
 
__STRICT_ANSI__
 && !defšed 
__USE_XOPEN2K


45 #iâdeà
CLK_TCK


46 
	#CLK_TCK
 
CLOCKS_PER_SEC


	)

52 #ià!
defšed
 
__şock_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_şock_t
)

53 
	#__şock_t_defšed
 1

	)

55 
	~<b™s/ty³s.h
>

57 
__BEGIN_NAMESPACE_STD


59 
__şock_t
 
	tşock_t
;

60 
	g__END_NAMESPACE_STD


61 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX


62 
	$__USING_NAMESPACE_STD
(
şock_t
)

66 #undeà
__Ãed_şock_t


68 #ià!
defšed
 
__time_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_time_t
)

69 
	#__time_t_defšed
 1

	)

71 
	~<b™s/ty³s.h
>

73 
__BEGIN_NAMESPACE_STD


75 
__time_t
 
	ttime_t
;

76 
__END_NAMESPACE_STD


77 #ifdeà
__USE_POSIX


78 
	$__USING_NAMESPACE_STD
(
time_t
)

82 #undeà
__Ãed_time_t


84 #ià!
defšed
 
__şockid_t_defšed
 && \

85 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_şockid_t
)

86 
	#__şockid_t_defšed
 1

	)

88 
	~<b™s/ty³s.h
>

91 
__şockid_t
 
	tşockid_t
;

94 #undeà
__şockid_time_t


96 #ià!
defšed
 
__tim”_t_defšed
 && \

97 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_tim”_t
)

98 
	#__tim”_t_defšed
 1

	)

100 
	~<b™s/ty³s.h
>

103 
__tim”_t
 
	ttim”_t
;

106 #undeà
__Ãed_tim”_t


109 #ià(!
defšed
 
__time¥ec_defšed
 \

110 && ((
defšed
 
_TIME_H
 \

111 && (
defšed
 
__USE_POSIX199309
 \

112 || 
defšed
 
__USE_ISOC11
)) \

113 || 
defšed
 
__Ãed_time¥ec
))

114 
	#__time¥ec_defšed
 1

	)

116 
	~<b™s/ty³s.h
>

120 
	stime¥ec


122 
__time_t
 
tv_£c
;

123 
__sysÿÎ_¦Úg_t
 
tv_n£c
;

127 #undeà
__Ãed_time¥ec


130 #ifdef 
_TIME_H


131 
__BEGIN_NAMESPACE_STD


133 
	stm


135 
tm_£c
;

136 
tm_mš
;

137 
tm_hour
;

138 
tm_mday
;

139 
tm_mÚ
;

140 
tm_y—r
;

141 
tm_wday
;

142 
tm_yday
;

143 
tm_isd¡
;

145 #ifdef 
__USE_MISC


146 
tm_gmtoff
;

147 cÚ¡ *
tm_zÚe
;

149 
__tm_gmtoff
;

150 cÚ¡ *
__tm_zÚe
;

153 
__END_NAMESPACE_STD


154 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX


155 
	$__USING_NAMESPACE_STD
(
tm
)

159 #ifdeà
__USE_POSIX199309


161 
	s™im”¥ec


163 
time¥ec
 
™_š‹rv®
;

164 
time¥ec
 
™_v®ue
;

168 
sigev’t
;

172 #ifdeà
__USE_XOPEN2K


173 #iâdeà
__pid_t_defšed


174 
__pid_t
 
	tpid_t
;

175 
	#__pid_t_defšed


	)

180 #ifdeà
__USE_ISOC11


182 
	#TIME_UTC
 1

	)

186 
__BEGIN_NAMESPACE_STD


189 
şock_t
 
	$şock
 (è
__THROW
;

192 
time_t
 
	$time
 (
time_t
 *
__tim”
è
__THROW
;

195 
	$difáime
 (
time_t
 
__time1
,ime_ˆ
__time0
)

196 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

199 
time_t
 
	$mktime
 (
tm
 *
__
è
__THROW
;

205 
size_t
 
	$¡ráime
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

206 cÚ¡ *
__»¡riù
 
__fÜm©
,

207 cÚ¡ 
tm
 *
__»¡riù
 
__
è
__THROW
;

208 
__END_NAMESPACE_STD


210 #ifdeà
__USE_XOPEN


213 *
	$¡½time
 (cÚ¡ *
__»¡riù
 
__s
,

214 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
)

215 
__THROW
;

218 #ifdeà
__USE_XOPEN2K8


221 
	~<xloÿË.h
>

223 
size_t
 
	$¡ráime_l
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

224 cÚ¡ *
__»¡riù
 
__fÜm©
,

225 cÚ¡ 
tm
 *
__»¡riù
 
__
,

226 
__loÿË_t
 
__loc
è
__THROW
;

229 #ifdeà
__USE_GNU


230 *
	$¡½time_l
 (cÚ¡ *
__»¡riù
 
__s
,

231 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
,

232 
__loÿË_t
 
__loc
è
__THROW
;

236 
__BEGIN_NAMESPACE_STD


239 
tm
 *
	$gmtime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

243 
tm
 *
	$loÿÉime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

244 
__END_NAMESPACE_STD


246 #ifdeà
__USE_POSIX


249 
tm
 *
	$gmtime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

250 
tm
 *
__»¡riù
 
__
è
__THROW
;

254 
tm
 *
	$loÿÉime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

255 
tm
 *
__»¡riù
 
__
è
__THROW
;

258 
__BEGIN_NAMESPACE_STD


261 *
	$asùime
 (cÚ¡ 
tm
 *
__
è
__THROW
;

264 *
	$ùime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

265 
__END_NAMESPACE_STD


267 #ifdeà
__USE_POSIX


272 *
	$asùime_r
 (cÚ¡ 
tm
 *
__»¡riù
 
__
,

273 *
__»¡riù
 
__buf
è
__THROW
;

276 *
	$ùime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

277 *
__»¡riù
 
__buf
è
__THROW
;

282 *
__tzÇme
[2];

283 
__daylight
;

284 
__timezÚe
;

287 #ifdef 
__USE_POSIX


289 *
tzÇme
[2];

293 
	$tz£t
 (è
__THROW
;

296 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


297 
daylight
;

298 
timezÚe
;

301 #ifdeà
__USE_MISC


304 
	$¡ime
 (cÚ¡ 
time_t
 *
__wh’
è
__THROW
;

310 
	#__i¦—p
(
y—r
) \

311 ((
y—r
è% 4 =ğ0 && ((y—rè% 100 !ğ0 || (y—rè% 400 =ğ0))

	)

314 #ifdeà
__USE_MISC


319 
time_t
 
	$timegm
 (
tm
 *
__
è
__THROW
;

322 
time_t
 
	$tim–oÿl
 (
tm
 *
__
è
__THROW
;

325 
	$dysize
 (
__y—r
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

329 #ifdeà
__USE_POSIX199309


334 
	`Çno¦“p
 (cÚ¡ 
time¥ec
 *
__»que¡ed_time
,

335 
time¥ec
 *
__»maššg
);

339 
	$şock_g‘»s
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__»s
è
__THROW
;

342 
	$şock_g‘time
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__
è
__THROW
;

345 
	$şock_£‰ime
 (
şockid_t
 
__şock_id
, cÚ¡ 
time¥ec
 *
__
)

346 
__THROW
;

348 #ifdeà
__USE_XOPEN2K


353 
	`şock_Çno¦“p
 (
şockid_t
 
__şock_id
, 
__æags
,

354 cÚ¡ 
time¥ec
 *
__»q
,

355 
time¥ec
 *
__»m
);

358 
	$şock_g‘ıuşockid
 (
pid_t
 
__pid
, 
şockid_t
 *
__şock_id
è
__THROW
;

363 
	$tim”_ü—‹
 (
şockid_t
 
__şock_id
,

364 
sigev’t
 *
__»¡riù
 
__evp
,

365 
tim”_t
 *
__»¡riù
 
__tim”id
è
__THROW
;

368 
	$tim”_d–‘e
 (
tim”_t
 
__tim”id
è
__THROW
;

371 
	$tim”_£‰ime
 (
tim”_t
 
__tim”id
, 
__æags
,

372 cÚ¡ 
™im”¥ec
 *
__»¡riù
 
__v®ue
,

373 
™im”¥ec
 *
__»¡riù
 
__ov®ue
è
__THROW
;

376 
	$tim”_g‘time
 (
tim”_t
 
__tim”id
, 
™im”¥ec
 *
__v®ue
)

377 
__THROW
;

380 
	$tim”_g‘ov”run
 (
tim”_t
 
__tim”id
è
__THROW
;

384 #ifdeà
__USE_ISOC11


386 
	$time¥ec_g‘
 (
time¥ec
 *
__ts
, 
__ba£
)

387 
__THROW
 
	`__nÚnuÎ
 ((1));

391 #ifdeà
__USE_XOPEN_EXTENDED


403 
g‘d©e_”r
;

412 
tm
 *
	`g‘d©e
 (cÚ¡ *
__¡ršg
);

415 #ifdeà
__USE_GNU


426 
	`g‘d©e_r
 (cÚ¡ *
__»¡riù
 
__¡ršg
,

427 
tm
 *
__»¡riù
 
__»sbuå
);

430 
__END_DECLS


	@/usr/include/unistd.h

22 #iâdef 
_UNISTD_H


23 
	#_UNISTD_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


32 #ifdeà
__USE_XOPEN2K8


34 
	#_POSIX_VERSION
 200809L

	)

35 #–ià
defšed
 
__USE_XOPEN2K


37 
	#_POSIX_VERSION
 200112L

	)

38 #–ià
defšed
 
__USE_POSIX199506


40 
	#_POSIX_VERSION
 199506L

	)

41 #–ià
defšed
 
__USE_POSIX199309


43 
	#_POSIX_VERSION
 199309L

	)

46 
	#_POSIX_VERSION
 199009L

	)

52 #ifdeà
__USE_XOPEN2K8


53 
	#__POSIX2_THIS_VERSION
 200809L

	)

55 #–ià
defšed
 
__USE_XOPEN2K


57 
	#__POSIX2_THIS_VERSION
 200112L

	)

58 #–ià
defšed
 
__USE_POSIX199506


60 
	#__POSIX2_THIS_VERSION
 199506L

	)

63 
	#__POSIX2_THIS_VERSION
 199209L

	)

67 
	#_POSIX2_VERSION
 
__POSIX2_THIS_VERSION


	)

70 
	#_POSIX2_C_VERSION
 
__POSIX2_THIS_VERSION


	)

74 
	#_POSIX2_C_BIND
 
__POSIX2_THIS_VERSION


	)

78 
	#_POSIX2_C_DEV
 
__POSIX2_THIS_VERSION


	)

82 
	#_POSIX2_SW_DEV
 
__POSIX2_THIS_VERSION


	)

86 
	#_POSIX2_LOCALEDEF
 
__POSIX2_THIS_VERSION


	)

89 #ifdeà
__USE_XOPEN2K8


90 
	#_XOPEN_VERSION
 700

	)

91 #–ià
defšed
 
__USE_XOPEN2K


92 
	#_XOPEN_VERSION
 600

	)

93 #–ià
defšed
 
__USE_UNIX98


94 
	#_XOPEN_VERSION
 500

	)

96 
	#_XOPEN_VERSION
 4

	)

100 
	#_XOPEN_XCU_VERSION
 4

	)

103 
	#_XOPEN_XPG2
 1

	)

104 
	#_XOPEN_XPG3
 1

	)

105 
	#_XOPEN_XPG4
 1

	)

108 
	#_XOPEN_UNIX
 1

	)

111 
	#_XOPEN_CRYPT
 1

	)

115 
	#_XOPEN_ENH_I18N
 1

	)

118 
	#_XOPEN_LEGACY
 1

	)

205 
	~<b™s/posix_İt.h
>

208 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


209 
	~<b™s/’vœÚm’ts.h
>

213 
	#STDIN_FILENO
 0

	)

214 
	#STDOUT_FILENO
 1

	)

215 
	#STDERR_FILENO
 2

	)

220 
	~<b™s/ty³s.h
>

222 #iâdef 
__ssize_t_defšed


223 
__ssize_t
 
	tssize_t
;

224 
	#__ssize_t_defšed


	)

227 
	#__Ãed_size_t


	)

228 
	#__Ãed_NULL


	)

229 
	~<¡ddef.h
>

231 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


234 #iâdeà
__gid_t_defšed


235 
__gid_t
 
	tgid_t
;

236 
	#__gid_t_defšed


	)

239 #iâdeà
__uid_t_defšed


240 
__uid_t
 
	tuid_t
;

241 
	#__uid_t_defšed


	)

244 #iâdeà
__off_t_defšed


245 #iâdeà
__USE_FILE_OFFSET64


246 
__off_t
 
	toff_t
;

248 
__off64_t
 
	toff_t
;

250 
	#__off_t_defšed


	)

252 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


253 
__off64_t
 
	toff64_t
;

254 
	#__off64_t_defšed


	)

257 #iâdeà
__u£cÚds_t_defšed


258 
__u£cÚds_t
 
	tu£cÚds_t
;

259 
	#__u£cÚds_t_defšed


	)

262 #iâdeà
__pid_t_defšed


263 
__pid_t
 
	tpid_t
;

264 
	#__pid_t_defšed


	)

268 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


269 #iâdeà
__šŒ_t_defšed


270 
__šŒ_t
 
	tšŒ_t
;

271 
	#__šŒ_t_defšed


	)

275 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


276 #iâdeà
__sockËn_t_defšed


277 
__sockËn_t
 
	tsockËn_t
;

278 
	#__sockËn_t_defšed


	)

284 
	#R_OK
 4

	)

285 
	#W_OK
 2

	)

286 
	#X_OK
 1

	)

287 
	#F_OK
 0

	)

290 
	$acûss
 (cÚ¡ *
__Çme
, 
__ty³
è
__THROW
 
	`__nÚnuÎ
 ((1));

292 #ifdeà
__USE_GNU


295 
	$euidacûss
 (cÚ¡ *
__Çme
, 
__ty³
)

296 
__THROW
 
	`__nÚnuÎ
 ((1));

299 
	$—cûss
 (cÚ¡ *
__Çme
, 
__ty³
)

300 
__THROW
 
	`__nÚnuÎ
 ((1));

303 #ifdeà
__USE_ATFILE


307 
	$çcûs§t
 (
__fd
, cÚ¡ *
__fe
, 
__ty³
, 
__æag
)

308 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

313 #iâdef 
_STDIO_H


314 
	#SEEK_SET
 0

	)

315 
	#SEEK_CUR
 1

	)

316 
	#SEEK_END
 2

	)

317 #ifdeà
__USE_GNU


318 
	#SEEK_DATA
 3

	)

319 
	#SEEK_HOLE
 4

	)

323 #ià
defšed
 
__USE_MISC
 && !defšed 
L_SET


325 
	#L_SET
 
SEEK_SET


	)

326 
	#L_INCR
 
SEEK_CUR


	)

327 
	#L_XTND
 
SEEK_END


	)

336 #iâdeà
__USE_FILE_OFFSET64


337 
__off_t
 
	$l£ek
 (
__fd
, 
__off_t
 
__off£t
, 
__wh’û
è
__THROW
;

339 #ifdeà
__REDIRECT_NTH


340 
__off64_t
 
	`__REDIRECT_NTH
 (
l£ek
,

341 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
),

342 
l£ek64
);

344 
	#l£ek
 
l£ek64


	)

347 #ifdeà
__USE_LARGEFILE64


348 
__off64_t
 
	$l£ek64
 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
)

349 
__THROW
;

356 
	`şo£
 (
__fd
);

363 
ssize_t
 
	$»ad
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
è
__wur
;

369 
ssize_t
 
	$wr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
è
__wur
;

371 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


372 #iâdeà
__USE_FILE_OFFSET64


379 
ssize_t
 
	$´—d
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

380 
__off_t
 
__off£t
è
__wur
;

387 
ssize_t
 
	$pwr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

388 
__off_t
 
__off£t
è
__wur
;

390 #ifdeà
__REDIRECT


391 
ssize_t
 
	`__REDIRECT
 (
´—d
, (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

392 
__off64_t
 
__off£t
),

393 
´—d64
è
__wur
;

394 
ssize_t
 
	`__REDIRECT
 (
pwr™e
, (
__fd
, cÚ¡ *
__buf
,

395 
size_t
 
__nby‹s
, 
__off64_t
 
__off£t
),

396 
pwr™e64
è
__wur
;

398 
	#´—d
 
´—d64


	)

399 
	#pwr™e
 
pwr™e64


	)

403 #ifdeà
__USE_LARGEFILE64


407 
ssize_t
 
	$´—d64
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

408 
__off64_t
 
__off£t
è
__wur
;

411 
ssize_t
 
	$pwr™e64
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

412 
__off64_t
 
__off£t
è
__wur
;

420 
	$pe
 (
__pedes
[2]è
__THROW
 
__wur
;

422 #ifdeà
__USE_GNU


425 
	$pe2
 (
__pedes
[2], 
__æags
è
__THROW
 
__wur
;

435 
	$®¬m
 (
__£cÚds
è
__THROW
;

447 
	`¦“p
 (
__£cÚds
);

449 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

450 || 
defšed
 
__USE_MISC


455 
__u£cÚds_t
 
	$u®¬m
 (
__u£cÚds_t
 
__v®ue
, __u£cÚds_ˆ
__š‹rv®
)

456 
__THROW
;

463 
	`u¦“p
 (
__u£cÚds_t
 
__u£cÚds
);

472 
	`·u£
 ();

476 
	$chown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

477 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

479 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


481 
	$fchown
 (
__fd
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
è
__THROW
 
__wur
;

486 
	$lchown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

487 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

491 #ifdeà
__USE_ATFILE


494 
	$fchowÇt
 (
__fd
, cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
,

495 
__gid_t
 
__group
, 
__æag
)

496 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

500 
	$chdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

502 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


504 
	$fchdœ
 (
__fd
è
__THROW
 
__wur
;

514 *
	$g‘cwd
 (*
__buf
, 
size_t
 
__size
è
__THROW
 
__wur
;

516 #ifdef 
__USE_GNU


520 *
	$g‘_cu¼’t_dœ_Çme
 (è
__THROW
;

523 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

524 || 
defšed
 
__USE_MISC


528 *
	$g‘wd
 (*
__buf
)

529 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
 
__wur
;

534 
	$dup
 (
__fd
è
__THROW
 
__wur
;

537 
	$dup2
 (
__fd
, 
__fd2
è
__THROW
;

539 #ifdeà
__USE_GNU


542 
	$dup3
 (
__fd
, 
__fd2
, 
__æags
è
__THROW
;

546 **
__’vœÚ
;

547 #ifdeà
__USE_GNU


548 **
’vœÚ
;

554 
	$execve
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[],

555 *cÚ¡ 
__’vp
[]è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

557 #ifdeà
__USE_XOPEN2K8


560 
	$ãxecve
 (
__fd
, *cÚ¡ 
__¬gv
[], *cÚ¡ 
__’vp
[])

561 
__THROW
 
	`__nÚnuÎ
 ((2));

566 
	$execv
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[])

567 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

571 
	$exeşe
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

572 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

576 
	$exeş
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

577 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

581 
	$execvp
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[])

582 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

587 
	$exeşp
 (cÚ¡ *
__fe
, cÚ¡ *
__¬g
, ...)

588 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

590 #ifdeà
__USE_GNU


593 
	$execv³
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[],

594 *cÚ¡ 
__’vp
[])

595 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

599 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


601 
	$niû
 (
__šc
è
__THROW
 
__wur
;

606 
	$_ex™
 (
__¡©us
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

612 
	~<b™s/cÚâame.h
>

615 
	$·thcÚf
 (cÚ¡ *
__·th
, 
__Çme
)

616 
__THROW
 
	`__nÚnuÎ
 ((1));

619 
	$å©hcÚf
 (
__fd
, 
__Çme
è
__THROW
;

622 
	$syscÚf
 (
__Çme
è
__THROW
;

624 #ifdef 
__USE_POSIX2


626 
size_t
 
	$cÚf¡r
 (
__Çme
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

631 
__pid_t
 
	$g‘pid
 (è
__THROW
;

634 
__pid_t
 
	$g‘µid
 (è
__THROW
;

637 
__pid_t
 
	$g‘pg½
 (è
__THROW
;

640 
__pid_t
 
	$__g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

641 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


642 
__pid_t
 
	$g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

649 
	$£gid
 (
__pid_t
 
__pid
, __pid_ˆ
__pgid
è
__THROW
;

651 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


663 
	$£g½
 (è
__THROW
;

670 
__pid_t
 
	$£tsid
 (è
__THROW
;

672 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


674 
__pid_t
 
	$g‘sid
 (
__pid_t
 
__pid
è
__THROW
;

678 
__uid_t
 
	$g‘uid
 (è
__THROW
;

681 
__uid_t
 
	$g‘euid
 (è
__THROW
;

684 
__gid_t
 
	$g‘gid
 (è
__THROW
;

687 
__gid_t
 
	$g‘egid
 (è
__THROW
;

692 
	$g‘groups
 (
__size
, 
__gid_t
 
__li¡
[]è
__THROW
 
__wur
;

694 #ifdef 
__USE_GNU


696 
	$group_memb”
 (
__gid_t
 
__gid
è
__THROW
;

703 
	$£tuid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

705 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


708 
	$£Œeuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
è
__THROW
 
__wur
;

711 #ifdeà
__USE_XOPEN2K


713 
	$£‹uid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

720 
	$£tgid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

722 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


725 
	$£Œegid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
è
__THROW
 
__wur
;

728 #ifdeà
__USE_XOPEN2K


730 
	$£‹gid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

733 #ifdeà
__USE_GNU


736 
	$g‘»suid
 (
__uid_t
 *
__ruid
, __uid_ˆ*
__euid
, __uid_ˆ*
__suid
)

737 
__THROW
;

741 
	$g‘»sgid
 (
__gid_t
 *
__rgid
, __gid_ˆ*
__egid
, __gid_ˆ*
__sgid
)

742 
__THROW
;

746 
	$£Œesuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
, __uid_ˆ
__suid
)

747 
__THROW
 
__wur
;

751 
	$£Œesgid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
, __gid_ˆ
__sgid
)

752 
__THROW
 
__wur
;

759 
__pid_t
 
	$fÜk
 (è
__THROWNL
;

761 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

762 || 
defšed
 
__USE_MISC


767 
__pid_t
 
	$vfÜk
 (è
__THROW
;

773 *
	$‰yÇme
 (
__fd
è
__THROW
;

777 
	$‰yÇme_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

778 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

782 
	$i§‰y
 (
__fd
è
__THROW
;

784 #ià
defšed
 
__USE_MISC
 \

785 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_UNIX98
)

788 
	$‰y¦Ù
 (è
__THROW
;

793 
	$lšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

794 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

796 #ifdeà
__USE_ATFILE


799 
	$lšk©
 (
__äomfd
, cÚ¡ *
__äom
, 
__tofd
,

800 cÚ¡ *
__to
, 
__æags
)

801 
__THROW
 
	`__nÚnuÎ
 ((2, 4)è
__wur
;

804 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


806 
	$symlšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

807 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

812 
ssize_t
 
	$»adlšk
 (cÚ¡ *
__»¡riù
 
__·th
,

813 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

814 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

817 #ifdeà
__USE_ATFILE


819 
	$symlšk©
 (cÚ¡ *
__äom
, 
__tofd
,

820 cÚ¡ *
__to
è
__THROW
 
	`__nÚnuÎ
 ((1, 3)è
__wur
;

823 
ssize_t
 
	$»adlšk©
 (
__fd
, cÚ¡ *
__»¡riù
 
__·th
,

824 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

825 
__THROW
 
	`__nÚnuÎ
 ((2, 3)è
__wur
;

829 
	$uÆšk
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

831 #ifdeà
__USE_ATFILE


833 
	$uÆšk©
 (
__fd
, cÚ¡ *
__Çme
, 
__æag
)

834 
__THROW
 
	`__nÚnuÎ
 ((2));

838 
	$rmdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1));

842 
__pid_t
 
	$tcg‘pg½
 (
__fd
è
__THROW
;

845 
	$tc£g½
 (
__fd
, 
__pid_t
 
__pg½_id
è
__THROW
;

852 *
	`g‘logš
 ();

853 #ià
defšed
 
__USE_REENTRANT
 || defšed 
__USE_POSIX199506


860 
	$g‘logš_r
 (*
__Çme
, 
size_t
 
__Çme_Ën
è
	`__nÚnuÎ
 ((1));

863 #ifdef 
__USE_MISC


865 
	$£ogš
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

869 #ifdef 
__USE_POSIX2


873 
	#__Ãed_g‘İt


	)

874 
	~<g‘İt.h
>

878 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


882 
	$g‘ho¡Çme
 (*
__Çme
, 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((1));

886 #ià
defšed
 
__USE_MISC


889 
	$£tho¡Çme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

890 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

894 
	$£tho¡id
 (
__id
è
__THROW
 
__wur
;

900 
	$g‘domašÇme
 (*
__Çme
, 
size_t
 
__Ën
)

901 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

902 
	$£tdomašÇme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

903 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

909 
	$vhªgup
 (è
__THROW
;

912 
	$»voke
 (cÚ¡ *
__fe
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

920 
	$´of
 (*
__§m¶e_bufãr
, 
size_t
 
__size
,

921 
size_t
 
__off£t
, 
__sÿË
)

922 
__THROW
 
	`__nÚnuÎ
 ((1));

928 
	$acù
 (cÚ¡ *
__Çme
è
__THROW
;

932 *
	$g‘u£rsh–l
 (è
__THROW
;

933 
	$’du£rsh–l
 (è
__THROW
;

934 
	$£tu£rsh–l
 (è
__THROW
;

940 
	$d«mÚ
 (
__nochdœ
, 
__noşo£
è
__THROW
 
__wur
;

944 #ià
defšed
 
__USE_MISC
 || (defšed 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

947 
	$chroÙ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

951 *
	$g‘·ss
 (cÚ¡ *
__´om±
è
	`__nÚnuÎ
 ((1));

959 
	`fsync
 (
__fd
);

962 #ifdeà
__USE_GNU


965 
	$syncfs
 (
__fd
è
__THROW
;

969 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


972 
	`g‘ho¡id
 ();

975 
	$sync
 (è
__THROW
;

978 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K


981 
	$g‘·gesize
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

986 
	$g‘dbËsize
 (è
__THROW
;

992 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


995 #iâdeà
__USE_FILE_OFFSET64


996 
	$Œunÿ‹
 (cÚ¡ *
__fe
, 
__off_t
 
__Ëngth
)

997 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

999 #ifdeà
__REDIRECT_NTH


1000 
	`__REDIRECT_NTH
 (
Œunÿ‹
,

1001 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
),

1002 
Œunÿ‹64
è
	`__nÚnuÎ
 ((1)è
__wur
;

1004 
	#Œunÿ‹
 
Œunÿ‹64


	)

1007 #ifdeà
__USE_LARGEFILE64


1008 
	$Œunÿ‹64
 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
)

1009 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

1014 #ià
defšed
 
__USE_POSIX199309
 \

1015 || 
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


1018 #iâdeà
__USE_FILE_OFFSET64


1019 
	$árunÿ‹
 (
__fd
, 
__off_t
 
__Ëngth
è
__THROW
 
__wur
;

1021 #ifdeà
__REDIRECT_NTH


1022 
	`__REDIRECT_NTH
 (
árunÿ‹
, (
__fd
, 
__off64_t
 
__Ëngth
),

1023 
árunÿ‹64
è
__wur
;

1025 
	#árunÿ‹
 
árunÿ‹64


	)

1028 #ifdeà
__USE_LARGEFILE64


1029 
	$árunÿ‹64
 (
__fd
, 
__off64_t
 
__Ëngth
è
__THROW
 
__wur
;

1035 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

1036 || 
defšed
 
__USE_MISC


1040 
	$brk
 (*
__addr
è
__THROW
 
__wur
;

1046 *
	$sbrk
 (
šŒ_t
 
__d–
è
__THROW
;

1050 #ifdeà
__USE_MISC


1061 
	$sysÿÎ
 (
__sy¢o
, ...è
__THROW
;

1066 #ià(
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
è&& !defšed 
F_LOCK


1078 
	#F_ULOCK
 0

	)

1079 
	#F_LOCK
 1

	)

1080 
	#F_TLOCK
 2

	)

1081 
	#F_TEST
 3

	)

1083 #iâdeà
__USE_FILE_OFFSET64


1084 
	$lockf
 (
__fd
, 
__cmd
, 
__off_t
 
__Ën
è
__wur
;

1086 #ifdeà
__REDIRECT


1087 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
),

1088 
lockf64
è
__wur
;

1090 
	#lockf
 
lockf64


	)

1093 #ifdeà
__USE_LARGEFILE64


1094 
	$lockf64
 (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
è
__wur
;

1099 #ifdeà
__USE_GNU


1104 
	#TEMP_FAILURE_RETRY
(
ex´essiÚ
) \

1105 (
__ex‹nsiÚ__
 \

1106 ({ 
__»suÉ
; \

1107 dØ
__»suÉ
 = (è(
ex´essiÚ
); \

1108 
__»suÉ
 =ğ-1L && 
”ºo
 =ğ
EINTR
); \

1109 
__»suÉ
; 
	}
}))

	)

1112 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_UNIX98


1115 
fd©async
 (
__fdes
);

1121 #ifdef 
__USE_XOPEN


1123 *
	$üy±
 (cÚ¡ *
__key
, cÚ¡ *
__§É
)

1124 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1128 
	$’üy±
 (*
__glibc_block
, 
__edæag
)

1129 
__THROW
 
	`__nÚnuÎ
 ((1));

1136 
	$swab
 (cÚ¡ *
__»¡riù
 
__äom
, *__»¡riù 
__to
,

1137 
ssize_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1143 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K


1145 *
	$ù”mid
 (*
__s
è
__THROW
;

1150 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


1151 
	~<b™s/uni¡d.h
>

1154 
__END_DECLS


	@/usr/include/alloca.h

18 #iâdef 
_ALLOCA_H


19 
	#_ALLOCA_H
 1

	)

21 
	~<ã©u»s.h
>

23 
	#__Ãed_size_t


	)

24 
	~<¡ddef.h
>

26 
	g__BEGIN_DECLS


29 #undeà
®loÿ


32 *
	$®loÿ
 (
size_t
 
__size
è
__THROW
;

34 #ifdef 
__GNUC__


35 
	#®loÿ
(
size
è
	`__butš_®loÿ
 (size)

	)

38 
__END_DECLS


	@/usr/include/endian.h

18 #iâdef 
_ENDIAN_H


19 
	#_ENDIAN_H
 1

	)

21 
	~<ã©u»s.h
>

31 
	#__LITTLE_ENDIAN
 1234

	)

32 
	#__BIG_ENDIAN
 4321

	)

33 
	#__PDP_ENDIAN
 3412

	)

36 
	~<b™s/’dŸn.h
>

40 #iâdeà
__FLOAT_WORD_ORDER


41 
	#__FLOAT_WORD_ORDER
 
__BYTE_ORDER


	)

44 #ifdef 
__USE_MISC


45 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

46 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

47 
	#PDP_ENDIAN
 
__PDP_ENDIAN


	)

48 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

51 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


52 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èLO, 
	)
HI

53 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


54 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èHI, 
	)
LO

58 #ià
defšed
 
__USE_MISC
 && !defšed 
__ASSEMBLER__


60 
	~<b™s/by‹sw­.h
>

62 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


63 
	#htobe16
(
x
è
	`__bsw­_16
 (x)

	)

64 
	#htŞe16
(
x
è(x)

	)

65 
	#be16toh
(
x
è
	`__bsw­_16
 (x)

	)

66 
	#Ë16toh
(
x
è(x)

	)

68 
	#htobe32
(
x
è
	`__bsw­_32
 (x)

	)

69 
	#htŞe32
(
x
è(x)

	)

70 
	#be32toh
(
x
è
	`__bsw­_32
 (x)

	)

71 
	#Ë32toh
(
x
è(x)

	)

73 
	#htobe64
(
x
è
	`__bsw­_64
 (x)

	)

74 
	#htŞe64
(
x
è(x)

	)

75 
	#be64toh
(
x
è
	`__bsw­_64
 (x)

	)

76 
	#Ë64toh
(
x
è(x)

	)

79 
	#htobe16
(
x
è(x)

	)

80 
	#htŞe16
(
x
è
	`__bsw­_16
 (x)

	)

81 
	#be16toh
(
x
è(x)

	)

82 
	#Ë16toh
(
x
è
	`__bsw­_16
 (x)

	)

84 
	#htobe32
(
x
è(x)

	)

85 
	#htŞe32
(
x
è
	`__bsw­_32
 (x)

	)

86 
	#be32toh
(
x
è(x)

	)

87 
	#Ë32toh
(
x
è
	`__bsw­_32
 (x)

	)

89 
	#htobe64
(
x
è(x)

	)

90 
	#htŞe64
(
x
è
	`__bsw­_64
 (x)

	)

91 
	#be64toh
(
x
è(x)

	)

92 
	#Ë64toh
(
x
è
	`__bsw­_64
 (x)

	)

	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

97 #undeà
__USE_ISOC11


98 #undeà
__USE_ISOC99


99 #undeà
__USE_ISOC95


100 #undeà
__USE_ISOCXX11


101 #undeà
__USE_POSIX


102 #undeà
__USE_POSIX2


103 #undeà
__USE_POSIX199309


104 #undeà
__USE_POSIX199506


105 #undeà
__USE_XOPEN


106 #undeà
__USE_XOPEN_EXTENDED


107 #undeà
__USE_UNIX98


108 #undeà
__USE_XOPEN2K


109 #undeà
__USE_XOPEN2KXSI


110 #undeà
__USE_XOPEN2K8


111 #undeà
__USE_XOPEN2K8XSI


112 #undeà
__USE_LARGEFILE


113 #undeà
__USE_LARGEFILE64


114 #undeà
__USE_FILE_OFFSET64


115 #undeà
__USE_MISC


116 #undeà
__USE_ATFILE


117 #undeà
__USE_GNU


118 #undeà
__USE_REENTRANT


119 #undeà
__USE_FORTIFY_LEVEL


120 #undeà
__KERNEL_STRICT_NAMES


124 #iâdeà
_LOOSE_KERNEL_NAMES


125 
	#__KERNEL_STRICT_NAMES


	)

135 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


136 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

137 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

139 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

146 #ià(
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE
) \

147 && !
defšed
 
	g_DEFAULT_SOURCE


152 #undeà
_DEFAULT_SOURCE


153 
	#_DEFAULT_SOURCE
 1

	)

157 #ifdeà
_GNU_SOURCE


158 #undeà
_ISOC95_SOURCE


159 
	#_ISOC95_SOURCE
 1

	)

160 #undeà
_ISOC99_SOURCE


161 
	#_ISOC99_SOURCE
 1

	)

162 #undeà
_ISOC11_SOURCE


163 
	#_ISOC11_SOURCE
 1

	)

164 #undeà
_POSIX_SOURCE


165 
	#_POSIX_SOURCE
 1

	)

166 #undeà
_POSIX_C_SOURCE


167 
	#_POSIX_C_SOURCE
 200809L

	)

168 #undeà
_XOPEN_SOURCE


169 
	#_XOPEN_SOURCE
 700

	)

170 #undeà
_XOPEN_SOURCE_EXTENDED


171 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

172 #undeà
_LARGEFILE64_SOURCE


173 
	#_LARGEFILE64_SOURCE
 1

	)

174 #undeà
_DEFAULT_SOURCE


175 
	#_DEFAULT_SOURCE
 1

	)

176 #undeà
_ATFILE_SOURCE


177 
	#_ATFILE_SOURCE
 1

	)

182 #ià(
defšed
 
_DEFAULT_SOURCE
 \

183 || (!
defšed
 
	g__STRICT_ANSI__
 \

184 && !
defšed
 
	g_ISOC99_SOURCE
 \

185 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

186 && !
defšed
 
	g_XOPEN_SOURCE
))

187 #undeà
_DEFAULT_SOURCE


188 
	#_DEFAULT_SOURCE
 1

	)

192 #ià(
defšed
 
_ISOC11_SOURCE
 \

193 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

194 
	#__USE_ISOC11
 1

	)

198 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

199 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

200 
	#__USE_ISOC99
 1

	)

204 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

205 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

206 
	#__USE_ISOC95
 1

	)

213 #ià((
defšed
 
__ılu¥lus
 && __cplusplus >= 201103L) \

214 || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__
)

215 
	#__USE_ISOCXX11
 1

	)

221 #ifdeà
_DEFAULT_SOURCE


222 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


223 
	#__USE_POSIX_IMPLICITLY
 1

	)

225 #undeà
_POSIX_SOURCE


226 
	#_POSIX_SOURCE
 1

	)

227 #undeà
_POSIX_C_SOURCE


228 
	#_POSIX_C_SOURCE
 200809L

	)

230 #ià((!
defšed
 
__STRICT_ANSI__
 \

231 || (
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

232 && !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

233 
	#_POSIX_SOURCE
 1

	)

234 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

235 
	#_POSIX_C_SOURCE
 2

	)

236 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

237 
	#_POSIX_C_SOURCE
 199506L

	)

238 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

239 
	#_POSIX_C_SOURCE
 200112L

	)

241 
	#_POSIX_C_SOURCE
 200809L

	)

243 
	#__USE_POSIX_IMPLICITLY
 1

	)

246 #ià(
defšed
 
_POSIX_SOURCE
 \

247 || (
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

248 || 
defšed
 
_XOPEN_SOURCE
)

249 
	#__USE_POSIX
 1

	)

252 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


253 
	#__USE_POSIX2
 1

	)

256 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

257 
	#__USE_POSIX199309
 1

	)

260 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

261 
	#__USE_POSIX199506
 1

	)

264 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

265 
	#__USE_XOPEN2K
 1

	)

266 #undeà
__USE_ISOC95


267 
	#__USE_ISOC95
 1

	)

268 #undeà
__USE_ISOC99


269 
	#__USE_ISOC99
 1

	)

272 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

273 
	#__USE_XOPEN2K8
 1

	)

274 #undeà
_ATFILE_SOURCE


275 
	#_ATFILE_SOURCE
 1

	)

278 #ifdef 
_XOPEN_SOURCE


279 
	#__USE_XOPEN
 1

	)

280 #ià(
_XOPEN_SOURCE
 - 0) >= 500

281 
	#__USE_XOPEN_EXTENDED
 1

	)

282 
	#__USE_UNIX98
 1

	)

283 #undeà
_LARGEFILE_SOURCE


284 
	#_LARGEFILE_SOURCE
 1

	)

285 #ià(
_XOPEN_SOURCE
 - 0) >= 600

286 #ià(
_XOPEN_SOURCE
 - 0) >= 700

287 
	#__USE_XOPEN2K8
 1

	)

288 
	#__USE_XOPEN2K8XSI
 1

	)

290 
	#__USE_XOPEN2K
 1

	)

291 
	#__USE_XOPEN2KXSI
 1

	)

292 #undeà
__USE_ISOC95


293 
	#__USE_ISOC95
 1

	)

294 #undeà
__USE_ISOC99


295 
	#__USE_ISOC99
 1

	)

298 #ifdeà
_XOPEN_SOURCE_EXTENDED


299 
	#__USE_XOPEN_EXTENDED
 1

	)

304 #ifdeà
_LARGEFILE_SOURCE


305 
	#__USE_LARGEFILE
 1

	)

308 #ifdeà
_LARGEFILE64_SOURCE


309 
	#__USE_LARGEFILE64
 1

	)

312 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

313 
	#__USE_FILE_OFFSET64
 1

	)

316 #ià
defšed
 
_DEFAULT_SOURCE


317 
	#__USE_MISC
 1

	)

320 #ifdef 
_ATFILE_SOURCE


321 
	#__USE_ATFILE
 1

	)

324 #ifdef 
_GNU_SOURCE


325 
	#__USE_GNU
 1

	)

328 #ià
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE


329 
	#__USE_REENTRANT
 1

	)

332 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

333 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

334 #ià
_FORTIFY_SOURCE
 > 1

335 
	#__USE_FORTIFY_LEVEL
 2

	)

337 
	#__USE_FORTIFY_LEVEL
 1

	)

340 
	#__USE_FORTIFY_LEVEL
 0

	)

345 
	~<¡dc-´edef.h
>

353 #undeà
__GNU_LIBRARY__


354 
	#__GNU_LIBRARY__
 6

	)

358 
	#__GLIBC__
 2

	)

359 
	#__GLIBC_MINOR__
 23

	)

361 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

362 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

365 #iâdeà
__ASSEMBLER__


366 #iâdeà
_SYS_CDEFS_H


367 
	~<sys/cdefs.h
>

372 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


373 
	#__USE_LARGEFILE
 1

	)

374 
	#__USE_LARGEFILE64
 1

	)

380 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

381 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

382 && 
defšed
 
	g__ex‹º_šlše


383 
	#__USE_EXTERN_INLINES
 1

	)

391 
	~<gnu/¡ubs.h
>

	@/usr/include/getopt.h

19 #iâdeà
_GETOPT_H


21 #iâdeà
__Ãed_g‘İt


22 
	#_GETOPT_H
 1

	)

32 #ià!
defšed
 
__GNU_LIBRARY__


33 
	~<ùy³.h
>

36 #iâdeà
__THROW


37 #iâdeà
__GNUC_PREREQ


38 
	#__GNUC_PREREQ
(
maj
, 
mš
è(0)

	)

40 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,8)

41 
	#__THROW
 
	`throw
 ()

	)

43 
	#__THROW


	)

47 #ifdef 
__ılu¥lus


57 *
İrg
;

71 
İtšd
;

76 
İ‹¼
;

80 
İtİt
;

82 #iâdeà
__Ãed_g‘İt


104 
	sİtiÚ


106 cÚ¡ *
	gÇme
;

109 
	ghas_¬g
;

110 *
	gæag
;

111 
	gv®
;

116 
	#no_¬gum’t
 0

	)

117 
	#»quœed_¬gum’t
 1

	)

118 
	#İtiÚ®_¬gum’t
 2

	)

146 #ifdeà
__GNU_LIBRARY__


150 
g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
, cÚ¡ *
__shÜtİts
)

151 
__THROW
;

153 #ià
defšed
 
__Ãed_g‘İt
 && defšed 
__USE_POSIX2
 \

154 && !
defšed
 
	g__USE_POSIX_IMPLICITLY
 && !defšed 
	g__USE_GNU


158 #ifdeà
__REDIRECT


159 
__REDIRECT_NTH
 (
g‘İt
, (
___¬gc
, *cÚ¡ *
___¬gv
,

160 cÚ¡ *
__shÜtİts
),

161 
__posix_g‘İt
);

163 
__posix_g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
,

164 cÚ¡ *
__shÜtİts
è
__THROW
;

165 
	#g‘İt
 
__posix_g‘İt


	)

169 
g‘İt
 ();

172 #iâdeà
__Ãed_g‘İt


173 
g‘İt_lÚg
 (
___¬gc
, *cÚ¡ *
___¬gv
,

174 cÚ¡ *
__shÜtİts
,

175 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

176 
__THROW
;

177 
g‘İt_lÚg_Úly
 (
___¬gc
, *cÚ¡ *
___¬gv
,

178 cÚ¡ *
__shÜtİts
,

179 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

180 
__THROW
;

184 #ifdef 
__ılu¥lus


189 #undeà
__Ãed_g‘İt


	@/usr/include/libio.h

28 #iâdeà
_IO_STDIO_H


29 
	#_IO_STDIO_H


	)

31 
	~<_G_cÚfig.h
>

33 
	#_IO_åos_t
 
_G_åos_t


	)

34 
	#_IO_åos64_t
 
_G_åos64_t


	)

35 
	#_IO_size_t
 
size_t


	)

36 
	#_IO_ssize_t
 
__ssize_t


	)

37 
	#_IO_off_t
 
__off_t


	)

38 
	#_IO_off64_t
 
__off64_t


	)

39 
	#_IO_pid_t
 
__pid_t


	)

40 
	#_IO_uid_t
 
__uid_t


	)

41 
	#_IO_icÚv_t
 
_G_icÚv_t


	)

42 
	#_IO_HAVE_ST_BLKSIZE
 
_G_HAVE_ST_BLKSIZE


	)

43 
	#_IO_BUFSIZ
 
_G_BUFSIZ


	)

44 
	#_IO_va_li¡
 
_G_va_li¡


	)

45 
	#_IO_wšt_t
 
wšt_t


	)

48 
	#__Ãed___va_li¡


	)

49 
	~<¡d¬g.h
>

50 #ifdeà
__GNUC_VA_LIST


51 #undeà
_IO_va_li¡


52 
	#_IO_va_li¡
 
__gnuc_va_li¡


	)

55 #iâdeà
__P


56 
	~<sys/cdefs.h
>

59 
	#_IO_UNIFIED_JUMPTABLES
 1

	)

61 #iâdeà
EOF


62 
	#EOF
 (-1)

	)

64 #iâdeà
NULL


65 #ià
defšed
 
__GNUG__
 && \

66 (
	g__GNUC__
 > 2 || (__GNUC__ =ğ2 && 
__GNUC_MINOR__
 >= 8))

67 
	#NULL
 (
__nuÎ
)

	)

69 #ià!
defšed
(
__ılu¥lus
)

70 
	#NULL
 ((*)0)

	)

72 
	#NULL
 (0)

	)

77 
	#_IOS_INPUT
 1

	)

78 
	#_IOS_OUTPUT
 2

	)

79 
	#_IOS_ATEND
 4

	)

80 
	#_IOS_APPEND
 8

	)

81 
	#_IOS_TRUNC
 16

	)

82 
	#_IOS_NOCREATE
 32

	)

83 
	#_IOS_NOREPLACE
 64

	)

84 
	#_IOS_BIN
 128

	)

92 
	#_IO_MAGIC
 0xFBAD0000

	)

93 
	#_OLD_STDIO_MAGIC
 0xFABC0000

	)

94 
	#_IO_MAGIC_MASK
 0xFFFF0000

	)

95 
	#_IO_USER_BUF
 1

	)

96 
	#_IO_UNBUFFERED
 2

	)

97 
	#_IO_NO_READS
 4

	)

98 
	#_IO_NO_WRITES
 8

	)

99 
	#_IO_EOF_SEEN
 0x10

	)

100 
	#_IO_ERR_SEEN
 0x20

	)

101 
	#_IO_DELETE_DONT_CLOSE
 0x40

	)

102 
	#_IO_LINKED
 0x80

	)

103 
	#_IO_IN_BACKUP
 0x100

	)

104 
	#_IO_LINE_BUF
 0x200

	)

105 
	#_IO_TIED_PUT_GET
 0x400

	)

106 
	#_IO_CURRENTLY_PUTTING
 0x800

	)

107 
	#_IO_IS_APPENDING
 0x1000

	)

108 
	#_IO_IS_FILEBUF
 0x2000

	)

109 
	#_IO_BAD_SEEN
 0x4000

	)

110 
	#_IO_USER_LOCK
 0x8000

	)

112 
	#_IO_FLAGS2_MMAP
 1

	)

113 
	#_IO_FLAGS2_NOTCANCEL
 2

	)

114 #ifdeà
_LIBC


115 
	#_IO_FLAGS2_FORTIFY
 4

	)

117 
	#_IO_FLAGS2_USER_WBUF
 8

	)

118 #ifdeà
_LIBC


119 
	#_IO_FLAGS2_SCANF_STD
 16

	)

120 
	#_IO_FLAGS2_NOCLOSE
 32

	)

121 
	#_IO_FLAGS2_CLOEXEC
 64

	)

125 
	#_IO_SKIPWS
 01

	)

126 
	#_IO_LEFT
 02

	)

127 
	#_IO_RIGHT
 04

	)

128 
	#_IO_INTERNAL
 010

	)

129 
	#_IO_DEC
 020

	)

130 
	#_IO_OCT
 040

	)

131 
	#_IO_HEX
 0100

	)

132 
	#_IO_SHOWBASE
 0200

	)

133 
	#_IO_SHOWPOINT
 0400

	)

134 
	#_IO_UPPERCASE
 01000

	)

135 
	#_IO_SHOWPOS
 02000

	)

136 
	#_IO_SCIENTIFIC
 04000

	)

137 
	#_IO_FIXED
 010000

	)

138 
	#_IO_UNITBUF
 020000

	)

139 
	#_IO_STDIO
 040000

	)

140 
	#_IO_DONT_CLOSE
 0100000

	)

141 
	#_IO_BOOLALPHA
 0200000

	)

144 
_IO_jump_t
; 
	g_IO_FILE
;

147 #ifdeà
_IO_MTSAFE_IO


150 
	t_IO_lock_t
;

156 
	s_IO_m¬k”
 {

157 
_IO_m¬k”
 *
	m_Ãxt
;

158 
_IO_FILE
 *
	m_sbuf
;

162 
	m_pos
;

164 
£t_¡»ampos
(
¡»ampos
 
¥
è{ 
	m_¥os
 = sp; }

165 
£t_off£t
(
off£t
è{ 
	m_pos
 = off£t; 
	m_¥os
 = (
¡»ampos
)(-2); }

166 
	mpublic
:

167 
¡»amm¬k”
(
¡»ambuf
 *
sb
);

168 ~
¡»amm¬k”
();

169 
§všg
(è{  
	m_¥os
 == -2; }

170 
d–
(
¡»amm¬k”
&);

171 
d–
();

176 
	e__codecvt_»suÉ


178 
	m__codecvt_ok
,

179 
	m__codecvt_·¹Ÿl
,

180 
	m__codecvt_”rÜ
,

181 
	m__codecvt_nocÚv


184 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


187 
	s_IO_codecvt


189 (*
	m__codecvt_de¡r
è(
	m_IO_codecvt
 *);

190 
__codecvt_»suÉ
 (*
__codecvt_do_out
è(
	m_IO_codecvt
 *,

191 
	m__mb¡©e_t
 *,

192 cÚ¡ 
	mwch¬_t
 *,

193 cÚ¡ 
	mwch¬_t
 *,

194 cÚ¡ 
	mwch¬_t
 **, *,

196 
__codecvt_»suÉ
 (*
__codecvt_do_unshiá
è(
	m_IO_codecvt
 *,

197 
	m__mb¡©e_t
 *, *,

199 
__codecvt_»suÉ
 (*
__codecvt_do_š
è(
	m_IO_codecvt
 *,

200 
	m__mb¡©e_t
 *,

202 cÚ¡ **, 
	mwch¬_t
 *,

203 
	mwch¬_t
 *, wchar_t **);

204 (*
	m__codecvt_do_’codšg
è(
	m_IO_codecvt
 *);

205 (*
	m__codecvt_do_®ways_nocÚv
è(
	m_IO_codecvt
 *);

206 (*
	m__codecvt_do_Ëngth
è(
	m_IO_codecvt
 *, 
	m__mb¡©e_t
 *,

207 cÚ¡ *, cÚ¡ *, 
	m_IO_size_t
);

208 (*
	m__codecvt_do_max_Ëngth
è(
	m_IO_codecvt
 *);

210 
_IO_icÚv_t
 
	m__cd_š
;

211 
_IO_icÚv_t
 
	m__cd_out
;

215 
	s_IO_wide_d©a


217 
wch¬_t
 *
	m_IO_»ad_±r
;

218 
wch¬_t
 *
	m_IO_»ad_’d
;

219 
wch¬_t
 *
	m_IO_»ad_ba£
;

220 
wch¬_t
 *
	m_IO_wr™e_ba£
;

221 
wch¬_t
 *
	m_IO_wr™e_±r
;

222 
wch¬_t
 *
	m_IO_wr™e_’d
;

223 
wch¬_t
 *
	m_IO_buf_ba£
;

224 
wch¬_t
 *
	m_IO_buf_’d
;

226 
wch¬_t
 *
	m_IO_§ve_ba£
;

227 
wch¬_t
 *
	m_IO_backup_ba£
;

229 
wch¬_t
 *
	m_IO_§ve_’d
;

231 
__mb¡©e_t
 
	m_IO_¡©e
;

232 
__mb¡©e_t
 
	m_IO_Ï¡_¡©e
;

233 
_IO_codecvt
 
	m_codecvt
;

235 
wch¬_t
 
	m_shÜtbuf
[1];

237 cÚ¡ 
_IO_jump_t
 *
	m_wide_vbË
;

241 
	s_IO_FILE
 {

242 
	m_æags
;

243 
	#_IO_fe_æags
 
_æags


	)

247 * 
	m_IO_»ad_±r
;

248 * 
	m_IO_»ad_’d
;

249 * 
	m_IO_»ad_ba£
;

250 * 
	m_IO_wr™e_ba£
;

251 * 
	m_IO_wr™e_±r
;

252 * 
	m_IO_wr™e_’d
;

253 * 
	m_IO_buf_ba£
;

254 * 
	m_IO_buf_’d
;

256 *
	m_IO_§ve_ba£
;

257 *
	m_IO_backup_ba£
;

258 *
	m_IO_§ve_’d
;

260 
_IO_m¬k”
 *
	m_m¬k”s
;

262 
_IO_FILE
 *
	m_chaš
;

264 
	m_f’o
;

266 
	m_blksize
;

268 
	m_æags2
;

270 
_IO_off_t
 
	m_Şd_off£t
;

272 
	#__HAVE_COLUMN


	)

274 
	m_cur_cŞumn
;

275 sigÃd 
	m_vbË_off£t
;

276 
	m_shÜtbuf
[1];

280 
_IO_lock_t
 *
	m_lock
;

281 #ifdeà
_IO_USE_OLD_IO_FILE


284 
	s_IO_FILE_com¶‘e


286 
_IO_FILE
 
	m_fe
;

288 #ià
defšed
 
_G_IO_IO_FILE_VERSION
 && _G_IO_IO_FILE_VERSION == 0x20001

289 
_IO_off64_t
 
	m_off£t
;

290 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


292 
_IO_codecvt
 *
	m_codecvt
;

293 
_IO_wide_d©a
 *
	m_wide_d©a
;

294 
_IO_FILE
 *
	m_ä“»s_li¡
;

295 *
	m_ä“»s_buf
;

297 *
	m__·d1
;

298 *
	m__·d2
;

299 *
	m__·d3
;

300 *
	m__·d4
;

302 
size_t
 
	m__·d5
;

303 
	m_mode
;

305 
	m_unu£d2
[15 *  (è- 4 *  (*è-  (
size_t
)];

309 #iâdeà
__ılu¥lus


310 
_IO_FILE
 
	t_IO_FILE
;

313 
	g_IO_FILE_¶us
;

315 
_IO_FILE_¶us
 
_IO_2_1_¡dš_
;

316 
_IO_FILE_¶us
 
_IO_2_1_¡dout_
;

317 
_IO_FILE_¶us
 
_IO_2_1_¡d”r_
;

318 #iâdeà
_LIBC


319 
	#_IO_¡dš
 ((
_IO_FILE
*)(&
_IO_2_1_¡dš_
))

	)

320 
	#_IO_¡dout
 ((
_IO_FILE
*)(&
_IO_2_1_¡dout_
))

	)

321 
	#_IO_¡d”r
 ((
_IO_FILE
*)(&
_IO_2_1_¡d”r_
))

	)

323 
_IO_FILE
 *
_IO_¡dš
 
©Œibu‹_hidd’
;

324 
_IO_FILE
 *
_IO_¡dout
 
©Œibu‹_hidd’
;

325 
_IO_FILE
 *
_IO_¡d”r
 
©Œibu‹_hidd’
;

333 
__ssize_t
 
	t__io_»ad_â
 (*
	t__cook›
, *
	t__buf
, 
	tsize_t
 
	t__nby‹s
);

341 
__ssize_t
 
	t__io_wr™e_â
 (*
	t__cook›
, cÚ¡ *
	t__buf
,

342 
	tsize_t
 
	t__n
);

350 
	t__io_£ek_â
 (*
	t__cook›
, 
	t_IO_off64_t
 *
	t__pos
, 
	t__w
);

353 
	t__io_şo£_â
 (*
	t__cook›
);

356 #ifdeà
_GNU_SOURCE


358 
__io_»ad_â
 
	tcook›_»ad_funùiÚ_t
;

359 
__io_wr™e_â
 
	tcook›_wr™e_funùiÚ_t
;

360 
__io_£ek_â
 
	tcook›_£ek_funùiÚ_t
;

361 
__io_şo£_â
 
	tcook›_şo£_funùiÚ_t
;

366 
__io_»ad_â
 *
	m»ad
;

367 
__io_wr™e_â
 *
	mwr™e
;

368 
__io_£ek_â
 *
	m£ek
;

369 
__io_şo£_â
 *
	mşo£
;

370 } 
	t_IO_cook›_io_funùiÚs_t
;

371 
_IO_cook›_io_funùiÚs_t
 
	tcook›_io_funùiÚs_t
;

373 
	g_IO_cook›_fe
;

376 
_IO_cook›_š™
 (
_IO_cook›_fe
 *
__cfe
, 
__»ad_wr™e
,

377 *
__cook›
, 
_IO_cook›_io_funùiÚs_t
 
__âs
);

381 #ifdeà
__ılu¥lus


385 
__und”æow
 (
_IO_FILE
 *);

386 
__uæow
 (
_IO_FILE
 *);

387 
__ov”æow
 (
_IO_FILE
 *, );

388 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


389 
_IO_wšt_t
 
__wund”æow
 (
_IO_FILE
 *);

390 
_IO_wšt_t
 
__wuæow
 (
_IO_FILE
 *);

391 
_IO_wšt_t
 
__wov”æow
 (
_IO_FILE
 *, _IO_wint_t);

394 #ià 
__GNUC__
 >= 3

395 
	#_IO_BE
(
ex´
, 
»s
è
	`__butš_ex³ù
 (Óx´),„es)

	)

397 
	#_IO_BE
(
ex´
, 
»s
èÓx´)

	)

400 
	#_IO_g‘c_uÆocked
(
_å
) \

401 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

402 ? 
	`__uæow
 (
_å
è: *(*è(_å)->
_IO_»ad_±r
++)

	)

403 
	#_IO_³ekc_uÆocked
(
_å
) \

404 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

405 && 
	`__und”æow
 (
_å
è=ğ
EOF
 ? EOF \

406 : *(*è(
_å
)->
_IO_»ad_±r
)

	)

407 
	#_IO_putc_uÆocked
(
_ch
, 
_å
) \

408 (
	`_IO_BE
 ((
_å
)->
_IO_wr™e_±r
 >ğ(_å)->
_IO_wr™e_’d
, 0) \

409 ? 
	`__ov”æow
 (
_å
, (è(
_ch
)) \

410 : (è(*(
_å
)->
_IO_wr™e_±r
++ = (
_ch
)))

	)

412 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


413 
	#_IO_g‘wc_uÆocked
(
_å
) \

414 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

415 || ((
_å
)->
_wide_d©a
->
_IO_»ad_±r
 \

416 >ğ(
_å
)->
_wide_d©a
->
_IO_»ad_’d
), 0) \

417 ? 
	`__wuæow
 (
_å
è: (
_IO_wšt_t
è*(_å)->
_wide_d©a
->
_IO_»ad_±r
++)

	)

418 
	#_IO_putwc_uÆocked
(
_wch
, 
_å
) \

419 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

420 || ((
_å
)->
_wide_d©a
->
_IO_wr™e_±r
 \

421 >ğ(
_å
)->
_wide_d©a
->
_IO_wr™e_’d
), 0) \

422 ? 
	`__wov”æow
 (
_å
, 
_wch
) \

423 : (
_IO_wšt_t
è(*(
_å
)->
_wide_d©a
->
_IO_wr™e_±r
++ = (
_wch
)))

	)

426 
	#_IO_ãof_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_EOF_SEEN
è!ğ0)

	)

427 
	#_IO_ã¼Ü_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_ERR_SEEN
è!ğ0)

	)

429 
_IO_g‘c
 (
_IO_FILE
 *
__å
);

430 
_IO_putc
 (
__c
, 
_IO_FILE
 *
__å
);

431 
_IO_ãof
 (
_IO_FILE
 *
__å
è
__THROW
;

432 
_IO_ã¼Ü
 (
_IO_FILE
 *
__å
è
__THROW
;

434 
_IO_³ekc_locked
 (
_IO_FILE
 *
__å
);

437 
	#_IO_PENDING_OUTPUT_COUNT
(
_å
) \

438 ((
_å
)->
_IO_wr™e_±r
 - (_å)->
_IO_wr™e_ba£
)

	)

440 
_IO_æockfe
 (
_IO_FILE
 *è
__THROW
;

441 
_IO_fuÆockfe
 (
_IO_FILE
 *è
__THROW
;

442 
_IO_árylockfe
 (
_IO_FILE
 *è
__THROW
;

444 #ifdeà
_IO_MTSAFE_IO


445 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_locked
 (_å)

	)

446 
	#_IO_æockfe
(
_å
) \

447 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_æockfe
 (_å)

	)

448 
	#_IO_fuÆockfe
(
_å
) \

449 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_fuÆockfe
 (_å)

	)

451 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_uÆocked
 (_å)

	)

452 
	#_IO_æockfe
(
_å
è

	)

453 
	#_IO_fuÆockfe
(
_å
è

	)

454 
	#_IO_árylockfe
(
_å
è

	)

455 
	#_IO_ş—nup_»giÚ_¡¬t
(
_fù
, 
_å
è

	)

456 
	#_IO_ş—nup_»giÚ_’d
(
_Do™
è

	)

459 
_IO_vfsÿnf
 (
_IO_FILE
 * 
__»¡riù
, const * __restrict,

460 
_IO_va_li¡
, *
__»¡riù
);

461 
_IO_vårštf
 (
_IO_FILE
 *
__»¡riù
, const *__restrict,

462 
_IO_va_li¡
);

463 
_IO_ssize_t
 
_IO_·dn
 (
_IO_FILE
 *, , _IO_ssize_t);

464 
_IO_size_t
 
_IO_sg‘n
 (
_IO_FILE
 *, *, _IO_size_t);

466 
_IO_off64_t
 
_IO_£ekoff
 (
_IO_FILE
 *, _IO_off64_t, , );

467 
_IO_off64_t
 
_IO_£ekpos
 (
_IO_FILE
 *, _IO_off64_t, );

469 
_IO_ä“_backup_¬—
 (
_IO_FILE
 *è
__THROW
;

471 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


472 
_IO_wšt_t
 
_IO_g‘wc
 (
_IO_FILE
 *
__å
);

473 
_IO_wšt_t
 
_IO_putwc
 (
wch¬_t
 
__wc
, 
_IO_FILE
 *
__å
);

474 
_IO_fwide
 (
_IO_FILE
 *
__å
, 
__mode
è
__THROW
;

475 #ià
__GNUC__
 >= 2

478 #ià
defšed
 
_LIBC
 && defšed 
SHARED


479 
	~<shlib-com·t.h
>

480 #ià
SHLIB_COMPAT
 (
libc
, 
GLIBC_2_0
, 
GLIBC_2_1
)

481 
	#_IO_fwide_maybe_šcom·tibË
 \

482 (
	`__butš_ex³ù
 (&
_IO_¡dš_u£d
 =ğ
NULL
, 0))

	)

483 cÚ¡ 
_IO_¡dš_u£d
;

484 
w—k_ex‹º
 (
_IO_¡dš_u£d
);

487 #iâdeà
_IO_fwide_maybe_šcom·tibË


488 
	#_IO_fwide_maybe_šcom·tibË
 (0)

	)

492 
	#_IO_fwide
(
__å
, 
__mode
) \

493 ({ 
__»suÉ
 = (
__mode
); \

494 ià(
__»suÉ
 < 0 && ! 
_IO_fwide_maybe_šcom·tibË
) \

496 ià((
__å
)->
_mode
 == 0) \

498 (
__å
)->
_mode
 = -1; \

499 
__»suÉ
 = (
__å
)->
_mode
; \

501 ià(
	`__butš_cÚ¡ªt_p
 (
__mode
) && (__mode) == 0) \

502 
__»suÉ
 = 
_IO_fwide_maybe_šcom·tibË
 ? -1 : (
__å
)->
_mode
; \

504 
__»suÉ
 = 
	`_IO_fwide
 (
__å
, __result); \

505 
__»suÉ
; })

	)

508 
_IO_vfwsÿnf
 (
_IO_FILE
 * 
__»¡riù
, cÚ¡ 
wch¬_t
 * __restrict,

509 
_IO_va_li¡
, *
__»¡riù
);

510 
_IO_vfw´štf
 (
_IO_FILE
 *
__»¡riù
, cÚ¡ 
wch¬_t
 *__restrict,

511 
_IO_va_li¡
);

512 
_IO_ssize_t
 
_IO_w·dn
 (
_IO_FILE
 *, 
wšt_t
, _IO_ssize_t);

513 
_IO_ä“_wbackup_¬—
 (
_IO_FILE
 *è
__THROW
;

516 #ifdeà
__LDBL_COMPAT


517 
	~<b™s/libio-ldbl.h
>

520 #ifdeà
__ılu¥lus


	@/usr/include/sched.h

19 #iâdef 
_SCHED_H


20 
	#_SCHED_H
 1

	)

22 
	~<ã©u»s.h
>

25 
	~<b™s/ty³s.h
>

27 
	#__Ãed_size_t


	)

28 
	~<¡ddef.h
>

30 #ifdeà
__USE_XOPEN2K


31 
	#__Ãed_time_t


	)

32 
	#__Ãed_time¥ec


	)

34 
	~<time.h
>

36 #iâdeà
__pid_t_defšed


37 
__pid_t
 
	tpid_t
;

38 
	#__pid_t_defšed


	)

43 
	~<b™s/sched.h
>

45 
	#sched_´iÜ™y
 
__sched_´iÜ™y


	)

48 
__BEGIN_DECLS


51 
	$sched_£¬am
 (
__pid_t
 
__pid
, cÚ¡ 
sched_·¿m
 *
__·¿m
)

52 
__THROW
;

55 
	$sched_g‘·¿m
 (
__pid_t
 
__pid
, 
sched_·¿m
 *
__·¿m
è
__THROW
;

58 
	$sched_£tscheduËr
 (
__pid_t
 
__pid
, 
__pŞicy
,

59 cÚ¡ 
sched_·¿m
 *
__·¿m
è
__THROW
;

62 
	$sched_g‘scheduËr
 (
__pid_t
 
__pid
è
__THROW
;

65 
	$sched_y›ld
 (è
__THROW
;

68 
	$sched_g‘_´iÜ™y_max
 (
__®gÜ™hm
è
__THROW
;

71 
	$sched_g‘_´iÜ™y_mš
 (
__®gÜ™hm
è
__THROW
;

74 
	$sched_¼_g‘_š‹rv®
 (
__pid_t
 
__pid
, 
time¥ec
 *
__t
è
__THROW
;

77 #ifdeà
__USE_GNU


79 
	#CPU_SETSIZE
 
__CPU_SETSIZE


	)

80 
	#CPU_SET
(
ıu
, 
ıu£
è
	`__CPU_SET_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

81 
	#CPU_CLR
(
ıu
, 
ıu£
è
	`__CPU_CLR_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

82 
	#CPU_ISSET
(
ıu
, 
ıu£
è
	`__CPU_ISSET_S
 (ıu,  (
ıu_£t_t
), \

83 
ıu£
)

	)

84 
	#CPU_ZERO
(
ıu£
è
	`__CPU_ZERO_S
 ( (
ıu_£t_t
), cpu£)

	)

85 
	#CPU_COUNT
(
ıu£
è
	`__CPU_COUNT_S
 ( (
ıu_£t_t
), cpu£)

	)

87 
	#CPU_SET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_SET_S
 (ıu, s‘size, cpu£)

	)

88 
	#CPU_CLR_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_CLR_S
 (ıu, s‘size, cpu£)

	)

89 
	#CPU_ISSET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_ISSET_S
 (cpu, setsize, \

90 
ıu£
)

	)

91 
	#CPU_ZERO_S
(
£tsize
, 
ıu£
è
	`__CPU_ZERO_S
 (£tsize, cpu£)

	)

92 
	#CPU_COUNT_S
(
£tsize
, 
ıu£
è
	`__CPU_COUNT_S
 (£tsize, cpu£)

	)

94 
	#CPU_EQUAL
(
ıu£1
, 
ıu£2
) \

95 
	`__CPU_EQUAL_S
 ( (
ıu_£t_t
), 
ıu£1
, 
ıu£2
)

	)

96 
	#CPU_EQUAL_S
(
£tsize
, 
ıu£1
, 
ıu£2
) \

97 
	`__CPU_EQUAL_S
 (
£tsize
, 
ıu£1
, 
ıu£2
)

	)

99 
	#CPU_AND
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

100 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

101 
	#CPU_OR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

102 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

103 
	#CPU_XOR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

104 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

105 
	#CPU_AND_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

106 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

107 
	#CPU_OR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

108 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

109 
	#CPU_XOR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

110 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

112 
	#CPU_ALLOC_SIZE
(
couÁ
è
	`__CPU_ALLOC_SIZE
 (couÁ)

	)

113 
	#CPU_ALLOC
(
couÁ
è
	`__CPU_ALLOC
 (couÁ)

	)

114 
	#CPU_FREE
(
ıu£t
è
	`__CPU_FREE
 (ıu£t)

	)

118 
	$sched_£ffš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

119 cÚ¡ 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

122 
	$sched_g‘affš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

123 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

126 
__END_DECLS


	@/usr/include/xlocale.h

20 #iâdeà
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loÿË_¡ruù


30 
__loÿË_d©a
 *
	m__loÿËs
[13];

33 cÚ¡ *
	m__ùy³_b
;

34 cÚ¡ *
	m__ùy³_tŞow”
;

35 cÚ¡ *
	m__ùy³_touµ”
;

38 cÚ¡ *
	m__Çmes
[13];

39 } *
	t__loÿË_t
;

42 
__loÿË_t
 
	tloÿË_t
;

	@/usr/include/_G_config.h

4 #iâdeà
_G_cÚfig_h


5 
	#_G_cÚfig_h
 1

	)

9 
	~<b™s/ty³s.h
>

10 
	#__Ãed_size_t


	)

11 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


12 
	#__Ãed_wch¬_t


	)

14 
	#__Ãed_NULL


	)

15 
	~<¡ddef.h
>

16 
	#__Ãed_mb¡©e_t


	)

17 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


18 
	#__Ãed_wšt_t


	)

20 
	~<wch¬.h
>

23 
__off_t
 
	m__pos
;

24 
__mb¡©e_t
 
	m__¡©e
;

25 } 
	t_G_åos_t
;

28 
__off64_t
 
	m__pos
;

29 
__mb¡©e_t
 
	m__¡©e
;

30 } 
	t_G_åos64_t
;

31 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


32 
	~<gcÚv.h
>

35 
__gcÚv_šfo
 
	m__cd
;

38 
__gcÚv_šfo
 
	m__cd
;

39 
__gcÚv_¡•_d©a
 
	m__d©a
;

40 } 
	m__combšed
;

41 } 
	t_G_icÚv_t
;

46 
	#_G_va_li¡
 
__gnuc_va_li¡


	)

48 
	#_G_HAVE_MMAP
 1

	)

49 
	#_G_HAVE_MREMAP
 1

	)

51 
	#_G_IO_IO_FILE_VERSION
 0x20001

	)

54 
	#_G_HAVE_ST_BLKSIZE
 
	`defšed
 (
_STATBUF_ST_BLKSIZE
)

	)

56 
	#_G_BUFSIZ
 8192

	)

	@/usr/include/ctype.h

22 #iâdef 
_CTYPE_H


23 
	#_CTYPE_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s.h
>

28 
	g__BEGIN_DECLS


30 #iâdeà
_ISb™


39 
	~<’dŸn.h
>

40 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


41 
	#_ISb™
(
b™
è(1 << (b™))

	)

43 
	#_ISb™
(
b™
è((b™è< 8 ? ((1 << (b™)è<< 8è: ((1 << (b™)è>> 8))

	)

48 
	m_ISuµ”
 = 
_ISb™
 (0),

49 
	m_ISlow”
 = 
_ISb™
 (1),

50 
	m_IS®pha
 = 
_ISb™
 (2),

51 
	m_ISdig™
 = 
_ISb™
 (3),

52 
	m_ISxdig™
 = 
_ISb™
 (4),

53 
	m_IS¥aû
 = 
_ISb™
 (5),

54 
	m_IS´št
 = 
_ISb™
 (6),

55 
	m_ISg¿ph
 = 
_ISb™
 (7),

56 
	m_ISbÏnk
 = 
_ISb™
 (8),

57 
	m_ISúŒl
 = 
_ISb™
 (9),

58 
	m_ISpunù
 = 
_ISb™
 (10),

59 
	m_IS®num
 = 
_ISb™
 (11)

79 cÚ¡ **
	$__ùy³_b_loc
 ()

80 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

81 cÚ¡ 
__št32_t
 **
	$__ùy³_tŞow”_loc
 ()

82 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

83 cÚ¡ 
__št32_t
 **
	$__ùy³_touµ”_loc
 ()

84 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

87 #iâdeà
__ılu¥lus


88 
	#__isùy³
(
c
, 
ty³
) \

89 ((*
	`__ùy³_b_loc
 ())[(è(
c
)] & (è
ty³
)

	)

90 #–ià
defšed
 
__USE_EXTERN_INLINES


91 
	#__isùy³_f
(
ty³
) \

92 
__ex‹º_šlše
 \

93 
is
##
	`ty³
 (
__c
è
__THROW
 \

95  (*
	`__ùy³_b_loc
 ())[(è(
__c
)] & (è
_IS
##
ty³
; \

96 
	}

	)
}

99 
	#__i§scii
(
c
è(((cè& ~0x7fè=ğ0è

	)

100 
	#__tßscii
(
c
è((cè& 0x7fè

	)

102 
	#__exùy³
(
Çme
è
	`Çme
 (è
__THROW


	)

104 
__BEGIN_NAMESPACE_STD


110 
__exùy³
 (
i§Êum
);

111 
__exùy³
 (
i§Íha
);

112 
__exùy³
 (
isúŒl
);

113 
__exùy³
 (
isdig™
);

114 
__exùy³
 (
i¦ow”
);

115 
__exùy³
 (
isg¿ph
);

116 
__exùy³
 (
i¥ršt
);

117 
__exùy³
 (
i¥unù
);

118 
__exùy³
 (
is¥aû
);

119 
__exùy³
 (
isuµ”
);

120 
__exùy³
 (
isxdig™
);

124 
	$tŞow”
 (
__c
è
__THROW
;

127 
	$touµ”
 (
__c
è
__THROW
;

129 
__END_NAMESPACE_STD


133 #ifdef 
__USE_ISOC99


134 
__BEGIN_NAMESPACE_C99


136 
	`__exùy³
 (
isbÏnk
);

138 
__END_NAMESPACE_C99


141 #ifdeà
__USE_GNU


143 
	$isùy³
 (
__c
, 
__mask
è
__THROW
;

146 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


150 
	$i§scii
 (
__c
è
__THROW
;

154 
	$tßscii
 (
__c
è
__THROW
;

158 
	`__exùy³
 (
_touµ”
);

159 
	`__exùy³
 (
_tŞow”
);

163 
	#__tobody
(
c
, 
f
, 
a
, 
¬gs
) \

164 (
__ex‹nsiÚ__
 \

165 ({ 
__»s
; \

166 ià( (
c
) > 1) \

168 ià(
	`__butš_cÚ¡ªt_p
 (
c
)) \

170 
__c
 = (
c
); \

171 
__»s
 = 
__c
 < -128 || __ø> 255 ? __ø: (
a
)[__c]; \

174 
__»s
 = 
f
 
¬gs
; \

177 
__»s
 = (
a
)[(è(
c
)]; \

178 
__»s
; 
	}
}))

	)

180 #ià!
defšed
 
__NO_CTYPE


181 #ifdeà
__isùy³_f


182 
	$__isùy³_f
 (
®num
)

183 
	$__isùy³_f
 (
®pha
)

184 
	$__isùy³_f
 (
úŒl
)

185 
	$__isùy³_f
 (
dig™
)

186 
	$__isùy³_f
 (
low”
)

187 
	$__isùy³_f
 (
g¿ph
)

188 
	$__isùy³_f
 (
´št
)

189 
	$__isùy³_f
 (
punù
)

190 
	$__isùy³_f
 (
¥aû
)

191 
	$__isùy³_f
 (
uµ”
)

192 
	$__isùy³_f
 (
xdig™
)

193 #ifdeà
__USE_ISOC99


194 
	$__isùy³_f
 (
bÏnk
)

196 #–ià
defšed
 
__isùy³


197 
	#i§Êum
(
c
è
	`__isùy³
((c), 
_IS®num
)

	)

198 
	#i§Íha
(
c
è
	`__isùy³
((c), 
_IS®pha
)

	)

199 
	#isúŒl
(
c
è
	`__isùy³
((c), 
_ISúŒl
)

	)

200 
	#isdig™
(
c
è
	`__isùy³
((c), 
_ISdig™
)

	)

201 
	#i¦ow”
(
c
è
	`__isùy³
((c), 
_ISlow”
)

	)

202 
	#isg¿ph
(
c
è
	`__isùy³
((c), 
_ISg¿ph
)

	)

203 
	#i¥ršt
(
c
è
	`__isùy³
((c), 
_IS´št
)

	)

204 
	#i¥unù
(
c
è
	`__isùy³
((c), 
_ISpunù
)

	)

205 
	#is¥aû
(
c
è
	`__isùy³
((c), 
_IS¥aû
)

	)

206 
	#isuµ”
(
c
è
	`__isùy³
((c), 
_ISuµ”
)

	)

207 
	#isxdig™
(
c
è
	`__isùy³
((c), 
_ISxdig™
)

	)

208 #ifdeà
__USE_ISOC99


209 
	#isbÏnk
(
c
è
	`__isùy³
((c), 
_ISbÏnk
)

	)

213 #ifdeà
__USE_EXTERN_INLINES


214 
__ex‹º_šlše
 

215 
	`__NTH
 (
	$tŞow”
 (
__c
))

217  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_tŞow”_loc
 ())[__c] : __c;

218 
	}
}

220 
__ex‹º_šlše
 

221 
__NTH
 (
	$touµ”
 (
__c
))

223  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_touµ”_loc
 ())[__c] : __c;

224 
	}
}

227 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


228 
	#tŞow”
(
c
è
	`__tobody
 (c, 
tŞow”
, *
	`__ùy³_tŞow”_loc
 (), (c))

	)

229 
	#touµ”
(
c
è
	`__tobody
 (c, 
touµ”
, *
	`__ùy³_touµ”_loc
 (), (c))

	)

232 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


233 
	#i§scii
(
c
è
	`__i§scii
 (c)

	)

234 
	#tßscii
(
c
è
	`__tßscii
 (c)

	)

236 
	#_tŞow”
(
c
è((è(*
	`__ùy³_tŞow”_loc
 ())[(è(c)])

	)

237 
	#_touµ”
(
c
è((è(*
	`__ùy³_touµ”_loc
 ())[(è(c)])

	)

243 #ifdeà
__USE_XOPEN2K8


257 
	~<xloÿË.h
>

261 
	#__isùy³_l
(
c
, 
ty³
, 
loÿË
) \

262 ((
loÿË
)->
__ùy³_b
[(è(
c
)] & (è
ty³
)

	)

264 
	#__exùy³_l
(
Çme
) \

265 
	`Çme
 (, 
__loÿË_t
è
__THROW


	)

271 
__exùy³_l
 (
i§Êum_l
);

272 
__exùy³_l
 (
i§Íha_l
);

273 
__exùy³_l
 (
isúŒl_l
);

274 
__exùy³_l
 (
isdig™_l
);

275 
__exùy³_l
 (
i¦ow”_l
);

276 
__exùy³_l
 (
isg¿ph_l
);

277 
__exùy³_l
 (
i¥ršt_l
);

278 
__exùy³_l
 (
i¥unù_l
);

279 
__exùy³_l
 (
is¥aû_l
);

280 
__exùy³_l
 (
isuµ”_l
);

281 
__exùy³_l
 (
isxdig™_l
);

283 
__exùy³_l
 (
isbÏnk_l
);

287 
	$__tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

288 
	$tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

291 
	$__touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

292 
	$touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

294 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


295 
	#__tŞow”_l
(
c
, 
loÿË
) \

296 
	`__tobody
 (
c
, 
__tŞow”_l
, (
loÿË
)->
__ùy³_tŞow”
, (c,†oÿË))

	)

297 
	#__touµ”_l
(
c
, 
loÿË
) \

298 
	`__tobody
 (
c
, 
__touµ”_l
, (
loÿË
)->
__ùy³_touµ”
, (c,†oÿË))

	)

299 
	#tŞow”_l
(
c
, 
loÿË
è
	`__tŞow”_l
 ((c), (loÿË))

	)

300 
	#touµ”_l
(
c
, 
loÿË
è
	`__touµ”_l
 ((c), (loÿË))

	)

304 #iâdeà
__NO_CTYPE


305 
	#__i§Êum_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®num
, (l))

	)

306 
	#__i§Íha_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®pha
, (l))

	)

307 
	#__isúŒl_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISúŒl
, (l))

	)

308 
	#__isdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISdig™
, (l))

	)

309 
	#__i¦ow”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISlow”
, (l))

	)

310 
	#__isg¿ph_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISg¿ph
, (l))

	)

311 
	#__i¥ršt_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS´št
, (l))

	)

312 
	#__i¥unù_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISpunù
, (l))

	)

313 
	#__is¥aû_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS¥aû
, (l))

	)

314 
	#__isuµ”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISuµ”
, (l))

	)

315 
	#__isxdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISxdig™
, (l))

	)

317 
	#__isbÏnk_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISbÏnk
, (l))

	)

319 #ifdeà
__USE_MISC


320 
	#__i§scii_l
(
c
,
l
è(Ö), 
	`__i§scii
 (c))

	)

321 
	#__tßscii_l
(
c
,
l
è(Ö), 
	`__tßscii
 (c))

	)

324 
	#i§Êum_l
(
c
,
l
è
	`__i§Êum_l
 ((c), (l))

	)

325 
	#i§Íha_l
(
c
,
l
è
	`__i§Íha_l
 ((c), (l))

	)

326 
	#isúŒl_l
(
c
,
l
è
	`__isúŒl_l
 ((c), (l))

	)

327 
	#isdig™_l
(
c
,
l
è
	`__isdig™_l
 ((c), (l))

	)

328 
	#i¦ow”_l
(
c
,
l
è
	`__i¦ow”_l
 ((c), (l))

	)

329 
	#isg¿ph_l
(
c
,
l
è
	`__isg¿ph_l
 ((c), (l))

	)

330 
	#i¥ršt_l
(
c
,
l
è
	`__i¥ršt_l
 ((c), (l))

	)

331 
	#i¥unù_l
(
c
,
l
è
	`__i¥unù_l
 ((c), (l))

	)

332 
	#is¥aû_l
(
c
,
l
è
	`__is¥aû_l
 ((c), (l))

	)

333 
	#isuµ”_l
(
c
,
l
è
	`__isuµ”_l
 ((c), (l))

	)

334 
	#isxdig™_l
(
c
,
l
è
	`__isxdig™_l
 ((c), (l))

	)

336 
	#isbÏnk_l
(
c
,
l
è
	`__isbÏnk_l
 ((c), (l))

	)

338 #ifdeà
__USE_MISC


339 
	#i§scii_l
(
c
,
l
è
	`__i§scii_l
 ((c), (l))

	)

340 
	#tßscii_l
(
c
,
l
è
	`__tßscii_l
 ((c), (l))

	)

347 
__END_DECLS


	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

55 
	#__STDC_ISO_10646__
 201505L

	)

58 
	#__STDC_NO_THREADS__
 1

	)

	@/usr/include/gconv.h

22 #iâdeà
_GCONV_H


23 
	#_GCONV_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	#__Ãed_mb¡©e_t


	)

27 
	#__Ãed_wšt_t


	)

28 
	~<wch¬.h
>

29 
	#__Ãed_size_t


	)

30 
	#__Ãed_wch¬_t


	)

31 
	~<¡ddef.h
>

34 
	#__UNKNOWN_10646_CHAR
 ((
wch¬_t
è0xfffd)

	)

39 
	m__GCONV_OK
 = 0,

40 
	m__GCONV_NOCONV
,

41 
	m__GCONV_NODB
,

42 
	m__GCONV_NOMEM
,

44 
	m__GCONV_EMPTY_INPUT
,

45 
	m__GCONV_FULL_OUTPUT
,

46 
	m__GCONV_ILLEGAL_INPUT
,

47 
	m__GCONV_INCOMPLETE_INPUT
,

49 
	m__GCONV_ILLEGAL_DESCRIPTOR
,

50 
	m__GCONV_INTERNAL_ERROR


57 
	m__GCONV_IS_LAST
 = 0x0001,

58 
	m__GCONV_IGNORE_ERRORS
 = 0x0002,

59 
	m__GCONV_SWAP
 = 0x0004,

60 
	m__GCONV_TRANSLIT
 = 0x0008

65 
	g__gcÚv_¡•
;

66 
	g__gcÚv_¡•_d©a
;

67 
	g__gcÚv_lßded_objeù
;

71 (*
	t__gcÚv_fù
è(
	t__gcÚv_¡•
 *, 
	t__gcÚv_¡•_d©a
 *,

73 **, 
	tsize_t
 *, , );

76 
	$wšt_t
 (*
	t__gcÚv_btowc_fù
è(
	t__gcÚv_¡•
 *, );

79 (*
	t__gcÚv_š™_fù
è(
	t__gcÚv_¡•
 *);

80 (*
	t__gcÚv_’d_fù
è(
	t__gcÚv_¡•
 *);

84 
	s__gcÚv_¡•


86 
__gcÚv_lßded_objeù
 *
__shlib_hªdË
;

87 cÚ¡ *
__modÇme
;

89 
__couÁ”
;

91 *
__äom_Çme
;

92 *
__to_Çme
;

94 
__gcÚv_fù
 
__fù
;

95 
__gcÚv_btowc_fù
 
__btowc_fù
;

96 
__gcÚv_š™_fù
 
__š™_fù
;

97 
__gcÚv_’d_fù
 
__’d_fù
;

101 
__mš_Ãeded_äom
;

102 
__max_Ãeded_äom
;

103 
__mš_Ãeded_to
;

104 
__max_Ãeded_to
;

107 
__¡©eful
;

109 *
__d©a
;

114 
	s__gcÚv_¡•_d©a


116 *
__outbuf
;

117 *
__outbuãnd
;

121 
__æags
;

125 
__švoÿtiÚ_couÁ”
;

129 
__š‹º®_u£
;

131 
__mb¡©e_t
 *
__¡©•
;

132 
__mb¡©e_t
 
__¡©e
;

138 
	s__gcÚv_šfo


140 
size_t
 
__n¡•s
;

141 
__gcÚv_¡•
 *
__¡•s
;

142 
__ex‹nsiÚ__
 
__gcÚv_¡•_d©a
 
__d©a
 
__æex¬r
;

143 } *
	t__gcÚv_t
;

146 
	`__gcÚv_Œª¦™”©e
 (
__gcÚv_¡•
 *
¡•
,

147 
__gcÚv_¡•_d©a
 *
¡•_d©a
,

148 cÚ¡ *
šbuf¡¬t
,

149 cÚ¡ **
šbuå
,

150 cÚ¡ *
šbuãnd
,

151 **
outbuf¡¬t
,

152 
size_t
 *
œ»v”sibË
);

	@/usr/include/wchar.h

23 #iâdeà
_WCHAR_H


25 #ià!
defšed
 
__Ãed_mb¡©e_t
 && !defšed 
__Ãed_wšt_t


26 
	#_WCHAR_H
 1

	)

27 
	~<ã©u»s.h
>

30 #ifdeà
_WCHAR_H


32 
	#__Ãed___FILE


	)

33 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


34 
	#__Ãed_FILE


	)

36 
	~<¡dio.h
>

38 
	#__Ãed___va_li¡


	)

39 
	~<¡d¬g.h
>

41 
	~<b™s/wch¬.h
>

44 
	#__Ãed_size_t


	)

45 
	#__Ãed_wch¬_t


	)

46 
	#__Ãed_NULL


	)

48 #ià
defšed
 
_WCHAR_H
 || defšed 
__Ãed_wšt_t
 || !defšed 
__WINT_TYPE__


49 #undeà
__Ãed_wšt_t


50 
	#__Ãed_wšt_t


	)

51 
	~<¡ddef.h
>

55 #iâdeà
_WINT_T


60 
	#_WINT_T


	)

61 
	twšt_t
;

65 #ià
defšed
 
__ılu¥lus
 && defšed 
_GLIBCPP_USE_NAMESPACES
 \

66 && 
defšed
 
__WINT_TYPE__


67 
__BEGIN_NAMESPACE_STD


68 
__WINT_TYPE__
 
	twšt_t
;

69 
	g__END_NAMESPACE_STD


74 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

75 
	#__CORRECT_ISO_CPP_WCHAR_H_PROTO


	)

79 #ià(
defšed
 
_WCHAR_H
 || defšed 
__Ãed_mb¡©e_t
è&& !defšed 
____mb¡©e_t_defšed


80 
	#____mb¡©e_t_defšed
 1

	)

84 
	m__couÁ
;

87 #ifdeà
__WINT_TYPE__


88 
__WINT_TYPE__
 
	m__wch
;

90 
wšt_t
 
	m__wch
;

92 
	m__wchb
[4];

93 } 
	m__v®ue
;

94 } 
	t__mb¡©e_t
;

96 #undeà
__Ãed_mb¡©e_t


101 #ifdeà
_WCHAR_H


103 #iâdeà
__mb¡©e_t_defšed


104 
__BEGIN_NAMESPACE_C99


106 
__mb¡©e_t
 
	tmb¡©e_t
;

107 
	g__END_NAMESPACE_C99


108 
	#__mb¡©e_t_defšed
 1

	)

111 #ifdeà
__USE_GNU


112 
	$__USING_NAMESPACE_C99
(
mb¡©e_t
)

115 #iâdeà
WCHAR_MIN


117 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

118 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

121 #iâdeà
WEOF


122 
	#WEOF
 (0xffffffffu)

	)

127 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_UNIX98


128 
	~<wùy³.h
>

132 
__BEGIN_DECLS


134 
__BEGIN_NAMESPACE_STD


137 
tm
;

138 
__END_NAMESPACE_STD


142 
	$__USING_NAMESPACE_STD
(
tm
)

145 
__BEGIN_NAMESPACE_STD


147 
wch¬_t
 *
	$wcsıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

148 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
)

149 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

152 
wch¬_t
 *
	$wc¢ıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

153 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

154 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

157 
wch¬_t
 *
	$wcsÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

158 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
)

159 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

161 
wch¬_t
 *
	$wc¢ÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

162 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

163 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

166 
	$wcscmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
)

167 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

169 
	$wc¢cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

170 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

171 
__END_NAMESPACE_STD


173 #ifdeà
__USE_XOPEN2K8


175 
	$wcsÿ£cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

178 
	$wc¢ÿ£cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

179 
size_t
 
__n
è
__THROW
;

183 
	~<xloÿË.h
>

185 
	$wcsÿ£cmp_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

186 
__loÿË_t
 
__loc
è
__THROW
;

188 
	$wc¢ÿ£cmp_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

189 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

192 
__BEGIN_NAMESPACE_STD


195 
	$wcscŞl
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

199 
size_t
 
	$wcsxäm
 (
wch¬_t
 *
__»¡riù
 
__s1
,

200 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

201 
__END_NAMESPACE_STD


203 #ifdeà
__USE_XOPEN2K8


209 
	$wcscŞl_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

210 
__loÿË_t
 
__loc
è
__THROW
;

215 
size_t
 
	$wcsxäm_l
 (
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

216 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

219 
wch¬_t
 *
	$wcsdup
 (cÚ¡ 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_m®loc__
;

222 
__BEGIN_NAMESPACE_STD


224 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


225 "C++" 
wch¬_t
 *
	$wcschr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

226 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

227 "C++" cÚ¡ 
wch¬_t
 *
	$wcschr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

228 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

230 
wch¬_t
 *
	$wcschr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

231 
__THROW
 
__©Œibu‹_pu»__
;

234 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


235 "C++" 
wch¬_t
 *
	$wc¤chr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

236 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

237 "C++" cÚ¡ 
wch¬_t
 *
	$wc¤chr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

238 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

240 
wch¬_t
 *
	$wc¤chr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

241 
__THROW
 
__©Œibu‹_pu»__
;

243 
__END_NAMESPACE_STD


245 #ifdeà
__USE_GNU


248 
wch¬_t
 *
	$wcschºul
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__wc
)

249 
__THROW
 
__©Œibu‹_pu»__
;

252 
__BEGIN_NAMESPACE_STD


255 
size_t
 
	$wcsc¥n
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__»jeù
)

256 
__THROW
 
__©Œibu‹_pu»__
;

259 
size_t
 
	$wcs¥n
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

260 
__THROW
 
__©Œibu‹_pu»__
;

262 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


263 "C++" 
wch¬_t
 *
	$wc¥brk
 (
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

264 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

265 "C++" cÚ¡ 
wch¬_t
 *
	$wc¥brk
 (cÚ¡ 
wch¬_t
 *
__wcs
,

266 cÚ¡ 
wch¬_t
 *
__acû±
)

267 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

269 
wch¬_t
 *
	$wc¥brk
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

270 
__THROW
 
__©Œibu‹_pu»__
;

273 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


274 "C++" 
wch¬_t
 *
	$wcs¡r
 (
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

275 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

276 "C++" cÚ¡ 
wch¬_t
 *
	$wcs¡r
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
,

277 cÚ¡ 
wch¬_t
 *
__ÃedË
)

278 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

280 
wch¬_t
 *
	$wcs¡r
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

281 
__THROW
 
__©Œibu‹_pu»__
;

285 
wch¬_t
 *
	$wc¡ok
 (
wch¬_t
 *
__»¡riù
 
__s
,

286 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__d–im
,

287 
wch¬_t
 **
__»¡riù
 
__±r
è
__THROW
;

290 
size_t
 
	$wc¦’
 (cÚ¡ 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_pu»__
;

291 
__END_NAMESPACE_STD


293 #ifdeà
__USE_XOPEN


295 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


296 "C++" 
wch¬_t
 *
	$wcswcs
 (
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

297 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

298 "C++" cÚ¡ 
wch¬_t
 *
	$wcswcs
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
,

299 cÚ¡ 
wch¬_t
 *
__ÃedË
)

300 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

302 
wch¬_t
 *
	$wcswcs
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

303 
__THROW
 
__©Œibu‹_pu»__
;

307 #ifdeà
__USE_XOPEN2K8


309 
size_t
 
	$wc¢Ën
 (cÚ¡ 
wch¬_t
 *
__s
, 
size_t
 
__maxËn
)

310 
__THROW
 
__©Œibu‹_pu»__
;

314 
__BEGIN_NAMESPACE_STD


316 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


317 "C++" 
wch¬_t
 *
	$wmemchr
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

318 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

319 "C++" cÚ¡ 
wch¬_t
 *
	$wmemchr
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__c
,

320 
size_t
 
__n
)

321 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

323 
wch¬_t
 *
	$wmemchr
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

324 
__THROW
 
__©Œibu‹_pu»__
;

328 
	$wmemcmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

329 
__THROW
 
__©Œibu‹_pu»__
;

332 
wch¬_t
 *
	$wmemıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

333 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

337 
wch¬_t
 *
	$wmemmove
 (
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

338 
__THROW
;

341 
wch¬_t
 *
	$wmem£t
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
è
__THROW
;

342 
__END_NAMESPACE_STD


344 #ifdeà
__USE_GNU


347 
wch¬_t
 *
	$wmempıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

348 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
)

349 
__THROW
;

353 
__BEGIN_NAMESPACE_STD


356 
wšt_t
 
	$btowc
 (
__c
è
__THROW
;

360 
	$wùob
 (
wšt_t
 
__c
è
__THROW
;

364 
	$mbsš™
 (cÚ¡ 
mb¡©e_t
 *
__ps
è
__THROW
 
__©Œibu‹_pu»__
;

368 
size_t
 
	$mb¹owc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

369 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

370 
mb¡©e_t
 *
__»¡riù
 
__p
è
__THROW
;

373 
size_t
 
	$wütomb
 (*
__»¡riù
 
__s
, 
wch¬_t
 
__wc
,

374 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

377 
size_t
 
	$__mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

378 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

379 
size_t
 
	$mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

380 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

381 
__END_NAMESPACE_STD


383 #ifdeà
__USE_EXTERN_INLINES


389 
wšt_t
 
	$__btowc_®Ÿs
 (
__c
è
	`__asm
 ("btowc");

390 
__ex‹º_šlše
 
wšt_t


391 
	`__NTH
 (
	$btowc
 (
__c
))

392 {  (
	`__butš_cÚ¡ªt_p
 (
__c
) && __c >= '\0' && __c <= '\x7f'

393 ? (
wšt_t
è
__c
 : 
	`__btowc_®Ÿs
 (__c)); 
	}
}

395 
	$__wùob_®Ÿs
 (
wšt_t
 
__c
è
	`__asm
 ("wctob");

396 
__ex‹º_šlše
 

397 
	`__NTH
 (
	$wùob
 (
wšt_t
 
__wc
))

398 {  (
	`__butš_cÚ¡ªt_p
 (
__wc
è&& __wø>ğ
L
'\0' && __wc <= L'\x7f'

399 ? (è
__wc
 : 
	`__wùob_®Ÿs
 (__wc)); 
	}
}

401 
__ex‹º_šlše
 
size_t


402 
__NTH
 (
	$mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

403 
mb¡©e_t
 *
__»¡riù
 
__ps
))

404 {  (
__ps
 !ğ
NULL


405 ? 
	`mb¹owc
 (
NULL
, 
__s
, 
__n
, 
__ps
è: 
	`__mb¾’
 (__s, __n, NULL)); 
	}
}

408 
__BEGIN_NAMESPACE_STD


411 
size_t
 
	$mb¤towcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

412 cÚ¡ **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

413 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

417 
size_t
 
	$wc¤tombs
 (*
__»¡riù
 
__d¡
,

418 cÚ¡ 
wch¬_t
 **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

419 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

420 
__END_NAMESPACE_STD


423 #ifdef 
__USE_XOPEN2K8


426 
size_t
 
	$mb¢¹owcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

427 cÚ¡ **
__»¡riù
 
__¤c
, 
size_t
 
__nmc
,

428 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

432 
size_t
 
	$wc¢¹ombs
 (*
__»¡riù
 
__d¡
,

433 cÚ¡ 
wch¬_t
 **
__»¡riù
 
__¤c
,

434 
size_t
 
__nwc
, size_ˆ
__Ën
,

435 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

440 #ifdeà
__USE_XOPEN


442 
	$wcwidth
 (
wch¬_t
 
__c
è
__THROW
;

446 
	$wcswidth
 (cÚ¡ 
wch¬_t
 *
__s
, 
size_t
 
__n
è
__THROW
;

450 
__BEGIN_NAMESPACE_STD


453 
	$wc¡od
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

454 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

455 
__END_NAMESPACE_STD


457 #ifdeà
__USE_ISOC99


458 
__BEGIN_NAMESPACE_C99


460 
	$wc¡of
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

461 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

462 
	$wc¡Şd
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

463 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

464 
__END_NAMESPACE_C99


468 
__BEGIN_NAMESPACE_STD


471 
	$wc¡Ş
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

472 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

476 
	$wc¡oul
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

477 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

478 
__THROW
;

479 
__END_NAMESPACE_STD


481 #ifdeà
__USE_ISOC99


482 
__BEGIN_NAMESPACE_C99


485 
__ex‹nsiÚ__


486 
	$wc¡Şl
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

487 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

488 
__THROW
;

492 
__ex‹nsiÚ__


493 
	$wc¡ouÎ
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

494 
wch¬_t
 **
__»¡riù
 
__’d±r
,

495 
__ba£
è
__THROW
;

496 
__END_NAMESPACE_C99


499 #ifdeà
__USE_GNU


502 
__ex‹nsiÚ__


503 
	$wc¡oq
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

504 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

505 
__THROW
;

509 
__ex‹nsiÚ__


510 
	$wc¡ouq
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

511 
wch¬_t
 **
__»¡riù
 
__’d±r
,

512 
__ba£
è
__THROW
;

515 #ifdeà
__USE_GNU


529 
	~<xloÿË.h
>

533 
	$wc¡Ş_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

534 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
,

535 
__loÿË_t
 
__loc
è
__THROW
;

537 
	$wc¡oul_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

538 
wch¬_t
 **
__»¡riù
 
__’d±r
,

539 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

541 
__ex‹nsiÚ__


542 
	$wc¡Şl_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

543 
wch¬_t
 **
__»¡riù
 
__’d±r
,

544 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

546 
__ex‹nsiÚ__


547 
	$wc¡ouÎ_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

548 
wch¬_t
 **
__»¡riù
 
__’d±r
,

549 
__ba£
, 
__loÿË_t
 
__loc
)

550 
__THROW
;

552 
	$wc¡od_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

553 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

554 
__THROW
;

556 
	$wc¡of_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

557 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

558 
__THROW
;

560 
	$wc¡Şd_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

561 
wch¬_t
 **
__»¡riù
 
__’d±r
,

562 
__loÿË_t
 
__loc
è
__THROW
;

566 #ifdeà
__USE_XOPEN2K8


569 
wch¬_t
 *
	$wııy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

570 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
è
__THROW
;

574 
wch¬_t
 *
	$wınıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

575 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

576 
__THROW
;

583 
__FILE
 *
	$İ’_wmem¡»am
 (
wch¬_t
 **
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
;

586 #ià
defšed
 
__USE_ISOC95
 || defšed 
__USE_UNIX98


587 
__BEGIN_NAMESPACE_STD


590 
	$fwide
 (
__FILE
 *
__å
, 
__mode
è
__THROW
;

597 
	`fw´štf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

598 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

604 
	`w´štf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

607 
	$sw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

608 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

609 
__THROW
 ;

615 
	`vfw´štf
 (
__FILE
 *
__»¡riù
 
__s
,

616 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

617 
__gnuc_va_li¡
 
__¬g
)

623 
	`vw´štf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

624 
__gnuc_va_li¡
 
__¬g
)

628 
	$vsw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

629 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

630 
__gnuc_va_li¡
 
__¬g
)

631 
__THROW
 ;

638 
	`fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

639 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

645 
	`wsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

648 
	$swsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

649 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

650 
__THROW
 ;

652 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

653 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

654 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

655 #ifdeà
__REDIRECT


659 
	`__REDIRECT
 (
fwsÿnf
, (
__FILE
 *
__»¡riù
 
__¡»am
,

660 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

661 
__isoc99_fwsÿnf
)

663 
	`__REDIRECT
 (
wsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

664 
__isoc99_wsÿnf
)

666 
	`__REDIRECT_NTH
 (
swsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

667 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

668 ...), 
__isoc99_swsÿnf
)

671 
	`__isoc99_fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

672 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

673 
	`__isoc99_wsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

674 
	$__isoc99_swsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

675 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

676 
__THROW
;

677 
	#fwsÿnf
 
__isoc99_fwsÿnf


	)

678 
	#wsÿnf
 
__isoc99_wsÿnf


	)

679 
	#swsÿnf
 
__isoc99_swsÿnf


	)

683 
__END_NAMESPACE_STD


686 #ifdeà
__USE_ISOC99


687 
__BEGIN_NAMESPACE_C99


692 
	`vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

693 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

694 
__gnuc_va_li¡
 
__¬g
)

700 
	`vwsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

701 
__gnuc_va_li¡
 
__¬g
)

704 
	$vswsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

705 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

706 
__gnuc_va_li¡
 
__¬g
)

707 
__THROW
 ;

709 #ià!
defšed
 
__USE_GNU
 \

710 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

711 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

712 #ifdeà
__REDIRECT


713 
	`__REDIRECT
 (
vfwsÿnf
, (
__FILE
 *
__»¡riù
 
__s
,

714 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

715 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vfwsÿnf
)

717 
	`__REDIRECT
 (
vwsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

718 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vwsÿnf
)

720 
	`__REDIRECT_NTH
 (
vswsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

721 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

722 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vswsÿnf
)

725 
	`__isoc99_vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

726 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

727 
__gnuc_va_li¡
 
__¬g
);

728 
	`__isoc99_vwsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

729 
__gnuc_va_li¡
 
__¬g
);

730 
	$__isoc99_vswsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

731 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

732 
__gnuc_va_li¡
 
__¬g
è
__THROW
;

733 
	#vfwsÿnf
 
__isoc99_vfwsÿnf


	)

734 
	#vwsÿnf
 
__isoc99_vwsÿnf


	)

735 
	#vswsÿnf
 
__isoc99_vswsÿnf


	)

739 
__END_NAMESPACE_C99


743 
__BEGIN_NAMESPACE_STD


748 
wšt_t
 
	`fg‘wc
 (
__FILE
 *
__¡»am
);

749 
wšt_t
 
	`g‘wc
 (
__FILE
 *
__¡»am
);

755 
wšt_t
 
	`g‘wch¬
 ();

762 
wšt_t
 
	`åutwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

763 
wšt_t
 
	`putwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

769 
wšt_t
 
	`putwch¬
 (
wch¬_t
 
__wc
);

777 
wch¬_t
 *
	`fg‘ws
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

778 
__FILE
 *
__»¡riù
 
__¡»am
);

784 
	`åutws
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ws
,

785 
__FILE
 *
__»¡riù
 
__¡»am
);

792 
wšt_t
 
	`ung‘wc
 (wšt_ˆ
__wc
, 
__FILE
 *
__¡»am
);

793 
__END_NAMESPACE_STD


796 #ifdeà
__USE_GNU


804 
wšt_t
 
	`g‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

805 
wšt_t
 
	`g‘wch¬_uÆocked
 ();

813 
wšt_t
 
	`fg‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

821 
wšt_t
 
	`åutwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

830 
wšt_t
 
	`putwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

831 
wšt_t
 
	`putwch¬_uÆocked
 (
wch¬_t
 
__wc
);

840 
wch¬_t
 *
	`fg‘ws_uÆocked
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

841 
__FILE
 *
__»¡riù
 
__¡»am
);

849 
	`åutws_uÆocked
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ws
,

850 
__FILE
 *
__»¡riù
 
__¡»am
);

854 
__BEGIN_NAMESPACE_C99


858 
size_t
 
	$wcsáime
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

859 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

860 cÚ¡ 
tm
 *
__»¡riù
 
__
è
__THROW
;

861 
__END_NAMESPACE_C99


863 #ifdeà
__USE_GNU


864 
	~<xloÿË.h
>

868 
size_t
 
	$wcsáime_l
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

869 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

870 cÚ¡ 
tm
 *
__»¡riù
 
__
,

871 
__loÿË_t
 
__loc
è
__THROW
;

880 #ià
defšed
 
__USE_UNIX98
 && !defšed 
__USE_GNU


881 
	#__Ãed_iswxxx


	)

882 
	~<wùy³.h
>

886 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


887 
	~<b™s/wch¬2.h
>

890 #ifdeà
__LDBL_COMPAT


891 
	~<b™s/wch¬-ldbl.h
>

894 
__END_DECLS


902 #undeà
__Ãed_mb¡©e_t


903 #undeà
__Ãed_wšt_t


	@/usr/include/wctype.h

23 #iâdeà
_WCTYPE_H


25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s.h
>

28 #iâdeà
__Ãed_iswxxx


29 
	#_WCTYPE_H
 1

	)

32 
	#__Ãed_wšt_t


	)

33 
	~<wch¬.h
>

37 #iâdeà
WEOF


38 
	#WEOF
 (0xffffffffu)

	)

41 #undeà
__Ãed_iswxxx


46 #iâdeà
__iswxxx_defšed


47 
	#__iswxxx_defšed
 1

	)

49 
__BEGIN_NAMESPACE_C99


52 
	twùy³_t
;

53 
	g__END_NAMESPACE_C99


55 #iâdeà
_ISwb™


60 
	~<’dŸn.h
>

61 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


62 
	#_ISwb™
(
b™
è(1 << (b™))

	)

64 
	#_ISwb™
(
b™
) \

65 ((
b™
) < 8 ? () ((1UL << (bit)) << 24) \

66 : ((
b™
) < 16 ? () ((1UL << (bit)) << 8) \

67 : ((
b™
) < 24 ? () ((1UL << (bit)) >> 8) \

68 : (è((1UL << (
b™
)è>> 24))))

	)

73 
	m__ISwuµ”
 = 0,

74 
	m__ISwlow”
 = 1,

75 
	m__ISw®pha
 = 2,

76 
	m__ISwdig™
 = 3,

77 
	m__ISwxdig™
 = 4,

78 
	m__ISw¥aû
 = 5,

79 
	m__ISw´št
 = 6,

80 
	m__ISwg¿ph
 = 7,

81 
	m__ISwbÏnk
 = 8,

82 
	m__ISwúŒl
 = 9,

83 
	m__ISwpunù
 = 10,

84 
	m__ISw®num
 = 11,

86 
	m_ISwuµ”
 = 
_ISwb™
 (
__ISwuµ”
),

87 
	m_ISwlow”
 = 
_ISwb™
 (
__ISwlow”
),

88 
	m_ISw®pha
 = 
_ISwb™
 (
__ISw®pha
),

89 
	m_ISwdig™
 = 
_ISwb™
 (
__ISwdig™
),

90 
	m_ISwxdig™
 = 
_ISwb™
 (
__ISwxdig™
),

91 
	m_ISw¥aû
 = 
_ISwb™
 (
__ISw¥aû
),

92 
	m_ISw´št
 = 
_ISwb™
 (
__ISw´št
),

93 
	m_ISwg¿ph
 = 
_ISwb™
 (
__ISwg¿ph
),

94 
	m_ISwbÏnk
 = 
_ISwb™
 (
__ISwbÏnk
),

95 
	m_ISwúŒl
 = 
_ISwb™
 (
__ISwúŒl
),

96 
	m_ISwpunù
 = 
_ISwb™
 (
__ISwpunù
),

97 
	m_ISw®num
 = 
_ISwb™
 (
__ISw®num
)

102 
__BEGIN_DECLS


104 
__BEGIN_NAMESPACE_C99


111 
	$isw®num
 (
wšt_t
 
__wc
è
__THROW
;

117 
	$isw®pha
 (
wšt_t
 
__wc
è
__THROW
;

120 
	$iswúŒl
 (
wšt_t
 
__wc
è
__THROW
;

124 
	$iswdig™
 (
wšt_t
 
__wc
è
__THROW
;

128 
	$iswg¿ph
 (
wšt_t
 
__wc
è
__THROW
;

133 
	$iswlow”
 (
wšt_t
 
__wc
è
__THROW
;

136 
	$isw´št
 (
wšt_t
 
__wc
è
__THROW
;

141 
	$iswpunù
 (
wšt_t
 
__wc
è
__THROW
;

146 
	$isw¥aû
 (
wšt_t
 
__wc
è
__THROW
;

151 
	$iswuµ”
 (
wšt_t
 
__wc
è
__THROW
;

156 
	$iswxdig™
 (
wšt_t
 
__wc
è
__THROW
;

161 #ifdeà
__USE_ISOC99


162 
	$iswbÏnk
 (
wšt_t
 
__wc
è
__THROW
;

171 
wùy³_t
 
	$wùy³
 (cÚ¡ *
__´İ”ty
è
__THROW
;

175 
	$iswùy³
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
è
__THROW
;

176 
__END_NAMESPACE_C99


183 
__BEGIN_NAMESPACE_C99


186 cÚ¡ 
	t__št32_t
 *
	twù¿ns_t
;

187 
__END_NAMESPACE_C99


188 #ifdeà
__USE_GNU


189 
	$__USING_NAMESPACE_C99
(
wù¿ns_t
)

192 
__BEGIN_NAMESPACE_C99


194 
wšt_t
 
	$towlow”
 (
wšt_t
 
__wc
è
__THROW
;

197 
wšt_t
 
	$towuµ”
 (
wšt_t
 
__wc
è
__THROW
;

198 
__END_NAMESPACE_C99


200 
__END_DECLS


207 #ifdeà
_WCTYPE_H


213 
__BEGIN_DECLS


215 
__BEGIN_NAMESPACE_C99


218 
wù¿ns_t
 
	$wù¿ns
 (cÚ¡ *
__´İ”ty
è
__THROW
;

221 
wšt_t
 
	$towù¿ns
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
è
__THROW
;

222 
__END_NAMESPACE_C99


224 #ifdeà
__USE_XOPEN2K8


226 
	~<xloÿË.h
>

230 
	$isw®num_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

236 
	$isw®pha_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

239 
	$iswúŒl_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

243 
	$iswdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

247 
	$iswg¿ph_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

252 
	$iswlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

255 
	$isw´št_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

260 
	$iswpunù_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

265 
	$isw¥aû_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

270 
	$iswuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

275 
	$iswxdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

280 
	$iswbÏnk_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

284 
wùy³_t
 
	$wùy³_l
 (cÚ¡ *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

285 
__THROW
;

289 
	$iswùy³_l
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
, 
__loÿË_t
 
__loÿË
)

290 
__THROW
;

298 
wšt_t
 
	$towlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

301 
wšt_t
 
	$towuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

305 
wù¿ns_t
 
	$wù¿ns_l
 (cÚ¡ *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

306 
__THROW
;

309 
wšt_t
 
	$towù¿ns_l
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
,

310 
__loÿË_t
 
__loÿË
è
__THROW
;

314 
__END_DECLS


	@
1
.
1
/usr/include
115
1701
activation_layer.c
activation_layer.h
activations.c
activations.h
avgpool_layer.c
avgpool_layer.h
batchnorm_layer.c
batchnorm_layer.h
blas.c
blas.h
box.c
box.h
classifier.h
col2im.c
col2im.h
compare.c
connected_layer.c
connected_layer.h
convolutional_layer.c
convolutional_layer.h
cost_layer.c
cost_layer.h
crnn_layer.c
crnn_layer.h
crop_layer.c
crop_layer.h
cuda.c
cuda.h
data.c
data.h
deconvolutional_layer.c
deconvolutional_layer.h
demo.c
demo.h
detection_layer.c
detection_layer.h
dropout_layer.c
dropout_layer.h
gemm.c
gemm.h
gru_layer.c
gru_layer.h
im2col.c
im2col.h
image.c
image.h
l2norm_layer.c
l2norm_layer.h
layer.c
layer.h
list.c
list.h
local_layer.c
local_layer.h
logistic_layer.c
logistic_layer.h
lstm_layer.c
lstm_layer.h
matrix.c
matrix.h
maxpool_layer.c
maxpool_layer.h
network.c
network.h
normalization_layer.c
normalization_layer.h
option_list.c
option_list.h
parser.c
parser.h
region_layer.c
region_layer.h
reorg_layer.c
reorg_layer.h
rnn_layer.c
rnn_layer.h
route_layer.c
route_layer.h
shortcut_layer.c
shortcut_layer.h
softmax_layer.c
softmax_layer.h
stb_image.h
stb_image_write.h
tree.c
tree.h
upsample_layer.c
upsample_layer.h
utils.c
utils.h
yolo_layer.c
yolo_layer.h
/usr/include/assert.h
/usr/include/limits.h
/usr/include/math.h
/usr/include/pthread.h
/usr/include/stdint.h
/usr/include/stdio.h
/usr/include/stdlib.h
/usr/include/string.h
/usr/include/time.h
/usr/include/unistd.h
/usr/include/alloca.h
/usr/include/endian.h
/usr/include/features.h
/usr/include/getopt.h
/usr/include/libio.h
/usr/include/sched.h
/usr/include/xlocale.h
/usr/include/_G_config.h
/usr/include/ctype.h
/usr/include/stdc-predef.h
/usr/include/gconv.h
/usr/include/wchar.h
/usr/include/wctype.h
